{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/butterfly/source/css/index.styl","path":"css/index.styl","modified":0,"renderable":1},{"_id":"themes/butterfly/source/css/var.styl","path":"css/var.styl","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/404.jpg","path":"img/404.jpg","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/algolia.svg","path":"img/algolia.svg","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/avator.png","path":"img/avator.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/favicon.png","path":"img/favicon.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/friend_404.gif","path":"img/friend_404.gif","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/icp.png","path":"img/icp.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/loading.gif","path":"img/loading.gif","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/tw_cn.js","path":"js/tw_cn.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/search/algolia.js","path":"js/search/algolia.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/search/local-search.js","path":"js/search/local-search.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/ClickShowText.js","path":"js/third-party/ClickShowText.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/activate-power-mode.js","path":"js/third-party/activate-power-mode.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/canvas-nest.js","path":"js/third-party/canvas-nest.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/canvas-ribbon.js","path":"js/third-party/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/click_heart.js","path":"js/third-party/click_heart.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/fireworks.js","path":"js/third-party/fireworks.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/piao.js","path":"js/third-party/piao.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"48f01e357230864df594b4549a67d838047b39dd","modified":1600595468717},{"_id":"source/.DS_Store","hash":"d1395a0934d2fd1db5c2a99b1b64dce02284d10f","modified":1618632895692},{"_id":"source/_posts/.DS_Store","hash":"28f0cca9851aff26142ea0edd7d9ba22f932dae4","modified":1618632895696},{"_id":"source/_posts/在k8s中部署RabbitMQ.md","hash":"bc1e6bb9f515c0830ad7d8c3afdeb5fa4f0199fe","modified":1616224573580},{"_id":"source/archives/index.md","hash":"48a8c6149085940ce0706c2d8cd5efc4606bdec6","modified":1616212573023},{"_id":"source/categories/index-1.md","hash":"99e4ac4fde62b04081c73b9e51ba2a168a67587c","modified":1616212474907},{"_id":"source/categories/index.md","hash":"85bf8b8d10fc11464413d4aebbf69db8588832d7","modified":1599290835590},{"_id":"source/tags/index-1.md","hash":"a757bb59b90734987feb65998f4d416276252d2c","modified":1616212481066},{"_id":"source/tags/index.md","hash":"ed49c4e6c4204d89e0c5838479e499e795c334d7","modified":1599290835590},{"_id":"source/_posts/在k8s中部署RabbitMQ/service.png","hash":"71d9ec668af0d71f6d4109d20edd67ce9b654718","modified":1616217980467},{"_id":"source/_posts/在k8s中部署RabbitMQ/bushu.png","hash":"51b3273b0ed83d2f03df80e5b08903682752c58f","modified":1616217472733},{"_id":"themes/butterfly/LICENSE","hash":"c372b56b7553dafd2d8a8abf12d0dd71b4e2bfc0","modified":1599293200708},{"_id":"themes/butterfly/README.md","hash":"111662216ce7d1ea63d7072aaea2a612543c19a1","modified":1599293200708},{"_id":"themes/butterfly/_config.yml","hash":"a449a0d900f7210d70c6af6af86a6c17315dbcea","modified":1616319656826},{"_id":"themes/butterfly/README_CN.md","hash":"6c17872d3bbd147a86f53a7de7ee193dfd1a9000","modified":1599293200708},{"_id":"themes/butterfly/package.json","hash":"f92db754486cb1cfaaa4b03b869877c922974bee","modified":1599293200723},{"_id":"themes/butterfly/.github/ISSUE_TEMPLATE.md","hash":"bc427d7f13fec05cfd2dcc10953cbb2a96bc31be","modified":1599293200707},{"_id":"themes/butterfly/.github/stale.yml","hash":"cd5a929ce25a6293a9f449e7b80dfe4307326797","modified":1599293200708},{"_id":"themes/butterfly/layout/404.pug","hash":"9ba3cea0f61ad5d0f6cb782fd3da9cf7b4077ae4","modified":1599293200709},{"_id":"themes/butterfly/layout/archive.pug","hash":"bd62286afb64a51c97e800c5945620d51605d5fa","modified":1599293200709},{"_id":"themes/butterfly/layout/category.pug","hash":"d014234c26d2c07caaea6703f7b48cb69c51907d","modified":1599293200709},{"_id":"themes/butterfly/layout/flink.pug","hash":"12571e3b98651d655cab29c01a33663393c66056","modified":1599293200710},{"_id":"themes/butterfly/layout/index.pug","hash":"e1c3146834c16e6077406180858add0a8183875a","modified":1599293200722},{"_id":"themes/butterfly/layout/page.pug","hash":"130ab657a6acfe149dbc59e481dc05d4d7d926a3","modified":1599293200722},{"_id":"themes/butterfly/layout/post.pug","hash":"2e34fd65d36508faec9fd015d6cdb108d4c29b58","modified":1599293200722},{"_id":"themes/butterfly/layout/tag.pug","hash":"3bb2a700c6d709d2757d55d357eed1fca5644e24","modified":1599293200722},{"_id":"themes/butterfly/languages/default.yml","hash":"730a00d41d0cb7b6ad768a9f91889307ffeffc23","modified":1599293200709},{"_id":"themes/butterfly/languages/en.yml","hash":"730a00d41d0cb7b6ad768a9f91889307ffeffc23","modified":1599293200709},{"_id":"themes/butterfly/languages/zh-CN.yml","hash":"e7d642fe6ed909c6552accd919a812c9ae86df7d","modified":1599293200709},{"_id":"themes/butterfly/languages/zh-TW.yml","hash":"582d4800d33209f4612f48f25f69e8d952aeabfe","modified":1599293200709},{"_id":"themes/butterfly/layout/includes/additional-js.pug","hash":"06ff82eaedfbc5cc9a65e34eaa063cebfb942a93","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/footer.pug","hash":"0675b44ce8eeffca750f32f68e406145b070f363","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head.pug","hash":"5f3a4c030a5f27d890089737f3fd4c58a1154c1f","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/layout.pug","hash":"e764e4ecceb04e11e2bfef84e72b4529bdc2362b","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/pagination.pug","hash":"29c6e5f8b82de38f61b53decfa9e0e9831b188f8","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/rightside.pug","hash":"71960ea57a3f241c80e7701f2decbf4ba9736ba0","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/sidebar.pug","hash":"158e49e0466e71e4d2cc7087a3ac5e703b3e13e4","modified":1599293200719},{"_id":"themes/butterfly/scripts/events/404.js","hash":"3c30dbd8b910ce7d8d7d8353cf2266cbc5d8775d","modified":1599293200723},{"_id":"themes/butterfly/scripts/events/replace_config.js","hash":"537e556e76760ce2103f359d5a424c6e2b9a0710","modified":1599293200723},{"_id":"themes/butterfly/scripts/filters/post_lazyload.js","hash":"e6db030700cefcd79e7a826b04e2a7172d53428e","modified":1599293200724},{"_id":"themes/butterfly/scripts/filters/random_cover.js","hash":"0b4775aaa955b75f03648fc1957fb88a6d440803","modified":1599293200724},{"_id":"themes/butterfly/scripts/helpers/aside_archives.js","hash":"fb394ffd0ec61fe50ff992fdf11356312ca2ccfb","modified":1599293200724},{"_id":"themes/butterfly/scripts/helpers/aside_categories.js","hash":"11aabab0092a3f2258c1fa931e74a7796074c515","modified":1599293200724},{"_id":"themes/butterfly/scripts/helpers/page.js","hash":"729a9f40c5bf603036f6e9443db93b1704cf17d9","modified":1599293200725},{"_id":"themes/butterfly/scripts/helpers/related_post.js","hash":"64b13aeb4f49609529be6f9060797bafc8a6f9bc","modified":1599293200725},{"_id":"themes/butterfly/scripts/tags/button.js","hash":"bae84b36b58572112047c3b02e975c1e762de56b","modified":1599293200725},{"_id":"themes/butterfly/scripts/tags/hide.js","hash":"a32e4166b6cbbc1c2bdecaa74662a12cdb98f4ce","modified":1599293200725},{"_id":"themes/butterfly/scripts/tags/gallery.js","hash":"2fad0a9e6645613631aad36dc3473fe8e032809b","modified":1599293200725},{"_id":"themes/butterfly/scripts/tags/mermaid.js","hash":"53eaff19d8da32e04e2c871300ea495356d633cd","modified":1599293200726},{"_id":"themes/butterfly/scripts/tags/note.js","hash":"c739846637c48b4779df2f62effb78e15100fd9f","modified":1599293200726},{"_id":"themes/butterfly/scripts/tags/tabs.js","hash":"ec58149e16b6269bbcb685020b98567e8e3440a8","modified":1599293200726},{"_id":"themes/butterfly/source/css/index.styl","hash":"8d908c4bc856f9369e8148e7b8dd7fb968fbf66c","modified":1599293200734},{"_id":"themes/butterfly/source/css/var.styl","hash":"3c20dbec8e323628f17a8510f6ef8bba6f00db2a","modified":1599293200734},{"_id":"themes/butterfly/source/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1599293200734},{"_id":"themes/butterfly/source/img/algolia.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1599293200734},{"_id":"themes/butterfly/source/img/favicon.png","hash":"3cf89864b4f6c9b532522a4d260a2e887971c92d","modified":1599293200736},{"_id":"themes/butterfly/source/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1599293200737},{"_id":"themes/butterfly/source/img/icp.png","hash":"cb1fd69b38ec23ce8366668ddffbbd0160de0104","modified":1599293200737},{"_id":"themes/butterfly/source/img/loading.gif","hash":"5f0287fb8fb98872fe1998c6f781111819e71806","modified":1599293200737},{"_id":"themes/butterfly/source/js/main.js","hash":"c2e386dfd6614123a58dd87a66a7fc9bcca8b64f","modified":1616218902930},{"_id":"themes/butterfly/source/js/tw_cn.js","hash":"030ad26843c22f6a5f91a40200c65d079a4f8475","modified":1599293200740},{"_id":"themes/butterfly/source/js/utils.js","hash":"43da5a9129aa827dc5c311b0e5e3a12ccc61b488","modified":1599293200740},{"_id":"themes/butterfly/layout/includes/chat/chatra.pug","hash":"77ec360f1f9fd702be540b0542449705828a77da","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/chat/daovoice.pug","hash":"ab96a70b0a65a7fae094d426beba7433f60f4a5a","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/chat/gitter.pug","hash":"ba9576ecba1a1768c25377e8b4fdb133982bd214","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/chat/index.pug","hash":"da7412131e768e331a9f33804f2f5f7c5eeaa178","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/chat/tidio.pug","hash":"208035fb6ae639653861d15c9a20e8d4bba2b02a","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/disqus.pug","hash":"821d968122bab8ce1ce04dc553b731eaf8e0d181","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/disqusjs.pug","hash":"751351eae0540651a5db865262ff4a6d40680715","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/facebook_comments.pug","hash":"7b7bb7d2b39b639cc8e1edf1274148460796662e","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/gitalk.pug","hash":"e98f5c199a76ad939a29a46c0dcbf7e85ec60ed2","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/index.pug","hash":"67cfc03939e08992ccb3a453d2b72458056535e9","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/livere.pug","hash":"9518b6e0c532af8ab0ae569ad795b769a2bd3040","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/utterances.pug","hash":"9427cb07bcfe2bc7198755eeebf60f9fe430a342","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/comments/valine.pug","hash":"7b91be55c613f16bb2da9ab48aaf6e08781f563a","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head/analytics.pug","hash":"8ec0609f14c284c3e6120940d7c4d7f1f201cd67","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head/Open_Graph.pug","hash":"a3c819238dceab080d5db0336ef07009ca216310","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head/aplayer.pug","hash":"b24959f00ac75f12f66b445158aad143ee860795","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head/comment.pug","hash":"7de136bdce45afa81341b13e61b7a3926e15f03b","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/config.pug","hash":"e8b774f88cc717371d2e31f5d532007d0b7b23ab","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/config_site.pug","hash":"29d6ab8de6e355925e76d92862671ce48ddd6f12","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/darkmode.pug","hash":"fa834037bf29843abd6b63fed3a868638b9875cd","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/noscript.pug","hash":"0a23423304127c4ffa69310526aaa59830d12c78","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/google_adsense.pug","hash":"ff4ceda534cdd711cfa2cb9e95e36258988674e1","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/preconnect.pug","hash":"95affc2c333f27b968c47272277da712d13f2670","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/pwa.pug","hash":"be1ff710e4381fc684243313dcadf0140d7469de","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/site_verification.pug","hash":"f5c8ec73c797ff3455e732fa7c92c856692f3ce5","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/head/subtitle.pug","hash":"bfbf1c850dcd825c2eb68bc74e9787a5fef9258b","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/index.pug","hash":"12dc74a7370b8d00f010e6914c09b1b12343fd92","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/menu_item.pug","hash":"c76b6236995f15e3cf5af376101c782a1078b845","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/nav.pug","hash":"2ff93c4edc1e52f63f3cd5f90354683e933a299e","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/post-info.pug","hash":"aa83c7e0dcaf60c85d44af32a7d2d20667a6893b","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/social.pug","hash":"0d953e51d04a9294a64153c89c20f491a9ec42d4","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/loading/loading.pug","hash":"5276937fbcceb9d62879dc47be880cd469a27349","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/loading/loading-js.pug","hash":"3cf431a4f04997b55873f7099c1402155b19cc95","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/mixins/article-sort.pug","hash":"4736ea0dec5561f4f75d283be3629062b234af23","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/mixins/post-ui.pug","hash":"c046c1b43ce9b5afe68b60c08230b843113a1561","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/mobile-sidebar/index.pug","hash":"d12fab033fb32b55abbc9be9b04cc6ab6465b98e","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/mobile-sidebar/mobile-menus.pug","hash":"e7ee2593788c6614b9f41f0789ef7166fe73a707","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/math/index.pug","hash":"ec97f284626b67208370b5084e5c5822844fa30a","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/math/katex.pug","hash":"73356f1068c7426597e268d6c4aefa2b0ac3a1d9","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/math/mermaid.pug","hash":"db848ff451d4c58670af415882ca6bb2e0da971b","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/math/mathjax.pug","hash":"6ccfaa776fc913ccf8b34825d918ab2b4d457434","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/search/algolia.pug","hash":"518eec7302d4fad75be46486407a945b39833ff8","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/search/index.pug","hash":"b01828b37d789797aeb5433f1705cff3c540a4d5","modified":1599293200718},{"_id":"themes/butterfly/layout/includes/search/local-search.pug","hash":"f8686264a4ff1d48961296f9949d705bc87de3ea","modified":1599293200718},{"_id":"themes/butterfly/layout/includes/post/post-copyright.pug","hash":"8efc0b7886bdb5959e173b5e11f5ffb8d1c5230e","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/share/add-this.pug","hash":"2980f1889226ca981aa23b8eb1853fde26dcf89a","modified":1599293200718},{"_id":"themes/butterfly/layout/includes/share/addtoany.pug","hash":"bbf5b70460b17c4fecb9ee6880aa71cdb2d807a8","modified":1599293200718},{"_id":"themes/butterfly/layout/includes/post/reward.pug","hash":"3740cece6885c285351295612723fd66e0d5a4bf","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/share/index.pug","hash":"c341aaa00113681b22f945f5004e6b22c8a0ca69","modified":1599293200719},{"_id":"themes/butterfly/layout/includes/share/share-js.pug","hash":"828a04c6e8e3a56c3c7f3c9bb1ecf4f99ed842fe","modified":1599293200719},{"_id":"themes/butterfly/layout/includes/third-party/canvas-nest.pug","hash":"3d7a3654ae03fd2665ea355ee9eac48af0ee82af","modified":1599293200719},{"_id":"themes/butterfly/layout/includes/third-party/canvas-ribbon-piao.pug","hash":"001f28c633d2ec2d5ef9ca047fb1fe61ffefd66f","modified":1599293200719},{"_id":"themes/butterfly/layout/includes/third-party/canvas-ribbon.pug","hash":"b4acf48c98ba2a6a5a5fb5387a0fd610bdfd55ef","modified":1599293200720},{"_id":"themes/butterfly/layout/includes/third-party/pangu.pug","hash":"8fdb96b8329e352ed691228767451b264151b3a6","modified":1599293200720},{"_id":"themes/butterfly/layout/includes/widget/card_ad.pug","hash":"2e940de1a6261fd378e16e4cd3362a9d69c12f50","modified":1599293200720},{"_id":"themes/butterfly/layout/includes/widget/card_author.pug","hash":"b5d73ceb54c43cc22e46b1cdcde24fcc8e420755","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_archives.pug","hash":"393a6f9a5dcabe8d96e9b6cb5620c12966dfd37f","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_announcement.pug","hash":"721b611fda6dcfca8f88b9c7b70fede7b69a516b","modified":1599293200720},{"_id":"themes/butterfly/layout/includes/widget/card_categories.pug","hash":"83cb6ba0d8c913570147b3871c7fc0674dac8cdf","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_recent_post.pug","hash":"355b50dd13471e00fbbfcf6519cf32a092c095b3","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_tags.pug","hash":"6a4c85a037c10e093f545d3167691c0b68634465","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_webinfo.pug","hash":"e0febc7eb43ceb21bb1607d4f2358b9b633cb2d2","modified":1599293200722},{"_id":"themes/butterfly/layout/includes/widget/index.pug","hash":"15fb3730f829e237c102a70ab9781178471fd786","modified":1599293200722},{"_id":"themes/butterfly/source/css/_global/function.styl","hash":"7f800733ca4e4ee4dd1e0ccaace274d1bc896539","modified":1599293200727},{"_id":"themes/butterfly/source/css/_global/index.styl","hash":"cd9580fdf3a138ca84504e1a8b3f4d633ccc7bd5","modified":1599293200727},{"_id":"themes/butterfly/source/css/_highlight/diff.styl","hash":"2d9820f9fc556855c9c26f9242adb1b29fe3c272","modified":1599293200727},{"_id":"themes/butterfly/source/css/_highlight/highlight.styl","hash":"f2884605b55dfb9575f9532d6ac568bc59d0c4ab","modified":1599293200727},{"_id":"themes/butterfly/source/css/_highlight/theme.styl","hash":"70ce4e354b03fe926fd06822e2a5f125e1cd3697","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/404.styl","hash":"b766e536a7a558f4850b31464a284ce2384d79f6","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/aside.styl","hash":"25c9a71043156adf67662d68b35d97d66f60a396","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/category.styl","hash":"7267043e52a9e620adfa860bdb3e4de400ff2596","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/chat.styl","hash":"29f48f9370f245e6e575b5836bccf47eb5688d8b","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/flink.styl","hash":"079ed647f847cf2693928d358929b65ce67cb31b","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/footer.styl","hash":"d8709e29efcfa0a7356384026dfbaac8861d3baa","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/head.styl","hash":"f7038a0ac08396784e57bcd31f6431c92909f514","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/loadding.styl","hash":"144ef01b03ae34d3ede4b9aa18f4c8cd3d6651ea","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/mobile-sidebar.styl","hash":"d2d6b36f3bcbba35e1e63ac0d59879decf63cc1f","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/page.styl","hash":"2fc2230d9a7117f6c5f7e484e2fbfc76e62fa8bc","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/pagination.styl","hash":"8f44be6a866d11f6afabf8689d9ae7b65eee18ae","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/post.styl","hash":"37a9832a6bc409947e85556b31f2adadf2f412ec","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/relatedposts.styl","hash":"4825afd4f94f1481b5422072fa5e506e2a387247","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/reward.styl","hash":"495da7b41a7909df989a5dcc13a29761ef23089b","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/rightside.styl","hash":"1cb78e3c8217eb93ad3652f60a3f4c92c1218083","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/sidebar.styl","hash":"33da3da65715ce1a85b8ecab92e0eab6ce620a58","modified":1599293200731},{"_id":"themes/butterfly/source/css/_layout/third-party.styl","hash":"4923e99c1b6abf11c81539576ce65202a2f40efb","modified":1599293200731},{"_id":"themes/butterfly/source/css/_mode/darkmode.styl","hash":"ce9b157439f48c5ef9106cbe3090525815009134","modified":1599293200731},{"_id":"themes/butterfly/source/css/_mode/readmode.styl","hash":"1608b5c2a307809e25ac7ad903fc6bc009c30016","modified":1599293200731},{"_id":"themes/butterfly/source/css/_search/algolia.styl","hash":"641ef2bc7af135c17fd90f3f974e78ebbaf1ac13","modified":1599293200732},{"_id":"themes/butterfly/source/css/_search/index.styl","hash":"5bb29799d0168b1d68cfb8165a41b9d90f86eab7","modified":1599293200732},{"_id":"themes/butterfly/source/css/_search/local-search.styl","hash":"da791f46239eabbbf28eb30b9e441f1ac2a8ced1","modified":1599293200732},{"_id":"themes/butterfly/source/css/_tags/button.styl","hash":"40926b9d87e06d4679bd3c8542a7a3acd5d10cc1","modified":1599293200732},{"_id":"themes/butterfly/source/css/_tags/gallery.styl","hash":"0bc29278fbcf1aec15222ed10c58697da1a0d676","modified":1599293200732},{"_id":"themes/butterfly/source/css/_tags/hexo.styl","hash":"d0386ba6d8d63afc72b9673e8f3e89df6446ffc2","modified":1599293200733},{"_id":"themes/butterfly/source/css/_tags/hide.styl","hash":"10e925cf59748af445d3606d965731013f31827c","modified":1599293200733},{"_id":"themes/butterfly/source/css/_tags/note.styl","hash":"2f8d4043dedef70813493e43e4c158e16ccc3fc0","modified":1599293200733},{"_id":"themes/butterfly/source/css/_tags/tabs.styl","hash":"48a582e1847595aaa435c048a7bb78b44ed8a716","modified":1599293200733},{"_id":"themes/butterfly/source/css/_third-party/normalize.min.css","hash":"001bd6d68a9b9af5dd0158fe116889434f36b1fd","modified":1599293200733},{"_id":"themes/butterfly/source/js/search/algolia.js","hash":"5ff5cb40d5ede73b48594d331244ada001154dac","modified":1599293200738},{"_id":"themes/butterfly/source/js/search/local-search.js","hash":"497993860b3c42bdc926a3bd83b4b8f480febd99","modified":1599293200738},{"_id":"themes/butterfly/source/js/third-party/ClickShowText.js","hash":"32864aee35b5d739a36702b8d916b17bac52b17e","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/activate-power-mode.js","hash":"2c4ab494225b7d04eed934efc43a43791e596f4a","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/canvas-nest.js","hash":"978402a16f3ceebe453806e3e25a5905a89776be","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/canvas-ribbon.js","hash":"1ddf4f6896175e77518f0fbd45776132b2954fb6","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/click_heart.js","hash":"004ea645ed8c5e354711b5fc0dbfe015e181916b","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/fireworks.js","hash":"411ced4031a856a5b87f7c62d3800027d12bacec","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/piao.js","hash":"05da3437664bb335e2336a52be8587e7719f7b89","modified":1599293200740},{"_id":"source/_posts/在k8s中部署RabbitMQ/log.png","hash":"67f08866e31bf7be0b10733147d91acb87c318cb","modified":1616217771632},{"_id":"themes/butterfly/source/img/avator.png","hash":"b2bc08b8559a3a777724aadcbaebbaf3bef791ef","modified":1599293200736},{"_id":"source/_posts/在k8s中部署RabbitMQ/web.png","hash":"aca80a860af76862c1510399be20e585580aaa45","modified":1616218111938},{"_id":"source/_posts/在k8s中部署RabbitMQ/client_log.png","hash":"5835d6bb7d706b615bcd8f49239d7e3ae82aa82b","modified":1616217853920},{"_id":"public/archives/index.html","hash":"b3a9d6fe30bedd96b6d368239b8b6c793d9a0e06","modified":1618633634480},{"_id":"public/categories/index-1.html","hash":"038eef1f7528b63212d2d60f591bc491ab9614ac","modified":1618633634480},{"_id":"public/categories/index.html","hash":"ee691a9ba9191beb737194913c31a6caaa44977b","modified":1618633634480},{"_id":"public/tags/index-1.html","hash":"3e8c80a32bc2bebeab776de3b1df53eb09d378da","modified":1618633634480},{"_id":"public/tags/index.html","hash":"16ad6388c2ff7db2e6076528d01343293dfb8837","modified":1618633634480},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/index.html","hash":"f3eed7aa2704d71ff72c997d771ed7ed2a8348d1","modified":1618633610681},{"_id":"public/archives/2021/index.html","hash":"80d8bb79119077bf0dd0f319e2d695fb9b4f6126","modified":1618633634480},{"_id":"public/archives/2021/03/index.html","hash":"ec53361450b48e4d7ea4c7229b60bc2bbb5e0774","modified":1618633634480},{"_id":"public/categories/消息中间件/index.html","hash":"1852445ef8136b7ba9dddc568ad6aff6f22c9fae","modified":1618633634480},{"_id":"public/categories/消息中间件/RabbitMQ/index.html","hash":"cf901ea17de7ec2b6c60a7bd7cff64bce04b86cd","modified":1618633634480},{"_id":"public/categories/消息中间件/RabbitMQ/部署/index.html","hash":"a437a0cf981c0e33a5da48e66ef021c438640d78","modified":1618633634480},{"_id":"public/index.html","hash":"99d5cb202787caba2d8359fd1d341ff0fe86cdb2","modified":1618633634480},{"_id":"public/tags/RabbitMQ/index.html","hash":"f425f28ffc3a484d032daee024d13eaa7e681a04","modified":1618633634480},{"_id":"public/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1616221797577},{"_id":"public/img/algolia.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1616221797577},{"_id":"public/img/favicon.png","hash":"3cf89864b4f6c9b532522a4d260a2e887971c92d","modified":1616221797577},{"_id":"public/img/icp.png","hash":"cb1fd69b38ec23ce8366668ddffbbd0160de0104","modified":1616221797577},{"_id":"public/img/loading.gif","hash":"5f0287fb8fb98872fe1998c6f781111819e71806","modified":1616221797577},{"_id":"public/CNAME","hash":"48f01e357230864df594b4549a67d838047b39dd","modified":1616221797577},{"_id":"public/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/service.png","hash":"71d9ec668af0d71f6d4109d20edd67ce9b654718","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/bushu.png","hash":"51b3273b0ed83d2f03df80e5b08903682752c58f","modified":1616221797577},{"_id":"public/css/var.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616221797577},{"_id":"public/js/utils.js","hash":"43da5a9129aa827dc5c311b0e5e3a12ccc61b488","modified":1616221797577},{"_id":"public/js/search/algolia.js","hash":"5ff5cb40d5ede73b48594d331244ada001154dac","modified":1616221797577},{"_id":"public/js/search/local-search.js","hash":"497993860b3c42bdc926a3bd83b4b8f480febd99","modified":1616221797577},{"_id":"public/js/third-party/ClickShowText.js","hash":"32864aee35b5d739a36702b8d916b17bac52b17e","modified":1616221797577},{"_id":"public/js/third-party/activate-power-mode.js","hash":"2c4ab494225b7d04eed934efc43a43791e596f4a","modified":1616221797577},{"_id":"public/js/third-party/canvas-nest.js","hash":"978402a16f3ceebe453806e3e25a5905a89776be","modified":1616221797577},{"_id":"public/js/third-party/canvas-ribbon.js","hash":"1ddf4f6896175e77518f0fbd45776132b2954fb6","modified":1616221797577},{"_id":"public/js/third-party/click_heart.js","hash":"004ea645ed8c5e354711b5fc0dbfe015e181916b","modified":1616221797577},{"_id":"public/js/third-party/fireworks.js","hash":"411ced4031a856a5b87f7c62d3800027d12bacec","modified":1616221797577},{"_id":"public/js/third-party/piao.js","hash":"05da3437664bb335e2336a52be8587e7719f7b89","modified":1616221797577},{"_id":"public/css/index.css","hash":"d955f3a4c6a05310eb5354404ac1ef9cbd28fe8c","modified":1616221797577},{"_id":"public/js/main.js","hash":"c2e386dfd6614123a58dd87a66a7fc9bcca8b64f","modified":1616221797577},{"_id":"public/js/tw_cn.js","hash":"030ad26843c22f6a5f91a40200c65d079a4f8475","modified":1616221797577},{"_id":"public/img/avator.png","hash":"b2bc08b8559a3a777724aadcbaebbaf3bef791ef","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/log.png","hash":"67f08866e31bf7be0b10733147d91acb87c318cb","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/web.png","hash":"aca80a860af76862c1510399be20e585580aaa45","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/client_log.png","hash":"5835d6bb7d706b615bcd8f49239d7e3ae82aa82b","modified":1616221797577},{"_id":"source/_posts/部署Ingress.md","hash":"f2276e7eb979ddb5b85a95ee4784dc46b771efa7","modified":1616225614178},{"_id":"source/_posts/在k8s中部署RabbitMQ/.DS_Store","hash":"4e64f1ac8566a9d3dc317186d770d52fcdb34144","modified":1616224447450},{"_id":"public/2021/03/20/部署Ingress/index.html","hash":"d53b752c51747933634a8a5b31665c3c034c6781","modified":1618633610681},{"_id":"public/categories/Kubernetes/index.html","hash":"ec29979314cad4609898c6dd6fff185066aa3a80","modified":1618633634480},{"_id":"public/categories/Kubernetes/Ingress-nginx/index.html","hash":"cae7b29125cf212ad3c4eea92cc5ce713de7088d","modified":1618633634480},{"_id":"public/tags/Ingress/index.html","hash":"c1b6553178381a2bda5e7e3b667ce8d79d6fb8f9","modified":1618633634480},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布.md","hash":"e4a37b897e59ca81b31b7e3e6bf6d77138effaf7","modified":1616230531405},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/index.html","hash":"7a566ff2e95ffbb97d5e31e163efa8b4f60c6b2a","modified":1618633610681},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/pod.png","hash":"5d27bac9f250f8c1fa0582d179135d8e4182e519","modified":1616226381609},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-ha.png","hash":"ff05d70835407c65fffb62ca46f31c6d507b8a3f","modified":1616227117706},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-never.png","hash":"a5bd79e1cf70bbf210658a923beb3e64039294e2","modified":1616227230206},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-wight.png","hash":"d6309a6c2f52b75ed625ef6a1f1d22c6d29ca622","modified":1616226688767},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-true.png","hash":"0dc651430e734e14767c987d9351c9a8ed39e161","modified":1616227310172},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2.png","hash":"9849d93155f759958c418acff7993cad654d6120","modified":1616226633526},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v1.png","hash":"fa31197af7e26528f5825fccea9cba7e584e0f2e","modified":1616226746224},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/pod.png","hash":"5d27bac9f250f8c1fa0582d179135d8e4182e519","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v1.png","hash":"fa31197af7e26528f5825fccea9cba7e584e0f2e","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2.png","hash":"9849d93155f759958c418acff7993cad654d6120","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2-wight.png","hash":"d6309a6c2f52b75ed625ef6a1f1d22c6d29ca622","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2-true.png","hash":"0dc651430e734e14767c987d9351c9a8ed39e161","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2-never.png","hash":"a5bd79e1cf70bbf210658a923beb3e64039294e2","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2-ha.png","hash":"ff05d70835407c65fffb62ca46f31c6d507b8a3f","modified":1616228714566},{"_id":"source/_posts/在k8s中部署redis集群.md","hash":"3dd0eecf2613ce023c900f4c29fa1d42d83f12a9","modified":1616241007951},{"_id":"source/_posts/在k8s中部署redis集群/create.png","hash":"328923445273cb0e937fac417a95e8ee830c397b","modified":1616240291299},{"_id":"source/_posts/在k8s中部署redis集群/info.png","hash":"a5be50fe42597778e979a80f5f133a990bc853fd","modified":1616240525995},{"_id":"source/_posts/在k8s中部署redis集群/detail.png","hash":"a6f861bd03ed14212a8232be8eced51e19e7c11a","modified":1616240561498},{"_id":"source/_posts/在k8s中部署redis集群/cluster.png","hash":"cfbc50e50fe764805893ed022cfcfd33043b6036","modified":1616240473552},{"_id":"public/2021/03/20/在k8s中部署redis集群/index.html","hash":"86cb78159be33c1d69bae498b03190498bcc4ef4","modified":1618633610681},{"_id":"public/tags/Redis/index.html","hash":"16094e6fa1f7772abd00f2ad60f9eb83fdaef520","modified":1618633634480},{"_id":"public/categories/数据库/Redis/index.html","hash":"489ce46e39b5fa218f1863f9a59c431b95468409","modified":1618633634480},{"_id":"public/categories/数据库/index.html","hash":"e1a5a771d66a34794264bbe8a8cc015a73b740d5","modified":1618633634480},{"_id":"public/categories/数据库/Redis/部署/index.html","hash":"a078cf2bc4fb515b4244a061a0a32cdc460e1188","modified":1618633634480},{"_id":"public/2021/03/20/在k8s中部署redis集群/create.png","hash":"328923445273cb0e937fac417a95e8ee830c397b","modified":1616240621559},{"_id":"public/2021/03/20/在k8s中部署redis集群/info.png","hash":"a5be50fe42597778e979a80f5f133a990bc853fd","modified":1616240621559},{"_id":"public/2021/03/20/在k8s中部署redis集群/detail.png","hash":"a6f861bd03ed14212a8232be8eced51e19e7c11a","modified":1616240621559},{"_id":"public/2021/03/20/在k8s中部署redis集群/cluster.png","hash":"cfbc50e50fe764805893ed022cfcfd33043b6036","modified":1616240621559},{"_id":"source/_posts/在k8s中部署mysql主从集群.md","hash":"52e8976e567cdfe48525a1250c6ac772f352cd58","modified":1616241766706},{"_id":"source/_posts/在k8s中部署mysql主从集群/zhucong.png","hash":"dc901cd5725175a1af914f17337eeb91e1439510","modified":1616241558634},{"_id":"public/categories/数据库/MySQL/index.html","hash":"277774eed88e96b5e4c9c9d1eae5a7f39034f2ba","modified":1618633634480},{"_id":"public/categories/数据库/MySQL/部署/index.html","hash":"1d89c0868c911c8dfbf5c32f4673a30fadd4f4b3","modified":1618633634480},{"_id":"public/tags/MySQL/index.html","hash":"f318c949e2dcf4e86959c1d211601a52696bcdff","modified":1618633634480},{"_id":"public/2021/03/20/在k8s中部署mysql主从集群/index.html","hash":"807c26a6ecb2d65b522d09c9061ac24f1e3e7a2e","modified":1618633610681},{"_id":"public/2021/03/20/在k8s中部署mysql主从集群/zhucong.png","hash":"dc901cd5725175a1af914f17337eeb91e1439510","modified":1616241781019},{"_id":"source/_posts/部署Mysql5-7.md","hash":"647ed988a939a6ee50d9243b356d4488ce130c45","modified":1616319551608},{"_id":"public/2021/03/21/部署Mysql5-7/index.html","hash":"ff79df1b65338f1bfb259be28121b1b842fac38a","modified":1618633610681},{"_id":"source/_posts/在k8s中部署Mysql单实例.md","hash":"e8cc0a53ecaa4b1b71351390146b5c28fe24eacc","modified":1616319932026},{"_id":"public/2021/03/21/在k8s中部署Mysql单实例/index.html","hash":"314e41a24d15e735c4872e42ab772401d8896450","modified":1618633610681},{"_id":"source/_posts/在k8s中使用nfs存储.md","hash":"3fada31803422f9796cceb3dc7cc1b5a6e4c49d1","modified":1616506490484},{"_id":"public/2021/03/23/在k8s中使用nfs存储/index.html","hash":"e4cb8c03d5f045c07dde1fb87848ce5316a87ce9","modified":1618633610681},{"_id":"public/categories/Kubernetes/存储/index.html","hash":"db0e818484836c992911cbadfa6b9e48c4648283","modified":1618633634480},{"_id":"public/categories/Kubernetes/存储/NFS/index.html","hash":"e97b91b11b06b4d11ae8e3841768253dda96ddbb","modified":1618633634480},{"_id":"public/tags/NFS/index.html","hash":"2c0390cc9485e470e107d2a7bd324bc40e28b79b","modified":1618633634480},{"_id":"source/_posts/在k8s中使用nfs存储/.DS_Store","hash":"c8c4336d2f6dc7372969949c598dba7490fceb36","modified":1616505751008},{"_id":"source/_posts/在k8s中使用nfs存储/pod-nfs-svc.png","hash":"14df383bb1a39f069a6a41c66c590dfaf7862024","modified":1599290835479},{"_id":"source/_posts/在k8s中使用nfs存储/pod-nfs-test.png","hash":"6c44a178fe6f673ea72649b02bbc235588527369","modified":1599290835480},{"_id":"source/_posts/在k8s中使用nfs存储/pod-nfs.png","hash":"f58f243592d8fb36010961dd21acfa67a7c016e3","modified":1599290835481},{"_id":"source/_posts/在k8s中使用nfs存储/pvc-nginx.png","hash":"1d66319a61690cbe6a845474238060a4dc27e1e5","modified":1599290835483},{"_id":"source/_posts/在k8s中使用nfs存储/pv.png","hash":"e34c9983e81419e8457171f090588398b4eb619c","modified":1599290835482},{"_id":"source/_posts/在k8s中使用nfs存储/nfs-client.png","hash":"e4f03cecc4d0f70d02a9765d1349014885ab1217","modified":1599290835478},{"_id":"source/_posts/在k8s中使用nfs存储/pvc.png","hash":"5642f98a4804c3033865c7dc83cc3999fbed4fd0","modified":1599290835484},{"_id":"source/_posts/在k8s中使用nfs存储/storageclass-pvc.png","hash":"96817ede171b4d89e9a947f6444c79d2950da7e4","modified":1599290835486},{"_id":"public/2021/03/23/在k8s中使用nfs存储/pod-nfs-svc.png","hash":"14df383bb1a39f069a6a41c66c590dfaf7862024","modified":1616506516736},{"_id":"public/2021/03/23/在k8s中使用nfs存储/pod-nfs.png","hash":"f58f243592d8fb36010961dd21acfa67a7c016e3","modified":1616506516736},{"_id":"public/2021/03/23/在k8s中使用nfs存储/pv.png","hash":"e34c9983e81419e8457171f090588398b4eb619c","modified":1616506516736},{"_id":"public/2021/03/23/在k8s中使用nfs存储/pvc-nginx.png","hash":"1d66319a61690cbe6a845474238060a4dc27e1e5","modified":1616506516736},{"_id":"public/2021/03/23/在k8s中使用nfs存储/pod-nfs-test.png","hash":"6c44a178fe6f673ea72649b02bbc235588527369","modified":1616506516736},{"_id":"public/2021/03/23/在k8s中使用nfs存储/pvc.png","hash":"5642f98a4804c3033865c7dc83cc3999fbed4fd0","modified":1616506516736},{"_id":"public/2021/03/23/在k8s中使用nfs存储/nfs-client.png","hash":"e4f03cecc4d0f70d02a9765d1349014885ab1217","modified":1616506516736},{"_id":"public/2021/03/23/在k8s中使用nfs存储/storageclass-pvc.png","hash":"96817ede171b4d89e9a947f6444c79d2950da7e4","modified":1616506516736},{"_id":"source/_posts/部署nfs存储.md","hash":"9797bef6ce4d8897cf7e64cce164dacf17739ccc","modified":1616507032510},{"_id":"public/2021/03/23/部署nfs存储/index.html","hash":"b44115d821af7a06b3516698ca010647d666c51f","modified":1618633610681},{"_id":"public/categories/存储/index.html","hash":"aee1dd7db51a39421e7e99d81622ba56083b24f7","modified":1618633634480},{"_id":"public/categories/存储/NFS/index.html","hash":"d16f2c7b7ada88c3bd4394810c1006e46d12d36f","modified":1618633634480},{"_id":"public/categories/存储/NFS/部署/index.html","hash":"1f04c34977f0e19480cedc1876a79a52ba49ee2e","modified":1618633634480},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集.md","hash":"3396ad4e5597848a267068bbe6e26235e3b06085","modified":1616822412991},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/index.html","hash":"0892b486029ba14068f27af02cb069b602d6d620","modified":1618633610681},{"_id":"public/categories/Kubernetes/日志收集/index.html","hash":"e4e0a3e57af966fa294708d282012c92b933ce5e","modified":1618633634480},{"_id":"public/tags/K8S/index.html","hash":"ccd3aca425d62a7e845848c8560cf82e394cfdb7","modified":1618633634480},{"_id":"public/tags/日志收集/index.html","hash":"dd1d2ae6556c23afe8530156008ea0210a1196c5","modified":1618633634480},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/add-cluster-1.png","hash":"42dcdd324f050f3db4502b034cc8c43c5336b2db","modified":1599290835413},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/add-cluster-2.png","hash":"1b9de318aa257d11f94f4b6ba965d7573bc78610","modified":1599290835413},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/configmap.png","hash":"6eaaf553c9288b6be7d7b30f51d016dc41dc191b","modified":1599290835424},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/.DS_Store","hash":"38249157287b1a9ea5840944392b7ffda97fdc51","modified":1616822536649},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/logstash-pod.png","hash":"3b98ea318afe0f720884d37dedf3115caf97a67e","modified":1599290835425},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/pod.png","hash":"451787216850a069ced1278fd42c1d37bea6f217","modified":1599290835418},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/es-pod.png","hash":"f4ceee98f71d989d64f60701a5bc9957768046f3","modified":1599290835416},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/kafka.png","hash":"95315c131198e1d78e9e76c04419e004aa627edb","modified":1599290835419},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/kibana-pod.png","hash":"56d4801ffe35a7b67bce82d1671813439be8609a","modified":1599290835423},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/kafka-pod.png","hash":"e73125790e7a51ad2f724fd518937ff9c0764da6","modified":1599290835415},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/kibana.png","hash":"865180e084989d63064f9c984d03a11afc47b80d","modified":1599290835422},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/add-cluster-2.png","hash":"1b9de318aa257d11f94f4b6ba965d7573bc78610","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/add-cluster-1.png","hash":"42dcdd324f050f3db4502b034cc8c43c5336b2db","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/configmap.png","hash":"6eaaf553c9288b6be7d7b30f51d016dc41dc191b","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/logstash-pod.png","hash":"3b98ea318afe0f720884d37dedf3115caf97a67e","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/pod.png","hash":"451787216850a069ced1278fd42c1d37bea6f217","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/kafka.png","hash":"95315c131198e1d78e9e76c04419e004aa627edb","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/kibana-pod.png","hash":"56d4801ffe35a7b67bce82d1671813439be8609a","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/es-pod.png","hash":"f4ceee98f71d989d64f60701a5bc9957768046f3","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/kafka-pod.png","hash":"e73125790e7a51ad2f724fd518937ff9c0764da6","modified":1616822479936},{"_id":"public/2021/03/27/在k8s中使用EFLK进行日志收集/kibana.png","hash":"865180e084989d63064f9c984d03a11afc47b80d","modified":1616822479936},{"_id":"source/_posts/kubeadm部署k8s-1-18集群.md","hash":"6baf39a4a469fb457b25e184a911eb1ec5290438","modified":1616915020676},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/.DS_Store","hash":"002ce977906d0a025513c9da8f36d84fa476de17","modified":1616913161946},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/calico-ip.png","hash":"09ce9a83c995cb0c4d555ddf2ece17500adec831","modified":1599290835453},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/cluster-check.png","hash":"24ce5c0972b9b454e7795bf9ced171962d821482","modified":1599290835459},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/getnode.png","hash":"cca3144948217ad6da5e3a1d76318129645a4f3f","modified":1599290835465},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/ipvs-rule.png","hash":"7e7ceb0a160f685d3a9dee118dcb3097d08c6972","modified":1599290835467},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/ipvs.png","hash":"8fbcc475b70df71470e99c27de0c5ac0e85975e5","modified":1599290835468},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/nodes.png","hash":"5a4cbbd814630d38b64eb765ddb9c5a6f6248e7e","modified":1599290835472},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/ansible-check.png","hash":"17ed2a4a4577997d4c3caf3f94f58bcc56c0d516","modified":1599290835452},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/calico-node.png","hash":"d13121504e5bdae80705842b27e49ef3485f604d","modified":1599290835454},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/etcd-helth.png","hash":"0d4545d89bd3805f15df8ccadb765ce7a6c1de14","modified":1599290835462},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/etcd-member.png","hash":"2ab5159afa1cb59f8cd52355ceaee1d928d10a8d","modified":1599290835464},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/etcd-cluster.png","hash":"3f8dfed7be6d7b786067aca7f64141d056df2aa9","modified":1599290835461},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/check-master.png","hash":"7eaef082099e0122c06ca5c2396b514ef47eae51","modified":1599290835457},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/kubeadm-init.png","hash":"001a0c763ade70a0cc5585b495975b64fee04591","modified":1599290835471},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/single-master.png","hash":"c6efea5343719c2248028b2063717f8b784b4ffa","modified":1599290835476},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/index.html","hash":"a1c22b523edbd57b4016eb40106e2a056556dae1","modified":1618633610681},{"_id":"public/categories/Kubernetes/部署/index.html","hash":"faad0289507bae0e513d39eaf875128f430c3a9d","modified":1618110803425},{"_id":"public/page/2/index.html","hash":"c0a9f4986c4c2bc1c835a137b1233f9b1b7e31b4","modified":1618633634480},{"_id":"public/tags/Kubernetes/index.html","hash":"cb3c69c4a00697e7b831c5b14153c50c810630a2","modified":1618633634480},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/calico-ip.png","hash":"09ce9a83c995cb0c4d555ddf2ece17500adec831","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/cluster-check.png","hash":"24ce5c0972b9b454e7795bf9ced171962d821482","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/getnode.png","hash":"cca3144948217ad6da5e3a1d76318129645a4f3f","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/ipvs-rule.png","hash":"7e7ceb0a160f685d3a9dee118dcb3097d08c6972","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/ipvs.png","hash":"8fbcc475b70df71470e99c27de0c5ac0e85975e5","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/nodes.png","hash":"5a4cbbd814630d38b64eb765ddb9c5a6f6248e7e","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/ansible-check.png","hash":"17ed2a4a4577997d4c3caf3f94f58bcc56c0d516","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/calico-node.png","hash":"d13121504e5bdae80705842b27e49ef3485f604d","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/etcd-cluster.png","hash":"3f8dfed7be6d7b786067aca7f64141d056df2aa9","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/etcd-helth.png","hash":"0d4545d89bd3805f15df8ccadb765ce7a6c1de14","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/etcd-member.png","hash":"2ab5159afa1cb59f8cd52355ceaee1d928d10a8d","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/kubeadm-init.png","hash":"001a0c763ade70a0cc5585b495975b64fee04591","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/check-master.png","hash":"7eaef082099e0122c06ca5c2396b514ef47eae51","modified":1616913296636},{"_id":"public/2021/03/28/kubeadm部署k8s-1-18集群/single-master.png","hash":"c6efea5343719c2248028b2063717f8b784b4ffa","modified":1616913296636},{"_id":"source/_posts/使用k3d和traefik快速搭建开发环境.md","hash":"432601e0e441bc585ff72141ca466c8a346bd0b5","modified":1616915360912},{"_id":"public/2021/03/28/使用k3d和traefik快速搭建开发环境/index.html","hash":"5af91a633d57fbdfeb0730c89ca8d56c2c6f1b8b","modified":1618633610681},{"_id":"public/categories/Kubernetes/集群部署/index.html","hash":"9449badea15ea6e6f4d193099fdf372fd0e29d70","modified":1618633634480},{"_id":"source/_posts/使用k3d和traefik快速搭建开发环境/.DS_Store","hash":"1b22ac77c91f2d8f21b80806c73e6a92ab72de56","modified":1616915106682},{"_id":"source/_posts/使用k3d和traefik快速搭建开发环境/dashboard.png","hash":"815b2c8d2904b01bba2daa98e2139704c24163bf","modified":1605329532837},{"_id":"source/_posts/使用k3d和traefik快速搭建开发环境/whoami.png","hash":"b39c70e56e5a62cad769d211027c0a8aee20551b","modified":1605330477606},{"_id":"public/2021/03/28/使用k3d和traefik快速搭建开发环境/whoami.png","hash":"b39c70e56e5a62cad769d211027c0a8aee20551b","modified":1616915392991},{"_id":"public/2021/03/28/使用k3d和traefik快速搭建开发环境/dashboard.png","hash":"815b2c8d2904b01bba2daa98e2139704c24163bf","modified":1616915392991},{"_id":"source/_posts/部署docker-ce.md","hash":"a6b54fcb36bf150aa8554e22167d80bb9252ee3e","modified":1617609173516},{"_id":"source/_posts/部署docker-ce/.DS_Store","hash":"21874e893f60c130aba40860b67fdb6fd20056ee","modified":1617608918805},{"_id":"source/_posts/部署docker-ce/docker-version.png","hash":"e383d33324bbd65bf138431b0e3d098d166f1d4a","modified":1599290835569},{"_id":"public/2021/04/05/部署docker-ce/index.html","hash":"d64240be2778d22575cd0ccc43dd5481223c87d2","modified":1618633610681},{"_id":"public/archives/2021/04/index.html","hash":"4d97e20363446eca4b11ca4a21b54c0f786c3cd5","modified":1618633634480},{"_id":"public/categories/Docker/index.html","hash":"cf896b39bb1c7aefe9a2e63adf5764b616ea7679","modified":1618633634480},{"_id":"public/categories/Docker/部署/index.html","hash":"e11195c079a27155b9739f9871a8f81e43a960b2","modified":1618633634480},{"_id":"public/tags/Docker/index.html","hash":"7c3a6b57f744f4de9a0f604009b8ec7908e5d1a1","modified":1618633634480},{"_id":"public/2021/04/05/部署docker-ce/docker-version.png","hash":"e383d33324bbd65bf138431b0e3d098d166f1d4a","modified":1617608971222},{"_id":"source/_posts/部署harbor镜像仓库.md","hash":"0d58b81e616da19156aa3c5c707f5d191468c420","modified":1617610101874},{"_id":"source/_posts/部署harbor镜像仓库/create-user.png","hash":"f75c209500395f7b6e6bbbef29d549289e39a3b2","modified":1599290835570},{"_id":"source/_posts/部署harbor镜像仓库/create.png","hash":"0a05e0a64c5bea9574e23e55de01dd1ff5003015","modified":1599290835570},{"_id":"source/_posts/部署harbor镜像仓库/harbor-login.png","hash":"23c85d368e48163f874e45c89983c759c4346460","modified":1599290835570},{"_id":"source/_posts/部署harbor镜像仓库/upload-image.png","hash":"25f96e2071491cc9dff09777d6cbad204962c28c","modified":1599290835570},{"_id":"source/_posts/部署harbor镜像仓库/.DS_Store","hash":"7f3c04cfbaafd24fd783aea86ee6974be4c5025c","modified":1617609290100},{"_id":"public/2021/04/05/部署harbor镜像仓库/index.html","hash":"471fbdcf8b104ab3c49a5a5676577552183d0c68","modified":1618633610681},{"_id":"public/categories/Docker/镜像仓库/index.html","hash":"e3aeea27b6320c27c7a1f111081a96a7d5bc49c8","modified":1618633634480},{"_id":"public/tags/Harbor/index.html","hash":"d5c854c4460e59e07f075ed4ffd6ca294280ba77","modified":1618633634480},{"_id":"public/2021/04/05/部署harbor镜像仓库/create-user.png","hash":"f75c209500395f7b6e6bbbef29d549289e39a3b2","modified":1617609379106},{"_id":"public/2021/04/05/部署harbor镜像仓库/create.png","hash":"0a05e0a64c5bea9574e23e55de01dd1ff5003015","modified":1617609379106},{"_id":"public/2021/04/05/部署harbor镜像仓库/harbor-login.png","hash":"23c85d368e48163f874e45c89983c759c4346460","modified":1617609379106},{"_id":"public/2021/04/05/部署harbor镜像仓库/upload-image.png","hash":"25f96e2071491cc9dff09777d6cbad204962c28c","modified":1617609379106},{"_id":"source/_posts/部署单点zookeeper.md","hash":"4a9736581420a63e49ba148b2e56c643315972c0","modified":1617692911130},{"_id":"source/_posts/部署单点zookeeper/.DS_Store","hash":"b06a7495293cba293b2573d4549ee1dc1a48645d","modified":1617692893579},{"_id":"source/_posts/部署单点zookeeper/start.png","hash":"7bbc0d33cb95c84846c4ac35c60771e03aaa5a52","modified":1607767294812},{"_id":"source/_posts/部署单点zookeeper/stop.png","hash":"aa628731318d5f2fb3cffb53812526fa43bce2f7","modified":1607767916185},{"_id":"source/_posts/部署单点zookeeper/status.png","hash":"7c61976b3a98b4ba936634e260b1456e66a60338","modified":1607767457720},{"_id":"public/2021/04/06/部署单点zookeeper/index.html","hash":"a0e5719e1468c5489e0feab4681dad0e8251b5b2","modified":1618633610681},{"_id":"public/categories/Zookeeper/index.html","hash":"1ea1c815c96de7963257b58408d186093a16c84b","modified":1618633634480},{"_id":"public/categories/Zookeeper/部署/index.html","hash":"9247644048d12bc8aba3a95340622aab7883ae4b","modified":1618633634480},{"_id":"public/tags/Zookeeper/index.html","hash":"fb4ee4943c305394cedb1dfd2b8bd42dc1ece9e3","modified":1618633634480},{"_id":"public/2021/04/06/部署单点zookeeper/stop.png","hash":"aa628731318d5f2fb3cffb53812526fa43bce2f7","modified":1617692923929},{"_id":"public/2021/04/06/部署单点zookeeper/start.png","hash":"7bbc0d33cb95c84846c4ac35c60771e03aaa5a52","modified":1617692923929},{"_id":"public/2021/04/06/部署单点zookeeper/status.png","hash":"7c61976b3a98b4ba936634e260b1456e66a60338","modified":1617692923929},{"_id":"source/_posts/二进制方式部署kubernetes-1-20.md","hash":"e3aa9db684218c79e20c54af0ee8f63e8320426d","modified":1618117268893},{"_id":"public/2021/04/11/二进制方式部署kubernetes-1-20/index.html","hash":"19d110625c29980ae9696a8a1d2135be8ad5b080","modified":1618633610681},{"_id":"public/archives/page/2/index.html","hash":"8647c3ace52f0c272aa649363f6970df47161eda","modified":1618633634480},{"_id":"public/archives/2021/page/2/index.html","hash":"d66f7e9004186b01eac6106401474d5c2d4f1768","modified":1618633634480},{"_id":"source/_posts/部署Nginx.md","hash":"9a8fa60fc57d613c0bcca5f41745d996fda61b91","modified":1618275270583},{"_id":"source/_posts/部署Nginx/.DS_Store","hash":"c82970566dfd3f413e6d47a36bd040fec5ff8534","modified":1618274408047},{"_id":"source/_posts/部署Nginx/install_source.png","hash":"a27b02fcf010964ca833d53dd2fc549e52949a9e","modified":1599290835572},{"_id":"public/2021/04/13/部署Nginx/index.html","hash":"46b3336ea8560e545ce486fb4e293c33da6a11a0","modified":1618633610681},{"_id":"public/categories/Nginx/index.html","hash":"d8cdfe539680a1086d7ceb034b57205d1141e379","modified":1618633634480},{"_id":"public/categories/Nginx/部署/index.html","hash":"23e6b2d64a4c88994267fc4efc8a6faeface2464","modified":1618633634480},{"_id":"public/tags/Nginx/index.html","hash":"6cfda2bc0819761c043c6881c7da551d92bc841a","modified":1618633634480},{"_id":"public/2021/04/13/部署Nginx/install_source.png","hash":"a27b02fcf010964ca833d53dd2fc549e52949a9e","modified":1618274469432},{"_id":"source/_posts/升级集群到1-18.md","hash":"dc91f5eff42fefebcb9f75813525485163232e01","modified":1618275590041},{"_id":"source/_posts/升级集群到1-18/.DS_Store","hash":"31f05fa5323884637436daa19051f0db28906649","modified":1618275030237},{"_id":"source/_posts/升级集群到1-18/carbon.png","hash":"b29c1c8c65ae1c923b7e6009c303c56366e01247","modified":1599290835491},{"_id":"source/_posts/升级集群到1-18/newversion.png","hash":"062c93633044768b7377667e0dc584458735d6ba","modified":1599290835494},{"_id":"source/_posts/升级集群到1-18/update-kubeadm.png","hash":"3debb778ab887ba714bdc7d4315db8bf3771b99a","modified":1599290835495},{"_id":"source/_posts/升级集群到1-18/update-res.png","hash":"da5105cb9de4db6fb586379f651cb8ebb897eb77","modified":1599290835498},{"_id":"source/_posts/升级集群到1-18/update.png","hash":"04431574468c7db31d2d96d39ca4d7b710dc5f11","modified":1599290835499},{"_id":"source/_posts/升级集群到1-18/update-node.png","hash":"4b383fa12090e0107da8a07853060b1bd97cf61d","modified":1599290835497},{"_id":"source/_posts/升级集群到1-18/drain.png","hash":"68b4dc6b5bfb4a6b70f069eb2bc5e5936d9a2b79","modified":1599290835493},{"_id":"public/2021/04/13/升级集群到1-18/index.html","hash":"678a84796d41d6049ca2b70198bc2335dec23baa","modified":1618633610681},{"_id":"public/2021/04/13/升级集群到1-18/carbon.png","hash":"b29c1c8c65ae1c923b7e6009c303c56366e01247","modified":1618275223826},{"_id":"public/2021/04/13/升级集群到1-18/newversion.png","hash":"062c93633044768b7377667e0dc584458735d6ba","modified":1618275223826},{"_id":"public/2021/04/13/升级集群到1-18/update-kubeadm.png","hash":"3debb778ab887ba714bdc7d4315db8bf3771b99a","modified":1618275223826},{"_id":"public/2021/04/13/升级集群到1-18/update.png","hash":"04431574468c7db31d2d96d39ca4d7b710dc5f11","modified":1618275223826},{"_id":"public/2021/04/13/升级集群到1-18/update-res.png","hash":"da5105cb9de4db6fb586379f651cb8ebb897eb77","modified":1618275223826},{"_id":"public/2021/04/13/升级集群到1-18/update-node.png","hash":"4b383fa12090e0107da8a07853060b1bd97cf61d","modified":1618275223826},{"_id":"public/2021/04/13/升级集群到1-18/drain.png","hash":"68b4dc6b5bfb4a6b70f069eb2bc5e5936d9a2b79","modified":1618275223826},{"_id":"source/_posts/kafka常用命令操作.md","hash":"596a0e9c72b1c39fe22a3a256b475d964a958927","modified":1618632591959},{"_id":"public/2021/04/17/kafka常用命令操作/index.html","hash":"9a3e08ca5e3dcb360252201560d48412eb0688a2","modified":1618633610681},{"_id":"public/categories/消息中间件/Kafka/index.html","hash":"5e08dcbc652ba23777cf4d171737a553a86ebf7f","modified":1618633634480},{"_id":"public/categories/消息中间件/Kafka/常用命令/index.html","hash":"e9c1b8f6c610c2b9f1fab9c3f5261053512f7371","modified":1618633634480},{"_id":"public/tags/Kafka/index.html","hash":"ea9b26903e0dccd1cde244d69550a4a1b76e033e","modified":1618633634480},{"_id":"source/_posts/zookeeper常用命令行操作/.DS_Store","hash":"37a135807012abb110cf00d5d290fe966f8c1096","modified":1618632900725},{"_id":"source/_posts/zookeeper常用命令行操作.md","hash":"8c96003dc801b26069604173588f2558c9d495e7","modified":1618633067941},{"_id":"source/_posts/zookeeper常用命令行操作/ls.png","hash":"6c48f4abd0ffb87815ef510d6656158521b3adb4","modified":1607767820992},{"_id":"public/2021/04/17/zookeeper常用命令行操作/index.html","hash":"69323e7b2563b3ca9182617683ff26ebc23af453","modified":1618633610681},{"_id":"public/categories/Zookeeper/常用操作/index.html","hash":"10dbb1ca51164c8e472eece483f23f819f43f51f","modified":1618633634480},{"_id":"public/2021/04/17/zookeeper常用命令行操作/ls.png","hash":"6c48f4abd0ffb87815ef510d6656158521b3adb4","modified":1618633076283},{"_id":"source/_posts/部署zookeeper集群.md","hash":"1abf79e5c50c7bf884ae3a6367ab0eb1afa6c5d7","modified":1618633502709},{"_id":"public/2021/04/17/部署zookeeper集群/index.html","hash":"6ab5976bbf096dd55ead97d8ee2b6a1376153298","modified":1618633610681},{"_id":"public/page/3/index.html","hash":"efa2e235d5ab6cbbe40c75a27af83038044a6667","modified":1618633634480},{"_id":"source/_posts/docker方式部署zookeeper集群.md","hash":"f5df7fd59a11fdf5d9d5fac06fe464a99ef03fee","modified":1618633602786},{"_id":"public/2021/04/17/docker方式部署zookeeper集群/index.html","hash":"f3178cdb044354c754a0ecc5082cfaee974b2a0e","modified":1618633610681}],"Category":[{"name":"消息中间件","_id":"ckmhcqa1z0006ihklc1vl5jh3"},{"name":"RabbitMQ","parent":"ckmhcqa1z0006ihklc1vl5jh3","_id":"ckmhcqa200009ihklec2k1y6e"},{"name":"部署","parent":"ckmhcqa200009ihklec2k1y6e","_id":"ckmhcqa20000aihkl1z5r5ap4"},{"name":"Kubernetes","_id":"ckmhedtrs000169kl7xhs1t43"},{"name":"Ingress-nginx","parent":"ckmhedtrs000169kl7xhs1t43","_id":"ckmhedtru000469kl8n316bgc"},{"name":"数据库","_id":"ckmhnxqqo0001rekl6vy4gso0"},{"name":"Redis","parent":"ckmhnxqqo0001rekl6vy4gso0","_id":"ckmhnxqqq0004rekl8e4o6n3y"},{"name":"部署","parent":"ckmhnxqqq0004rekl8e4o6n3y","_id":"ckmhnxqqq0005rekl0rof3u4y"},{"name":"MySQL","parent":"ckmhnxqqo0001rekl6vy4gso0","_id":"ckmhomlel00029akl2yue81ng"},{"name":"部署","parent":"ckmhomlel00029akl2yue81ng","_id":"ckmhomlem00049akl1aku3r09"},{"name":"存储","parent":"ckmhedtrs000169kl7xhs1t43","_id":"ckmm1micp0002tpkldcks657m"},{"name":"NFS","parent":"ckmm1micp0002tpkldcks657m","_id":"ckmm1micq0004tpklg7gz7y4d"},{"name":"存储","_id":"ckmm2hjla00016lklewircegs"},{"name":"NFS","parent":"ckmm2hjla00016lklewircegs","_id":"ckmm2hjld00036lkle3r87h5e"},{"name":"部署","parent":"ckmm2hjld00036lkle3r87h5e","_id":"ckmm2hjld00046lkl9tkjd5h8"},{"name":"日志收集","parent":"ckmhedtrs000169kl7xhs1t43","_id":"ckmr8oskw00023nkl0p62535k"},{"name":"部署","parent":"ckmhedtrs000169kl7xhs1t43","_id":"ckmssfie70002h0kl3bae30bl"},{"name":"集群部署","parent":"ckmhedtrs000169kl7xhs1t43","_id":"ckmstgf290000i8klgooka7fy"},{"name":"Docker","_id":"ckn4am8520001zkkl9zt70kyu"},{"name":"部署","parent":"ckn4am8520001zkkl9zt70kyu","_id":"ckn4am8560004zkkl2h3f7x0q"},{"name":"镜像仓库","parent":"ckn4am8520001zkkl9zt70kyu","_id":"ckn4auyvf0002pckld7fda7xn"},{"name":"Zookeeper","_id":"ckn5olmoz0001u5klc9q15f6g"},{"name":"部署","parent":"ckn5olmoz0001u5klc9q15f6g","_id":"ckn5olmp30004u5kl93iy22tz"},{"name":"Nginx","_id":"cknfau6530001sbkl01vu52dk"},{"name":"部署","parent":"cknfau6530001sbkl01vu52dk","_id":"cknfau6580004sbklgcsvabwj"},{"name":"Kafka","parent":"ckmhcqa1z0006ihklc1vl5jh3","_id":"cknl8040k00028hklfcy47m0x"},{"name":"常用命令","parent":"cknl8040k00028hklfcy47m0x","_id":"cknl8040l00048hkl0e642uk8"},{"name":"常用操作","parent":"ckn5olmoz0001u5klc9q15f6g","_id":"cknl8cbib000285kla7rd4vfn"}],"Data":[],"Page":[{"title":"archives","date":"2021-03-20T03:56:13.000Z","_content":"","source":"archives/index.md","raw":"---\ntitle: archives\ndate: 2021-03-20 11:56:13\n---\n","updated":"2021-03-20T03:56:13.023Z","path":"archives/index.html","comments":1,"layout":"page","_id":"ckmhcqa1r0000ihkld47ub9ui","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""},{"title":"categories","date":"2021-03-20T03:54:34.000Z","_content":"","source":"categories/index-1.md","raw":"---\ntitle: categories\ndate: 2021-03-20 11:54:34\n---\n","updated":"2021-03-20T03:54:34.907Z","path":"categories/index-1.html","comments":1,"layout":"page","_id":"ckmhcqa1t0001ihklhrn756l3","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""},{"title":"分类","date":"2020-07-01T16:00:00.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2020-07-02 00:00:00\ntype: \"categories\"\n---\n","updated":"2020-09-05T07:27:15.590Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ckmhcqa1u0002ihklhy3j15r5","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""},{"title":"tags","date":"2021-03-20T03:54:41.000Z","_content":"","source":"tags/index-1.md","raw":"---\ntitle: tags\ndate: 2021-03-20 11:54:41\n---\n","updated":"2021-03-20T03:54:41.066Z","path":"tags/index-1.html","comments":1,"layout":"page","_id":"ckmhcqa1u0003ihklh8dw4231","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""},{"title":"标签","date":"2020-07-01T16:00:00.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2020-07-02 00:00:00\ntype: \"tags\"\n---\n","updated":"2020-09-05T07:27:15.590Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ckmhcqa1w0004ihkl0krka2jz","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""}],"Post":[{"title":"在k8s中部署RabbitMQ","date":"2021-03-20T04:09:11.000Z","description":"本文介绍在k8s中使用有状态服务部署RabbitMQ 3.8.3","cover":"https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=1271185307,1858861969&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个RabbitMQ 3.8.3 版本的集群\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 准备\n\n{% tabs comments %}\n\n<!-- tab K8S集群环境 -->\n\n本文使用的 k8s版本为 `1.20.4`版本，将使用`storageclass`作为持久化存储，底层为`nfs`，使用`default` namespace部署。\n\n<!-- endtab -->\n\n<!-- tab RabbitMq -->\n\n`RabbitMQ`在`k8s`集群中通过`rabbitmq_peer_discovery_k8s plugin`与`k8s apiserver`进行交互，获取各个服务的`URL`，且`RabbitMQ`在`k8s`集群中必须用`statefulset`和`headless service`进行匹配；\n\n> rabbitmq_peer_discovery_k8s`是`RabbitMQ`官方基于第三方开源项目`rabbitmq-autocluster`开发，对`3.7.X`及以上版本提供的`Kubernetes`下的对等发现插件，可实现`rabbitmq`集群在`k8s`中的自动化部署，因此低于3.7.X版本请使用`rabbitmq-autocluster\n\n\n\n这里部署使用的版本是`3.8.3`，其他版本信息可以参看官方文档：[rabbitmq download](https://www.rabbitmq.com/download.html)\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署\n\n\n\n## 创建相关文件\n\n\n\n{% tabs comments %}\n\n<!-- tab 创建configmap -->\n\n创建一个`rabbitmq-configmap.yaml`的文件：\n\n```yaml\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: rabbitmq-cluster-config\n  namespace: default\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\ndata:\n    enabled_plugins: |\n      [rabbitmq_management,rabbitmq_peer_discovery_k8s].\n    rabbitmq.conf: |\n      default_user = admin\n      default_pass = 123!@#\n      cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s\n      cluster_formation.k8s.host = kubernetes.default.svc.cluster.local\n      cluster_formation.k8s.address_type = hostname\n      cluster_formation.node_cleanup.interval = 30\n      cluster_formation.node_cleanup.only_log_warning = true\n      cluster_partition_handling = autoheal\n      queue_master_locator=min-masters\n      loopback_users.guest = false\n      cluster_formation.randomized_startup_delay_range.min = 0\n      cluster_formation.randomized_startup_delay_range.max = 2\n      cluster_formation.k8s.hostname_suffix = .rabbitmq-cluster.default.svc.cluster.local\n      vm_memory_high_watermark.absolute = 1GB\n      disk_free_limit.absolute = 2GB\n```\n\n\n\n- `enabled_plugins`：声明开启的插件；\n- `default_user/default_pass`：指定用户名和密码；\n- `cluster_formation.k8s.address_type`：从`k8s`返回的`Pod`容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是`ip`，但是默认情况下在`k8s`中`pod`的`ip`都是不固定的，因此可能导致节点的配置和数据丢失，后面的`yaml`中会通过引用元数据的方式固定`pod`的主机名；\n\n<!-- endtab -->\n\n<!-- tab 创建service -->\n\n创建一个`rabbitmq-service.yaml`的文件：\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster\n  namespace: default\nspec:\n  clusterIP: None\n  ports:\n  - name: rmqport\n    port: 5672\n    targetPort: 5672\n  selector:\n    app: rabbitmq-cluster\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster-manage\n  namespace: default\nspec:\n  ports:\n  - name: http\n    port: 15672\n    protocol: TCP\n    targetPort: 15672\n  selector:\n    app: rabbitmq-cluster\n  type: NodePort\n```\n\n\n\n> 这里定义了两个service，一个是`NodePort`用于用户通过web访问的管理页面，另一个是用于rabbitmq服务通信；\n\n<!-- endtab -->\n\n<!-- tab RBAC -->\n\n创建一个`rabbitmq-rbac.yaml`的文件：\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\nrules:\n- apiGroups: [\"\"]\n  resources: [\"endpoints\"]\n  verbs: [\"get\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: rabbitmq-cluster\nsubjects:\n- kind: ServiceAccount\n  name: rabbitmq-cluster\n  namespace: default\n```\n\n<!-- endtab -->\n\n\n\n<!-- tab 创建statefulset -->\n\n创建一个`rabbitmq-cluster-sts.yaml`的文件：\n\n```yaml\nkind: StatefulSet\napiVersion: apps/v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster\n  namespace: default\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: rabbitmq-cluster\n  serviceName: rabbitmq-cluster\n  template:\n    metadata:\n      labels:\n        app: rabbitmq-cluster\n    spec:\n      containers:\n      - args:\n        - -c\n        - cp -v /etc/rabbitmq/rabbitmq.conf ${RABBITMQ_CONFIG_FILE}; exec docker-entrypoint.sh\n          rabbitmq-server\n        command:\n        - sh\n        env:\n        - name: TZ\n          value: 'Asia/Shanghai'\n        - name: RABBITMQ_ERLANG_COOKIE\n          value: 'SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY='\n        - name: K8S_SERVICE_NAME\n          value: rabbitmq-cluster\n        - name: POD_IP\n          valueFrom:\n            fieldRef:\n              fieldPath: status.podIP\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: POD_NAMESPACE\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.namespace\n        - name: RABBITMQ_USE_LONGNAME\n          value: \"true\"\n        - name: RABBITMQ_NODENAME\n          value: rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local\n        - name: RABBITMQ_CONFIG_FILE\n          value: /var/lib/rabbitmq/rabbitmq.conf\n        image: rabbitmq:3.8.3-management\n        imagePullPolicy: IfNotPresent\n        livenessProbe:\n          exec:\n            command:\n            - rabbitmq-diagnostics\n            - status\n          initialDelaySeconds: 60\n          periodSeconds: 60\n          timeoutSeconds: 15\n        name: rabbitmq\n        ports:\n        - containerPort: 15672\n          name: http\n          protocol: TCP\n        - containerPort: 5672\n          name: amqp\n          protocol: TCP\n        readinessProbe:\n          exec:\n            command:\n            - rabbitmq-diagnostics\n            - status\n          initialDelaySeconds: 20\n          periodSeconds: 60\n          timeoutSeconds: 10\n        volumeMounts:\n        - mountPath: /etc/rabbitmq\n          name: config-volume\n          readOnly: false\n        - mountPath: /var/lib/rabbitmq\n          name: rabbitmq-storage\n          readOnly: false\n        - name: timezone\n          mountPath: /etc/localtime\n          readOnly: true\n      serviceAccountName: rabbitmq-cluster\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: config-volume\n        configMap:\n          items:\n          - key: rabbitmq.conf\n            path: rabbitmq.conf\n          - key: enabled_plugins\n            path: enabled_plugins\n          name: rabbitmq-cluster-config\n      - name: timezone\n        hostPath:\n          path: /usr/share/zoneinfo/Asia/Shanghai\n  volumeClaimTemplates:\n  - metadata:\n      name: rabbitmq-storage\n    spec:\n      accessModes:\n      - ReadWriteMany\n      storageClassName: \"managed-nfs-storage\"\n      resources:\n        requests:\n          storage: 2Gi\n```\n\n> 这里指定了storageclass的名字为：`managed-nfs-storage`，需要根据实际情况调整\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 部署服务\n\n执行下面的命令完成部署：\n\n```bash\nkubectl apply -f .\n```\n\n\n\n## 检查\n\n执行下面的命令检查资源创建情况，确保pod都处于运行状态：\n\n```bash\nkubectl get pod,sts -n default\n```\n\n\n\n<img src=\"./bushu.png\" style=\"zoom:70%;\" />\n\n\n\n检查pod日志，观察集群建立情况：\n\n<img src=\"./log.png\" style=\"zoom:70%;\" />\n\n\n\n进入pod中，通过客户端命令查看集群状态：\n\n```bash\nkubectl exec -ti  rabbitmq-cluster-0 -n default -- rabbitmqctl cluster_status\n```\n\n<img src=\"./client_log.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问管理页面\n\n查看对应service使用的宿主机端口：\n\n```bash\nkubectl get svc -n default\n```\n\n<img src=\"./service.png\" style=\"zoom:70%;\" />\n\n\n\n通过浏览器访问node节点的30888端口即可打开rabbitmq的管理页面：\n\n<img src=\"./web.png\" style=\"zoom:70%;\" />\n\n","source":"_posts/在k8s中部署RabbitMQ.md","raw":"---\ntitle: 在k8s中部署RabbitMQ\ndate: 2021-03-20 12:09:11\ntags:\n- RabbitMQ\ncategories:\n- 消息中间件\n- RabbitMQ\n- 部署\ndescription: 本文介绍在k8s中使用有状态服务部署RabbitMQ 3.8.3\ncover: https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=1271185307,1858861969&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个RabbitMQ 3.8.3 版本的集群\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 准备\n\n{% tabs comments %}\n\n<!-- tab K8S集群环境 -->\n\n本文使用的 k8s版本为 `1.20.4`版本，将使用`storageclass`作为持久化存储，底层为`nfs`，使用`default` namespace部署。\n\n<!-- endtab -->\n\n<!-- tab RabbitMq -->\n\n`RabbitMQ`在`k8s`集群中通过`rabbitmq_peer_discovery_k8s plugin`与`k8s apiserver`进行交互，获取各个服务的`URL`，且`RabbitMQ`在`k8s`集群中必须用`statefulset`和`headless service`进行匹配；\n\n> rabbitmq_peer_discovery_k8s`是`RabbitMQ`官方基于第三方开源项目`rabbitmq-autocluster`开发，对`3.7.X`及以上版本提供的`Kubernetes`下的对等发现插件，可实现`rabbitmq`集群在`k8s`中的自动化部署，因此低于3.7.X版本请使用`rabbitmq-autocluster\n\n\n\n这里部署使用的版本是`3.8.3`，其他版本信息可以参看官方文档：[rabbitmq download](https://www.rabbitmq.com/download.html)\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署\n\n\n\n## 创建相关文件\n\n\n\n{% tabs comments %}\n\n<!-- tab 创建configmap -->\n\n创建一个`rabbitmq-configmap.yaml`的文件：\n\n```yaml\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: rabbitmq-cluster-config\n  namespace: default\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\ndata:\n    enabled_plugins: |\n      [rabbitmq_management,rabbitmq_peer_discovery_k8s].\n    rabbitmq.conf: |\n      default_user = admin\n      default_pass = 123!@#\n      cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s\n      cluster_formation.k8s.host = kubernetes.default.svc.cluster.local\n      cluster_formation.k8s.address_type = hostname\n      cluster_formation.node_cleanup.interval = 30\n      cluster_formation.node_cleanup.only_log_warning = true\n      cluster_partition_handling = autoheal\n      queue_master_locator=min-masters\n      loopback_users.guest = false\n      cluster_formation.randomized_startup_delay_range.min = 0\n      cluster_formation.randomized_startup_delay_range.max = 2\n      cluster_formation.k8s.hostname_suffix = .rabbitmq-cluster.default.svc.cluster.local\n      vm_memory_high_watermark.absolute = 1GB\n      disk_free_limit.absolute = 2GB\n```\n\n\n\n- `enabled_plugins`：声明开启的插件；\n- `default_user/default_pass`：指定用户名和密码；\n- `cluster_formation.k8s.address_type`：从`k8s`返回的`Pod`容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是`ip`，但是默认情况下在`k8s`中`pod`的`ip`都是不固定的，因此可能导致节点的配置和数据丢失，后面的`yaml`中会通过引用元数据的方式固定`pod`的主机名；\n\n<!-- endtab -->\n\n<!-- tab 创建service -->\n\n创建一个`rabbitmq-service.yaml`的文件：\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster\n  namespace: default\nspec:\n  clusterIP: None\n  ports:\n  - name: rmqport\n    port: 5672\n    targetPort: 5672\n  selector:\n    app: rabbitmq-cluster\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster-manage\n  namespace: default\nspec:\n  ports:\n  - name: http\n    port: 15672\n    protocol: TCP\n    targetPort: 15672\n  selector:\n    app: rabbitmq-cluster\n  type: NodePort\n```\n\n\n\n> 这里定义了两个service，一个是`NodePort`用于用户通过web访问的管理页面，另一个是用于rabbitmq服务通信；\n\n<!-- endtab -->\n\n<!-- tab RBAC -->\n\n创建一个`rabbitmq-rbac.yaml`的文件：\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\nrules:\n- apiGroups: [\"\"]\n  resources: [\"endpoints\"]\n  verbs: [\"get\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: rabbitmq-cluster\nsubjects:\n- kind: ServiceAccount\n  name: rabbitmq-cluster\n  namespace: default\n```\n\n<!-- endtab -->\n\n\n\n<!-- tab 创建statefulset -->\n\n创建一个`rabbitmq-cluster-sts.yaml`的文件：\n\n```yaml\nkind: StatefulSet\napiVersion: apps/v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster\n  namespace: default\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: rabbitmq-cluster\n  serviceName: rabbitmq-cluster\n  template:\n    metadata:\n      labels:\n        app: rabbitmq-cluster\n    spec:\n      containers:\n      - args:\n        - -c\n        - cp -v /etc/rabbitmq/rabbitmq.conf ${RABBITMQ_CONFIG_FILE}; exec docker-entrypoint.sh\n          rabbitmq-server\n        command:\n        - sh\n        env:\n        - name: TZ\n          value: 'Asia/Shanghai'\n        - name: RABBITMQ_ERLANG_COOKIE\n          value: 'SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY='\n        - name: K8S_SERVICE_NAME\n          value: rabbitmq-cluster\n        - name: POD_IP\n          valueFrom:\n            fieldRef:\n              fieldPath: status.podIP\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: POD_NAMESPACE\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.namespace\n        - name: RABBITMQ_USE_LONGNAME\n          value: \"true\"\n        - name: RABBITMQ_NODENAME\n          value: rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local\n        - name: RABBITMQ_CONFIG_FILE\n          value: /var/lib/rabbitmq/rabbitmq.conf\n        image: rabbitmq:3.8.3-management\n        imagePullPolicy: IfNotPresent\n        livenessProbe:\n          exec:\n            command:\n            - rabbitmq-diagnostics\n            - status\n          initialDelaySeconds: 60\n          periodSeconds: 60\n          timeoutSeconds: 15\n        name: rabbitmq\n        ports:\n        - containerPort: 15672\n          name: http\n          protocol: TCP\n        - containerPort: 5672\n          name: amqp\n          protocol: TCP\n        readinessProbe:\n          exec:\n            command:\n            - rabbitmq-diagnostics\n            - status\n          initialDelaySeconds: 20\n          periodSeconds: 60\n          timeoutSeconds: 10\n        volumeMounts:\n        - mountPath: /etc/rabbitmq\n          name: config-volume\n          readOnly: false\n        - mountPath: /var/lib/rabbitmq\n          name: rabbitmq-storage\n          readOnly: false\n        - name: timezone\n          mountPath: /etc/localtime\n          readOnly: true\n      serviceAccountName: rabbitmq-cluster\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: config-volume\n        configMap:\n          items:\n          - key: rabbitmq.conf\n            path: rabbitmq.conf\n          - key: enabled_plugins\n            path: enabled_plugins\n          name: rabbitmq-cluster-config\n      - name: timezone\n        hostPath:\n          path: /usr/share/zoneinfo/Asia/Shanghai\n  volumeClaimTemplates:\n  - metadata:\n      name: rabbitmq-storage\n    spec:\n      accessModes:\n      - ReadWriteMany\n      storageClassName: \"managed-nfs-storage\"\n      resources:\n        requests:\n          storage: 2Gi\n```\n\n> 这里指定了storageclass的名字为：`managed-nfs-storage`，需要根据实际情况调整\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 部署服务\n\n执行下面的命令完成部署：\n\n```bash\nkubectl apply -f .\n```\n\n\n\n## 检查\n\n执行下面的命令检查资源创建情况，确保pod都处于运行状态：\n\n```bash\nkubectl get pod,sts -n default\n```\n\n\n\n<img src=\"./bushu.png\" style=\"zoom:70%;\" />\n\n\n\n检查pod日志，观察集群建立情况：\n\n<img src=\"./log.png\" style=\"zoom:70%;\" />\n\n\n\n进入pod中，通过客户端命令查看集群状态：\n\n```bash\nkubectl exec -ti  rabbitmq-cluster-0 -n default -- rabbitmqctl cluster_status\n```\n\n<img src=\"./client_log.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问管理页面\n\n查看对应service使用的宿主机端口：\n\n```bash\nkubectl get svc -n default\n```\n\n<img src=\"./service.png\" style=\"zoom:70%;\" />\n\n\n\n通过浏览器访问node节点的30888端口即可打开rabbitmq的管理页面：\n\n<img src=\"./web.png\" style=\"zoom:70%;\" />\n\n","slug":"在k8s中部署RabbitMQ","published":1,"updated":"2021-03-20T07:16:13.580Z","_id":"ckmhcqa1w0005ihkl8wyy7a8c","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个RabbitMQ 3.8.3 版本的集群</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">K8S集群环境</button></li><li class=\"tab\"><button data-href=\"#comments-2\">RabbitMq</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>本文使用的 k8s版本为 <code>1.20.4</code>版本，将使用<code>storageclass</code>作为持久化存储，底层为<code>nfs</code>，使用<code>default</code> namespace部署。</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p><code>RabbitMQ</code>在<code>k8s</code>集群中通过<code>rabbitmq_peer_discovery_k8s plugin</code>与<code>k8s apiserver</code>进行交互，获取各个服务的<code>URL</code>，且<code>RabbitMQ</code>在<code>k8s</code>集群中必须用<code>statefulset</code>和<code>headless service</code>进行匹配；</p>\n<blockquote>\n<p>rabbitmq_peer_discovery_k8s<code>是</code>RabbitMQ<code>官方基于第三方开源项目</code>rabbitmq-autocluster<code>开发，对</code>3.7.X<code>及以上版本提供的</code>Kubernetes<code>下的对等发现插件，可实现</code>rabbitmq<code>集群在</code>k8s<code>中的自动化部署，因此低于3.7.X版本请使用</code>rabbitmq-autocluster</p>\n</blockquote>\n<p>这里部署使用的版本是<code>3.8.3</code>，其他版本信息可以参看官方文档：<a href=\"https://www.rabbitmq.com/download.html\">rabbitmq download</a></p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h1><h2 id=\"创建相关文件\"><a href=\"#创建相关文件\" class=\"headerlink\" title=\"创建相关文件\"></a>创建相关文件</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建configmap</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">RBAC</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建statefulset</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>创建一个<code>rabbitmq-configmap.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">addonmanager.kubernetes.io/mode:</span> <span class=\"string\">Reconcile</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">    <span class=\"attr\">enabled_plugins:</span> <span class=\"string\">|</span></span><br><span class=\"line\">      [<span class=\"string\">rabbitmq_management</span>,<span class=\"string\">rabbitmq_peer_discovery_k8s</span>]<span class=\"string\">.</span></span><br><span class=\"line\">    <span class=\"attr\">rabbitmq.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">      <span class=\"string\">default_user</span> <span class=\"string\">=</span> <span class=\"string\">admin</span></span><br><span class=\"line\">      <span class=\"string\">default_pass</span> <span class=\"string\">=</span> <span class=\"number\">123</span><span class=\"type\">!@#</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.peer_discovery_backend</span> <span class=\"string\">=</span> <span class=\"string\">rabbit_peer_discovery_k8s</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.host</span> <span class=\"string\">=</span> <span class=\"string\">kubernetes.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.address_type</span> <span class=\"string\">=</span> <span class=\"string\">hostname</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.node_cleanup.interval</span> <span class=\"string\">=</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.node_cleanup.only_log_warning</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"string\">cluster_partition_handling</span> <span class=\"string\">=</span> <span class=\"string\">autoheal</span></span><br><span class=\"line\">      <span class=\"string\">queue_master_locator=min-masters</span></span><br><span class=\"line\">      <span class=\"string\">loopback_users.guest</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.randomized_startup_delay_range.min</span> <span class=\"string\">=</span> <span class=\"number\">0</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.randomized_startup_delay_range.max</span> <span class=\"string\">=</span> <span class=\"number\">2</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.hostname_suffix</span> <span class=\"string\">=</span> <span class=\"string\">.rabbitmq-cluster.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"string\">vm_memory_high_watermark.absolute</span> <span class=\"string\">=</span> <span class=\"string\">1GB</span></span><br><span class=\"line\">      <span class=\"string\">disk_free_limit.absolute</span> <span class=\"string\">=</span> <span class=\"string\">2GB</span></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><code>enabled_plugins</code>：声明开启的插件；</li>\n<li><code>default_user/default_pass</code>：指定用户名和密码；</li>\n<li><code>cluster_formation.k8s.address_type</code>：从<code>k8s</code>返回的<code>Pod</code>容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是<code>ip</code>，但是默认情况下在<code>k8s</code>中<code>pod</code>的<code>ip</code>都是不固定的，因此可能导致节点的配置和数据丢失，后面的<code>yaml</code>中会通过引用元数据的方式固定<code>pod</code>的主机名；</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>创建一个<code>rabbitmq-service.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">rmqport</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-manage</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>这里定义了两个service，一个是<code>NodePort</code>用于用户通过web访问的管理页面，另一个是用于rabbitmq服务通信；</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>创建一个<code>rabbitmq-rbac.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><p>创建一个<code>rabbitmq-cluster-sts.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">cp</span> <span class=\"string\">-v</span> <span class=\"string\">/etc/rabbitmq/rabbitmq.conf</span> <span class=\"string\">$&#123;RABBITMQ_CONFIG_FILE&#125;;</span> <span class=\"string\">exec</span> <span class=\"string\">docker-entrypoint.sh</span></span><br><span class=\"line\">          <span class=\"string\">rabbitmq-server</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;Asia/Shanghai&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_ERLANG_COOKIE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY=&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">K8S_SERVICE_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAMESPACE</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_USE_LONGNAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_NODENAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_CONFIG_FILE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/var/lib/rabbitmq/rabbitmq.conf</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">rabbitmq:3.8.3-management</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">rabbitmq-diagnostics</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">status</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">amqp</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">rabbitmq-diagnostics</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">status</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-storage</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">items:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">rabbitmq.conf</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">rabbitmq.conf</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">enabled_plugins</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">enabled_plugins</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-config</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\">        <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-storage</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">&quot;managed-nfs-storage&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">2Gi</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里指定了storageclass的名字为：<code>managed-nfs-storage</code>，需要根据实际情况调整</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"部署服务\"><a href=\"#部署服务\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h2><p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f .</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查\"><a href=\"#检查\" class=\"headerlink\" title=\"检查\"></a>检查</h2><p>执行下面的命令检查资源创建情况，确保pod都处于运行状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,sts -n default</span><br></pre></td></tr></table></figure>\n\n\n\n<img src= \"/img/loading.gif\" data-src=\"./bushu.png\" style=\"zoom:70%;\" />\n\n\n\n<p>检查pod日志，观察集群建立情况：</p>\n<img src= \"/img/loading.gif\" data-src=\"./log.png\" style=\"zoom:70%;\" />\n\n\n\n<p>进入pod中，通过客户端命令查看集群状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -ti  rabbitmq-cluster-0 -n default -- rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./client_log.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问管理页面\"><a href=\"#访问管理页面\" class=\"headerlink\" title=\"访问管理页面\"></a>访问管理页面</h2><p>查看对应service使用的宿主机端口：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n default</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./service.png\" style=\"zoom:70%;\" />\n\n\n\n<p>通过浏览器访问node节点的30888端口即可打开rabbitmq的管理页面：</p>\n<img src= \"/img/loading.gif\" data-src=\"./web.png\" style=\"zoom:70%;\" />\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个RabbitMQ 3.8.3 版本的集群</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">K8S集群环境</button></li><li class=\"tab\"><button data-href=\"#comments-2\">RabbitMq</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>本文使用的 k8s版本为 <code>1.20.4</code>版本，将使用<code>storageclass</code>作为持久化存储，底层为<code>nfs</code>，使用<code>default</code> namespace部署。</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p><code>RabbitMQ</code>在<code>k8s</code>集群中通过<code>rabbitmq_peer_discovery_k8s plugin</code>与<code>k8s apiserver</code>进行交互，获取各个服务的<code>URL</code>，且<code>RabbitMQ</code>在<code>k8s</code>集群中必须用<code>statefulset</code>和<code>headless service</code>进行匹配；</p>\n<blockquote>\n<p>rabbitmq_peer_discovery_k8s<code>是</code>RabbitMQ<code>官方基于第三方开源项目</code>rabbitmq-autocluster<code>开发，对</code>3.7.X<code>及以上版本提供的</code>Kubernetes<code>下的对等发现插件，可实现</code>rabbitmq<code>集群在</code>k8s<code>中的自动化部署，因此低于3.7.X版本请使用</code>rabbitmq-autocluster</p>\n</blockquote>\n<p>这里部署使用的版本是<code>3.8.3</code>，其他版本信息可以参看官方文档：<a href=\"https://www.rabbitmq.com/download.html\">rabbitmq download</a></p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h1><h2 id=\"创建相关文件\"><a href=\"#创建相关文件\" class=\"headerlink\" title=\"创建相关文件\"></a>创建相关文件</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建configmap</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">RBAC</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建statefulset</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>创建一个<code>rabbitmq-configmap.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">addonmanager.kubernetes.io/mode:</span> <span class=\"string\">Reconcile</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">    <span class=\"attr\">enabled_plugins:</span> <span class=\"string\">|</span></span><br><span class=\"line\">      [<span class=\"string\">rabbitmq_management</span>,<span class=\"string\">rabbitmq_peer_discovery_k8s</span>]<span class=\"string\">.</span></span><br><span class=\"line\">    <span class=\"attr\">rabbitmq.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">      <span class=\"string\">default_user</span> <span class=\"string\">=</span> <span class=\"string\">admin</span></span><br><span class=\"line\">      <span class=\"string\">default_pass</span> <span class=\"string\">=</span> <span class=\"number\">123</span><span class=\"type\">!@#</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.peer_discovery_backend</span> <span class=\"string\">=</span> <span class=\"string\">rabbit_peer_discovery_k8s</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.host</span> <span class=\"string\">=</span> <span class=\"string\">kubernetes.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.address_type</span> <span class=\"string\">=</span> <span class=\"string\">hostname</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.node_cleanup.interval</span> <span class=\"string\">=</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.node_cleanup.only_log_warning</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"string\">cluster_partition_handling</span> <span class=\"string\">=</span> <span class=\"string\">autoheal</span></span><br><span class=\"line\">      <span class=\"string\">queue_master_locator=min-masters</span></span><br><span class=\"line\">      <span class=\"string\">loopback_users.guest</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.randomized_startup_delay_range.min</span> <span class=\"string\">=</span> <span class=\"number\">0</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.randomized_startup_delay_range.max</span> <span class=\"string\">=</span> <span class=\"number\">2</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.hostname_suffix</span> <span class=\"string\">=</span> <span class=\"string\">.rabbitmq-cluster.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"string\">vm_memory_high_watermark.absolute</span> <span class=\"string\">=</span> <span class=\"string\">1GB</span></span><br><span class=\"line\">      <span class=\"string\">disk_free_limit.absolute</span> <span class=\"string\">=</span> <span class=\"string\">2GB</span></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><code>enabled_plugins</code>：声明开启的插件；</li>\n<li><code>default_user/default_pass</code>：指定用户名和密码；</li>\n<li><code>cluster_formation.k8s.address_type</code>：从<code>k8s</code>返回的<code>Pod</code>容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是<code>ip</code>，但是默认情况下在<code>k8s</code>中<code>pod</code>的<code>ip</code>都是不固定的，因此可能导致节点的配置和数据丢失，后面的<code>yaml</code>中会通过引用元数据的方式固定<code>pod</code>的主机名；</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>创建一个<code>rabbitmq-service.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">rmqport</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-manage</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>这里定义了两个service，一个是<code>NodePort</code>用于用户通过web访问的管理页面，另一个是用于rabbitmq服务通信；</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>创建一个<code>rabbitmq-rbac.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><p>创建一个<code>rabbitmq-cluster-sts.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">cp</span> <span class=\"string\">-v</span> <span class=\"string\">/etc/rabbitmq/rabbitmq.conf</span> <span class=\"string\">$&#123;RABBITMQ_CONFIG_FILE&#125;;</span> <span class=\"string\">exec</span> <span class=\"string\">docker-entrypoint.sh</span></span><br><span class=\"line\">          <span class=\"string\">rabbitmq-server</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;Asia/Shanghai&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_ERLANG_COOKIE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY=&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">K8S_SERVICE_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAMESPACE</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_USE_LONGNAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_NODENAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_CONFIG_FILE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/var/lib/rabbitmq/rabbitmq.conf</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">rabbitmq:3.8.3-management</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">rabbitmq-diagnostics</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">status</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">amqp</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">rabbitmq-diagnostics</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">status</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-storage</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">items:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">rabbitmq.conf</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">rabbitmq.conf</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">enabled_plugins</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">enabled_plugins</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-config</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\">        <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-storage</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">&quot;managed-nfs-storage&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">2Gi</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里指定了storageclass的名字为：<code>managed-nfs-storage</code>，需要根据实际情况调整</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"部署服务\"><a href=\"#部署服务\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h2><p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f .</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查\"><a href=\"#检查\" class=\"headerlink\" title=\"检查\"></a>检查</h2><p>执行下面的命令检查资源创建情况，确保pod都处于运行状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,sts -n default</span><br></pre></td></tr></table></figure>\n\n\n\n<img src=\"./bushu.png\" style=\"zoom:70%;\" />\n\n\n\n<p>检查pod日志，观察集群建立情况：</p>\n<img src=\"./log.png\" style=\"zoom:70%;\" />\n\n\n\n<p>进入pod中，通过客户端命令查看集群状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -ti  rabbitmq-cluster-0 -n default -- rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>\n\n<img src=\"./client_log.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问管理页面\"><a href=\"#访问管理页面\" class=\"headerlink\" title=\"访问管理页面\"></a>访问管理页面</h2><p>查看对应service使用的宿主机端口：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n default</span><br></pre></td></tr></table></figure>\n\n<img src=\"./service.png\" style=\"zoom:70%;\" />\n\n\n\n<p>通过浏览器访问node节点的30888端口即可打开rabbitmq的管理页面：</p>\n<img src=\"./web.png\" style=\"zoom:70%;\" />\n\n"},{"title":"部署Ingress","date":"2021-03-20T07:13:31.000Z","description":"在k8s集群中部署ingress-nginx","cover":"https://www.kubernetes.org.cn/img/2019/10/fe9890c6467aa42ebd24d536416942d3-768x442.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中部署Ingress-nginx。\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 什么是Ingress\n\nIngress实际是集群的流量统一入口，可以根据不同请求的URL将流量转发给集群中的服务（通过Ingress-Controller实现）。目前有很多Ingress-controller的实现方案：\n\n- `Ingress NGINX`: Kubernetes 官方维护的方案，也是本次安装使用的 Controller；\n- `F5 BIG-IP Controller`: F5 所开发的 Controller，它能够让管理员通过 CLI 或 API 让 Kubernetes 与 OpenShift 管理 F5 BIG-IP 设备；\n- `Ingress Kong`: 著名的开源 API Gateway 方案所维护的 Kubernetes Ingress Controller；\n- `Traefik`: 是一套开源的 HTTP 反向代理与负载均衡器，而它也支援了 Ingress；\n- `Voyager`: 一套以 HAProxy 为底的 Ingress Controller；\n\n\n\n这里使用的是Ingress Nginx，它实质就是一个nginx服务，他可以通过apiserver动态更新nginx的配置，实现基于域名的虚拟主机工功能。\n\n\n\n<br>\n\n\n\n## 部署Ingress Nginx\n\n官方维护的配置yaml文件在 [官方YAML文件](https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml)，可以直接执行下面的命令部署：\n\n```bash\n$ kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml\n```\n\n\n\n这个文件会创建一个名为：`ingress-nginx`的namespace，相关的pod会部署在这个namespace下面。\n\n\n\n有一点需要注意的是，最好修改一下这个文件中deployment的这个地方：\n\n```yaml\nspec:\n      hostNetwork: true\n      dnsPolicy: ClusterFirst\n      containers:\n        - name: controller\n          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.32.0\n          imagePullPolicy: IfNotPresent\n```\n\n> 这里增加了`hostNetwork: true`，让ingress使用host网络，这样才可以通过默认的service配置被外部访问。\n\n\n\n使用下面的命令进行部署：\n\n```bash\nkubectl apply -f deploy.yaml\n```\n\n\n\n<br>\n\n","source":"_posts/部署Ingress.md","raw":"---\ntitle: 部署Ingress\ndate: 2021-03-20 15:13:31\ntags:\n- Ingress\ncategories:\n- Kubernetes\n- Ingress-nginx\ndescription: 在k8s集群中部署ingress-nginx\ncover: https://www.kubernetes.org.cn/img/2019/10/fe9890c6467aa42ebd24d536416942d3-768x442.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中部署Ingress-nginx。\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 什么是Ingress\n\nIngress实际是集群的流量统一入口，可以根据不同请求的URL将流量转发给集群中的服务（通过Ingress-Controller实现）。目前有很多Ingress-controller的实现方案：\n\n- `Ingress NGINX`: Kubernetes 官方维护的方案，也是本次安装使用的 Controller；\n- `F5 BIG-IP Controller`: F5 所开发的 Controller，它能够让管理员通过 CLI 或 API 让 Kubernetes 与 OpenShift 管理 F5 BIG-IP 设备；\n- `Ingress Kong`: 著名的开源 API Gateway 方案所维护的 Kubernetes Ingress Controller；\n- `Traefik`: 是一套开源的 HTTP 反向代理与负载均衡器，而它也支援了 Ingress；\n- `Voyager`: 一套以 HAProxy 为底的 Ingress Controller；\n\n\n\n这里使用的是Ingress Nginx，它实质就是一个nginx服务，他可以通过apiserver动态更新nginx的配置，实现基于域名的虚拟主机工功能。\n\n\n\n<br>\n\n\n\n## 部署Ingress Nginx\n\n官方维护的配置yaml文件在 [官方YAML文件](https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml)，可以直接执行下面的命令部署：\n\n```bash\n$ kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml\n```\n\n\n\n这个文件会创建一个名为：`ingress-nginx`的namespace，相关的pod会部署在这个namespace下面。\n\n\n\n有一点需要注意的是，最好修改一下这个文件中deployment的这个地方：\n\n```yaml\nspec:\n      hostNetwork: true\n      dnsPolicy: ClusterFirst\n      containers:\n        - name: controller\n          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.32.0\n          imagePullPolicy: IfNotPresent\n```\n\n> 这里增加了`hostNetwork: true`，让ingress使用host网络，这样才可以通过默认的service配置被外部访问。\n\n\n\n使用下面的命令进行部署：\n\n```bash\nkubectl apply -f deploy.yaml\n```\n\n\n\n<br>\n\n","slug":"部署Ingress","published":1,"updated":"2021-03-20T07:33:34.178Z","_id":"ckmhedtrq000069kl21spa224","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中部署Ingress-nginx。</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"什么是Ingress\"><a href=\"#什么是Ingress\" class=\"headerlink\" title=\"什么是Ingress\"></a>什么是Ingress</h1><p>Ingress实际是集群的流量统一入口，可以根据不同请求的URL将流量转发给集群中的服务（通过Ingress-Controller实现）。目前有很多Ingress-controller的实现方案：</p>\n<ul>\n<li><code>Ingress NGINX</code>: Kubernetes 官方维护的方案，也是本次安装使用的 Controller；</li>\n<li><code>F5 BIG-IP Controller</code>: F5 所开发的 Controller，它能够让管理员通过 CLI 或 API 让 Kubernetes 与 OpenShift 管理 F5 BIG-IP 设备；</li>\n<li><code>Ingress Kong</code>: 著名的开源 API Gateway 方案所维护的 Kubernetes Ingress Controller；</li>\n<li><code>Traefik</code>: 是一套开源的 HTTP 反向代理与负载均衡器，而它也支援了 Ingress；</li>\n<li><code>Voyager</code>: 一套以 HAProxy 为底的 Ingress Controller；</li>\n</ul>\n<p>这里使用的是Ingress Nginx，它实质就是一个nginx服务，他可以通过apiserver动态更新nginx的配置，实现基于域名的虚拟主机工功能。</p>\n<br>\n\n\n\n<h2 id=\"部署Ingress-Nginx\"><a href=\"#部署Ingress-Nginx\" class=\"headerlink\" title=\"部署Ingress Nginx\"></a>部署Ingress Nginx</h2><p>官方维护的配置yaml文件在 <a href=\"https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml\">官方YAML文件</a>，可以直接执行下面的命令部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<p>这个文件会创建一个名为：<code>ingress-nginx</code>的namespace，相关的pod会部署在这个namespace下面。</p>\n<p>有一点需要注意的是，最好修改一下这个文件中deployment的这个地方：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">hostNetwork:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.32.0</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里增加了<code>hostNetwork: true</code>，让ingress使用host网络，这样才可以通过默认的service配置被外部访问。</p>\n</blockquote>\n<p>使用下面的命令进行部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f deploy.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中部署Ingress-nginx。</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"什么是Ingress\"><a href=\"#什么是Ingress\" class=\"headerlink\" title=\"什么是Ingress\"></a>什么是Ingress</h1><p>Ingress实际是集群的流量统一入口，可以根据不同请求的URL将流量转发给集群中的服务（通过Ingress-Controller实现）。目前有很多Ingress-controller的实现方案：</p>\n<ul>\n<li><code>Ingress NGINX</code>: Kubernetes 官方维护的方案，也是本次安装使用的 Controller；</li>\n<li><code>F5 BIG-IP Controller</code>: F5 所开发的 Controller，它能够让管理员通过 CLI 或 API 让 Kubernetes 与 OpenShift 管理 F5 BIG-IP 设备；</li>\n<li><code>Ingress Kong</code>: 著名的开源 API Gateway 方案所维护的 Kubernetes Ingress Controller；</li>\n<li><code>Traefik</code>: 是一套开源的 HTTP 反向代理与负载均衡器，而它也支援了 Ingress；</li>\n<li><code>Voyager</code>: 一套以 HAProxy 为底的 Ingress Controller；</li>\n</ul>\n<p>这里使用的是Ingress Nginx，它实质就是一个nginx服务，他可以通过apiserver动态更新nginx的配置，实现基于域名的虚拟主机工功能。</p>\n<br>\n\n\n\n<h2 id=\"部署Ingress-Nginx\"><a href=\"#部署Ingress-Nginx\" class=\"headerlink\" title=\"部署Ingress Nginx\"></a>部署Ingress Nginx</h2><p>官方维护的配置yaml文件在 <a href=\"https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml\">官方YAML文件</a>，可以直接执行下面的命令部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<p>这个文件会创建一个名为：<code>ingress-nginx</code>的namespace，相关的pod会部署在这个namespace下面。</p>\n<p>有一点需要注意的是，最好修改一下这个文件中deployment的这个地方：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">hostNetwork:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.32.0</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里增加了<code>hostNetwork: true</code>，让ingress使用host网络，这样才可以通过默认的service配置被外部访问。</p>\n</blockquote>\n<p>使用下面的命令进行部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f deploy.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n"},{"title":"ingress-nginx实现蓝绿、灰度发布","date":"2021-03-20T07:34:11.000Z","description":"利用ingress特性实现在k8s中的蓝绿、灰度发布","cover":"https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中利用 Ingress-nginx 的 Canary 功能实现蓝绿、灰度发布\n\n更新于 2021-03-20\n\n{% endnote %}\n\n\n\n<br>\n\n\n\n# Canary功能介绍\n\nIngress-Nginx在0.21版本引入了Canary功能，可以为网关入口配置多个版本的应用程序，使用annotation来控制多个后端服务的流量分配。\n\n\n\ncanary通过下面的一些注释来实现流量分配：\n\n- `nginx.ingress.kubernetes.io/canary: \"true\"`：启用Canary功能；\n- `nginx.ingress.kubernetes.io/canary-weight` ：指定一个0-100的整数，根据设置的值来决定大概有百分之多少的流量会分配Canary Ingress中指定的后端服务；\n- `nginx.ingress.kubernetes.io/canary-by-header` ：基于request header 的流量切分，适用于灰度发布或者A/B测试，当设定的hearder值为always是，请求流量会被一直分配到Canary入口，当hearder值被设置为never时，请求流量不会分配到Canary入口，对于其他hearder值，将忽略，并通过优先级将请求流量分配到其他规则；\n- `nginx.ingress.kubernetes.io/canary-by-header-value`： 要和`nginx.ingress.kubernetes.io/canary-by-header` 一起使用，当请求中的hearder key和value 与`nginx.ingress.kubernetes.io/canary-by-header` `nginx.ingress.kubernetes.io/canary-by-header-value`匹配时，请求流量会被分配到Canary Ingress入口，对于其他任何hearder值，将忽略，并通过优先级将请求流量分配到其他规则；\n- `nginx.ingress.kubernetes.io/canary-by-cookie` ：基于cookie的流量切分，也适用于灰度发布或者A/B测试，当cookie值设置为always时，请求流量将被路由到Canary Ingress入口，当cookie值设置为never时，请求流量将不会路由到Canary入口，对于其他值，将忽略，并通过优先级将请求流量分配到其他规则；\n\n\n\n以上几种注释的优先级为：**canary-by-header - > canary-by-cookie - > canary-weight**\n\n\n\n<br>\n\n\n\n# 基于权重分配流量\n\n## 创建v1版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n  labels:\n    app: echoserverv1\n  name: echoserverv1\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv1\n          servicePort: 8080\n        path: /\n```\n\n\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv1\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv1\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv1\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv1\n  namespace: echoserver\n  labels:\n    name:  echoserverv1\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv1\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv1 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv1\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查创建情况\n\n```bash\nkubectl get pod,service,ingress -n echoserver\n```\n\n<img src=\"./pod.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问服务\n\n```bash\nfor i in `seq 10`;do curl -s echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v1.png\" style=\"zoom:70%;\" />\n\n\n\n>  可以看到，所有的请求都正常返回且版本为v1\n\n\n\n## 发布v2版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n> 注意这里的ingress就开启了canary功能，切设置权重为50%\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv2\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv2\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\n  labels:\n    name:  echoserverv2\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv2\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv2 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv2\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查v2版本服务\n\n```bash\nkubectl get pod,service,ingress -n echoserver\n```\n\n<img src=\"./v2.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问服务\n\n```bash\nfor i in `seq 10`;do curl -s echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-wight.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到，v1和v2两个版本的请求比几乎是50%\n\n\n\n\n\n<br>\n\n\n\n# 基于header的流量分配\n\n## 更新v2版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"v2\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n> 注意这里设置了`nginx.ingress.kubernetes.io/canary-by-header`\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv2\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv2\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\n  labels:\n    name:  echoserverv2\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv2\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv2 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv2\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 访问服务\n\n因为设置了`nginx.ingress.kubernetes.io/canary-by-header: v2`，将会出现以下的集中情况：\n\n{% tabs comments %}\n\n<!-- tab 请求header为 v2:always -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:always\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-ha.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到请求的header-key为v2，value为always，流量将全部调度到v2版本\n\n<!-- endtab -->\n\n<!-- tab 请求header为 v2:never -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:never\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-never.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到请求的header-key为v2，value为never，流量将全部调度到v1版本\n\n<!-- endtab -->\n\n<!-- tab 请求header为 v2，header-key任意 -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:true\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-true.png\" style=\"zoom:70%;\" />\n\n> 可以看到请求的header-key为v2，value为其他值，流量将根据权重比例进行分配\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 按照header key/value进行分配\n\n只需要在v2版本的ingress中指定`nginx.ingress.kubernetes.io/canary-by-header-value`即可：\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"v2\"\n    nginx.ingress.kubernetes.io/canary-by-header-value: \"true\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n\n\n此时因为指定了header key和value，则请求的header必须包含：`v2:true`才能进入v2版本，否则会按照比例进行v1，v2版本分配。\n\n\n\n<br>\n\n\n\n# 基于cookie进行流量分配\n\n## 更新v2版本服务\n\n\n\n基于cookie进行分配的时候，不能定义cookie的value\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-cookie: \"user_from_shanghai\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n\n\n## 访问服务\n\n{% tabs comments %}\n\n<!-- tab 设置cookie user_from_shanghai -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai\" echo.example.com|grep Hostname;done\n```\n\n\n\n> 请求将按照比例分配到两个版本\n\n<!-- endtab -->\n\n<!-- tab 设置cookie user_from_shanghai:always -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai:always\" echo.example.com|grep Hostname;done\n```\n\n\n\n> 请求将按照比例分配到两个版本\n\n<!-- endtab -->\n\n<!-- tab 设置coolie user_from_shanghai=always -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai=always\" echo.example.com|grep Hostname;done\n```\n\n> 请求将全部进入v2版本\n\n<!-- endtab -->\n\n{% endtabs %}\n\n","source":"_posts/ingress-nginx实现蓝绿、灰度发布.md","raw":"---\ntitle: ingress-nginx实现蓝绿、灰度发布\ndate: 2021-03-20 15:34:11\ntags:\n- Ingress\ncategories:\n- Kubernetes\n- Ingress-nginx\ndescription: 利用ingress特性实现在k8s中的蓝绿、灰度发布\ncover: https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中利用 Ingress-nginx 的 Canary 功能实现蓝绿、灰度发布\n\n更新于 2021-03-20\n\n{% endnote %}\n\n\n\n<br>\n\n\n\n# Canary功能介绍\n\nIngress-Nginx在0.21版本引入了Canary功能，可以为网关入口配置多个版本的应用程序，使用annotation来控制多个后端服务的流量分配。\n\n\n\ncanary通过下面的一些注释来实现流量分配：\n\n- `nginx.ingress.kubernetes.io/canary: \"true\"`：启用Canary功能；\n- `nginx.ingress.kubernetes.io/canary-weight` ：指定一个0-100的整数，根据设置的值来决定大概有百分之多少的流量会分配Canary Ingress中指定的后端服务；\n- `nginx.ingress.kubernetes.io/canary-by-header` ：基于request header 的流量切分，适用于灰度发布或者A/B测试，当设定的hearder值为always是，请求流量会被一直分配到Canary入口，当hearder值被设置为never时，请求流量不会分配到Canary入口，对于其他hearder值，将忽略，并通过优先级将请求流量分配到其他规则；\n- `nginx.ingress.kubernetes.io/canary-by-header-value`： 要和`nginx.ingress.kubernetes.io/canary-by-header` 一起使用，当请求中的hearder key和value 与`nginx.ingress.kubernetes.io/canary-by-header` `nginx.ingress.kubernetes.io/canary-by-header-value`匹配时，请求流量会被分配到Canary Ingress入口，对于其他任何hearder值，将忽略，并通过优先级将请求流量分配到其他规则；\n- `nginx.ingress.kubernetes.io/canary-by-cookie` ：基于cookie的流量切分，也适用于灰度发布或者A/B测试，当cookie值设置为always时，请求流量将被路由到Canary Ingress入口，当cookie值设置为never时，请求流量将不会路由到Canary入口，对于其他值，将忽略，并通过优先级将请求流量分配到其他规则；\n\n\n\n以上几种注释的优先级为：**canary-by-header - > canary-by-cookie - > canary-weight**\n\n\n\n<br>\n\n\n\n# 基于权重分配流量\n\n## 创建v1版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n  labels:\n    app: echoserverv1\n  name: echoserverv1\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv1\n          servicePort: 8080\n        path: /\n```\n\n\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv1\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv1\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv1\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv1\n  namespace: echoserver\n  labels:\n    name:  echoserverv1\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv1\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv1 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv1\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查创建情况\n\n```bash\nkubectl get pod,service,ingress -n echoserver\n```\n\n<img src=\"./pod.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问服务\n\n```bash\nfor i in `seq 10`;do curl -s echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v1.png\" style=\"zoom:70%;\" />\n\n\n\n>  可以看到，所有的请求都正常返回且版本为v1\n\n\n\n## 发布v2版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n> 注意这里的ingress就开启了canary功能，切设置权重为50%\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv2\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv2\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\n  labels:\n    name:  echoserverv2\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv2\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv2 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv2\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查v2版本服务\n\n```bash\nkubectl get pod,service,ingress -n echoserver\n```\n\n<img src=\"./v2.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问服务\n\n```bash\nfor i in `seq 10`;do curl -s echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-wight.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到，v1和v2两个版本的请求比几乎是50%\n\n\n\n\n\n<br>\n\n\n\n# 基于header的流量分配\n\n## 更新v2版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"v2\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n> 注意这里设置了`nginx.ingress.kubernetes.io/canary-by-header`\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv2\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv2\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\n  labels:\n    name:  echoserverv2\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv2\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv2 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv2\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 访问服务\n\n因为设置了`nginx.ingress.kubernetes.io/canary-by-header: v2`，将会出现以下的集中情况：\n\n{% tabs comments %}\n\n<!-- tab 请求header为 v2:always -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:always\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-ha.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到请求的header-key为v2，value为always，流量将全部调度到v2版本\n\n<!-- endtab -->\n\n<!-- tab 请求header为 v2:never -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:never\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-never.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到请求的header-key为v2，value为never，流量将全部调度到v1版本\n\n<!-- endtab -->\n\n<!-- tab 请求header为 v2，header-key任意 -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:true\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-true.png\" style=\"zoom:70%;\" />\n\n> 可以看到请求的header-key为v2，value为其他值，流量将根据权重比例进行分配\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 按照header key/value进行分配\n\n只需要在v2版本的ingress中指定`nginx.ingress.kubernetes.io/canary-by-header-value`即可：\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"v2\"\n    nginx.ingress.kubernetes.io/canary-by-header-value: \"true\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n\n\n此时因为指定了header key和value，则请求的header必须包含：`v2:true`才能进入v2版本，否则会按照比例进行v1，v2版本分配。\n\n\n\n<br>\n\n\n\n# 基于cookie进行流量分配\n\n## 更新v2版本服务\n\n\n\n基于cookie进行分配的时候，不能定义cookie的value\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-cookie: \"user_from_shanghai\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n\n\n## 访问服务\n\n{% tabs comments %}\n\n<!-- tab 设置cookie user_from_shanghai -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai\" echo.example.com|grep Hostname;done\n```\n\n\n\n> 请求将按照比例分配到两个版本\n\n<!-- endtab -->\n\n<!-- tab 设置cookie user_from_shanghai:always -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai:always\" echo.example.com|grep Hostname;done\n```\n\n\n\n> 请求将按照比例分配到两个版本\n\n<!-- endtab -->\n\n<!-- tab 设置coolie user_from_shanghai=always -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai=always\" echo.example.com|grep Hostname;done\n```\n\n> 请求将全部进入v2版本\n\n<!-- endtab -->\n\n{% endtabs %}\n\n","slug":"ingress-nginx实现蓝绿、灰度发布","published":1,"updated":"2021-03-20T08:55:31.405Z","_id":"ckmhfeglz0000a9kl96lc40q7","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中利用 Ingress-nginx 的 Canary 功能实现蓝绿、灰度发布</p><p>更新于 2021-03-20</p>\n          </div>\n\n\n\n<br>\n\n\n\n<h1 id=\"Canary功能介绍\"><a href=\"#Canary功能介绍\" class=\"headerlink\" title=\"Canary功能介绍\"></a>Canary功能介绍</h1><p>Ingress-Nginx在0.21版本引入了Canary功能，可以为网关入口配置多个版本的应用程序，使用annotation来控制多个后端服务的流量分配。</p>\n<p>canary通过下面的一些注释来实现流量分配：</p>\n<ul>\n<li><code>nginx.ingress.kubernetes.io/canary: &quot;true&quot;</code>：启用Canary功能；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-weight</code> ：指定一个0-100的整数，根据设置的值来决定大概有百分之多少的流量会分配Canary Ingress中指定的后端服务；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-header</code> ：基于request header 的流量切分，适用于灰度发布或者A/B测试，当设定的hearder值为always是，请求流量会被一直分配到Canary入口，当hearder值被设置为never时，请求流量不会分配到Canary入口，对于其他hearder值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-header-value</code>： 要和<code>nginx.ingress.kubernetes.io/canary-by-header</code> 一起使用，当请求中的hearder key和value 与<code>nginx.ingress.kubernetes.io/canary-by-header</code> <code>nginx.ingress.kubernetes.io/canary-by-header-value</code>匹配时，请求流量会被分配到Canary Ingress入口，对于其他任何hearder值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-cookie</code> ：基于cookie的流量切分，也适用于灰度发布或者A/B测试，当cookie值设置为always时，请求流量将被路由到Canary Ingress入口，当cookie值设置为never时，请求流量将不会路由到Canary入口，对于其他值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n</ul>\n<p>以上几种注释的优先级为：<strong>canary-by-header - &gt; canary-by-cookie - &gt; canary-weight</strong></p>\n<br>\n\n\n\n<h1 id=\"基于权重分配流量\"><a href=\"#基于权重分配流量\" class=\"headerlink\" title=\"基于权重分配流量\"></a>基于权重分配流量</h1><h2 id=\"创建v1版本服务\"><a href=\"#创建v1版本服务\" class=\"headerlink\" title=\"创建v1版本服务\"></a>创建v1版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查创建情况\"><a href=\"#检查创建情况\" class=\"headerlink\" title=\"检查创建情况\"></a>检查创建情况</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,service,ingress -n echoserver</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./pod.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问服务\"><a href=\"#访问服务\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v1.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p> 可以看到，所有的请求都正常返回且版本为v1</p>\n</blockquote>\n<h2 id=\"发布v2版本服务\"><a href=\"#发布v2版本服务\" class=\"headerlink\" title=\"发布v2版本服务\"></a>发布v2版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意这里的ingress就开启了canary功能，切设置权重为50%</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查v2版本服务\"><a href=\"#检查v2版本服务\" class=\"headerlink\" title=\"检查v2版本服务\"></a>检查v2版本服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,service,ingress -n echoserver</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问服务-1\"><a href=\"#访问服务-1\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2-wight.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到，v1和v2两个版本的请求比几乎是50%</p>\n</blockquote>\n<br>\n\n\n\n<h1 id=\"基于header的流量分配\"><a href=\"#基于header的流量分配\" class=\"headerlink\" title=\"基于header的流量分配\"></a>基于header的流量分配</h1><h2 id=\"更新v2版本服务\"><a href=\"#更新v2版本服务\" class=\"headerlink\" title=\"更新v2版本服务\"></a>更新v2版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意这里设置了<code>nginx.ingress.kubernetes.io/canary-by-header</code></p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"访问服务-2\"><a href=\"#访问服务-2\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><p>因为设置了<code>nginx.ingress.kubernetes.io/canary-by-header: v2</code>，将会出现以下的集中情况：</p>\n<div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">请求header为 v2:always</button></li><li class=\"tab\"><button data-href=\"#comments-2\">请求header为 v2:never</button></li><li class=\"tab\"><button data-href=\"#comments-3\">请求header为 v2，header-key任意</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2-ha.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为always，流量将全部调度到v2版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:never&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2-never.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为never，流量将全部调度到v1版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:true&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2-true.png\" style=\"zoom:70%;\" />\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为其他值，流量将根据权重比例进行分配</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"按照header-key-value进行分配\"><a href=\"#按照header-key-value进行分配\" class=\"headerlink\" title=\"按照header key/value进行分配\"></a>按照header key/value进行分配</h2><p>只需要在v2版本的ingress中指定<code>nginx.ingress.kubernetes.io/canary-by-header-value</code>即可：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header-value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>此时因为指定了header key和value，则请求的header必须包含：<code>v2:true</code>才能进入v2版本，否则会按照比例进行v1，v2版本分配。</p>\n<br>\n\n\n\n<h1 id=\"基于cookie进行流量分配\"><a href=\"#基于cookie进行流量分配\" class=\"headerlink\" title=\"基于cookie进行流量分配\"></a>基于cookie进行流量分配</h1><h2 id=\"更新v2版本服务-1\"><a href=\"#更新v2版本服务-1\" class=\"headerlink\" title=\"更新v2版本服务\"></a>更新v2版本服务</h2><p>基于cookie进行分配的时候，不能定义cookie的value</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class=\"string\">&quot;user_from_shanghai&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"访问服务-3\"><a href=\"#访问服务-3\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">设置cookie user_from_shanghai</button></li><li class=\"tab\"><button data-href=\"#comments-2\">设置cookie user_from_shanghai:always</button></li><li class=\"tab\"><button data-href=\"#comments-3\">设置coolie user_from_shanghai=always</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>请求将按照比例分配到两个版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai:always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>请求将按照比例分配到两个版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai=always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>请求将全部进入v2版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中利用 Ingress-nginx 的 Canary 功能实现蓝绿、灰度发布</p><p>更新于 2021-03-20</p>\n          </div>\n\n\n\n<br>\n\n\n\n<h1 id=\"Canary功能介绍\"><a href=\"#Canary功能介绍\" class=\"headerlink\" title=\"Canary功能介绍\"></a>Canary功能介绍</h1><p>Ingress-Nginx在0.21版本引入了Canary功能，可以为网关入口配置多个版本的应用程序，使用annotation来控制多个后端服务的流量分配。</p>\n<p>canary通过下面的一些注释来实现流量分配：</p>\n<ul>\n<li><code>nginx.ingress.kubernetes.io/canary: &quot;true&quot;</code>：启用Canary功能；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-weight</code> ：指定一个0-100的整数，根据设置的值来决定大概有百分之多少的流量会分配Canary Ingress中指定的后端服务；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-header</code> ：基于request header 的流量切分，适用于灰度发布或者A/B测试，当设定的hearder值为always是，请求流量会被一直分配到Canary入口，当hearder值被设置为never时，请求流量不会分配到Canary入口，对于其他hearder值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-header-value</code>： 要和<code>nginx.ingress.kubernetes.io/canary-by-header</code> 一起使用，当请求中的hearder key和value 与<code>nginx.ingress.kubernetes.io/canary-by-header</code> <code>nginx.ingress.kubernetes.io/canary-by-header-value</code>匹配时，请求流量会被分配到Canary Ingress入口，对于其他任何hearder值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-cookie</code> ：基于cookie的流量切分，也适用于灰度发布或者A/B测试，当cookie值设置为always时，请求流量将被路由到Canary Ingress入口，当cookie值设置为never时，请求流量将不会路由到Canary入口，对于其他值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n</ul>\n<p>以上几种注释的优先级为：<strong>canary-by-header - &gt; canary-by-cookie - &gt; canary-weight</strong></p>\n<br>\n\n\n\n<h1 id=\"基于权重分配流量\"><a href=\"#基于权重分配流量\" class=\"headerlink\" title=\"基于权重分配流量\"></a>基于权重分配流量</h1><h2 id=\"创建v1版本服务\"><a href=\"#创建v1版本服务\" class=\"headerlink\" title=\"创建v1版本服务\"></a>创建v1版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查创建情况\"><a href=\"#检查创建情况\" class=\"headerlink\" title=\"检查创建情况\"></a>检查创建情况</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,service,ingress -n echoserver</span><br></pre></td></tr></table></figure>\n\n<img src=\"./pod.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问服务\"><a href=\"#访问服务\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v1.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p> 可以看到，所有的请求都正常返回且版本为v1</p>\n</blockquote>\n<h2 id=\"发布v2版本服务\"><a href=\"#发布v2版本服务\" class=\"headerlink\" title=\"发布v2版本服务\"></a>发布v2版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意这里的ingress就开启了canary功能，切设置权重为50%</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查v2版本服务\"><a href=\"#检查v2版本服务\" class=\"headerlink\" title=\"检查v2版本服务\"></a>检查v2版本服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,service,ingress -n echoserver</span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问服务-1\"><a href=\"#访问服务-1\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2-wight.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到，v1和v2两个版本的请求比几乎是50%</p>\n</blockquote>\n<br>\n\n\n\n<h1 id=\"基于header的流量分配\"><a href=\"#基于header的流量分配\" class=\"headerlink\" title=\"基于header的流量分配\"></a>基于header的流量分配</h1><h2 id=\"更新v2版本服务\"><a href=\"#更新v2版本服务\" class=\"headerlink\" title=\"更新v2版本服务\"></a>更新v2版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意这里设置了<code>nginx.ingress.kubernetes.io/canary-by-header</code></p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"访问服务-2\"><a href=\"#访问服务-2\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><p>因为设置了<code>nginx.ingress.kubernetes.io/canary-by-header: v2</code>，将会出现以下的集中情况：</p>\n<div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">请求header为 v2:always</button></li><li class=\"tab\"><button data-href=\"#comments-2\">请求header为 v2:never</button></li><li class=\"tab\"><button data-href=\"#comments-3\">请求header为 v2，header-key任意</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2-ha.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为always，流量将全部调度到v2版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:never&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2-never.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为never，流量将全部调度到v1版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:true&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2-true.png\" style=\"zoom:70%;\" />\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为其他值，流量将根据权重比例进行分配</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"按照header-key-value进行分配\"><a href=\"#按照header-key-value进行分配\" class=\"headerlink\" title=\"按照header key/value进行分配\"></a>按照header key/value进行分配</h2><p>只需要在v2版本的ingress中指定<code>nginx.ingress.kubernetes.io/canary-by-header-value</code>即可：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header-value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>此时因为指定了header key和value，则请求的header必须包含：<code>v2:true</code>才能进入v2版本，否则会按照比例进行v1，v2版本分配。</p>\n<br>\n\n\n\n<h1 id=\"基于cookie进行流量分配\"><a href=\"#基于cookie进行流量分配\" class=\"headerlink\" title=\"基于cookie进行流量分配\"></a>基于cookie进行流量分配</h1><h2 id=\"更新v2版本服务-1\"><a href=\"#更新v2版本服务-1\" class=\"headerlink\" title=\"更新v2版本服务\"></a>更新v2版本服务</h2><p>基于cookie进行分配的时候，不能定义cookie的value</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class=\"string\">&quot;user_from_shanghai&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"访问服务-3\"><a href=\"#访问服务-3\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">设置cookie user_from_shanghai</button></li><li class=\"tab\"><button data-href=\"#comments-2\">设置cookie user_from_shanghai:always</button></li><li class=\"tab\"><button data-href=\"#comments-3\">设置coolie user_from_shanghai=always</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>请求将按照比例分配到两个版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai:always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>请求将按照比例分配到两个版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai=always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>请求将全部进入v2版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n"},{"title":"在k8s中部署redis集群","date":"2021-03-20T11:28:27.000Z","description":"在k8s中部署一个高可用redis集群","cover":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180327%2F34adc98d775145f0b23c5fa67217af1d.png&refer=http%3A%2F%2F5b0988e595225.cdn.sohucs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1618831808&t=b7f7e1ea802b755f7896decb0502c6a3","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个redis 5.0.5 版本的集群\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 创建相关文件\n\n{% tabs comments %}\n\n<!-- tab configmap -->\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: redis-cluster\ndata:\n  update-node.sh: |\n    #!/bin/sh\n    REDIS_NODES=\"/data/nodes.conf\"\n    sed -i -e \"/myself/ s/[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}/${POD_IP}/\" ${REDIS_NODES}\n    exec \"$@\"\n  redis.conf: |+\n    cluster-enabled yes\n    cluster-require-full-coverage no\n    cluster-node-timeout 15000\n    cluster-config-file /data/nodes.conf\n    cluster-migration-barrier 1\n    appendonly yes\n    protected-mode no\n```\n\n<!-- endtab -->\n\n<!-- tab statefulset -->\n\n```yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: redis-cluster\nspec:\n  serviceName: redis-cluster\n  replicas: 6\n  selector:\n    matchLabels:\n      app: redis-cluster\n  template:\n    metadata:\n      labels:\n        app: redis-cluster\n    spec:\n      containers:\n      - name: redis\n        image: redis:5.0.5-alpine\n        ports:\n        - containerPort: 6379\n          name: client\n        - containerPort: 16379\n          name: gossip\n        command: [\"/conf/update-node.sh\", \"redis-server\", \"/conf/redis.conf\"]\n        env:\n        - name: POD_IP\n          valueFrom:\n            fieldRef:\n              fieldPath: status.podIP\n        volumeMounts:\n        - name: conf\n          mountPath: /conf\n          readOnly: false\n        - name: data\n          mountPath: /data\n          readOnly: false\n      volumes:\n      - name: conf\n        configMap:\n          name: redis-cluster\n          defaultMode: 0755\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 5Gi\n      storageClassName: standard\n```\n\n<!-- endtab -->\n\n<!-- tab service -->\n\n```yaml\napiVersion: v1  \nkind: Service  \nmetadata:  \n  name: redis-cluster  \nspec:  \n  type: ClusterIP  \n  ports:  \n  - port: 6379  \n    targetPort: 6379  \n    name: client  \n  - port: 16379  \n    targetPort: 16379  \n    name: gossip  \n  selector:  \n    app: redis-cluster  \n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n<br>\n\n\n\n# 创建服务\n\n执行下面的命令创建服务：\n\n```bash\nkubectl apply -f configmap.yaml\nkubectl apply -f statefulset.yaml\nkubectl apply -f service.yaml\n```\n\n<img src=\"./create.png\" style=\"zoom:70%;\" />\n\n\n\n<br>\n\n# 初始化集群\n\n将前三个节点作为主，后面节点作为从：\n\n```bash\nkubectl exec -it redis-cluster-0 -- redis-cli --cluster create --cluster-replicas 1 $(kubectl get pods -l app=redis-cluster -o jsonpath='{range.items[*]}{.status.podIP}:6379 ')  \n```\n\n<img src=\"./cluster.png\" style=\"zoom:70%;\" />\n\n\n\n<br>\n\n\n\n# 验证集群\n\n使用下面的命令验证集群是否正常：\n\n```bash\nkubectl exec -it redis-cluster-0 -- redis-cli cluster info  \n\nfor x in $(seq 0 5); do echo \"redis-cluster-$x\"; kubectl exec redis-cluster-$x -- redis-cli role; echo; done \n```\n\n<img src=\"./info.png\" style=\"zoom:70%;\" />\n\n<img src=\"./detail.png\" style=\"zoom:70%;\" />\n\n","source":"_posts/在k8s中部署redis集群.md","raw":"---\ntitle: 在k8s中部署redis集群\ndate: 2021-03-20 19:28:27\ntags:\n- Redis\ncategories:\n- 数据库\n- Redis\n- 部署\ndescription: 在k8s中部署一个高可用redis集群\ncover: https://gimg2.baidu.com/image_search/src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180327%2F34adc98d775145f0b23c5fa67217af1d.png&refer=http%3A%2F%2F5b0988e595225.cdn.sohucs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1618831808&t=b7f7e1ea802b755f7896decb0502c6a3\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个redis 5.0.5 版本的集群\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 创建相关文件\n\n{% tabs comments %}\n\n<!-- tab configmap -->\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: redis-cluster\ndata:\n  update-node.sh: |\n    #!/bin/sh\n    REDIS_NODES=\"/data/nodes.conf\"\n    sed -i -e \"/myself/ s/[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}\\.[0-9]\\{1,3\\}/${POD_IP}/\" ${REDIS_NODES}\n    exec \"$@\"\n  redis.conf: |+\n    cluster-enabled yes\n    cluster-require-full-coverage no\n    cluster-node-timeout 15000\n    cluster-config-file /data/nodes.conf\n    cluster-migration-barrier 1\n    appendonly yes\n    protected-mode no\n```\n\n<!-- endtab -->\n\n<!-- tab statefulset -->\n\n```yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: redis-cluster\nspec:\n  serviceName: redis-cluster\n  replicas: 6\n  selector:\n    matchLabels:\n      app: redis-cluster\n  template:\n    metadata:\n      labels:\n        app: redis-cluster\n    spec:\n      containers:\n      - name: redis\n        image: redis:5.0.5-alpine\n        ports:\n        - containerPort: 6379\n          name: client\n        - containerPort: 16379\n          name: gossip\n        command: [\"/conf/update-node.sh\", \"redis-server\", \"/conf/redis.conf\"]\n        env:\n        - name: POD_IP\n          valueFrom:\n            fieldRef:\n              fieldPath: status.podIP\n        volumeMounts:\n        - name: conf\n          mountPath: /conf\n          readOnly: false\n        - name: data\n          mountPath: /data\n          readOnly: false\n      volumes:\n      - name: conf\n        configMap:\n          name: redis-cluster\n          defaultMode: 0755\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes: [ \"ReadWriteOnce\" ]\n      resources:\n        requests:\n          storage: 5Gi\n      storageClassName: standard\n```\n\n<!-- endtab -->\n\n<!-- tab service -->\n\n```yaml\napiVersion: v1  \nkind: Service  \nmetadata:  \n  name: redis-cluster  \nspec:  \n  type: ClusterIP  \n  ports:  \n  - port: 6379  \n    targetPort: 6379  \n    name: client  \n  - port: 16379  \n    targetPort: 16379  \n    name: gossip  \n  selector:  \n    app: redis-cluster  \n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n<br>\n\n\n\n# 创建服务\n\n执行下面的命令创建服务：\n\n```bash\nkubectl apply -f configmap.yaml\nkubectl apply -f statefulset.yaml\nkubectl apply -f service.yaml\n```\n\n<img src=\"./create.png\" style=\"zoom:70%;\" />\n\n\n\n<br>\n\n# 初始化集群\n\n将前三个节点作为主，后面节点作为从：\n\n```bash\nkubectl exec -it redis-cluster-0 -- redis-cli --cluster create --cluster-replicas 1 $(kubectl get pods -l app=redis-cluster -o jsonpath='{range.items[*]}{.status.podIP}:6379 ')  \n```\n\n<img src=\"./cluster.png\" style=\"zoom:70%;\" />\n\n\n\n<br>\n\n\n\n# 验证集群\n\n使用下面的命令验证集群是否正常：\n\n```bash\nkubectl exec -it redis-cluster-0 -- redis-cli cluster info  \n\nfor x in $(seq 0 5); do echo \"redis-cluster-$x\"; kubectl exec redis-cluster-$x -- redis-cli role; echo; done \n```\n\n<img src=\"./info.png\" style=\"zoom:70%;\" />\n\n<img src=\"./detail.png\" style=\"zoom:70%;\" />\n\n","slug":"在k8s中部署redis集群","published":1,"updated":"2021-03-20T11:50:07.951Z","_id":"ckmhnxqql0000rekl24iihiwh","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个redis 5.0.5 版本的集群</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"创建相关文件\"><a href=\"#创建相关文件\" class=\"headerlink\" title=\"创建相关文件\"></a>创建相关文件</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">configmap</button></li><li class=\"tab\"><button data-href=\"#comments-2\">statefulset</button></li><li class=\"tab\"><button data-href=\"#comments-3\">service</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">update-node.sh:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"comment\">#!/bin/sh</span></span><br><span class=\"line\">    <span class=\"string\">REDIS_NODES=&quot;/data/nodes.conf&quot;</span></span><br><span class=\"line\">    <span class=\"string\">sed</span> <span class=\"string\">-i</span> <span class=\"string\">-e</span> <span class=\"string\">&quot;/myself/ s/[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;/$&#123;POD_IP&#125;/&quot;</span> <span class=\"string\">$&#123;REDIS_NODES&#125;</span></span><br><span class=\"line\">    <span class=\"string\">exec</span> <span class=\"string\">&quot;$@&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">redis.conf:</span> <span class=\"string\">|+</span></span><br><span class=\"line\">    <span class=\"string\">cluster-enabled</span> <span class=\"literal\">yes</span></span><br><span class=\"line\">    <span class=\"string\">cluster-require-full-coverage</span> <span class=\"literal\">no</span></span><br><span class=\"line\">    <span class=\"string\">cluster-node-timeout</span> <span class=\"number\">15000</span></span><br><span class=\"line\">    <span class=\"string\">cluster-config-file</span> <span class=\"string\">/data/nodes.conf</span></span><br><span class=\"line\">    <span class=\"string\">cluster-migration-barrier</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"string\">appendonly</span> <span class=\"literal\">yes</span></span><br><span class=\"line\">    <span class=\"string\">protected-mode</span> <span class=\"literal\">no</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">6</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">redis:5.0.5-alpine</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">client</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">16379</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">gossip</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">&quot;/conf/update-node.sh&quot;</span>, <span class=\"string\">&quot;redis-server&quot;</span>, <span class=\"string\">&quot;/conf/redis.conf&quot;</span>]</span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/conf</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">          <span class=\"attr\">defaultMode:</span> <span class=\"number\">0755</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span> [ <span class=\"string\">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">5Gi</span></span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">standard</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span>  </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span>  </span><br><span class=\"line\"><span class=\"attr\">metadata:</span>  </span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis-cluster</span>  </span><br><span class=\"line\"><span class=\"attr\">spec:</span>  </span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span>  </span><br><span class=\"line\">  <span class=\"attr\">ports:</span>  </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">6379</span>  </span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">6379</span>  </span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">client</span>  </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">16379</span>  </span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">16379</span>  </span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">gossip</span>  </span><br><span class=\"line\">  <span class=\"attr\">selector:</span>  </span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">redis-cluster</span>  </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n<br>\n\n\n\n<h1 id=\"创建服务\"><a href=\"#创建服务\" class=\"headerlink\" title=\"创建服务\"></a>创建服务</h1><p>执行下面的命令创建服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f configmap.yaml</span><br><span class=\"line\">kubectl apply -f statefulset.yaml</span><br><span class=\"line\">kubectl apply -f service.yaml</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./create.png\" style=\"zoom:70%;\" />\n\n\n\n<br>\n\n<h1 id=\"初始化集群\"><a href=\"#初始化集群\" class=\"headerlink\" title=\"初始化集群\"></a>初始化集群</h1><p>将前三个节点作为主，后面节点作为从：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it redis-cluster-0 -- redis-cli --cluster create --cluster-replicas 1 $(kubectl get pods -l app=redis-cluster -o jsonpath=<span class=\"string\">&#x27;&#123;range.items[*]&#125;&#123;.status.podIP&#125;:6379 &#x27;</span>)  </span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./cluster.png\" style=\"zoom:70%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"验证集群\"><a href=\"#验证集群\" class=\"headerlink\" title=\"验证集群\"></a>验证集群</h1><p>使用下面的命令验证集群是否正常：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it redis-cluster-0 -- redis-cli cluster info  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> $(seq 0 5); <span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;redis-cluster-<span class=\"variable\">$x</span>&quot;</span>; kubectl <span class=\"built_in\">exec</span> redis-cluster-<span class=\"variable\">$x</span> -- redis-cli role; <span class=\"built_in\">echo</span>; <span class=\"keyword\">done</span> </span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./info.png\" style=\"zoom:70%;\" />\n\n<img src= \"/img/loading.gif\" data-src=\"./detail.png\" style=\"zoom:70%;\" />\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个redis 5.0.5 版本的集群</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"创建相关文件\"><a href=\"#创建相关文件\" class=\"headerlink\" title=\"创建相关文件\"></a>创建相关文件</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">configmap</button></li><li class=\"tab\"><button data-href=\"#comments-2\">statefulset</button></li><li class=\"tab\"><button data-href=\"#comments-3\">service</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">update-node.sh:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"comment\">#!/bin/sh</span></span><br><span class=\"line\">    <span class=\"string\">REDIS_NODES=&quot;/data/nodes.conf&quot;</span></span><br><span class=\"line\">    <span class=\"string\">sed</span> <span class=\"string\">-i</span> <span class=\"string\">-e</span> <span class=\"string\">&quot;/myself/ s/[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;\\.[0-9]\\&#123;1,3\\&#125;/$&#123;POD_IP&#125;/&quot;</span> <span class=\"string\">$&#123;REDIS_NODES&#125;</span></span><br><span class=\"line\">    <span class=\"string\">exec</span> <span class=\"string\">&quot;$@&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">redis.conf:</span> <span class=\"string\">|+</span></span><br><span class=\"line\">    <span class=\"string\">cluster-enabled</span> <span class=\"literal\">yes</span></span><br><span class=\"line\">    <span class=\"string\">cluster-require-full-coverage</span> <span class=\"literal\">no</span></span><br><span class=\"line\">    <span class=\"string\">cluster-node-timeout</span> <span class=\"number\">15000</span></span><br><span class=\"line\">    <span class=\"string\">cluster-config-file</span> <span class=\"string\">/data/nodes.conf</span></span><br><span class=\"line\">    <span class=\"string\">cluster-migration-barrier</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"string\">appendonly</span> <span class=\"literal\">yes</span></span><br><span class=\"line\">    <span class=\"string\">protected-mode</span> <span class=\"literal\">no</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">6</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">redis:5.0.5-alpine</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">client</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">16379</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">gossip</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">&quot;/conf/update-node.sh&quot;</span>, <span class=\"string\">&quot;redis-server&quot;</span>, <span class=\"string\">&quot;/conf/redis.conf&quot;</span>]</span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/conf</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">redis-cluster</span></span><br><span class=\"line\">          <span class=\"attr\">defaultMode:</span> <span class=\"number\">0755</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span> [ <span class=\"string\">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">5Gi</span></span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">standard</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span>  </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span>  </span><br><span class=\"line\"><span class=\"attr\">metadata:</span>  </span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis-cluster</span>  </span><br><span class=\"line\"><span class=\"attr\">spec:</span>  </span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span>  </span><br><span class=\"line\">  <span class=\"attr\">ports:</span>  </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">6379</span>  </span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">6379</span>  </span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">client</span>  </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">16379</span>  </span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">16379</span>  </span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">gossip</span>  </span><br><span class=\"line\">  <span class=\"attr\">selector:</span>  </span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">redis-cluster</span>  </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n<br>\n\n\n\n<h1 id=\"创建服务\"><a href=\"#创建服务\" class=\"headerlink\" title=\"创建服务\"></a>创建服务</h1><p>执行下面的命令创建服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f configmap.yaml</span><br><span class=\"line\">kubectl apply -f statefulset.yaml</span><br><span class=\"line\">kubectl apply -f service.yaml</span><br></pre></td></tr></table></figure>\n\n<img src=\"./create.png\" style=\"zoom:70%;\" />\n\n\n\n<br>\n\n<h1 id=\"初始化集群\"><a href=\"#初始化集群\" class=\"headerlink\" title=\"初始化集群\"></a>初始化集群</h1><p>将前三个节点作为主，后面节点作为从：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it redis-cluster-0 -- redis-cli --cluster create --cluster-replicas 1 $(kubectl get pods -l app=redis-cluster -o jsonpath=<span class=\"string\">&#x27;&#123;range.items[*]&#125;&#123;.status.podIP&#125;:6379 &#x27;</span>)  </span><br></pre></td></tr></table></figure>\n\n<img src=\"./cluster.png\" style=\"zoom:70%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"验证集群\"><a href=\"#验证集群\" class=\"headerlink\" title=\"验证集群\"></a>验证集群</h1><p>使用下面的命令验证集群是否正常：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -it redis-cluster-0 -- redis-cli cluster info  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> x <span class=\"keyword\">in</span> $(seq 0 5); <span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"string\">&quot;redis-cluster-<span class=\"variable\">$x</span>&quot;</span>; kubectl <span class=\"built_in\">exec</span> redis-cluster-<span class=\"variable\">$x</span> -- redis-cli role; <span class=\"built_in\">echo</span>; <span class=\"keyword\">done</span> </span><br></pre></td></tr></table></figure>\n\n<img src=\"./info.png\" style=\"zoom:70%;\" />\n\n<img src=\"./detail.png\" style=\"zoom:70%;\" />\n\n"},{"title":"在k8s中部署mysql主从集群","date":"2021-03-20T11:49:14.000Z","description":"在k8s中部署一个高可用主从mysql集群","cover":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fs3.51cto.com%2Foss%2F201802%2F08%2F63b4c7aed6ae968d015d1996d849e887.jpg-wh_651x-s_1564773166.jpg&refer=http%3A%2F%2Fs3.51cto.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1618833026&t=075446eb7b37fdf6d30bff2ef6ae2ac7","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个mysql 5.7 版本的主从同步集群\n\n更新于 2021-03-20\n\n{% endnote %}\n\n\n\n<br>\n\n\n\n# 目标\n\n- 搭建一个master-slave集群；\n- 读操作可以在master和slave上进行；\n- 写操作只能在master上进行；\n- slave从master同步数据；\n\n\n\n<br>\n\n\n\n# 创建相关文件\n\n{% tabs comments %}\n\n<!-- tab namespace -->\n\n```yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: mysql\n  labels:\n    app: mysql\n```\n\n<!-- endtab -->\n\n<!-- tab configmap -->\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\ndata:\n  master.cnf: |\n    # Master配置\n    [mysqld]\n    log-bin=mysqllog\n    skip-name-resolve\n  slave.cnf: |\n    # Slave配置\n    [mysqld]\n    super-read-only\n    skip-name-resolve\n    log-bin=mysql-bin\n    replicate-ignore-db=mysql\n```\n\n<!-- endtab -->\n\n<!-- tab secret -->\n\n```yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysql-secret\n  namespace: mysql\n  labels:\n    app: mysql\ntype: Opaque\ndata:\n  password: MTIzNDU2 # echo -n \"123456\" | base64\n```\n\n<!-- endtab -->\n\n<!-- tab service -->\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n  clusterIP: None\n  selector:\n    app: mysql\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-read\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n  selector:\n    app: mysql\n```\n\n<!-- endtab -->\n\n<!-- tab statefulset -->\n\n```yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  selector:\n    matchLabels:\n      app: mysql\n  serviceName: mysql\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: mysql\n    spec:\n      initContainers:\n      - name: init-mysql\n        image: mysql:5.7\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          # 从 Pod 的序号，生成 server-id\n          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1\n          ordinal=${BASH_REMATCH[1]}\n          echo [mysqld] > /mnt/conf.d/server-id.cnf\n          # 由于 server-id 不能为 0，因此给 ID 加 100 来避开它\n          echo server-id=$((100 + $ordinal)) >> /mnt/conf.d/server-id.cnf\n          # 如果 Pod 的序号为 0，说明它是 Master 节点，从 ConfigMap 里把 Master 的配置文件拷贝到 /mnt/conf.d 目录下\n          # 否则，拷贝 ConfigMap 里的 Slave 的配置文件\n          if [[ ${ordinal} -eq 0 ]]; then\n            cp /mnt/config-map/master.cnf /mnt/conf.d\n          else\n            cp /mnt/config-map/slave.cnf /mnt/conf.d\n          fi\n        volumeMounts:\n        - name: conf\n          mountPath: /mnt/conf.d\n        - name: config-map\n          mountPath: /mnt/config-map\n      - name: clone-mysql\n        image: gcr.io/google-samples/xtrabackup:1.0\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          # 拷贝操作只需要在第一次启动时进行，所以数据已经存在则跳过\n          [[ -d /var/lib/mysql/mysql ]] && exit 0\n          # Master 节点（序号为 0）不需要这个操作\n          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1\n          ordinal=${BASH_REMATCH[1]}\n          [[ $ordinal == 0 ]] && exit 0\n          # 使用 ncat 指令，远程地从前一个节点拷贝数据到本地\n          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql\n          # 执行 --prepare，这样拷贝来的数据就可以用作恢复了\n          xtrabackup --prepare --target-dir=/var/lib/mysql\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n      containers:\n      - name: mysql\n        image: mysql:5.7\n        env:\n#        - name: MYSQL_ALLOW_EMPTY_PASSWORD\n#          value: \"1\"\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        ports:\n        - name: mysql\n          containerPort: 3306\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n        resources:\n          requests:\n            cpu: 500m\n            memory: 1Gi\n        livenessProbe:\n          exec:\n            command: [\"mysqladmin\", \"ping\", \"-uroot\", \"-p${MYSQL_ROOT_PASSWORD}\"]\n          initialDelaySeconds: 30\n          periodSeconds: 10\n          timeoutSeconds: 5\n        readinessProbe:\n          exec:\n            command: [\"mysqladmin\", \"ping\", \"-uroot\", \"-p${MYSQL_ROOT_PASSWORD}\"]\n          initialDelaySeconds: 5\n          periodSeconds: 2\n          timeoutSeconds: 1\n      - name: xtrabackup\n        image: gcr.io/google-samples/xtrabackup:1.0\n        ports:\n        - name: xtrabackup\n          containerPort: 3307\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          cd /var/lib/mysql\n          # 从备份信息文件里读取 MASTER_LOG_FILE 和 MASTER_LOG_POS 这 2 个字段的值，用来拼装集群初始化 SQL\n          if [[ -f xtrabackup_slave_info ]]; then\n            # 如果 xtrabackup_slave_info 文件存在，说明这个备份数据来自于另一个 Slave 节点\n            # 这种情况下，XtraBackup 工具在备份的时候，就已经在这个文件里自动生成了 \"CHANGE MASTER TO\" SQL 语句\n            # 所以，只需要把这个文件重命名为 change_master_to.sql.in，后面直接使用即可\n            mv xtrabackup_slave_info change_master_to.sql.in\n            # 所以，也就用不着 xtrabackup_binlog_info 了\n            rm -f xtrabackup_binlog_info\n          elif [[ -f xtrabackup_binlog_info ]]; then\n            # 如果只是存在 xtrabackup_binlog_info 文件，说明备份来自于 Master 节点，就需要解析这个备份信息文件，读取所需的两个字段的值\n            [[ $(cat xtrabackup_binlog_info) =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1\n            rm xtrabackup_binlog_info\n            # 把两个字段的值拼装成 SQL，写入 change_master_to.sql.in 文件\n            echo \"CHANGE MASTER TO MASTER_LOG_FILE='${BASH_REMATCH[1]}',\\\n                  MASTER_LOG_POS=${BASH_REMATCH[2]}\" > change_master_to.sql.in\n          fi\n          # 如果存在 change_master_to.sql.in，就意味着需要做集群初始化工作\n          if [[ -f change_master_to.sql.in ]]; then\n            # 但一定要先等 MySQL 容器启动之后才能进行下一步连接 MySQL 的操作\n            echo \"Waiting for mysqld to be ready（accepting connections）\"\n            until mysql -h 127.0.0.1 -uroot -p${MYSQL_ROOT_PASSWORD} -e \"SELECT 1\"; do sleep 1; done\n            echo \"Initializing replication from clone position\"\n            # 将文件 change_master_to.sql.in 改个名字\n            # 防止这个 Container 重启的时候，因为又找到了 change_master_to.sql.in，从而重复执行一遍初始化流程\n            mv change_master_to.sql.in change_master_to.sql.orig\n            # 使用 change_master_to.sql.orig 的内容，也就是前面拼装的 SQL，组成一个完整的初始化和启动 Slave 的 SQL 语句\n            mysql -h 127.0.0.1 -uroot -p${MYSQL_ROOT_PASSWORD} << EOF\n          $(< change_master_to.sql.orig),\n            MASTER_HOST='mysql-0.mysql.mysql',\n            MASTER_USER='root',\n            MASTER_PASSWORD='${MYSQL_ROOT_PASSWORD}',\n            MASTER_CONNECT_RETRY=10;\n          START SLAVE;\n          EOF\n          fi\n          # 使用 ncat 监听 3307 端口。\n          # 它的作用是，在收到传输请求的时候，直接执行 xtrabackup --backup 命令，备份 MySQL 的数据并发送给请求者\n          exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \\\n            \"xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root --password=${MYSQL_ROOT_PASSWORD}\"\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n      volumes:\n      - name: conf\n        emptyDir: {}\n      - name: config-map\n        configMap:\n          name: mysql\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - \"ReadWriteOnce\"\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 3Gi\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 验证服务\n\n## 验证主从\n\n执行下面命令：\n\n```bash\nkubectl -n mysql exec mysql-1 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'show slave status \\G'\"\n```\n\n<img src=\"./zhucong.png\" style=\"zoom:70%;\" />\n\n\n\n> 证明组从同步是正常的\n\n\n\n## 插入数据查看同步\n\n在master上插入数据：\n\n```bash\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'create database test’\"\n\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;create table counter(c int);’\"\n\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;insert into counter values(123)’\"\n```\n\n\n\n在slave上查看数据是否同步：\n\n```bash\nkubectl -n mysql exec mysql-1 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;select * from counter’\"  \n```\n\n\n\n<br>\n\n\n\n# 扩展集群\n\n目前这样的集群是支持slave水平扩展的，只需要增加statefulset的副本数即可：\n\n```bash\nkubectl -n mysql scale statefulset mysql -—replicas=3\n```\n\n\n\n然后新的节点也会自动同步：\n\n```bash\nkubectl -n mysql exec mysql-2 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;select * from counter’\"  \n```\n\n","source":"_posts/在k8s中部署mysql主从集群.md","raw":"---\ntitle: 在k8s中部署mysql主从集群\ndate: 2021-03-20 19:49:14\ntags:\n- MySQL\ncategories:\n- 数据库\n- MySQL\n- 部署\ndescription: 在k8s中部署一个高可用主从mysql集群\ncover: https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fs3.51cto.com%2Foss%2F201802%2F08%2F63b4c7aed6ae968d015d1996d849e887.jpg-wh_651x-s_1564773166.jpg&refer=http%3A%2F%2Fs3.51cto.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1618833026&t=075446eb7b37fdf6d30bff2ef6ae2ac7\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个mysql 5.7 版本的主从同步集群\n\n更新于 2021-03-20\n\n{% endnote %}\n\n\n\n<br>\n\n\n\n# 目标\n\n- 搭建一个master-slave集群；\n- 读操作可以在master和slave上进行；\n- 写操作只能在master上进行；\n- slave从master同步数据；\n\n\n\n<br>\n\n\n\n# 创建相关文件\n\n{% tabs comments %}\n\n<!-- tab namespace -->\n\n```yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: mysql\n  labels:\n    app: mysql\n```\n\n<!-- endtab -->\n\n<!-- tab configmap -->\n\n```yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\ndata:\n  master.cnf: |\n    # Master配置\n    [mysqld]\n    log-bin=mysqllog\n    skip-name-resolve\n  slave.cnf: |\n    # Slave配置\n    [mysqld]\n    super-read-only\n    skip-name-resolve\n    log-bin=mysql-bin\n    replicate-ignore-db=mysql\n```\n\n<!-- endtab -->\n\n<!-- tab secret -->\n\n```yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: mysql-secret\n  namespace: mysql\n  labels:\n    app: mysql\ntype: Opaque\ndata:\n  password: MTIzNDU2 # echo -n \"123456\" | base64\n```\n\n<!-- endtab -->\n\n<!-- tab service -->\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n  clusterIP: None\n  selector:\n    app: mysql\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql-read\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  ports:\n  - name: mysql\n    port: 3306\n  selector:\n    app: mysql\n```\n\n<!-- endtab -->\n\n<!-- tab statefulset -->\n\n```yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: mysql\n  namespace: mysql\n  labels:\n    app: mysql\nspec:\n  selector:\n    matchLabels:\n      app: mysql\n  serviceName: mysql\n  replicas: 2\n  template:\n    metadata:\n      labels:\n        app: mysql\n    spec:\n      initContainers:\n      - name: init-mysql\n        image: mysql:5.7\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          # 从 Pod 的序号，生成 server-id\n          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1\n          ordinal=${BASH_REMATCH[1]}\n          echo [mysqld] > /mnt/conf.d/server-id.cnf\n          # 由于 server-id 不能为 0，因此给 ID 加 100 来避开它\n          echo server-id=$((100 + $ordinal)) >> /mnt/conf.d/server-id.cnf\n          # 如果 Pod 的序号为 0，说明它是 Master 节点，从 ConfigMap 里把 Master 的配置文件拷贝到 /mnt/conf.d 目录下\n          # 否则，拷贝 ConfigMap 里的 Slave 的配置文件\n          if [[ ${ordinal} -eq 0 ]]; then\n            cp /mnt/config-map/master.cnf /mnt/conf.d\n          else\n            cp /mnt/config-map/slave.cnf /mnt/conf.d\n          fi\n        volumeMounts:\n        - name: conf\n          mountPath: /mnt/conf.d\n        - name: config-map\n          mountPath: /mnt/config-map\n      - name: clone-mysql\n        image: gcr.io/google-samples/xtrabackup:1.0\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          # 拷贝操作只需要在第一次启动时进行，所以数据已经存在则跳过\n          [[ -d /var/lib/mysql/mysql ]] && exit 0\n          # Master 节点（序号为 0）不需要这个操作\n          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1\n          ordinal=${BASH_REMATCH[1]}\n          [[ $ordinal == 0 ]] && exit 0\n          # 使用 ncat 指令，远程地从前一个节点拷贝数据到本地\n          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql\n          # 执行 --prepare，这样拷贝来的数据就可以用作恢复了\n          xtrabackup --prepare --target-dir=/var/lib/mysql\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n      containers:\n      - name: mysql\n        image: mysql:5.7\n        env:\n#        - name: MYSQL_ALLOW_EMPTY_PASSWORD\n#          value: \"1\"\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        ports:\n        - name: mysql\n          containerPort: 3306\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n        resources:\n          requests:\n            cpu: 500m\n            memory: 1Gi\n        livenessProbe:\n          exec:\n            command: [\"mysqladmin\", \"ping\", \"-uroot\", \"-p${MYSQL_ROOT_PASSWORD}\"]\n          initialDelaySeconds: 30\n          periodSeconds: 10\n          timeoutSeconds: 5\n        readinessProbe:\n          exec:\n            command: [\"mysqladmin\", \"ping\", \"-uroot\", \"-p${MYSQL_ROOT_PASSWORD}\"]\n          initialDelaySeconds: 5\n          periodSeconds: 2\n          timeoutSeconds: 1\n      - name: xtrabackup\n        image: gcr.io/google-samples/xtrabackup:1.0\n        ports:\n        - name: xtrabackup\n          containerPort: 3307\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          valueFrom:\n            secretKeyRef:\n              name: mysql-secret\n              key: password\n        command:\n        - bash\n        - \"-c\"\n        - |\n          set -ex\n          cd /var/lib/mysql\n          # 从备份信息文件里读取 MASTER_LOG_FILE 和 MASTER_LOG_POS 这 2 个字段的值，用来拼装集群初始化 SQL\n          if [[ -f xtrabackup_slave_info ]]; then\n            # 如果 xtrabackup_slave_info 文件存在，说明这个备份数据来自于另一个 Slave 节点\n            # 这种情况下，XtraBackup 工具在备份的时候，就已经在这个文件里自动生成了 \"CHANGE MASTER TO\" SQL 语句\n            # 所以，只需要把这个文件重命名为 change_master_to.sql.in，后面直接使用即可\n            mv xtrabackup_slave_info change_master_to.sql.in\n            # 所以，也就用不着 xtrabackup_binlog_info 了\n            rm -f xtrabackup_binlog_info\n          elif [[ -f xtrabackup_binlog_info ]]; then\n            # 如果只是存在 xtrabackup_binlog_info 文件，说明备份来自于 Master 节点，就需要解析这个备份信息文件，读取所需的两个字段的值\n            [[ $(cat xtrabackup_binlog_info) =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1\n            rm xtrabackup_binlog_info\n            # 把两个字段的值拼装成 SQL，写入 change_master_to.sql.in 文件\n            echo \"CHANGE MASTER TO MASTER_LOG_FILE='${BASH_REMATCH[1]}',\\\n                  MASTER_LOG_POS=${BASH_REMATCH[2]}\" > change_master_to.sql.in\n          fi\n          # 如果存在 change_master_to.sql.in，就意味着需要做集群初始化工作\n          if [[ -f change_master_to.sql.in ]]; then\n            # 但一定要先等 MySQL 容器启动之后才能进行下一步连接 MySQL 的操作\n            echo \"Waiting for mysqld to be ready（accepting connections）\"\n            until mysql -h 127.0.0.1 -uroot -p${MYSQL_ROOT_PASSWORD} -e \"SELECT 1\"; do sleep 1; done\n            echo \"Initializing replication from clone position\"\n            # 将文件 change_master_to.sql.in 改个名字\n            # 防止这个 Container 重启的时候，因为又找到了 change_master_to.sql.in，从而重复执行一遍初始化流程\n            mv change_master_to.sql.in change_master_to.sql.orig\n            # 使用 change_master_to.sql.orig 的内容，也就是前面拼装的 SQL，组成一个完整的初始化和启动 Slave 的 SQL 语句\n            mysql -h 127.0.0.1 -uroot -p${MYSQL_ROOT_PASSWORD} << EOF\n          $(< change_master_to.sql.orig),\n            MASTER_HOST='mysql-0.mysql.mysql',\n            MASTER_USER='root',\n            MASTER_PASSWORD='${MYSQL_ROOT_PASSWORD}',\n            MASTER_CONNECT_RETRY=10;\n          START SLAVE;\n          EOF\n          fi\n          # 使用 ncat 监听 3307 端口。\n          # 它的作用是，在收到传输请求的时候，直接执行 xtrabackup --backup 命令，备份 MySQL 的数据并发送给请求者\n          exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \\\n            \"xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root --password=${MYSQL_ROOT_PASSWORD}\"\n        volumeMounts:\n        - name: data\n          mountPath: /var/lib/mysql\n          subPath: mysql\n        - name: conf\n          mountPath: /etc/mysql/conf.d\n      volumes:\n      - name: conf\n        emptyDir: {}\n      - name: config-map\n        configMap:\n          name: mysql\n  volumeClaimTemplates:\n  - metadata:\n      name: data\n    spec:\n      accessModes:\n      - \"ReadWriteOnce\"\n      storageClassName: local-storage\n      resources:\n        requests:\n          storage: 3Gi\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 验证服务\n\n## 验证主从\n\n执行下面命令：\n\n```bash\nkubectl -n mysql exec mysql-1 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'show slave status \\G'\"\n```\n\n<img src=\"./zhucong.png\" style=\"zoom:70%;\" />\n\n\n\n> 证明组从同步是正常的\n\n\n\n## 插入数据查看同步\n\n在master上插入数据：\n\n```bash\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'create database test’\"\n\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;create table counter(c int);’\"\n\nkubectl -n mysql exec mysql-0 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;insert into counter values(123)’\"\n```\n\n\n\n在slave上查看数据是否同步：\n\n```bash\nkubectl -n mysql exec mysql-1 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;select * from counter’\"  \n```\n\n\n\n<br>\n\n\n\n# 扩展集群\n\n目前这样的集群是支持slave水平扩展的，只需要增加statefulset的副本数即可：\n\n```bash\nkubectl -n mysql scale statefulset mysql -—replicas=3\n```\n\n\n\n然后新的节点也会自动同步：\n\n```bash\nkubectl -n mysql exec mysql-2 -c mysql -- bash -c \"mysql -uroot -p123456 -e 'use test;select * from counter’\"  \n```\n\n","slug":"在k8s中部署mysql主从集群","published":1,"updated":"2021-03-20T12:02:46.706Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckmhomleh00009akldrlddunm","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个mysql 5.7 版本的主从同步集群</p><p>更新于 2021-03-20</p>\n          </div>\n\n\n\n<br>\n\n\n\n<h1 id=\"目标\"><a href=\"#目标\" class=\"headerlink\" title=\"目标\"></a>目标</h1><ul>\n<li>搭建一个master-slave集群；</li>\n<li>读操作可以在master和slave上进行；</li>\n<li>写操作只能在master上进行；</li>\n<li>slave从master同步数据；</li>\n</ul>\n<br>\n\n\n\n<h1 id=\"创建相关文件\"><a href=\"#创建相关文件\" class=\"headerlink\" title=\"创建相关文件\"></a>创建相关文件</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">namespace</button></li><li class=\"tab\"><button data-href=\"#comments-2\">configmap</button></li><li class=\"tab\"><button data-href=\"#comments-3\">secret</button></li><li class=\"tab\"><button data-href=\"#comments-4\">service</button></li><li class=\"tab\"><button data-href=\"#comments-5\">statefulset</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">master.cnf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"comment\"># Master配置</span></span><br><span class=\"line\">    [<span class=\"string\">mysqld</span>]</span><br><span class=\"line\">    <span class=\"string\">log-bin=mysqllog</span></span><br><span class=\"line\">    <span class=\"string\">skip-name-resolve</span></span><br><span class=\"line\">  <span class=\"attr\">slave.cnf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"comment\"># Slave配置</span></span><br><span class=\"line\">    [<span class=\"string\">mysqld</span>]</span><br><span class=\"line\">    <span class=\"string\">super-read-only</span></span><br><span class=\"line\">    <span class=\"string\">skip-name-resolve</span></span><br><span class=\"line\">    <span class=\"string\">log-bin=mysql-bin</span></span><br><span class=\"line\">    <span class=\"string\">replicate-ignore-db=mysql</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">Opaque</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">password:</span> <span class=\"string\">MTIzNDU2</span> <span class=\"comment\"># echo -n &quot;123456&quot; | base64</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-read</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-5\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">init-mysql</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">mysql:5.7</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">              <span class=\"attr\">key:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">bash</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">set</span> <span class=\"string\">-ex</span></span><br><span class=\"line\">          <span class=\"comment\"># 从 Pod 的序号，生成 server-id</span></span><br><span class=\"line\">          [[ <span class=\"string\">$(hostname)</span> <span class=\"string\">=~</span> <span class=\"string\">-(</span>[<span class=\"number\">0</span><span class=\"number\">-9</span>]<span class=\"string\">+)$</span> ]] <span class=\"string\">||</span> <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"string\">ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class=\"line\">          <span class=\"string\">echo</span> [<span class=\"string\">mysqld</span>] <span class=\"string\">&gt;</span> <span class=\"string\">/mnt/conf.d/server-id.cnf</span></span><br><span class=\"line\">          <span class=\"comment\"># 由于 server-id 不能为 0，因此给 ID 加 100 来避开它</span></span><br><span class=\"line\">          <span class=\"string\">echo</span> <span class=\"string\">server-id=$((100</span> <span class=\"string\">+</span> <span class=\"string\">$ordinal))</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">/mnt/conf.d/server-id.cnf</span></span><br><span class=\"line\">          <span class=\"comment\"># 如果 Pod 的序号为 0，说明它是 Master 节点，从 ConfigMap 里把 Master 的配置文件拷贝到 /mnt/conf.d 目录下</span></span><br><span class=\"line\">          <span class=\"comment\"># 否则，拷贝 ConfigMap 里的 Slave 的配置文件</span></span><br><span class=\"line\">          <span class=\"string\">if</span> [[ <span class=\"string\">$</span>&#123;<span class=\"string\">ordinal</span>&#125; <span class=\"string\">-eq</span> <span class=\"number\">0</span> ]]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">            <span class=\"string\">cp</span> <span class=\"string\">/mnt/config-map/master.cnf</span> <span class=\"string\">/mnt/conf.d</span></span><br><span class=\"line\">          <span class=\"string\">else</span></span><br><span class=\"line\">            <span class=\"string\">cp</span> <span class=\"string\">/mnt/config-map/slave.cnf</span> <span class=\"string\">/mnt/conf.d</span></span><br><span class=\"line\">          <span class=\"string\">fi</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/mnt/conf.d</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config-map</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/mnt/config-map</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">clone-mysql</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">gcr.io/google-samples/xtrabackup:1.0</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">              <span class=\"attr\">key:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">bash</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">set</span> <span class=\"string\">-ex</span></span><br><span class=\"line\">          <span class=\"comment\"># 拷贝操作只需要在第一次启动时进行，所以数据已经存在则跳过</span></span><br><span class=\"line\">          [[ <span class=\"string\">-d</span> <span class=\"string\">/var/lib/mysql/mysql</span> ]] <span class=\"string\">&amp;&amp;</span> <span class=\"string\">exit</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"comment\"># Master 节点（序号为 0）不需要这个操作</span></span><br><span class=\"line\">          [[ <span class=\"string\">$(hostname)</span> <span class=\"string\">=~</span> <span class=\"string\">-(</span>[<span class=\"number\">0</span><span class=\"number\">-9</span>]<span class=\"string\">+)$</span> ]] <span class=\"string\">||</span> <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"string\">ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class=\"line\">          [[ <span class=\"string\">$ordinal</span> <span class=\"string\">==</span> <span class=\"number\">0</span> ]] <span class=\"string\">&amp;&amp;</span> <span class=\"string\">exit</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"comment\"># 使用 ncat 指令，远程地从前一个节点拷贝数据到本地</span></span><br><span class=\"line\">          <span class=\"string\">ncat</span> <span class=\"string\">--recv-only</span> <span class=\"string\">mysql-$(($ordinal-1)).mysql</span> <span class=\"number\">3307</span> <span class=\"string\">|</span> <span class=\"string\">xbstream</span> <span class=\"string\">-x</span> <span class=\"string\">-C</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"comment\"># 执行 --prepare，这样拷贝来的数据就可以用作恢复了</span></span><br><span class=\"line\">          <span class=\"string\">xtrabackup</span> <span class=\"string\">--prepare</span> <span class=\"string\">--target-dir=/var/lib/mysql</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/mysql/conf.d</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">mysql:5.7</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\"><span class=\"comment\">#        - name: MYSQL_ALLOW_EMPTY_PASSWORD</span></span><br><span class=\"line\"><span class=\"comment\">#          value: &quot;1&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">              <span class=\"attr\">key:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">          <span class=\"attr\">containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/mysql/conf.d</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span> [<span class=\"string\">&quot;mysqladmin&quot;</span>, <span class=\"string\">&quot;ping&quot;</span>, <span class=\"string\">&quot;-uroot&quot;</span>, <span class=\"string\">&quot;-p$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;</span>]</span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span> [<span class=\"string\">&quot;mysqladmin&quot;</span>, <span class=\"string\">&quot;ping&quot;</span>, <span class=\"string\">&quot;-uroot&quot;</span>, <span class=\"string\">&quot;-p$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;</span>]</span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">2</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">xtrabackup</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">gcr.io/google-samples/xtrabackup:1.0</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">xtrabackup</span></span><br><span class=\"line\">          <span class=\"attr\">containerPort:</span> <span class=\"number\">3307</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">              <span class=\"attr\">key:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">bash</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">set</span> <span class=\"string\">-ex</span></span><br><span class=\"line\">          <span class=\"string\">cd</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"comment\"># 从备份信息文件里读取 MASTER_LOG_FILE 和 MASTER_LOG_POS 这 2 个字段的值，用来拼装集群初始化 SQL</span></span><br><span class=\"line\">          <span class=\"string\">if</span> [[ <span class=\"string\">-f</span> <span class=\"string\">xtrabackup_slave_info</span> ]]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># 如果 xtrabackup_slave_info 文件存在，说明这个备份数据来自于另一个 Slave 节点</span></span><br><span class=\"line\">            <span class=\"comment\"># 这种情况下，XtraBackup 工具在备份的时候，就已经在这个文件里自动生成了 &quot;CHANGE MASTER TO&quot; SQL 语句</span></span><br><span class=\"line\">            <span class=\"comment\"># 所以，只需要把这个文件重命名为 change_master_to.sql.in，后面直接使用即可</span></span><br><span class=\"line\">            <span class=\"string\">mv</span> <span class=\"string\">xtrabackup_slave_info</span> <span class=\"string\">change_master_to.sql.in</span></span><br><span class=\"line\">            <span class=\"comment\"># 所以，也就用不着 xtrabackup_binlog_info 了</span></span><br><span class=\"line\">            <span class=\"string\">rm</span> <span class=\"string\">-f</span> <span class=\"string\">xtrabackup_binlog_info</span></span><br><span class=\"line\">          <span class=\"string\">elif</span> [[ <span class=\"string\">-f</span> <span class=\"string\">xtrabackup_binlog_info</span> ]]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># 如果只是存在 xtrabackup_binlog_info 文件，说明备份来自于 Master 节点，就需要解析这个备份信息文件，读取所需的两个字段的值</span></span><br><span class=\"line\">            [[ <span class=\"string\">$(cat</span> <span class=\"string\">xtrabackup_binlog_info)</span> <span class=\"string\">=~</span> <span class=\"string\">^(.*?)</span>[[<span class=\"string\">:space:</span>]]<span class=\"string\">+(.*?)$</span> ]] <span class=\"string\">||</span> <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"string\">rm</span> <span class=\"string\">xtrabackup_binlog_info</span></span><br><span class=\"line\">            <span class=\"comment\"># 把两个字段的值拼装成 SQL，写入 change_master_to.sql.in 文件</span></span><br><span class=\"line\">            <span class=\"string\">echo</span> <span class=\"string\">&quot;CHANGE MASTER TO MASTER_LOG_FILE=&#x27;$&#123;BASH_REMATCH[1]&#125;&#x27;,\\</span></span><br><span class=\"line\"><span class=\"string\">                  MASTER_LOG_POS=$&#123;BASH_REMATCH[2]&#125;&quot;</span> <span class=\"string\">&gt;</span> <span class=\"string\">change_master_to.sql.in</span></span><br><span class=\"line\">          <span class=\"string\">fi</span></span><br><span class=\"line\">          <span class=\"comment\"># 如果存在 change_master_to.sql.in，就意味着需要做集群初始化工作</span></span><br><span class=\"line\">          <span class=\"string\">if</span> [[ <span class=\"string\">-f</span> <span class=\"string\">change_master_to.sql.in</span> ]]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># 但一定要先等 MySQL 容器启动之后才能进行下一步连接 MySQL 的操作</span></span><br><span class=\"line\">            <span class=\"string\">echo</span> <span class=\"string\">&quot;Waiting for mysqld to be ready（accepting connections）&quot;</span></span><br><span class=\"line\">            <span class=\"string\">until</span> <span class=\"string\">mysql</span> <span class=\"string\">-h</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> <span class=\"string\">-uroot</span> <span class=\"string\">-p$&#123;MYSQL_ROOT_PASSWORD&#125;</span> <span class=\"string\">-e</span> <span class=\"string\">&quot;SELECT 1&quot;</span><span class=\"string\">;</span> <span class=\"string\">do</span> <span class=\"string\">sleep</span> <span class=\"number\">1</span><span class=\"string\">;</span> <span class=\"string\">done</span></span><br><span class=\"line\">            <span class=\"string\">echo</span> <span class=\"string\">&quot;Initializing replication from clone position&quot;</span></span><br><span class=\"line\">            <span class=\"comment\"># 将文件 change_master_to.sql.in 改个名字</span></span><br><span class=\"line\">            <span class=\"comment\"># 防止这个 Container 重启的时候，因为又找到了 change_master_to.sql.in，从而重复执行一遍初始化流程</span></span><br><span class=\"line\">            <span class=\"string\">mv</span> <span class=\"string\">change_master_to.sql.in</span> <span class=\"string\">change_master_to.sql.orig</span></span><br><span class=\"line\">            <span class=\"comment\"># 使用 change_master_to.sql.orig 的内容，也就是前面拼装的 SQL，组成一个完整的初始化和启动 Slave 的 SQL 语句</span></span><br><span class=\"line\">            <span class=\"string\">mysql</span> <span class=\"string\">-h</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> <span class=\"string\">-uroot</span> <span class=\"string\">-p$&#123;MYSQL_ROOT_PASSWORD&#125;</span> <span class=\"string\">&lt;&lt;</span> <span class=\"string\">EOF</span></span><br><span class=\"line\">          <span class=\"string\">$(&lt;</span> <span class=\"string\">change_master_to.sql.orig),</span></span><br><span class=\"line\">            <span class=\"string\">MASTER_HOST=&#x27;mysql-0.mysql.mysql&#x27;,</span></span><br><span class=\"line\">            <span class=\"string\">MASTER_USER=&#x27;root&#x27;,</span></span><br><span class=\"line\">            <span class=\"string\">MASTER_PASSWORD=&#x27;$&#123;MYSQL_ROOT_PASSWORD&#125;&#x27;,</span></span><br><span class=\"line\">            <span class=\"string\">MASTER_CONNECT_RETRY=10;</span></span><br><span class=\"line\">          <span class=\"string\">START</span> <span class=\"string\">SLAVE;</span></span><br><span class=\"line\">          <span class=\"string\">EOF</span></span><br><span class=\"line\">          <span class=\"string\">fi</span></span><br><span class=\"line\">          <span class=\"comment\"># 使用 ncat 监听 3307 端口。</span></span><br><span class=\"line\">          <span class=\"comment\"># 它的作用是，在收到传输请求的时候，直接执行 xtrabackup --backup 命令，备份 MySQL 的数据并发送给请求者</span></span><br><span class=\"line\">          <span class=\"string\">exec</span> <span class=\"string\">ncat</span> <span class=\"string\">--listen</span> <span class=\"string\">--keep-open</span> <span class=\"string\">--send-only</span> <span class=\"string\">--max-conns=1</span> <span class=\"number\">3307</span> <span class=\"string\">-c</span> <span class=\"string\">\\</span></span><br><span class=\"line\">            <span class=\"string\">&quot;xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root --password=$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/mysql/conf.d</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">        <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config-map</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;ReadWriteOnce&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">local-storage</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">3Gi</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"验证服务\"><a href=\"#验证服务\" class=\"headerlink\" title=\"验证服务\"></a>验证服务</h1><h2 id=\"验证主从\"><a href=\"#验证主从\" class=\"headerlink\" title=\"验证主从\"></a>验证主从</h2><p>执行下面命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-1 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;show slave status \\G&#x27;&quot;</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./zhucong.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>证明组从同步是正常的</p>\n</blockquote>\n<h2 id=\"插入数据查看同步\"><a href=\"#插入数据查看同步\" class=\"headerlink\" title=\"插入数据查看同步\"></a>插入数据查看同步</h2><p>在master上插入数据：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-0 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;create database test’&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-0 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;use test;create table counter(c int);’&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-0 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;use test;insert into counter values(123)’&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>在slave上查看数据是否同步：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-1 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;use test;select * from counter’&quot;</span>  </span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"扩展集群\"><a href=\"#扩展集群\" class=\"headerlink\" title=\"扩展集群\"></a>扩展集群</h1><p>目前这样的集群是支持slave水平扩展的，只需要增加statefulset的副本数即可：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql scale statefulset mysql -—replicas=3</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后新的节点也会自动同步：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-2 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;use test;select * from counter’&quot;</span>  </span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个mysql 5.7 版本的主从同步集群</p><p>更新于 2021-03-20</p>\n          </div>\n\n\n\n<br>\n\n\n\n<h1 id=\"目标\"><a href=\"#目标\" class=\"headerlink\" title=\"目标\"></a>目标</h1><ul>\n<li>搭建一个master-slave集群；</li>\n<li>读操作可以在master和slave上进行；</li>\n<li>写操作只能在master上进行；</li>\n<li>slave从master同步数据；</li>\n</ul>\n<br>\n\n\n\n<h1 id=\"创建相关文件\"><a href=\"#创建相关文件\" class=\"headerlink\" title=\"创建相关文件\"></a>创建相关文件</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">namespace</button></li><li class=\"tab\"><button data-href=\"#comments-2\">configmap</button></li><li class=\"tab\"><button data-href=\"#comments-3\">secret</button></li><li class=\"tab\"><button data-href=\"#comments-4\">service</button></li><li class=\"tab\"><button data-href=\"#comments-5\">statefulset</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">master.cnf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"comment\"># Master配置</span></span><br><span class=\"line\">    [<span class=\"string\">mysqld</span>]</span><br><span class=\"line\">    <span class=\"string\">log-bin=mysqllog</span></span><br><span class=\"line\">    <span class=\"string\">skip-name-resolve</span></span><br><span class=\"line\">  <span class=\"attr\">slave.cnf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"comment\"># Slave配置</span></span><br><span class=\"line\">    [<span class=\"string\">mysqld</span>]</span><br><span class=\"line\">    <span class=\"string\">super-read-only</span></span><br><span class=\"line\">    <span class=\"string\">skip-name-resolve</span></span><br><span class=\"line\">    <span class=\"string\">log-bin=mysql-bin</span></span><br><span class=\"line\">    <span class=\"string\">replicate-ignore-db=mysql</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">Opaque</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">password:</span> <span class=\"string\">MTIzNDU2</span> <span class=\"comment\"># echo -n &quot;123456&quot; | base64</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-read</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-5\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">init-mysql</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">mysql:5.7</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">              <span class=\"attr\">key:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">bash</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">set</span> <span class=\"string\">-ex</span></span><br><span class=\"line\">          <span class=\"comment\"># 从 Pod 的序号，生成 server-id</span></span><br><span class=\"line\">          [[ <span class=\"string\">$(hostname)</span> <span class=\"string\">=~</span> <span class=\"string\">-(</span>[<span class=\"number\">0</span><span class=\"number\">-9</span>]<span class=\"string\">+)$</span> ]] <span class=\"string\">||</span> <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"string\">ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class=\"line\">          <span class=\"string\">echo</span> [<span class=\"string\">mysqld</span>] <span class=\"string\">&gt;</span> <span class=\"string\">/mnt/conf.d/server-id.cnf</span></span><br><span class=\"line\">          <span class=\"comment\"># 由于 server-id 不能为 0，因此给 ID 加 100 来避开它</span></span><br><span class=\"line\">          <span class=\"string\">echo</span> <span class=\"string\">server-id=$((100</span> <span class=\"string\">+</span> <span class=\"string\">$ordinal))</span> <span class=\"string\">&gt;&gt;</span> <span class=\"string\">/mnt/conf.d/server-id.cnf</span></span><br><span class=\"line\">          <span class=\"comment\"># 如果 Pod 的序号为 0，说明它是 Master 节点，从 ConfigMap 里把 Master 的配置文件拷贝到 /mnt/conf.d 目录下</span></span><br><span class=\"line\">          <span class=\"comment\"># 否则，拷贝 ConfigMap 里的 Slave 的配置文件</span></span><br><span class=\"line\">          <span class=\"string\">if</span> [[ <span class=\"string\">$</span>&#123;<span class=\"string\">ordinal</span>&#125; <span class=\"string\">-eq</span> <span class=\"number\">0</span> ]]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">            <span class=\"string\">cp</span> <span class=\"string\">/mnt/config-map/master.cnf</span> <span class=\"string\">/mnt/conf.d</span></span><br><span class=\"line\">          <span class=\"string\">else</span></span><br><span class=\"line\">            <span class=\"string\">cp</span> <span class=\"string\">/mnt/config-map/slave.cnf</span> <span class=\"string\">/mnt/conf.d</span></span><br><span class=\"line\">          <span class=\"string\">fi</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/mnt/conf.d</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config-map</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/mnt/config-map</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">clone-mysql</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">gcr.io/google-samples/xtrabackup:1.0</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">              <span class=\"attr\">key:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">bash</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">set</span> <span class=\"string\">-ex</span></span><br><span class=\"line\">          <span class=\"comment\"># 拷贝操作只需要在第一次启动时进行，所以数据已经存在则跳过</span></span><br><span class=\"line\">          [[ <span class=\"string\">-d</span> <span class=\"string\">/var/lib/mysql/mysql</span> ]] <span class=\"string\">&amp;&amp;</span> <span class=\"string\">exit</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"comment\"># Master 节点（序号为 0）不需要这个操作</span></span><br><span class=\"line\">          [[ <span class=\"string\">$(hostname)</span> <span class=\"string\">=~</span> <span class=\"string\">-(</span>[<span class=\"number\">0</span><span class=\"number\">-9</span>]<span class=\"string\">+)$</span> ]] <span class=\"string\">||</span> <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"string\">ordinal=$&#123;BASH_REMATCH[1]&#125;</span></span><br><span class=\"line\">          [[ <span class=\"string\">$ordinal</span> <span class=\"string\">==</span> <span class=\"number\">0</span> ]] <span class=\"string\">&amp;&amp;</span> <span class=\"string\">exit</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"comment\"># 使用 ncat 指令，远程地从前一个节点拷贝数据到本地</span></span><br><span class=\"line\">          <span class=\"string\">ncat</span> <span class=\"string\">--recv-only</span> <span class=\"string\">mysql-$(($ordinal-1)).mysql</span> <span class=\"number\">3307</span> <span class=\"string\">|</span> <span class=\"string\">xbstream</span> <span class=\"string\">-x</span> <span class=\"string\">-C</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"comment\"># 执行 --prepare，这样拷贝来的数据就可以用作恢复了</span></span><br><span class=\"line\">          <span class=\"string\">xtrabackup</span> <span class=\"string\">--prepare</span> <span class=\"string\">--target-dir=/var/lib/mysql</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/mysql/conf.d</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">mysql:5.7</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\"><span class=\"comment\">#        - name: MYSQL_ALLOW_EMPTY_PASSWORD</span></span><br><span class=\"line\"><span class=\"comment\">#          value: &quot;1&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">              <span class=\"attr\">key:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">          <span class=\"attr\">containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/mysql/conf.d</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span> [<span class=\"string\">&quot;mysqladmin&quot;</span>, <span class=\"string\">&quot;ping&quot;</span>, <span class=\"string\">&quot;-uroot&quot;</span>, <span class=\"string\">&quot;-p$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;</span>]</span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span> [<span class=\"string\">&quot;mysqladmin&quot;</span>, <span class=\"string\">&quot;ping&quot;</span>, <span class=\"string\">&quot;-uroot&quot;</span>, <span class=\"string\">&quot;-p$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;</span>]</span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">2</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">xtrabackup</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">gcr.io/google-samples/xtrabackup:1.0</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">xtrabackup</span></span><br><span class=\"line\">          <span class=\"attr\">containerPort:</span> <span class=\"number\">3307</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">mysql-secret</span></span><br><span class=\"line\">              <span class=\"attr\">key:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">bash</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">|</span></span><br><span class=\"line\">          <span class=\"string\">set</span> <span class=\"string\">-ex</span></span><br><span class=\"line\">          <span class=\"string\">cd</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"comment\"># 从备份信息文件里读取 MASTER_LOG_FILE 和 MASTER_LOG_POS 这 2 个字段的值，用来拼装集群初始化 SQL</span></span><br><span class=\"line\">          <span class=\"string\">if</span> [[ <span class=\"string\">-f</span> <span class=\"string\">xtrabackup_slave_info</span> ]]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># 如果 xtrabackup_slave_info 文件存在，说明这个备份数据来自于另一个 Slave 节点</span></span><br><span class=\"line\">            <span class=\"comment\"># 这种情况下，XtraBackup 工具在备份的时候，就已经在这个文件里自动生成了 &quot;CHANGE MASTER TO&quot; SQL 语句</span></span><br><span class=\"line\">            <span class=\"comment\"># 所以，只需要把这个文件重命名为 change_master_to.sql.in，后面直接使用即可</span></span><br><span class=\"line\">            <span class=\"string\">mv</span> <span class=\"string\">xtrabackup_slave_info</span> <span class=\"string\">change_master_to.sql.in</span></span><br><span class=\"line\">            <span class=\"comment\"># 所以，也就用不着 xtrabackup_binlog_info 了</span></span><br><span class=\"line\">            <span class=\"string\">rm</span> <span class=\"string\">-f</span> <span class=\"string\">xtrabackup_binlog_info</span></span><br><span class=\"line\">          <span class=\"string\">elif</span> [[ <span class=\"string\">-f</span> <span class=\"string\">xtrabackup_binlog_info</span> ]]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># 如果只是存在 xtrabackup_binlog_info 文件，说明备份来自于 Master 节点，就需要解析这个备份信息文件，读取所需的两个字段的值</span></span><br><span class=\"line\">            [[ <span class=\"string\">$(cat</span> <span class=\"string\">xtrabackup_binlog_info)</span> <span class=\"string\">=~</span> <span class=\"string\">^(.*?)</span>[[<span class=\"string\">:space:</span>]]<span class=\"string\">+(.*?)$</span> ]] <span class=\"string\">||</span> <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"string\">rm</span> <span class=\"string\">xtrabackup_binlog_info</span></span><br><span class=\"line\">            <span class=\"comment\"># 把两个字段的值拼装成 SQL，写入 change_master_to.sql.in 文件</span></span><br><span class=\"line\">            <span class=\"string\">echo</span> <span class=\"string\">&quot;CHANGE MASTER TO MASTER_LOG_FILE=&#x27;$&#123;BASH_REMATCH[1]&#125;&#x27;,\\</span></span><br><span class=\"line\"><span class=\"string\">                  MASTER_LOG_POS=$&#123;BASH_REMATCH[2]&#125;&quot;</span> <span class=\"string\">&gt;</span> <span class=\"string\">change_master_to.sql.in</span></span><br><span class=\"line\">          <span class=\"string\">fi</span></span><br><span class=\"line\">          <span class=\"comment\"># 如果存在 change_master_to.sql.in，就意味着需要做集群初始化工作</span></span><br><span class=\"line\">          <span class=\"string\">if</span> [[ <span class=\"string\">-f</span> <span class=\"string\">change_master_to.sql.in</span> ]]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># 但一定要先等 MySQL 容器启动之后才能进行下一步连接 MySQL 的操作</span></span><br><span class=\"line\">            <span class=\"string\">echo</span> <span class=\"string\">&quot;Waiting for mysqld to be ready（accepting connections）&quot;</span></span><br><span class=\"line\">            <span class=\"string\">until</span> <span class=\"string\">mysql</span> <span class=\"string\">-h</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> <span class=\"string\">-uroot</span> <span class=\"string\">-p$&#123;MYSQL_ROOT_PASSWORD&#125;</span> <span class=\"string\">-e</span> <span class=\"string\">&quot;SELECT 1&quot;</span><span class=\"string\">;</span> <span class=\"string\">do</span> <span class=\"string\">sleep</span> <span class=\"number\">1</span><span class=\"string\">;</span> <span class=\"string\">done</span></span><br><span class=\"line\">            <span class=\"string\">echo</span> <span class=\"string\">&quot;Initializing replication from clone position&quot;</span></span><br><span class=\"line\">            <span class=\"comment\"># 将文件 change_master_to.sql.in 改个名字</span></span><br><span class=\"line\">            <span class=\"comment\"># 防止这个 Container 重启的时候，因为又找到了 change_master_to.sql.in，从而重复执行一遍初始化流程</span></span><br><span class=\"line\">            <span class=\"string\">mv</span> <span class=\"string\">change_master_to.sql.in</span> <span class=\"string\">change_master_to.sql.orig</span></span><br><span class=\"line\">            <span class=\"comment\"># 使用 change_master_to.sql.orig 的内容，也就是前面拼装的 SQL，组成一个完整的初始化和启动 Slave 的 SQL 语句</span></span><br><span class=\"line\">            <span class=\"string\">mysql</span> <span class=\"string\">-h</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> <span class=\"string\">-uroot</span> <span class=\"string\">-p$&#123;MYSQL_ROOT_PASSWORD&#125;</span> <span class=\"string\">&lt;&lt;</span> <span class=\"string\">EOF</span></span><br><span class=\"line\">          <span class=\"string\">$(&lt;</span> <span class=\"string\">change_master_to.sql.orig),</span></span><br><span class=\"line\">            <span class=\"string\">MASTER_HOST=&#x27;mysql-0.mysql.mysql&#x27;,</span></span><br><span class=\"line\">            <span class=\"string\">MASTER_USER=&#x27;root&#x27;,</span></span><br><span class=\"line\">            <span class=\"string\">MASTER_PASSWORD=&#x27;$&#123;MYSQL_ROOT_PASSWORD&#125;&#x27;,</span></span><br><span class=\"line\">            <span class=\"string\">MASTER_CONNECT_RETRY=10;</span></span><br><span class=\"line\">          <span class=\"string\">START</span> <span class=\"string\">SLAVE;</span></span><br><span class=\"line\">          <span class=\"string\">EOF</span></span><br><span class=\"line\">          <span class=\"string\">fi</span></span><br><span class=\"line\">          <span class=\"comment\"># 使用 ncat 监听 3307 端口。</span></span><br><span class=\"line\">          <span class=\"comment\"># 它的作用是，在收到传输请求的时候，直接执行 xtrabackup --backup 命令，备份 MySQL 的数据并发送给请求者</span></span><br><span class=\"line\">          <span class=\"string\">exec</span> <span class=\"string\">ncat</span> <span class=\"string\">--listen</span> <span class=\"string\">--keep-open</span> <span class=\"string\">--send-only</span> <span class=\"string\">--max-conns=1</span> <span class=\"number\">3307</span> <span class=\"string\">-c</span> <span class=\"string\">\\</span></span><br><span class=\"line\">            <span class=\"string\">&quot;xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root --password=$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/mysql/conf.d</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">conf</span></span><br><span class=\"line\">        <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config-map</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;ReadWriteOnce&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">local-storage</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">3Gi</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"验证服务\"><a href=\"#验证服务\" class=\"headerlink\" title=\"验证服务\"></a>验证服务</h1><h2 id=\"验证主从\"><a href=\"#验证主从\" class=\"headerlink\" title=\"验证主从\"></a>验证主从</h2><p>执行下面命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-1 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;show slave status \\G&#x27;&quot;</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./zhucong.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>证明组从同步是正常的</p>\n</blockquote>\n<h2 id=\"插入数据查看同步\"><a href=\"#插入数据查看同步\" class=\"headerlink\" title=\"插入数据查看同步\"></a>插入数据查看同步</h2><p>在master上插入数据：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-0 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;create database test’&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-0 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;use test;create table counter(c int);’&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-0 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;use test;insert into counter values(123)’&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>在slave上查看数据是否同步：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-1 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;use test;select * from counter’&quot;</span>  </span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"扩展集群\"><a href=\"#扩展集群\" class=\"headerlink\" title=\"扩展集群\"></a>扩展集群</h1><p>目前这样的集群是支持slave水平扩展的，只需要增加statefulset的副本数即可：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql scale statefulset mysql -—replicas=3</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后新的节点也会自动同步：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n mysql <span class=\"built_in\">exec</span> mysql-2 -c mysql -- bash -c <span class=\"string\">&quot;mysql -uroot -p123456 -e &#x27;use test;select * from counter’&quot;</span>  </span><br></pre></td></tr></table></figure>\n\n"},{"title":"部署Mysql5.7","date":"2021-03-21T09:30:43.000Z","description":"使用RPM和源码两种方式部署一个单节点mysql 5.7服务","cover":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic2.zhimg.com%2Fv2-c16b7d2b9e1ee5bccad87488ea69e352_1200x500.jpg&refer=http%3A%2F%2Fpic2.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1618911539&t=69fb2b2d94fdfe5deb68e606202bc923","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用RPM和源码两种方式部署一个单节点mysql 5.7服务，实验环境为centos7\n\n更新于 2021-03-21\n\n{% endnote %}\n\n<br>\n\n\n\n# RPM方式部署\n\n## 卸载旧版本\n\n首先检查是否存在旧的mysql：\n\n```bash\nrpm -qa | grep -i mysql\n```\n\n\n\n如果存在就需要卸载：\n\n```bash\nrpm -ev [旧的mysql包名]\n```\n\n\n\n## 下载\n\n下载mysql5.7官方prm包\n\n```bash\nwget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar\n```\n\n\n\n然后解压，可以看到解压出如下的一些安装包：\n\n```bash\ntar xvf mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar \n\nmysql-community-embedded-devel-5.7.26-1.el7.x86_64.rpm\nmysql-community-libs-5.7.26-1.el7.x86_64.rpm\nmysql-community-embedded-5.7.26-1.el7.x86_64.rpm\nmysql-community-test-5.7.26-1.el7.x86_64.rpm\nmysql-community-embedded-compat-5.7.26-1.el7.x86_64.rpm\nmysql-community-common-5.7.26-1.el7.x86_64.rpm\nmysql-community-devel-5.7.26-1.el7.x86_64.rpm\nmysql-community-client-5.7.26-1.el7.x86_64.rpm\nmysql-community-server-5.7.26-1.el7.x86_64.rpm\nmysql-community-libs-compat-5.7.26-1.el7.x86_64.rpm\n```\n\n- mysql-community-client：客户端的安装包；\n- mysql-community-server：服务端的安装包；\n- mysql-community-devel：包含开发库文件的安装包；\n- mysql-community-test：包含测试的安装包；\n- mysql-community-embedded：嵌入式mysql安装包；\n\n\n\n## 安装\n\n一般情况下，只需要安装client和server安装包即可，当然其也会依赖其他库的安装包：\n\n```bash\nrpm -ivh mysql-community-common-5.7.26-1.el7.x86_64.rpm\nrpm -ivh mysql-community-libs*\nrpm -ivh mysql-community-client-5.7.26-1.el7.x86_64.rpm\nrpm -ivh mysql-community-devel-5.7.26-1.el7.x86_64.rpm\nyum install -y perl libaio libaio-devel numactl net-tools\nrpm -ivh mysql-community-server-5.7.26-1.el7.x86_64.rpm\n```\n\n\n\n## 启动服务\n\n启动mysql服务\n\n```bash\nsystemctl start mysqld.service\n```\n\n\n\n## 获取初始密码\n\n查看mysql日志，找到类似下面的这一行：\n\n```bash\ncat /var/log/mysql.log\n\n[Note] A temporary password is generated for root@localhost: <wqB!ebdk6b4\n```\n\n> mysql第一次运行的时候会初始化一个root用户并设置一个随机密码，这一行可以找到这个密码\n\n\n\n## 修改密码并连接\n\n可以通过下面的命令修改root密码并删除测试数据库和匿名用户\n\n```bash\n# 设置root用户密码\nmysqladmin -u root -p'<wqB!ebdk6b4' password Root123?\n\n# 删除测试数据库和匿名用户\nmysql_secure_installation\n```\n\n> mysql密码需要符合一定的密码规则，否则设置会失败\n\n\n\n下面就可以连接mysql了：\n\n```bash\n$ mysql -uroot -pRoot123?\n```\n\n\n\n<br>\n\n\n\n# 源码方式安装\n\n## 依赖安装\n\n安装依赖包：\n\n```bash\nyum install -y make gcc gcc-c++ cmake bison-devel ncurses ncurses-devel\n```\n\n\n\n## 下载源码包\n\n首先下载mysql5.7源码包：\n\n```bash\nwget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.26.tar.gz\n```\n\n\n\n## 创建安装目录\n\n创建安装目录和数据目录，安装目录一般放在 `/usr/local/` 下，数据目录使用单独的磁盘：\n\n```bash\nmkdir /usr/local/mysql\nmkdir -p /data/3306/data\nmkdir -p /data/3306/binlog\n```\n\n\n\n## 安装boost库\n\n> 从mysql5.7开始，boost库是必须依赖的\n\n```bash\nmkdir /usr/local/boost\ncd /usr/local/boost\nwget http://www.sourceforge.net/projects/boost/files/boost/1.59.0/boost_1_59_0.tar.gz\ntar zxf boost_1_59_0.tar.gz\n```\n\n\n\n## 编译安装mysql\n\n编译源码：\n\n```bash\ntar zxf mysql-boost-5.7.26.tar.gz\ncd mysql-5.7.26/\n\ncmake \\\n-DCMAKE_INSTALL_PREFIX=/usr/local/mysql \\   \n-DMYSQL_DATADIR=/data/3306/data \\\n-DSYSCONFDIR=/data/3306 \\\n-DWITH_MYISAM_STORAGE_ENGINE=1 \\\n-DWITH_INNOBASE_STORAGE_ENGINE=1 \\\n-DWITH_MEMORY_STORAGE_ENGINE=1 \\\n-DWITH_READLINE=1 \\\n-DMYSQL_UNIX_ADDR=/data/3306/mysql.sock \\\n-DMYSQL_TCP_PORT=3306 \\\n-DENABLED_LOCAL_INFILE=1 \\\n-DWITH_PARTITION_STORAGE_ENGINE=1 \\\n-DEXTRA_CHARSETS=all \\\n-DDEFAULT_CHARSET=utf8mb4 \\\n-DDEFAULT_COLLATION=utf8mb4_general_ci \\\n-DWITH_BOOST=/usr/local/boost\n```\n\n- `DCMAKE_INSTALL_PREFIX` ：安装的根目录；\n- `DMYSQL_DATADIR`：数据目录；\n- `DSYSCONFDIR`：配置文件目录；\n- `DWITH_MYISAM_STORAGE_ENGINE=1`：编译myisam存储引擎，默认的存储引擎，不加也可以；\n- `DWITH_INNOBASE_STORAGE_ENGINE=1`：支持InnoDB存储引擎，这个也是默认安装的；\n- `DWITH_MEMORY_STORAGE_ENGINE=1`： 持MEMORY引擎；\n- `DWITH_READLINE=1`：使用readline功能；\n- `DMYSQL_UNIX_ADDR`：sock文件存放目录；\n- `DMYSQL_TCP_PORT=3306` ：数据库端口；\n- `DENABLED_LOCAL_INFILE=1`：可以使用load data infile命令从本地导入文件；\n- `DWITH_PARTITION_STORAGE_ENGINE=1`： 安装数据库分区；\n- `DEXTRA_CHARSETS=all`： 支持所有字符集；\n- `DDEFAULT_CHARSET=utf8mb4`：默认字符集；\n- `DDEFAULT_COLLATION=utf8mb4_general_ci` ：默认效验字符集排序规则，要和`DDEFAULT_CHARSET`一起用；\n- `DWITH_BOOST=/usr/local/boost`：指定boost库位置，从5.7.5开始Boost库是必需的；\n\n\n\n编译成功后进行安装：\n\n```bash\nmake && make install\nmake clean\n```\n\n\n\n## 添加用户并初始化\n\n```bash\ngroupadd mysql\nuseradd -g mysql mysql\nchown -R mysql:mysql /usr/local/mysql\nchown -R mysql:mysql /data/3306\ncd /usr/local/mysql\n./bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/data/3306/data/ \n```\n\n\n\n观察初始化输出，找到类似于如下的一行：\n\n```\n2019-06-29T11:32:37.238756Z 1 [Note] A temporary password is generated for root@localhost: &leFGSPpM4sC\n```\n\n> **这个是初始化设置的mysql默认root密码，需要暂时记住。**\n\n\n\n## 环境设置\n\n设置环境变量：\n\n```bash\necho \"export PATH=$PATH:/usr/local/mysql/bin\" >> /etc/profile\nsource /etc/profile\n```\n\n\n\n设置mysql启动文件：\n\n```bash\ncd /usr/local/mysql/support-files\ncp mysql.server /etc/init.d/mysqld\nchmod 755 /etc/init.d/mysqld\n```\n\n\n\n修改mysql启动脚本，设置数据目录和根目录：\n\n```bash\nvim /etc/init.d/mysqld\n\n// 修改下面的项目指定根目录\nbasedir=/usr/local/mysql/\ndatadir=/data/3306/data/\n```\n\n\n\n修改配置文件：\n\n```bash\nvim /etc/my.cnf\n\n// 修改为如下的形式\n[mysqld]\nbasedir=/usr/local/mysql\ndatadir=/data/3306/data/\nsocket=/data/3306/mysql.sock\nuser=mysql\ntmpdir=/data/3306/\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n# Settings user and group are ignored when systemd is used.\n# If you need to run mysqld under a different user or group,\n# customize your systemd unit file for mariadb according to the\n# instructions in http://fedoraproject.org/wiki/Systemd\n\n[mysqld_safe]\nlog-error=/data/3306/data/error.log\npid-file=/data/3306/data/mysql.pid\n\n#\n# include all files from the config directory\n#\n!includedir /etc/my.cnf.d\n```\n\n\n\n## 启动服务并连接\n\n启动mysql：\n\n```bash\nservice mysqld start \nnetstat -ntlp | grep mysqld\ntcp6       0      0 :::3306                 :::*                    LISTEN      18471/mysqld        \n```\n\n\n\n现在就可以使用前面获取到的默认密码登录数据库了，不过也可以使用下面的命令来重新设置密码及删除匿名用户和库：\n\n```bash\n# 设置root用户密码\nmysqladmin -u root -p'&leFGSPpM4sC' password Root123?\n\n# 删除测试数据库和匿名用户\nmysql_secure_installation\nmysql -uroot -pRoot123?\n```\n\n","source":"_posts/部署Mysql5-7.md","raw":"---\ntitle: 部署Mysql5.7\ndate: 2021-03-21 17:30:43\ntags:\n- MySQL\ncategories:\n- 数据库\n- MySQL\n- 部署\ndescription: 使用RPM和源码两种方式部署一个单节点mysql 5.7服务\ncover: https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic2.zhimg.com%2Fv2-c16b7d2b9e1ee5bccad87488ea69e352_1200x500.jpg&refer=http%3A%2F%2Fpic2.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1618911539&t=69fb2b2d94fdfe5deb68e606202bc923\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用RPM和源码两种方式部署一个单节点mysql 5.7服务，实验环境为centos7\n\n更新于 2021-03-21\n\n{% endnote %}\n\n<br>\n\n\n\n# RPM方式部署\n\n## 卸载旧版本\n\n首先检查是否存在旧的mysql：\n\n```bash\nrpm -qa | grep -i mysql\n```\n\n\n\n如果存在就需要卸载：\n\n```bash\nrpm -ev [旧的mysql包名]\n```\n\n\n\n## 下载\n\n下载mysql5.7官方prm包\n\n```bash\nwget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar\n```\n\n\n\n然后解压，可以看到解压出如下的一些安装包：\n\n```bash\ntar xvf mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar \n\nmysql-community-embedded-devel-5.7.26-1.el7.x86_64.rpm\nmysql-community-libs-5.7.26-1.el7.x86_64.rpm\nmysql-community-embedded-5.7.26-1.el7.x86_64.rpm\nmysql-community-test-5.7.26-1.el7.x86_64.rpm\nmysql-community-embedded-compat-5.7.26-1.el7.x86_64.rpm\nmysql-community-common-5.7.26-1.el7.x86_64.rpm\nmysql-community-devel-5.7.26-1.el7.x86_64.rpm\nmysql-community-client-5.7.26-1.el7.x86_64.rpm\nmysql-community-server-5.7.26-1.el7.x86_64.rpm\nmysql-community-libs-compat-5.7.26-1.el7.x86_64.rpm\n```\n\n- mysql-community-client：客户端的安装包；\n- mysql-community-server：服务端的安装包；\n- mysql-community-devel：包含开发库文件的安装包；\n- mysql-community-test：包含测试的安装包；\n- mysql-community-embedded：嵌入式mysql安装包；\n\n\n\n## 安装\n\n一般情况下，只需要安装client和server安装包即可，当然其也会依赖其他库的安装包：\n\n```bash\nrpm -ivh mysql-community-common-5.7.26-1.el7.x86_64.rpm\nrpm -ivh mysql-community-libs*\nrpm -ivh mysql-community-client-5.7.26-1.el7.x86_64.rpm\nrpm -ivh mysql-community-devel-5.7.26-1.el7.x86_64.rpm\nyum install -y perl libaio libaio-devel numactl net-tools\nrpm -ivh mysql-community-server-5.7.26-1.el7.x86_64.rpm\n```\n\n\n\n## 启动服务\n\n启动mysql服务\n\n```bash\nsystemctl start mysqld.service\n```\n\n\n\n## 获取初始密码\n\n查看mysql日志，找到类似下面的这一行：\n\n```bash\ncat /var/log/mysql.log\n\n[Note] A temporary password is generated for root@localhost: <wqB!ebdk6b4\n```\n\n> mysql第一次运行的时候会初始化一个root用户并设置一个随机密码，这一行可以找到这个密码\n\n\n\n## 修改密码并连接\n\n可以通过下面的命令修改root密码并删除测试数据库和匿名用户\n\n```bash\n# 设置root用户密码\nmysqladmin -u root -p'<wqB!ebdk6b4' password Root123?\n\n# 删除测试数据库和匿名用户\nmysql_secure_installation\n```\n\n> mysql密码需要符合一定的密码规则，否则设置会失败\n\n\n\n下面就可以连接mysql了：\n\n```bash\n$ mysql -uroot -pRoot123?\n```\n\n\n\n<br>\n\n\n\n# 源码方式安装\n\n## 依赖安装\n\n安装依赖包：\n\n```bash\nyum install -y make gcc gcc-c++ cmake bison-devel ncurses ncurses-devel\n```\n\n\n\n## 下载源码包\n\n首先下载mysql5.7源码包：\n\n```bash\nwget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.26.tar.gz\n```\n\n\n\n## 创建安装目录\n\n创建安装目录和数据目录，安装目录一般放在 `/usr/local/` 下，数据目录使用单独的磁盘：\n\n```bash\nmkdir /usr/local/mysql\nmkdir -p /data/3306/data\nmkdir -p /data/3306/binlog\n```\n\n\n\n## 安装boost库\n\n> 从mysql5.7开始，boost库是必须依赖的\n\n```bash\nmkdir /usr/local/boost\ncd /usr/local/boost\nwget http://www.sourceforge.net/projects/boost/files/boost/1.59.0/boost_1_59_0.tar.gz\ntar zxf boost_1_59_0.tar.gz\n```\n\n\n\n## 编译安装mysql\n\n编译源码：\n\n```bash\ntar zxf mysql-boost-5.7.26.tar.gz\ncd mysql-5.7.26/\n\ncmake \\\n-DCMAKE_INSTALL_PREFIX=/usr/local/mysql \\   \n-DMYSQL_DATADIR=/data/3306/data \\\n-DSYSCONFDIR=/data/3306 \\\n-DWITH_MYISAM_STORAGE_ENGINE=1 \\\n-DWITH_INNOBASE_STORAGE_ENGINE=1 \\\n-DWITH_MEMORY_STORAGE_ENGINE=1 \\\n-DWITH_READLINE=1 \\\n-DMYSQL_UNIX_ADDR=/data/3306/mysql.sock \\\n-DMYSQL_TCP_PORT=3306 \\\n-DENABLED_LOCAL_INFILE=1 \\\n-DWITH_PARTITION_STORAGE_ENGINE=1 \\\n-DEXTRA_CHARSETS=all \\\n-DDEFAULT_CHARSET=utf8mb4 \\\n-DDEFAULT_COLLATION=utf8mb4_general_ci \\\n-DWITH_BOOST=/usr/local/boost\n```\n\n- `DCMAKE_INSTALL_PREFIX` ：安装的根目录；\n- `DMYSQL_DATADIR`：数据目录；\n- `DSYSCONFDIR`：配置文件目录；\n- `DWITH_MYISAM_STORAGE_ENGINE=1`：编译myisam存储引擎，默认的存储引擎，不加也可以；\n- `DWITH_INNOBASE_STORAGE_ENGINE=1`：支持InnoDB存储引擎，这个也是默认安装的；\n- `DWITH_MEMORY_STORAGE_ENGINE=1`： 持MEMORY引擎；\n- `DWITH_READLINE=1`：使用readline功能；\n- `DMYSQL_UNIX_ADDR`：sock文件存放目录；\n- `DMYSQL_TCP_PORT=3306` ：数据库端口；\n- `DENABLED_LOCAL_INFILE=1`：可以使用load data infile命令从本地导入文件；\n- `DWITH_PARTITION_STORAGE_ENGINE=1`： 安装数据库分区；\n- `DEXTRA_CHARSETS=all`： 支持所有字符集；\n- `DDEFAULT_CHARSET=utf8mb4`：默认字符集；\n- `DDEFAULT_COLLATION=utf8mb4_general_ci` ：默认效验字符集排序规则，要和`DDEFAULT_CHARSET`一起用；\n- `DWITH_BOOST=/usr/local/boost`：指定boost库位置，从5.7.5开始Boost库是必需的；\n\n\n\n编译成功后进行安装：\n\n```bash\nmake && make install\nmake clean\n```\n\n\n\n## 添加用户并初始化\n\n```bash\ngroupadd mysql\nuseradd -g mysql mysql\nchown -R mysql:mysql /usr/local/mysql\nchown -R mysql:mysql /data/3306\ncd /usr/local/mysql\n./bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/data/3306/data/ \n```\n\n\n\n观察初始化输出，找到类似于如下的一行：\n\n```\n2019-06-29T11:32:37.238756Z 1 [Note] A temporary password is generated for root@localhost: &leFGSPpM4sC\n```\n\n> **这个是初始化设置的mysql默认root密码，需要暂时记住。**\n\n\n\n## 环境设置\n\n设置环境变量：\n\n```bash\necho \"export PATH=$PATH:/usr/local/mysql/bin\" >> /etc/profile\nsource /etc/profile\n```\n\n\n\n设置mysql启动文件：\n\n```bash\ncd /usr/local/mysql/support-files\ncp mysql.server /etc/init.d/mysqld\nchmod 755 /etc/init.d/mysqld\n```\n\n\n\n修改mysql启动脚本，设置数据目录和根目录：\n\n```bash\nvim /etc/init.d/mysqld\n\n// 修改下面的项目指定根目录\nbasedir=/usr/local/mysql/\ndatadir=/data/3306/data/\n```\n\n\n\n修改配置文件：\n\n```bash\nvim /etc/my.cnf\n\n// 修改为如下的形式\n[mysqld]\nbasedir=/usr/local/mysql\ndatadir=/data/3306/data/\nsocket=/data/3306/mysql.sock\nuser=mysql\ntmpdir=/data/3306/\n# Disabling symbolic-links is recommended to prevent assorted security risks\nsymbolic-links=0\n# Settings user and group are ignored when systemd is used.\n# If you need to run mysqld under a different user or group,\n# customize your systemd unit file for mariadb according to the\n# instructions in http://fedoraproject.org/wiki/Systemd\n\n[mysqld_safe]\nlog-error=/data/3306/data/error.log\npid-file=/data/3306/data/mysql.pid\n\n#\n# include all files from the config directory\n#\n!includedir /etc/my.cnf.d\n```\n\n\n\n## 启动服务并连接\n\n启动mysql：\n\n```bash\nservice mysqld start \nnetstat -ntlp | grep mysqld\ntcp6       0      0 :::3306                 :::*                    LISTEN      18471/mysqld        \n```\n\n\n\n现在就可以使用前面获取到的默认密码登录数据库了，不过也可以使用下面的命令来重新设置密码及删除匿名用户和库：\n\n```bash\n# 设置root用户密码\nmysqladmin -u root -p'&leFGSPpM4sC' password Root123?\n\n# 删除测试数据库和匿名用户\nmysql_secure_installation\nmysql -uroot -pRoot123?\n```\n\n","slug":"部署Mysql5-7","published":1,"updated":"2021-03-21T09:39:11.608Z","_id":"ckmiywj6d0000rckldiobffs5","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用RPM和源码两种方式部署一个单节点mysql 5.7服务，实验环境为centos7</p><p>更新于 2021-03-21</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"RPM方式部署\"><a href=\"#RPM方式部署\" class=\"headerlink\" title=\"RPM方式部署\"></a>RPM方式部署</h1><h2 id=\"卸载旧版本\"><a href=\"#卸载旧版本\" class=\"headerlink\" title=\"卸载旧版本\"></a>卸载旧版本</h2><p>首先检查是否存在旧的mysql：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -qa | grep -i mysql</span><br></pre></td></tr></table></figure>\n\n\n\n<p>如果存在就需要卸载：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -ev [旧的mysql包名]</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p>下载mysql5.7官方prm包</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后解压，可以看到解压出如下的一些安装包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar xvf mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar </span><br><span class=\"line\"></span><br><span class=\"line\">mysql-community-embedded-devel-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-libs-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-embedded-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-test-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-embedded-compat-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-common-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-devel-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-client-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-libs-compat-5.7.26-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>mysql-community-client：客户端的安装包；</li>\n<li>mysql-community-server：服务端的安装包；</li>\n<li>mysql-community-devel：包含开发库文件的安装包；</li>\n<li>mysql-community-test：包含测试的安装包；</li>\n<li>mysql-community-embedded：嵌入式mysql安装包；</li>\n</ul>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>一般情况下，只需要安装client和server安装包即可，当然其也会依赖其他库的安装包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -ivh mysql-community-common-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">rpm -ivh mysql-community-libs*</span><br><span class=\"line\">rpm -ivh mysql-community-client-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">rpm -ivh mysql-community-devel-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">yum install -y perl libaio libaio-devel numactl net-tools</span><br><span class=\"line\">rpm -ivh mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"启动服务\"><a href=\"#启动服务\" class=\"headerlink\" title=\"启动服务\"></a>启动服务</h2><p>启动mysql服务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start mysqld.service</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"获取初始密码\"><a href=\"#获取初始密码\" class=\"headerlink\" title=\"获取初始密码\"></a>获取初始密码</h2><p>查看mysql日志，找到类似下面的这一行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /var/<span class=\"built_in\">log</span>/mysql.log</span><br><span class=\"line\"></span><br><span class=\"line\">[Note] A temporary password is generated <span class=\"keyword\">for</span> root@localhost: &lt;wqB!ebdk6b4</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>mysql第一次运行的时候会初始化一个root用户并设置一个随机密码，这一行可以找到这个密码</p>\n</blockquote>\n<h2 id=\"修改密码并连接\"><a href=\"#修改密码并连接\" class=\"headerlink\" title=\"修改密码并连接\"></a>修改密码并连接</h2><p>可以通过下面的命令修改root密码并删除测试数据库和匿名用户</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置root用户密码</span></span><br><span class=\"line\">mysqladmin -u root -p<span class=\"string\">&#x27;&lt;wqB!ebdk6b4&#x27;</span> password Root123?</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除测试数据库和匿名用户</span></span><br><span class=\"line\">mysql_secure_installation</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>mysql密码需要符合一定的密码规则，否则设置会失败</p>\n</blockquote>\n<p>下面就可以连接mysql了：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mysql -uroot -pRoot123?</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"源码方式安装\"><a href=\"#源码方式安装\" class=\"headerlink\" title=\"源码方式安装\"></a>源码方式安装</h1><h2 id=\"依赖安装\"><a href=\"#依赖安装\" class=\"headerlink\" title=\"依赖安装\"></a>依赖安装</h2><p>安装依赖包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y make gcc gcc-c++ cmake bison-devel ncurses ncurses-devel</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"下载源码包\"><a href=\"#下载源码包\" class=\"headerlink\" title=\"下载源码包\"></a>下载源码包</h2><p>首先下载mysql5.7源码包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.26.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建安装目录\"><a href=\"#创建安装目录\" class=\"headerlink\" title=\"创建安装目录\"></a>创建安装目录</h2><p>创建安装目录和数据目录，安装目录一般放在 <code>/usr/local/</code> 下，数据目录使用单独的磁盘：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">mkdir -p /data/3306/data</span><br><span class=\"line\">mkdir -p /data/3306/binlog</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"安装boost库\"><a href=\"#安装boost库\" class=\"headerlink\" title=\"安装boost库\"></a>安装boost库</h2><blockquote>\n<p>从mysql5.7开始，boost库是必须依赖的</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /usr/<span class=\"built_in\">local</span>/boost</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/boost</span><br><span class=\"line\">wget http://www.sourceforge.net/projects/boost/files/boost/1.59.0/boost_1_59_0.tar.gz</span><br><span class=\"line\">tar zxf boost_1_59_0.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"编译安装mysql\"><a href=\"#编译安装mysql\" class=\"headerlink\" title=\"编译安装mysql\"></a>编译安装mysql</h2><p>编译源码：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxf mysql-boost-5.7.26.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> mysql-5.7.26/</span><br><span class=\"line\"></span><br><span class=\"line\">cmake \\</span><br><span class=\"line\">-DCMAKE_INSTALL_PREFIX=/usr/<span class=\"built_in\">local</span>/mysql \\   </span><br><span class=\"line\">-DMYSQL_DATADIR=/data/3306/data \\</span><br><span class=\"line\">-DSYSCONFDIR=/data/3306 \\</span><br><span class=\"line\">-DWITH_MYISAM_STORAGE_ENGINE=1 \\</span><br><span class=\"line\">-DWITH_INNOBASE_STORAGE_ENGINE=1 \\</span><br><span class=\"line\">-DWITH_MEMORY_STORAGE_ENGINE=1 \\</span><br><span class=\"line\">-DWITH_READLINE=1 \\</span><br><span class=\"line\">-DMYSQL_UNIX_ADDR=/data/3306/mysql.sock \\</span><br><span class=\"line\">-DMYSQL_TCP_PORT=3306 \\</span><br><span class=\"line\">-DENABLED_LOCAL_INFILE=1 \\</span><br><span class=\"line\">-DWITH_PARTITION_STORAGE_ENGINE=1 \\</span><br><span class=\"line\">-DEXTRA_CHARSETS=all \\</span><br><span class=\"line\">-DDEFAULT_CHARSET=utf8mb4 \\</span><br><span class=\"line\">-DDEFAULT_COLLATION=utf8mb4_general_ci \\</span><br><span class=\"line\">-DWITH_BOOST=/usr/<span class=\"built_in\">local</span>/boost</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>DCMAKE_INSTALL_PREFIX</code> ：安装的根目录；</li>\n<li><code>DMYSQL_DATADIR</code>：数据目录；</li>\n<li><code>DSYSCONFDIR</code>：配置文件目录；</li>\n<li><code>DWITH_MYISAM_STORAGE_ENGINE=1</code>：编译myisam存储引擎，默认的存储引擎，不加也可以；</li>\n<li><code>DWITH_INNOBASE_STORAGE_ENGINE=1</code>：支持InnoDB存储引擎，这个也是默认安装的；</li>\n<li><code>DWITH_MEMORY_STORAGE_ENGINE=1</code>： 持MEMORY引擎；</li>\n<li><code>DWITH_READLINE=1</code>：使用readline功能；</li>\n<li><code>DMYSQL_UNIX_ADDR</code>：sock文件存放目录；</li>\n<li><code>DMYSQL_TCP_PORT=3306</code> ：数据库端口；</li>\n<li><code>DENABLED_LOCAL_INFILE=1</code>：可以使用load data infile命令从本地导入文件；</li>\n<li><code>DWITH_PARTITION_STORAGE_ENGINE=1</code>： 安装数据库分区；</li>\n<li><code>DEXTRA_CHARSETS=all</code>： 支持所有字符集；</li>\n<li><code>DDEFAULT_CHARSET=utf8mb4</code>：默认字符集；</li>\n<li><code>DDEFAULT_COLLATION=utf8mb4_general_ci</code> ：默认效验字符集排序规则，要和<code>DDEFAULT_CHARSET</code>一起用；</li>\n<li><code>DWITH_BOOST=/usr/local/boost</code>：指定boost库位置，从5.7.5开始Boost库是必需的；</li>\n</ul>\n<p>编译成功后进行安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\">make clean</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"添加用户并初始化\"><a href=\"#添加用户并初始化\" class=\"headerlink\" title=\"添加用户并初始化\"></a>添加用户并初始化</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd mysql</span><br><span class=\"line\">useradd -g mysql mysql</span><br><span class=\"line\">chown -R mysql:mysql /usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">chown -R mysql:mysql /data/3306</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">./bin/mysqld --initialize --user=mysql --basedir=/usr/<span class=\"built_in\">local</span>/mysql --datadir=/data/3306/data/ </span><br></pre></td></tr></table></figure>\n\n\n\n<p>观察初始化输出，找到类似于如下的一行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2019-06-29T11:32:37.238756Z 1 [Note] A temporary password is generated for root@localhost: &amp;leFGSPpM4sC</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>这个是初始化设置的mysql默认root密码，需要暂时记住。</strong></p>\n</blockquote>\n<h2 id=\"环境设置\"><a href=\"#环境设置\" class=\"headerlink\" title=\"环境设置\"></a>环境设置</h2><p>设置环境变量：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export PATH=<span class=\"variable\">$PATH</span>:/usr/local/mysql/bin&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n\n\n\n<p>设置mysql启动文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/mysql/support-files</span><br><span class=\"line\">cp mysql.server /etc/init.d/mysqld</span><br><span class=\"line\">chmod 755 /etc/init.d/mysqld</span><br></pre></td></tr></table></figure>\n\n\n\n<p>修改mysql启动脚本，设置数据目录和根目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/init.d/mysqld</span><br><span class=\"line\"></span><br><span class=\"line\">// 修改下面的项目指定根目录</span><br><span class=\"line\">basedir=/usr/<span class=\"built_in\">local</span>/mysql/</span><br><span class=\"line\">datadir=/data/3306/data/</span><br></pre></td></tr></table></figure>\n\n\n\n<p>修改配置文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">// 修改为如下的形式</span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">basedir=/usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">datadir=/data/3306/data/</span><br><span class=\"line\">socket=/data/3306/mysql.sock</span><br><span class=\"line\">user=mysql</span><br><span class=\"line\">tmpdir=/data/3306/</span><br><span class=\"line\"><span class=\"comment\"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class=\"line\">symbolic-links=0</span><br><span class=\"line\"><span class=\"comment\"># Settings user and group are ignored when systemd is used.</span></span><br><span class=\"line\"><span class=\"comment\"># If you need to run mysqld under a different user or group,</span></span><br><span class=\"line\"><span class=\"comment\"># customize your systemd unit file for mariadb according to the</span></span><br><span class=\"line\"><span class=\"comment\"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld_safe]</span><br><span class=\"line\">log-error=/data/3306/data/error.log</span><br><span class=\"line\">pid-file=/data/3306/data/mysql.pid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># include all files from the config directory</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\">!includedir /etc/my.cnf.d</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"启动服务并连接\"><a href=\"#启动服务并连接\" class=\"headerlink\" title=\"启动服务并连接\"></a>启动服务并连接</h2><p>启动mysql：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service mysqld start </span><br><span class=\"line\">netstat -ntlp | grep mysqld</span><br><span class=\"line\">tcp6       0      0 :::3306                 :::*                    LISTEN      18471/mysqld        </span><br></pre></td></tr></table></figure>\n\n\n\n<p>现在就可以使用前面获取到的默认密码登录数据库了，不过也可以使用下面的命令来重新设置密码及删除匿名用户和库：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置root用户密码</span></span><br><span class=\"line\">mysqladmin -u root -p<span class=\"string\">&#x27;&amp;leFGSPpM4sC&#x27;</span> password Root123?</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除测试数据库和匿名用户</span></span><br><span class=\"line\">mysql_secure_installation</span><br><span class=\"line\">mysql -uroot -pRoot123?</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用RPM和源码两种方式部署一个单节点mysql 5.7服务，实验环境为centos7</p><p>更新于 2021-03-21</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"RPM方式部署\"><a href=\"#RPM方式部署\" class=\"headerlink\" title=\"RPM方式部署\"></a>RPM方式部署</h1><h2 id=\"卸载旧版本\"><a href=\"#卸载旧版本\" class=\"headerlink\" title=\"卸载旧版本\"></a>卸载旧版本</h2><p>首先检查是否存在旧的mysql：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -qa | grep -i mysql</span><br></pre></td></tr></table></figure>\n\n\n\n<p>如果存在就需要卸载：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -ev [旧的mysql包名]</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p>下载mysql5.7官方prm包</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后解压，可以看到解压出如下的一些安装包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar xvf mysql-5.7.26-1.el7.x86_64.rpm-bundle.tar </span><br><span class=\"line\"></span><br><span class=\"line\">mysql-community-embedded-devel-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-libs-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-embedded-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-test-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-embedded-compat-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-common-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-devel-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-client-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">mysql-community-libs-compat-5.7.26-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>mysql-community-client：客户端的安装包；</li>\n<li>mysql-community-server：服务端的安装包；</li>\n<li>mysql-community-devel：包含开发库文件的安装包；</li>\n<li>mysql-community-test：包含测试的安装包；</li>\n<li>mysql-community-embedded：嵌入式mysql安装包；</li>\n</ul>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>一般情况下，只需要安装client和server安装包即可，当然其也会依赖其他库的安装包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -ivh mysql-community-common-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">rpm -ivh mysql-community-libs*</span><br><span class=\"line\">rpm -ivh mysql-community-client-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">rpm -ivh mysql-community-devel-5.7.26-1.el7.x86_64.rpm</span><br><span class=\"line\">yum install -y perl libaio libaio-devel numactl net-tools</span><br><span class=\"line\">rpm -ivh mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"启动服务\"><a href=\"#启动服务\" class=\"headerlink\" title=\"启动服务\"></a>启动服务</h2><p>启动mysql服务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start mysqld.service</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"获取初始密码\"><a href=\"#获取初始密码\" class=\"headerlink\" title=\"获取初始密码\"></a>获取初始密码</h2><p>查看mysql日志，找到类似下面的这一行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /var/<span class=\"built_in\">log</span>/mysql.log</span><br><span class=\"line\"></span><br><span class=\"line\">[Note] A temporary password is generated <span class=\"keyword\">for</span> root@localhost: &lt;wqB!ebdk6b4</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>mysql第一次运行的时候会初始化一个root用户并设置一个随机密码，这一行可以找到这个密码</p>\n</blockquote>\n<h2 id=\"修改密码并连接\"><a href=\"#修改密码并连接\" class=\"headerlink\" title=\"修改密码并连接\"></a>修改密码并连接</h2><p>可以通过下面的命令修改root密码并删除测试数据库和匿名用户</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置root用户密码</span></span><br><span class=\"line\">mysqladmin -u root -p<span class=\"string\">&#x27;&lt;wqB!ebdk6b4&#x27;</span> password Root123?</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除测试数据库和匿名用户</span></span><br><span class=\"line\">mysql_secure_installation</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>mysql密码需要符合一定的密码规则，否则设置会失败</p>\n</blockquote>\n<p>下面就可以连接mysql了：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ mysql -uroot -pRoot123?</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"源码方式安装\"><a href=\"#源码方式安装\" class=\"headerlink\" title=\"源码方式安装\"></a>源码方式安装</h1><h2 id=\"依赖安装\"><a href=\"#依赖安装\" class=\"headerlink\" title=\"依赖安装\"></a>依赖安装</h2><p>安装依赖包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y make gcc gcc-c++ cmake bison-devel ncurses ncurses-devel</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"下载源码包\"><a href=\"#下载源码包\" class=\"headerlink\" title=\"下载源码包\"></a>下载源码包</h2><p>首先下载mysql5.7源码包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-boost-5.7.26.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建安装目录\"><a href=\"#创建安装目录\" class=\"headerlink\" title=\"创建安装目录\"></a>创建安装目录</h2><p>创建安装目录和数据目录，安装目录一般放在 <code>/usr/local/</code> 下，数据目录使用单独的磁盘：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">mkdir -p /data/3306/data</span><br><span class=\"line\">mkdir -p /data/3306/binlog</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"安装boost库\"><a href=\"#安装boost库\" class=\"headerlink\" title=\"安装boost库\"></a>安装boost库</h2><blockquote>\n<p>从mysql5.7开始，boost库是必须依赖的</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /usr/<span class=\"built_in\">local</span>/boost</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/boost</span><br><span class=\"line\">wget http://www.sourceforge.net/projects/boost/files/boost/1.59.0/boost_1_59_0.tar.gz</span><br><span class=\"line\">tar zxf boost_1_59_0.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"编译安装mysql\"><a href=\"#编译安装mysql\" class=\"headerlink\" title=\"编译安装mysql\"></a>编译安装mysql</h2><p>编译源码：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxf mysql-boost-5.7.26.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> mysql-5.7.26/</span><br><span class=\"line\"></span><br><span class=\"line\">cmake \\</span><br><span class=\"line\">-DCMAKE_INSTALL_PREFIX=/usr/<span class=\"built_in\">local</span>/mysql \\   </span><br><span class=\"line\">-DMYSQL_DATADIR=/data/3306/data \\</span><br><span class=\"line\">-DSYSCONFDIR=/data/3306 \\</span><br><span class=\"line\">-DWITH_MYISAM_STORAGE_ENGINE=1 \\</span><br><span class=\"line\">-DWITH_INNOBASE_STORAGE_ENGINE=1 \\</span><br><span class=\"line\">-DWITH_MEMORY_STORAGE_ENGINE=1 \\</span><br><span class=\"line\">-DWITH_READLINE=1 \\</span><br><span class=\"line\">-DMYSQL_UNIX_ADDR=/data/3306/mysql.sock \\</span><br><span class=\"line\">-DMYSQL_TCP_PORT=3306 \\</span><br><span class=\"line\">-DENABLED_LOCAL_INFILE=1 \\</span><br><span class=\"line\">-DWITH_PARTITION_STORAGE_ENGINE=1 \\</span><br><span class=\"line\">-DEXTRA_CHARSETS=all \\</span><br><span class=\"line\">-DDEFAULT_CHARSET=utf8mb4 \\</span><br><span class=\"line\">-DDEFAULT_COLLATION=utf8mb4_general_ci \\</span><br><span class=\"line\">-DWITH_BOOST=/usr/<span class=\"built_in\">local</span>/boost</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>DCMAKE_INSTALL_PREFIX</code> ：安装的根目录；</li>\n<li><code>DMYSQL_DATADIR</code>：数据目录；</li>\n<li><code>DSYSCONFDIR</code>：配置文件目录；</li>\n<li><code>DWITH_MYISAM_STORAGE_ENGINE=1</code>：编译myisam存储引擎，默认的存储引擎，不加也可以；</li>\n<li><code>DWITH_INNOBASE_STORAGE_ENGINE=1</code>：支持InnoDB存储引擎，这个也是默认安装的；</li>\n<li><code>DWITH_MEMORY_STORAGE_ENGINE=1</code>： 持MEMORY引擎；</li>\n<li><code>DWITH_READLINE=1</code>：使用readline功能；</li>\n<li><code>DMYSQL_UNIX_ADDR</code>：sock文件存放目录；</li>\n<li><code>DMYSQL_TCP_PORT=3306</code> ：数据库端口；</li>\n<li><code>DENABLED_LOCAL_INFILE=1</code>：可以使用load data infile命令从本地导入文件；</li>\n<li><code>DWITH_PARTITION_STORAGE_ENGINE=1</code>： 安装数据库分区；</li>\n<li><code>DEXTRA_CHARSETS=all</code>： 支持所有字符集；</li>\n<li><code>DDEFAULT_CHARSET=utf8mb4</code>：默认字符集；</li>\n<li><code>DDEFAULT_COLLATION=utf8mb4_general_ci</code> ：默认效验字符集排序规则，要和<code>DDEFAULT_CHARSET</code>一起用；</li>\n<li><code>DWITH_BOOST=/usr/local/boost</code>：指定boost库位置，从5.7.5开始Boost库是必需的；</li>\n</ul>\n<p>编译成功后进行安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\">make clean</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"添加用户并初始化\"><a href=\"#添加用户并初始化\" class=\"headerlink\" title=\"添加用户并初始化\"></a>添加用户并初始化</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">groupadd mysql</span><br><span class=\"line\">useradd -g mysql mysql</span><br><span class=\"line\">chown -R mysql:mysql /usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">chown -R mysql:mysql /data/3306</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">./bin/mysqld --initialize --user=mysql --basedir=/usr/<span class=\"built_in\">local</span>/mysql --datadir=/data/3306/data/ </span><br></pre></td></tr></table></figure>\n\n\n\n<p>观察初始化输出，找到类似于如下的一行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2019-06-29T11:32:37.238756Z 1 [Note] A temporary password is generated for root@localhost: &amp;leFGSPpM4sC</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><strong>这个是初始化设置的mysql默认root密码，需要暂时记住。</strong></p>\n</blockquote>\n<h2 id=\"环境设置\"><a href=\"#环境设置\" class=\"headerlink\" title=\"环境设置\"></a>环境设置</h2><p>设置环境变量：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export PATH=<span class=\"variable\">$PATH</span>:/usr/local/mysql/bin&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n\n\n\n<p>设置mysql启动文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/mysql/support-files</span><br><span class=\"line\">cp mysql.server /etc/init.d/mysqld</span><br><span class=\"line\">chmod 755 /etc/init.d/mysqld</span><br></pre></td></tr></table></figure>\n\n\n\n<p>修改mysql启动脚本，设置数据目录和根目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/init.d/mysqld</span><br><span class=\"line\"></span><br><span class=\"line\">// 修改下面的项目指定根目录</span><br><span class=\"line\">basedir=/usr/<span class=\"built_in\">local</span>/mysql/</span><br><span class=\"line\">datadir=/data/3306/data/</span><br></pre></td></tr></table></figure>\n\n\n\n<p>修改配置文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">// 修改为如下的形式</span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">basedir=/usr/<span class=\"built_in\">local</span>/mysql</span><br><span class=\"line\">datadir=/data/3306/data/</span><br><span class=\"line\">socket=/data/3306/mysql.sock</span><br><span class=\"line\">user=mysql</span><br><span class=\"line\">tmpdir=/data/3306/</span><br><span class=\"line\"><span class=\"comment\"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class=\"line\">symbolic-links=0</span><br><span class=\"line\"><span class=\"comment\"># Settings user and group are ignored when systemd is used.</span></span><br><span class=\"line\"><span class=\"comment\"># If you need to run mysqld under a different user or group,</span></span><br><span class=\"line\"><span class=\"comment\"># customize your systemd unit file for mariadb according to the</span></span><br><span class=\"line\"><span class=\"comment\"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld_safe]</span><br><span class=\"line\">log-error=/data/3306/data/error.log</span><br><span class=\"line\">pid-file=/data/3306/data/mysql.pid</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># include all files from the config directory</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\">!includedir /etc/my.cnf.d</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"启动服务并连接\"><a href=\"#启动服务并连接\" class=\"headerlink\" title=\"启动服务并连接\"></a>启动服务并连接</h2><p>启动mysql：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">service mysqld start </span><br><span class=\"line\">netstat -ntlp | grep mysqld</span><br><span class=\"line\">tcp6       0      0 :::3306                 :::*                    LISTEN      18471/mysqld        </span><br></pre></td></tr></table></figure>\n\n\n\n<p>现在就可以使用前面获取到的默认密码登录数据库了，不过也可以使用下面的命令来重新设置密码及删除匿名用户和库：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 设置root用户密码</span></span><br><span class=\"line\">mysqladmin -u root -p<span class=\"string\">&#x27;&amp;leFGSPpM4sC&#x27;</span> password Root123?</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除测试数据库和匿名用户</span></span><br><span class=\"line\">mysql_secure_installation</span><br><span class=\"line\">mysql -uroot -pRoot123?</span><br></pre></td></tr></table></figure>\n\n"},{"title":"在k8s中部署Mysql单实例","date":"2021-03-21T09:42:30.000Z","description":"在k8s中部署一个mysql单实例","cover":"https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=985528186,1328606288&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中部署一个单实例mysql，不具备高可用性只适合于测试开发\n\n更新于 2021-03-21\n\n{% endnote %}\n\n<br>\n\n\n\n# 创建service对象\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\n  namespace: default\nspec:\n  ports:\n  - port: 3306\n  selector:\n    app: mysql\n  clusterIP: None\n```\n\n\n\n执行下面的命令创建：\n\n```bash\nkubectl create -f mysql-service.yaml\n```\n\n\n\n<br>\n\n\n\n# 创建存储卷\n\n```yaml\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: mysql-pv-volume\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 20Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/mnt/data\"\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pv-claim\nspec:\n  storageClassName: manual\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n```\n\n\n\n使用下面的命令创建：\n\n```bash\nkubectl create -f mysql-storage.yaml\n```\n\n\n\n<br>\n\n\n\n# 创建deployment\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: mysql\nspec:\n  selector:\n    matchLabels:\n      app: mysql\n  strategy:\n    type: Recreate\n  template:\n    metadata:\n      labels:\n        app: mysql\n    spec:\n      containers:\n      - image: mysql:5.7\n        name: mysql\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          value: password\n        ports:\n        - containerPort: 3306\n          name: mysql\n        volumeMounts:\n        - name: mysql-persistent-storage\n          mountPath: /var/lib/mysql\n      volumes:\n      - name: mysql-persistent-storage\n        persistentVolumeClaim:\n          claimName: mysql-pv-claim\n```\n\n\n\n执行下面的命令创建：\n\n```bash\nkubectl create -f mysql-deployment.yaml\n```\n\n","source":"_posts/在k8s中部署Mysql单实例.md","raw":"---\ntitle: 在k8s中部署Mysql单实例\ndate: 2021-03-21 17:42:30\ntags:\n- MySQL\ncategories:\n- 数据库\n- MySQL\n- 部署\ndescription:  在k8s中部署一个mysql单实例\ncover: https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=985528186,1328606288&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中部署一个单实例mysql，不具备高可用性只适合于测试开发\n\n更新于 2021-03-21\n\n{% endnote %}\n\n<br>\n\n\n\n# 创建service对象\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: mysql\n  namespace: default\nspec:\n  ports:\n  - port: 3306\n  selector:\n    app: mysql\n  clusterIP: None\n```\n\n\n\n执行下面的命令创建：\n\n```bash\nkubectl create -f mysql-service.yaml\n```\n\n\n\n<br>\n\n\n\n# 创建存储卷\n\n```yaml\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: mysql-pv-volume\n  labels:\n    type: local\nspec:\n  storageClassName: manual\n  capacity:\n    storage: 20Gi\n  accessModes:\n    - ReadWriteOnce\n  hostPath:\n    path: \"/mnt/data\"\n---\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: mysql-pv-claim\nspec:\n  storageClassName: manual\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 20Gi\n```\n\n\n\n使用下面的命令创建：\n\n```bash\nkubectl create -f mysql-storage.yaml\n```\n\n\n\n<br>\n\n\n\n# 创建deployment\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: mysql\nspec:\n  selector:\n    matchLabels:\n      app: mysql\n  strategy:\n    type: Recreate\n  template:\n    metadata:\n      labels:\n        app: mysql\n    spec:\n      containers:\n      - image: mysql:5.7\n        name: mysql\n        env:\n        - name: MYSQL_ROOT_PASSWORD\n          value: password\n        ports:\n        - containerPort: 3306\n          name: mysql\n        volumeMounts:\n        - name: mysql-persistent-storage\n          mountPath: /var/lib/mysql\n      volumes:\n      - name: mysql-persistent-storage\n        persistentVolumeClaim:\n          claimName: mysql-pv-claim\n```\n\n\n\n执行下面的命令创建：\n\n```bash\nkubectl create -f mysql-deployment.yaml\n```\n\n","slug":"在k8s中部署Mysql单实例","published":1,"updated":"2021-03-21T09:45:32.026Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckmiz76uz0000i5klf1kh3vak","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中部署一个单实例mysql，不具备高可用性只适合于测试开发</p><p>更新于 2021-03-21</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"创建service对象\"><a href=\"#创建service对象\" class=\"headerlink\" title=\"创建service对象\"></a>创建service对象</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create -f mysql-service.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"创建存储卷\"><a href=\"#创建存储卷\" class=\"headerlink\" title=\"创建存储卷\"></a>创建存储卷</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-pv-volume</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">manual</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">20Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">  <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">&quot;/mnt/data&quot;</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-pv-claim</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">manual</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">20Gi</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>使用下面的命令创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create -f mysql-storage.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"创建deployment\"><a href=\"#创建deployment\" class=\"headerlink\" title=\"创建deployment\"></a>创建deployment</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">mysql:5.7</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql-persistent-storage</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql-persistent-storage</span></span><br><span class=\"line\">        <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">          <span class=\"attr\">claimName:</span> <span class=\"string\">mysql-pv-claim</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create -f mysql-deployment.yaml</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中部署一个单实例mysql，不具备高可用性只适合于测试开发</p><p>更新于 2021-03-21</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"创建service对象\"><a href=\"#创建service对象\" class=\"headerlink\" title=\"创建service对象\"></a>创建service对象</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create -f mysql-service.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"创建存储卷\"><a href=\"#创建存储卷\" class=\"headerlink\" title=\"创建存储卷\"></a>创建存储卷</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-pv-volume</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">local</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">manual</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">20Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">  <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">&quot;/mnt/data&quot;</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-pv-claim</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">manual</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">20Gi</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>使用下面的命令创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create -f mysql-storage.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"创建deployment\"><a href=\"#创建deployment\" class=\"headerlink\" title=\"创建deployment\"></a>创建deployment</h1><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">mysql:5.7</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">MYSQL_ROOT_PASSWORD</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">password</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">3306</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql-persistent-storage</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/mysql</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql-persistent-storage</span></span><br><span class=\"line\">        <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">          <span class=\"attr\">claimName:</span> <span class=\"string\">mysql-pv-claim</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create -f mysql-deployment.yaml</span><br></pre></td></tr></table></figure>\n\n"},{"title":"在k8s中使用nfs存储","date":"2021-03-23T13:16:14.000Z","description":"在k8s中使用nfs作为底层存储的三种姿势","cover":"https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=251466455,608736426&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用nfs作为存储，实现PV、PVC和storageclass\n\n更新于 2021-03-21\n\n{% endnote %}\n\n<br>\n\n\n\n# 安装NFS\n\n直接使用yum命令安装nfs：\n\n```bash\nyum install -y nfs-utils rpcbind\n```\n\n\n\n创建nfs目录：\n\n```bash\nmkdir -p /opt/nfs/data\necho \"/opt/nfs/data *(rw,no_root_squash)\" >> /etc/exports\n```\n\n> 生产上应该给该目录挂载一个数据盘\n\n\n\n启动nfs：\n\n```bash\nsystemctl start rpcbind\nsystemctl status rpcbind\nsystemctl enable rpcbind\nsystemctl start nfs \nsystemctl status nfs\nsystemctl enable nfs\n```\n\n\n\n在k8s的node和master节点上，都安装`nfs-utils`：\n\n```bash\nyum install -y nfs-utils\n```\n\n\n\n<br>\n\n\n\n# nfs类型的volume\n\n这种方式是直接在yaml中定义数据卷为nfs类型，示例如下：\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-nfs\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx-nfs\n  template:\n    metadata:\n      labels:\n          app: nginx-nfs\n    spec:\n      containers:\n      - name: nginx-nfs\n        image: nginx\n        volumeMounts:\n        - name: wwwroot\n          mountPath: /usr/share/nginx/html\n        ports:\n        - containerPort: 80\n      volumes:\n      - name: wwwroot\n        nfs:\n          server: 10.8.138.8\n          path: /opt/nfs/data\n```\n\n\n\n然后直接apply即可创建一个使用nfs类型volume的pod：\n\n```bash\nkubectl apply -f pod-nfs-volume.yaml\n```\n\n<img src=\"./pod-nfs.png\" style=\"zoom:70%;\" />\n\n\n\n然后可以将这个pod作为service暴露出来：\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx-nfs-svc\n  labels:\n    app: nginx-nfs-svc\nspec:\n  ports:\n  - port: 80\n    targetPort: 80\n  selector:\n    app: nginx-nfs\n```\n\n\n\n```bash\nkubectl apply -f pod-nfs-svc.yaml\n```\n\n<img src=\"./pod-nfs-svc.png\" style=\"zoom:70%;\" />\n\n\n\n验证访问的话，可以向nfs数据目录中放入一个html文件然后访问：\n\n<img src=\"./pod-nfs-test.png\" style=\"zoom:70%;\" />\n\n<br>\n\n\n\n\n\n# nfs类型的pv和pvc\n\n## 创建PV\n\n```yaml\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: nfs-pv\nspec:\n  capacity:\n    storage: 500Mi\n  accessModes:\n    - ReadWriteMany\n  persistentVolumeReclaimPolicy: Recycle\n  nfs:\n    path: /opt/nfs/data\n    server: 10.8.138.8\n```\n\n\n\n这里就创建了一个名为`nfs-pv`的pv，大小500Mi，其中指定了nfs的数据目录和nfs地址。\n\n- `accessModes`：pv访问模式，支持如下几个：\n  - `ReadWriteOnce`：读写挂载在一个节点上；\n  - `ReadOnlyMany`：只读挂载多个节点上；\n  - `ReadWriteMany`：读写挂载在多个节点上；\n- `persistentVolumeReclaimPolicy`：回收策略，支持以下几个：\n  - `Retain`：不作任何操作，需要手动删除（默认）\n  - `Recycle`：没有pvc使用时清空数据让其他pvc使用；\n  - `Delete`：删除；\n\n\n\n<img src=\"./pv.png\" style=\"zoom:50%;\" />\n\n\n\n> 可以看到pv目前是可用状态。\n\n\n\n\n\n## 创建PV\n\npod的直接消费对象为pvc而非pv，所以还需要创建pvc来绑定pv。\n\n```yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: pvc01\nspec:\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 500Mi\n```\n\n> 这里就创建了一个大小为500Mi，名字为`pvc01`的pvc请求。\n\n\n\npvc是自动绑定pv的，有如下两个原则：\n\n- 根据pvc申请的容量，采用最小配原则匹配到合适的pv并绑定；\n- 根据访问模式匹配，绑定pv和pvc访问模式一致的；\n\n\n\n<img src=\"./pvc.png\" style=\"zoom:50%;\" />\n\n> 可以看到pvc和pv都是绑定状态了。\n\n\n\n## 使用pvc\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-nfs\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx-nfs\n  template:\n    metadata:\n      labels:\n          app: nginx-nfs\n    spec:\n      containers:\n      - name: nginx-nfs\n        image: nginx\n        volumeMounts:\n        - name: wwwroot\n          mountPath: /usr/share/nginx/html\n        ports:\n        - containerPort: 80\n      volumes:\n      - name: wwwroot\n        persistentVolumeClaim:\n          claimName: pvc01\n```\n\n\n\n 使用pvc的时候，只需要在`volumes`定义的时候制定pvc名称即可。\n\n\n\n<img src=\"./pvc-nginx.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n# nfs类型的storageclass\n\n**nfs默认不支持storageclass，需要安装额外的插件**\n\n\n\n## 安装nfs-client插件\n\n{% tabs comments %}\n\n<!-- tab helm方式部署 -->\n\n```bash\nhelm install nfs-storageclass --set nfs.server=10.8.138.8 --set nfs.path=/opt/nfs/data --namespace default  stable/nfs-client-provisioner\n```\n\n\n\n![](./nfs-client.png)\n\n> 可以看到nfs-client服务已经创建，storageclass也已经创建了。\n\n<!-- endtab -->\n\n<!-- tab yaml方式部署 -->\n\n使用yaml文件方式安装，需要部署下面的三个yaml文件来安装nfs-client：\n\n```yaml\n# nfs-cluster-role.yaml\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    app: nfs-client-provisioner\n  name: nfs-client-provisioner-runner\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"persistentvolumes\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"delete\"]\n  - apiGroups: [\"\"]\n    resources: [\"persistentvolumeclaims\"]\n    verbs: [\"get\", \"list\", \"watch\", \"update\"]\n  - apiGroups: [\"storage.k8s.io\"]\n    resources: [\"storageclasses\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  - apiGroups: [\"\"]\n    resources: [\"events\"]\n    verbs: [\"create\", \"update\", \"patch\"]\n  - apiGroups: [\"\"]\n    resources: [\"endpoints\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]\n\n---\n\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    app: nfs-client-provisioner\n  name: run-nfs-client-provisioner\nsubjects:\n  - kind: ServiceAccount\n    name: nfs-client-provisioner \n    namespace: kube-system\nroleRef:\n  kind: ClusterRole\n  name: nfs-client-provisioner-runner \n  apiGroup: rbac.authorization.k8s.io \n\n---\n\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    app: nfs-client-provisioner\n  name: leader-locking-nfs-client-provisioner\n  namespace: kube-system\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"endpoints\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]\n\n---\n\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    app: nfs-client-provisioner\n  name: leader-locking-nfs-client-provisioner\nsubjects:\n  - kind: ServiceAccount\n    name: nfs-client-provisioner \n    namespace: kube-system\nroleRef:\n  kind: Role \n  name: leader-locking-nfs-client-provisioner\n  apiGroup: rbac.authorization.k8s.io\n```\n\n```yaml\n# nfs-deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nfs-client-provisioner\n  namespace: kube-system\n  labels:\n    app: nfs-client-provisioner\nspec:\n  replicas: 1\n  strategy:\n    type: Recreate\n  selector:\n    matchLabels:\n      app: nfs-client-provisioner\n  template:\n    metadata:\n      annotations:\n      labels:\n        app: nfs-client-provisioner\n    spec:\n      serviceAccountName: nfs-client-provisioner\n      containers:\n        - name: nfs-client-provisioner\n          image: \"quay.io/external_storage/nfs-client-provisioner:v3.1.0-k8s1.11\"\n          imagePullPolicy: IfNotPresent\n          volumeMounts:\n            - name: nfs-client-root\n              mountPath: /persistentvolumes\n          env:\n            - name: PROVISIONER_NAME\n              value: cluster.local/nfs-client-provisioner\n            - name: NFS_SERVER\n              value: 10.8.138.8\n            - name: NFS_PATH\n              value: /data/nfs-data\n      volumes:\n        - name: nfs-client-root\n          nfs:\n            server: 10.8.138.8 \n            path: /data/nfs-data\n```\n\n```yaml\n# nfs-service.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    app: nfs-client-provisioner \n  name: nfs-client-provisioner \n  namespace: kube-system\n```\n\n\n\n直接运行这三个文件即可：\n\n```bash\nkubectl apply -f nfs-cluster-role.yaml\nkubectl apply -f nfs-deployment.yaml\nkubectl apply -f nfs-service.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 创建storageclass\n\n使用类似下面的yaml文件可以创建其他的storageclass：\n\n```yaml\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: es-storageclass\n  labels:\n    app: nfs-client-provisioner\nprovisioner: cluster.local/nfs-client-provisioner\nallowVolumeExpansion: true\nreclaimPolicy: Retain\nparameters:\n  archiveOnDelete: \"true\"\n```\n\n\n\n## pvc使用storageclass\n\n```yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: testclaim\nspec:\n  storageClassName: \"nfs-client\"\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 100Mi\n```\n\n\n\n这里创建一个名为`testclaim`的100Mi的pvc，使用`nfs-client`这个storageclass。\n\n\n\n![](./storageclass-pvc.png)\n\n\n\n\n\n\n\n","source":"_posts/在k8s中使用nfs存储.md","raw":"---\ntitle: 在k8s中使用nfs存储\ndate: 2021-03-23 21:16:14\ntags:\n- NFS\ncategories:\n- Kubernetes\n- 存储\n- NFS\ndescription: 在k8s中使用nfs作为底层存储的三种姿势\ncover: https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=251466455,608736426&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用nfs作为存储，实现PV、PVC和storageclass\n\n更新于 2021-03-21\n\n{% endnote %}\n\n<br>\n\n\n\n# 安装NFS\n\n直接使用yum命令安装nfs：\n\n```bash\nyum install -y nfs-utils rpcbind\n```\n\n\n\n创建nfs目录：\n\n```bash\nmkdir -p /opt/nfs/data\necho \"/opt/nfs/data *(rw,no_root_squash)\" >> /etc/exports\n```\n\n> 生产上应该给该目录挂载一个数据盘\n\n\n\n启动nfs：\n\n```bash\nsystemctl start rpcbind\nsystemctl status rpcbind\nsystemctl enable rpcbind\nsystemctl start nfs \nsystemctl status nfs\nsystemctl enable nfs\n```\n\n\n\n在k8s的node和master节点上，都安装`nfs-utils`：\n\n```bash\nyum install -y nfs-utils\n```\n\n\n\n<br>\n\n\n\n# nfs类型的volume\n\n这种方式是直接在yaml中定义数据卷为nfs类型，示例如下：\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-nfs\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx-nfs\n  template:\n    metadata:\n      labels:\n          app: nginx-nfs\n    spec:\n      containers:\n      - name: nginx-nfs\n        image: nginx\n        volumeMounts:\n        - name: wwwroot\n          mountPath: /usr/share/nginx/html\n        ports:\n        - containerPort: 80\n      volumes:\n      - name: wwwroot\n        nfs:\n          server: 10.8.138.8\n          path: /opt/nfs/data\n```\n\n\n\n然后直接apply即可创建一个使用nfs类型volume的pod：\n\n```bash\nkubectl apply -f pod-nfs-volume.yaml\n```\n\n<img src=\"./pod-nfs.png\" style=\"zoom:70%;\" />\n\n\n\n然后可以将这个pod作为service暴露出来：\n\n```yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: nginx-nfs-svc\n  labels:\n    app: nginx-nfs-svc\nspec:\n  ports:\n  - port: 80\n    targetPort: 80\n  selector:\n    app: nginx-nfs\n```\n\n\n\n```bash\nkubectl apply -f pod-nfs-svc.yaml\n```\n\n<img src=\"./pod-nfs-svc.png\" style=\"zoom:70%;\" />\n\n\n\n验证访问的话，可以向nfs数据目录中放入一个html文件然后访问：\n\n<img src=\"./pod-nfs-test.png\" style=\"zoom:70%;\" />\n\n<br>\n\n\n\n\n\n# nfs类型的pv和pvc\n\n## 创建PV\n\n```yaml\napiVersion: v1\nkind: PersistentVolume\nmetadata:\n  name: nfs-pv\nspec:\n  capacity:\n    storage: 500Mi\n  accessModes:\n    - ReadWriteMany\n  persistentVolumeReclaimPolicy: Recycle\n  nfs:\n    path: /opt/nfs/data\n    server: 10.8.138.8\n```\n\n\n\n这里就创建了一个名为`nfs-pv`的pv，大小500Mi，其中指定了nfs的数据目录和nfs地址。\n\n- `accessModes`：pv访问模式，支持如下几个：\n  - `ReadWriteOnce`：读写挂载在一个节点上；\n  - `ReadOnlyMany`：只读挂载多个节点上；\n  - `ReadWriteMany`：读写挂载在多个节点上；\n- `persistentVolumeReclaimPolicy`：回收策略，支持以下几个：\n  - `Retain`：不作任何操作，需要手动删除（默认）\n  - `Recycle`：没有pvc使用时清空数据让其他pvc使用；\n  - `Delete`：删除；\n\n\n\n<img src=\"./pv.png\" style=\"zoom:50%;\" />\n\n\n\n> 可以看到pv目前是可用状态。\n\n\n\n\n\n## 创建PV\n\npod的直接消费对象为pvc而非pv，所以还需要创建pvc来绑定pv。\n\n```yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: pvc01\nspec:\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 500Mi\n```\n\n> 这里就创建了一个大小为500Mi，名字为`pvc01`的pvc请求。\n\n\n\npvc是自动绑定pv的，有如下两个原则：\n\n- 根据pvc申请的容量，采用最小配原则匹配到合适的pv并绑定；\n- 根据访问模式匹配，绑定pv和pvc访问模式一致的；\n\n\n\n<img src=\"./pvc.png\" style=\"zoom:50%;\" />\n\n> 可以看到pvc和pv都是绑定状态了。\n\n\n\n## 使用pvc\n\n```yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nginx-nfs\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: nginx-nfs\n  template:\n    metadata:\n      labels:\n          app: nginx-nfs\n    spec:\n      containers:\n      - name: nginx-nfs\n        image: nginx\n        volumeMounts:\n        - name: wwwroot\n          mountPath: /usr/share/nginx/html\n        ports:\n        - containerPort: 80\n      volumes:\n      - name: wwwroot\n        persistentVolumeClaim:\n          claimName: pvc01\n```\n\n\n\n 使用pvc的时候，只需要在`volumes`定义的时候制定pvc名称即可。\n\n\n\n<img src=\"./pvc-nginx.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n# nfs类型的storageclass\n\n**nfs默认不支持storageclass，需要安装额外的插件**\n\n\n\n## 安装nfs-client插件\n\n{% tabs comments %}\n\n<!-- tab helm方式部署 -->\n\n```bash\nhelm install nfs-storageclass --set nfs.server=10.8.138.8 --set nfs.path=/opt/nfs/data --namespace default  stable/nfs-client-provisioner\n```\n\n\n\n![](./nfs-client.png)\n\n> 可以看到nfs-client服务已经创建，storageclass也已经创建了。\n\n<!-- endtab -->\n\n<!-- tab yaml方式部署 -->\n\n使用yaml文件方式安装，需要部署下面的三个yaml文件来安装nfs-client：\n\n```yaml\n# nfs-cluster-role.yaml\nkind: ClusterRole\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    app: nfs-client-provisioner\n  name: nfs-client-provisioner-runner\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"persistentvolumes\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"delete\"]\n  - apiGroups: [\"\"]\n    resources: [\"persistentvolumeclaims\"]\n    verbs: [\"get\", \"list\", \"watch\", \"update\"]\n  - apiGroups: [\"storage.k8s.io\"]\n    resources: [\"storageclasses\"]\n    verbs: [\"get\", \"list\", \"watch\"]\n  - apiGroups: [\"\"]\n    resources: [\"events\"]\n    verbs: [\"create\", \"update\", \"patch\"]\n  - apiGroups: [\"\"]\n    resources: [\"endpoints\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]\n\n---\n\nkind: ClusterRoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    app: nfs-client-provisioner\n  name: run-nfs-client-provisioner\nsubjects:\n  - kind: ServiceAccount\n    name: nfs-client-provisioner \n    namespace: kube-system\nroleRef:\n  kind: ClusterRole\n  name: nfs-client-provisioner-runner \n  apiGroup: rbac.authorization.k8s.io \n\n---\n\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    app: nfs-client-provisioner\n  name: leader-locking-nfs-client-provisioner\n  namespace: kube-system\nrules:\n  - apiGroups: [\"\"]\n    resources: [\"endpoints\"]\n    verbs: [\"get\", \"list\", \"watch\", \"create\", \"update\", \"patch\"]\n\n---\n\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1\nmetadata:\n  labels:\n    app: nfs-client-provisioner\n  name: leader-locking-nfs-client-provisioner\nsubjects:\n  - kind: ServiceAccount\n    name: nfs-client-provisioner \n    namespace: kube-system\nroleRef:\n  kind: Role \n  name: leader-locking-nfs-client-provisioner\n  apiGroup: rbac.authorization.k8s.io\n```\n\n```yaml\n# nfs-deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: nfs-client-provisioner\n  namespace: kube-system\n  labels:\n    app: nfs-client-provisioner\nspec:\n  replicas: 1\n  strategy:\n    type: Recreate\n  selector:\n    matchLabels:\n      app: nfs-client-provisioner\n  template:\n    metadata:\n      annotations:\n      labels:\n        app: nfs-client-provisioner\n    spec:\n      serviceAccountName: nfs-client-provisioner\n      containers:\n        - name: nfs-client-provisioner\n          image: \"quay.io/external_storage/nfs-client-provisioner:v3.1.0-k8s1.11\"\n          imagePullPolicy: IfNotPresent\n          volumeMounts:\n            - name: nfs-client-root\n              mountPath: /persistentvolumes\n          env:\n            - name: PROVISIONER_NAME\n              value: cluster.local/nfs-client-provisioner\n            - name: NFS_SERVER\n              value: 10.8.138.8\n            - name: NFS_PATH\n              value: /data/nfs-data\n      volumes:\n        - name: nfs-client-root\n          nfs:\n            server: 10.8.138.8 \n            path: /data/nfs-data\n```\n\n```yaml\n# nfs-service.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  labels:\n    app: nfs-client-provisioner \n  name: nfs-client-provisioner \n  namespace: kube-system\n```\n\n\n\n直接运行这三个文件即可：\n\n```bash\nkubectl apply -f nfs-cluster-role.yaml\nkubectl apply -f nfs-deployment.yaml\nkubectl apply -f nfs-service.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 创建storageclass\n\n使用类似下面的yaml文件可以创建其他的storageclass：\n\n```yaml\napiVersion: storage.k8s.io/v1\nkind: StorageClass\nmetadata:\n  name: es-storageclass\n  labels:\n    app: nfs-client-provisioner\nprovisioner: cluster.local/nfs-client-provisioner\nallowVolumeExpansion: true\nreclaimPolicy: Retain\nparameters:\n  archiveOnDelete: \"true\"\n```\n\n\n\n## pvc使用storageclass\n\n```yaml\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: testclaim\nspec:\n  storageClassName: \"nfs-client\"\n  accessModes:\n    - ReadWriteMany\n  resources:\n    requests:\n      storage: 100Mi\n```\n\n\n\n这里创建一个名为`testclaim`的100Mi的pvc，使用`nfs-client`这个storageclass。\n\n\n\n![](./storageclass-pvc.png)\n\n\n\n\n\n\n\n","slug":"在k8s中使用nfs存储","published":1,"updated":"2021-03-23T13:34:50.484Z","_id":"ckmm1mich0000tpkldiecb3rx","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用nfs作为存储，实现PV、PVC和storageclass</p><p>更新于 2021-03-21</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"安装NFS\"><a href=\"#安装NFS\" class=\"headerlink\" title=\"安装NFS\"></a>安装NFS</h1><p>直接使用yum命令安装nfs：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils rpcbind</span><br></pre></td></tr></table></figure>\n\n\n\n<p>创建nfs目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /opt/nfs/data</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/opt/nfs/data *(rw,no_root_squash)&quot;</span> &gt;&gt; /etc/exports</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>生产上应该给该目录挂载一个数据盘</p>\n</blockquote>\n<p>启动nfs：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl status rpcbind</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind</span><br><span class=\"line\">systemctl start nfs </span><br><span class=\"line\">systemctl status nfs</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs</span><br></pre></td></tr></table></figure>\n\n\n\n<p>在k8s的node和master节点上，都安装<code>nfs-utils</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"nfs类型的volume\"><a href=\"#nfs类型的volume\" class=\"headerlink\" title=\"nfs类型的volume\"></a>nfs类型的volume</h1><p>这种方式是直接在yaml中定义数据卷为nfs类型，示例如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">          <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wwwroot</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wwwroot</span></span><br><span class=\"line\">        <span class=\"attr\">nfs:</span></span><br><span class=\"line\">          <span class=\"attr\">server:</span> <span class=\"number\">10.8</span><span class=\"number\">.138</span><span class=\"number\">.8</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/opt/nfs/data</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后直接apply即可创建一个使用nfs类型volume的pod：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f pod-nfs-volume.yaml</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./pod-nfs.png\" style=\"zoom:70%;\" />\n\n\n\n<p>然后可以将这个pod作为service暴露出来：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs-svc</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f pod-nfs-svc.yaml</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./pod-nfs-svc.png\" style=\"zoom:70%;\" />\n\n\n\n<p>验证访问的话，可以向nfs数据目录中放入一个html文件然后访问：</p>\n<img src= \"/img/loading.gif\" data-src=\"./pod-nfs-test.png\" style=\"zoom:70%;\" />\n\n<br>\n\n\n\n\n\n<h1 id=\"nfs类型的pv和pvc\"><a href=\"#nfs类型的pv和pvc\" class=\"headerlink\" title=\"nfs类型的pv和pvc\"></a>nfs类型的pv和pvc</h1><h2 id=\"创建PV\"><a href=\"#创建PV\" class=\"headerlink\" title=\"创建PV\"></a>创建PV</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-pv</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">persistentVolumeReclaimPolicy:</span> <span class=\"string\">Recycle</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/opt/nfs/data</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">10.8</span><span class=\"number\">.138</span><span class=\"number\">.8</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>这里就创建了一个名为<code>nfs-pv</code>的pv，大小500Mi，其中指定了nfs的数据目录和nfs地址。</p>\n<ul>\n<li><code>accessModes</code>：pv访问模式，支持如下几个：<ul>\n<li><code>ReadWriteOnce</code>：读写挂载在一个节点上；</li>\n<li><code>ReadOnlyMany</code>：只读挂载多个节点上；</li>\n<li><code>ReadWriteMany</code>：读写挂载在多个节点上；</li>\n</ul>\n</li>\n<li><code>persistentVolumeReclaimPolicy</code>：回收策略，支持以下几个：<ul>\n<li><code>Retain</code>：不作任何操作，需要手动删除（默认）</li>\n<li><code>Recycle</code>：没有pvc使用时清空数据让其他pvc使用；</li>\n<li><code>Delete</code>：删除；</li>\n</ul>\n</li>\n</ul>\n<img src= \"/img/loading.gif\" data-src=\"./pv.png\" style=\"zoom:50%;\" />\n\n\n\n<blockquote>\n<p>可以看到pv目前是可用状态。</p>\n</blockquote>\n<h2 id=\"创建PV-1\"><a href=\"#创建PV-1\" class=\"headerlink\" title=\"创建PV\"></a>创建PV</h2><p>pod的直接消费对象为pvc而非pv，所以还需要创建pvc来绑定pv。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pvc01</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">500Mi</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里就创建了一个大小为500Mi，名字为<code>pvc01</code>的pvc请求。</p>\n</blockquote>\n<p>pvc是自动绑定pv的，有如下两个原则：</p>\n<ul>\n<li>根据pvc申请的容量，采用最小配原则匹配到合适的pv并绑定；</li>\n<li>根据访问模式匹配，绑定pv和pvc访问模式一致的；</li>\n</ul>\n<img src= \"/img/loading.gif\" data-src=\"./pvc.png\" style=\"zoom:50%;\" />\n\n<blockquote>\n<p>可以看到pvc和pv都是绑定状态了。</p>\n</blockquote>\n<h2 id=\"使用pvc\"><a href=\"#使用pvc\" class=\"headerlink\" title=\"使用pvc\"></a>使用pvc</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">          <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wwwroot</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wwwroot</span></span><br><span class=\"line\">        <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">          <span class=\"attr\">claimName:</span> <span class=\"string\">pvc01</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p> 使用pvc的时候，只需要在<code>volumes</code>定义的时候制定pvc名称即可。</p>\n<img src= \"/img/loading.gif\" data-src=\"./pvc-nginx.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"nfs类型的storageclass\"><a href=\"#nfs类型的storageclass\" class=\"headerlink\" title=\"nfs类型的storageclass\"></a>nfs类型的storageclass</h1><p><strong>nfs默认不支持storageclass，需要安装额外的插件</strong></p>\n<h2 id=\"安装nfs-client插件\"><a href=\"#安装nfs-client插件\" class=\"headerlink\" title=\"安装nfs-client插件\"></a>安装nfs-client插件</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">helm方式部署</button></li><li class=\"tab\"><button data-href=\"#comments-2\">yaml方式部署</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm install nfs-storageclass --<span class=\"built_in\">set</span> nfs.server=10.8.138.8 --<span class=\"built_in\">set</span> nfs.path=/opt/nfs/data --namespace default  stable/nfs-client-provisioner</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src= \"/img/loading.gif\" data-src=\"./nfs-client.png\" alt=\"\"></p>\n<blockquote>\n<p>可以看到nfs-client服务已经创建，storageclass也已经创建了。</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>使用yaml文件方式安装，需要部署下面的三个yaml文件来安装nfs-client：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nfs-cluster-role.yaml</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner-runner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumes&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;update&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;storage.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;storageclasses&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;events&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">run-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span> </span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner-runner</span> </span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span> </span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span> </span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nfs-deployment.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&quot;quay.io/external_storage/nfs-client-provisioner:v3.1.0-k8s1.11&quot;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">              <span class=\"attr\">mountPath:</span> <span class=\"string\">/persistentvolumes</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PROVISIONER_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">cluster.local/nfs-client-provisioner</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_SERVER</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"number\">10.8</span><span class=\"number\">.138</span><span class=\"number\">.8</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_PATH</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">/data/nfs-data</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">          <span class=\"attr\">nfs:</span></span><br><span class=\"line\">            <span class=\"attr\">server:</span> <span class=\"number\">10.8</span><span class=\"number\">.138</span><span class=\"number\">.8</span> </span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/data/nfs-data</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nfs-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span> </span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span> </span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>直接运行这三个文件即可：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f nfs-cluster-role.yaml</span><br><span class=\"line\">kubectl apply -f nfs-deployment.yaml</span><br><span class=\"line\">kubectl apply -f nfs-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"创建storageclass\"><a href=\"#创建storageclass\" class=\"headerlink\" title=\"创建storageclass\"></a>创建storageclass</h2><p>使用类似下面的yaml文件可以创建其他的storageclass：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">storage.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StorageClass</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-storageclass</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">provisioner:</span> <span class=\"string\">cluster.local/nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">allowVolumeExpansion:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">reclaimPolicy:</span> <span class=\"string\">Retain</span></span><br><span class=\"line\"><span class=\"attr\">parameters:</span></span><br><span class=\"line\">  <span class=\"attr\">archiveOnDelete:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"pvc使用storageclass\"><a href=\"#pvc使用storageclass\" class=\"headerlink\" title=\"pvc使用storageclass\"></a>pvc使用storageclass</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">testclaim</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">&quot;nfs-client&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">100Mi</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>这里创建一个名为<code>testclaim</code>的100Mi的pvc，使用<code>nfs-client</code>这个storageclass。</p>\n<p><img src= \"/img/loading.gif\" data-src=\"./storageclass-pvc.png\" alt=\"\"></p>\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用nfs作为存储，实现PV、PVC和storageclass</p><p>更新于 2021-03-21</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"安装NFS\"><a href=\"#安装NFS\" class=\"headerlink\" title=\"安装NFS\"></a>安装NFS</h1><p>直接使用yum命令安装nfs：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils rpcbind</span><br></pre></td></tr></table></figure>\n\n\n\n<p>创建nfs目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /opt/nfs/data</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/opt/nfs/data *(rw,no_root_squash)&quot;</span> &gt;&gt; /etc/exports</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>生产上应该给该目录挂载一个数据盘</p>\n</blockquote>\n<p>启动nfs：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl status rpcbind</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind</span><br><span class=\"line\">systemctl start nfs </span><br><span class=\"line\">systemctl status nfs</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs</span><br></pre></td></tr></table></figure>\n\n\n\n<p>在k8s的node和master节点上，都安装<code>nfs-utils</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"nfs类型的volume\"><a href=\"#nfs类型的volume\" class=\"headerlink\" title=\"nfs类型的volume\"></a>nfs类型的volume</h1><p>这种方式是直接在yaml中定义数据卷为nfs类型，示例如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">          <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wwwroot</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wwwroot</span></span><br><span class=\"line\">        <span class=\"attr\">nfs:</span></span><br><span class=\"line\">          <span class=\"attr\">server:</span> <span class=\"number\">10.8</span><span class=\"number\">.138</span><span class=\"number\">.8</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/opt/nfs/data</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后直接apply即可创建一个使用nfs类型volume的pod：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f pod-nfs-volume.yaml</span><br></pre></td></tr></table></figure>\n\n<img src=\"./pod-nfs.png\" style=\"zoom:70%;\" />\n\n\n\n<p>然后可以将这个pod作为service暴露出来：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs-svc</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f pod-nfs-svc.yaml</span><br></pre></td></tr></table></figure>\n\n<img src=\"./pod-nfs-svc.png\" style=\"zoom:70%;\" />\n\n\n\n<p>验证访问的话，可以向nfs数据目录中放入一个html文件然后访问：</p>\n<img src=\"./pod-nfs-test.png\" style=\"zoom:70%;\" />\n\n<br>\n\n\n\n\n\n<h1 id=\"nfs类型的pv和pvc\"><a href=\"#nfs类型的pv和pvc\" class=\"headerlink\" title=\"nfs类型的pv和pvc\"></a>nfs类型的pv和pvc</h1><h2 id=\"创建PV\"><a href=\"#创建PV\" class=\"headerlink\" title=\"创建PV\"></a>创建PV</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-pv</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">persistentVolumeReclaimPolicy:</span> <span class=\"string\">Recycle</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/opt/nfs/data</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">10.8</span><span class=\"number\">.138</span><span class=\"number\">.8</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>这里就创建了一个名为<code>nfs-pv</code>的pv，大小500Mi，其中指定了nfs的数据目录和nfs地址。</p>\n<ul>\n<li><code>accessModes</code>：pv访问模式，支持如下几个：<ul>\n<li><code>ReadWriteOnce</code>：读写挂载在一个节点上；</li>\n<li><code>ReadOnlyMany</code>：只读挂载多个节点上；</li>\n<li><code>ReadWriteMany</code>：读写挂载在多个节点上；</li>\n</ul>\n</li>\n<li><code>persistentVolumeReclaimPolicy</code>：回收策略，支持以下几个：<ul>\n<li><code>Retain</code>：不作任何操作，需要手动删除（默认）</li>\n<li><code>Recycle</code>：没有pvc使用时清空数据让其他pvc使用；</li>\n<li><code>Delete</code>：删除；</li>\n</ul>\n</li>\n</ul>\n<img src=\"./pv.png\" style=\"zoom:50%;\" />\n\n\n\n<blockquote>\n<p>可以看到pv目前是可用状态。</p>\n</blockquote>\n<h2 id=\"创建PV-1\"><a href=\"#创建PV-1\" class=\"headerlink\" title=\"创建PV\"></a>创建PV</h2><p>pod的直接消费对象为pvc而非pv，所以还需要创建pvc来绑定pv。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pvc01</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">500Mi</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里就创建了一个大小为500Mi，名字为<code>pvc01</code>的pvc请求。</p>\n</blockquote>\n<p>pvc是自动绑定pv的，有如下两个原则：</p>\n<ul>\n<li>根据pvc申请的容量，采用最小配原则匹配到合适的pv并绑定；</li>\n<li>根据访问模式匹配，绑定pv和pvc访问模式一致的；</li>\n</ul>\n<img src=\"./pvc.png\" style=\"zoom:50%;\" />\n\n<blockquote>\n<p>可以看到pvc和pv都是绑定状态了。</p>\n</blockquote>\n<h2 id=\"使用pvc\"><a href=\"#使用pvc\" class=\"headerlink\" title=\"使用pvc\"></a>使用pvc</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">          <span class=\"attr\">app:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-nfs</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wwwroot</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wwwroot</span></span><br><span class=\"line\">        <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">          <span class=\"attr\">claimName:</span> <span class=\"string\">pvc01</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p> 使用pvc的时候，只需要在<code>volumes</code>定义的时候制定pvc名称即可。</p>\n<img src=\"./pvc-nginx.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"nfs类型的storageclass\"><a href=\"#nfs类型的storageclass\" class=\"headerlink\" title=\"nfs类型的storageclass\"></a>nfs类型的storageclass</h1><p><strong>nfs默认不支持storageclass，需要安装额外的插件</strong></p>\n<h2 id=\"安装nfs-client插件\"><a href=\"#安装nfs-client插件\" class=\"headerlink\" title=\"安装nfs-client插件\"></a>安装nfs-client插件</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">helm方式部署</button></li><li class=\"tab\"><button data-href=\"#comments-2\">yaml方式部署</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm install nfs-storageclass --<span class=\"built_in\">set</span> nfs.server=10.8.138.8 --<span class=\"built_in\">set</span> nfs.path=/opt/nfs/data --namespace default  stable/nfs-client-provisioner</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"./nfs-client.png\" alt=\"\"></p>\n<blockquote>\n<p>可以看到nfs-client服务已经创建，storageclass也已经创建了。</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>使用yaml文件方式安装，需要部署下面的三个yaml文件来安装nfs-client：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nfs-cluster-role.yaml</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner-runner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumes&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;update&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;storage.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;storageclasses&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;events&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">run-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span> </span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner-runner</span> </span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span> </span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span> </span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nfs-deployment.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">annotations:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&quot;quay.io/external_storage/nfs-client-provisioner:v3.1.0-k8s1.11&quot;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">              <span class=\"attr\">mountPath:</span> <span class=\"string\">/persistentvolumes</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PROVISIONER_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">cluster.local/nfs-client-provisioner</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_SERVER</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"number\">10.8</span><span class=\"number\">.138</span><span class=\"number\">.8</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_PATH</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">/data/nfs-data</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">          <span class=\"attr\">nfs:</span></span><br><span class=\"line\">            <span class=\"attr\">server:</span> <span class=\"number\">10.8</span><span class=\"number\">.138</span><span class=\"number\">.8</span> </span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/data/nfs-data</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># nfs-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span> </span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span> </span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>直接运行这三个文件即可：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f nfs-cluster-role.yaml</span><br><span class=\"line\">kubectl apply -f nfs-deployment.yaml</span><br><span class=\"line\">kubectl apply -f nfs-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"创建storageclass\"><a href=\"#创建storageclass\" class=\"headerlink\" title=\"创建storageclass\"></a>创建storageclass</h2><p>使用类似下面的yaml文件可以创建其他的storageclass：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">storage.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StorageClass</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-storageclass</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">provisioner:</span> <span class=\"string\">cluster.local/nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">allowVolumeExpansion:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">reclaimPolicy:</span> <span class=\"string\">Retain</span></span><br><span class=\"line\"><span class=\"attr\">parameters:</span></span><br><span class=\"line\">  <span class=\"attr\">archiveOnDelete:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"pvc使用storageclass\"><a href=\"#pvc使用storageclass\" class=\"headerlink\" title=\"pvc使用storageclass\"></a>pvc使用storageclass</h2><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">testclaim</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">&quot;nfs-client&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">100Mi</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>这里创建一个名为<code>testclaim</code>的100Mi的pvc，使用<code>nfs-client</code>这个storageclass。</p>\n<p><img src=\"./storageclass-pvc.png\" alt=\"\"></p>\n"},{"title":"部署nfs存储","date":"2021-03-23T13:38:44.000Z","description":"在Linux服务器上部署NFS存储","cover":"https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=773960014,3839457367&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了什么是NFS存储并且在linux服务器上部署nfs服务\n\n更新于 2021-03-21\n\n{% endnote %}\n\n<br>\n\n\n\n# NFS介绍\n\nNFS是`Network File System`的缩写，即网络文件系统。功能是通过网络让不同的机器、不同的操作系统能够彼此分享文件，让应用程序在客户端通过网络访问位于服务器磁盘中的数据，是在类Unix系统间实现磁盘文件共享的一种方法。\n\n\n\nNFS使用RPC协议进行通信，NFS可以看作是一个RPC Server，主要功能是管理需要分享的目录和文件，它不负责通信和信息传输，而是把这部分工作交给RPC协议来完成。即NFS在文件传送或信息传送过程中依赖于RPC协议。所以只要用到NFS的地方都要启动RPC服务，不论是NFS SERVER或者NFS CLIENT。这样SERVER和CLIENT才能通过RPC来实现PROGRAM PORT的对应。\n\n\n\n>  可以这么理解RPC和NFS的关系：NFS是一个文件系统，而RPC是负责负责信息的传输。\n\n\n\n<br>\n\n\n\n# 部署NFS\n\nNFS依赖于`nfs-utils`和`rpcbind`，所以先安装这两个软件包：\n\n```bash\nyum install -y nfs-utils rpcbind\n```\n\n\n\n创建nfs数据目录：\n\n```bash\nmkdir /nfs-data\n```\n\n> 一般这个目录会挂载一个数据盘\n\n\n\nNFS共享存储需要将存储的地址配置在`/etc/exporters`下，例如这里配置为：\n\n```bash\n/nfs-data *(rw,no_root_squash)\n```\n\n> 星号表示允许所有客户端访问，支持对客户端IP地址和网段进行限制\n\n\n\n其中支持的参数为：\n\n- `ro`：只读；\n- `rw`：读写；\n- `root_squash`：当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户；\n- `no_root_squash`：当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员；\n- `all_squash`：无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户；\n- `sync`：同时将数据写入到内存与硬盘中，保证不丢失数据；\n- `async`：优先将数据写入到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据；\n\n\n\n启动服务：\n\n```bash\nsystemctl start rpcbind\nsystemctl enable rpcbind\nsystemctl start nfs-server\nsystemctl enable nfs-server\n```\n\n\n\n其他客户端想要使用nfs存储，则首先需要安装`nfs-utils`，然后可以使用下面的命令将nfs的目录挂载到本地：\n\n```bash\nyum install -y nfs-utils\nmount -t nfs <nfs服务器地址>:/nfs-data /nfsdata\n```\n\n","source":"_posts/部署nfs存储.md","raw":"---\ntitle: 部署nfs存储\ndate: 2021-03-23 21:38:44\ntags:\n- NFS\ncategories:\n- 存储\n- NFS\n- 部署\ndescription: 在Linux服务器上部署NFS存储\ncover: https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=773960014,3839457367&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了什么是NFS存储并且在linux服务器上部署nfs服务\n\n更新于 2021-03-21\n\n{% endnote %}\n\n<br>\n\n\n\n# NFS介绍\n\nNFS是`Network File System`的缩写，即网络文件系统。功能是通过网络让不同的机器、不同的操作系统能够彼此分享文件，让应用程序在客户端通过网络访问位于服务器磁盘中的数据，是在类Unix系统间实现磁盘文件共享的一种方法。\n\n\n\nNFS使用RPC协议进行通信，NFS可以看作是一个RPC Server，主要功能是管理需要分享的目录和文件，它不负责通信和信息传输，而是把这部分工作交给RPC协议来完成。即NFS在文件传送或信息传送过程中依赖于RPC协议。所以只要用到NFS的地方都要启动RPC服务，不论是NFS SERVER或者NFS CLIENT。这样SERVER和CLIENT才能通过RPC来实现PROGRAM PORT的对应。\n\n\n\n>  可以这么理解RPC和NFS的关系：NFS是一个文件系统，而RPC是负责负责信息的传输。\n\n\n\n<br>\n\n\n\n# 部署NFS\n\nNFS依赖于`nfs-utils`和`rpcbind`，所以先安装这两个软件包：\n\n```bash\nyum install -y nfs-utils rpcbind\n```\n\n\n\n创建nfs数据目录：\n\n```bash\nmkdir /nfs-data\n```\n\n> 一般这个目录会挂载一个数据盘\n\n\n\nNFS共享存储需要将存储的地址配置在`/etc/exporters`下，例如这里配置为：\n\n```bash\n/nfs-data *(rw,no_root_squash)\n```\n\n> 星号表示允许所有客户端访问，支持对客户端IP地址和网段进行限制\n\n\n\n其中支持的参数为：\n\n- `ro`：只读；\n- `rw`：读写；\n- `root_squash`：当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户；\n- `no_root_squash`：当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员；\n- `all_squash`：无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户；\n- `sync`：同时将数据写入到内存与硬盘中，保证不丢失数据；\n- `async`：优先将数据写入到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据；\n\n\n\n启动服务：\n\n```bash\nsystemctl start rpcbind\nsystemctl enable rpcbind\nsystemctl start nfs-server\nsystemctl enable nfs-server\n```\n\n\n\n其他客户端想要使用nfs存储，则首先需要安装`nfs-utils`，然后可以使用下面的命令将nfs的目录挂载到本地：\n\n```bash\nyum install -y nfs-utils\nmount -t nfs <nfs服务器地址>:/nfs-data /nfsdata\n```\n\n","slug":"部署nfs存储","published":1,"updated":"2021-03-23T13:43:52.510Z","_id":"ckmm2hjl700006lkl3s4h67o2","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了什么是NFS存储并且在linux服务器上部署nfs服务</p><p>更新于 2021-03-21</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"NFS介绍\"><a href=\"#NFS介绍\" class=\"headerlink\" title=\"NFS介绍\"></a>NFS介绍</h1><p>NFS是<code>Network File System</code>的缩写，即网络文件系统。功能是通过网络让不同的机器、不同的操作系统能够彼此分享文件，让应用程序在客户端通过网络访问位于服务器磁盘中的数据，是在类Unix系统间实现磁盘文件共享的一种方法。</p>\n<p>NFS使用RPC协议进行通信，NFS可以看作是一个RPC Server，主要功能是管理需要分享的目录和文件，它不负责通信和信息传输，而是把这部分工作交给RPC协议来完成。即NFS在文件传送或信息传送过程中依赖于RPC协议。所以只要用到NFS的地方都要启动RPC服务，不论是NFS SERVER或者NFS CLIENT。这样SERVER和CLIENT才能通过RPC来实现PROGRAM PORT的对应。</p>\n<blockquote>\n<p> 可以这么理解RPC和NFS的关系：NFS是一个文件系统，而RPC是负责负责信息的传输。</p>\n</blockquote>\n<br>\n\n\n\n<h1 id=\"部署NFS\"><a href=\"#部署NFS\" class=\"headerlink\" title=\"部署NFS\"></a>部署NFS</h1><p>NFS依赖于<code>nfs-utils</code>和<code>rpcbind</code>，所以先安装这两个软件包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils rpcbind</span><br></pre></td></tr></table></figure>\n\n\n\n<p>创建nfs数据目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /nfs-data</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>一般这个目录会挂载一个数据盘</p>\n</blockquote>\n<p>NFS共享存储需要将存储的地址配置在<code>/etc/exporters</code>下，例如这里配置为：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/nfs-data *(rw,no_root_squash)</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>星号表示允许所有客户端访问，支持对客户端IP地址和网段进行限制</p>\n</blockquote>\n<p>其中支持的参数为：</p>\n<ul>\n<li><code>ro</code>：只读；</li>\n<li><code>rw</code>：读写；</li>\n<li><code>root_squash</code>：当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户；</li>\n<li><code>no_root_squash</code>：当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员；</li>\n<li><code>all_squash</code>：无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户；</li>\n<li><code>sync</code>：同时将数据写入到内存与硬盘中，保证不丢失数据；</li>\n<li><code>async</code>：优先将数据写入到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据；</li>\n</ul>\n<p>启动服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind</span><br><span class=\"line\">systemctl start nfs-server</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs-server</span><br></pre></td></tr></table></figure>\n\n\n\n<p>其他客户端想要使用nfs存储，则首先需要安装<code>nfs-utils</code>，然后可以使用下面的命令将nfs的目录挂载到本地：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils</span><br><span class=\"line\">mount -t nfs &lt;nfs服务器地址&gt;:/nfs-data /nfsdata</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了什么是NFS存储并且在linux服务器上部署nfs服务</p><p>更新于 2021-03-21</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"NFS介绍\"><a href=\"#NFS介绍\" class=\"headerlink\" title=\"NFS介绍\"></a>NFS介绍</h1><p>NFS是<code>Network File System</code>的缩写，即网络文件系统。功能是通过网络让不同的机器、不同的操作系统能够彼此分享文件，让应用程序在客户端通过网络访问位于服务器磁盘中的数据，是在类Unix系统间实现磁盘文件共享的一种方法。</p>\n<p>NFS使用RPC协议进行通信，NFS可以看作是一个RPC Server，主要功能是管理需要分享的目录和文件，它不负责通信和信息传输，而是把这部分工作交给RPC协议来完成。即NFS在文件传送或信息传送过程中依赖于RPC协议。所以只要用到NFS的地方都要启动RPC服务，不论是NFS SERVER或者NFS CLIENT。这样SERVER和CLIENT才能通过RPC来实现PROGRAM PORT的对应。</p>\n<blockquote>\n<p> 可以这么理解RPC和NFS的关系：NFS是一个文件系统，而RPC是负责负责信息的传输。</p>\n</blockquote>\n<br>\n\n\n\n<h1 id=\"部署NFS\"><a href=\"#部署NFS\" class=\"headerlink\" title=\"部署NFS\"></a>部署NFS</h1><p>NFS依赖于<code>nfs-utils</code>和<code>rpcbind</code>，所以先安装这两个软件包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils rpcbind</span><br></pre></td></tr></table></figure>\n\n\n\n<p>创建nfs数据目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /nfs-data</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>一般这个目录会挂载一个数据盘</p>\n</blockquote>\n<p>NFS共享存储需要将存储的地址配置在<code>/etc/exporters</code>下，例如这里配置为：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/nfs-data *(rw,no_root_squash)</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>星号表示允许所有客户端访问，支持对客户端IP地址和网段进行限制</p>\n</blockquote>\n<p>其中支持的参数为：</p>\n<ul>\n<li><code>ro</code>：只读；</li>\n<li><code>rw</code>：读写；</li>\n<li><code>root_squash</code>：当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户；</li>\n<li><code>no_root_squash</code>：当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员；</li>\n<li><code>all_squash</code>：无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户；</li>\n<li><code>sync</code>：同时将数据写入到内存与硬盘中，保证不丢失数据；</li>\n<li><code>async</code>：优先将数据写入到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据；</li>\n</ul>\n<p>启动服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind</span><br><span class=\"line\">systemctl start nfs-server</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs-server</span><br></pre></td></tr></table></figure>\n\n\n\n<p>其他客户端想要使用nfs存储，则首先需要安装<code>nfs-utils</code>，然后可以使用下面的命令将nfs的目录挂载到本地：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils</span><br><span class=\"line\">mount -t nfs &lt;nfs服务器地址&gt;:/nfs-data /nfsdata</span><br></pre></td></tr></table></figure>\n\n"},{"title":"在k8s中使用EFLK进行日志收集","date":"2021-03-27T04:31:50.000Z","description":"在kubernetes中使用ELFK进行日志收集和展示","cover":"https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用filebeat、kafka、logstash、elasticsearch、kibana进行日志收集\n\n更新于 2021-03-27\n\n{% endnote %}\n\n<br>\n\n\n\n# 架构方案\n\n## 架构\n\n整体收集方案使用如下的组件：\n\n- `filebeat`：采集节点和容器日志，发送到kafka；\n- `kafka`：接收filebeat发送的日志消息；\n- `logstash`：从kafka中消费日志消息并进行处理；\n- `elasticsearch`：进行日志存储；\n- `kibana`：日志可视化展示；\n\n\n\n> 日志文件 --> filebeat --> kafka --> logstash --> elasticsearch --> kibana\n\n\n\n## 版本选择\n\n- `filebeat`：7.6.2；\n- `kafka`：2.12-2.5.0；\n- `zookeeper`：3.5.7；\n- `logstash`：7.8.0；\n- `elasticsearch`：7.8.0；\n- `kibana`：7.8.0；\n\n\n\n## 方案可能存在的问题\n\n这套日志收集方案可能存在下面的问题：\n\n- elasticsearch可能存在瓶颈（es还需要进一步调优）；\n- logstash会根据写入es的速度调整消息消费的速度，所有kafka有时候会出现消息堆积的情况；\n- ......\n\n\n\n<br>\n\n\n\n# 准备工作\n\n{% tabs comments %}\n\n<!-- tab 准备nfs相关资源 -->\n\n这里使用nfs作为底层存储，相关的创建方法可以参考：{% post_link 在k8s中使用nfs存储 %}，当然也可以使用其他的存储系统。\n\n<!-- endtab -->\n\n<!-- tab 创建namespace -->\n\n使用下面的yaml文件创建一个namespace：\n\n```yaml\n# namesapce.yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: logging\n```\n\n\n\n```bash\nkubectl apply -f namespace.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 设置elasticsearch密码 -->\n\nelasticsearch开启x-pack认证功能，这里将elasticsearch的密码保存在secret资源中：\n\n```bash\nespassword=\"elastic\"\n\nkubectl create secret generic es-logging-password --from-literal=elastic='elastic' -n logging\n```\n\n\n\n> 这里讲elasticsearch密码设置为：`elastic`\n\n<!-- endtab -->\n\n\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署elasticsearch\n\n## 部署相关资源\n\n{% tabs comments %}\n\n<!-- tab 创建elasticsearch配置 -->\n\n```yaml\n# elasticsearch-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: es-logging-config\n  namespace: logging\ndata:\n  elasticsearch.yml: |\n    cluster.name: es-logging-cluster\n    node.name: ${NODE_NAME}\n    network.host: 0.0.0.0\n    http.port: 9200\n    transport.port: 9300\n    discovery.seed_hosts: [\"es-logging-cluster\"]\n    cluster.initial_master_nodes:\n      - es-logging-0\n      - es-logging-1\n      - es-logging-2\n    xpack.monitoring.collection.enabled: true\n    xpack.security.enabled: true\n    xpack.license.self_generated.type: basic\n    indices.lifecycle.history_index_enabled: false\n    xpack.ilm.enabled: true\n    \n    cluster.routing.allocation.disk.threshold_enabled: false\n\n    # xpack.security.transport.ssl.enabled: true\n    # xpack.security.transport.ssl.verification_mode: certificate\n    # xpack.security.transport.ssl.key: certs/es-logging-service.key\n    # xpack.security.transport.ssl.certificate: certs/es-logging-service.crt\n    # xpack.security.transport.ssl.certificate_authorities: certs/ca.crt\n    # xpack.security.http.ssl.enabled: false\n    # xpack.security.authc.realms:\n    #   native.realm1:\n    #     order: 0\n  es_check.sh: >\n    #!/bin/bash\n\n    ES_REST_BASEURL=http://localhost:9200\n\n    EXPECTED_RESPONSE_CODE=200\n\n    max_time=${READINESS_PROBE_TIMEOUT:-30}\n\n\n    function check_if_ready() {\n      path=\"$1\"\n      err_msg=\"$2\"\n      response_code=$(curl -s -k --head \\\n          -u elastic:${ELASTIC_PASSWORD} \\\n          --max-time $max_time \\\n          -o /dev/null \\\n          -w '%{response_code}' \\\n          \"${ES_REST_BASEURL}${path}\")\n\n      if [ \"${response_code}\" != ${EXPECTED_RESPONSE_CODE} ]; then\n        echo \"${err_msg} [response code: ${response_code}]\"\n        exit 1\n      fi\n      exit 0\n    }\n\n\n    check_if_ready \"/\" \"Elasticsearch node is not ready to accept HTTP requests yet\"\n```\n\n\n\n配置中的相关参数解释：\n\n- `cluster.name`：设置es集群名称，用于唯一标识一个集群；\n- `network.host`：监听的地址；\n- `discovery.seed_hosts`：节点发现方式；\n- `xpack.security.enabled`起用xpack安全组件；\n- `cluster.routing.allocation.disk.threshold_enabled`是否启动磁盘分配器；\n\n> `cluster.routing.allocation.disk.threshold_enabled`这个参数这里设置为false，表示关闭磁盘分配器，这样es可以使用全部磁盘空间。默认情况下当磁盘空间大于85%后，es就不能再创建分片了。这个参数在es使用同一个后端存储的时候应该调节一下。[相关文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#disk-based-shard-allocation)\n\n\n\nes启用了x-pack密码认证，并且通过脚本检查es是否正常启动。我这里将es https通信方式注释掉了，如果有需要可以生成相关证书并起用https配置。直接运行下面的命令创建es配置：\n\n```bash\nkubectl apply -f elasticsearch-config.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建elasticsearch集群 -->\n\n使用下面的yaml文件创建一个namespace：\n\n```yaml\n# elasticsearch-cluster.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app: es-logging\n  name: es-logging\n  namespace: logging\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: es-logging\n  serviceName: es-logging-cluster\n  template:\n    metadata:\n      labels:\n        app: es-logging\n      name: es-logging\n    spec:\n    #   affinity:\n    #     podAntiAffinity:\n    #       requiredDuringSchedulingIgnoredDuringExecution:\n    #         - labelSelector:\n    #             matchExpressions:\n    #               - key: app\n    #                 operator: In\n    #                 values:\n    #                   - es-logging\n    #           topologyKey: kubernetes.io/hostname\n      containers:\n        - env:\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: POD_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.podIP\n            - name: ES_JAVA_OPTS\n              value: '-Xms2g -Xmx2g'\n            - name: TZ\n              value: Asia/Shanghai\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'docker.elastic.co/elasticsearch/elasticsearch:7.8.0'\n          imagePullPolicy: IfNotPresent\n          livenessProbe:\n            exec:\n              command:\n                - sh\n                - '-c'\n                - /usr/share/elasticsearch/config/es_check.sh\n            failureThreshold: 3\n            initialDelaySeconds: 60\n            periodSeconds: 20\n            successThreshold: 1\n            timeoutSeconds: 1\n          name: es-logging\n          ports:\n            - containerPort: 9200\n              name: tcp-9200\n              protocol: TCP\n            - containerPort: 9300\n              name: tcp-9300\n              protocol: TCP\n          readinessProbe:\n            exec:\n              command:\n                - sh\n                - '-c'\n                - /usr/share/elasticsearch/config/es_check.sh\n            failureThreshold: 3\n            initialDelaySeconds: 15\n            periodSeconds: 10\n            successThreshold: 1\n            timeoutSeconds: 1\n          resources:\n            limits:\n              cpu: '2'\n          volumeMounts:\n            - mountPath: /usr/share/elasticsearch/data\n              name: es7x-data\n            - mountPath: /usr/share/elasticsearch/config/elasticsearch.yml\n              name: es7x-config\n              subPath: elasticsearch.yml\n            - mountPath: /usr/share/elasticsearch/config/es_check.sh\n              name: es7x-config\n              subPath: es_check.sh\n            # - mountPath: /usr/share/elasticsearch/config/certs\n            #   name: es-certs\n            #   readOnly: true\n        - env:\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: POD_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.podIP\n            - name: TZ\n              value: Asia/Shanghai\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n            - name: ES_URI\n              value: 'http://elastic:$(ELASTIC_PASSWORD)@localhost:9200'\n            - name: ES_INDICES\n              value: 'true'\n            - name: ES_ALL\n              value: 'true'\n            - name: ES_INDICES_SETTINGS\n              value: 'true'\n          image: 'justwatch/elasticsearch_exporter:1.1.0'\n          imagePullPolicy: IfNotPresent\n          name: elasticsearch-exporter\n          ports:\n            - containerPort: 9114\n              name: tcp-9114\n              protocol: TCP\n          resources:\n            limits:\n              cpu: 200m\n              memory: 200Mi\n      dnsPolicy: ClusterFirst\n      initContainers:\n        - command:\n            - sysctl\n            - '-w'\n            - vm.max_map_count=262144\n          image: 'busybox:1.31.0'\n          imagePullPolicy: IfNotPresent\n          name: increase-vm-max-map\n          securityContext:\n            privileged: true\n            runAsUser: 0\n        - command:\n            - sh\n            - '-c'\n            - ulimit -n 65536\n          image: 'busybox:1.31.0'\n          imagePullPolicy: IfNotPresent\n          name: increase-fd-ulimit\n          securityContext:\n            privileged: true\n            runAsUser: 0\n    #   nodeSelector:\n    #     node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 1000\n        runAsUser: 1000\n        seLinuxOptions:\n          level: 's0:c13,c12'\n    #   serviceAccount: es-logging-sa\n    #   serviceAccountName: es-logging-sa\n      terminationGracePeriodSeconds: 10\n      volumes:\n        - configMap:\n            defaultMode: 493\n            name: es-logging-config\n          name: es7x-config\n        # - name: es-certs\n        #   secret:\n        #     defaultMode: 420\n        #     secretName: es-logging-certs\n  updateStrategy:\n    type: RollingUpdate\n  volumeClaimTemplates:\n    - metadata:\n        labels:\n          name: es-logging\n        name: es7x-data\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 20Gi\n        storageClassName: logging-storageclass\n```\n\n\n\nes集群使用了statefulset方式部署，其中storageclass`logging-storageclass`需要自己手动创建，执行下面的命令完成部署。\n\n```bash\nkubectl apply -f elasticsearch-cluster.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建service -->\n\n```yaml\n# elasticsearch-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: es-logging\n  name: es-logging-service\n  namespace: logging\nspec:\n  ports:\n    - name: tcp-9200\n      port: 9200\n      protocol: TCP\n      targetPort: 9200\n  selector:\n    app: es-logging\n  sessionAffinity: None\n  type: ClusterIP\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: es-logging\n    monitor-app: elasticsearch-exporter\n  name: es-logging-cluster\n  namespace: logging\nspec:\n  clusterIP: None\n  ports:\n    - name: tcp-9300\n      port: 9300\n      protocol: TCP\n      targetPort: 9300\n    - name: tcp-9114\n      port: 9114\n      protocol: TCP\n      targetPort: 9114\n  selector:\n    app: es-logging\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面的命令完成部署：\n\n```bash\nkubeclt apply -f elasticsearch-service.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查\n\n首先确保所有的pod都处于running状态：\n\n```bash\nkubectl get pod -n logging | grep es\n```\n\n<img src=\"./es-pod.png\" style=\"zoom:50%;\" />\n\n\n\n然后执行下面的命令：\n\n```bash\nkubectl logs -f es-logging-1 -n logging -c es-logging\n```\n\n\n\n如果输出的日志中有`Cluster health status changed from [YELLOW] to [GREEN]`，说明集群正常了。\n\n\n\n<br>\n\n\n\n# 部署kafka\n\n## 部署zookeeper\n\n{% tabs comments %}\n\n<!-- tab 部署zookeeper集群 -->\n\n```yaml\n# zookeeper-cluster.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: zk-logging\n  namespace: logging\nspec:\n  podManagementPolicy: Parallel\n  replicas: 3\n  selector:\n    matchLabels:\n      app: zk-logging\n  serviceName: zk-logging-headless\n  template:\n    metadata:\n      labels:\n        app: zk-logging\n    spec:\n    #   affinity:\n    #     podAntiAffinity:\n    #       requiredDuringSchedulingIgnoredDuringExecution:\n    #         - labelSelector:\n    #             matchExpressions:\n    #               - key: app\n    #                 operator: In\n    #                 values:\n    #                   - zk-logging\n    #           topologyKey: kubernetes.io/hostname\n      containers:\n        - env:\n            - name: ZOO_SERVERS\n              value: >-\n                server.1=zk-logging-0.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181\n                server.2=zk-logging-1.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181\n                server.3=zk-logging-2.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181\n            - name: ZOO_4LW_COMMANDS_WHITELIST\n              value: 'ruok,srvr,conf,stat'\n            - name: TZ\n              value: Asia/Shanghai\n          image: 'zookeeper:3.5.7'\n          imagePullPolicy: Always\n          name: zk-logging\n          ports:\n            - containerPort: 2181\n              name: client\n              protocol: TCP\n            - containerPort: 2888\n              name: server\n              protocol: TCP\n            - containerPort: 3888\n              name: leader-election\n              protocol: TCP\n          resources:\n            requests:\n              cpu: 500m\n              memory: 500Mi\n          volumeMounts:\n            - mountPath: /data\n              name: datadir\n      dnsPolicy: ClusterFirst\n      initContainers:\n        - command:\n            - sh\n            - '-c'\n            - >-\n              echo $(( $(echo ${POD_NAME} | awk -F \"-\" '{print $NF}') + 1 )) >\n              /data/myid\n          env:\n            - name: POD_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n          image: 'busybox:1.31.0'\n          imagePullPolicy: IfNotPresent\n          name: init-zk-logging\n          resources: {}\n          volumeMounts:\n            - mountPath: /data\n              name: datadir\n    #   nodeSelector:\n        # node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 1000\n        runAsUser: 1000\n    #   serviceAccount: zk-logging-sa\n    #   serviceAccountName: zk-logging-sa\n      terminationGracePeriodSeconds: 30\n  updateStrategy:\n    type: RollingUpdate\n  volumeClaimTemplates:\n    - metadata:\n        creationTimestamp: null\n        name: datadir\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 5Gi\n        storageClassName: logging-storageclass\n```\n\n\n\n使用下面的命令完成部署：\n\n```bash\nkubectl apply -f zookeeper-cluster.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署service对象 -->\n\n```yaml\n# zookeeper-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: zk-logging\n  name: zk-logging-service\n  namespace: logging\nspec:\n  ports:\n    - name: client\n      port: 2181\n      protocol: TCP\n      targetPort: 2181\n  selector:\n    app: zk-logging\n  sessionAffinity: None\n  type: ClusterIP\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: zk-logging\n  name: zk-logging-headless\n  namespace: logging\nspec:\n  clusterIP: None\n  ports:\n    - name: server\n      port: 2888\n      protocol: TCP\n      targetPort: 2888\n    - name: leader-election\n      port: 3888\n      protocol: TCP\n      targetPort: 3888\n  selector:\n    app: zk-logging\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面命令完成部署：\n\n```bash\nkubectl apply -f zookeeper-service.yaml\n```\n\n\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 部署kafka\n\n{% tabs comments %}\n\n<!-- tab 部署kafka集群 -->\n\n```yaml\n# kafka-cluster.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: kafka-logging\n  namespace: logging\nspec:\n  podManagementPolicy: Parallel\n  replicas: 3\n  selector:\n    matchLabels:\n      app: kafka-logging\n  serviceName: kafka-logging-service\n  template:\n    metadata:\n      labels:\n        app: kafka-logging\n    spec:\n    #   affinity:\n    #     podAntiAffinity:\n    #       requiredDuringSchedulingIgnoredDuringExecution:\n    #         - labelSelector:\n    #             matchExpressions:\n    #               - key: app\n    #                 operator: In\n    #                 values:\n    #                   - kafka-logging\n    #           topologyKey: kubernetes.io/hostname\n      containers:\n        - env:\n            - name: KAFKA_REPLICAS\n              value: '3'\n            - name: KAFKA_ZK_LOCAL\n              value: 'false'\n            - name: KAFKA_HEAP_OPTS\n              value: '-Xmx1024M -Xms1024M'\n            - name: SERVER_num_partitions\n              value: '3'\n            - name: SERVER_delete_topic_enable\n              value: 'true'\n            - name: SERVER_log_retention_hours\n              value: '2147483647'\n            - name: KAFKA_ADVERTISED_PORT\n              value: '9092'\n            - name: SERVER_zookeeper_connection_timeout_ms\n              value: '6000'\n            - name: SERVER_log_dirs\n              value: /opt/kafka/data/logs\n            - name: KAFKA_ADVERTISED_HOST_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: KAFKA_ZOOKEEPER_CONNECT\n              value: 'zk-logging-service.logging.svc.cluster.local:2181'\n            - name: BROKER_ID_COMMAND\n              value: 'hostname | awk -F ''-'' ''{print $NF}'''\n            - name: KAFKA_PORT_NUMBER\n              value: '9092'\n            - name: KAFKA_ADVERTISED_HOST_NAME\n              value: >-\n                $(KAFKA_ADVERTISED_HOST_NAME).kafka-logging-service.logging.svc.cluster.local\n            - name: TZ\n              value: Asia/Shanghai\n          image: 'wurstmeister/kafka:2.12-2.5.0'\n          imagePullPolicy: Always\n          name: kafka-logging\n          ports:\n            - containerPort: 9092\n              name: server\n              protocol: TCP\n          resources:\n            requests:\n              cpu: 500m\n              memory: 500Mi\n          volumeMounts:\n            - mountPath: /kafka\n              name: datadir\n      dnsPolicy: ClusterFirst\n    #   nodeSelector:\n    #     node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 0\n        runAsUser: 0\n    #   serviceAccount: kafka-logging-sa\n    #   serviceAccountName: kafka-logging-sa\n      terminationGracePeriodSeconds: 30\n  updateStrategy:\n    type: RollingUpdate\n  volumeClaimTemplates:\n    - metadata:\n        creationTimestamp: null\n        name: datadir\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 20Gi\n        storageClassName: logging-storageclass\n```\n\n\n\n使用下面的命令完成部署：\n\n```bash\nkubectl apply -f kafka-cluster.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署service对象 -->\n\n```yaml\n# kafka-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: kafka-logging\n  name: kafka-logging-service\n  namespace: logging\nspec:\n  clusterIP: None\n  ports:\n    - name: server\n      port: 9092\n      protocol: TCP\n      targetPort: 9092\n  selector:\n    app: kafka-logging\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面命令完成部署：\n\n```bash\nkubectl apply -f kafka-service.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署kafka-manager -->\n\nkafka-manager是kafka的一个web管理平台，这里部署一下方便在有需要时进行管理。\n\n```yaml\n# kafka-manager.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: kafka-manager\n  name: kafka-manager\n  namespace: logging\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: kafka-manager\n  strategy:\n    rollingUpdate:\n      maxSurge: 25%\n      maxUnavailable: 25%\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: kafka-manager\n    spec:\n      containers:\n        - env:\n            - name: ZK_HOSTS\n              value: 'zk-logging-service.logging.svc:2181'\n            - name: TZ\n              value: Asia/Shanghai\n          image: 'kafkamanager/kafka-manager:2.0.0.2'\n          imagePullPolicy: IfNotPresent\n          name: kafka-manager\n          ports:\n            - containerPort: 9000\n              name: tcp-9000\n              protocol: TCP\n          resources: {}\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: kafka-manager\n  name: kafka-manager\n  namespace: logging\nspec:\n  ports:\n    - name: kafka-manager\n      port: 9000\n      protocol: TCP\n      targetPort: 9000\n  selector:\n    app: kafka-manager\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面命令完成部署：\n\n```bash\nkubectl apply -f kafka-manager.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建ingress -->\n\n```yaml\n# kafka-manager-ingress.yaml\nkind: Ingress\nmetadata:\n   name: kafka-manager\n   namespace: logging\nspec:\n   rules:\n   - host: kafka-manager.example.com\n     http:\n       paths:\n       - path: /\n         backend:\n          serviceName: kafka-manager\n          servicePort: 9000\n```\n\n\n\n执行下面的命令完成创建：\n\n```bash\nkubectl apply -f kafka-manager-ingress.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查服务\n\n检查所有的pod都正常运行：\n\n```bash\nkubectl get pod,svc,ingress -n logging | grep -E 'kafka|zk'\n```\n\n<img src=\"./kafka-pod.png\" style=\"zoom:50%;\" />\n\n\n\n## 创建nginx配置\n\n在nginx服务器上增加kafka-manager配置，代理kafka服务：\n\n```nginx\n# /etc/nginx/conf.d/kafka-manager.conf\nupstream ingress-80 {\n    server 10.8.138.9:80 max_fails=3 fail_timeout=5s weight=2;\n    server 10.8.138.11:80 max_fails=3 fail_timeout=5s weight=2;\n}\n\nserver {\n    listen 80;\n    server_name kafka-manager.example.com;\n    rewrite ^(.*) https://$host$1 permanent;\n}\n\nserver {\n    listen 443 ssl;\n    server_name kafka-manager.example.com;\n\n    ssl_certificate /etc/nginx/ssl/nginx.crt;\n    ssl_certificate_key /etc/nginx/ssl/nginx.key;\n\n    access_log /var/log/nginx/kafka-manager.example.com_access.log main;\n    error_log /var/log/nginx/kafka-manager.example.com_error.log;\n\n    location / {\n      proxy_pass http://ingress-80;\n      proxy_set_header Host $http_host;\n    }\n\n    include conf.d/common.ini;\n}\n```\n\n\n\n检查配置并重载nginx：\n\n```bash\nnginx -t \nnginx -s reload \n```\n\n\n\n## 访问并配置kafka-manager\n\n通过浏览器访问kafka-manager的域名`kafka-manager.example.com`即可进入kafka-manager的控制页面，点击上边的`Cluster`，然后选择`Add Cluster`添加kafka集群，需要填入下面几个信息：\n\n<img src=\"./add-cluster-1.png\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"./add-cluster-2.png\" style=\"zoom:50%;\" />\n\n\n\n最后点击`save`后集群信息添加完成。\n\n\n\n<br>\n\n\n\n# 部署logstash\n\n##  创建logstash配置\n\nlogstash相关的配置文件可以在[logstash配置文件](https://github.com/liyongzhezz/yaml/tree/master/EFK-kafka日志收集) 找到，这里需要将`efk-template.json`, `init_efk.sh`, `k8s-log.json`, `logstash.conf`, `logstash.yml`, `systemd-log.json` 放入一个目录下，例如`logstash-conf`下：\n\n- `efk-template.json`：定义的是针对索引的日志策略；\n- `init_efk.sh`：操作es ，初始化一些配置；\n- `k8s-log.json`：收集k8s日志的配置；\n- `logstash.conf`：logstash的流水线配置；\n- `logstash.yml`：logstash配置文件；\n- `systemd-log.json`：收集系统日志的配置；\n\n\n\n然后执行下面的命令：\n\n```bash\nkubectl create configmap logstash-logging-config --from-file=./logstash-conf/ -n logging \n```\n\n\n\n<img src=\"./configmap.png\" style=\"zoom:50%;\" />\n\n\n\n## 部署logstash\n\nlogstash不需要很多实例，所以使用`deployment`方式部署，可以根据需要进行扩展：\n\n```yaml\n# logstash-deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: logstash-logging\n  name: logstash-logging\n  namespace: logging\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: logstash-logging\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: logstash-logging\n      name: logstash-logging\n    spec:\n      containers:\n        - env:\n            - name: TZ\n              value: Asia/Shanghai\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'logstash:7.8.0'\n          imagePullPolicy: IfNotPresent\n          name: logstash-logging\n          ports:\n            - containerPort: 5044\n              name: tcp-5044\n              protocol: TCP\n            - containerPort: 9600\n              name: tcp-9600\n              protocol: TCP\n          resources: {}\n          securityContext:\n            privileged: true\n            runAsUser: 1000\n          volumeMounts:\n            - mountPath: /usr/share/logstash/config/logstash.yml\n              name: logstash-config\n              subPath: logstash.yml\n            - mountPath: /usr/share/logstash/pipeline/logstash.conf\n              name: logstash-config\n              subPath: logstash.conf\n            - mountPath: /usr/share/logstash/config/efk-template.json\n              name: logstash-config\n              subPath: efk-template.json\n      dnsPolicy: ClusterFirst\n      initContainers:\n        - command:\n            - sh\n            - '-c'\n            - /bin/init_efk.sh\n          env:\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'curlimages/curl:latest'\n          imagePullPolicy: Always\n          name: init-efk\n          resources: {}\n          volumeMounts:\n            - mountPath: /bin/init_efk.sh\n              name: logstash-config\n              subPath: init_efk.sh\n            - mountPath: /tmp/k8s-log.json\n              name: logstash-config\n              subPath: k8s-log.json\n            - mountPath: /tmp/systemd-log.json\n              name: logstash-config\n              subPath: systemd-log.json\n    #   nodeSelector:\n    #     node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 1000\n        runAsUser: 1000\n        seLinuxOptions:\n          level: 's0:c13,c12'\n      terminationGracePeriodSeconds: 30\n      volumes:\n        - configMap:\n            defaultMode: 493\n            name: logstash-logging-config\n          name: logstash-config\n```\n\n\n\n直接运行下面的命令部署logstash：\n\n```bash\nkubectl apply -f logstash-deployment.yaml\n```\n\n\n\n## 检查服务\n\n确保所有的pod都处于Running状态：\n\n```bash\nkubectl get pod -n logging | grep logstash\n```\n\n<img src=\"./logstash-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n# 部署filebeat\n\n## 部署相关资源\n\n{% tabs comments %}\n\n<!-- tab 创建权限 -->\n\n```yaml\n# filebeat-rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: filebeat-logging-sa\n  namespace: logging\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: filebeat-logging-bind\nsubjects:\n- kind: ServiceAccount\n  name: filebeat-logging-sa\n  namespace: logging\nroleRef:\n  kind: ClusterRole\n  name: filebeat-logging-clusterrole\n  apiGroup: rbac.authorization.k8s.io\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: filebeat-logging-clusterrole\nrules:\n- apiGroups: [\"\"] # \"\" indicates the core API group\n  resources:\n  - namespaces\n  - pods\n  verbs:\n  - get\n  - watch\n  - list\n```\n\n\n\n执行下面的命令完成创建：\n\n```yaml\nkubectl apply -f filebeat-rbac.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建相关配置 -->\n\n```yaml\n# filebeat-configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: filebeat-logging-config\n  namespace: logging\ndata:\n  filebeat.yml: |\n    name: \"filebeat-k8s\"\n    filebeat.registry.path: /var/log/filebeat/registry\n    logging.level: warning\n    filebeat.inputs:\n    - type: container\n      scan_frequency: 5s\n      enable: true\n      symlinks: false\n      harvester_buffer_size: 16384\n      max_bytes: 10485760\n      paths:\n      - /var/lib/docker/containers/*/*-json.log\n      multiline.pattern: '^[[:space:]]+.+\\b|^Caused by:|^[[:alpha:]]+.+Exception:\\s\\w+.+|^[[:alpha:]]+.+Exception$|^Exception\\s\\w+.+'\n      multiline.negate: false\n      multiline.match: after\n      multiline.max_lines: 500\n      multiline.timeout: 5s\n      fields_under_root: true\n      overwrite_keys: true\n\n    - type: log\n      scan_frequency: 5s\n      enable: true\n      symlinks: false\n      harvester_buffer_size: 16384\n      max_bytes: 10485760\n      paths:\n      - /var/log/messages\n      fields_under_root: true\n      overwrite_keys: true\n\n    processors:\n      - add_kubernetes_metadata:\n          in_cluster: true\n      - add_host_metadata: \n          netinfo.enabled: true\n      - add_locale: ~\n      - add_fields:\n          target: host\n          fields:\n            name: ${NODE_NAME}\n            ip: ${NODE_IP}\n            podip: ${POD_IP}\n      - drop_fields:\n          fields: [\"agent.ephemeral_id\",\"agent.id\",\"log.offset\",\"suricata.eve.timestamp\",\"host.os.codename\",\"host.hostname\"]\n          ignore_missing: false\n\n    output.kafka:\n      hosts: [\"kafka-logging-service:9092\"]\n      version: 2.0.0\n      worker: 3\n      topics: \n        - topic: \"k8s-log.%{[kubernetes.namespace]}\"\n          when.contains: \n            input.type: \"container\"\n        - topic: \"systemd-log.%{[host.name]}\"\n          when.contains: \n            input.type: \"log\"\n      partition.round_robin:\n        reachable_only: false\n      required_acks: 1\n      compression: gzip\n      max_message_bytes: 1000000\n\n\n    xpack.monitoring.enabled: true\n    xpack.monitoring.elasticsearch.hosts: [ \"es-logging-service:9200\" ]\n    xpack.monitoring.elasticsearch.protocol: \"http\"\n    xpack.monitoring.elasticsearch.username: \"elastic\" \n    xpack.monitoring.elasticsearch.password: \"${ELASTIC_PASSWORD}\"\n```\n\n\n\n在配置文件中，指定filebeat去读取docker日志和系统日志，并将日志发送给kafka。filebeat本身不对日志进行处理。执行下面的命令完成创建：\n\n```bash\nkubectl apply -f filebeat-configmap.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署filebeat -->\n\n每一个工作节点都需要收集日志，所以使用daemonset方式进行部署：\n\n```yaml\n# fileat-daemonset.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  labels:\n    app: filebeat-logging\n    version: v1\n  name: filebeat-logging\n  namespace: logging\nspec:\n  selector:\n    matchLabels:\n      app: filebeat-logging\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: filebeat-logging\n        version: v1\n    spec:\n      containers:\n        - args:\n            - '-c'\n            - /home/filebeat-config/filebeat.yml\n            - '-e'\n          env:\n            - name: TZ\n              value: Asia/Shanghai\n            - name: POD_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.podIP\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: spec.nodeName\n            - name: NODE_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.hostIP\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'elastic/filebeat:7.6.8'\n          imagePullPolicy: IfNotPresent\n          name: filebeat-logging\n          securityContext:\n            privileged: true\n            runAsUser: 0\n          volumeMounts:\n            - mountPath: /var/log\n              name: filebeat-storage\n            - mountPath: /var/log/pods\n              name: varlogpods\n            - mountPath: /var/lib/docker/containers\n              name: varlibdockercontainers\n            - mountPath: /home/filebeat-config\n              name: filebeat-volume\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      serviceAccount: filebeat-logging-sa\n      serviceAccountName: filebeat-logging-sa\n      terminationGracePeriodSeconds: 30\n      volumes:\n        - hostPath:\n            path: /var/log\n            type: ''\n          name: filebeat-storage\n        - hostPath:\n            path: /var/log/pods\n            type: ''\n          name: varlogpods\n        - hostPath:\n            path: /var/lib/docker/containers\n            type: ''\n          name: varlibdockercontainers\n        - configMap:\n            defaultMode: 420\n            name: filebeat-logging-config\n          name: filebeat-volume\n  updateStrategy:\n    rollingUpdate:\n      maxUnavailable: 1\n    type: RollingUpdate\n```\n\n\n\n在yaml文件中，将`/var/lib/docker/containers`和`/var/log`挂载到了容器中，方便容器进行日志收集。\n\n```bash\nkubectl apply -f filebeat-daemonset.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查服务\n\n确保所有pod都正常运行：\n\n```bash\nkubectl get pod -n logging | grep filebeat\n```\n\n<img src=\"./pod.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n# 部署kibana\n\n## 部署相关资源\n\n{% tabs comments %}\n\n<!-- tab 创建初始化配置 -->\n\nKibana相关的配置文件可以在[kibana配置文件](https://github.com/liyongzhezz/yaml/tree/master/EFK-kafka日志收集) 找到，这里需要将`init_kibana.sh` 放入一个目录下，例如`kibana-conf`下，然后执行下面的命令：\n\n```bash\nkubectl create configmap kibana-logging-init-config --from-file=./kibana-conf/init_kibana.sh -n logging\n```\n\n<!-- endtab -->\n\n<!-- tab 创建配置文件 -->\n\n```yaml\n# kibana-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: kibana-logging-config\n  namespace: logging\ndata:\n  kibana.yml: |\n    server.port: 5601\n    server.host: \"0.0.0.0\"\n    server.name: \"kibana-logging\"\n    elasticsearch.hosts: [\"http://es-logging-service:9200\"]\n    xpack.monitoring.ui.container.elasticsearch.enabled: true\n    xpack.security.enabled: true\n    elasticsearch.username: \"kibana\"\n    elasticsearch.password: \"${KIBANA_PASSWORD}\"\n    elasticsearch.requestHeadersWhitelist: [ 'es-security-runas-user',\n    'authorization', 'X-Proxy-Remote-User', 'x-forwarded-for',\n    'x-forwarded-access-token' ]\n    elasticsearch.requestTimeout: 300000\n    kibana.index: \".kibana\"\n    logging.quiet: true\n  kibana_check.sh: |\n    #!/bin/bash\n    KIBANA_REST_BASEURL=http://localhost:5601/login\n    EXPECTED_RESPONSE_CODE=200\n    max_time=\"${max_time:-4}\"\n\n    response_code=\"$(\n        curl --silent                          \\\n             --request HEAD                    \\\n             --head                            \\\n             --output /dev/null                \\\n             --max-time \"${max_time}\"          \\\n             --write-out '%{response_code}'    \\\n             \"${KIBANA_REST_BASEURL}\"\n    )\"\n\n    if [ \"${response_code}\" == \"${EXPECTED_RESPONSE_CODE}\" ]; then\n        exit 0\n    else\n        echo \"Kibana node is not ready to accept HTTP requests yet [response code: ${response_code}]\"\n        exit 1\n    fi\n```\n\n\n\n执行下面的命令完成部署：\n\n```bash\nkubectl apply -f kibana-config.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署kibana -->\n\n```yaml\n# kibana-deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: kibana-logging\n  name: kibana-logging\n  namespace: logging\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: kibana-logging\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: kibana-logging\n      name: kibana-logging\n    spec:\n      containers:\n        - env:\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: TZ\n              value: Asia/Shanghai\n            - name: KIBANA_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'kibana:7.8.0'\n          name: kibana-logging\n          imagePullPolicy: IfNotPresent\n          livenessProbe:\n            exec:\n              command:\n                - sh\n                - '-c'\n                - /usr/share/kibana/config/kibana_check.sh\n            failureThreshold: 3\n            initialDelaySeconds: 60\n            periodSeconds: 20\n            successThreshold: 1\n            timeoutSeconds: 1\n          ports:\n            - containerPort: 5601\n              name: tcp-5601\n              protocol: TCP\n          readinessProbe:\n            exec:\n              command:\n                - sh\n                - '-c'\n                - /usr/share/kibana/config/kibana_check.sh\n            failureThreshold: 3\n            initialDelaySeconds: 15\n            periodSeconds: 10\n            successThreshold: 1\n            timeoutSeconds: 1\n          resources:\n            limits:\n              cpu: '2'\n              memory: 2Gi\n            requests:\n              cpu: 500m\n              memory: 500Mi\n          volumeMounts:\n            - mountPath: /usr/share/kibana/config/kibana.yml\n              name: kibana-config\n              subPath: kibana.yml\n            - mountPath: /usr/share/kibana/config/kibana_check.sh\n              name: kibana-config\n              subPath: kibana_check.sh\n      dnsPolicy: ClusterFirst\n      initContainers:\n        - command:\n            - sh\n            - '-c'\n            - /bin/init_kibana.sh\n          env:\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'curlimages/curl:latest'\n          imagePullPolicy: Always\n          name: init-kibana\n          resources: {}\n          volumeMounts:\n            - mountPath: /bin/init_kibana.sh\n              name: kibana-init\n              subPath: init_kibana.sh\n    #   nodeSelector:\n    #     node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      volumes:\n        - configMap:\n            defaultMode: 493\n            name: kibana-logging-config\n          name: kibana-config\n        - configMap:\n            defaultMode: 493\n            name: kibana-logging-init-config\n          name: kibana-init\n```\n\n\n\n执行下面的命令完成部署：\n\n```bash\nkubectl apply -f kibana-deployment.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建service对象 -->\n\n```yaml\n# kibana-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: kibana-logging-service\n  namespace: logging\nspec:\n  ports:\n    - name: tcp-5601\n      port: 5601\n      protocol: TCP\n      targetPort: 5601\n  selector:\n    app: kibana-logging\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面的命令完成创建：\n\n```bash\nkubectl apply -f kibana-service.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建ingress对象 -->\n\n```yaml\n# kibana-ingress.yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n   name: kibana\n   namespace: logging\nspec:\n   rules:\n   - host: kibana.example.com\n     http:\n       paths:\n       - path: /\n         backend:\n          serviceName: kibana-logging-service\n          servicePort: 5601\n```\n\n\n\n执行下面的命令完成创建：\n\n```bash\nkubectl apply -f kibana-ingress.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 配置nginx暴露服务\n\n新增下面的nginx配置:\n\n```nginx\n# /etc/nginx/conf.d/kibana.conf\nupstream ingress-80 {\n    server 10.8.138.9:80 max_fails=3 fail_timeout=5s weight=2;\n    server 10.8.138.11:80 max_fails=3 fail_timeout=5s weight=2;\n}\n\nserver {\n    listen 80;\n    server_name kibana.example.com;\n    rewrite ^(.*) https://$host$1 permanent;\n}\n\nserver {\n    listen 443 ssl;\n    server_name kibana.example.com;\n\n    ssl_certificate /etc/nginx/ssl/nginx.crt;\n    ssl_certificate_key /etc/nginx/ssl/nginx.key;\n\n    access_log /var/log/nginx/kibana.example.com_access.log main;\n    error_log /var/log/nginx/kibana.example.com_error.log;\n\n    location / {\n      proxy_pass http://ingress-80;\n      proxy_set_header Host $http_host;\n    }\n\n    include conf.d/common.ini;\n}\n```\n\n\n\n检查并重载nginx：\n\n```bash\nnginx -t\nnginx -s reload\n```\n\n\n\n## 检查服务\n\n确保相关pod都处在Running状态：\n\n```bash\nkubectl get pod,svc,ingress -n logging | grep kibana\n```\n\n<img src=\"./kibana-pod.png\" style=\"zoom:50%;\" />\n\n\n\n## 访问页面\n\n通过浏览器访问`kibana.example.com`即可进入kibana的页面，输入在部署elasticsearch中设置的初始账号密码：`elastic/elastic`。然后在kibana中创建`Index patterns`就可以了。\n\n<img src=\"./kibana.png\" style=\"zoom:50%;\" />\n\n\n\n访问kafka-manager观察，发现消息topic也创建出来并且有消息在队列中被logstash消费：\n\n<img src=\"./kafka.png\" style=\"zoom:50%;\" />\n\n\n\n","source":"_posts/在k8s中使用EFLK进行日志收集.md","raw":"---\ntitle: 在k8s中使用EFLK进行日志收集\ndate: 2021-03-27 12:31:50\ntags:\n- K8S\n- 日志收集\ncategories:\n- Kubernetes\n- 日志收集\ndescription: 在kubernetes中使用ELFK进行日志收集和展示\ncover: https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用filebeat、kafka、logstash、elasticsearch、kibana进行日志收集\n\n更新于 2021-03-27\n\n{% endnote %}\n\n<br>\n\n\n\n# 架构方案\n\n## 架构\n\n整体收集方案使用如下的组件：\n\n- `filebeat`：采集节点和容器日志，发送到kafka；\n- `kafka`：接收filebeat发送的日志消息；\n- `logstash`：从kafka中消费日志消息并进行处理；\n- `elasticsearch`：进行日志存储；\n- `kibana`：日志可视化展示；\n\n\n\n> 日志文件 --> filebeat --> kafka --> logstash --> elasticsearch --> kibana\n\n\n\n## 版本选择\n\n- `filebeat`：7.6.2；\n- `kafka`：2.12-2.5.0；\n- `zookeeper`：3.5.7；\n- `logstash`：7.8.0；\n- `elasticsearch`：7.8.0；\n- `kibana`：7.8.0；\n\n\n\n## 方案可能存在的问题\n\n这套日志收集方案可能存在下面的问题：\n\n- elasticsearch可能存在瓶颈（es还需要进一步调优）；\n- logstash会根据写入es的速度调整消息消费的速度，所有kafka有时候会出现消息堆积的情况；\n- ......\n\n\n\n<br>\n\n\n\n# 准备工作\n\n{% tabs comments %}\n\n<!-- tab 准备nfs相关资源 -->\n\n这里使用nfs作为底层存储，相关的创建方法可以参考：{% post_link 在k8s中使用nfs存储 %}，当然也可以使用其他的存储系统。\n\n<!-- endtab -->\n\n<!-- tab 创建namespace -->\n\n使用下面的yaml文件创建一个namespace：\n\n```yaml\n# namesapce.yaml\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: logging\n```\n\n\n\n```bash\nkubectl apply -f namespace.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 设置elasticsearch密码 -->\n\nelasticsearch开启x-pack认证功能，这里将elasticsearch的密码保存在secret资源中：\n\n```bash\nespassword=\"elastic\"\n\nkubectl create secret generic es-logging-password --from-literal=elastic='elastic' -n logging\n```\n\n\n\n> 这里讲elasticsearch密码设置为：`elastic`\n\n<!-- endtab -->\n\n\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署elasticsearch\n\n## 部署相关资源\n\n{% tabs comments %}\n\n<!-- tab 创建elasticsearch配置 -->\n\n```yaml\n# elasticsearch-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: es-logging-config\n  namespace: logging\ndata:\n  elasticsearch.yml: |\n    cluster.name: es-logging-cluster\n    node.name: ${NODE_NAME}\n    network.host: 0.0.0.0\n    http.port: 9200\n    transport.port: 9300\n    discovery.seed_hosts: [\"es-logging-cluster\"]\n    cluster.initial_master_nodes:\n      - es-logging-0\n      - es-logging-1\n      - es-logging-2\n    xpack.monitoring.collection.enabled: true\n    xpack.security.enabled: true\n    xpack.license.self_generated.type: basic\n    indices.lifecycle.history_index_enabled: false\n    xpack.ilm.enabled: true\n    \n    cluster.routing.allocation.disk.threshold_enabled: false\n\n    # xpack.security.transport.ssl.enabled: true\n    # xpack.security.transport.ssl.verification_mode: certificate\n    # xpack.security.transport.ssl.key: certs/es-logging-service.key\n    # xpack.security.transport.ssl.certificate: certs/es-logging-service.crt\n    # xpack.security.transport.ssl.certificate_authorities: certs/ca.crt\n    # xpack.security.http.ssl.enabled: false\n    # xpack.security.authc.realms:\n    #   native.realm1:\n    #     order: 0\n  es_check.sh: >\n    #!/bin/bash\n\n    ES_REST_BASEURL=http://localhost:9200\n\n    EXPECTED_RESPONSE_CODE=200\n\n    max_time=${READINESS_PROBE_TIMEOUT:-30}\n\n\n    function check_if_ready() {\n      path=\"$1\"\n      err_msg=\"$2\"\n      response_code=$(curl -s -k --head \\\n          -u elastic:${ELASTIC_PASSWORD} \\\n          --max-time $max_time \\\n          -o /dev/null \\\n          -w '%{response_code}' \\\n          \"${ES_REST_BASEURL}${path}\")\n\n      if [ \"${response_code}\" != ${EXPECTED_RESPONSE_CODE} ]; then\n        echo \"${err_msg} [response code: ${response_code}]\"\n        exit 1\n      fi\n      exit 0\n    }\n\n\n    check_if_ready \"/\" \"Elasticsearch node is not ready to accept HTTP requests yet\"\n```\n\n\n\n配置中的相关参数解释：\n\n- `cluster.name`：设置es集群名称，用于唯一标识一个集群；\n- `network.host`：监听的地址；\n- `discovery.seed_hosts`：节点发现方式；\n- `xpack.security.enabled`起用xpack安全组件；\n- `cluster.routing.allocation.disk.threshold_enabled`是否启动磁盘分配器；\n\n> `cluster.routing.allocation.disk.threshold_enabled`这个参数这里设置为false，表示关闭磁盘分配器，这样es可以使用全部磁盘空间。默认情况下当磁盘空间大于85%后，es就不能再创建分片了。这个参数在es使用同一个后端存储的时候应该调节一下。[相关文档](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#disk-based-shard-allocation)\n\n\n\nes启用了x-pack密码认证，并且通过脚本检查es是否正常启动。我这里将es https通信方式注释掉了，如果有需要可以生成相关证书并起用https配置。直接运行下面的命令创建es配置：\n\n```bash\nkubectl apply -f elasticsearch-config.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建elasticsearch集群 -->\n\n使用下面的yaml文件创建一个namespace：\n\n```yaml\n# elasticsearch-cluster.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  labels:\n    app: es-logging\n  name: es-logging\n  namespace: logging\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: es-logging\n  serviceName: es-logging-cluster\n  template:\n    metadata:\n      labels:\n        app: es-logging\n      name: es-logging\n    spec:\n    #   affinity:\n    #     podAntiAffinity:\n    #       requiredDuringSchedulingIgnoredDuringExecution:\n    #         - labelSelector:\n    #             matchExpressions:\n    #               - key: app\n    #                 operator: In\n    #                 values:\n    #                   - es-logging\n    #           topologyKey: kubernetes.io/hostname\n      containers:\n        - env:\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: POD_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.podIP\n            - name: ES_JAVA_OPTS\n              value: '-Xms2g -Xmx2g'\n            - name: TZ\n              value: Asia/Shanghai\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'docker.elastic.co/elasticsearch/elasticsearch:7.8.0'\n          imagePullPolicy: IfNotPresent\n          livenessProbe:\n            exec:\n              command:\n                - sh\n                - '-c'\n                - /usr/share/elasticsearch/config/es_check.sh\n            failureThreshold: 3\n            initialDelaySeconds: 60\n            periodSeconds: 20\n            successThreshold: 1\n            timeoutSeconds: 1\n          name: es-logging\n          ports:\n            - containerPort: 9200\n              name: tcp-9200\n              protocol: TCP\n            - containerPort: 9300\n              name: tcp-9300\n              protocol: TCP\n          readinessProbe:\n            exec:\n              command:\n                - sh\n                - '-c'\n                - /usr/share/elasticsearch/config/es_check.sh\n            failureThreshold: 3\n            initialDelaySeconds: 15\n            periodSeconds: 10\n            successThreshold: 1\n            timeoutSeconds: 1\n          resources:\n            limits:\n              cpu: '2'\n          volumeMounts:\n            - mountPath: /usr/share/elasticsearch/data\n              name: es7x-data\n            - mountPath: /usr/share/elasticsearch/config/elasticsearch.yml\n              name: es7x-config\n              subPath: elasticsearch.yml\n            - mountPath: /usr/share/elasticsearch/config/es_check.sh\n              name: es7x-config\n              subPath: es_check.sh\n            # - mountPath: /usr/share/elasticsearch/config/certs\n            #   name: es-certs\n            #   readOnly: true\n        - env:\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: POD_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.podIP\n            - name: TZ\n              value: Asia/Shanghai\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n            - name: ES_URI\n              value: 'http://elastic:$(ELASTIC_PASSWORD)@localhost:9200'\n            - name: ES_INDICES\n              value: 'true'\n            - name: ES_ALL\n              value: 'true'\n            - name: ES_INDICES_SETTINGS\n              value: 'true'\n          image: 'justwatch/elasticsearch_exporter:1.1.0'\n          imagePullPolicy: IfNotPresent\n          name: elasticsearch-exporter\n          ports:\n            - containerPort: 9114\n              name: tcp-9114\n              protocol: TCP\n          resources:\n            limits:\n              cpu: 200m\n              memory: 200Mi\n      dnsPolicy: ClusterFirst\n      initContainers:\n        - command:\n            - sysctl\n            - '-w'\n            - vm.max_map_count=262144\n          image: 'busybox:1.31.0'\n          imagePullPolicy: IfNotPresent\n          name: increase-vm-max-map\n          securityContext:\n            privileged: true\n            runAsUser: 0\n        - command:\n            - sh\n            - '-c'\n            - ulimit -n 65536\n          image: 'busybox:1.31.0'\n          imagePullPolicy: IfNotPresent\n          name: increase-fd-ulimit\n          securityContext:\n            privileged: true\n            runAsUser: 0\n    #   nodeSelector:\n    #     node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 1000\n        runAsUser: 1000\n        seLinuxOptions:\n          level: 's0:c13,c12'\n    #   serviceAccount: es-logging-sa\n    #   serviceAccountName: es-logging-sa\n      terminationGracePeriodSeconds: 10\n      volumes:\n        - configMap:\n            defaultMode: 493\n            name: es-logging-config\n          name: es7x-config\n        # - name: es-certs\n        #   secret:\n        #     defaultMode: 420\n        #     secretName: es-logging-certs\n  updateStrategy:\n    type: RollingUpdate\n  volumeClaimTemplates:\n    - metadata:\n        labels:\n          name: es-logging\n        name: es7x-data\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 20Gi\n        storageClassName: logging-storageclass\n```\n\n\n\nes集群使用了statefulset方式部署，其中storageclass`logging-storageclass`需要自己手动创建，执行下面的命令完成部署。\n\n```bash\nkubectl apply -f elasticsearch-cluster.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建service -->\n\n```yaml\n# elasticsearch-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: es-logging\n  name: es-logging-service\n  namespace: logging\nspec:\n  ports:\n    - name: tcp-9200\n      port: 9200\n      protocol: TCP\n      targetPort: 9200\n  selector:\n    app: es-logging\n  sessionAffinity: None\n  type: ClusterIP\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: es-logging\n    monitor-app: elasticsearch-exporter\n  name: es-logging-cluster\n  namespace: logging\nspec:\n  clusterIP: None\n  ports:\n    - name: tcp-9300\n      port: 9300\n      protocol: TCP\n      targetPort: 9300\n    - name: tcp-9114\n      port: 9114\n      protocol: TCP\n      targetPort: 9114\n  selector:\n    app: es-logging\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面的命令完成部署：\n\n```bash\nkubeclt apply -f elasticsearch-service.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查\n\n首先确保所有的pod都处于running状态：\n\n```bash\nkubectl get pod -n logging | grep es\n```\n\n<img src=\"./es-pod.png\" style=\"zoom:50%;\" />\n\n\n\n然后执行下面的命令：\n\n```bash\nkubectl logs -f es-logging-1 -n logging -c es-logging\n```\n\n\n\n如果输出的日志中有`Cluster health status changed from [YELLOW] to [GREEN]`，说明集群正常了。\n\n\n\n<br>\n\n\n\n# 部署kafka\n\n## 部署zookeeper\n\n{% tabs comments %}\n\n<!-- tab 部署zookeeper集群 -->\n\n```yaml\n# zookeeper-cluster.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: zk-logging\n  namespace: logging\nspec:\n  podManagementPolicy: Parallel\n  replicas: 3\n  selector:\n    matchLabels:\n      app: zk-logging\n  serviceName: zk-logging-headless\n  template:\n    metadata:\n      labels:\n        app: zk-logging\n    spec:\n    #   affinity:\n    #     podAntiAffinity:\n    #       requiredDuringSchedulingIgnoredDuringExecution:\n    #         - labelSelector:\n    #             matchExpressions:\n    #               - key: app\n    #                 operator: In\n    #                 values:\n    #                   - zk-logging\n    #           topologyKey: kubernetes.io/hostname\n      containers:\n        - env:\n            - name: ZOO_SERVERS\n              value: >-\n                server.1=zk-logging-0.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181\n                server.2=zk-logging-1.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181\n                server.3=zk-logging-2.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181\n            - name: ZOO_4LW_COMMANDS_WHITELIST\n              value: 'ruok,srvr,conf,stat'\n            - name: TZ\n              value: Asia/Shanghai\n          image: 'zookeeper:3.5.7'\n          imagePullPolicy: Always\n          name: zk-logging\n          ports:\n            - containerPort: 2181\n              name: client\n              protocol: TCP\n            - containerPort: 2888\n              name: server\n              protocol: TCP\n            - containerPort: 3888\n              name: leader-election\n              protocol: TCP\n          resources:\n            requests:\n              cpu: 500m\n              memory: 500Mi\n          volumeMounts:\n            - mountPath: /data\n              name: datadir\n      dnsPolicy: ClusterFirst\n      initContainers:\n        - command:\n            - sh\n            - '-c'\n            - >-\n              echo $(( $(echo ${POD_NAME} | awk -F \"-\" '{print $NF}') + 1 )) >\n              /data/myid\n          env:\n            - name: POD_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n          image: 'busybox:1.31.0'\n          imagePullPolicy: IfNotPresent\n          name: init-zk-logging\n          resources: {}\n          volumeMounts:\n            - mountPath: /data\n              name: datadir\n    #   nodeSelector:\n        # node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 1000\n        runAsUser: 1000\n    #   serviceAccount: zk-logging-sa\n    #   serviceAccountName: zk-logging-sa\n      terminationGracePeriodSeconds: 30\n  updateStrategy:\n    type: RollingUpdate\n  volumeClaimTemplates:\n    - metadata:\n        creationTimestamp: null\n        name: datadir\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 5Gi\n        storageClassName: logging-storageclass\n```\n\n\n\n使用下面的命令完成部署：\n\n```bash\nkubectl apply -f zookeeper-cluster.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署service对象 -->\n\n```yaml\n# zookeeper-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: zk-logging\n  name: zk-logging-service\n  namespace: logging\nspec:\n  ports:\n    - name: client\n      port: 2181\n      protocol: TCP\n      targetPort: 2181\n  selector:\n    app: zk-logging\n  sessionAffinity: None\n  type: ClusterIP\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: zk-logging\n  name: zk-logging-headless\n  namespace: logging\nspec:\n  clusterIP: None\n  ports:\n    - name: server\n      port: 2888\n      protocol: TCP\n      targetPort: 2888\n    - name: leader-election\n      port: 3888\n      protocol: TCP\n      targetPort: 3888\n  selector:\n    app: zk-logging\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面命令完成部署：\n\n```bash\nkubectl apply -f zookeeper-service.yaml\n```\n\n\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 部署kafka\n\n{% tabs comments %}\n\n<!-- tab 部署kafka集群 -->\n\n```yaml\n# kafka-cluster.yaml\napiVersion: apps/v1\nkind: StatefulSet\nmetadata:\n  name: kafka-logging\n  namespace: logging\nspec:\n  podManagementPolicy: Parallel\n  replicas: 3\n  selector:\n    matchLabels:\n      app: kafka-logging\n  serviceName: kafka-logging-service\n  template:\n    metadata:\n      labels:\n        app: kafka-logging\n    spec:\n    #   affinity:\n    #     podAntiAffinity:\n    #       requiredDuringSchedulingIgnoredDuringExecution:\n    #         - labelSelector:\n    #             matchExpressions:\n    #               - key: app\n    #                 operator: In\n    #                 values:\n    #                   - kafka-logging\n    #           topologyKey: kubernetes.io/hostname\n      containers:\n        - env:\n            - name: KAFKA_REPLICAS\n              value: '3'\n            - name: KAFKA_ZK_LOCAL\n              value: 'false'\n            - name: KAFKA_HEAP_OPTS\n              value: '-Xmx1024M -Xms1024M'\n            - name: SERVER_num_partitions\n              value: '3'\n            - name: SERVER_delete_topic_enable\n              value: 'true'\n            - name: SERVER_log_retention_hours\n              value: '2147483647'\n            - name: KAFKA_ADVERTISED_PORT\n              value: '9092'\n            - name: SERVER_zookeeper_connection_timeout_ms\n              value: '6000'\n            - name: SERVER_log_dirs\n              value: /opt/kafka/data/logs\n            - name: KAFKA_ADVERTISED_HOST_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: KAFKA_ZOOKEEPER_CONNECT\n              value: 'zk-logging-service.logging.svc.cluster.local:2181'\n            - name: BROKER_ID_COMMAND\n              value: 'hostname | awk -F ''-'' ''{print $NF}'''\n            - name: KAFKA_PORT_NUMBER\n              value: '9092'\n            - name: KAFKA_ADVERTISED_HOST_NAME\n              value: >-\n                $(KAFKA_ADVERTISED_HOST_NAME).kafka-logging-service.logging.svc.cluster.local\n            - name: TZ\n              value: Asia/Shanghai\n          image: 'wurstmeister/kafka:2.12-2.5.0'\n          imagePullPolicy: Always\n          name: kafka-logging\n          ports:\n            - containerPort: 9092\n              name: server\n              protocol: TCP\n          resources:\n            requests:\n              cpu: 500m\n              memory: 500Mi\n          volumeMounts:\n            - mountPath: /kafka\n              name: datadir\n      dnsPolicy: ClusterFirst\n    #   nodeSelector:\n    #     node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 0\n        runAsUser: 0\n    #   serviceAccount: kafka-logging-sa\n    #   serviceAccountName: kafka-logging-sa\n      terminationGracePeriodSeconds: 30\n  updateStrategy:\n    type: RollingUpdate\n  volumeClaimTemplates:\n    - metadata:\n        creationTimestamp: null\n        name: datadir\n      spec:\n        accessModes:\n          - ReadWriteOnce\n        resources:\n          requests:\n            storage: 20Gi\n        storageClassName: logging-storageclass\n```\n\n\n\n使用下面的命令完成部署：\n\n```bash\nkubectl apply -f kafka-cluster.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署service对象 -->\n\n```yaml\n# kafka-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: kafka-logging\n  name: kafka-logging-service\n  namespace: logging\nspec:\n  clusterIP: None\n  ports:\n    - name: server\n      port: 9092\n      protocol: TCP\n      targetPort: 9092\n  selector:\n    app: kafka-logging\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面命令完成部署：\n\n```bash\nkubectl apply -f kafka-service.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署kafka-manager -->\n\nkafka-manager是kafka的一个web管理平台，这里部署一下方便在有需要时进行管理。\n\n```yaml\n# kafka-manager.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: kafka-manager\n  name: kafka-manager\n  namespace: logging\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: kafka-manager\n  strategy:\n    rollingUpdate:\n      maxSurge: 25%\n      maxUnavailable: 25%\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: kafka-manager\n    spec:\n      containers:\n        - env:\n            - name: ZK_HOSTS\n              value: 'zk-logging-service.logging.svc:2181'\n            - name: TZ\n              value: Asia/Shanghai\n          image: 'kafkamanager/kafka-manager:2.0.0.2'\n          imagePullPolicy: IfNotPresent\n          name: kafka-manager\n          ports:\n            - containerPort: 9000\n              name: tcp-9000\n              protocol: TCP\n          resources: {}\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n---\napiVersion: v1\nkind: Service\nmetadata:\n  labels:\n    app: kafka-manager\n  name: kafka-manager\n  namespace: logging\nspec:\n  ports:\n    - name: kafka-manager\n      port: 9000\n      protocol: TCP\n      targetPort: 9000\n  selector:\n    app: kafka-manager\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面命令完成部署：\n\n```bash\nkubectl apply -f kafka-manager.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建ingress -->\n\n```yaml\n# kafka-manager-ingress.yaml\nkind: Ingress\nmetadata:\n   name: kafka-manager\n   namespace: logging\nspec:\n   rules:\n   - host: kafka-manager.example.com\n     http:\n       paths:\n       - path: /\n         backend:\n          serviceName: kafka-manager\n          servicePort: 9000\n```\n\n\n\n执行下面的命令完成创建：\n\n```bash\nkubectl apply -f kafka-manager-ingress.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查服务\n\n检查所有的pod都正常运行：\n\n```bash\nkubectl get pod,svc,ingress -n logging | grep -E 'kafka|zk'\n```\n\n<img src=\"./kafka-pod.png\" style=\"zoom:50%;\" />\n\n\n\n## 创建nginx配置\n\n在nginx服务器上增加kafka-manager配置，代理kafka服务：\n\n```nginx\n# /etc/nginx/conf.d/kafka-manager.conf\nupstream ingress-80 {\n    server 10.8.138.9:80 max_fails=3 fail_timeout=5s weight=2;\n    server 10.8.138.11:80 max_fails=3 fail_timeout=5s weight=2;\n}\n\nserver {\n    listen 80;\n    server_name kafka-manager.example.com;\n    rewrite ^(.*) https://$host$1 permanent;\n}\n\nserver {\n    listen 443 ssl;\n    server_name kafka-manager.example.com;\n\n    ssl_certificate /etc/nginx/ssl/nginx.crt;\n    ssl_certificate_key /etc/nginx/ssl/nginx.key;\n\n    access_log /var/log/nginx/kafka-manager.example.com_access.log main;\n    error_log /var/log/nginx/kafka-manager.example.com_error.log;\n\n    location / {\n      proxy_pass http://ingress-80;\n      proxy_set_header Host $http_host;\n    }\n\n    include conf.d/common.ini;\n}\n```\n\n\n\n检查配置并重载nginx：\n\n```bash\nnginx -t \nnginx -s reload \n```\n\n\n\n## 访问并配置kafka-manager\n\n通过浏览器访问kafka-manager的域名`kafka-manager.example.com`即可进入kafka-manager的控制页面，点击上边的`Cluster`，然后选择`Add Cluster`添加kafka集群，需要填入下面几个信息：\n\n<img src=\"./add-cluster-1.png\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"./add-cluster-2.png\" style=\"zoom:50%;\" />\n\n\n\n最后点击`save`后集群信息添加完成。\n\n\n\n<br>\n\n\n\n# 部署logstash\n\n##  创建logstash配置\n\nlogstash相关的配置文件可以在[logstash配置文件](https://github.com/liyongzhezz/yaml/tree/master/EFK-kafka日志收集) 找到，这里需要将`efk-template.json`, `init_efk.sh`, `k8s-log.json`, `logstash.conf`, `logstash.yml`, `systemd-log.json` 放入一个目录下，例如`logstash-conf`下：\n\n- `efk-template.json`：定义的是针对索引的日志策略；\n- `init_efk.sh`：操作es ，初始化一些配置；\n- `k8s-log.json`：收集k8s日志的配置；\n- `logstash.conf`：logstash的流水线配置；\n- `logstash.yml`：logstash配置文件；\n- `systemd-log.json`：收集系统日志的配置；\n\n\n\n然后执行下面的命令：\n\n```bash\nkubectl create configmap logstash-logging-config --from-file=./logstash-conf/ -n logging \n```\n\n\n\n<img src=\"./configmap.png\" style=\"zoom:50%;\" />\n\n\n\n## 部署logstash\n\nlogstash不需要很多实例，所以使用`deployment`方式部署，可以根据需要进行扩展：\n\n```yaml\n# logstash-deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: logstash-logging\n  name: logstash-logging\n  namespace: logging\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: logstash-logging\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: logstash-logging\n      name: logstash-logging\n    spec:\n      containers:\n        - env:\n            - name: TZ\n              value: Asia/Shanghai\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'logstash:7.8.0'\n          imagePullPolicy: IfNotPresent\n          name: logstash-logging\n          ports:\n            - containerPort: 5044\n              name: tcp-5044\n              protocol: TCP\n            - containerPort: 9600\n              name: tcp-9600\n              protocol: TCP\n          resources: {}\n          securityContext:\n            privileged: true\n            runAsUser: 1000\n          volumeMounts:\n            - mountPath: /usr/share/logstash/config/logstash.yml\n              name: logstash-config\n              subPath: logstash.yml\n            - mountPath: /usr/share/logstash/pipeline/logstash.conf\n              name: logstash-config\n              subPath: logstash.conf\n            - mountPath: /usr/share/logstash/config/efk-template.json\n              name: logstash-config\n              subPath: efk-template.json\n      dnsPolicy: ClusterFirst\n      initContainers:\n        - command:\n            - sh\n            - '-c'\n            - /bin/init_efk.sh\n          env:\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'curlimages/curl:latest'\n          imagePullPolicy: Always\n          name: init-efk\n          resources: {}\n          volumeMounts:\n            - mountPath: /bin/init_efk.sh\n              name: logstash-config\n              subPath: init_efk.sh\n            - mountPath: /tmp/k8s-log.json\n              name: logstash-config\n              subPath: k8s-log.json\n            - mountPath: /tmp/systemd-log.json\n              name: logstash-config\n              subPath: systemd-log.json\n    #   nodeSelector:\n    #     node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      securityContext:\n        fsGroup: 1000\n        runAsUser: 1000\n        seLinuxOptions:\n          level: 's0:c13,c12'\n      terminationGracePeriodSeconds: 30\n      volumes:\n        - configMap:\n            defaultMode: 493\n            name: logstash-logging-config\n          name: logstash-config\n```\n\n\n\n直接运行下面的命令部署logstash：\n\n```bash\nkubectl apply -f logstash-deployment.yaml\n```\n\n\n\n## 检查服务\n\n确保所有的pod都处于Running状态：\n\n```bash\nkubectl get pod -n logging | grep logstash\n```\n\n<img src=\"./logstash-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n# 部署filebeat\n\n## 部署相关资源\n\n{% tabs comments %}\n\n<!-- tab 创建权限 -->\n\n```yaml\n# filebeat-rbac.yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: filebeat-logging-sa\n  namespace: logging\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRoleBinding\nmetadata:\n  name: filebeat-logging-bind\nsubjects:\n- kind: ServiceAccount\n  name: filebeat-logging-sa\n  namespace: logging\nroleRef:\n  kind: ClusterRole\n  name: filebeat-logging-clusterrole\n  apiGroup: rbac.authorization.k8s.io\n---\napiVersion: rbac.authorization.k8s.io/v1beta1\nkind: ClusterRole\nmetadata:\n  name: filebeat-logging-clusterrole\nrules:\n- apiGroups: [\"\"] # \"\" indicates the core API group\n  resources:\n  - namespaces\n  - pods\n  verbs:\n  - get\n  - watch\n  - list\n```\n\n\n\n执行下面的命令完成创建：\n\n```yaml\nkubectl apply -f filebeat-rbac.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建相关配置 -->\n\n```yaml\n# filebeat-configmap.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: filebeat-logging-config\n  namespace: logging\ndata:\n  filebeat.yml: |\n    name: \"filebeat-k8s\"\n    filebeat.registry.path: /var/log/filebeat/registry\n    logging.level: warning\n    filebeat.inputs:\n    - type: container\n      scan_frequency: 5s\n      enable: true\n      symlinks: false\n      harvester_buffer_size: 16384\n      max_bytes: 10485760\n      paths:\n      - /var/lib/docker/containers/*/*-json.log\n      multiline.pattern: '^[[:space:]]+.+\\b|^Caused by:|^[[:alpha:]]+.+Exception:\\s\\w+.+|^[[:alpha:]]+.+Exception$|^Exception\\s\\w+.+'\n      multiline.negate: false\n      multiline.match: after\n      multiline.max_lines: 500\n      multiline.timeout: 5s\n      fields_under_root: true\n      overwrite_keys: true\n\n    - type: log\n      scan_frequency: 5s\n      enable: true\n      symlinks: false\n      harvester_buffer_size: 16384\n      max_bytes: 10485760\n      paths:\n      - /var/log/messages\n      fields_under_root: true\n      overwrite_keys: true\n\n    processors:\n      - add_kubernetes_metadata:\n          in_cluster: true\n      - add_host_metadata: \n          netinfo.enabled: true\n      - add_locale: ~\n      - add_fields:\n          target: host\n          fields:\n            name: ${NODE_NAME}\n            ip: ${NODE_IP}\n            podip: ${POD_IP}\n      - drop_fields:\n          fields: [\"agent.ephemeral_id\",\"agent.id\",\"log.offset\",\"suricata.eve.timestamp\",\"host.os.codename\",\"host.hostname\"]\n          ignore_missing: false\n\n    output.kafka:\n      hosts: [\"kafka-logging-service:9092\"]\n      version: 2.0.0\n      worker: 3\n      topics: \n        - topic: \"k8s-log.%{[kubernetes.namespace]}\"\n          when.contains: \n            input.type: \"container\"\n        - topic: \"systemd-log.%{[host.name]}\"\n          when.contains: \n            input.type: \"log\"\n      partition.round_robin:\n        reachable_only: false\n      required_acks: 1\n      compression: gzip\n      max_message_bytes: 1000000\n\n\n    xpack.monitoring.enabled: true\n    xpack.monitoring.elasticsearch.hosts: [ \"es-logging-service:9200\" ]\n    xpack.monitoring.elasticsearch.protocol: \"http\"\n    xpack.monitoring.elasticsearch.username: \"elastic\" \n    xpack.monitoring.elasticsearch.password: \"${ELASTIC_PASSWORD}\"\n```\n\n\n\n在配置文件中，指定filebeat去读取docker日志和系统日志，并将日志发送给kafka。filebeat本身不对日志进行处理。执行下面的命令完成创建：\n\n```bash\nkubectl apply -f filebeat-configmap.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署filebeat -->\n\n每一个工作节点都需要收集日志，所以使用daemonset方式进行部署：\n\n```yaml\n# fileat-daemonset.yaml\napiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  labels:\n    app: filebeat-logging\n    version: v1\n  name: filebeat-logging\n  namespace: logging\nspec:\n  selector:\n    matchLabels:\n      app: filebeat-logging\n      version: v1\n  template:\n    metadata:\n      labels:\n        app: filebeat-logging\n        version: v1\n    spec:\n      containers:\n        - args:\n            - '-c'\n            - /home/filebeat-config/filebeat.yml\n            - '-e'\n          env:\n            - name: TZ\n              value: Asia/Shanghai\n            - name: POD_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.podIP\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: spec.nodeName\n            - name: NODE_IP\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: status.hostIP\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'elastic/filebeat:7.6.8'\n          imagePullPolicy: IfNotPresent\n          name: filebeat-logging\n          securityContext:\n            privileged: true\n            runAsUser: 0\n          volumeMounts:\n            - mountPath: /var/log\n              name: filebeat-storage\n            - mountPath: /var/log/pods\n              name: varlogpods\n            - mountPath: /var/lib/docker/containers\n              name: varlibdockercontainers\n            - mountPath: /home/filebeat-config\n              name: filebeat-volume\n      dnsPolicy: ClusterFirst\n      restartPolicy: Always\n      serviceAccount: filebeat-logging-sa\n      serviceAccountName: filebeat-logging-sa\n      terminationGracePeriodSeconds: 30\n      volumes:\n        - hostPath:\n            path: /var/log\n            type: ''\n          name: filebeat-storage\n        - hostPath:\n            path: /var/log/pods\n            type: ''\n          name: varlogpods\n        - hostPath:\n            path: /var/lib/docker/containers\n            type: ''\n          name: varlibdockercontainers\n        - configMap:\n            defaultMode: 420\n            name: filebeat-logging-config\n          name: filebeat-volume\n  updateStrategy:\n    rollingUpdate:\n      maxUnavailable: 1\n    type: RollingUpdate\n```\n\n\n\n在yaml文件中，将`/var/lib/docker/containers`和`/var/log`挂载到了容器中，方便容器进行日志收集。\n\n```bash\nkubectl apply -f filebeat-daemonset.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查服务\n\n确保所有pod都正常运行：\n\n```bash\nkubectl get pod -n logging | grep filebeat\n```\n\n<img src=\"./pod.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n# 部署kibana\n\n## 部署相关资源\n\n{% tabs comments %}\n\n<!-- tab 创建初始化配置 -->\n\nKibana相关的配置文件可以在[kibana配置文件](https://github.com/liyongzhezz/yaml/tree/master/EFK-kafka日志收集) 找到，这里需要将`init_kibana.sh` 放入一个目录下，例如`kibana-conf`下，然后执行下面的命令：\n\n```bash\nkubectl create configmap kibana-logging-init-config --from-file=./kibana-conf/init_kibana.sh -n logging\n```\n\n<!-- endtab -->\n\n<!-- tab 创建配置文件 -->\n\n```yaml\n# kibana-config.yaml\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: kibana-logging-config\n  namespace: logging\ndata:\n  kibana.yml: |\n    server.port: 5601\n    server.host: \"0.0.0.0\"\n    server.name: \"kibana-logging\"\n    elasticsearch.hosts: [\"http://es-logging-service:9200\"]\n    xpack.monitoring.ui.container.elasticsearch.enabled: true\n    xpack.security.enabled: true\n    elasticsearch.username: \"kibana\"\n    elasticsearch.password: \"${KIBANA_PASSWORD}\"\n    elasticsearch.requestHeadersWhitelist: [ 'es-security-runas-user',\n    'authorization', 'X-Proxy-Remote-User', 'x-forwarded-for',\n    'x-forwarded-access-token' ]\n    elasticsearch.requestTimeout: 300000\n    kibana.index: \".kibana\"\n    logging.quiet: true\n  kibana_check.sh: |\n    #!/bin/bash\n    KIBANA_REST_BASEURL=http://localhost:5601/login\n    EXPECTED_RESPONSE_CODE=200\n    max_time=\"${max_time:-4}\"\n\n    response_code=\"$(\n        curl --silent                          \\\n             --request HEAD                    \\\n             --head                            \\\n             --output /dev/null                \\\n             --max-time \"${max_time}\"          \\\n             --write-out '%{response_code}'    \\\n             \"${KIBANA_REST_BASEURL}\"\n    )\"\n\n    if [ \"${response_code}\" == \"${EXPECTED_RESPONSE_CODE}\" ]; then\n        exit 0\n    else\n        echo \"Kibana node is not ready to accept HTTP requests yet [response code: ${response_code}]\"\n        exit 1\n    fi\n```\n\n\n\n执行下面的命令完成部署：\n\n```bash\nkubectl apply -f kibana-config.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 部署kibana -->\n\n```yaml\n# kibana-deployment.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: kibana-logging\n  name: kibana-logging\n  namespace: logging\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: kibana-logging\n  strategy:\n    rollingUpdate:\n      maxSurge: 1\n      maxUnavailable: 1\n    type: RollingUpdate\n  template:\n    metadata:\n      labels:\n        app: kibana-logging\n      name: kibana-logging\n    spec:\n      containers:\n        - env:\n            - name: NODE_NAME\n              valueFrom:\n                fieldRef:\n                  apiVersion: v1\n                  fieldPath: metadata.name\n            - name: TZ\n              value: Asia/Shanghai\n            - name: KIBANA_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'kibana:7.8.0'\n          name: kibana-logging\n          imagePullPolicy: IfNotPresent\n          livenessProbe:\n            exec:\n              command:\n                - sh\n                - '-c'\n                - /usr/share/kibana/config/kibana_check.sh\n            failureThreshold: 3\n            initialDelaySeconds: 60\n            periodSeconds: 20\n            successThreshold: 1\n            timeoutSeconds: 1\n          ports:\n            - containerPort: 5601\n              name: tcp-5601\n              protocol: TCP\n          readinessProbe:\n            exec:\n              command:\n                - sh\n                - '-c'\n                - /usr/share/kibana/config/kibana_check.sh\n            failureThreshold: 3\n            initialDelaySeconds: 15\n            periodSeconds: 10\n            successThreshold: 1\n            timeoutSeconds: 1\n          resources:\n            limits:\n              cpu: '2'\n              memory: 2Gi\n            requests:\n              cpu: 500m\n              memory: 500Mi\n          volumeMounts:\n            - mountPath: /usr/share/kibana/config/kibana.yml\n              name: kibana-config\n              subPath: kibana.yml\n            - mountPath: /usr/share/kibana/config/kibana_check.sh\n              name: kibana-config\n              subPath: kibana_check.sh\n      dnsPolicy: ClusterFirst\n      initContainers:\n        - command:\n            - sh\n            - '-c'\n            - /bin/init_kibana.sh\n          env:\n            - name: ELASTIC_PASSWORD\n              valueFrom:\n                secretKeyRef:\n                  key: elastic\n                  name: es-logging-password\n          image: 'curlimages/curl:latest'\n          imagePullPolicy: Always\n          name: init-kibana\n          resources: {}\n          volumeMounts:\n            - mountPath: /bin/init_kibana.sh\n              name: kibana-init\n              subPath: init_kibana.sh\n    #   nodeSelector:\n    #     node-role.kubernetes.io/compute: 'true'\n      restartPolicy: Always\n      terminationGracePeriodSeconds: 30\n      volumes:\n        - configMap:\n            defaultMode: 493\n            name: kibana-logging-config\n          name: kibana-config\n        - configMap:\n            defaultMode: 493\n            name: kibana-logging-init-config\n          name: kibana-init\n```\n\n\n\n执行下面的命令完成部署：\n\n```bash\nkubectl apply -f kibana-deployment.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建service对象 -->\n\n```yaml\n# kibana-service.yaml\napiVersion: v1\nkind: Service\nmetadata:\n  name: kibana-logging-service\n  namespace: logging\nspec:\n  ports:\n    - name: tcp-5601\n      port: 5601\n      protocol: TCP\n      targetPort: 5601\n  selector:\n    app: kibana-logging\n  sessionAffinity: None\n  type: ClusterIP\n```\n\n\n\n执行下面的命令完成创建：\n\n```bash\nkubectl apply -f kibana-service.yaml\n```\n\n<!-- endtab -->\n\n<!-- tab 创建ingress对象 -->\n\n```yaml\n# kibana-ingress.yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n   name: kibana\n   namespace: logging\nspec:\n   rules:\n   - host: kibana.example.com\n     http:\n       paths:\n       - path: /\n         backend:\n          serviceName: kibana-logging-service\n          servicePort: 5601\n```\n\n\n\n执行下面的命令完成创建：\n\n```bash\nkubectl apply -f kibana-ingress.yaml\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 配置nginx暴露服务\n\n新增下面的nginx配置:\n\n```nginx\n# /etc/nginx/conf.d/kibana.conf\nupstream ingress-80 {\n    server 10.8.138.9:80 max_fails=3 fail_timeout=5s weight=2;\n    server 10.8.138.11:80 max_fails=3 fail_timeout=5s weight=2;\n}\n\nserver {\n    listen 80;\n    server_name kibana.example.com;\n    rewrite ^(.*) https://$host$1 permanent;\n}\n\nserver {\n    listen 443 ssl;\n    server_name kibana.example.com;\n\n    ssl_certificate /etc/nginx/ssl/nginx.crt;\n    ssl_certificate_key /etc/nginx/ssl/nginx.key;\n\n    access_log /var/log/nginx/kibana.example.com_access.log main;\n    error_log /var/log/nginx/kibana.example.com_error.log;\n\n    location / {\n      proxy_pass http://ingress-80;\n      proxy_set_header Host $http_host;\n    }\n\n    include conf.d/common.ini;\n}\n```\n\n\n\n检查并重载nginx：\n\n```bash\nnginx -t\nnginx -s reload\n```\n\n\n\n## 检查服务\n\n确保相关pod都处在Running状态：\n\n```bash\nkubectl get pod,svc,ingress -n logging | grep kibana\n```\n\n<img src=\"./kibana-pod.png\" style=\"zoom:50%;\" />\n\n\n\n## 访问页面\n\n通过浏览器访问`kibana.example.com`即可进入kibana的页面，输入在部署elasticsearch中设置的初始账号密码：`elastic/elastic`。然后在kibana中创建`Index patterns`就可以了。\n\n<img src=\"./kibana.png\" style=\"zoom:50%;\" />\n\n\n\n访问kafka-manager观察，发现消息topic也创建出来并且有消息在队列中被logstash消费：\n\n<img src=\"./kafka.png\" style=\"zoom:50%;\" />\n\n\n\n","slug":"在k8s中使用EFLK进行日志收集","published":1,"updated":"2021-03-27T05:20:12.991Z","_id":"ckmr8oskh00003nklevtyder2","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用filebeat、kafka、logstash、elasticsearch、kibana进行日志收集</p><p>更新于 2021-03-27</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"架构方案\"><a href=\"#架构方案\" class=\"headerlink\" title=\"架构方案\"></a>架构方案</h1><h2 id=\"架构\"><a href=\"#架构\" class=\"headerlink\" title=\"架构\"></a>架构</h2><p>整体收集方案使用如下的组件：</p>\n<ul>\n<li><code>filebeat</code>：采集节点和容器日志，发送到kafka；</li>\n<li><code>kafka</code>：接收filebeat发送的日志消息；</li>\n<li><code>logstash</code>：从kafka中消费日志消息并进行处理；</li>\n<li><code>elasticsearch</code>：进行日志存储；</li>\n<li><code>kibana</code>：日志可视化展示；</li>\n</ul>\n<blockquote>\n<p>日志文件 –&gt; filebeat –&gt; kafka –&gt; logstash –&gt; elasticsearch –&gt; kibana</p>\n</blockquote>\n<h2 id=\"版本选择\"><a href=\"#版本选择\" class=\"headerlink\" title=\"版本选择\"></a>版本选择</h2><ul>\n<li><code>filebeat</code>：7.6.2；</li>\n<li><code>kafka</code>：2.12-2.5.0；</li>\n<li><code>zookeeper</code>：3.5.7；</li>\n<li><code>logstash</code>：7.8.0；</li>\n<li><code>elasticsearch</code>：7.8.0；</li>\n<li><code>kibana</code>：7.8.0；</li>\n</ul>\n<h2 id=\"方案可能存在的问题\"><a href=\"#方案可能存在的问题\" class=\"headerlink\" title=\"方案可能存在的问题\"></a>方案可能存在的问题</h2><p>这套日志收集方案可能存在下面的问题：</p>\n<ul>\n<li>elasticsearch可能存在瓶颈（es还需要进一步调优）；</li>\n<li>logstash会根据写入es的速度调整消息消费的速度，所有kafka有时候会出现消息堆积的情况；</li>\n<li>……</li>\n</ul>\n<br>\n\n\n\n<h1 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">准备nfs相关资源</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建namespace</button></li><li class=\"tab\"><button data-href=\"#comments-3\">设置elasticsearch密码</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>这里使用nfs作为底层存储，相关的创建方法可以参考：<a href=\"/2021/03/23/%E5%9C%A8k8s%E4%B8%AD%E4%BD%BF%E7%94%A8nfs%E5%AD%98%E5%82%A8/\" title=\"在k8s中使用nfs存储\">在k8s中使用nfs存储</a>，当然也可以使用其他的存储系统。</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>使用下面的yaml文件创建一个namespace：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># namesapce.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">logging</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f namespace.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>elasticsearch开启x-pack认证功能，这里将elasticsearch的密码保存在secret资源中：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">espassword=<span class=\"string\">&quot;elastic&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create secret generic es-logging-password --from-literal=elastic=<span class=\"string\">&#x27;elastic&#x27;</span> -n logging</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>这里讲elasticsearch密码设置为：<code>elastic</code></p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署elasticsearch\"><a href=\"#部署elasticsearch\" class=\"headerlink\" title=\"部署elasticsearch\"></a>部署elasticsearch</h1><h2 id=\"部署相关资源\"><a href=\"#部署相关资源\" class=\"headerlink\" title=\"部署相关资源\"></a>部署相关资源</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建elasticsearch配置</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建elasticsearch集群</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建service</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># elasticsearch-config.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">elasticsearch.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"attr\">cluster.name:</span> <span class=\"string\">es-logging-cluster</span></span><br><span class=\"line\">    <span class=\"attr\">node.name:</span> <span class=\"string\">$&#123;NODE_NAME&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">network.host:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">http.port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">    <span class=\"attr\">transport.port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">    <span class=\"attr\">discovery.seed_hosts:</span> [<span class=\"string\">&quot;es-logging-cluster&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">cluster.initial_master_nodes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">es-logging-0</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">es-logging-1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">es-logging-2</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.collection.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.security.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.license.self_generated.type:</span> <span class=\"string\">basic</span></span><br><span class=\"line\">    <span class=\"attr\">indices.lifecycle.history_index_enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.ilm.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"attr\">cluster.routing.allocation.disk.threshold_enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.enabled: true</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.verification_mode: certificate</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.key: certs/es-logging-service.key</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.certificate: certs/es-logging-service.crt</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.certificate_authorities: certs/ca.crt</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.http.ssl.enabled: false</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.authc.realms:</span></span><br><span class=\"line\">    <span class=\"comment\">#   native.realm1:</span></span><br><span class=\"line\">    <span class=\"comment\">#     order: 0</span></span><br><span class=\"line\">  <span class=\"attr\">es_check.sh:</span> <span class=\"string\">&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">ES_REST_BASEURL=http://localhost:9200</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">EXPECTED_RESPONSE_CODE=200</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">max_time=$&#123;READINESS_PROBE_TIMEOUT:-30&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">function</span> <span class=\"string\">check_if_ready()</span> &#123;</span><br><span class=\"line\">      <span class=\"string\">path=&quot;$1&quot;</span></span><br><span class=\"line\">      <span class=\"string\">err_msg=&quot;$2&quot;</span></span><br><span class=\"line\">      <span class=\"string\">response_code=$(curl</span> <span class=\"string\">-s</span> <span class=\"string\">-k</span> <span class=\"string\">--head</span> <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">-u</span> <span class=\"string\">elastic:$</span>&#123;<span class=\"string\">ELASTIC_PASSWORD</span>&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">--max-time</span> <span class=\"string\">$max_time</span> <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">-o</span> <span class=\"string\">/dev/null</span> <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">-w</span> <span class=\"string\">&#x27;<span class=\"template-variable\">%&#123;response_code&#125;</span>&#x27;</span> <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">&quot;$&#123;ES_REST_BASEURL&#125;$&#123;path&#125;&quot;</span><span class=\"string\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"string\">if</span> [ <span class=\"string\">&quot;$&#123;response_code&#125;&quot;</span> <span class=\"type\">!=</span> <span class=\"string\">$</span>&#123;<span class=\"string\">EXPECTED_RESPONSE_CODE</span>&#125; ]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">        <span class=\"string\">echo</span> <span class=\"string\">&quot;$&#123;err_msg&#125; [response code: $&#123;response_code&#125;]&quot;</span></span><br><span class=\"line\">        <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"string\">fi</span></span><br><span class=\"line\">      <span class=\"string\">exit</span> <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">check_if_ready</span> <span class=\"string\">&quot;/&quot;</span> <span class=\"string\">&quot;Elasticsearch node is not ready to accept HTTP requests yet&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>配置中的相关参数解释：</p>\n<ul>\n<li><code>cluster.name</code>：设置es集群名称，用于唯一标识一个集群；</li>\n<li><code>network.host</code>：监听的地址；</li>\n<li><code>discovery.seed_hosts</code>：节点发现方式；</li>\n<li><code>xpack.security.enabled</code>起用xpack安全组件；</li>\n<li><code>cluster.routing.allocation.disk.threshold_enabled</code>是否启动磁盘分配器；</li>\n</ul>\n<blockquote>\n<p><code>cluster.routing.allocation.disk.threshold_enabled</code>这个参数这里设置为false，表示关闭磁盘分配器，这样es可以使用全部磁盘空间。默认情况下当磁盘空间大于85%后，es就不能再创建分片了。这个参数在es使用同一个后端存储的时候应该调节一下。<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#disk-based-shard-allocation\">相关文档</a></p>\n</blockquote>\n<p>es启用了x-pack密码认证，并且通过脚本检查es是否正常启动。我这里将es https通信方式注释掉了，如果有需要可以生成相关证书并起用https配置。直接运行下面的命令创建es配置：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f elasticsearch-config.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>使用下面的yaml文件创建一个namespace：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># elasticsearch-cluster.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">es-logging-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"comment\">#   affinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#     podAntiAffinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#       requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">    <span class=\"comment\">#         - labelSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#             matchExpressions:</span></span><br><span class=\"line\">    <span class=\"comment\">#               - key: app</span></span><br><span class=\"line\">    <span class=\"comment\">#                 operator: In</span></span><br><span class=\"line\">    <span class=\"comment\">#                 values:</span></span><br><span class=\"line\">    <span class=\"comment\">#                   - es-logging</span></span><br><span class=\"line\">    <span class=\"comment\">#           topologyKey: kubernetes.io/hostname</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_JAVA_OPTS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;-Xms2g -Xmx2g&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;docker.elastic.co/elasticsearch/elasticsearch:7.8.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">exec:</span></span><br><span class=\"line\">              <span class=\"attr\">command:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">/usr/share/elasticsearch/config/es_check.sh</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9200</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9300</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">exec:</span></span><br><span class=\"line\">              <span class=\"attr\">command:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">/usr/share/elasticsearch/config/es_check.sh</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">&#x27;2&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/data</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">es7x-data</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">es7x-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">elasticsearch.yml</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/config/es_check.sh</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">es7x-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">es_check.sh</span></span><br><span class=\"line\">            <span class=\"comment\"># - mountPath: /usr/share/elasticsearch/config/certs</span></span><br><span class=\"line\">            <span class=\"comment\">#   name: es-certs</span></span><br><span class=\"line\">            <span class=\"comment\">#   readOnly: true</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_URI</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;http://elastic:$(ELASTIC_PASSWORD)@localhost:9200&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_INDICES</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_ALL</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_INDICES_SETTINGS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;justwatch/elasticsearch_exporter:1.1.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">elasticsearch-exporter</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9114</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9114</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">200m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">200Mi</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sysctl</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-w&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">vm.max_map_count=262144</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;busybox:1.31.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">increase-vm-max-map</span></span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">ulimit</span> <span class=\"string\">-n</span> <span class=\"number\">65536</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;busybox:1.31.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">increase-fd-ulimit</span></span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#     node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">fsGroup:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">seLinuxOptions:</span></span><br><span class=\"line\">          <span class=\"attr\">level:</span> <span class=\"string\">&#x27;s0:c13,c12&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccount: es-logging-sa</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccountName: es-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">493</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">es-logging-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">es7x-config</span></span><br><span class=\"line\">        <span class=\"comment\"># - name: es-certs</span></span><br><span class=\"line\">        <span class=\"comment\">#   secret:</span></span><br><span class=\"line\">        <span class=\"comment\">#     defaultMode: 420</span></span><br><span class=\"line\">        <span class=\"comment\">#     secretName: es-logging-certs</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">        <span class=\"attr\">labels:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">es7x-data</span></span><br><span class=\"line\">      <span class=\"attr\">spec:</span></span><br><span class=\"line\">        <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">storage:</span> <span class=\"string\">20Gi</span></span><br><span class=\"line\">        <span class=\"attr\">storageClassName:</span> <span class=\"string\">logging-storageclass</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>es集群使用了statefulset方式部署，其中storageclass<code>logging-storageclass</code>需要自己手动创建，执行下面的命令完成部署。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f elasticsearch-cluster.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># elasticsearch-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp-9200</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">    <span class=\"attr\">monitor-app:</span> <span class=\"string\">elasticsearch-exporter</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp-9300</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp-9114</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9114</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9114</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeclt apply -f elasticsearch-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查\"><a href=\"#检查\" class=\"headerlink\" title=\"检查\"></a>检查</h2><p>首先确保所有的pod都处于running状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n logging | grep es</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./es-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<p>然后执行下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl logs -f es-logging-1 -n logging -c es-logging</span><br></pre></td></tr></table></figure>\n\n\n\n<p>如果输出的日志中有<code>Cluster health status changed from [YELLOW] to [GREEN]</code>，说明集群正常了。</p>\n<br>\n\n\n\n<h1 id=\"部署kafka\"><a href=\"#部署kafka\" class=\"headerlink\" title=\"部署kafka\"></a>部署kafka</h1><h2 id=\"部署zookeeper\"><a href=\"#部署zookeeper\" class=\"headerlink\" title=\"部署zookeeper\"></a>部署zookeeper</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">部署zookeeper集群</button></li><li class=\"tab\"><button data-href=\"#comments-2\">部署service对象</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># zookeeper-cluster.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podManagementPolicy:</span> <span class=\"string\">Parallel</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">zk-logging-headless</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"comment\">#   affinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#     podAntiAffinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#       requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">    <span class=\"comment\">#         - labelSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#             matchExpressions:</span></span><br><span class=\"line\">    <span class=\"comment\">#               - key: app</span></span><br><span class=\"line\">    <span class=\"comment\">#                 operator: In</span></span><br><span class=\"line\">    <span class=\"comment\">#                 values:</span></span><br><span class=\"line\">    <span class=\"comment\">#                   - zk-logging</span></span><br><span class=\"line\">    <span class=\"comment\">#           topologyKey: kubernetes.io/hostname</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ZOO_SERVERS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&gt;-</span></span><br><span class=\"line\">                <span class=\"string\">server.1=zk-logging-0.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181</span></span><br><span class=\"line\">                <span class=\"string\">server.2=zk-logging-1.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181</span></span><br><span class=\"line\">                <span class=\"string\">server.3=zk-logging-2.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ZOO_4LW_COMMANDS_WHITELIST</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;ruok,srvr,conf,stat&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;zookeeper:3.5.7&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">2181</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">client</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">2888</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">server</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">3888</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">leader-election</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&gt;-</span></span><br><span class=\"line\">              <span class=\"string\">echo</span> <span class=\"string\">$((</span> <span class=\"string\">$(echo</span> <span class=\"string\">$&#123;POD_NAME&#125;</span> <span class=\"string\">|</span> <span class=\"string\">awk</span> <span class=\"string\">-F</span> <span class=\"string\">&quot;-&quot;</span> <span class=\"string\">&#x27;&#123;print $NF&#125;&#x27;</span><span class=\"string\">)</span> <span class=\"string\">+</span> <span class=\"number\">1</span> <span class=\"string\">))</span> <span class=\"string\">&gt;</span></span><br><span class=\"line\">              <span class=\"string\">/data/myid</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;busybox:1.31.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">init-zk-logging</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">        <span class=\"comment\"># node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">fsGroup:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccount: zk-logging-sa</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccountName: zk-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">        <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">      <span class=\"attr\">spec:</span></span><br><span class=\"line\">        <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">storage:</span> <span class=\"string\">5Gi</span></span><br><span class=\"line\">        <span class=\"attr\">storageClassName:</span> <span class=\"string\">logging-storageclass</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>使用下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f zookeeper-cluster.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># zookeeper-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">zk-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">client</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">2181</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">2181</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">zk-logging-headless</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">server</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">2888</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">2888</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">leader-election</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">3888</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">3888</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f zookeeper-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"部署kafka-1\"><a href=\"#部署kafka-1\" class=\"headerlink\" title=\"部署kafka\"></a>部署kafka</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">部署kafka集群</button></li><li class=\"tab\"><button data-href=\"#comments-2\">部署service对象</button></li><li class=\"tab\"><button data-href=\"#comments-3\">部署kafka-manager</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建ingress</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kafka-cluster.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podManagementPolicy:</span> <span class=\"string\">Parallel</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">kafka-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"comment\">#   affinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#     podAntiAffinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#       requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">    <span class=\"comment\">#         - labelSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#             matchExpressions:</span></span><br><span class=\"line\">    <span class=\"comment\">#               - key: app</span></span><br><span class=\"line\">    <span class=\"comment\">#                 operator: In</span></span><br><span class=\"line\">    <span class=\"comment\">#                 values:</span></span><br><span class=\"line\">    <span class=\"comment\">#                   - kafka-logging</span></span><br><span class=\"line\">    <span class=\"comment\">#           topologyKey: kubernetes.io/hostname</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_REPLICAS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;3&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ZK_LOCAL</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;false&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_HEAP_OPTS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;-Xmx1024M -Xms1024M&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_num_partitions</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;3&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_delete_topic_enable</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_log_retention_hours</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;2147483647&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ADVERTISED_PORT</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;9092&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_zookeeper_connection_timeout_ms</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;6000&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_log_dirs</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">/opt/kafka/data/logs</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ADVERTISED_HOST_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ZOOKEEPER_CONNECT</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;zk-logging-service.logging.svc.cluster.local:2181&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">BROKER_ID_COMMAND</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;hostname | awk -F &#x27;</span><span class=\"string\">&#x27;-&#x27;</span><span class=\"string\">&#x27; &#x27;</span><span class=\"string\">&#x27;&#123;print $NF&#125;&#x27;</span><span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_PORT_NUMBER</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;9092&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ADVERTISED_HOST_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&gt;-</span></span><br><span class=\"line\">                <span class=\"string\">$(KAFKA_ADVERTISED_HOST_NAME).kafka-logging-service.logging.svc.cluster.local</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;wurstmeister/kafka:2.12-2.5.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9092</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">server</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/kafka</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#     node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">fsGroup:</span> <span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccount: kafka-logging-sa</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccountName: kafka-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">        <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">      <span class=\"attr\">spec:</span></span><br><span class=\"line\">        <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">storage:</span> <span class=\"string\">20Gi</span></span><br><span class=\"line\">        <span class=\"attr\">storageClassName:</span> <span class=\"string\">logging-storageclass</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>使用下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kafka-cluster.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kafka-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kafka-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">server</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9092</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9092</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kafka-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>kafka-manager是kafka的一个web管理平台，这里部署一下方便在有需要时进行管理。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kafka-manager.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">25</span><span class=\"string\">%</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">25</span><span class=\"string\">%</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ZK_HOSTS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;zk-logging-service.logging.svc:2181&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;kafkamanager/kafka-manager:2.0.0.2&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9000</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kafka-manager.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kafka-manager-ingress.yaml</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">   <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">   <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">   <span class=\"attr\">rules:</span></span><br><span class=\"line\">   <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">kafka-manager.example.com</span></span><br><span class=\"line\">     <span class=\"attr\">http:</span></span><br><span class=\"line\">       <span class=\"attr\">paths:</span></span><br><span class=\"line\">       <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">         <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">9000</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kafka-manager-ingress.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查服务\"><a href=\"#检查服务\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h2><p>检查所有的pod都正常运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,svc,ingress -n logging | grep -E <span class=\"string\">&#x27;kafka|zk&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./kafka-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"创建nginx配置\"><a href=\"#创建nginx配置\" class=\"headerlink\" title=\"创建nginx配置\"></a>创建nginx配置</h2><p>在nginx服务器上增加kafka-manager配置，代理kafka服务：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/nginx/conf.d/kafka-manager.conf</span></span><br><span class=\"line\"><span class=\"attribute\">upstream</span> ingress-<span class=\"number\">80</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">10.8.138.9:80</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">5s</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">10.8.138.11:80</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">5s</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> kafka-manager.example.com;</span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> https://$host<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> kafka-manager.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span> /etc/nginx/ssl/nginx.crt;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span> /etc/nginx/ssl/nginx.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> /var/log/nginx/kafka-manager.example.com_access.log main;</span><br><span class=\"line\">    <span class=\"attribute\">error_log</span> /var/log/nginx/kafka-manager.example.com_error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_pass</span> http://ingress-80;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_set_header</span> Host $http_host;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> conf.d/common.ini;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>检查配置并重载nginx：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t </span><br><span class=\"line\">nginx -s reload </span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"访问并配置kafka-manager\"><a href=\"#访问并配置kafka-manager\" class=\"headerlink\" title=\"访问并配置kafka-manager\"></a>访问并配置kafka-manager</h2><p>通过浏览器访问kafka-manager的域名<code>kafka-manager.example.com</code>即可进入kafka-manager的控制页面，点击上边的<code>Cluster</code>，然后选择<code>Add Cluster</code>添加kafka集群，需要填入下面几个信息：</p>\n<img src= \"/img/loading.gif\" data-src=\"./add-cluster-1.png\" style=\"zoom:50%;\" />\n\n\n\n<img src= \"/img/loading.gif\" data-src=\"./add-cluster-2.png\" style=\"zoom:50%;\" />\n\n\n\n<p>最后点击<code>save</code>后集群信息添加完成。</p>\n<br>\n\n\n\n<h1 id=\"部署logstash\"><a href=\"#部署logstash\" class=\"headerlink\" title=\"部署logstash\"></a>部署logstash</h1><h2 id=\"创建logstash配置\"><a href=\"#创建logstash配置\" class=\"headerlink\" title=\"创建logstash配置\"></a>创建logstash配置</h2><p>logstash相关的配置文件可以在<a href=\"https://github.com/liyongzhezz/yaml/tree/master/EFK-kafka日志收集\">logstash配置文件</a> 找到，这里需要将<code>efk-template.json</code>, <code>init_efk.sh</code>, <code>k8s-log.json</code>, <code>logstash.conf</code>, <code>logstash.yml</code>, <code>systemd-log.json</code> 放入一个目录下，例如<code>logstash-conf</code>下：</p>\n<ul>\n<li><code>efk-template.json</code>：定义的是针对索引的日志策略；</li>\n<li><code>init_efk.sh</code>：操作es ，初始化一些配置；</li>\n<li><code>k8s-log.json</code>：收集k8s日志的配置；</li>\n<li><code>logstash.conf</code>：logstash的流水线配置；</li>\n<li><code>logstash.yml</code>：logstash配置文件；</li>\n<li><code>systemd-log.json</code>：收集系统日志的配置；</li>\n</ul>\n<p>然后执行下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create configmap logstash-logging-config --from-file=./logstash-conf/ -n logging </span><br></pre></td></tr></table></figure>\n\n\n\n<img src= \"/img/loading.gif\" data-src=\"./configmap.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"部署logstash-1\"><a href=\"#部署logstash-1\" class=\"headerlink\" title=\"部署logstash\"></a>部署logstash</h2><p>logstash不需要很多实例，所以使用<code>deployment</code>方式部署，可以根据需要进行扩展：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># logstash-deployment.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;logstash:7.8.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5044</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-5044</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9600</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9600</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/logstash/config/logstash.yml</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">logstash.yml</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/logstash/pipeline/logstash.conf</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">logstash.conf</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/logstash/config/efk-template.json</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">efk-template.json</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">/bin/init_efk.sh</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;curlimages/curl:latest&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">init-efk</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/bin/init_efk.sh</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">init_efk.sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/tmp/k8s-log.json</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">k8s-log.json</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/tmp/systemd-log.json</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">systemd-log.json</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#     node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">fsGroup:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">seLinuxOptions:</span></span><br><span class=\"line\">          <span class=\"attr\">level:</span> <span class=\"string\">&#x27;s0:c13,c12&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">493</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">logstash-logging-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>直接运行下面的命令部署logstash：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f logstash-deployment.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查服务-1\"><a href=\"#检查服务-1\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h2><p>确保所有的pod都处于Running状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n logging | grep logstash</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./logstash-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"部署filebeat\"><a href=\"#部署filebeat\" class=\"headerlink\" title=\"部署filebeat\"></a>部署filebeat</h1><h2 id=\"部署相关资源-1\"><a href=\"#部署相关资源-1\" class=\"headerlink\" title=\"部署相关资源\"></a>部署相关资源</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建权限</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建相关配置</button></li><li class=\"tab\"><button data-href=\"#comments-3\">部署filebeat</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># filebeat-rbac.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-sa</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-bind</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-sa</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-clusterrole</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-clusterrole</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>] <span class=\"comment\"># &quot;&quot; indicates the core API group</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">namespaces</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">pods</span></span><br><span class=\"line\">  <span class=\"attr\">verbs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成创建：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">filebeat-rbac.yaml</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># filebeat-configmap.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">filebeat.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">&quot;filebeat-k8s&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">filebeat.registry.path:</span> <span class=\"string\">/var/log/filebeat/registry</span></span><br><span class=\"line\">    <span class=\"attr\">logging.level:</span> <span class=\"string\">warning</span></span><br><span class=\"line\">    <span class=\"attr\">filebeat.inputs:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">container</span></span><br><span class=\"line\">      <span class=\"attr\">scan_frequency:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">      <span class=\"attr\">enable:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">symlinks:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">harvester_buffer_size:</span> <span class=\"number\">16384</span></span><br><span class=\"line\">      <span class=\"attr\">max_bytes:</span> <span class=\"number\">10485760</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/lib/docker/containers/*/*-json.log</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.pattern:</span> <span class=\"string\">&#x27;^[[:space:]]+.+\\b|^Caused by:|^[[:alpha:]]+.+Exception:\\s\\w+.+|^[[:alpha:]]+.+Exception$|^Exception\\s\\w+.+&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.negate:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.match:</span> <span class=\"string\">after</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.max_lines:</span> <span class=\"number\">500</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.timeout:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">      <span class=\"attr\">fields_under_root:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">overwrite_keys:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">      <span class=\"attr\">scan_frequency:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">      <span class=\"attr\">enable:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">symlinks:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">harvester_buffer_size:</span> <span class=\"number\">16384</span></span><br><span class=\"line\">      <span class=\"attr\">max_bytes:</span> <span class=\"number\">10485760</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/log/messages</span></span><br><span class=\"line\">      <span class=\"attr\">fields_under_root:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">overwrite_keys:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">processors:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">add_kubernetes_metadata:</span></span><br><span class=\"line\">          <span class=\"attr\">in_cluster:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">add_host_metadata:</span> </span><br><span class=\"line\">          <span class=\"attr\">netinfo.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">add_locale:</span> <span class=\"string\">~</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">add_fields:</span></span><br><span class=\"line\">          <span class=\"attr\">target:</span> <span class=\"string\">host</span></span><br><span class=\"line\">          <span class=\"attr\">fields:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">$&#123;NODE_NAME&#125;</span></span><br><span class=\"line\">            <span class=\"attr\">ip:</span> <span class=\"string\">$&#123;NODE_IP&#125;</span></span><br><span class=\"line\">            <span class=\"attr\">podip:</span> <span class=\"string\">$&#123;POD_IP&#125;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">drop_fields:</span></span><br><span class=\"line\">          <span class=\"attr\">fields:</span> [<span class=\"string\">&quot;agent.ephemeral_id&quot;</span>,<span class=\"string\">&quot;agent.id&quot;</span>,<span class=\"string\">&quot;log.offset&quot;</span>,<span class=\"string\">&quot;suricata.eve.timestamp&quot;</span>,<span class=\"string\">&quot;host.os.codename&quot;</span>,<span class=\"string\">&quot;host.hostname&quot;</span>]</span><br><span class=\"line\">          <span class=\"attr\">ignore_missing:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">output.kafka:</span></span><br><span class=\"line\">      <span class=\"attr\">hosts:</span> [<span class=\"string\">&quot;kafka-logging-service:9092&quot;</span>]</span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"number\">2.0</span><span class=\"number\">.0</span></span><br><span class=\"line\">      <span class=\"attr\">worker:</span> <span class=\"number\">3</span></span><br><span class=\"line\">      <span class=\"attr\">topics:</span> </span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">topic:</span> <span class=\"string\">&quot;k8s-log.<span class=\"template-variable\">%&#123;[kubernetes.namespace]&#125;</span>&quot;</span></span><br><span class=\"line\">          <span class=\"attr\">when.contains:</span> </span><br><span class=\"line\">            <span class=\"attr\">input.type:</span> <span class=\"string\">&quot;container&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">topic:</span> <span class=\"string\">&quot;systemd-log.<span class=\"template-variable\">%&#123;[host.name]&#125;</span>&quot;</span></span><br><span class=\"line\">          <span class=\"attr\">when.contains:</span> </span><br><span class=\"line\">            <span class=\"attr\">input.type:</span> <span class=\"string\">&quot;log&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">partition.round_robin:</span></span><br><span class=\"line\">        <span class=\"attr\">reachable_only:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">required_acks:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">compression:</span> <span class=\"string\">gzip</span></span><br><span class=\"line\">      <span class=\"attr\">max_message_bytes:</span> <span class=\"number\">1000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.elasticsearch.hosts:</span> [ <span class=\"string\">&quot;es-logging-service:9200&quot;</span> ]</span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.elasticsearch.protocol:</span> <span class=\"string\">&quot;http&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.elasticsearch.username:</span> <span class=\"string\">&quot;elastic&quot;</span> </span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.elasticsearch.password:</span> <span class=\"string\">&quot;$&#123;ELASTIC_PASSWORD&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>在配置文件中，指定filebeat去读取docker日志和系统日志，并将日志发送给kafka。filebeat本身不对日志进行处理。执行下面的命令完成创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f filebeat-configmap.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>每一个工作节点都需要收集日志，所以使用daemonset方式进行部署：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># fileat-daemonset.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DaemonSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">        <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">/home/filebeat-config/filebeat.yml</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-e&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">spec.nodeName</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_IP</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.hostIP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;elastic/filebeat:7.6.8&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">filebeat-storage</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/log/pods</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">varlogpods</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/docker/containers</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">varlibdockercontainers</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/home/filebeat-config</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">filebeat-volume</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccount:</span> <span class=\"string\">filebeat-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">filebeat-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">            <span class=\"attr\">type:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">filebeat-storage</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/var/log/pods</span></span><br><span class=\"line\">            <span class=\"attr\">type:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">varlogpods</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/var/lib/docker/containers</span></span><br><span class=\"line\">            <span class=\"attr\">type:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">varlibdockercontainers</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">420</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">filebeat-volume</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>在yaml文件中，将<code>/var/lib/docker/containers</code>和<code>/var/log</code>挂载到了容器中，方便容器进行日志收集。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f filebeat-daemonset.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查服务-2\"><a href=\"#检查服务-2\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h2><p>确保所有pod都正常运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n logging | grep filebeat</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./pod.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"部署kibana\"><a href=\"#部署kibana\" class=\"headerlink\" title=\"部署kibana\"></a>部署kibana</h1><h2 id=\"部署相关资源-2\"><a href=\"#部署相关资源-2\" class=\"headerlink\" title=\"部署相关资源\"></a>部署相关资源</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建初始化配置</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">部署kibana</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建service对象</button></li><li class=\"tab\"><button data-href=\"#comments-5\">创建ingress对象</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>Kibana相关的配置文件可以在<a href=\"https://github.com/liyongzhezz/yaml/tree/master/EFK-kafka日志收集\">kibana配置文件</a> 找到，这里需要将<code>init_kibana.sh</code> 放入一个目录下，例如<code>kibana-conf</code>下，然后执行下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create configmap kibana-logging-init-config --from-file=./kibana-conf/init_kibana.sh -n logging</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kibana-config.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">kibana.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"attr\">server.port:</span> <span class=\"number\">5601</span></span><br><span class=\"line\">    <span class=\"attr\">server.host:</span> <span class=\"string\">&quot;0.0.0.0&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">server.name:</span> <span class=\"string\">&quot;kibana-logging&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.hosts:</span> [<span class=\"string\">&quot;http://es-logging-service:9200&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.ui.container.elasticsearch.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.security.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.username:</span> <span class=\"string\">&quot;kibana&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.password:</span> <span class=\"string\">&quot;$&#123;KIBANA_PASSWORD&#125;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.requestHeadersWhitelist:</span> [ <span class=\"string\">&#x27;es-security-runas-user&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;authorization&#x27;</span>, <span class=\"string\">&#x27;X-Proxy-Remote-User&#x27;</span>, <span class=\"string\">&#x27;x-forwarded-for&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;x-forwarded-access-token&#x27;</span> ]</span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.requestTimeout:</span> <span class=\"number\">300000</span></span><br><span class=\"line\">    <span class=\"attr\">kibana.index:</span> <span class=\"string\">&quot;.kibana&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">logging.quiet:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"attr\">kibana_check.sh:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\">    <span class=\"string\">KIBANA_REST_BASEURL=http://localhost:5601/login</span></span><br><span class=\"line\">    <span class=\"string\">EXPECTED_RESPONSE_CODE=200</span></span><br><span class=\"line\">    <span class=\"string\">max_time=&quot;$&#123;max_time:-4&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">response_code=&quot;$(</span></span><br><span class=\"line\">        <span class=\"string\">curl</span> <span class=\"string\">--silent</span>                          <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--request</span> <span class=\"string\">HEAD</span>                    <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--head</span>                            <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--output</span> <span class=\"string\">/dev/null</span>                <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--max-time</span> <span class=\"string\">&quot;$&#123;max_time&#125;&quot;</span>          <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--write-out</span> <span class=\"string\">&#x27;<span class=\"template-variable\">%&#123;response_code&#125;</span>&#x27;</span>    <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">&quot;$&#123;KIBANA_REST_BASEURL&#125;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">)&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">if</span> [ <span class=\"string\">&quot;$&#123;response_code&#125;&quot;</span> <span class=\"string\">==</span> <span class=\"string\">&quot;$&#123;EXPECTED_RESPONSE_CODE&#125;&quot;</span> ]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">        <span class=\"string\">exit</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"string\">else</span></span><br><span class=\"line\">        <span class=\"string\">echo</span> <span class=\"string\">&quot;Kibana node is not ready to accept HTTP requests yet [response code: $&#123;response_code&#125;]&quot;</span></span><br><span class=\"line\">        <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"string\">fi</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kibana-config.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kibana-deployment.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KIBANA_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;kibana:7.8.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">exec:</span></span><br><span class=\"line\">              <span class=\"attr\">command:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">/usr/share/kibana/config/kibana_check.sh</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5601</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-5601</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">exec:</span></span><br><span class=\"line\">              <span class=\"attr\">command:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">/usr/share/kibana/config/kibana_check.sh</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">&#x27;2&#x27;</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\">            <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/kibana/config/kibana.yml</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">kibana.yml</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/kibana/config/kibana_check.sh</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">kibana_check.sh</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">/bin/init_kibana.sh</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;curlimages/curl:latest&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">init-kibana</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/bin/init_kibana.sh</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">kibana-init</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">init_kibana.sh</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#     node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">493</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">493</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging-init-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kibana-init</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kibana-deployment.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kibana-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp-5601</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">5601</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">5601</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kibana-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-5\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kibana-ingress.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">   <span class=\"attr\">name:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\">   <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">   <span class=\"attr\">rules:</span></span><br><span class=\"line\">   <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">kibana.example.com</span></span><br><span class=\"line\">     <span class=\"attr\">http:</span></span><br><span class=\"line\">       <span class=\"attr\">paths:</span></span><br><span class=\"line\">       <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">         <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">kibana-logging-service</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">5601</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kibana-ingress.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"配置nginx暴露服务\"><a href=\"#配置nginx暴露服务\" class=\"headerlink\" title=\"配置nginx暴露服务\"></a>配置nginx暴露服务</h2><p>新增下面的nginx配置:</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/nginx/conf.d/kibana.conf</span></span><br><span class=\"line\"><span class=\"attribute\">upstream</span> ingress-<span class=\"number\">80</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">10.8.138.9:80</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">5s</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">10.8.138.11:80</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">5s</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> kibana.example.com;</span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> https://$host<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> kibana.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span> /etc/nginx/ssl/nginx.crt;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span> /etc/nginx/ssl/nginx.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> /var/log/nginx/kibana.example.com_access.log main;</span><br><span class=\"line\">    <span class=\"attribute\">error_log</span> /var/log/nginx/kibana.example.com_error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_pass</span> http://ingress-80;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_set_header</span> Host $http_host;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> conf.d/common.ini;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>检查并重载nginx：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t</span><br><span class=\"line\">nginx -s reload</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查服务-3\"><a href=\"#检查服务-3\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h2><p>确保相关pod都处在Running状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,svc,ingress -n logging | grep kibana</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./kibana-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"访问页面\"><a href=\"#访问页面\" class=\"headerlink\" title=\"访问页面\"></a>访问页面</h2><p>通过浏览器访问<code>kibana.example.com</code>即可进入kibana的页面，输入在部署elasticsearch中设置的初始账号密码：<code>elastic/elastic</code>。然后在kibana中创建<code>Index patterns</code>就可以了。</p>\n<img src= \"/img/loading.gif\" data-src=\"./kibana.png\" style=\"zoom:50%;\" />\n\n\n\n<p>访问kafka-manager观察，发现消息topic也创建出来并且有消息在队列中被logstash消费：</p>\n<img src= \"/img/loading.gif\" data-src=\"./kafka.png\" style=\"zoom:50%;\" />\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用filebeat、kafka、logstash、elasticsearch、kibana进行日志收集</p><p>更新于 2021-03-27</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"架构方案\"><a href=\"#架构方案\" class=\"headerlink\" title=\"架构方案\"></a>架构方案</h1><h2 id=\"架构\"><a href=\"#架构\" class=\"headerlink\" title=\"架构\"></a>架构</h2><p>整体收集方案使用如下的组件：</p>\n<ul>\n<li><code>filebeat</code>：采集节点和容器日志，发送到kafka；</li>\n<li><code>kafka</code>：接收filebeat发送的日志消息；</li>\n<li><code>logstash</code>：从kafka中消费日志消息并进行处理；</li>\n<li><code>elasticsearch</code>：进行日志存储；</li>\n<li><code>kibana</code>：日志可视化展示；</li>\n</ul>\n<blockquote>\n<p>日志文件 –&gt; filebeat –&gt; kafka –&gt; logstash –&gt; elasticsearch –&gt; kibana</p>\n</blockquote>\n<h2 id=\"版本选择\"><a href=\"#版本选择\" class=\"headerlink\" title=\"版本选择\"></a>版本选择</h2><ul>\n<li><code>filebeat</code>：7.6.2；</li>\n<li><code>kafka</code>：2.12-2.5.0；</li>\n<li><code>zookeeper</code>：3.5.7；</li>\n<li><code>logstash</code>：7.8.0；</li>\n<li><code>elasticsearch</code>：7.8.0；</li>\n<li><code>kibana</code>：7.8.0；</li>\n</ul>\n<h2 id=\"方案可能存在的问题\"><a href=\"#方案可能存在的问题\" class=\"headerlink\" title=\"方案可能存在的问题\"></a>方案可能存在的问题</h2><p>这套日志收集方案可能存在下面的问题：</p>\n<ul>\n<li>elasticsearch可能存在瓶颈（es还需要进一步调优）；</li>\n<li>logstash会根据写入es的速度调整消息消费的速度，所有kafka有时候会出现消息堆积的情况；</li>\n<li>……</li>\n</ul>\n<br>\n\n\n\n<h1 id=\"准备工作\"><a href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"></a>准备工作</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">准备nfs相关资源</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建namespace</button></li><li class=\"tab\"><button data-href=\"#comments-3\">设置elasticsearch密码</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>这里使用nfs作为底层存储，相关的创建方法可以参考：<a href=\"/2021/03/23/%E5%9C%A8k8s%E4%B8%AD%E4%BD%BF%E7%94%A8nfs%E5%AD%98%E5%82%A8/\" title=\"在k8s中使用nfs存储\">在k8s中使用nfs存储</a>，当然也可以使用其他的存储系统。</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>使用下面的yaml文件创建一个namespace：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># namesapce.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">logging</span></span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f namespace.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>elasticsearch开启x-pack认证功能，这里将elasticsearch的密码保存在secret资源中：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">espassword=<span class=\"string\">&quot;elastic&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create secret generic es-logging-password --from-literal=elastic=<span class=\"string\">&#x27;elastic&#x27;</span> -n logging</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>这里讲elasticsearch密码设置为：<code>elastic</code></p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署elasticsearch\"><a href=\"#部署elasticsearch\" class=\"headerlink\" title=\"部署elasticsearch\"></a>部署elasticsearch</h1><h2 id=\"部署相关资源\"><a href=\"#部署相关资源\" class=\"headerlink\" title=\"部署相关资源\"></a>部署相关资源</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建elasticsearch配置</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建elasticsearch集群</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建service</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># elasticsearch-config.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">elasticsearch.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"attr\">cluster.name:</span> <span class=\"string\">es-logging-cluster</span></span><br><span class=\"line\">    <span class=\"attr\">node.name:</span> <span class=\"string\">$&#123;NODE_NAME&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">network.host:</span> <span class=\"number\">0.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">http.port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">    <span class=\"attr\">transport.port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">    <span class=\"attr\">discovery.seed_hosts:</span> [<span class=\"string\">&quot;es-logging-cluster&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">cluster.initial_master_nodes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">es-logging-0</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">es-logging-1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">es-logging-2</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.collection.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.security.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.license.self_generated.type:</span> <span class=\"string\">basic</span></span><br><span class=\"line\">    <span class=\"attr\">indices.lifecycle.history_index_enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.ilm.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"attr\">cluster.routing.allocation.disk.threshold_enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.enabled: true</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.verification_mode: certificate</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.key: certs/es-logging-service.key</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.certificate: certs/es-logging-service.crt</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.transport.ssl.certificate_authorities: certs/ca.crt</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.http.ssl.enabled: false</span></span><br><span class=\"line\">    <span class=\"comment\"># xpack.security.authc.realms:</span></span><br><span class=\"line\">    <span class=\"comment\">#   native.realm1:</span></span><br><span class=\"line\">    <span class=\"comment\">#     order: 0</span></span><br><span class=\"line\">  <span class=\"attr\">es_check.sh:</span> <span class=\"string\">&gt;</span></span><br><span class=\"line\">    <span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">ES_REST_BASEURL=http://localhost:9200</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">EXPECTED_RESPONSE_CODE=200</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">max_time=$&#123;READINESS_PROBE_TIMEOUT:-30&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">function</span> <span class=\"string\">check_if_ready()</span> &#123;</span><br><span class=\"line\">      <span class=\"string\">path=&quot;$1&quot;</span></span><br><span class=\"line\">      <span class=\"string\">err_msg=&quot;$2&quot;</span></span><br><span class=\"line\">      <span class=\"string\">response_code=$(curl</span> <span class=\"string\">-s</span> <span class=\"string\">-k</span> <span class=\"string\">--head</span> <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">-u</span> <span class=\"string\">elastic:$</span>&#123;<span class=\"string\">ELASTIC_PASSWORD</span>&#125; <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">--max-time</span> <span class=\"string\">$max_time</span> <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">-o</span> <span class=\"string\">/dev/null</span> <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">-w</span> <span class=\"string\">&#x27;<span class=\"template-variable\">%&#123;response_code&#125;</span>&#x27;</span> <span class=\"string\">\\</span></span><br><span class=\"line\">          <span class=\"string\">&quot;$&#123;ES_REST_BASEURL&#125;$&#123;path&#125;&quot;</span><span class=\"string\">)</span></span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"string\">if</span> [ <span class=\"string\">&quot;$&#123;response_code&#125;&quot;</span> <span class=\"type\">!=</span> <span class=\"string\">$</span>&#123;<span class=\"string\">EXPECTED_RESPONSE_CODE</span>&#125; ]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">        <span class=\"string\">echo</span> <span class=\"string\">&quot;$&#123;err_msg&#125; [response code: $&#123;response_code&#125;]&quot;</span></span><br><span class=\"line\">        <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"string\">fi</span></span><br><span class=\"line\">      <span class=\"string\">exit</span> <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">check_if_ready</span> <span class=\"string\">&quot;/&quot;</span> <span class=\"string\">&quot;Elasticsearch node is not ready to accept HTTP requests yet&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>配置中的相关参数解释：</p>\n<ul>\n<li><code>cluster.name</code>：设置es集群名称，用于唯一标识一个集群；</li>\n<li><code>network.host</code>：监听的地址；</li>\n<li><code>discovery.seed_hosts</code>：节点发现方式；</li>\n<li><code>xpack.security.enabled</code>起用xpack安全组件；</li>\n<li><code>cluster.routing.allocation.disk.threshold_enabled</code>是否启动磁盘分配器；</li>\n</ul>\n<blockquote>\n<p><code>cluster.routing.allocation.disk.threshold_enabled</code>这个参数这里设置为false，表示关闭磁盘分配器，这样es可以使用全部磁盘空间。默认情况下当磁盘空间大于85%后，es就不能再创建分片了。这个参数在es使用同一个后端存储的时候应该调节一下。<a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cluster.html#disk-based-shard-allocation\">相关文档</a></p>\n</blockquote>\n<p>es启用了x-pack密码认证，并且通过脚本检查es是否正常启动。我这里将es https通信方式注释掉了，如果有需要可以生成相关证书并起用https配置。直接运行下面的命令创建es配置：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f elasticsearch-config.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>使用下面的yaml文件创建一个namespace：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># elasticsearch-cluster.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">es-logging-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"comment\">#   affinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#     podAntiAffinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#       requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">    <span class=\"comment\">#         - labelSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#             matchExpressions:</span></span><br><span class=\"line\">    <span class=\"comment\">#               - key: app</span></span><br><span class=\"line\">    <span class=\"comment\">#                 operator: In</span></span><br><span class=\"line\">    <span class=\"comment\">#                 values:</span></span><br><span class=\"line\">    <span class=\"comment\">#                   - es-logging</span></span><br><span class=\"line\">    <span class=\"comment\">#           topologyKey: kubernetes.io/hostname</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_JAVA_OPTS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;-Xms2g -Xmx2g&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;docker.elastic.co/elasticsearch/elasticsearch:7.8.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">exec:</span></span><br><span class=\"line\">              <span class=\"attr\">command:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">/usr/share/elasticsearch/config/es_check.sh</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9200</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9300</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">exec:</span></span><br><span class=\"line\">              <span class=\"attr\">command:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">/usr/share/elasticsearch/config/es_check.sh</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">&#x27;2&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/data</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">es7x-data</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/config/elasticsearch.yml</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">es7x-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">elasticsearch.yml</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/config/es_check.sh</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">es7x-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">es_check.sh</span></span><br><span class=\"line\">            <span class=\"comment\"># - mountPath: /usr/share/elasticsearch/config/certs</span></span><br><span class=\"line\">            <span class=\"comment\">#   name: es-certs</span></span><br><span class=\"line\">            <span class=\"comment\">#   readOnly: true</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_URI</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;http://elastic:$(ELASTIC_PASSWORD)@localhost:9200&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_INDICES</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_ALL</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_INDICES_SETTINGS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;justwatch/elasticsearch_exporter:1.1.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">elasticsearch-exporter</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9114</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9114</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">200m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">200Mi</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sysctl</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-w&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">vm.max_map_count=262144</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;busybox:1.31.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">increase-vm-max-map</span></span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">ulimit</span> <span class=\"string\">-n</span> <span class=\"number\">65536</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;busybox:1.31.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">increase-fd-ulimit</span></span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#     node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">fsGroup:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">seLinuxOptions:</span></span><br><span class=\"line\">          <span class=\"attr\">level:</span> <span class=\"string\">&#x27;s0:c13,c12&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccount: es-logging-sa</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccountName: es-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">493</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">es-logging-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">es7x-config</span></span><br><span class=\"line\">        <span class=\"comment\"># - name: es-certs</span></span><br><span class=\"line\">        <span class=\"comment\">#   secret:</span></span><br><span class=\"line\">        <span class=\"comment\">#     defaultMode: 420</span></span><br><span class=\"line\">        <span class=\"comment\">#     secretName: es-logging-certs</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">        <span class=\"attr\">labels:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">es7x-data</span></span><br><span class=\"line\">      <span class=\"attr\">spec:</span></span><br><span class=\"line\">        <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">storage:</span> <span class=\"string\">20Gi</span></span><br><span class=\"line\">        <span class=\"attr\">storageClassName:</span> <span class=\"string\">logging-storageclass</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>es集群使用了statefulset方式部署，其中storageclass<code>logging-storageclass</code>需要自己手动创建，执行下面的命令完成部署。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f elasticsearch-cluster.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># elasticsearch-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp-9200</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">    <span class=\"attr\">monitor-app:</span> <span class=\"string\">elasticsearch-exporter</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp-9300</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp-9114</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9114</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9114</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">es-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeclt apply -f elasticsearch-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查\"><a href=\"#检查\" class=\"headerlink\" title=\"检查\"></a>检查</h2><p>首先确保所有的pod都处于running状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n logging | grep es</span><br></pre></td></tr></table></figure>\n\n<img src=\"./es-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<p>然后执行下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl logs -f es-logging-1 -n logging -c es-logging</span><br></pre></td></tr></table></figure>\n\n\n\n<p>如果输出的日志中有<code>Cluster health status changed from [YELLOW] to [GREEN]</code>，说明集群正常了。</p>\n<br>\n\n\n\n<h1 id=\"部署kafka\"><a href=\"#部署kafka\" class=\"headerlink\" title=\"部署kafka\"></a>部署kafka</h1><h2 id=\"部署zookeeper\"><a href=\"#部署zookeeper\" class=\"headerlink\" title=\"部署zookeeper\"></a>部署zookeeper</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">部署zookeeper集群</button></li><li class=\"tab\"><button data-href=\"#comments-2\">部署service对象</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># zookeeper-cluster.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podManagementPolicy:</span> <span class=\"string\">Parallel</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">zk-logging-headless</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"comment\">#   affinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#     podAntiAffinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#       requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">    <span class=\"comment\">#         - labelSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#             matchExpressions:</span></span><br><span class=\"line\">    <span class=\"comment\">#               - key: app</span></span><br><span class=\"line\">    <span class=\"comment\">#                 operator: In</span></span><br><span class=\"line\">    <span class=\"comment\">#                 values:</span></span><br><span class=\"line\">    <span class=\"comment\">#                   - zk-logging</span></span><br><span class=\"line\">    <span class=\"comment\">#           topologyKey: kubernetes.io/hostname</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ZOO_SERVERS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&gt;-</span></span><br><span class=\"line\">                <span class=\"string\">server.1=zk-logging-0.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181</span></span><br><span class=\"line\">                <span class=\"string\">server.2=zk-logging-1.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181</span></span><br><span class=\"line\">                <span class=\"string\">server.3=zk-logging-2.zk-logging-headless.logging.svc.cluster.local:2888:3888;2181</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ZOO_4LW_COMMANDS_WHITELIST</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;ruok,srvr,conf,stat&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;zookeeper:3.5.7&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">2181</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">client</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">2888</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">server</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">3888</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">leader-election</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&gt;-</span></span><br><span class=\"line\">              <span class=\"string\">echo</span> <span class=\"string\">$((</span> <span class=\"string\">$(echo</span> <span class=\"string\">$&#123;POD_NAME&#125;</span> <span class=\"string\">|</span> <span class=\"string\">awk</span> <span class=\"string\">-F</span> <span class=\"string\">&quot;-&quot;</span> <span class=\"string\">&#x27;&#123;print $NF&#125;&#x27;</span><span class=\"string\">)</span> <span class=\"string\">+</span> <span class=\"number\">1</span> <span class=\"string\">))</span> <span class=\"string\">&gt;</span></span><br><span class=\"line\">              <span class=\"string\">/data/myid</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;busybox:1.31.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">init-zk-logging</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">        <span class=\"comment\"># node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">fsGroup:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccount: zk-logging-sa</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccountName: zk-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">        <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">      <span class=\"attr\">spec:</span></span><br><span class=\"line\">        <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">storage:</span> <span class=\"string\">5Gi</span></span><br><span class=\"line\">        <span class=\"attr\">storageClassName:</span> <span class=\"string\">logging-storageclass</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>使用下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f zookeeper-cluster.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># zookeeper-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">zk-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">client</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">2181</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">2181</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">zk-logging-headless</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">server</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">2888</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">2888</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">leader-election</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">3888</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">3888</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">zk-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f zookeeper-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"部署kafka-1\"><a href=\"#部署kafka-1\" class=\"headerlink\" title=\"部署kafka\"></a>部署kafka</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">部署kafka集群</button></li><li class=\"tab\"><button data-href=\"#comments-2\">部署service对象</button></li><li class=\"tab\"><button data-href=\"#comments-3\">部署kafka-manager</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建ingress</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kafka-cluster.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">podManagementPolicy:</span> <span class=\"string\">Parallel</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">kafka-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"comment\">#   affinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#     podAntiAffinity:</span></span><br><span class=\"line\">    <span class=\"comment\">#       requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">    <span class=\"comment\">#         - labelSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#             matchExpressions:</span></span><br><span class=\"line\">    <span class=\"comment\">#               - key: app</span></span><br><span class=\"line\">    <span class=\"comment\">#                 operator: In</span></span><br><span class=\"line\">    <span class=\"comment\">#                 values:</span></span><br><span class=\"line\">    <span class=\"comment\">#                   - kafka-logging</span></span><br><span class=\"line\">    <span class=\"comment\">#           topologyKey: kubernetes.io/hostname</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_REPLICAS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;3&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ZK_LOCAL</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;false&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_HEAP_OPTS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;-Xmx1024M -Xms1024M&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_num_partitions</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;3&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_delete_topic_enable</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_log_retention_hours</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;2147483647&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ADVERTISED_PORT</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;9092&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_zookeeper_connection_timeout_ms</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;6000&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVER_log_dirs</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">/opt/kafka/data/logs</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ADVERTISED_HOST_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ZOOKEEPER_CONNECT</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;zk-logging-service.logging.svc.cluster.local:2181&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">BROKER_ID_COMMAND</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;hostname | awk -F &#x27;</span><span class=\"string\">&#x27;-&#x27;</span><span class=\"string\">&#x27; &#x27;</span><span class=\"string\">&#x27;&#123;print $NF&#125;&#x27;</span><span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_PORT_NUMBER</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;9092&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KAFKA_ADVERTISED_HOST_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&gt;-</span></span><br><span class=\"line\">                <span class=\"string\">$(KAFKA_ADVERTISED_HOST_NAME).kafka-logging-service.logging.svc.cluster.local</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;wurstmeister/kafka:2.12-2.5.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9092</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">server</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/kafka</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#     node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">fsGroup:</span> <span class=\"number\">0</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccount: kafka-logging-sa</span></span><br><span class=\"line\">    <span class=\"comment\">#   serviceAccountName: kafka-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">        <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">datadir</span></span><br><span class=\"line\">      <span class=\"attr\">spec:</span></span><br><span class=\"line\">        <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">storage:</span> <span class=\"string\">20Gi</span></span><br><span class=\"line\">        <span class=\"attr\">storageClassName:</span> <span class=\"string\">logging-storageclass</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>使用下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kafka-cluster.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kafka-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kafka-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">server</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9092</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9092</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kafka-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>kafka-manager是kafka的一个web管理平台，这里部署一下方便在有需要时进行管理。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kafka-manager.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">25</span><span class=\"string\">%</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">25</span><span class=\"string\">%</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ZK_HOSTS</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&#x27;zk-logging-service.logging.svc:2181&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;kafkamanager/kafka-manager:2.0.0.2&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9000</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">9000</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kafka-manager.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kafka-manager-ingress.yaml</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">   <span class=\"attr\">name:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">   <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">   <span class=\"attr\">rules:</span></span><br><span class=\"line\">   <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">kafka-manager.example.com</span></span><br><span class=\"line\">     <span class=\"attr\">http:</span></span><br><span class=\"line\">       <span class=\"attr\">paths:</span></span><br><span class=\"line\">       <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">         <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">kafka-manager</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">9000</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kafka-manager-ingress.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查服务\"><a href=\"#检查服务\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h2><p>检查所有的pod都正常运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,svc,ingress -n logging | grep -E <span class=\"string\">&#x27;kafka|zk&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./kafka-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"创建nginx配置\"><a href=\"#创建nginx配置\" class=\"headerlink\" title=\"创建nginx配置\"></a>创建nginx配置</h2><p>在nginx服务器上增加kafka-manager配置，代理kafka服务：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/nginx/conf.d/kafka-manager.conf</span></span><br><span class=\"line\"><span class=\"attribute\">upstream</span> ingress-<span class=\"number\">80</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">10.8.138.9:80</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">5s</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">10.8.138.11:80</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">5s</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> kafka-manager.example.com;</span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> https://$host<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> kafka-manager.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span> /etc/nginx/ssl/nginx.crt;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span> /etc/nginx/ssl/nginx.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> /var/log/nginx/kafka-manager.example.com_access.log main;</span><br><span class=\"line\">    <span class=\"attribute\">error_log</span> /var/log/nginx/kafka-manager.example.com_error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_pass</span> http://ingress-80;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_set_header</span> Host $http_host;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> conf.d/common.ini;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>检查配置并重载nginx：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t </span><br><span class=\"line\">nginx -s reload </span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"访问并配置kafka-manager\"><a href=\"#访问并配置kafka-manager\" class=\"headerlink\" title=\"访问并配置kafka-manager\"></a>访问并配置kafka-manager</h2><p>通过浏览器访问kafka-manager的域名<code>kafka-manager.example.com</code>即可进入kafka-manager的控制页面，点击上边的<code>Cluster</code>，然后选择<code>Add Cluster</code>添加kafka集群，需要填入下面几个信息：</p>\n<img src=\"./add-cluster-1.png\" style=\"zoom:50%;\" />\n\n\n\n<img src=\"./add-cluster-2.png\" style=\"zoom:50%;\" />\n\n\n\n<p>最后点击<code>save</code>后集群信息添加完成。</p>\n<br>\n\n\n\n<h1 id=\"部署logstash\"><a href=\"#部署logstash\" class=\"headerlink\" title=\"部署logstash\"></a>部署logstash</h1><h2 id=\"创建logstash配置\"><a href=\"#创建logstash配置\" class=\"headerlink\" title=\"创建logstash配置\"></a>创建logstash配置</h2><p>logstash相关的配置文件可以在<a href=\"https://github.com/liyongzhezz/yaml/tree/master/EFK-kafka日志收集\">logstash配置文件</a> 找到，这里需要将<code>efk-template.json</code>, <code>init_efk.sh</code>, <code>k8s-log.json</code>, <code>logstash.conf</code>, <code>logstash.yml</code>, <code>systemd-log.json</code> 放入一个目录下，例如<code>logstash-conf</code>下：</p>\n<ul>\n<li><code>efk-template.json</code>：定义的是针对索引的日志策略；</li>\n<li><code>init_efk.sh</code>：操作es ，初始化一些配置；</li>\n<li><code>k8s-log.json</code>：收集k8s日志的配置；</li>\n<li><code>logstash.conf</code>：logstash的流水线配置；</li>\n<li><code>logstash.yml</code>：logstash配置文件；</li>\n<li><code>systemd-log.json</code>：收集系统日志的配置；</li>\n</ul>\n<p>然后执行下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create configmap logstash-logging-config --from-file=./logstash-conf/ -n logging </span><br></pre></td></tr></table></figure>\n\n\n\n<img src=\"./configmap.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"部署logstash-1\"><a href=\"#部署logstash-1\" class=\"headerlink\" title=\"部署logstash\"></a>部署logstash</h2><p>logstash不需要很多实例，所以使用<code>deployment</code>方式部署，可以根据需要进行扩展：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># logstash-deployment.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;logstash:7.8.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">logstash-logging</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5044</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-5044</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9600</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-9600</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/logstash/config/logstash.yml</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">logstash.yml</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/logstash/pipeline/logstash.conf</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">logstash.conf</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/logstash/config/efk-template.json</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">efk-template.json</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">/bin/init_efk.sh</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;curlimages/curl:latest&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">init-efk</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/bin/init_efk.sh</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">init_efk.sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/tmp/k8s-log.json</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">k8s-log.json</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/tmp/systemd-log.json</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">systemd-log.json</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#     node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">fsGroup:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">seLinuxOptions:</span></span><br><span class=\"line\">          <span class=\"attr\">level:</span> <span class=\"string\">&#x27;s0:c13,c12&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">493</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">logstash-logging-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">logstash-config</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>直接运行下面的命令部署logstash：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f logstash-deployment.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查服务-1\"><a href=\"#检查服务-1\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h2><p>确保所有的pod都处于Running状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n logging | grep logstash</span><br></pre></td></tr></table></figure>\n\n<img src=\"./logstash-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"部署filebeat\"><a href=\"#部署filebeat\" class=\"headerlink\" title=\"部署filebeat\"></a>部署filebeat</h1><h2 id=\"部署相关资源-1\"><a href=\"#部署相关资源-1\" class=\"headerlink\" title=\"部署相关资源\"></a>部署相关资源</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建权限</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建相关配置</button></li><li class=\"tab\"><button data-href=\"#comments-3\">部署filebeat</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># filebeat-rbac.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-sa</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-bind</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-sa</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-clusterrole</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-clusterrole</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>] <span class=\"comment\"># &quot;&quot; indicates the core API group</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">namespaces</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">pods</span></span><br><span class=\"line\">  <span class=\"attr\">verbs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成创建：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">filebeat-rbac.yaml</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># filebeat-configmap.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">filebeat.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">&quot;filebeat-k8s&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">filebeat.registry.path:</span> <span class=\"string\">/var/log/filebeat/registry</span></span><br><span class=\"line\">    <span class=\"attr\">logging.level:</span> <span class=\"string\">warning</span></span><br><span class=\"line\">    <span class=\"attr\">filebeat.inputs:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">container</span></span><br><span class=\"line\">      <span class=\"attr\">scan_frequency:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">      <span class=\"attr\">enable:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">symlinks:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">harvester_buffer_size:</span> <span class=\"number\">16384</span></span><br><span class=\"line\">      <span class=\"attr\">max_bytes:</span> <span class=\"number\">10485760</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/lib/docker/containers/*/*-json.log</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.pattern:</span> <span class=\"string\">&#x27;^[[:space:]]+.+\\b|^Caused by:|^[[:alpha:]]+.+Exception:\\s\\w+.+|^[[:alpha:]]+.+Exception$|^Exception\\s\\w+.+&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.negate:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.match:</span> <span class=\"string\">after</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.max_lines:</span> <span class=\"number\">500</span></span><br><span class=\"line\">      <span class=\"attr\">multiline.timeout:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">      <span class=\"attr\">fields_under_root:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">overwrite_keys:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">type:</span> <span class=\"string\">log</span></span><br><span class=\"line\">      <span class=\"attr\">scan_frequency:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">      <span class=\"attr\">enable:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">symlinks:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">harvester_buffer_size:</span> <span class=\"number\">16384</span></span><br><span class=\"line\">      <span class=\"attr\">max_bytes:</span> <span class=\"number\">10485760</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/log/messages</span></span><br><span class=\"line\">      <span class=\"attr\">fields_under_root:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">overwrite_keys:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">processors:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">add_kubernetes_metadata:</span></span><br><span class=\"line\">          <span class=\"attr\">in_cluster:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">add_host_metadata:</span> </span><br><span class=\"line\">          <span class=\"attr\">netinfo.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">add_locale:</span> <span class=\"string\">~</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">add_fields:</span></span><br><span class=\"line\">          <span class=\"attr\">target:</span> <span class=\"string\">host</span></span><br><span class=\"line\">          <span class=\"attr\">fields:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">$&#123;NODE_NAME&#125;</span></span><br><span class=\"line\">            <span class=\"attr\">ip:</span> <span class=\"string\">$&#123;NODE_IP&#125;</span></span><br><span class=\"line\">            <span class=\"attr\">podip:</span> <span class=\"string\">$&#123;POD_IP&#125;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">drop_fields:</span></span><br><span class=\"line\">          <span class=\"attr\">fields:</span> [<span class=\"string\">&quot;agent.ephemeral_id&quot;</span>,<span class=\"string\">&quot;agent.id&quot;</span>,<span class=\"string\">&quot;log.offset&quot;</span>,<span class=\"string\">&quot;suricata.eve.timestamp&quot;</span>,<span class=\"string\">&quot;host.os.codename&quot;</span>,<span class=\"string\">&quot;host.hostname&quot;</span>]</span><br><span class=\"line\">          <span class=\"attr\">ignore_missing:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">output.kafka:</span></span><br><span class=\"line\">      <span class=\"attr\">hosts:</span> [<span class=\"string\">&quot;kafka-logging-service:9092&quot;</span>]</span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"number\">2.0</span><span class=\"number\">.0</span></span><br><span class=\"line\">      <span class=\"attr\">worker:</span> <span class=\"number\">3</span></span><br><span class=\"line\">      <span class=\"attr\">topics:</span> </span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">topic:</span> <span class=\"string\">&quot;k8s-log.<span class=\"template-variable\">%&#123;[kubernetes.namespace]&#125;</span>&quot;</span></span><br><span class=\"line\">          <span class=\"attr\">when.contains:</span> </span><br><span class=\"line\">            <span class=\"attr\">input.type:</span> <span class=\"string\">&quot;container&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">topic:</span> <span class=\"string\">&quot;systemd-log.<span class=\"template-variable\">%&#123;[host.name]&#125;</span>&quot;</span></span><br><span class=\"line\">          <span class=\"attr\">when.contains:</span> </span><br><span class=\"line\">            <span class=\"attr\">input.type:</span> <span class=\"string\">&quot;log&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">partition.round_robin:</span></span><br><span class=\"line\">        <span class=\"attr\">reachable_only:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"attr\">required_acks:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">compression:</span> <span class=\"string\">gzip</span></span><br><span class=\"line\">      <span class=\"attr\">max_message_bytes:</span> <span class=\"number\">1000000</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.elasticsearch.hosts:</span> [ <span class=\"string\">&quot;es-logging-service:9200&quot;</span> ]</span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.elasticsearch.protocol:</span> <span class=\"string\">&quot;http&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.elasticsearch.username:</span> <span class=\"string\">&quot;elastic&quot;</span> </span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.elasticsearch.password:</span> <span class=\"string\">&quot;$&#123;ELASTIC_PASSWORD&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>在配置文件中，指定filebeat去读取docker日志和系统日志，并将日志发送给kafka。filebeat本身不对日志进行处理。执行下面的命令完成创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f filebeat-configmap.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>每一个工作节点都需要收集日志，所以使用daemonset方式进行部署：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># fileat-daemonset.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DaemonSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">        <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">/home/filebeat-config/filebeat.yml</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-e&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">spec.nodeName</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_IP</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.hostIP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;elastic/filebeat:7.6.8&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging</span></span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">filebeat-storage</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/log/pods</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">varlogpods</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/docker/containers</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">varlibdockercontainers</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/home/filebeat-config</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">filebeat-volume</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccount:</span> <span class=\"string\">filebeat-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">filebeat-logging-sa</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">            <span class=\"attr\">type:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">filebeat-storage</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/var/log/pods</span></span><br><span class=\"line\">            <span class=\"attr\">type:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">varlogpods</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/var/lib/docker/containers</span></span><br><span class=\"line\">            <span class=\"attr\">type:</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">varlibdockercontainers</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">420</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">filebeat-logging-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">filebeat-volume</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>在yaml文件中，将<code>/var/lib/docker/containers</code>和<code>/var/log</code>挂载到了容器中，方便容器进行日志收集。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f filebeat-daemonset.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查服务-2\"><a href=\"#检查服务-2\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h2><p>确保所有pod都正常运行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n logging | grep filebeat</span><br></pre></td></tr></table></figure>\n\n<img src=\"./pod.png\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"部署kibana\"><a href=\"#部署kibana\" class=\"headerlink\" title=\"部署kibana\"></a>部署kibana</h1><h2 id=\"部署相关资源-2\"><a href=\"#部署相关资源-2\" class=\"headerlink\" title=\"部署相关资源\"></a>部署相关资源</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建初始化配置</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">部署kibana</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建service对象</button></li><li class=\"tab\"><button data-href=\"#comments-5\">创建ingress对象</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>Kibana相关的配置文件可以在<a href=\"https://github.com/liyongzhezz/yaml/tree/master/EFK-kafka日志收集\">kibana配置文件</a> 找到，这里需要将<code>init_kibana.sh</code> 放入一个目录下，例如<code>kibana-conf</code>下，然后执行下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create configmap kibana-logging-init-config --from-file=./kibana-conf/init_kibana.sh -n logging</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kibana-config.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">kibana.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"attr\">server.port:</span> <span class=\"number\">5601</span></span><br><span class=\"line\">    <span class=\"attr\">server.host:</span> <span class=\"string\">&quot;0.0.0.0&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">server.name:</span> <span class=\"string\">&quot;kibana-logging&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.hosts:</span> [<span class=\"string\">&quot;http://es-logging-service:9200&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">xpack.monitoring.ui.container.elasticsearch.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">xpack.security.enabled:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.username:</span> <span class=\"string\">&quot;kibana&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.password:</span> <span class=\"string\">&quot;$&#123;KIBANA_PASSWORD&#125;&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.requestHeadersWhitelist:</span> [ <span class=\"string\">&#x27;es-security-runas-user&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;authorization&#x27;</span>, <span class=\"string\">&#x27;X-Proxy-Remote-User&#x27;</span>, <span class=\"string\">&#x27;x-forwarded-for&#x27;</span>,</span><br><span class=\"line\">    <span class=\"string\">&#x27;x-forwarded-access-token&#x27;</span> ]</span><br><span class=\"line\">    <span class=\"attr\">elasticsearch.requestTimeout:</span> <span class=\"number\">300000</span></span><br><span class=\"line\">    <span class=\"attr\">kibana.index:</span> <span class=\"string\">&quot;.kibana&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">logging.quiet:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"attr\">kibana_check.sh:</span> <span class=\"string\">|</span></span><br><span class=\"line\">    <span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\">    <span class=\"string\">KIBANA_REST_BASEURL=http://localhost:5601/login</span></span><br><span class=\"line\">    <span class=\"string\">EXPECTED_RESPONSE_CODE=200</span></span><br><span class=\"line\">    <span class=\"string\">max_time=&quot;$&#123;max_time:-4&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">response_code=&quot;$(</span></span><br><span class=\"line\">        <span class=\"string\">curl</span> <span class=\"string\">--silent</span>                          <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--request</span> <span class=\"string\">HEAD</span>                    <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--head</span>                            <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--output</span> <span class=\"string\">/dev/null</span>                <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--max-time</span> <span class=\"string\">&quot;$&#123;max_time&#125;&quot;</span>          <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">--write-out</span> <span class=\"string\">&#x27;<span class=\"template-variable\">%&#123;response_code&#125;</span>&#x27;</span>    <span class=\"string\">\\</span></span><br><span class=\"line\">             <span class=\"string\">&quot;$&#123;KIBANA_REST_BASEURL&#125;&quot;</span></span><br><span class=\"line\">    <span class=\"string\">)&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">if</span> [ <span class=\"string\">&quot;$&#123;response_code&#125;&quot;</span> <span class=\"string\">==</span> <span class=\"string\">&quot;$&#123;EXPECTED_RESPONSE_CODE&#125;&quot;</span> ]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">        <span class=\"string\">exit</span> <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"string\">else</span></span><br><span class=\"line\">        <span class=\"string\">echo</span> <span class=\"string\">&quot;Kibana node is not ready to accept HTTP requests yet [response code: $&#123;response_code&#125;]&quot;</span></span><br><span class=\"line\">        <span class=\"string\">exit</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"string\">fi</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kibana-config.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kibana-deployment.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">RollingUpdate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NODE_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">Asia/Shanghai</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">KIBANA_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;kibana:7.8.0&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">exec:</span></span><br><span class=\"line\">              <span class=\"attr\">command:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">/usr/share/kibana/config/kibana_check.sh</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5601</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">tcp-5601</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">exec:</span></span><br><span class=\"line\">              <span class=\"attr\">command:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">/usr/share/kibana/config/kibana_check.sh</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">&#x27;2&#x27;</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\">            <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/kibana/config/kibana.yml</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">kibana.yml</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/kibana/config/kibana_check.sh</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">kibana_check.sh</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">&#x27;-c&#x27;</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">/bin/init_kibana.sh</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ELASTIC_PASSWORD</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">secretKeyRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">key:</span> <span class=\"string\">elastic</span></span><br><span class=\"line\">                  <span class=\"attr\">name:</span> <span class=\"string\">es-logging-password</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">&#x27;curlimages/curl:latest&#x27;</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">init-kibana</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/bin/init_kibana.sh</span></span><br><span class=\"line\">              <span class=\"attr\">name:</span> <span class=\"string\">kibana-init</span></span><br><span class=\"line\">              <span class=\"attr\">subPath:</span> <span class=\"string\">init_kibana.sh</span></span><br><span class=\"line\">    <span class=\"comment\">#   nodeSelector:</span></span><br><span class=\"line\">    <span class=\"comment\">#     node-role.kubernetes.io/compute: &#x27;true&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">493</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kibana-config</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">defaultMode:</span> <span class=\"number\">493</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging-init-config</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">kibana-init</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kibana-deployment.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kibana-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kibana-logging-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tcp-5601</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">5601</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"number\">5601</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">kibana-logging</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kibana-service.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-5\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kibana-ingress.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">   <span class=\"attr\">name:</span> <span class=\"string\">kibana</span></span><br><span class=\"line\">   <span class=\"attr\">namespace:</span> <span class=\"string\">logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">   <span class=\"attr\">rules:</span></span><br><span class=\"line\">   <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">kibana.example.com</span></span><br><span class=\"line\">     <span class=\"attr\">http:</span></span><br><span class=\"line\">       <span class=\"attr\">paths:</span></span><br><span class=\"line\">       <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">         <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">kibana-logging-service</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">5601</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行下面的命令完成创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kibana-ingress.yaml</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"配置nginx暴露服务\"><a href=\"#配置nginx暴露服务\" class=\"headerlink\" title=\"配置nginx暴露服务\"></a>配置nginx暴露服务</h2><p>新增下面的nginx配置:</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /etc/nginx/conf.d/kibana.conf</span></span><br><span class=\"line\"><span class=\"attribute\">upstream</span> ingress-<span class=\"number\">80</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">10.8.138.9:80</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">5s</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> <span class=\"number\">10.8.138.11:80</span> max_fails=<span class=\"number\">3</span> fail_timeout=<span class=\"number\">5s</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> kibana.example.com;</span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> https://$host<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> kibana.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span> /etc/nginx/ssl/nginx.crt;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span> /etc/nginx/ssl/nginx.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> /var/log/nginx/kibana.example.com_access.log main;</span><br><span class=\"line\">    <span class=\"attribute\">error_log</span> /var/log/nginx/kibana.example.com_error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_pass</span> http://ingress-80;</span><br><span class=\"line\">      <span class=\"attribute\">proxy_set_header</span> Host $http_host;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> conf.d/common.ini;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>检查并重载nginx：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t</span><br><span class=\"line\">nginx -s reload</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查服务-3\"><a href=\"#检查服务-3\" class=\"headerlink\" title=\"检查服务\"></a>检查服务</h2><p>确保相关pod都处在Running状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,svc,ingress -n logging | grep kibana</span><br></pre></td></tr></table></figure>\n\n<img src=\"./kibana-pod.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"访问页面\"><a href=\"#访问页面\" class=\"headerlink\" title=\"访问页面\"></a>访问页面</h2><p>通过浏览器访问<code>kibana.example.com</code>即可进入kibana的页面，输入在部署elasticsearch中设置的初始账号密码：<code>elastic/elastic</code>。然后在kibana中创建<code>Index patterns</code>就可以了。</p>\n<img src=\"./kibana.png\" style=\"zoom:50%;\" />\n\n\n\n<p>访问kafka-manager观察，发现消息topic也创建出来并且有消息在队列中被logstash消费：</p>\n<img src=\"./kafka.png\" style=\"zoom:50%;\" />\n\n\n\n"},{"title":"kubeadm部署k8s 1.17集群","date":"2021-03-28T06:32:13.000Z","description":"通过kubeadm部署3master节点高可用k8s 1.17.3集群","cover":"https://raw.githubusercontent.com/kubernetes/kubeadm/master/logos/stacked/color/kubeadm-stacked-color.png","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了通过kubeadm部署3master节点高可用k8s 1.17.3集群 \n\n更新于 2021-03-28\n\n{% endnote %}\n\n<br>\n\n\n\n# 集群规划\n\n|    主机名     |   IP地址    |        用途        |\n| :-----------: | :---------: | :----------------: |\n| SCA-LUM700011 | 10.8.138.8  | nginx+nfs+运维节点 |\n| SCA-LUM700007 | 10.8.138.5  |      master-1      |\n| SCA-LUM700008 | 10.8.138.6  |      Master-2      |\n| SCA-LUM700012 | 10.8.138.10 |      Master-3      |\n| SCA-LUM700013 | 10.8.138.9  |       Node-1       |\n| SCA-LUM700014 | 10.8.138.11 |       node-2       |\n\n\n\n操作系统`centos7.6`，前端还有一个elb，地址为`10.8.138.12`，代理master的apiserver。kube-proxy使用`ipvs`模式，集群使用`1.17.3`版本\n\n\n\n<br>\n\n\n\n# 安装工具\n\n{% tabs comments %}\n\n<!-- tab 安装nfs -->\n\nnfs的作用是为集群提供共享存储，nginx后面用来代理集群的ingress等服务。在`SCA-LUM700011`这台nfs服务器上有挂载的磁盘，先对其格式化并创建nfs的数据目录：\n\n```bash\nmkfs.xfs /dev/vdb -f\nmkdir -p /data/nfs-data\necho \"/dev/vdb /data/nfs-data xfs defaults 0 0\" >> /etc/fstab\nmount -a\ndf -h\n```\n\n\n\n安装nfs相关服务并启动nfs：\n\n```bash\nyum install -y nfs-utils rpcbind\necho \"/data/nfs-data *(rw,no_root_squash)\" >> /etc/exports\nsystemctl start rpcbind\nsystemctl status rpcbind\nsystemctl enable rpcbind\nsystemctl start nfs \nsystemctl status nfs\nsystemctl enable nfs\n```\n\n\n\n在集群的每一个节点上执行下面的命令安装`nfs-utils`工具：\n\n```bash\nyum install -y nfs-utils \n```\n\n<!-- endtab -->\n\n<!-- tab 安装nginx -->\n\nnginx将作为一个代理，代理集群中的服务，这里使用yum方式安装nginx。\n\n```bash\n# 安装依赖\nyum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel\n\n# 添加yum源\ncat > /etc/yum.repos.d/nginx.repo << EOF\n[nginx-stable]\nname=nginx stable repo\nbaseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/\ngpgcheck=1\nenabled=1\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\n\n[nginx-mainline]\nname=nginx mainline repo\nbaseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/\ngpgcheck=1\nenabled=0\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\nEOF\n\n# 安装nginx\nyum install -y nginx\n\n# 检查\nnginx -v\nnginx -V\n\n# 启动nginx\nsystemctl start nginx\nsystenctl status nginx\nsystenctl enable nginx\n```\n\n<!-- endtab -->\n\n<!-- tab 安装ansible -->\n\n`ansible`可以方便批量执行指令，首先在`SCA-LUM700011`这台创建ssh key并分发到其他节点，将这台服务器作为运维节点，下面使用的ansible就在这个上面运行。\n\n```bash\nssh-keygen\nssh-copy-id 10.8.138.5\nssh-copy-id 10.8.138.6\nssh-copy-id 10.8.138.10\nssh-copy-id 10.8.138.9\nssh-copy-id 10.8.138.11\n```\n\n\n\n安装ansible：\n\n```bash\nyum install -y ansible\n\n# 设置配置文件\ncat > /etc/ansible/ansible.cfg <<EOF\n[defaults]\nlog_path = /var/log/ansible.log\nforks = 20\nhost_key_checking = False\nretry_files_enabled = False\ndeprecation_warnings = False\nnocows = True\nremote_user = root\nroles_path = roles/\ngathering = smart\nfact_caching = jsonfile\nfact_caching_connection = /etc/ansible/facts\nfact_caching_timeout = 600\ncallback_whitelist = profile_tasks\ninventory_ignore_extensions = secrets.py, .pyc, .cfg, .crt, .ini\ntimeout = 30\n\n[inventory]\nunparsed_is_failed=true\n\n[ssh_connection]\npipelining = True\nssh_args = -o ControlMaster=auto -o ControlPersist=600s\ntimeout = 10\ncontrol_path = %(directory)s/%%h-%%r\nEOF\n\n# 设置host文件\ncat > /etc/ansible/hosts <<EOF\n[cluster]\n10.8.138.5  hostname='SCA-LUM700007'\n10.8.138.6  hostname='SCA-LUM700008'\n10.8.138.10 hostname='SCA-LUM700012'\n10.8.138.9  hostname='SCA-LUM700013'\n10.8.138.11 hostname='SCA-LUM700014'\n\n[ans]\n10.8.138.8\n\n[master]\n10.8.138.5\n10.8.138.6\n10.8.138.10\n\n[worker]\n10.8.138.9\n10.8.138.11\nEOF\n\n# 检查ansible\nansible cluster -m ping \n```\n\n<img src=\"./ansible-check.png\" style=\"zoom:40%;\" />\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n\n\n<br>\n\n# 内核优化\n\n{% tabs comments %}\n\n<!-- tab 升级内核版本 -->\n\n**注意，我这里计划使用ipvs模式，需要升级内核版本，每台服务器都升级一下**\n\n```bash\n# 载入公钥\nrpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\n\n# 安装 ELRepo 最新版本\nyum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm\n\n# 列出可以使用的 kernel 包版本\nyum list available --disablerepo=* --enablerepo=elrepo-kernel\n\n# 安装内核\nyum install -y kernel-lt-4.4.226-1.el7.elrepo --enablerepo=elrepo-kernel\n\n# 查看可用内核\ncat /boot/grub2/grub.cfg | grep menuentry\n\nmenuentry 'CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)' --class centos （略）\nmenuentry 'CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)' --class centos ...（略）\n\n# 设置从新的内核起动\ngrub2-set-default \"CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)\"\n\n# 查看内核启动项\ngrub2-editenv list\n\nsaved_entry=CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)\n\n# 重启\nreboot\n```\n\n<!-- endtab -->\n\n<!-- tab 设置内核参数 -->\n\n```bash\ncat > /etc/k8s.conf << EOF\nfs.file-max=6815744\nnet.ipv4.ip_forward=1\nnet.bridge.bridge-nf-call-iptables=1\nnet.bridge.bridge-nf-call-ip6tables=1\nnet.ipv4.ip_forward=1\nnet.ipv4.tcp_tw_recycle=0\nvm.swappiness=0\nvm.panic_on_oom=0\n\n# 当内核维护的arp表过于庞大时候，可以考虑优化\nnet.ipv4.neigh.default.gc_thresh1=1024\nnet.ipv4.neigh.default.gc_thresh2=4096\nnet.ipv4.neigh.default.gc_thresh3=8192\n\n# netfilter优化\nnet.netfilter.nf_conntrack_max=10485760\nnet.netfilter.nf_conntrack_tcp_timeout_established=300\nnet.netfilter.nf_conntrack_buckets=655360\n\nnet.core.netdev_max_backlog=10000\nfs.inotify.max_user_instances=524288\nfs.inotify.max_user_watches=524288\n\nEOF\n```\n\n- `fs.file-max`表示系统级别最大文件句柄数量；\n- `net.ipv4.neigh.default.gc_thresh1`表示存在于ARP高速缓存中的最少层数，如果少于这个数垃圾收集器将不会运行。缺省值是128；\n- `net.ipv4.neigh.default.gc_thresh2`保存在ARP高速缓存中的最多的记录软限制。垃圾收集器在开始收集前允许记录数超过这个数字 5 秒。缺省值是 512；\n- `net.ipv4.neigh.default.gc_thresh3`保存在ARP高速缓存中的最多记录的硬限制，一旦高速缓存中的数目高于此，垃圾收集器将马上运行。缺省值是1024；\n- `net.netfilter.nf_conntrack_max`内核内存中netfilter可以同时处理的“任务”（连接跟踪条目）；\n- `net.netfilter.nf_conntrack_buckets`哈希表大小（只读）（64位系统、8G内存默认 65536，16G翻倍，如此类推）;\n- `net.core.netdev_max_backlog`网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目；\n- `fs.inotify.max_user_instances`默认值: 128 指定了每一个real user ID可创建的inotify instatnces的数量上限；\n- `fs.inotify.max_user_watches`默认值: 8192 指定了每个inotify instance相关联的watches的上限；\n\n\n\n执行下面的命令在每个节点生效配置：\n\n```bash\nansible cluster -m copy -a 'src=/etc/sysctl.d/k8s.conf dest=/etc/sysctl.d/k8s.conf mode=0755'\nansible cluster -m shell -a 'sysctl -p /etc/sysctl.d/k8s.conf'\nansible cluster -m shell -a 'echo \"/sbin/sysctl -p /etc/sysctl.d/k8s.conf\" >> /etc/rc.local'\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署前准备\n\n{% tabs comments %}\n\n<!-- tab 设置host -->\n\n通过`ansible`为每个节点设置host文件：\n\n```bash\nansible cluster -m shell -a 'cat >> /etc/hosts <<EOF\n10.8.138.5  SCA-LUM700007 sca-lum700007 master1\n10.8.138.6  SCA-LUM700008 sca-lum700008 master2\n10.8.138.10 SCA-LUM700012 sca-lum700012 master3\n10.8.138.9  SCA-LUM700013 sca-lum700013 node1\n10.8.138.11 SCA-LUM700014 sca-lum700014 node2\nEOF'\n```\n\n<!-- endtab -->\n\n<!-- tab 安装docker -->\n\n**需要给集群所有的节点安装docker**\n\n\n\n首先添加repo文件：\n\n```bash\nansible cluster -m shell -a 'yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo'\n```\n\n\n\n设置存储目录，一般docker的数据存放路径为`/var/lib/docker`，所以在每个服务器上最好都有一个数据盘挂载到该目录下，防止docker数据过多爆盘。这里以一台服务器的设置为例：\n\n```bash\nmkdir /var/lib/docker\nmkfs.xfs -f /dev/vdb\necho \"/dev/vdb /var/lib/docker xfs defaults 0 0\" >> /etc/fstab\nmount -a\ndf -h\n```\n\n\n\n安装docker\n\n```bash\n# 查看当前可用的版本\nyum list docker-ce --showduplicates|sort -r\n\n# 安装docker\nansible cluster -m shell -a 'yum install -y docker-ce-18.06.3.ce-3.el7'\n```\n\n\n\n设置配置文件：\n\n```bash\ncat > daemon.json <<EOF\n{\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"5\"\n  },\n  \"storage-driver\": \"overlay2\"\n}\nEOF\n\n# 分发到集群节点\nansible cluster -m shell -a 'mkdir /etc/docker'\nansible cluster -m copy -a 'src=daemon.json dest=/etc/docker/daemon.json'\n```\n\n\n\n启动服务：\n\n```bash\nansible cluster -m shell -a 'systemctl daemon-reload'\nansible cluster -m shell -a 'systemctl restart docker'\nansible cluster -m shell -a 'systemctl status docker'\nansible cluster -m shell -a 'systemctl enable docker'\n```\n\n<!-- endtab -->\n\n<!-- tab 关闭swap -->\n\n```bash\nansible cluster -m shell -a 'swapoff -a'\nansible cluster -m shell -a 'sed -i \"/swap/s/^/#/g\" /etc/fstab'\n```\n\n<!-- endtab -->\n\n<!-- tab 开启ipvs -->\n\n本集群的service网络采用ipvs模式：\n\n```bash\n# 配置内核参数\nansible cluster -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present'\nansible cluster -m sysctl -a 'name=net.bridge.bridge-nf-call-iptables value=1 state=present'\nansible cluster -m sysctl -a 'name=net.bridge.bridge-nf-call-ip6tables value=1 state=present'\n\n# 加载ipvs模块\ncat > /tmp/ipvs.modules <<EOF\n#!/bin/bash\nipvs_modules=\"ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4\"\nfor kernel_module in \\${ipvs_modules}; do\n    /sbin/modinfo -F filename \\${kernel_module} > /dev/null 2>&1\n    if [ $? -eq 0 ]; then\n        /sbin/modprobe \\${kernel_module}\n    fi\ndone\nEOF\n\nansible cluster -m copy -a 'src=/tmp/ipvs.modules dest=/root/ipvs.modules mode=0755'\nansible cluster -m shell -a 'sh /root/ipvs.modules'\n\n# 设置开机启动执行该脚本\nansible cluster -m shell -a 'echo \"sh /root/ipvs.modules\" >> /etc/rc.local'\n\n# 验证 ipvs 支持\nansible cluster -m shell -a 'lsmod | grep ip_vs'\n\n# 安装ipvsadm\nansible cluster -m yum -a 'name=ipvsadm state=present'\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 安装基础服务\n\n## 添加yum源\n\n```bash\ncat > /etc/yum.repos.d/kubernetes.repo << EOF\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n# 分发文件\nansible cluster -m copy -a 'src=/etc/yum.repos.d/kubernetes.repo dest=/etc/yum.repos.d/kubernetes.repo'\n```\n\n\n\n## 安装kubelet、kubectl、kubeadm\n\n这里安装的是`1.17.3`版本：\n\n```bash\n# 安装kubectl、kubeadm、kubelet\nansible cluster -m shell -a 'yum install -y kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3'\n\n# 检查\nansible cluster -m shell -a 'ls /usr/bin/kube*'\n\n# 设置kubelet自启动\nansible cluster -m shell -a 'systemctl enable kubelet'\n```\n\n\n\n<br>\n\n\n\n# 部署master节点\n\n这一步在任意一个master上执行，这里我在`master1`上执行。需要配置下kubeadm的相关参数。\n\n\n\n## 配置kubeadm参数\n\n```bash\ncat > kubeadm-config.yaml << EOF\napiVersion: kubeadm.k8s.io/v1beta2\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 0.0.0.0\n  bindPort: 6443\nnodeRegistration:\n  criSocket: /var/run/dockershim.sock\n  taints:\n  - effect: NoSchedule\n    key: node-role.kubernetes.io/master\n  kubeletExtraArgs:\n    cgroup-driver: \"systemd\"\n  ignorePreflightErrors:\n  - IsPrivilegedUser\n---\napiVersion: kubeadm.k8s.io/v1beta2\nkind: ClusterConfiguration\ncontrolPlaneEndpoint: 10.8.138.12:6443\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\napiServer:\n  timeoutForControlPlane: 5m0s\n  extraArgs:\n    authorization-mode: \"Node,RBAC\"\n  certSANs:\n  - \"10.8.138.12\"\n  - \"14.116.177.22\"\n  - \"kubernetes\"\n  - \"kubernetes.default\"\n  - \"kubernetes.default.svc\"\n  - \"kubernetes.default.svc.cluster\"\n  - \"kubernetes.default.svc.cluster.local\"\ncontrollerManager:\n  extraArgs:\n    \"node-cidr-mask-size\": \"20\"\nscheduler:\n  extraArgs:\n    address: \"0.0.0.0\"\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /var/lib/etcd\n#    extraArgs:\n#      listen-client-urls: \"http://10.100.0.1:2379\"\n#    serverCertSANs:\n#    serverCertSANs:\n#    - \"localhost\"\n#    - \"127.0.0.1\"\n#    peerCertSANs:\n#    - \"localhost\"\n#    - \"127.0.0.1\"\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers\nkubernetesVersion: v1.17.3\nnetworking:\n  dnsDomain: cluster.local\n  serviceSubnet: 172.24.0.0/16\n  podSubnet: 172.21.0.0/16\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nbindAddress: 0.0.0.0\n#clusterCIDR:\nmode: ipvs  # 定义代理模式： userspace、 iptables 或 ipvs 。默认使用 iptables ，大集群建议使用 ipvs。\nipvs:\n  scheduler: lc\n  syncPeriod: 30s\n  minSyncPeriod: 5s\n  tcpTimeout: 0s\n  tcpFinTimeout: 0s\n  udpTimeout: 0s\n---\napiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\nEOF\n```\n\n- 其中`10.8.138.12`为我前端slb的IP地址，代理后端三个master节点的6443；\n- 根据实际情况在`certSANs`中添加IP和域名；\n- 注意修改其中的kubernetes的版本，以及ipvs模式的调度算法（这里我使用的是lc）\n\n\n\n## 验证配置\n\n下面的命令可以验证配置是否有误，并不会真正执行：\n\n```bash\nkubeadm init --config=kubeadm-config.yaml --upload-certs --dry-run\n```\n\n\n\n## 创建集群\n\n```bash\n# 创建集群\nkubeadm init --config=kubeadm-config.yaml --upload-certs\n```\n\n\n\n执行成功的话，会出现下面的信息：\n\n![](./kubeadm-init.png)\n\n\n\n从上边可以看出，添加master节点和node节点就可以在对应服务器上执行下面的命令：\n\n```shell\n# 添加master\nkubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\\n    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \\\n    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c\n    \n# 添加node节点\nkubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\\n    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e\n```\n\n> 命令中的token有两个小时时效，时效后需要重新获取\n\n\n\n## 添加其他的master节点\n\n在剩下的两个master节点`SCA-LUM700008`和`SCA-LUM700012`执行下面的命令：\n\n```shell\nkubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\\n    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \\\n    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c\n```\n\n> 不需要拷贝kubeadm-config.yaml文件，会通过第一个apiserver去配置信息；\n\n\n\n## 设置kubectl\n\n\n\n```bash\n# 自动补全\nansible master -m shell -a 'echo \"source <(kubectl completion bash)\" >> ~/.bashrc'\n\n# 设置kubectl证书\ncp /etc/kubernetes/admin.conf /root/.kube/config\n```\n\n\n\n## 验证master部署情况\n\n```bash\n# 查看master\nkubectl get node --kubeconfig /etc/kubernetes/admin.conf\n\n# 查看pod\nkubectl get pod --all-namespaces --kubeconfig /etc/kubernetes/admin.conf\n```\n\n![](check-master.png)\n\n\n\n> 这里有些pod没有启动是正常的，因为集群还没部署完成。\n\n\n\n## 确认kubeproxy开启了ipvs\n\n首先查看网卡信息，多了一个kube-ipvs0网卡：\n\n```bash\n$ ip a s\n```\n\n<img src=\"./ipvs.png\" style=\"zoom:50%;\" />\n\n\n\n查看ipvs规则：\n\n```bash\n$ ipvsadm -Ln\n```\n\n<img src=\"./ipvs-rule.png\" style=\"zoom:40%;\" />\n\n\n\n<br>\n\n\n\n# 部署etcd\n\n## 更新etcd配置\n\n更新后会自动重启服务：\n\n```bash\nansible master -m shell -a 'sed -i \"/--initial-cluster=/c\\    - --initial-cluster=sca-lum700012=https://10.8.138.10:2380,sca-lum700007=https://10.8.138.5:2380,sca-lum700008=https://10.8.138.6:2380\" /etc/kubernetes/manifests/etcd.yaml'\n\n# apiserver 默认访问本地的 etcd 节点，如果需要访问集群所有节点可以修改配置。\nansible master -m shell -a 'sed -i \"/- --etcd-servers/c\\    - --etcd-servers=https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379\" /etc/kubernetes/manifests/kube-apiserver.yaml'\n```\n\n\n\n## 查看etcd节点状态\n\n```bash\n# 下载etcdctl\ncurl -L -O https://github.com/etcd-io/etcd/releases/download/v3.4.3/etcd-v3.4.3-linux-amd64.tar.gz\ntar xzf etcd-v3.4.3-linux-amd64.tar.gz\nmv etcd-v3.4.3-linux-amd64/etcd* /usr/local/bin/\n\n# 查看状态\nETCDCTL=3 etcdctl --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   member list\n```\n\n![](./etcd-member.png)\n\n\n\n## 查看集群状态\n\n```bash\nETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint status\n```\n\n![](./etcd-cluster.png)\n\n\n\n## etcd节点健康状态\n\n```bash\nETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint health\n```\n\n![](./etcd-helth.png)\n\n<br>\n\n\n\n# 部署node节点\n\n在所有node节点上执行下面的命令：\n\n```bash\nkubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\\n    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e\n```\n\n\n\n查看：\n\n```bash\nkubectl get node \n```\n\n<img src=\"./getnode.png\" style=\"zoom:67%;\" />\n\n\n\n*节点已经添加进来了，因为没有部署CNI所以都是NOTREADY。*\n\n<br>\n\n\n\n# 部署calico\n\n## 下载calico\n\n```bash\n# 下载calico的yaml文件\ncurl -L https://docs.projectcalico.org/v3.11/manifests/calico.yaml -o calico.yaml\n```\n\n\n\n## 部署calico\n\n修改calico.yaml：\n\n```yaml\n# 修改为pod网段\n- name: CALICO_IPV4POOL_CIDR\n  value: \"172.21.0.0/16\"\n  \n# 增加该参数，设定端口范围\n- name: FELIX_KUBENODEPORTRANGES\n  value: \"30000:50000\"\n```\n\n\n\n部署calico：\n\n```bash\nkubectl apply -f calico.yaml\n```\n\n\n\n部署完成后，查看节点状态，应该都READY：\n\n```bash\nkubectl get node\n```\n\n<img src=\"./nodes.png\" style=\"zoom:50%;\" />\n\n\n\n## 设置calico命令行工具\n\n下载calico命令行工具：\n\n```bash\n# 下载\ncurl -L -o /usr/local/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.11.2/calicoctl-linux-amd64\n\n# 配置\nmkdir -p /etc/calico\ncat > /etc/calico/calicoctl.cfg <<EOF\napiVersion: projectcalico.org/v3\nkind: CalicoAPIConfig\nmetadata:\nspec:\n  datastoreType: kubernetes\n  kubeconfig: /etc/kubernetes/admin.conf  # 使用 admin 配置\n  #k8sAPIEndpoint: https://10.8.138.12:6443\n  #k8sCertFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt\n  #k8sKeyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key\n  #k8sCAFile: /etc/kubernetes/pki/ca.crt\nEOF\n```\n\n\n\n## 查看calico节点\n\n```bash\ncalicoctl node status\n```\n\n<img src=\"./calico-node.png\" style=\"zoom:50%;\" />\n\n\n\n## 查看ippool\n\n```bash\ncalicoctl get ippool -o wide\n\nNAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR\ndefault-ipv4-ippool   172.21.0.0/16   true   Always     Never       false      all()\n```\n\n\n\n## 查看ip状态\n\n```bash\ncalicoctl ipam show\n```\n\n![](./calico-ip.png)\n\n<br>\n\n\n\n# 集群校验\n\n```bash\nkubectl config get-clusters\nkubectl cluster-info\n```\n\n![](./cluster-check.png)\n\n\n\n<br>\n\n\n\n# nginx服务其配置\n\n`SCA-LUM700011`作为nginx服务器，将会代理ingress服务，所以先设置一下。\n\n\n\n## 自签证书\n\n```bash\n# 确认安装了openssl\nopenssl version\n\n# 确定nginx安装了https模块(应该有--with-http_ssl_module)\nnginx -V\n\n# 创建整数目录\ncd /etc/nginx/\nmkdir ssl\ncd ssl\n\n# 生成秘钥\nopenssl genrsa -out nginx.key 2048\nGenerating RSA private key, 2048 bit long modulus\n..............................................+++\n.....................................................................+++\ne is 65537 (0x10001)\n\n# 生成签名请求文件（csr），输入上边的密码，并输入相关的信息\nopenssl req -new -key nginx.key -out nginx.csr\n\n# 也可以在一行，不用交互式输入\nopenssl req -subj \"/C=CN/ST=Guangdong/L=Shenzhen/O=nginx/OU=dev/CN=test.example.com/emailAddress=test@123.com\" -new -key nginx.key -out nginx.csr\n\n# 生成自签名证书，指定过期时间3650天，输入密码即可生成\nopenssl x509 -req -days 3650 -in nginx.csr -signkey nginx.key -out nginx.crt\n\n# 查看生成的文件\n$ ls\nnginx.crt  nginx.csr  nginx.key\n```\n\n\n\n## 修改nginx主配置文件\n\n修改`/etc/nginx/nginx.conf`文件为如下内容：\n\n```nginx\nuser  nginx;\nworker_processes  1;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    include /etc/nginx/conf.d/*.conf;\n}\n```\n\n\n\n这里使用`include`导入其他的配置文件，所有服务的nginx配置都放在`/etc/nginx/conf.d`下，如果目录不存在需要自己创建。\n\n\n\n在``/etc/nginx/conf.d`下先创建一个通用配置文件`common.ini`，这个是所有配置文件都要用的，所以抽离出来：\n\n```nginx\nlocation = /favicon.ico {\n    log_not_found off;\n    access_log off;\n}\n\nlocation ~* /\\.(svn|git)/ {\n    return 404;\n}\n```\n\n\n\n### 创建一个测试配置\n\n在`/etc/nginx/conf.d`下新建一个配置文件`https.conf`：\n\n```nginx\nserver {\n  listen 80;\n  server_name https-server.example.com;\n\n  rewrite ^(.*) https://$host$1 permanent;\n\n}\n\nserver {\n    listen 443 ssl;\n    server_name https-server.example.com;\n\n    ssl_certificate /etc/nginx/ssl/new/nginx.crt;\n    ssl_certificate_key /etc/nginx/ssl/new/nginx.key;\n\n    access_log /var/log/nginx/https-server.example.com_access.log main;\n    error_log /var/log/nginx/https-server.example.com_error.log;\n\n    location / {\n      root /usr/share/nginx/html;\n      index index.html index.htm;\n    }\n\n    include conf.d/common.ini;\n}\n```\n\n\n\n在`/usr/share/nginx/html`下创建测试页面：\n\n```bash\n$ echo \"this is https page\" > /usr/share/nginx/html/index.html\n```\n\n\n\n### 绑定host\n\n因为我是测试环境，且我要通过域名的方式访问服务，所以需要绑定host，这一步在自己的电脑上操作，过程不赘述。\n\n\n\n### 重启nginx并访问\n\n执行下面的命令检查配置并重新加载：\n\n```bash\nnginx -t\nnginx -s reload \n```\n\n\n\n然后通过浏览器访问域名：`https-server.example.com`，应该就可以看到设置的https页面了。\n\n> 注意，有的浏览器对于自签证书是不信任的，需要手动下载证书然后在电脑中导入就可以了。\n\n\n\n","source":"_posts/kubeadm部署k8s-1-18集群.md","raw":"---\ntitle: kubeadm部署k8s 1.17集群\ndate: 2021-03-28 14:32:13\ntags:\n- Kubernetes\ncategories:\n- Kubernetes\n- 集群部署\ndescription: 通过kubeadm部署3master节点高可用k8s 1.17.3集群 \ncover: https://raw.githubusercontent.com/kubernetes/kubeadm/master/logos/stacked/color/kubeadm-stacked-color.png\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了通过kubeadm部署3master节点高可用k8s 1.17.3集群 \n\n更新于 2021-03-28\n\n{% endnote %}\n\n<br>\n\n\n\n# 集群规划\n\n|    主机名     |   IP地址    |        用途        |\n| :-----------: | :---------: | :----------------: |\n| SCA-LUM700011 | 10.8.138.8  | nginx+nfs+运维节点 |\n| SCA-LUM700007 | 10.8.138.5  |      master-1      |\n| SCA-LUM700008 | 10.8.138.6  |      Master-2      |\n| SCA-LUM700012 | 10.8.138.10 |      Master-3      |\n| SCA-LUM700013 | 10.8.138.9  |       Node-1       |\n| SCA-LUM700014 | 10.8.138.11 |       node-2       |\n\n\n\n操作系统`centos7.6`，前端还有一个elb，地址为`10.8.138.12`，代理master的apiserver。kube-proxy使用`ipvs`模式，集群使用`1.17.3`版本\n\n\n\n<br>\n\n\n\n# 安装工具\n\n{% tabs comments %}\n\n<!-- tab 安装nfs -->\n\nnfs的作用是为集群提供共享存储，nginx后面用来代理集群的ingress等服务。在`SCA-LUM700011`这台nfs服务器上有挂载的磁盘，先对其格式化并创建nfs的数据目录：\n\n```bash\nmkfs.xfs /dev/vdb -f\nmkdir -p /data/nfs-data\necho \"/dev/vdb /data/nfs-data xfs defaults 0 0\" >> /etc/fstab\nmount -a\ndf -h\n```\n\n\n\n安装nfs相关服务并启动nfs：\n\n```bash\nyum install -y nfs-utils rpcbind\necho \"/data/nfs-data *(rw,no_root_squash)\" >> /etc/exports\nsystemctl start rpcbind\nsystemctl status rpcbind\nsystemctl enable rpcbind\nsystemctl start nfs \nsystemctl status nfs\nsystemctl enable nfs\n```\n\n\n\n在集群的每一个节点上执行下面的命令安装`nfs-utils`工具：\n\n```bash\nyum install -y nfs-utils \n```\n\n<!-- endtab -->\n\n<!-- tab 安装nginx -->\n\nnginx将作为一个代理，代理集群中的服务，这里使用yum方式安装nginx。\n\n```bash\n# 安装依赖\nyum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel\n\n# 添加yum源\ncat > /etc/yum.repos.d/nginx.repo << EOF\n[nginx-stable]\nname=nginx stable repo\nbaseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/\ngpgcheck=1\nenabled=1\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\n\n[nginx-mainline]\nname=nginx mainline repo\nbaseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/\ngpgcheck=1\nenabled=0\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\nEOF\n\n# 安装nginx\nyum install -y nginx\n\n# 检查\nnginx -v\nnginx -V\n\n# 启动nginx\nsystemctl start nginx\nsystenctl status nginx\nsystenctl enable nginx\n```\n\n<!-- endtab -->\n\n<!-- tab 安装ansible -->\n\n`ansible`可以方便批量执行指令，首先在`SCA-LUM700011`这台创建ssh key并分发到其他节点，将这台服务器作为运维节点，下面使用的ansible就在这个上面运行。\n\n```bash\nssh-keygen\nssh-copy-id 10.8.138.5\nssh-copy-id 10.8.138.6\nssh-copy-id 10.8.138.10\nssh-copy-id 10.8.138.9\nssh-copy-id 10.8.138.11\n```\n\n\n\n安装ansible：\n\n```bash\nyum install -y ansible\n\n# 设置配置文件\ncat > /etc/ansible/ansible.cfg <<EOF\n[defaults]\nlog_path = /var/log/ansible.log\nforks = 20\nhost_key_checking = False\nretry_files_enabled = False\ndeprecation_warnings = False\nnocows = True\nremote_user = root\nroles_path = roles/\ngathering = smart\nfact_caching = jsonfile\nfact_caching_connection = /etc/ansible/facts\nfact_caching_timeout = 600\ncallback_whitelist = profile_tasks\ninventory_ignore_extensions = secrets.py, .pyc, .cfg, .crt, .ini\ntimeout = 30\n\n[inventory]\nunparsed_is_failed=true\n\n[ssh_connection]\npipelining = True\nssh_args = -o ControlMaster=auto -o ControlPersist=600s\ntimeout = 10\ncontrol_path = %(directory)s/%%h-%%r\nEOF\n\n# 设置host文件\ncat > /etc/ansible/hosts <<EOF\n[cluster]\n10.8.138.5  hostname='SCA-LUM700007'\n10.8.138.6  hostname='SCA-LUM700008'\n10.8.138.10 hostname='SCA-LUM700012'\n10.8.138.9  hostname='SCA-LUM700013'\n10.8.138.11 hostname='SCA-LUM700014'\n\n[ans]\n10.8.138.8\n\n[master]\n10.8.138.5\n10.8.138.6\n10.8.138.10\n\n[worker]\n10.8.138.9\n10.8.138.11\nEOF\n\n# 检查ansible\nansible cluster -m ping \n```\n\n<img src=\"./ansible-check.png\" style=\"zoom:40%;\" />\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n\n\n<br>\n\n# 内核优化\n\n{% tabs comments %}\n\n<!-- tab 升级内核版本 -->\n\n**注意，我这里计划使用ipvs模式，需要升级内核版本，每台服务器都升级一下**\n\n```bash\n# 载入公钥\nrpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org\n\n# 安装 ELRepo 最新版本\nyum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm\n\n# 列出可以使用的 kernel 包版本\nyum list available --disablerepo=* --enablerepo=elrepo-kernel\n\n# 安装内核\nyum install -y kernel-lt-4.4.226-1.el7.elrepo --enablerepo=elrepo-kernel\n\n# 查看可用内核\ncat /boot/grub2/grub.cfg | grep menuentry\n\nmenuentry 'CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)' --class centos （略）\nmenuentry 'CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)' --class centos ...（略）\n\n# 设置从新的内核起动\ngrub2-set-default \"CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)\"\n\n# 查看内核启动项\ngrub2-editenv list\n\nsaved_entry=CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)\n\n# 重启\nreboot\n```\n\n<!-- endtab -->\n\n<!-- tab 设置内核参数 -->\n\n```bash\ncat > /etc/k8s.conf << EOF\nfs.file-max=6815744\nnet.ipv4.ip_forward=1\nnet.bridge.bridge-nf-call-iptables=1\nnet.bridge.bridge-nf-call-ip6tables=1\nnet.ipv4.ip_forward=1\nnet.ipv4.tcp_tw_recycle=0\nvm.swappiness=0\nvm.panic_on_oom=0\n\n# 当内核维护的arp表过于庞大时候，可以考虑优化\nnet.ipv4.neigh.default.gc_thresh1=1024\nnet.ipv4.neigh.default.gc_thresh2=4096\nnet.ipv4.neigh.default.gc_thresh3=8192\n\n# netfilter优化\nnet.netfilter.nf_conntrack_max=10485760\nnet.netfilter.nf_conntrack_tcp_timeout_established=300\nnet.netfilter.nf_conntrack_buckets=655360\n\nnet.core.netdev_max_backlog=10000\nfs.inotify.max_user_instances=524288\nfs.inotify.max_user_watches=524288\n\nEOF\n```\n\n- `fs.file-max`表示系统级别最大文件句柄数量；\n- `net.ipv4.neigh.default.gc_thresh1`表示存在于ARP高速缓存中的最少层数，如果少于这个数垃圾收集器将不会运行。缺省值是128；\n- `net.ipv4.neigh.default.gc_thresh2`保存在ARP高速缓存中的最多的记录软限制。垃圾收集器在开始收集前允许记录数超过这个数字 5 秒。缺省值是 512；\n- `net.ipv4.neigh.default.gc_thresh3`保存在ARP高速缓存中的最多记录的硬限制，一旦高速缓存中的数目高于此，垃圾收集器将马上运行。缺省值是1024；\n- `net.netfilter.nf_conntrack_max`内核内存中netfilter可以同时处理的“任务”（连接跟踪条目）；\n- `net.netfilter.nf_conntrack_buckets`哈希表大小（只读）（64位系统、8G内存默认 65536，16G翻倍，如此类推）;\n- `net.core.netdev_max_backlog`网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目；\n- `fs.inotify.max_user_instances`默认值: 128 指定了每一个real user ID可创建的inotify instatnces的数量上限；\n- `fs.inotify.max_user_watches`默认值: 8192 指定了每个inotify instance相关联的watches的上限；\n\n\n\n执行下面的命令在每个节点生效配置：\n\n```bash\nansible cluster -m copy -a 'src=/etc/sysctl.d/k8s.conf dest=/etc/sysctl.d/k8s.conf mode=0755'\nansible cluster -m shell -a 'sysctl -p /etc/sysctl.d/k8s.conf'\nansible cluster -m shell -a 'echo \"/sbin/sysctl -p /etc/sysctl.d/k8s.conf\" >> /etc/rc.local'\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署前准备\n\n{% tabs comments %}\n\n<!-- tab 设置host -->\n\n通过`ansible`为每个节点设置host文件：\n\n```bash\nansible cluster -m shell -a 'cat >> /etc/hosts <<EOF\n10.8.138.5  SCA-LUM700007 sca-lum700007 master1\n10.8.138.6  SCA-LUM700008 sca-lum700008 master2\n10.8.138.10 SCA-LUM700012 sca-lum700012 master3\n10.8.138.9  SCA-LUM700013 sca-lum700013 node1\n10.8.138.11 SCA-LUM700014 sca-lum700014 node2\nEOF'\n```\n\n<!-- endtab -->\n\n<!-- tab 安装docker -->\n\n**需要给集群所有的节点安装docker**\n\n\n\n首先添加repo文件：\n\n```bash\nansible cluster -m shell -a 'yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo'\n```\n\n\n\n设置存储目录，一般docker的数据存放路径为`/var/lib/docker`，所以在每个服务器上最好都有一个数据盘挂载到该目录下，防止docker数据过多爆盘。这里以一台服务器的设置为例：\n\n```bash\nmkdir /var/lib/docker\nmkfs.xfs -f /dev/vdb\necho \"/dev/vdb /var/lib/docker xfs defaults 0 0\" >> /etc/fstab\nmount -a\ndf -h\n```\n\n\n\n安装docker\n\n```bash\n# 查看当前可用的版本\nyum list docker-ce --showduplicates|sort -r\n\n# 安装docker\nansible cluster -m shell -a 'yum install -y docker-ce-18.06.3.ce-3.el7'\n```\n\n\n\n设置配置文件：\n\n```bash\ncat > daemon.json <<EOF\n{\n  \"exec-opts\": [\"native.cgroupdriver=systemd\"],\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n    \"max-size\": \"100m\",\n    \"max-file\": \"5\"\n  },\n  \"storage-driver\": \"overlay2\"\n}\nEOF\n\n# 分发到集群节点\nansible cluster -m shell -a 'mkdir /etc/docker'\nansible cluster -m copy -a 'src=daemon.json dest=/etc/docker/daemon.json'\n```\n\n\n\n启动服务：\n\n```bash\nansible cluster -m shell -a 'systemctl daemon-reload'\nansible cluster -m shell -a 'systemctl restart docker'\nansible cluster -m shell -a 'systemctl status docker'\nansible cluster -m shell -a 'systemctl enable docker'\n```\n\n<!-- endtab -->\n\n<!-- tab 关闭swap -->\n\n```bash\nansible cluster -m shell -a 'swapoff -a'\nansible cluster -m shell -a 'sed -i \"/swap/s/^/#/g\" /etc/fstab'\n```\n\n<!-- endtab -->\n\n<!-- tab 开启ipvs -->\n\n本集群的service网络采用ipvs模式：\n\n```bash\n# 配置内核参数\nansible cluster -m sysctl -a 'name=net.ipv4.ip_forward value=1 state=present'\nansible cluster -m sysctl -a 'name=net.bridge.bridge-nf-call-iptables value=1 state=present'\nansible cluster -m sysctl -a 'name=net.bridge.bridge-nf-call-ip6tables value=1 state=present'\n\n# 加载ipvs模块\ncat > /tmp/ipvs.modules <<EOF\n#!/bin/bash\nipvs_modules=\"ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4\"\nfor kernel_module in \\${ipvs_modules}; do\n    /sbin/modinfo -F filename \\${kernel_module} > /dev/null 2>&1\n    if [ $? -eq 0 ]; then\n        /sbin/modprobe \\${kernel_module}\n    fi\ndone\nEOF\n\nansible cluster -m copy -a 'src=/tmp/ipvs.modules dest=/root/ipvs.modules mode=0755'\nansible cluster -m shell -a 'sh /root/ipvs.modules'\n\n# 设置开机启动执行该脚本\nansible cluster -m shell -a 'echo \"sh /root/ipvs.modules\" >> /etc/rc.local'\n\n# 验证 ipvs 支持\nansible cluster -m shell -a 'lsmod | grep ip_vs'\n\n# 安装ipvsadm\nansible cluster -m yum -a 'name=ipvsadm state=present'\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 安装基础服务\n\n## 添加yum源\n\n```bash\ncat > /etc/yum.repos.d/kubernetes.repo << EOF\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\n# 分发文件\nansible cluster -m copy -a 'src=/etc/yum.repos.d/kubernetes.repo dest=/etc/yum.repos.d/kubernetes.repo'\n```\n\n\n\n## 安装kubelet、kubectl、kubeadm\n\n这里安装的是`1.17.3`版本：\n\n```bash\n# 安装kubectl、kubeadm、kubelet\nansible cluster -m shell -a 'yum install -y kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3'\n\n# 检查\nansible cluster -m shell -a 'ls /usr/bin/kube*'\n\n# 设置kubelet自启动\nansible cluster -m shell -a 'systemctl enable kubelet'\n```\n\n\n\n<br>\n\n\n\n# 部署master节点\n\n这一步在任意一个master上执行，这里我在`master1`上执行。需要配置下kubeadm的相关参数。\n\n\n\n## 配置kubeadm参数\n\n```bash\ncat > kubeadm-config.yaml << EOF\napiVersion: kubeadm.k8s.io/v1beta2\nkind: InitConfiguration\nlocalAPIEndpoint:\n  advertiseAddress: 0.0.0.0\n  bindPort: 6443\nnodeRegistration:\n  criSocket: /var/run/dockershim.sock\n  taints:\n  - effect: NoSchedule\n    key: node-role.kubernetes.io/master\n  kubeletExtraArgs:\n    cgroup-driver: \"systemd\"\n  ignorePreflightErrors:\n  - IsPrivilegedUser\n---\napiVersion: kubeadm.k8s.io/v1beta2\nkind: ClusterConfiguration\ncontrolPlaneEndpoint: 10.8.138.12:6443\ncertificatesDir: /etc/kubernetes/pki\nclusterName: kubernetes\napiServer:\n  timeoutForControlPlane: 5m0s\n  extraArgs:\n    authorization-mode: \"Node,RBAC\"\n  certSANs:\n  - \"10.8.138.12\"\n  - \"14.116.177.22\"\n  - \"kubernetes\"\n  - \"kubernetes.default\"\n  - \"kubernetes.default.svc\"\n  - \"kubernetes.default.svc.cluster\"\n  - \"kubernetes.default.svc.cluster.local\"\ncontrollerManager:\n  extraArgs:\n    \"node-cidr-mask-size\": \"20\"\nscheduler:\n  extraArgs:\n    address: \"0.0.0.0\"\ndns:\n  type: CoreDNS\netcd:\n  local:\n    dataDir: /var/lib/etcd\n#    extraArgs:\n#      listen-client-urls: \"http://10.100.0.1:2379\"\n#    serverCertSANs:\n#    serverCertSANs:\n#    - \"localhost\"\n#    - \"127.0.0.1\"\n#    peerCertSANs:\n#    - \"localhost\"\n#    - \"127.0.0.1\"\nimageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers\nkubernetesVersion: v1.17.3\nnetworking:\n  dnsDomain: cluster.local\n  serviceSubnet: 172.24.0.0/16\n  podSubnet: 172.21.0.0/16\n---\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nkind: KubeProxyConfiguration\nbindAddress: 0.0.0.0\n#clusterCIDR:\nmode: ipvs  # 定义代理模式： userspace、 iptables 或 ipvs 。默认使用 iptables ，大集群建议使用 ipvs。\nipvs:\n  scheduler: lc\n  syncPeriod: 30s\n  minSyncPeriod: 5s\n  tcpTimeout: 0s\n  tcpFinTimeout: 0s\n  udpTimeout: 0s\n---\napiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\nEOF\n```\n\n- 其中`10.8.138.12`为我前端slb的IP地址，代理后端三个master节点的6443；\n- 根据实际情况在`certSANs`中添加IP和域名；\n- 注意修改其中的kubernetes的版本，以及ipvs模式的调度算法（这里我使用的是lc）\n\n\n\n## 验证配置\n\n下面的命令可以验证配置是否有误，并不会真正执行：\n\n```bash\nkubeadm init --config=kubeadm-config.yaml --upload-certs --dry-run\n```\n\n\n\n## 创建集群\n\n```bash\n# 创建集群\nkubeadm init --config=kubeadm-config.yaml --upload-certs\n```\n\n\n\n执行成功的话，会出现下面的信息：\n\n![](./kubeadm-init.png)\n\n\n\n从上边可以看出，添加master节点和node节点就可以在对应服务器上执行下面的命令：\n\n```shell\n# 添加master\nkubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\\n    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \\\n    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c\n    \n# 添加node节点\nkubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\\n    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e\n```\n\n> 命令中的token有两个小时时效，时效后需要重新获取\n\n\n\n## 添加其他的master节点\n\n在剩下的两个master节点`SCA-LUM700008`和`SCA-LUM700012`执行下面的命令：\n\n```shell\nkubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\\n    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \\\n    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c\n```\n\n> 不需要拷贝kubeadm-config.yaml文件，会通过第一个apiserver去配置信息；\n\n\n\n## 设置kubectl\n\n\n\n```bash\n# 自动补全\nansible master -m shell -a 'echo \"source <(kubectl completion bash)\" >> ~/.bashrc'\n\n# 设置kubectl证书\ncp /etc/kubernetes/admin.conf /root/.kube/config\n```\n\n\n\n## 验证master部署情况\n\n```bash\n# 查看master\nkubectl get node --kubeconfig /etc/kubernetes/admin.conf\n\n# 查看pod\nkubectl get pod --all-namespaces --kubeconfig /etc/kubernetes/admin.conf\n```\n\n![](check-master.png)\n\n\n\n> 这里有些pod没有启动是正常的，因为集群还没部署完成。\n\n\n\n## 确认kubeproxy开启了ipvs\n\n首先查看网卡信息，多了一个kube-ipvs0网卡：\n\n```bash\n$ ip a s\n```\n\n<img src=\"./ipvs.png\" style=\"zoom:50%;\" />\n\n\n\n查看ipvs规则：\n\n```bash\n$ ipvsadm -Ln\n```\n\n<img src=\"./ipvs-rule.png\" style=\"zoom:40%;\" />\n\n\n\n<br>\n\n\n\n# 部署etcd\n\n## 更新etcd配置\n\n更新后会自动重启服务：\n\n```bash\nansible master -m shell -a 'sed -i \"/--initial-cluster=/c\\    - --initial-cluster=sca-lum700012=https://10.8.138.10:2380,sca-lum700007=https://10.8.138.5:2380,sca-lum700008=https://10.8.138.6:2380\" /etc/kubernetes/manifests/etcd.yaml'\n\n# apiserver 默认访问本地的 etcd 节点，如果需要访问集群所有节点可以修改配置。\nansible master -m shell -a 'sed -i \"/- --etcd-servers/c\\    - --etcd-servers=https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379\" /etc/kubernetes/manifests/kube-apiserver.yaml'\n```\n\n\n\n## 查看etcd节点状态\n\n```bash\n# 下载etcdctl\ncurl -L -O https://github.com/etcd-io/etcd/releases/download/v3.4.3/etcd-v3.4.3-linux-amd64.tar.gz\ntar xzf etcd-v3.4.3-linux-amd64.tar.gz\nmv etcd-v3.4.3-linux-amd64/etcd* /usr/local/bin/\n\n# 查看状态\nETCDCTL=3 etcdctl --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   member list\n```\n\n![](./etcd-member.png)\n\n\n\n## 查看集群状态\n\n```bash\nETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint status\n```\n\n![](./etcd-cluster.png)\n\n\n\n## etcd节点健康状态\n\n```bash\nETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint health\n```\n\n![](./etcd-helth.png)\n\n<br>\n\n\n\n# 部署node节点\n\n在所有node节点上执行下面的命令：\n\n```bash\nkubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\\n    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e\n```\n\n\n\n查看：\n\n```bash\nkubectl get node \n```\n\n<img src=\"./getnode.png\" style=\"zoom:67%;\" />\n\n\n\n*节点已经添加进来了，因为没有部署CNI所以都是NOTREADY。*\n\n<br>\n\n\n\n# 部署calico\n\n## 下载calico\n\n```bash\n# 下载calico的yaml文件\ncurl -L https://docs.projectcalico.org/v3.11/manifests/calico.yaml -o calico.yaml\n```\n\n\n\n## 部署calico\n\n修改calico.yaml：\n\n```yaml\n# 修改为pod网段\n- name: CALICO_IPV4POOL_CIDR\n  value: \"172.21.0.0/16\"\n  \n# 增加该参数，设定端口范围\n- name: FELIX_KUBENODEPORTRANGES\n  value: \"30000:50000\"\n```\n\n\n\n部署calico：\n\n```bash\nkubectl apply -f calico.yaml\n```\n\n\n\n部署完成后，查看节点状态，应该都READY：\n\n```bash\nkubectl get node\n```\n\n<img src=\"./nodes.png\" style=\"zoom:50%;\" />\n\n\n\n## 设置calico命令行工具\n\n下载calico命令行工具：\n\n```bash\n# 下载\ncurl -L -o /usr/local/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.11.2/calicoctl-linux-amd64\n\n# 配置\nmkdir -p /etc/calico\ncat > /etc/calico/calicoctl.cfg <<EOF\napiVersion: projectcalico.org/v3\nkind: CalicoAPIConfig\nmetadata:\nspec:\n  datastoreType: kubernetes\n  kubeconfig: /etc/kubernetes/admin.conf  # 使用 admin 配置\n  #k8sAPIEndpoint: https://10.8.138.12:6443\n  #k8sCertFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt\n  #k8sKeyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key\n  #k8sCAFile: /etc/kubernetes/pki/ca.crt\nEOF\n```\n\n\n\n## 查看calico节点\n\n```bash\ncalicoctl node status\n```\n\n<img src=\"./calico-node.png\" style=\"zoom:50%;\" />\n\n\n\n## 查看ippool\n\n```bash\ncalicoctl get ippool -o wide\n\nNAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR\ndefault-ipv4-ippool   172.21.0.0/16   true   Always     Never       false      all()\n```\n\n\n\n## 查看ip状态\n\n```bash\ncalicoctl ipam show\n```\n\n![](./calico-ip.png)\n\n<br>\n\n\n\n# 集群校验\n\n```bash\nkubectl config get-clusters\nkubectl cluster-info\n```\n\n![](./cluster-check.png)\n\n\n\n<br>\n\n\n\n# nginx服务其配置\n\n`SCA-LUM700011`作为nginx服务器，将会代理ingress服务，所以先设置一下。\n\n\n\n## 自签证书\n\n```bash\n# 确认安装了openssl\nopenssl version\n\n# 确定nginx安装了https模块(应该有--with-http_ssl_module)\nnginx -V\n\n# 创建整数目录\ncd /etc/nginx/\nmkdir ssl\ncd ssl\n\n# 生成秘钥\nopenssl genrsa -out nginx.key 2048\nGenerating RSA private key, 2048 bit long modulus\n..............................................+++\n.....................................................................+++\ne is 65537 (0x10001)\n\n# 生成签名请求文件（csr），输入上边的密码，并输入相关的信息\nopenssl req -new -key nginx.key -out nginx.csr\n\n# 也可以在一行，不用交互式输入\nopenssl req -subj \"/C=CN/ST=Guangdong/L=Shenzhen/O=nginx/OU=dev/CN=test.example.com/emailAddress=test@123.com\" -new -key nginx.key -out nginx.csr\n\n# 生成自签名证书，指定过期时间3650天，输入密码即可生成\nopenssl x509 -req -days 3650 -in nginx.csr -signkey nginx.key -out nginx.crt\n\n# 查看生成的文件\n$ ls\nnginx.crt  nginx.csr  nginx.key\n```\n\n\n\n## 修改nginx主配置文件\n\n修改`/etc/nginx/nginx.conf`文件为如下内容：\n\n```nginx\nuser  nginx;\nworker_processes  1;\n\nerror_log  /var/log/nginx/error.log warn;\npid        /var/run/nginx.pid;\n\n\nevents {\n    worker_connections  1024;\n}\n\n\nhttp {\n    include       /etc/nginx/mime.types;\n    default_type  application/octet-stream;\n\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile        on;\n    #tcp_nopush     on;\n\n    keepalive_timeout  65;\n\n    #gzip  on;\n\n    include /etc/nginx/conf.d/*.conf;\n}\n```\n\n\n\n这里使用`include`导入其他的配置文件，所有服务的nginx配置都放在`/etc/nginx/conf.d`下，如果目录不存在需要自己创建。\n\n\n\n在``/etc/nginx/conf.d`下先创建一个通用配置文件`common.ini`，这个是所有配置文件都要用的，所以抽离出来：\n\n```nginx\nlocation = /favicon.ico {\n    log_not_found off;\n    access_log off;\n}\n\nlocation ~* /\\.(svn|git)/ {\n    return 404;\n}\n```\n\n\n\n### 创建一个测试配置\n\n在`/etc/nginx/conf.d`下新建一个配置文件`https.conf`：\n\n```nginx\nserver {\n  listen 80;\n  server_name https-server.example.com;\n\n  rewrite ^(.*) https://$host$1 permanent;\n\n}\n\nserver {\n    listen 443 ssl;\n    server_name https-server.example.com;\n\n    ssl_certificate /etc/nginx/ssl/new/nginx.crt;\n    ssl_certificate_key /etc/nginx/ssl/new/nginx.key;\n\n    access_log /var/log/nginx/https-server.example.com_access.log main;\n    error_log /var/log/nginx/https-server.example.com_error.log;\n\n    location / {\n      root /usr/share/nginx/html;\n      index index.html index.htm;\n    }\n\n    include conf.d/common.ini;\n}\n```\n\n\n\n在`/usr/share/nginx/html`下创建测试页面：\n\n```bash\n$ echo \"this is https page\" > /usr/share/nginx/html/index.html\n```\n\n\n\n### 绑定host\n\n因为我是测试环境，且我要通过域名的方式访问服务，所以需要绑定host，这一步在自己的电脑上操作，过程不赘述。\n\n\n\n### 重启nginx并访问\n\n执行下面的命令检查配置并重新加载：\n\n```bash\nnginx -t\nnginx -s reload \n```\n\n\n\n然后通过浏览器访问域名：`https-server.example.com`，应该就可以看到设置的https页面了。\n\n> 注意，有的浏览器对于自签证书是不信任的，需要手动下载证书然后在电脑中导入就可以了。\n\n\n\n","slug":"kubeadm部署k8s-1-18集群","published":1,"updated":"2021-03-28T07:03:40.676Z","_id":"ckmssfie00000h0klhkf821js","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了通过kubeadm部署3master节点高可用k8s 1.17.3集群 </p><p>更新于 2021-03-28</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"集群规划\"><a href=\"#集群规划\" class=\"headerlink\" title=\"集群规划\"></a>集群规划</h1><table>\n<thead>\n<tr>\n<th align=\"center\">主机名</th>\n<th align=\"center\">IP地址</th>\n<th align=\"center\">用途</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">SCA-LUM700011</td>\n<td align=\"center\">10.8.138.8</td>\n<td align=\"center\">nginx+nfs+运维节点</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700007</td>\n<td align=\"center\">10.8.138.5</td>\n<td align=\"center\">master-1</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700008</td>\n<td align=\"center\">10.8.138.6</td>\n<td align=\"center\">Master-2</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700012</td>\n<td align=\"center\">10.8.138.10</td>\n<td align=\"center\">Master-3</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700013</td>\n<td align=\"center\">10.8.138.9</td>\n<td align=\"center\">Node-1</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700014</td>\n<td align=\"center\">10.8.138.11</td>\n<td align=\"center\">node-2</td>\n</tr>\n</tbody></table>\n<p>操作系统<code>centos7.6</code>，前端还有一个elb，地址为<code>10.8.138.12</code>，代理master的apiserver。kube-proxy使用<code>ipvs</code>模式，集群使用<code>1.17.3</code>版本</p>\n<br>\n\n\n\n<h1 id=\"安装工具\"><a href=\"#安装工具\" class=\"headerlink\" title=\"安装工具\"></a>安装工具</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装nfs</button></li><li class=\"tab\"><button data-href=\"#comments-2\">安装nginx</button></li><li class=\"tab\"><button data-href=\"#comments-3\">安装ansible</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>nfs的作用是为集群提供共享存储，nginx后面用来代理集群的ingress等服务。在<code>SCA-LUM700011</code>这台nfs服务器上有挂载的磁盘，先对其格式化并创建nfs的数据目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkfs.xfs /dev/vdb -f</span><br><span class=\"line\">mkdir -p /data/nfs-data</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/dev/vdb /data/nfs-data xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\">mount -a</span><br><span class=\"line\">df -h</span><br></pre></td></tr></table></figure>\n\n\n\n<p>安装nfs相关服务并启动nfs：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils rpcbind</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/data/nfs-data *(rw,no_root_squash)&quot;</span> &gt;&gt; /etc/exports</span><br><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl status rpcbind</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind</span><br><span class=\"line\">systemctl start nfs </span><br><span class=\"line\">systemctl status nfs</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs</span><br></pre></td></tr></table></figure>\n\n\n\n<p>在集群的每一个节点上执行下面的命令安装<code>nfs-utils</code>工具：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>nginx将作为一个代理，代理集群中的服务，这里使用yum方式安装nginx。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装依赖</span></span><br><span class=\"line\">yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加yum源</span></span><br><span class=\"line\">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[nginx-stable]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx stable repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=1</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[nginx-mainline]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx mainline repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=1</span></span><br><span class=\"line\"><span class=\"string\">enabled=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装nginx</span></span><br><span class=\"line\">yum install -y nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查</span></span><br><span class=\"line\">nginx -v</span><br><span class=\"line\">nginx -V</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动nginx</span></span><br><span class=\"line\">systemctl start nginx</span><br><span class=\"line\">systenctl status nginx</span><br><span class=\"line\">systenctl <span class=\"built_in\">enable</span> nginx</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p><code>ansible</code>可以方便批量执行指令，首先在<code>SCA-LUM700011</code>这台创建ssh key并分发到其他节点，将这台服务器作为运维节点，下面使用的ansible就在这个上面运行。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen</span><br><span class=\"line\">ssh-copy-id 10.8.138.5</span><br><span class=\"line\">ssh-copy-id 10.8.138.6</span><br><span class=\"line\">ssh-copy-id 10.8.138.10</span><br><span class=\"line\">ssh-copy-id 10.8.138.9</span><br><span class=\"line\">ssh-copy-id 10.8.138.11</span><br></pre></td></tr></table></figure>\n\n\n\n<p>安装ansible：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y ansible</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置配置文件</span></span><br><span class=\"line\">cat &gt; /etc/ansible/ansible.cfg &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[defaults]</span></span><br><span class=\"line\"><span class=\"string\">log_path = /var/log/ansible.log</span></span><br><span class=\"line\"><span class=\"string\">forks = 20</span></span><br><span class=\"line\"><span class=\"string\">host_key_checking = False</span></span><br><span class=\"line\"><span class=\"string\">retry_files_enabled = False</span></span><br><span class=\"line\"><span class=\"string\">deprecation_warnings = False</span></span><br><span class=\"line\"><span class=\"string\">nocows = True</span></span><br><span class=\"line\"><span class=\"string\">remote_user = root</span></span><br><span class=\"line\"><span class=\"string\">roles_path = roles/</span></span><br><span class=\"line\"><span class=\"string\">gathering = smart</span></span><br><span class=\"line\"><span class=\"string\">fact_caching = jsonfile</span></span><br><span class=\"line\"><span class=\"string\">fact_caching_connection = /etc/ansible/facts</span></span><br><span class=\"line\"><span class=\"string\">fact_caching_timeout = 600</span></span><br><span class=\"line\"><span class=\"string\">callback_whitelist = profile_tasks</span></span><br><span class=\"line\"><span class=\"string\">inventory_ignore_extensions = secrets.py, .pyc, .cfg, .crt, .ini</span></span><br><span class=\"line\"><span class=\"string\">timeout = 30</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[inventory]</span></span><br><span class=\"line\"><span class=\"string\">unparsed_is_failed=true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[ssh_connection]</span></span><br><span class=\"line\"><span class=\"string\">pipelining = True</span></span><br><span class=\"line\"><span class=\"string\">ssh_args = -o ControlMaster=auto -o ControlPersist=600s</span></span><br><span class=\"line\"><span class=\"string\">timeout = 10</span></span><br><span class=\"line\"><span class=\"string\">control_path = %(directory)s/%%h-%%r</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置host文件</span></span><br><span class=\"line\">cat &gt; /etc/ansible/hosts &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[cluster]</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.5  hostname=&#x27;SCA-LUM700007&#x27;</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.6  hostname=&#x27;SCA-LUM700008&#x27;</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.10 hostname=&#x27;SCA-LUM700012&#x27;</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.9  hostname=&#x27;SCA-LUM700013&#x27;</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.11 hostname=&#x27;SCA-LUM700014&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[ans]</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.8</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[master]</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.5</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.6</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.10</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[worker]</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.9</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.11</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查ansible</span></span><br><span class=\"line\">ansible cluster -m ping </span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./ansible-check.png\" style=\"zoom:40%;\" /><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n\n\n<br>\n\n<h1 id=\"内核优化\"><a href=\"#内核优化\" class=\"headerlink\" title=\"内核优化\"></a>内核优化</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">升级内核版本</button></li><li class=\"tab\"><button data-href=\"#comments-2\">设置内核参数</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p><strong>注意，我这里计划使用ipvs模式，需要升级内核版本，每台服务器都升级一下</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 载入公钥</span></span><br><span class=\"line\">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 ELRepo 最新版本</span></span><br><span class=\"line\">yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 列出可以使用的 kernel 包版本</span></span><br><span class=\"line\">yum list available --disablerepo=* --enablerepo=elrepo-kernel</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装内核</span></span><br><span class=\"line\">yum install -y kernel-lt-4.4.226-1.el7.elrepo --enablerepo=elrepo-kernel</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看可用内核</span></span><br><span class=\"line\">cat /boot/grub2/grub.cfg | grep menuentry</span><br><span class=\"line\"></span><br><span class=\"line\">menuentry <span class=\"string\">&#x27;CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)&#x27;</span> --class centos （略）</span><br><span class=\"line\">menuentry <span class=\"string\">&#x27;CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)&#x27;</span> --class centos ...（略）</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置从新的内核起动</span></span><br><span class=\"line\">grub2-set-default <span class=\"string\">&quot;CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看内核启动项</span></span><br><span class=\"line\">grub2-editenv list</span><br><span class=\"line\"></span><br><span class=\"line\">saved_entry=CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启</span></span><br><span class=\"line\">reboot</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/k8s.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">fs.file-max=6815744</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.ip_forward=1</span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.ip_forward=1</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.tcp_tw_recycle=0</span></span><br><span class=\"line\"><span class=\"string\">vm.swappiness=0</span></span><br><span class=\"line\"><span class=\"string\">vm.panic_on_oom=0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># 当内核维护的arp表过于庞大时候，可以考虑优化</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.neigh.default.gc_thresh1=1024</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.neigh.default.gc_thresh2=4096</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.neigh.default.gc_thresh3=8192</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># netfilter优化</span></span><br><span class=\"line\"><span class=\"string\">net.netfilter.nf_conntrack_max=10485760</span></span><br><span class=\"line\"><span class=\"string\">net.netfilter.nf_conntrack_tcp_timeout_established=300</span></span><br><span class=\"line\"><span class=\"string\">net.netfilter.nf_conntrack_buckets=655360</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">net.core.netdev_max_backlog=10000</span></span><br><span class=\"line\"><span class=\"string\">fs.inotify.max_user_instances=524288</span></span><br><span class=\"line\"><span class=\"string\">fs.inotify.max_user_watches=524288</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>fs.file-max</code>表示系统级别最大文件句柄数量；</li>\n<li><code>net.ipv4.neigh.default.gc_thresh1</code>表示存在于ARP高速缓存中的最少层数，如果少于这个数垃圾收集器将不会运行。缺省值是128；</li>\n<li><code>net.ipv4.neigh.default.gc_thresh2</code>保存在ARP高速缓存中的最多的记录软限制。垃圾收集器在开始收集前允许记录数超过这个数字 5 秒。缺省值是 512；</li>\n<li><code>net.ipv4.neigh.default.gc_thresh3</code>保存在ARP高速缓存中的最多记录的硬限制，一旦高速缓存中的数目高于此，垃圾收集器将马上运行。缺省值是1024；</li>\n<li><code>net.netfilter.nf_conntrack_max</code>内核内存中netfilter可以同时处理的“任务”（连接跟踪条目）；</li>\n<li><code>net.netfilter.nf_conntrack_buckets</code>哈希表大小（只读）（64位系统、8G内存默认 65536，16G翻倍，如此类推）;</li>\n<li><code>net.core.netdev_max_backlog</code>网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目；</li>\n<li><code>fs.inotify.max_user_instances</code>默认值: 128 指定了每一个real user ID可创建的inotify instatnces的数量上限；</li>\n<li><code>fs.inotify.max_user_watches</code>默认值: 8192 指定了每个inotify instance相关联的watches的上限；</li>\n</ul>\n<p>执行下面的命令在每个节点生效配置：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m copy -a <span class=\"string\">&#x27;src=/etc/sysctl.d/k8s.conf dest=/etc/sysctl.d/k8s.conf mode=0755&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;sysctl -p /etc/sysctl.d/k8s.conf&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;echo &quot;/sbin/sysctl -p /etc/sysctl.d/k8s.conf&quot; &gt;&gt; /etc/rc.local&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署前准备\"><a href=\"#部署前准备\" class=\"headerlink\" title=\"部署前准备\"></a>部署前准备</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">设置host</button></li><li class=\"tab\"><button data-href=\"#comments-2\">安装docker</button></li><li class=\"tab\"><button data-href=\"#comments-3\">关闭swap</button></li><li class=\"tab\"><button data-href=\"#comments-4\">开启ipvs</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>通过<code>ansible</code>为每个节点设置host文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.5  SCA-LUM700007 sca-lum700007 master1</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.6  SCA-LUM700008 sca-lum700008 master2</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.10 SCA-LUM700012 sca-lum700012 master3</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.9  SCA-LUM700013 sca-lum700013 node1</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.11 SCA-LUM700014 sca-lum700014 node2</span></span><br><span class=\"line\"><span class=\"string\">EOF&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p><strong>需要给集群所有的节点安装docker</strong></p>\n<p>首先添加repo文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>设置存储目录，一般docker的数据存放路径为<code>/var/lib/docker</code>，所以在每个服务器上最好都有一个数据盘挂载到该目录下，防止docker数据过多爆盘。这里以一台服务器的设置为例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /var/lib/docker</span><br><span class=\"line\">mkfs.xfs -f /dev/vdb</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/dev/vdb /var/lib/docker xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\">mount -a</span><br><span class=\"line\">df -h</span><br></pre></td></tr></table></figure>\n\n\n\n<p>安装docker</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前可用的版本</span></span><br><span class=\"line\">yum list docker-ce --showduplicates|sort -r</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装docker</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;yum install -y docker-ce-18.06.3.ce-3.el7&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>设置配置文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; daemon.json &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;log-opts&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;max-size&quot;: &quot;100m&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;max-file&quot;: &quot;5&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 分发到集群节点</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;mkdir /etc/docker&#x27;</span></span><br><span class=\"line\">ansible cluster -m copy -a <span class=\"string\">&#x27;src=daemon.json dest=/etc/docker/daemon.json&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>启动服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl daemon-reload&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl restart docker&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl status docker&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl enable docker&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;swapoff -a&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;sed -i &quot;/swap/s/^/#/g&quot; /etc/fstab&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><p>本集群的service网络采用ipvs模式：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置内核参数</span></span><br><span class=\"line\">ansible cluster -m sysctl -a <span class=\"string\">&#x27;name=net.ipv4.ip_forward value=1 state=present&#x27;</span></span><br><span class=\"line\">ansible cluster -m sysctl -a <span class=\"string\">&#x27;name=net.bridge.bridge-nf-call-iptables value=1 state=present&#x27;</span></span><br><span class=\"line\">ansible cluster -m sysctl -a <span class=\"string\">&#x27;name=net.bridge.bridge-nf-call-ip6tables value=1 state=present&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加载ipvs模块</span></span><br><span class=\"line\">cat &gt; /tmp/ipvs.modules &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"string\">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4&quot;</span></span><br><span class=\"line\"><span class=\"string\">for kernel_module in \\$&#123;ipvs_modules&#125;; do</span></span><br><span class=\"line\"><span class=\"string\">    /sbin/modinfo -F filename \\$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span></span><br><span class=\"line\"><span class=\"string\">    if [ $? -eq 0 ]; then</span></span><br><span class=\"line\"><span class=\"string\">        /sbin/modprobe \\$&#123;kernel_module&#125;</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">done</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">ansible cluster -m copy -a <span class=\"string\">&#x27;src=/tmp/ipvs.modules dest=/root/ipvs.modules mode=0755&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;sh /root/ipvs.modules&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置开机启动执行该脚本</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;echo &quot;sh /root/ipvs.modules&quot; &gt;&gt; /etc/rc.local&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证 ipvs 支持</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;lsmod | grep ip_vs&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装ipvsadm</span></span><br><span class=\"line\">ansible cluster -m yum -a <span class=\"string\">&#x27;name=ipvsadm state=present&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"安装基础服务\"><a href=\"#安装基础服务\" class=\"headerlink\" title=\"安装基础服务\"></a>安装基础服务</h1><h2 id=\"添加yum源\"><a href=\"#添加yum源\" class=\"headerlink\" title=\"添加yum源\"></a>添加yum源</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes]</span></span><br><span class=\"line\"><span class=\"string\">name=Kubernetes</span></span><br><span class=\"line\"><span class=\"string\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">repo_gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 分发文件</span></span><br><span class=\"line\">ansible cluster -m copy -a <span class=\"string\">&#x27;src=/etc/yum.repos.d/kubernetes.repo dest=/etc/yum.repos.d/kubernetes.repo&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"安装kubelet、kubectl、kubeadm\"><a href=\"#安装kubelet、kubectl、kubeadm\" class=\"headerlink\" title=\"安装kubelet、kubectl、kubeadm\"></a>安装kubelet、kubectl、kubeadm</h2><p>这里安装的是<code>1.17.3</code>版本：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装kubectl、kubeadm、kubelet</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;yum install -y kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;ls /usr/bin/kube*&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置kubelet自启动</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl enable kubelet&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署master节点\"><a href=\"#部署master节点\" class=\"headerlink\" title=\"部署master节点\"></a>部署master节点</h1><p>这一步在任意一个master上执行，这里我在<code>master1</code>上执行。需要配置下kubeadm的相关参数。</p>\n<h2 id=\"配置kubeadm参数\"><a href=\"#配置kubeadm参数\" class=\"headerlink\" title=\"配置kubeadm参数\"></a>配置kubeadm参数</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; kubeadm-config.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class=\"line\"><span class=\"string\">kind: InitConfiguration</span></span><br><span class=\"line\"><span class=\"string\">localAPIEndpoint:</span></span><br><span class=\"line\"><span class=\"string\">  advertiseAddress: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">  bindPort: 6443</span></span><br><span class=\"line\"><span class=\"string\">nodeRegistration:</span></span><br><span class=\"line\"><span class=\"string\">  criSocket: /var/run/dockershim.sock</span></span><br><span class=\"line\"><span class=\"string\">  taints:</span></span><br><span class=\"line\"><span class=\"string\">  - effect: NoSchedule</span></span><br><span class=\"line\"><span class=\"string\">    key: node-role.kubernetes.io/master</span></span><br><span class=\"line\"><span class=\"string\">  kubeletExtraArgs:</span></span><br><span class=\"line\"><span class=\"string\">    cgroup-driver: &quot;systemd&quot;</span></span><br><span class=\"line\"><span class=\"string\">  ignorePreflightErrors:</span></span><br><span class=\"line\"><span class=\"string\">  - IsPrivilegedUser</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class=\"line\"><span class=\"string\">kind: ClusterConfiguration</span></span><br><span class=\"line\"><span class=\"string\">controlPlaneEndpoint: 10.8.138.12:6443</span></span><br><span class=\"line\"><span class=\"string\">certificatesDir: /etc/kubernetes/pki</span></span><br><span class=\"line\"><span class=\"string\">clusterName: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">apiServer:</span></span><br><span class=\"line\"><span class=\"string\">  timeoutForControlPlane: 5m0s</span></span><br><span class=\"line\"><span class=\"string\">  extraArgs:</span></span><br><span class=\"line\"><span class=\"string\">    authorization-mode: &quot;Node,RBAC&quot;</span></span><br><span class=\"line\"><span class=\"string\">  certSANs:</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;10.8.138.12&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;14.116.177.22&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes.default&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes.default.svc&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes.default.svc.cluster&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class=\"line\"><span class=\"string\">controllerManager:</span></span><br><span class=\"line\"><span class=\"string\">  extraArgs:</span></span><br><span class=\"line\"><span class=\"string\">    &quot;node-cidr-mask-size&quot;: &quot;20&quot;</span></span><br><span class=\"line\"><span class=\"string\">scheduler:</span></span><br><span class=\"line\"><span class=\"string\">  extraArgs:</span></span><br><span class=\"line\"><span class=\"string\">    address: &quot;0.0.0.0&quot;</span></span><br><span class=\"line\"><span class=\"string\">dns:</span></span><br><span class=\"line\"><span class=\"string\">  type: CoreDNS</span></span><br><span class=\"line\"><span class=\"string\">etcd:</span></span><br><span class=\"line\"><span class=\"string\">  local:</span></span><br><span class=\"line\"><span class=\"string\">    dataDir: /var/lib/etcd</span></span><br><span class=\"line\"><span class=\"string\">#    extraArgs:</span></span><br><span class=\"line\"><span class=\"string\">#      listen-client-urls: &quot;http://10.100.0.1:2379&quot;</span></span><br><span class=\"line\"><span class=\"string\">#    serverCertSANs:</span></span><br><span class=\"line\"><span class=\"string\">#    serverCertSANs:</span></span><br><span class=\"line\"><span class=\"string\">#    - &quot;localhost&quot;</span></span><br><span class=\"line\"><span class=\"string\">#    - &quot;127.0.0.1&quot;</span></span><br><span class=\"line\"><span class=\"string\">#    peerCertSANs:</span></span><br><span class=\"line\"><span class=\"string\">#    - &quot;localhost&quot;</span></span><br><span class=\"line\"><span class=\"string\">#    - &quot;127.0.0.1&quot;</span></span><br><span class=\"line\"><span class=\"string\">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br><span class=\"line\"><span class=\"string\">kubernetesVersion: v1.17.3</span></span><br><span class=\"line\"><span class=\"string\">networking:</span></span><br><span class=\"line\"><span class=\"string\">  dnsDomain: cluster.local</span></span><br><span class=\"line\"><span class=\"string\">  serviceSubnet: 172.24.0.0/16</span></span><br><span class=\"line\"><span class=\"string\">  podSubnet: 172.21.0.0/16</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeProxyConfiguration</span></span><br><span class=\"line\"><span class=\"string\">bindAddress: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">#clusterCIDR:</span></span><br><span class=\"line\"><span class=\"string\">mode: ipvs  # 定义代理模式： userspace、 iptables 或 ipvs 。默认使用 iptables ，大集群建议使用 ipvs。</span></span><br><span class=\"line\"><span class=\"string\">ipvs:</span></span><br><span class=\"line\"><span class=\"string\">  scheduler: lc</span></span><br><span class=\"line\"><span class=\"string\">  syncPeriod: 30s</span></span><br><span class=\"line\"><span class=\"string\">  minSyncPeriod: 5s</span></span><br><span class=\"line\"><span class=\"string\">  tcpTimeout: 0s</span></span><br><span class=\"line\"><span class=\"string\">  tcpFinTimeout: 0s</span></span><br><span class=\"line\"><span class=\"string\">  udpTimeout: 0s</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeletConfiguration</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>其中<code>10.8.138.12</code>为我前端slb的IP地址，代理后端三个master节点的6443；</li>\n<li>根据实际情况在<code>certSANs</code>中添加IP和域名；</li>\n<li>注意修改其中的kubernetes的版本，以及ipvs模式的调度算法（这里我使用的是lc）</li>\n</ul>\n<h2 id=\"验证配置\"><a href=\"#验证配置\" class=\"headerlink\" title=\"验证配置\"></a>验证配置</h2><p>下面的命令可以验证配置是否有误，并不会真正执行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm init --config=kubeadm-config.yaml --upload-certs --dry-run</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建集群\"><a href=\"#创建集群\" class=\"headerlink\" title=\"创建集群\"></a>创建集群</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建集群</span></span><br><span class=\"line\">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行成功的话，会出现下面的信息：</p>\n<p><img src= \"/img/loading.gif\" data-src=\"./kubeadm-init.png\" alt=\"\"></p>\n<p>从上边可以看出，添加master节点和node节点就可以在对应服务器上执行下面的命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 添加master</span></span><br><span class=\"line\">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \\</span><br><span class=\"line\">    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 添加node节点</span></span><br><span class=\"line\">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>命令中的token有两个小时时效，时效后需要重新获取</p>\n</blockquote>\n<h2 id=\"添加其他的master节点\"><a href=\"#添加其他的master节点\" class=\"headerlink\" title=\"添加其他的master节点\"></a>添加其他的master节点</h2><p>在剩下的两个master节点<code>SCA-LUM700008</code>和<code>SCA-LUM700012</code>执行下面的命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \\</span><br><span class=\"line\">    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>不需要拷贝kubeadm-config.yaml文件，会通过第一个apiserver去配置信息；</p>\n</blockquote>\n<h2 id=\"设置kubectl\"><a href=\"#设置kubectl\" class=\"headerlink\" title=\"设置kubectl\"></a>设置kubectl</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 自动补全</span></span><br><span class=\"line\">ansible master -m shell -a <span class=\"string\">&#x27;echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置kubectl证书</span></span><br><span class=\"line\">cp /etc/kubernetes/admin.conf /root/.kube/config</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"验证master部署情况\"><a href=\"#验证master部署情况\" class=\"headerlink\" title=\"验证master部署情况\"></a>验证master部署情况</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看master</span></span><br><span class=\"line\">kubectl get node --kubeconfig /etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pod</span></span><br><span class=\"line\">kubectl get pod --all-namespaces --kubeconfig /etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"check-master.png\" alt=\"\"></p>\n<blockquote>\n<p>这里有些pod没有启动是正常的，因为集群还没部署完成。</p>\n</blockquote>\n<h2 id=\"确认kubeproxy开启了ipvs\"><a href=\"#确认kubeproxy开启了ipvs\" class=\"headerlink\" title=\"确认kubeproxy开启了ipvs\"></a>确认kubeproxy开启了ipvs</h2><p>首先查看网卡信息，多了一个kube-ipvs0网卡：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ip a s</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./ipvs.png\" style=\"zoom:50%;\" />\n\n\n\n<p>查看ipvs规则：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ipvsadm -Ln</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./ipvs-rule.png\" style=\"zoom:40%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"部署etcd\"><a href=\"#部署etcd\" class=\"headerlink\" title=\"部署etcd\"></a>部署etcd</h1><h2 id=\"更新etcd配置\"><a href=\"#更新etcd配置\" class=\"headerlink\" title=\"更新etcd配置\"></a>更新etcd配置</h2><p>更新后会自动重启服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible master -m shell -a <span class=\"string\">&#x27;sed -i &quot;/--initial-cluster=/c\\    - --initial-cluster=sca-lum700012=https://10.8.138.10:2380,sca-lum700007=https://10.8.138.5:2380,sca-lum700008=https://10.8.138.6:2380&quot; /etc/kubernetes/manifests/etcd.yaml&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># apiserver 默认访问本地的 etcd 节点，如果需要访问集群所有节点可以修改配置。</span></span><br><span class=\"line\">ansible master -m shell -a <span class=\"string\">&#x27;sed -i &quot;/- --etcd-servers/c\\    - --etcd-servers=https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379&quot; /etc/kubernetes/manifests/kube-apiserver.yaml&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看etcd节点状态\"><a href=\"#查看etcd节点状态\" class=\"headerlink\" title=\"查看etcd节点状态\"></a>查看etcd节点状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载etcdctl</span></span><br><span class=\"line\">curl -L -O https://github.com/etcd-io/etcd/releases/download/v3.4.3/etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class=\"line\">tar xzf etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class=\"line\">mv etcd-v3.4.3-linux-amd64/etcd* /usr/<span class=\"built_in\">local</span>/bin/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看状态</span></span><br><span class=\"line\">ETCDCTL=3 etcdctl --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   member list</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./etcd-member.png\" alt=\"\"></p>\n<h2 id=\"查看集群状态\"><a href=\"#查看集群状态\" class=\"headerlink\" title=\"查看集群状态\"></a>查看集群状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint status</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./etcd-cluster.png\" alt=\"\"></p>\n<h2 id=\"etcd节点健康状态\"><a href=\"#etcd节点健康状态\" class=\"headerlink\" title=\"etcd节点健康状态\"></a>etcd节点健康状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint health</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./etcd-helth.png\" alt=\"\"></p>\n<br>\n\n\n\n<h1 id=\"部署node节点\"><a href=\"#部署node节点\" class=\"headerlink\" title=\"部署node节点\"></a>部署node节点</h1><p>在所有node节点上执行下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e</span><br></pre></td></tr></table></figure>\n\n\n\n<p>查看：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node </span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./getnode.png\" style=\"zoom:67%;\" />\n\n\n\n<p><em>节点已经添加进来了，因为没有部署CNI所以都是NOTREADY。</em></p>\n<br>\n\n\n\n<h1 id=\"部署calico\"><a href=\"#部署calico\" class=\"headerlink\" title=\"部署calico\"></a>部署calico</h1><h2 id=\"下载calico\"><a href=\"#下载calico\" class=\"headerlink\" title=\"下载calico\"></a>下载calico</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载calico的yaml文件</span></span><br><span class=\"line\">curl -L https://docs.projectcalico.org/v3.11/manifests/calico.yaml -o calico.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"部署calico-1\"><a href=\"#部署calico-1\" class=\"headerlink\" title=\"部署calico\"></a>部署calico</h2><p>修改calico.yaml：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改为pod网段</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CALICO_IPV4POOL_CIDR</span></span><br><span class=\"line\">  <span class=\"attr\">value:</span> <span class=\"string\">&quot;172.21.0.0/16&quot;</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 增加该参数，设定端口范围</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">FELIX_KUBENODEPORTRANGES</span></span><br><span class=\"line\">  <span class=\"attr\">value:</span> <span class=\"string\">&quot;30000:50000&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>部署calico：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<p>部署完成后，查看节点状态，应该都READY：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./nodes.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"设置calico命令行工具\"><a href=\"#设置calico命令行工具\" class=\"headerlink\" title=\"设置calico命令行工具\"></a>设置calico命令行工具</h2><p>下载calico命令行工具：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载</span></span><br><span class=\"line\">curl -L -o /usr/<span class=\"built_in\">local</span>/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.11.2/calicoctl-linux-amd64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置</span></span><br><span class=\"line\">mkdir -p /etc/calico</span><br><span class=\"line\">cat &gt; /etc/calico/calicoctl.cfg &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: projectcalico.org/v3</span></span><br><span class=\"line\"><span class=\"string\">kind: CalicoAPIConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  datastoreType: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">  kubeconfig: /etc/kubernetes/admin.conf  # 使用 admin 配置</span></span><br><span class=\"line\"><span class=\"string\">  #k8sAPIEndpoint: https://10.8.138.12:6443</span></span><br><span class=\"line\"><span class=\"string\">  #k8sCertFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class=\"line\"><span class=\"string\">  #k8sKeyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class=\"line\"><span class=\"string\">  #k8sCAFile: /etc/kubernetes/pki/ca.crt</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看calico节点\"><a href=\"#查看calico节点\" class=\"headerlink\" title=\"查看calico节点\"></a>查看calico节点</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">calicoctl node status</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./calico-node.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"查看ippool\"><a href=\"#查看ippool\" class=\"headerlink\" title=\"查看ippool\"></a>查看ippool</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">calicoctl get ippool -o wide</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR</span><br><span class=\"line\">default-ipv4-ippool   172.21.0.0/16   <span class=\"literal\">true</span>   Always     Never       <span class=\"literal\">false</span>      all()</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看ip状态\"><a href=\"#查看ip状态\" class=\"headerlink\" title=\"查看ip状态\"></a>查看ip状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">calicoctl ipam show</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./calico-ip.png\" alt=\"\"></p>\n<br>\n\n\n\n<h1 id=\"集群校验\"><a href=\"#集群校验\" class=\"headerlink\" title=\"集群校验\"></a>集群校验</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl config get-clusters</span><br><span class=\"line\">kubectl cluster-info</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./cluster-check.png\" alt=\"\"></p>\n<br>\n\n\n\n<h1 id=\"nginx服务其配置\"><a href=\"#nginx服务其配置\" class=\"headerlink\" title=\"nginx服务其配置\"></a>nginx服务其配置</h1><p><code>SCA-LUM700011</code>作为nginx服务器，将会代理ingress服务，所以先设置一下。</p>\n<h2 id=\"自签证书\"><a href=\"#自签证书\" class=\"headerlink\" title=\"自签证书\"></a>自签证书</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 确认安装了openssl</span></span><br><span class=\"line\">openssl version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 确定nginx安装了https模块(应该有--with-http_ssl_module)</span></span><br><span class=\"line\">nginx -V</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建整数目录</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /etc/nginx/</span><br><span class=\"line\">mkdir ssl</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ssl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成秘钥</span></span><br><span class=\"line\">openssl genrsa -out nginx.key 2048</span><br><span class=\"line\">Generating RSA private key, 2048 bit long modulus</span><br><span class=\"line\">..............................................+++</span><br><span class=\"line\">.....................................................................+++</span><br><span class=\"line\">e is 65537 (0x10001)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成签名请求文件（csr），输入上边的密码，并输入相关的信息</span></span><br><span class=\"line\">openssl req -new -key nginx.key -out nginx.csr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 也可以在一行，不用交互式输入</span></span><br><span class=\"line\">openssl req -subj <span class=\"string\">&quot;/C=CN/ST=Guangdong/L=Shenzhen/O=nginx/OU=dev/CN=test.example.com/emailAddress=test@123.com&quot;</span> -new -key nginx.key -out nginx.csr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成自签名证书，指定过期时间3650天，输入密码即可生成</span></span><br><span class=\"line\">openssl x509 -req -days 3650 -<span class=\"keyword\">in</span> nginx.csr -signkey nginx.key -out nginx.crt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看生成的文件</span></span><br><span class=\"line\">$ ls</span><br><span class=\"line\">nginx.crt  nginx.csr  nginx.key</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"修改nginx主配置文件\"><a href=\"#修改nginx主配置文件\" class=\"headerlink\" title=\"修改nginx主配置文件\"></a>修改nginx主配置文件</h2><p>修改<code>/etc/nginx/nginx.conf</code>文件为如下内容：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">user</span>  nginx;</span><br><span class=\"line\"><span class=\"attribute\">worker_processes</span>  <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">error_log</span>  /var/log/nginx/error.log <span class=\"literal\">warn</span>;</span><br><span class=\"line\"><span class=\"attribute\">pid</span>        /var/run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">worker_connections</span>  <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">include</span>       /etc/nginx/mime.types;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span>  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">log_format</span>  main  <span class=\"string\">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">sendfile</span>        <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"comment\">#tcp_nopush     on;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">keepalive_timeout</span>  <span class=\"number\">65</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">#gzip  on;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> /etc/nginx/conf.d/<span class=\"regexp\">*.conf</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>这里使用<code>include</code>导入其他的配置文件，所有服务的nginx配置都放在<code>/etc/nginx/conf.d</code>下，如果目录不存在需要自己创建。</p>\n<p>在``/etc/nginx/conf.d<code>下先创建一个通用配置文件</code>common.ini`，这个是所有配置文件都要用的，所以抽离出来：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> = /favicon.ico &#123;</span><br><span class=\"line\">    <span class=\"attribute\">log_not_found</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">location</span> <span class=\"regexp\">~* /\\.(svn|git)/</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">404</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"创建一个测试配置\"><a href=\"#创建一个测试配置\" class=\"headerlink\" title=\"创建一个测试配置\"></a>创建一个测试配置</h3><p>在<code>/etc/nginx/conf.d</code>下新建一个配置文件<code>https.conf</code>：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> https-server.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> https://$host<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> https-server.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span> /etc/nginx/ssl/new/nginx.crt;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span> /etc/nginx/ssl/new/nginx.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> /var/log/nginx/https-server.example.com_access.log main;</span><br><span class=\"line\">    <span class=\"attribute\">error_log</span> /var/log/nginx/https-server.example.com_error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">      <span class=\"attribute\">root</span> /usr/share/nginx/html;</span><br><span class=\"line\">      <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> conf.d/common.ini;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>在<code>/usr/share/nginx/html</code>下创建测试页面：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">&quot;this is https page&quot;</span> &gt; /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"绑定host\"><a href=\"#绑定host\" class=\"headerlink\" title=\"绑定host\"></a>绑定host</h3><p>因为我是测试环境，且我要通过域名的方式访问服务，所以需要绑定host，这一步在自己的电脑上操作，过程不赘述。</p>\n<h3 id=\"重启nginx并访问\"><a href=\"#重启nginx并访问\" class=\"headerlink\" title=\"重启nginx并访问\"></a>重启nginx并访问</h3><p>执行下面的命令检查配置并重新加载：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t</span><br><span class=\"line\">nginx -s reload </span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后通过浏览器访问域名：<code>https-server.example.com</code>，应该就可以看到设置的https页面了。</p>\n<blockquote>\n<p>注意，有的浏览器对于自签证书是不信任的，需要手动下载证书然后在电脑中导入就可以了。</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了通过kubeadm部署3master节点高可用k8s 1.17.3集群 </p><p>更新于 2021-03-28</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"集群规划\"><a href=\"#集群规划\" class=\"headerlink\" title=\"集群规划\"></a>集群规划</h1><table>\n<thead>\n<tr>\n<th align=\"center\">主机名</th>\n<th align=\"center\">IP地址</th>\n<th align=\"center\">用途</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">SCA-LUM700011</td>\n<td align=\"center\">10.8.138.8</td>\n<td align=\"center\">nginx+nfs+运维节点</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700007</td>\n<td align=\"center\">10.8.138.5</td>\n<td align=\"center\">master-1</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700008</td>\n<td align=\"center\">10.8.138.6</td>\n<td align=\"center\">Master-2</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700012</td>\n<td align=\"center\">10.8.138.10</td>\n<td align=\"center\">Master-3</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700013</td>\n<td align=\"center\">10.8.138.9</td>\n<td align=\"center\">Node-1</td>\n</tr>\n<tr>\n<td align=\"center\">SCA-LUM700014</td>\n<td align=\"center\">10.8.138.11</td>\n<td align=\"center\">node-2</td>\n</tr>\n</tbody></table>\n<p>操作系统<code>centos7.6</code>，前端还有一个elb，地址为<code>10.8.138.12</code>，代理master的apiserver。kube-proxy使用<code>ipvs</code>模式，集群使用<code>1.17.3</code>版本</p>\n<br>\n\n\n\n<h1 id=\"安装工具\"><a href=\"#安装工具\" class=\"headerlink\" title=\"安装工具\"></a>安装工具</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装nfs</button></li><li class=\"tab\"><button data-href=\"#comments-2\">安装nginx</button></li><li class=\"tab\"><button data-href=\"#comments-3\">安装ansible</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>nfs的作用是为集群提供共享存储，nginx后面用来代理集群的ingress等服务。在<code>SCA-LUM700011</code>这台nfs服务器上有挂载的磁盘，先对其格式化并创建nfs的数据目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkfs.xfs /dev/vdb -f</span><br><span class=\"line\">mkdir -p /data/nfs-data</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/dev/vdb /data/nfs-data xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\">mount -a</span><br><span class=\"line\">df -h</span><br></pre></td></tr></table></figure>\n\n\n\n<p>安装nfs相关服务并启动nfs：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils rpcbind</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/data/nfs-data *(rw,no_root_squash)&quot;</span> &gt;&gt; /etc/exports</span><br><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl status rpcbind</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind</span><br><span class=\"line\">systemctl start nfs </span><br><span class=\"line\">systemctl status nfs</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs</span><br></pre></td></tr></table></figure>\n\n\n\n<p>在集群的每一个节点上执行下面的命令安装<code>nfs-utils</code>工具：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y nfs-utils </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>nginx将作为一个代理，代理集群中的服务，这里使用yum方式安装nginx。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装依赖</span></span><br><span class=\"line\">yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加yum源</span></span><br><span class=\"line\">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[nginx-stable]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx stable repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=1</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[nginx-mainline]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx mainline repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=1</span></span><br><span class=\"line\"><span class=\"string\">enabled=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装nginx</span></span><br><span class=\"line\">yum install -y nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查</span></span><br><span class=\"line\">nginx -v</span><br><span class=\"line\">nginx -V</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动nginx</span></span><br><span class=\"line\">systemctl start nginx</span><br><span class=\"line\">systenctl status nginx</span><br><span class=\"line\">systenctl <span class=\"built_in\">enable</span> nginx</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p><code>ansible</code>可以方便批量执行指令，首先在<code>SCA-LUM700011</code>这台创建ssh key并分发到其他节点，将这台服务器作为运维节点，下面使用的ansible就在这个上面运行。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen</span><br><span class=\"line\">ssh-copy-id 10.8.138.5</span><br><span class=\"line\">ssh-copy-id 10.8.138.6</span><br><span class=\"line\">ssh-copy-id 10.8.138.10</span><br><span class=\"line\">ssh-copy-id 10.8.138.9</span><br><span class=\"line\">ssh-copy-id 10.8.138.11</span><br></pre></td></tr></table></figure>\n\n\n\n<p>安装ansible：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y ansible</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置配置文件</span></span><br><span class=\"line\">cat &gt; /etc/ansible/ansible.cfg &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[defaults]</span></span><br><span class=\"line\"><span class=\"string\">log_path = /var/log/ansible.log</span></span><br><span class=\"line\"><span class=\"string\">forks = 20</span></span><br><span class=\"line\"><span class=\"string\">host_key_checking = False</span></span><br><span class=\"line\"><span class=\"string\">retry_files_enabled = False</span></span><br><span class=\"line\"><span class=\"string\">deprecation_warnings = False</span></span><br><span class=\"line\"><span class=\"string\">nocows = True</span></span><br><span class=\"line\"><span class=\"string\">remote_user = root</span></span><br><span class=\"line\"><span class=\"string\">roles_path = roles/</span></span><br><span class=\"line\"><span class=\"string\">gathering = smart</span></span><br><span class=\"line\"><span class=\"string\">fact_caching = jsonfile</span></span><br><span class=\"line\"><span class=\"string\">fact_caching_connection = /etc/ansible/facts</span></span><br><span class=\"line\"><span class=\"string\">fact_caching_timeout = 600</span></span><br><span class=\"line\"><span class=\"string\">callback_whitelist = profile_tasks</span></span><br><span class=\"line\"><span class=\"string\">inventory_ignore_extensions = secrets.py, .pyc, .cfg, .crt, .ini</span></span><br><span class=\"line\"><span class=\"string\">timeout = 30</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[inventory]</span></span><br><span class=\"line\"><span class=\"string\">unparsed_is_failed=true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[ssh_connection]</span></span><br><span class=\"line\"><span class=\"string\">pipelining = True</span></span><br><span class=\"line\"><span class=\"string\">ssh_args = -o ControlMaster=auto -o ControlPersist=600s</span></span><br><span class=\"line\"><span class=\"string\">timeout = 10</span></span><br><span class=\"line\"><span class=\"string\">control_path = %(directory)s/%%h-%%r</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置host文件</span></span><br><span class=\"line\">cat &gt; /etc/ansible/hosts &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[cluster]</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.5  hostname=&#x27;SCA-LUM700007&#x27;</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.6  hostname=&#x27;SCA-LUM700008&#x27;</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.10 hostname=&#x27;SCA-LUM700012&#x27;</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.9  hostname=&#x27;SCA-LUM700013&#x27;</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.11 hostname=&#x27;SCA-LUM700014&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[ans]</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.8</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[master]</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.5</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.6</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.10</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[worker]</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.9</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.11</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查ansible</span></span><br><span class=\"line\">ansible cluster -m ping </span><br></pre></td></tr></table></figure>\n\n<img src=\"./ansible-check.png\" style=\"zoom:40%;\" /><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n\n\n<br>\n\n<h1 id=\"内核优化\"><a href=\"#内核优化\" class=\"headerlink\" title=\"内核优化\"></a>内核优化</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">升级内核版本</button></li><li class=\"tab\"><button data-href=\"#comments-2\">设置内核参数</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p><strong>注意，我这里计划使用ipvs模式，需要升级内核版本，每台服务器都升级一下</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 载入公钥</span></span><br><span class=\"line\">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装 ELRepo 最新版本</span></span><br><span class=\"line\">yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 列出可以使用的 kernel 包版本</span></span><br><span class=\"line\">yum list available --disablerepo=* --enablerepo=elrepo-kernel</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装内核</span></span><br><span class=\"line\">yum install -y kernel-lt-4.4.226-1.el7.elrepo --enablerepo=elrepo-kernel</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看可用内核</span></span><br><span class=\"line\">cat /boot/grub2/grub.cfg | grep menuentry</span><br><span class=\"line\"></span><br><span class=\"line\">menuentry <span class=\"string\">&#x27;CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)&#x27;</span> --class centos （略）</span><br><span class=\"line\">menuentry <span class=\"string\">&#x27;CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)&#x27;</span> --class centos ...（略）</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置从新的内核起动</span></span><br><span class=\"line\">grub2-set-default <span class=\"string\">&quot;CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看内核启动项</span></span><br><span class=\"line\">grub2-editenv list</span><br><span class=\"line\"></span><br><span class=\"line\">saved_entry=CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启</span></span><br><span class=\"line\">reboot</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/k8s.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">fs.file-max=6815744</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.ip_forward=1</span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.ip_forward=1</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.tcp_tw_recycle=0</span></span><br><span class=\"line\"><span class=\"string\">vm.swappiness=0</span></span><br><span class=\"line\"><span class=\"string\">vm.panic_on_oom=0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># 当内核维护的arp表过于庞大时候，可以考虑优化</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.neigh.default.gc_thresh1=1024</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.neigh.default.gc_thresh2=4096</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.neigh.default.gc_thresh3=8192</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># netfilter优化</span></span><br><span class=\"line\"><span class=\"string\">net.netfilter.nf_conntrack_max=10485760</span></span><br><span class=\"line\"><span class=\"string\">net.netfilter.nf_conntrack_tcp_timeout_established=300</span></span><br><span class=\"line\"><span class=\"string\">net.netfilter.nf_conntrack_buckets=655360</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">net.core.netdev_max_backlog=10000</span></span><br><span class=\"line\"><span class=\"string\">fs.inotify.max_user_instances=524288</span></span><br><span class=\"line\"><span class=\"string\">fs.inotify.max_user_watches=524288</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>fs.file-max</code>表示系统级别最大文件句柄数量；</li>\n<li><code>net.ipv4.neigh.default.gc_thresh1</code>表示存在于ARP高速缓存中的最少层数，如果少于这个数垃圾收集器将不会运行。缺省值是128；</li>\n<li><code>net.ipv4.neigh.default.gc_thresh2</code>保存在ARP高速缓存中的最多的记录软限制。垃圾收集器在开始收集前允许记录数超过这个数字 5 秒。缺省值是 512；</li>\n<li><code>net.ipv4.neigh.default.gc_thresh3</code>保存在ARP高速缓存中的最多记录的硬限制，一旦高速缓存中的数目高于此，垃圾收集器将马上运行。缺省值是1024；</li>\n<li><code>net.netfilter.nf_conntrack_max</code>内核内存中netfilter可以同时处理的“任务”（连接跟踪条目）；</li>\n<li><code>net.netfilter.nf_conntrack_buckets</code>哈希表大小（只读）（64位系统、8G内存默认 65536，16G翻倍，如此类推）;</li>\n<li><code>net.core.netdev_max_backlog</code>网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目；</li>\n<li><code>fs.inotify.max_user_instances</code>默认值: 128 指定了每一个real user ID可创建的inotify instatnces的数量上限；</li>\n<li><code>fs.inotify.max_user_watches</code>默认值: 8192 指定了每个inotify instance相关联的watches的上限；</li>\n</ul>\n<p>执行下面的命令在每个节点生效配置：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m copy -a <span class=\"string\">&#x27;src=/etc/sysctl.d/k8s.conf dest=/etc/sysctl.d/k8s.conf mode=0755&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;sysctl -p /etc/sysctl.d/k8s.conf&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;echo &quot;/sbin/sysctl -p /etc/sysctl.d/k8s.conf&quot; &gt;&gt; /etc/rc.local&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署前准备\"><a href=\"#部署前准备\" class=\"headerlink\" title=\"部署前准备\"></a>部署前准备</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">设置host</button></li><li class=\"tab\"><button data-href=\"#comments-2\">安装docker</button></li><li class=\"tab\"><button data-href=\"#comments-3\">关闭swap</button></li><li class=\"tab\"><button data-href=\"#comments-4\">开启ipvs</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>通过<code>ansible</code>为每个节点设置host文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.5  SCA-LUM700007 sca-lum700007 master1</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.6  SCA-LUM700008 sca-lum700008 master2</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.10 SCA-LUM700012 sca-lum700012 master3</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.9  SCA-LUM700013 sca-lum700013 node1</span></span><br><span class=\"line\"><span class=\"string\">10.8.138.11 SCA-LUM700014 sca-lum700014 node2</span></span><br><span class=\"line\"><span class=\"string\">EOF&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p><strong>需要给集群所有的节点安装docker</strong></p>\n<p>首先添加repo文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>设置存储目录，一般docker的数据存放路径为<code>/var/lib/docker</code>，所以在每个服务器上最好都有一个数据盘挂载到该目录下，防止docker数据过多爆盘。这里以一台服务器的设置为例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /var/lib/docker</span><br><span class=\"line\">mkfs.xfs -f /dev/vdb</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/dev/vdb /var/lib/docker xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\">mount -a</span><br><span class=\"line\">df -h</span><br></pre></td></tr></table></figure>\n\n\n\n<p>安装docker</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看当前可用的版本</span></span><br><span class=\"line\">yum list docker-ce --showduplicates|sort -r</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装docker</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;yum install -y docker-ce-18.06.3.ce-3.el7&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>设置配置文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; daemon.json &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;log-opts&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;max-size&quot;: &quot;100m&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;max-file&quot;: &quot;5&quot;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 分发到集群节点</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;mkdir /etc/docker&#x27;</span></span><br><span class=\"line\">ansible cluster -m copy -a <span class=\"string\">&#x27;src=daemon.json dest=/etc/docker/daemon.json&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>启动服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl daemon-reload&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl restart docker&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl status docker&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl enable docker&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;swapoff -a&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;sed -i &quot;/swap/s/^/#/g&quot; /etc/fstab&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><p>本集群的service网络采用ipvs模式：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置内核参数</span></span><br><span class=\"line\">ansible cluster -m sysctl -a <span class=\"string\">&#x27;name=net.ipv4.ip_forward value=1 state=present&#x27;</span></span><br><span class=\"line\">ansible cluster -m sysctl -a <span class=\"string\">&#x27;name=net.bridge.bridge-nf-call-iptables value=1 state=present&#x27;</span></span><br><span class=\"line\">ansible cluster -m sysctl -a <span class=\"string\">&#x27;name=net.bridge.bridge-nf-call-ip6tables value=1 state=present&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加载ipvs模块</span></span><br><span class=\"line\">cat &gt; /tmp/ipvs.modules &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"string\">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4&quot;</span></span><br><span class=\"line\"><span class=\"string\">for kernel_module in \\$&#123;ipvs_modules&#125;; do</span></span><br><span class=\"line\"><span class=\"string\">    /sbin/modinfo -F filename \\$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span></span><br><span class=\"line\"><span class=\"string\">    if [ $? -eq 0 ]; then</span></span><br><span class=\"line\"><span class=\"string\">        /sbin/modprobe \\$&#123;kernel_module&#125;</span></span><br><span class=\"line\"><span class=\"string\">    fi</span></span><br><span class=\"line\"><span class=\"string\">done</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">ansible cluster -m copy -a <span class=\"string\">&#x27;src=/tmp/ipvs.modules dest=/root/ipvs.modules mode=0755&#x27;</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;sh /root/ipvs.modules&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置开机启动执行该脚本</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;echo &quot;sh /root/ipvs.modules&quot; &gt;&gt; /etc/rc.local&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证 ipvs 支持</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;lsmod | grep ip_vs&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装ipvsadm</span></span><br><span class=\"line\">ansible cluster -m yum -a <span class=\"string\">&#x27;name=ipvsadm state=present&#x27;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"安装基础服务\"><a href=\"#安装基础服务\" class=\"headerlink\" title=\"安装基础服务\"></a>安装基础服务</h1><h2 id=\"添加yum源\"><a href=\"#添加yum源\" class=\"headerlink\" title=\"添加yum源\"></a>添加yum源</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes]</span></span><br><span class=\"line\"><span class=\"string\">name=Kubernetes</span></span><br><span class=\"line\"><span class=\"string\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">repo_gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 分发文件</span></span><br><span class=\"line\">ansible cluster -m copy -a <span class=\"string\">&#x27;src=/etc/yum.repos.d/kubernetes.repo dest=/etc/yum.repos.d/kubernetes.repo&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"安装kubelet、kubectl、kubeadm\"><a href=\"#安装kubelet、kubectl、kubeadm\" class=\"headerlink\" title=\"安装kubelet、kubectl、kubeadm\"></a>安装kubelet、kubectl、kubeadm</h2><p>这里安装的是<code>1.17.3</code>版本：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装kubectl、kubeadm、kubelet</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;yum install -y kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;ls /usr/bin/kube*&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置kubelet自启动</span></span><br><span class=\"line\">ansible cluster -m shell -a <span class=\"string\">&#x27;systemctl enable kubelet&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署master节点\"><a href=\"#部署master节点\" class=\"headerlink\" title=\"部署master节点\"></a>部署master节点</h1><p>这一步在任意一个master上执行，这里我在<code>master1</code>上执行。需要配置下kubeadm的相关参数。</p>\n<h2 id=\"配置kubeadm参数\"><a href=\"#配置kubeadm参数\" class=\"headerlink\" title=\"配置kubeadm参数\"></a>配置kubeadm参数</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; kubeadm-config.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class=\"line\"><span class=\"string\">kind: InitConfiguration</span></span><br><span class=\"line\"><span class=\"string\">localAPIEndpoint:</span></span><br><span class=\"line\"><span class=\"string\">  advertiseAddress: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">  bindPort: 6443</span></span><br><span class=\"line\"><span class=\"string\">nodeRegistration:</span></span><br><span class=\"line\"><span class=\"string\">  criSocket: /var/run/dockershim.sock</span></span><br><span class=\"line\"><span class=\"string\">  taints:</span></span><br><span class=\"line\"><span class=\"string\">  - effect: NoSchedule</span></span><br><span class=\"line\"><span class=\"string\">    key: node-role.kubernetes.io/master</span></span><br><span class=\"line\"><span class=\"string\">  kubeletExtraArgs:</span></span><br><span class=\"line\"><span class=\"string\">    cgroup-driver: &quot;systemd&quot;</span></span><br><span class=\"line\"><span class=\"string\">  ignorePreflightErrors:</span></span><br><span class=\"line\"><span class=\"string\">  - IsPrivilegedUser</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class=\"line\"><span class=\"string\">kind: ClusterConfiguration</span></span><br><span class=\"line\"><span class=\"string\">controlPlaneEndpoint: 10.8.138.12:6443</span></span><br><span class=\"line\"><span class=\"string\">certificatesDir: /etc/kubernetes/pki</span></span><br><span class=\"line\"><span class=\"string\">clusterName: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">apiServer:</span></span><br><span class=\"line\"><span class=\"string\">  timeoutForControlPlane: 5m0s</span></span><br><span class=\"line\"><span class=\"string\">  extraArgs:</span></span><br><span class=\"line\"><span class=\"string\">    authorization-mode: &quot;Node,RBAC&quot;</span></span><br><span class=\"line\"><span class=\"string\">  certSANs:</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;10.8.138.12&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;14.116.177.22&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes.default&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes.default.svc&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes.default.svc.cluster&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class=\"line\"><span class=\"string\">controllerManager:</span></span><br><span class=\"line\"><span class=\"string\">  extraArgs:</span></span><br><span class=\"line\"><span class=\"string\">    &quot;node-cidr-mask-size&quot;: &quot;20&quot;</span></span><br><span class=\"line\"><span class=\"string\">scheduler:</span></span><br><span class=\"line\"><span class=\"string\">  extraArgs:</span></span><br><span class=\"line\"><span class=\"string\">    address: &quot;0.0.0.0&quot;</span></span><br><span class=\"line\"><span class=\"string\">dns:</span></span><br><span class=\"line\"><span class=\"string\">  type: CoreDNS</span></span><br><span class=\"line\"><span class=\"string\">etcd:</span></span><br><span class=\"line\"><span class=\"string\">  local:</span></span><br><span class=\"line\"><span class=\"string\">    dataDir: /var/lib/etcd</span></span><br><span class=\"line\"><span class=\"string\">#    extraArgs:</span></span><br><span class=\"line\"><span class=\"string\">#      listen-client-urls: &quot;http://10.100.0.1:2379&quot;</span></span><br><span class=\"line\"><span class=\"string\">#    serverCertSANs:</span></span><br><span class=\"line\"><span class=\"string\">#    serverCertSANs:</span></span><br><span class=\"line\"><span class=\"string\">#    - &quot;localhost&quot;</span></span><br><span class=\"line\"><span class=\"string\">#    - &quot;127.0.0.1&quot;</span></span><br><span class=\"line\"><span class=\"string\">#    peerCertSANs:</span></span><br><span class=\"line\"><span class=\"string\">#    - &quot;localhost&quot;</span></span><br><span class=\"line\"><span class=\"string\">#    - &quot;127.0.0.1&quot;</span></span><br><span class=\"line\"><span class=\"string\">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br><span class=\"line\"><span class=\"string\">kubernetesVersion: v1.17.3</span></span><br><span class=\"line\"><span class=\"string\">networking:</span></span><br><span class=\"line\"><span class=\"string\">  dnsDomain: cluster.local</span></span><br><span class=\"line\"><span class=\"string\">  serviceSubnet: 172.24.0.0/16</span></span><br><span class=\"line\"><span class=\"string\">  podSubnet: 172.21.0.0/16</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeProxyConfiguration</span></span><br><span class=\"line\"><span class=\"string\">bindAddress: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">#clusterCIDR:</span></span><br><span class=\"line\"><span class=\"string\">mode: ipvs  # 定义代理模式： userspace、 iptables 或 ipvs 。默认使用 iptables ，大集群建议使用 ipvs。</span></span><br><span class=\"line\"><span class=\"string\">ipvs:</span></span><br><span class=\"line\"><span class=\"string\">  scheduler: lc</span></span><br><span class=\"line\"><span class=\"string\">  syncPeriod: 30s</span></span><br><span class=\"line\"><span class=\"string\">  minSyncPeriod: 5s</span></span><br><span class=\"line\"><span class=\"string\">  tcpTimeout: 0s</span></span><br><span class=\"line\"><span class=\"string\">  tcpFinTimeout: 0s</span></span><br><span class=\"line\"><span class=\"string\">  udpTimeout: 0s</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeletConfiguration</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>其中<code>10.8.138.12</code>为我前端slb的IP地址，代理后端三个master节点的6443；</li>\n<li>根据实际情况在<code>certSANs</code>中添加IP和域名；</li>\n<li>注意修改其中的kubernetes的版本，以及ipvs模式的调度算法（这里我使用的是lc）</li>\n</ul>\n<h2 id=\"验证配置\"><a href=\"#验证配置\" class=\"headerlink\" title=\"验证配置\"></a>验证配置</h2><p>下面的命令可以验证配置是否有误，并不会真正执行：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm init --config=kubeadm-config.yaml --upload-certs --dry-run</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建集群\"><a href=\"#创建集群\" class=\"headerlink\" title=\"创建集群\"></a>创建集群</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建集群</span></span><br><span class=\"line\">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br></pre></td></tr></table></figure>\n\n\n\n<p>执行成功的话，会出现下面的信息：</p>\n<p><img src=\"./kubeadm-init.png\" alt=\"\"></p>\n<p>从上边可以看出，添加master节点和node节点就可以在对应服务器上执行下面的命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 添加master</span></span><br><span class=\"line\">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \\</span><br><span class=\"line\">    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 添加node节点</span></span><br><span class=\"line\">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>命令中的token有两个小时时效，时效后需要重新获取</p>\n</blockquote>\n<h2 id=\"添加其他的master节点\"><a href=\"#添加其他的master节点\" class=\"headerlink\" title=\"添加其他的master节点\"></a>添加其他的master节点</h2><p>在剩下的两个master节点<code>SCA-LUM700008</code>和<code>SCA-LUM700012</code>执行下面的命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \\</span><br><span class=\"line\">    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>不需要拷贝kubeadm-config.yaml文件，会通过第一个apiserver去配置信息；</p>\n</blockquote>\n<h2 id=\"设置kubectl\"><a href=\"#设置kubectl\" class=\"headerlink\" title=\"设置kubectl\"></a>设置kubectl</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 自动补全</span></span><br><span class=\"line\">ansible master -m shell -a <span class=\"string\">&#x27;echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置kubectl证书</span></span><br><span class=\"line\">cp /etc/kubernetes/admin.conf /root/.kube/config</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"验证master部署情况\"><a href=\"#验证master部署情况\" class=\"headerlink\" title=\"验证master部署情况\"></a>验证master部署情况</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看master</span></span><br><span class=\"line\">kubectl get node --kubeconfig /etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看pod</span></span><br><span class=\"line\">kubectl get pod --all-namespaces --kubeconfig /etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"check-master.png\" alt=\"\"></p>\n<blockquote>\n<p>这里有些pod没有启动是正常的，因为集群还没部署完成。</p>\n</blockquote>\n<h2 id=\"确认kubeproxy开启了ipvs\"><a href=\"#确认kubeproxy开启了ipvs\" class=\"headerlink\" title=\"确认kubeproxy开启了ipvs\"></a>确认kubeproxy开启了ipvs</h2><p>首先查看网卡信息，多了一个kube-ipvs0网卡：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ip a s</span><br></pre></td></tr></table></figure>\n\n<img src=\"./ipvs.png\" style=\"zoom:50%;\" />\n\n\n\n<p>查看ipvs规则：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ ipvsadm -Ln</span><br></pre></td></tr></table></figure>\n\n<img src=\"./ipvs-rule.png\" style=\"zoom:40%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"部署etcd\"><a href=\"#部署etcd\" class=\"headerlink\" title=\"部署etcd\"></a>部署etcd</h1><h2 id=\"更新etcd配置\"><a href=\"#更新etcd配置\" class=\"headerlink\" title=\"更新etcd配置\"></a>更新etcd配置</h2><p>更新后会自动重启服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible master -m shell -a <span class=\"string\">&#x27;sed -i &quot;/--initial-cluster=/c\\    - --initial-cluster=sca-lum700012=https://10.8.138.10:2380,sca-lum700007=https://10.8.138.5:2380,sca-lum700008=https://10.8.138.6:2380&quot; /etc/kubernetes/manifests/etcd.yaml&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># apiserver 默认访问本地的 etcd 节点，如果需要访问集群所有节点可以修改配置。</span></span><br><span class=\"line\">ansible master -m shell -a <span class=\"string\">&#x27;sed -i &quot;/- --etcd-servers/c\\    - --etcd-servers=https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379&quot; /etc/kubernetes/manifests/kube-apiserver.yaml&#x27;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看etcd节点状态\"><a href=\"#查看etcd节点状态\" class=\"headerlink\" title=\"查看etcd节点状态\"></a>查看etcd节点状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载etcdctl</span></span><br><span class=\"line\">curl -L -O https://github.com/etcd-io/etcd/releases/download/v3.4.3/etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class=\"line\">tar xzf etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class=\"line\">mv etcd-v3.4.3-linux-amd64/etcd* /usr/<span class=\"built_in\">local</span>/bin/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看状态</span></span><br><span class=\"line\">ETCDCTL=3 etcdctl --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   member list</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./etcd-member.png\" alt=\"\"></p>\n<h2 id=\"查看集群状态\"><a href=\"#查看集群状态\" class=\"headerlink\" title=\"查看集群状态\"></a>查看集群状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint status</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./etcd-cluster.png\" alt=\"\"></p>\n<h2 id=\"etcd节点健康状态\"><a href=\"#etcd节点健康状态\" class=\"headerlink\" title=\"etcd节点健康状态\"></a>etcd节点健康状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint health</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./etcd-helth.png\" alt=\"\"></p>\n<br>\n\n\n\n<h1 id=\"部署node节点\"><a href=\"#部署node节点\" class=\"headerlink\" title=\"部署node节点\"></a>部署node节点</h1><p>在所有node节点上执行下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e</span><br></pre></td></tr></table></figure>\n\n\n\n<p>查看：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node </span><br></pre></td></tr></table></figure>\n\n<img src=\"./getnode.png\" style=\"zoom:67%;\" />\n\n\n\n<p><em>节点已经添加进来了，因为没有部署CNI所以都是NOTREADY。</em></p>\n<br>\n\n\n\n<h1 id=\"部署calico\"><a href=\"#部署calico\" class=\"headerlink\" title=\"部署calico\"></a>部署calico</h1><h2 id=\"下载calico\"><a href=\"#下载calico\" class=\"headerlink\" title=\"下载calico\"></a>下载calico</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载calico的yaml文件</span></span><br><span class=\"line\">curl -L https://docs.projectcalico.org/v3.11/manifests/calico.yaml -o calico.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"部署calico-1\"><a href=\"#部署calico-1\" class=\"headerlink\" title=\"部署calico\"></a>部署calico</h2><p>修改calico.yaml：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改为pod网段</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CALICO_IPV4POOL_CIDR</span></span><br><span class=\"line\">  <span class=\"attr\">value:</span> <span class=\"string\">&quot;172.21.0.0/16&quot;</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 增加该参数，设定端口范围</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">FELIX_KUBENODEPORTRANGES</span></span><br><span class=\"line\">  <span class=\"attr\">value:</span> <span class=\"string\">&quot;30000:50000&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>部署calico：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<p>部署完成后，查看节点状态，应该都READY：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node</span><br></pre></td></tr></table></figure>\n\n<img src=\"./nodes.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"设置calico命令行工具\"><a href=\"#设置calico命令行工具\" class=\"headerlink\" title=\"设置calico命令行工具\"></a>设置calico命令行工具</h2><p>下载calico命令行工具：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 下载</span></span><br><span class=\"line\">curl -L -o /usr/<span class=\"built_in\">local</span>/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.11.2/calicoctl-linux-amd64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 配置</span></span><br><span class=\"line\">mkdir -p /etc/calico</span><br><span class=\"line\">cat &gt; /etc/calico/calicoctl.cfg &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: projectcalico.org/v3</span></span><br><span class=\"line\"><span class=\"string\">kind: CalicoAPIConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  datastoreType: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">  kubeconfig: /etc/kubernetes/admin.conf  # 使用 admin 配置</span></span><br><span class=\"line\"><span class=\"string\">  #k8sAPIEndpoint: https://10.8.138.12:6443</span></span><br><span class=\"line\"><span class=\"string\">  #k8sCertFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class=\"line\"><span class=\"string\">  #k8sKeyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class=\"line\"><span class=\"string\">  #k8sCAFile: /etc/kubernetes/pki/ca.crt</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看calico节点\"><a href=\"#查看calico节点\" class=\"headerlink\" title=\"查看calico节点\"></a>查看calico节点</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">calicoctl node status</span><br></pre></td></tr></table></figure>\n\n<img src=\"./calico-node.png\" style=\"zoom:50%;\" />\n\n\n\n<h2 id=\"查看ippool\"><a href=\"#查看ippool\" class=\"headerlink\" title=\"查看ippool\"></a>查看ippool</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">calicoctl get ippool -o wide</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR</span><br><span class=\"line\">default-ipv4-ippool   172.21.0.0/16   <span class=\"literal\">true</span>   Always     Never       <span class=\"literal\">false</span>      all()</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看ip状态\"><a href=\"#查看ip状态\" class=\"headerlink\" title=\"查看ip状态\"></a>查看ip状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">calicoctl ipam show</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./calico-ip.png\" alt=\"\"></p>\n<br>\n\n\n\n<h1 id=\"集群校验\"><a href=\"#集群校验\" class=\"headerlink\" title=\"集群校验\"></a>集群校验</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl config get-clusters</span><br><span class=\"line\">kubectl cluster-info</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./cluster-check.png\" alt=\"\"></p>\n<br>\n\n\n\n<h1 id=\"nginx服务其配置\"><a href=\"#nginx服务其配置\" class=\"headerlink\" title=\"nginx服务其配置\"></a>nginx服务其配置</h1><p><code>SCA-LUM700011</code>作为nginx服务器，将会代理ingress服务，所以先设置一下。</p>\n<h2 id=\"自签证书\"><a href=\"#自签证书\" class=\"headerlink\" title=\"自签证书\"></a>自签证书</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 确认安装了openssl</span></span><br><span class=\"line\">openssl version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 确定nginx安装了https模块(应该有--with-http_ssl_module)</span></span><br><span class=\"line\">nginx -V</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建整数目录</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /etc/nginx/</span><br><span class=\"line\">mkdir ssl</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ssl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成秘钥</span></span><br><span class=\"line\">openssl genrsa -out nginx.key 2048</span><br><span class=\"line\">Generating RSA private key, 2048 bit long modulus</span><br><span class=\"line\">..............................................+++</span><br><span class=\"line\">.....................................................................+++</span><br><span class=\"line\">e is 65537 (0x10001)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成签名请求文件（csr），输入上边的密码，并输入相关的信息</span></span><br><span class=\"line\">openssl req -new -key nginx.key -out nginx.csr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 也可以在一行，不用交互式输入</span></span><br><span class=\"line\">openssl req -subj <span class=\"string\">&quot;/C=CN/ST=Guangdong/L=Shenzhen/O=nginx/OU=dev/CN=test.example.com/emailAddress=test@123.com&quot;</span> -new -key nginx.key -out nginx.csr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成自签名证书，指定过期时间3650天，输入密码即可生成</span></span><br><span class=\"line\">openssl x509 -req -days 3650 -<span class=\"keyword\">in</span> nginx.csr -signkey nginx.key -out nginx.crt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看生成的文件</span></span><br><span class=\"line\">$ ls</span><br><span class=\"line\">nginx.crt  nginx.csr  nginx.key</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"修改nginx主配置文件\"><a href=\"#修改nginx主配置文件\" class=\"headerlink\" title=\"修改nginx主配置文件\"></a>修改nginx主配置文件</h2><p>修改<code>/etc/nginx/nginx.conf</code>文件为如下内容：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">user</span>  nginx;</span><br><span class=\"line\"><span class=\"attribute\">worker_processes</span>  <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">error_log</span>  /var/log/nginx/error.log <span class=\"literal\">warn</span>;</span><br><span class=\"line\"><span class=\"attribute\">pid</span>        /var/run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">worker_connections</span>  <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">include</span>       /etc/nginx/mime.types;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span>  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">log_format</span>  main  <span class=\"string\">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">sendfile</span>        <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"comment\">#tcp_nopush     on;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">keepalive_timeout</span>  <span class=\"number\">65</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">#gzip  on;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> /etc/nginx/conf.d/<span class=\"regexp\">*.conf</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>这里使用<code>include</code>导入其他的配置文件，所有服务的nginx配置都放在<code>/etc/nginx/conf.d</code>下，如果目录不存在需要自己创建。</p>\n<p>在``/etc/nginx/conf.d<code>下先创建一个通用配置文件</code>common.ini`，这个是所有配置文件都要用的，所以抽离出来：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">location</span> = /favicon.ico &#123;</span><br><span class=\"line\">    <span class=\"attribute\">log_not_found</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">location</span> <span class=\"regexp\">~* /\\.(svn|git)/</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">404</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"创建一个测试配置\"><a href=\"#创建一个测试配置\" class=\"headerlink\" title=\"创建一个测试配置\"></a>创建一个测试配置</h3><p>在<code>/etc/nginx/conf.d</code>下新建一个配置文件<code>https.conf</code>：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">  <span class=\"attribute\">server_name</span> https-server.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> https://$host<span class=\"variable\">$1</span> <span class=\"literal\">permanent</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> https-server.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate</span> /etc/nginx/ssl/new/nginx.crt;</span><br><span class=\"line\">    <span class=\"attribute\">ssl_certificate_key</span> /etc/nginx/ssl/new/nginx.key;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">access_log</span> /var/log/nginx/https-server.example.com_access.log main;</span><br><span class=\"line\">    <span class=\"attribute\">error_log</span> /var/log/nginx/https-server.example.com_error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">location</span> / &#123;</span><br><span class=\"line\">      <span class=\"attribute\">root</span> /usr/share/nginx/html;</span><br><span class=\"line\">      <span class=\"attribute\">index</span> index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">include</span> conf.d/common.ini;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<p>在<code>/usr/share/nginx/html</code>下创建测试页面：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">echo</span> <span class=\"string\">&quot;this is https page&quot;</span> &gt; /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"绑定host\"><a href=\"#绑定host\" class=\"headerlink\" title=\"绑定host\"></a>绑定host</h3><p>因为我是测试环境，且我要通过域名的方式访问服务，所以需要绑定host，这一步在自己的电脑上操作，过程不赘述。</p>\n<h3 id=\"重启nginx并访问\"><a href=\"#重启nginx并访问\" class=\"headerlink\" title=\"重启nginx并访问\"></a>重启nginx并访问</h3><p>执行下面的命令检查配置并重新加载：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -t</span><br><span class=\"line\">nginx -s reload </span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后通过浏览器访问域名：<code>https-server.example.com</code>，应该就可以看到设置的https页面了。</p>\n<blockquote>\n<p>注意，有的浏览器对于自签证书是不信任的，需要手动下载证书然后在电脑中导入就可以了。</p>\n</blockquote>\n"},{"title":"使用k3d和traefik快速搭建开发环境","date":"2021-03-28T07:04:38.000Z","description":"使用k3s和treafik快速搭建一个k8s开发环境","cover":"https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3084171116,3613775985&fm=26&gp=0.jpg","_content":"\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用k3d和traefik快速搭建开发环境\n\n更新于 2021-03-28\n\n{% endnote %}\n\n<br>\n\n\n\n# 介绍\n\n一套完成的k8s系统比较复杂，需要很多的资源，部署起来也需要较长的时间。如果是开发环境，对于集群要求快速停止和开启、可以有多个集群并行、使用最少的资源，k3d就可以满足。\n\n\n\nk3d是一个非常轻量的集群，可以快速构建用于开发的k8s集群，其具有一下的特点：\n\n- 集群默认使用sqlite而不是etcd存储数据；\n- 所有的组件都封装在一个二进制程序中；\n- 在docker内运行，快速启停；\n\n\n\n<br>\n\n\n\n# k3d启动集群\n\n\n\n## 安装k3d\n\n直接运行下面的命令安装k3s：\n\n```bash\ncurl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash\n```\n\n\n\n这个会在系统中安装`k3d`命令程序，使用下面的命令查看帮助信息：\n\n```bash\nk3d -h\n```\n\n\n\n\n\n## 启动集群\n\n使用下面的命令启动集群：\n\n```bash\nk3d cluster create devcluster \\\n--api-port 127.0.0.1:6443 \\\n-p 80:80@loadbalancer \\\n-p 443:443@loadbalancer \\\n--k3s-server-arg \"--no-deploy=traefik\"\n```\n\n\n\n> 默认的k3d绑定的是traefik1，这里使用其他控制器，所以默认不安装\n\n\n\n在某些云环境下，只能使用docker的host网络模式，那么创建集群则使用下面的命令：\n\n```bash\nk3d cluster create devcluster \\\n--network host \\\n--api-port 127.0.0.1:6443 \\\n-p 80:80@loadbalancer \\\n-p 443:443@loadbalancer \\\n--k3s-server-arg \"--no-deploy=traefik\" \\\n--no-hostip\n```\n\n\n\n> 指定network类型为host，并不将宿主机ip地址替换到程序中\n\n\n\n## 查看集群\n\n查看当前创建的集群直接使用下面的命令：\n\n```bash\nk3d cluster ls\n\nNAME         SERVERS   AGENTS   LOADBALANCER\ndevcluster   1/1       0/0      false\n```\n\n\n\n可以看到当前的集群已经创建好了\n\n\n\n## 设置kubectl\n\n首先设置yum源，安装kubectl：\n\n```bash\ncat > /etc/yum.repos.d/kubernetes.repo << EOF\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\nyum install -y kubectl-1.17.3\n```\n\n\n\n然后获取集群`devcluster`的认证信息：\n\n```bash\nk3d kubeconfig get devcluster > /root/.kube/config\n```\n\n\n\n现在就可以使用kubectl来操作集群了：\n\n```bash\nkubectl get node \nNAME                      STATUS   ROLES    AGE   VERSION\nk3d-devcluster-server-0   Ready    master   26m   v1.19.3+k3s2\n\nkubectl get pod --all-namespaces \nNAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE\nkube-system   metrics-server-7b4f8b595-pghbq           1/1     Running   0          26m\nkube-system   local-path-provisioner-7ff9579c6-hmg6k   1/1     Running   0          26m\nkube-system   coredns-66c464876b-5lpn5                 1/1     Running   0          26m\n```\n\n\n\n<br>\n\n\n\n# 部署traefik 2\n\n## 安装helm3\n\n```bash\nwget https://get.helm.sh/helm-v3.2.1-linux-amd64.tar.gz\ntar zxf helm-v3.2.1-linux-amd64.tar.gz\ncp linux-amd64/helm /usr/local/bin/\nhelm version\n\nversion.BuildInfo{Version:\"v3.2.1\", GitCommit:\"fe51cd1e31e6a202cba7dead9552a6d418ded79a\", GitTreeState:\"clean\", GoVersion:\"go1.13.10\"}\n```\n\n\n\n## 安装traefik 2\n\n```bash\nhelm repo add traefik https://containous.github.io/traefik-helm-chart\nhelm repo list\nhelm install traefik traefik/traefik\nkubectl get pod -n default\n\nNAME                       READY   STATUS    RESTARTS   AGE\nsvclb-traefik-ldtfr        2/2     Running   0          26s\ntraefik-5fc4947cf9-w695g   1/1     Running   0          26s\n```\n\n\n\n## 设置traefik的dashboard\n\n```bash\nkubectl port-forward $(kubectl get pods --selector \"app.kubernetes.io/name=traefik\" --output=name) --address 0.0.0.0 9000:9000\n```\n\n\n\n通过浏览器访问`http://<宿主机IP>:9000/dashboard/`即可进入traefik的dashboard\n\n![](./dashboard.png)\n\n\n\n<br>\n\n\n\n# 应用部署\n\n这里部署一个`whoami`的测试服务：\n\n```bash\nkubectl create deploy whoami --image containous/whoami\nkubectl expose deploy whoami --port 80\n```\n\n\n\n然后创建一个ingress暴露服务让外部访问：\n\n```yaml\n# whoami-ingress.yaml\napiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\n  name: whoami\n  annotations:\n    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure\n    traefik.ingress.kubernetes.io/router.tls: \"true\"\nspec:\n  rules:\n  - http:\n      paths:\n      - path: /\n        backend:\n          serviceName: whoami\n          servicePort: 80\n```\n\n\n\n使用下面的命令进行创建：\n\n```bash\nkubectl apply -f whoami-ingress.yaml\nkubectl get ingress\n```\n\n\n\n直接在浏览器，访问：`https://<宿主机IP>`即可：\n\n![](./whoami.png)\n\n","source":"_posts/使用k3d和traefik快速搭建开发环境.md","raw":"---\ntitle: 使用k3d和traefik快速搭建开发环境\ndate: 2021-03-28 15:04:38\ntags:\n- Kubernetes\ncategories:\n- Kubernetes\n- 集群部署\ndescription: 使用k3s和treafik快速搭建一个k8s开发环境\ncover: https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3084171116,3613775985&fm=26&gp=0.jpg\n---\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用k3d和traefik快速搭建开发环境\n\n更新于 2021-03-28\n\n{% endnote %}\n\n<br>\n\n\n\n# 介绍\n\n一套完成的k8s系统比较复杂，需要很多的资源，部署起来也需要较长的时间。如果是开发环境，对于集群要求快速停止和开启、可以有多个集群并行、使用最少的资源，k3d就可以满足。\n\n\n\nk3d是一个非常轻量的集群，可以快速构建用于开发的k8s集群，其具有一下的特点：\n\n- 集群默认使用sqlite而不是etcd存储数据；\n- 所有的组件都封装在一个二进制程序中；\n- 在docker内运行，快速启停；\n\n\n\n<br>\n\n\n\n# k3d启动集群\n\n\n\n## 安装k3d\n\n直接运行下面的命令安装k3s：\n\n```bash\ncurl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash\n```\n\n\n\n这个会在系统中安装`k3d`命令程序，使用下面的命令查看帮助信息：\n\n```bash\nk3d -h\n```\n\n\n\n\n\n## 启动集群\n\n使用下面的命令启动集群：\n\n```bash\nk3d cluster create devcluster \\\n--api-port 127.0.0.1:6443 \\\n-p 80:80@loadbalancer \\\n-p 443:443@loadbalancer \\\n--k3s-server-arg \"--no-deploy=traefik\"\n```\n\n\n\n> 默认的k3d绑定的是traefik1，这里使用其他控制器，所以默认不安装\n\n\n\n在某些云环境下，只能使用docker的host网络模式，那么创建集群则使用下面的命令：\n\n```bash\nk3d cluster create devcluster \\\n--network host \\\n--api-port 127.0.0.1:6443 \\\n-p 80:80@loadbalancer \\\n-p 443:443@loadbalancer \\\n--k3s-server-arg \"--no-deploy=traefik\" \\\n--no-hostip\n```\n\n\n\n> 指定network类型为host，并不将宿主机ip地址替换到程序中\n\n\n\n## 查看集群\n\n查看当前创建的集群直接使用下面的命令：\n\n```bash\nk3d cluster ls\n\nNAME         SERVERS   AGENTS   LOADBALANCER\ndevcluster   1/1       0/0      false\n```\n\n\n\n可以看到当前的集群已经创建好了\n\n\n\n## 设置kubectl\n\n首先设置yum源，安装kubectl：\n\n```bash\ncat > /etc/yum.repos.d/kubernetes.repo << EOF\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0\ngpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\nEOF\n\nyum install -y kubectl-1.17.3\n```\n\n\n\n然后获取集群`devcluster`的认证信息：\n\n```bash\nk3d kubeconfig get devcluster > /root/.kube/config\n```\n\n\n\n现在就可以使用kubectl来操作集群了：\n\n```bash\nkubectl get node \nNAME                      STATUS   ROLES    AGE   VERSION\nk3d-devcluster-server-0   Ready    master   26m   v1.19.3+k3s2\n\nkubectl get pod --all-namespaces \nNAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE\nkube-system   metrics-server-7b4f8b595-pghbq           1/1     Running   0          26m\nkube-system   local-path-provisioner-7ff9579c6-hmg6k   1/1     Running   0          26m\nkube-system   coredns-66c464876b-5lpn5                 1/1     Running   0          26m\n```\n\n\n\n<br>\n\n\n\n# 部署traefik 2\n\n## 安装helm3\n\n```bash\nwget https://get.helm.sh/helm-v3.2.1-linux-amd64.tar.gz\ntar zxf helm-v3.2.1-linux-amd64.tar.gz\ncp linux-amd64/helm /usr/local/bin/\nhelm version\n\nversion.BuildInfo{Version:\"v3.2.1\", GitCommit:\"fe51cd1e31e6a202cba7dead9552a6d418ded79a\", GitTreeState:\"clean\", GoVersion:\"go1.13.10\"}\n```\n\n\n\n## 安装traefik 2\n\n```bash\nhelm repo add traefik https://containous.github.io/traefik-helm-chart\nhelm repo list\nhelm install traefik traefik/traefik\nkubectl get pod -n default\n\nNAME                       READY   STATUS    RESTARTS   AGE\nsvclb-traefik-ldtfr        2/2     Running   0          26s\ntraefik-5fc4947cf9-w695g   1/1     Running   0          26s\n```\n\n\n\n## 设置traefik的dashboard\n\n```bash\nkubectl port-forward $(kubectl get pods --selector \"app.kubernetes.io/name=traefik\" --output=name) --address 0.0.0.0 9000:9000\n```\n\n\n\n通过浏览器访问`http://<宿主机IP>:9000/dashboard/`即可进入traefik的dashboard\n\n![](./dashboard.png)\n\n\n\n<br>\n\n\n\n# 应用部署\n\n这里部署一个`whoami`的测试服务：\n\n```bash\nkubectl create deploy whoami --image containous/whoami\nkubectl expose deploy whoami --port 80\n```\n\n\n\n然后创建一个ingress暴露服务让外部访问：\n\n```yaml\n# whoami-ingress.yaml\napiVersion: networking.k8s.io/v1beta1\nkind: Ingress\nmetadata:\n  name: whoami\n  annotations:\n    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure\n    traefik.ingress.kubernetes.io/router.tls: \"true\"\nspec:\n  rules:\n  - http:\n      paths:\n      - path: /\n        backend:\n          serviceName: whoami\n          servicePort: 80\n```\n\n\n\n使用下面的命令进行创建：\n\n```bash\nkubectl apply -f whoami-ingress.yaml\nkubectl get ingress\n```\n\n\n\n直接在浏览器，访问：`https://<宿主机IP>`即可：\n\n![](./whoami.png)\n\n","slug":"使用k3d和traefik快速搭建开发环境","published":1,"updated":"2021-03-28T07:09:20.912Z","_id":"ckmsthprc0000vwklbrbd652u","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用k3d和traefik快速搭建开发环境</p><p>更新于 2021-03-28</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h1><p>一套完成的k8s系统比较复杂，需要很多的资源，部署起来也需要较长的时间。如果是开发环境，对于集群要求快速停止和开启、可以有多个集群并行、使用最少的资源，k3d就可以满足。</p>\n<p>k3d是一个非常轻量的集群，可以快速构建用于开发的k8s集群，其具有一下的特点：</p>\n<ul>\n<li>集群默认使用sqlite而不是etcd存储数据；</li>\n<li>所有的组件都封装在一个二进制程序中；</li>\n<li>在docker内运行，快速启停；</li>\n</ul>\n<br>\n\n\n\n<h1 id=\"k3d启动集群\"><a href=\"#k3d启动集群\" class=\"headerlink\" title=\"k3d启动集群\"></a>k3d启动集群</h1><h2 id=\"安装k3d\"><a href=\"#安装k3d\" class=\"headerlink\" title=\"安装k3d\"></a>安装k3d</h2><p>直接运行下面的命令安装k3s：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash</span><br></pre></td></tr></table></figure>\n\n\n\n<p>这个会在系统中安装<code>k3d</code>命令程序，使用下面的命令查看帮助信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d -h</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"启动集群\"><a href=\"#启动集群\" class=\"headerlink\" title=\"启动集群\"></a>启动集群</h2><p>使用下面的命令启动集群：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d cluster create devcluster \\</span><br><span class=\"line\">--api-port 127.0.0.1:6443 \\</span><br><span class=\"line\">-p 80:80@loadbalancer \\</span><br><span class=\"line\">-p 443:443@loadbalancer \\</span><br><span class=\"line\">--k3s-server-arg <span class=\"string\">&quot;--no-deploy=traefik&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>默认的k3d绑定的是traefik1，这里使用其他控制器，所以默认不安装</p>\n</blockquote>\n<p>在某些云环境下，只能使用docker的host网络模式，那么创建集群则使用下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d cluster create devcluster \\</span><br><span class=\"line\">--network host \\</span><br><span class=\"line\">--api-port 127.0.0.1:6443 \\</span><br><span class=\"line\">-p 80:80@loadbalancer \\</span><br><span class=\"line\">-p 443:443@loadbalancer \\</span><br><span class=\"line\">--k3s-server-arg <span class=\"string\">&quot;--no-deploy=traefik&quot;</span> \\</span><br><span class=\"line\">--no-hostip</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>指定network类型为host，并不将宿主机ip地址替换到程序中</p>\n</blockquote>\n<h2 id=\"查看集群\"><a href=\"#查看集群\" class=\"headerlink\" title=\"查看集群\"></a>查看集群</h2><p>查看当前创建的集群直接使用下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d cluster ls</span><br><span class=\"line\"></span><br><span class=\"line\">NAME         SERVERS   AGENTS   LOADBALANCER</span><br><span class=\"line\">devcluster   1/1       0/0      <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>可以看到当前的集群已经创建好了</p>\n<h2 id=\"设置kubectl\"><a href=\"#设置kubectl\" class=\"headerlink\" title=\"设置kubectl\"></a>设置kubectl</h2><p>首先设置yum源，安装kubectl：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes]</span></span><br><span class=\"line\"><span class=\"string\">name=Kubernetes</span></span><br><span class=\"line\"><span class=\"string\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">repo_gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y kubectl-1.17.3</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后获取集群<code>devcluster</code>的认证信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d kubeconfig get devcluster &gt; /root/.kube/config</span><br></pre></td></tr></table></figure>\n\n\n\n<p>现在就可以使用kubectl来操作集群了：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node </span><br><span class=\"line\">NAME                      STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">k3d-devcluster-server-0   Ready    master   26m   v1.19.3+k3s2</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get pod --all-namespaces </span><br><span class=\"line\">NAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">kube-system   metrics-server-7b4f8b595-pghbq           1/1     Running   0          26m</span><br><span class=\"line\">kube-system   local-path-provisioner-7ff9579c6-hmg6k   1/1     Running   0          26m</span><br><span class=\"line\">kube-system   coredns-66c464876b-5lpn5                 1/1     Running   0          26m</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署traefik-2\"><a href=\"#部署traefik-2\" class=\"headerlink\" title=\"部署traefik 2\"></a>部署traefik 2</h1><h2 id=\"安装helm3\"><a href=\"#安装helm3\" class=\"headerlink\" title=\"安装helm3\"></a>安装helm3</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://get.helm.sh/helm-v3.2.1-linux-amd64.tar.gz</span><br><span class=\"line\">tar zxf helm-v3.2.1-linux-amd64.tar.gz</span><br><span class=\"line\">cp linux-amd64/helm /usr/<span class=\"built_in\">local</span>/bin/</span><br><span class=\"line\">helm version</span><br><span class=\"line\"></span><br><span class=\"line\">version.BuildInfo&#123;Version:<span class=\"string\">&quot;v3.2.1&quot;</span>, GitCommit:<span class=\"string\">&quot;fe51cd1e31e6a202cba7dead9552a6d418ded79a&quot;</span>, GitTreeState:<span class=\"string\">&quot;clean&quot;</span>, GoVersion:<span class=\"string\">&quot;go1.13.10&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"安装traefik-2\"><a href=\"#安装traefik-2\" class=\"headerlink\" title=\"安装traefik 2\"></a>安装traefik 2</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm repo add traefik https://containous.github.io/traefik-helm-chart</span><br><span class=\"line\">helm repo list</span><br><span class=\"line\">helm install traefik traefik/traefik</span><br><span class=\"line\">kubectl get pod -n default</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">svclb-traefik-ldtfr        2/2     Running   0          26s</span><br><span class=\"line\">traefik-5fc4947cf9-w695g   1/1     Running   0          26s</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"设置traefik的dashboard\"><a href=\"#设置traefik的dashboard\" class=\"headerlink\" title=\"设置traefik的dashboard\"></a>设置traefik的dashboard</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl port-forward $(kubectl get pods --selector <span class=\"string\">&quot;app.kubernetes.io/name=traefik&quot;</span> --output=name) --address 0.0.0.0 9000:9000</span><br></pre></td></tr></table></figure>\n\n\n\n<p>通过浏览器访问<code>http://&lt;宿主机IP&gt;:9000/dashboard/</code>即可进入traefik的dashboard</p>\n<p><img src= \"/img/loading.gif\" data-src=\"./dashboard.png\" alt=\"\"></p>\n<br>\n\n\n\n<h1 id=\"应用部署\"><a href=\"#应用部署\" class=\"headerlink\" title=\"应用部署\"></a>应用部署</h1><p>这里部署一个<code>whoami</code>的测试服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create deploy whoami --image containous/whoami</span><br><span class=\"line\">kubectl expose deploy whoami --port 80</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后创建一个ingress暴露服务让外部访问：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># whoami-ingress.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">whoami</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">traefik.ingress.kubernetes.io/router.entrypoints:</span> <span class=\"string\">web,websecure</span></span><br><span class=\"line\">    <span class=\"attr\">traefik.ingress.kubernetes.io/router.tls:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">whoami</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>使用下面的命令进行创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f whoami-ingress.yaml</span><br><span class=\"line\">kubectl get ingress</span><br></pre></td></tr></table></figure>\n\n\n\n<p>直接在浏览器，访问：<code>https://&lt;宿主机IP&gt;</code>即可：</p>\n<p><img src= \"/img/loading.gif\" data-src=\"./whoami.png\" alt=\"\"></p>\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用k3d和traefik快速搭建开发环境</p><p>更新于 2021-03-28</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"介绍\"><a href=\"#介绍\" class=\"headerlink\" title=\"介绍\"></a>介绍</h1><p>一套完成的k8s系统比较复杂，需要很多的资源，部署起来也需要较长的时间。如果是开发环境，对于集群要求快速停止和开启、可以有多个集群并行、使用最少的资源，k3d就可以满足。</p>\n<p>k3d是一个非常轻量的集群，可以快速构建用于开发的k8s集群，其具有一下的特点：</p>\n<ul>\n<li>集群默认使用sqlite而不是etcd存储数据；</li>\n<li>所有的组件都封装在一个二进制程序中；</li>\n<li>在docker内运行，快速启停；</li>\n</ul>\n<br>\n\n\n\n<h1 id=\"k3d启动集群\"><a href=\"#k3d启动集群\" class=\"headerlink\" title=\"k3d启动集群\"></a>k3d启动集群</h1><h2 id=\"安装k3d\"><a href=\"#安装k3d\" class=\"headerlink\" title=\"安装k3d\"></a>安装k3d</h2><p>直接运行下面的命令安装k3s：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash</span><br></pre></td></tr></table></figure>\n\n\n\n<p>这个会在系统中安装<code>k3d</code>命令程序，使用下面的命令查看帮助信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d -h</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"启动集群\"><a href=\"#启动集群\" class=\"headerlink\" title=\"启动集群\"></a>启动集群</h2><p>使用下面的命令启动集群：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d cluster create devcluster \\</span><br><span class=\"line\">--api-port 127.0.0.1:6443 \\</span><br><span class=\"line\">-p 80:80@loadbalancer \\</span><br><span class=\"line\">-p 443:443@loadbalancer \\</span><br><span class=\"line\">--k3s-server-arg <span class=\"string\">&quot;--no-deploy=traefik&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>默认的k3d绑定的是traefik1，这里使用其他控制器，所以默认不安装</p>\n</blockquote>\n<p>在某些云环境下，只能使用docker的host网络模式，那么创建集群则使用下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d cluster create devcluster \\</span><br><span class=\"line\">--network host \\</span><br><span class=\"line\">--api-port 127.0.0.1:6443 \\</span><br><span class=\"line\">-p 80:80@loadbalancer \\</span><br><span class=\"line\">-p 443:443@loadbalancer \\</span><br><span class=\"line\">--k3s-server-arg <span class=\"string\">&quot;--no-deploy=traefik&quot;</span> \\</span><br><span class=\"line\">--no-hostip</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>指定network类型为host，并不将宿主机ip地址替换到程序中</p>\n</blockquote>\n<h2 id=\"查看集群\"><a href=\"#查看集群\" class=\"headerlink\" title=\"查看集群\"></a>查看集群</h2><p>查看当前创建的集群直接使用下面的命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d cluster ls</span><br><span class=\"line\"></span><br><span class=\"line\">NAME         SERVERS   AGENTS   LOADBALANCER</span><br><span class=\"line\">devcluster   1/1       0/0      <span class=\"literal\">false</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>可以看到当前的集群已经创建好了</p>\n<h2 id=\"设置kubectl\"><a href=\"#设置kubectl\" class=\"headerlink\" title=\"设置kubectl\"></a>设置kubectl</h2><p>首先设置yum源，安装kubectl：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes]</span></span><br><span class=\"line\"><span class=\"string\">name=Kubernetes</span></span><br><span class=\"line\"><span class=\"string\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">repo_gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y kubectl-1.17.3</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后获取集群<code>devcluster</code>的认证信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3d kubeconfig get devcluster &gt; /root/.kube/config</span><br></pre></td></tr></table></figure>\n\n\n\n<p>现在就可以使用kubectl来操作集群了：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node </span><br><span class=\"line\">NAME                      STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">k3d-devcluster-server-0   Ready    master   26m   v1.19.3+k3s2</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get pod --all-namespaces </span><br><span class=\"line\">NAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">kube-system   metrics-server-7b4f8b595-pghbq           1/1     Running   0          26m</span><br><span class=\"line\">kube-system   local-path-provisioner-7ff9579c6-hmg6k   1/1     Running   0          26m</span><br><span class=\"line\">kube-system   coredns-66c464876b-5lpn5                 1/1     Running   0          26m</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署traefik-2\"><a href=\"#部署traefik-2\" class=\"headerlink\" title=\"部署traefik 2\"></a>部署traefik 2</h1><h2 id=\"安装helm3\"><a href=\"#安装helm3\" class=\"headerlink\" title=\"安装helm3\"></a>安装helm3</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://get.helm.sh/helm-v3.2.1-linux-amd64.tar.gz</span><br><span class=\"line\">tar zxf helm-v3.2.1-linux-amd64.tar.gz</span><br><span class=\"line\">cp linux-amd64/helm /usr/<span class=\"built_in\">local</span>/bin/</span><br><span class=\"line\">helm version</span><br><span class=\"line\"></span><br><span class=\"line\">version.BuildInfo&#123;Version:<span class=\"string\">&quot;v3.2.1&quot;</span>, GitCommit:<span class=\"string\">&quot;fe51cd1e31e6a202cba7dead9552a6d418ded79a&quot;</span>, GitTreeState:<span class=\"string\">&quot;clean&quot;</span>, GoVersion:<span class=\"string\">&quot;go1.13.10&quot;</span>&#125;</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"安装traefik-2\"><a href=\"#安装traefik-2\" class=\"headerlink\" title=\"安装traefik 2\"></a>安装traefik 2</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">helm repo add traefik https://containous.github.io/traefik-helm-chart</span><br><span class=\"line\">helm repo list</span><br><span class=\"line\">helm install traefik traefik/traefik</span><br><span class=\"line\">kubectl get pod -n default</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">svclb-traefik-ldtfr        2/2     Running   0          26s</span><br><span class=\"line\">traefik-5fc4947cf9-w695g   1/1     Running   0          26s</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"设置traefik的dashboard\"><a href=\"#设置traefik的dashboard\" class=\"headerlink\" title=\"设置traefik的dashboard\"></a>设置traefik的dashboard</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl port-forward $(kubectl get pods --selector <span class=\"string\">&quot;app.kubernetes.io/name=traefik&quot;</span> --output=name) --address 0.0.0.0 9000:9000</span><br></pre></td></tr></table></figure>\n\n\n\n<p>通过浏览器访问<code>http://&lt;宿主机IP&gt;:9000/dashboard/</code>即可进入traefik的dashboard</p>\n<p><img src=\"./dashboard.png\" alt=\"\"></p>\n<br>\n\n\n\n<h1 id=\"应用部署\"><a href=\"#应用部署\" class=\"headerlink\" title=\"应用部署\"></a>应用部署</h1><p>这里部署一个<code>whoami</code>的测试服务：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create deploy whoami --image containous/whoami</span><br><span class=\"line\">kubectl expose deploy whoami --port 80</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后创建一个ingress暴露服务让外部访问：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># whoami-ingress.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">whoami</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">traefik.ingress.kubernetes.io/router.entrypoints:</span> <span class=\"string\">web,websecure</span></span><br><span class=\"line\">    <span class=\"attr\">traefik.ingress.kubernetes.io/router.tls:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">whoami</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>使用下面的命令进行创建：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f whoami-ingress.yaml</span><br><span class=\"line\">kubectl get ingress</span><br></pre></td></tr></table></figure>\n\n\n\n<p>直接在浏览器，访问：<code>https://&lt;宿主机IP&gt;</code>即可：</p>\n<p><img src=\"./whoami.png\" alt=\"\"></p>\n"},{"title":"部署docker-ce","date":"2021-04-05T07:46:52.000Z","description":"使用yum方式部署docker-ce","cover":"https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=4156517757,536988701&fm=26&gp=0.jpg","_content":"\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用yum方式部署docker-ce环境，版本为18.06\n\ndocker在拆分为ce和ee之后，大版本例如18表示发布的年份，小版本表示的是月份。\n\n更新于 2021-04-05\n\n{% endnote %}\n\n<br>\n\n\n\n\n\n# 卸载旧版docker\n\n```bash\nyum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine\n```\n\n<br>\n\n\n\n# 安装依赖\n\n```bash\nyum install -y yum-utils device-mapper-persistent-data lvm2\n```\n\n<br>\n\n\n\n\n\n# 添加docker源\n\n```bash\nyum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n```\n\n<br>\n\n\n\n# 【可选】挂载数据目录\n\n一般docker会把数据存储在`/var/lib/docker`下，所以如果是生产环境，建议挂载一个数据盘到该目录下防止爆盘。\n\n<br>\n\n\n\n\n\n# 安装Docker CE\n\n## 查看可用版本\n\n```bash\nyum list docker-ce --showduplicates|sort -r\n```\n\n‌\n\n## 安装最新版本\n\n```bash\nyum install -y docker-ce\n```\n\n‌\n\n## 安装指定版本\n\n```bash\nyum install -y docker-ce-18.06.1.ce-1.el7.centos\n```\n\n\n\n<br>\n\n\n\n#  启动docker\n\n```bash\nsystemctl start docker\nsystemctl enable docker\n```\n\n<br>\n\n\n\n# 验证安装\n\n```bash\n# 查看docker server和client的版本\ndocker version\n```\n\n<img src=\"./docker-version.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n# 卸载docker\n\n首先卸载docker软件包：\n\n```bash\nyum remove docker-ce\n```\n\n\n\n然后需要手动删除docker镜像、容器等相关文件：\n\n```bash\nrm -rf /var/lib/docker\n```\n\n","source":"_posts/部署docker-ce.md","raw":"---\ntitle: 部署docker-ce\ndate: 2021-04-05 15:46:52\ntags:\n- Docker\ncategories:\n- Docker\n- 部署\ndescription: 使用yum方式部署docker-ce\ncover: https://ss0.bdstatic.com/70cFuHSh_Q1YnxGkpoWK1HF6hhy/it/u=4156517757,536988701&fm=26&gp=0.jpg\n---\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用yum方式部署docker-ce环境，版本为18.06\n\ndocker在拆分为ce和ee之后，大版本例如18表示发布的年份，小版本表示的是月份。\n\n更新于 2021-04-05\n\n{% endnote %}\n\n<br>\n\n\n\n\n\n# 卸载旧版docker\n\n```bash\nyum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine\n```\n\n<br>\n\n\n\n# 安装依赖\n\n```bash\nyum install -y yum-utils device-mapper-persistent-data lvm2\n```\n\n<br>\n\n\n\n\n\n# 添加docker源\n\n```bash\nyum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\n```\n\n<br>\n\n\n\n# 【可选】挂载数据目录\n\n一般docker会把数据存储在`/var/lib/docker`下，所以如果是生产环境，建议挂载一个数据盘到该目录下防止爆盘。\n\n<br>\n\n\n\n\n\n# 安装Docker CE\n\n## 查看可用版本\n\n```bash\nyum list docker-ce --showduplicates|sort -r\n```\n\n‌\n\n## 安装最新版本\n\n```bash\nyum install -y docker-ce\n```\n\n‌\n\n## 安装指定版本\n\n```bash\nyum install -y docker-ce-18.06.1.ce-1.el7.centos\n```\n\n\n\n<br>\n\n\n\n#  启动docker\n\n```bash\nsystemctl start docker\nsystemctl enable docker\n```\n\n<br>\n\n\n\n# 验证安装\n\n```bash\n# 查看docker server和client的版本\ndocker version\n```\n\n<img src=\"./docker-version.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n# 卸载docker\n\n首先卸载docker软件包：\n\n```bash\nyum remove docker-ce\n```\n\n\n\n然后需要手动删除docker镜像、容器等相关文件：\n\n```bash\nrm -rf /var/lib/docker\n```\n\n","slug":"部署docker-ce","published":1,"updated":"2021-04-05T07:52:53.516Z","_id":"ckn4am84z0000zkkl8pjpc13t","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用yum方式部署docker-ce环境，版本为18.06</p><p>docker在拆分为ce和ee之后，大版本例如18表示发布的年份，小版本表示的是月份。</p><p>更新于 2021-04-05</p>\n          </div>\n\n<br>\n\n\n\n\n\n<h1 id=\"卸载旧版docker\"><a href=\"#卸载旧版docker\" class=\"headerlink\" title=\"卸载旧版docker\"></a>卸载旧版docker</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n\n\n<h1 id=\"添加docker源\"><a href=\"#添加docker源\" class=\"headerlink\" title=\"添加docker源\"></a>添加docker源</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"【可选】挂载数据目录\"><a href=\"#【可选】挂载数据目录\" class=\"headerlink\" title=\"【可选】挂载数据目录\"></a>【可选】挂载数据目录</h1><p>一般docker会把数据存储在<code>/var/lib/docker</code>下，所以如果是生产环境，建议挂载一个数据盘到该目录下防止爆盘。</p>\n<br>\n\n\n\n\n\n<h1 id=\"安装Docker-CE\"><a href=\"#安装Docker-CE\" class=\"headerlink\" title=\"安装Docker CE\"></a>安装Docker CE</h1><h2 id=\"查看可用版本\"><a href=\"#查看可用版本\" class=\"headerlink\" title=\"查看可用版本\"></a>查看可用版本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum list docker-ce --showduplicates|sort -r</span><br></pre></td></tr></table></figure>\n\n<p>‌</p>\n<h2 id=\"安装最新版本\"><a href=\"#安装最新版本\" class=\"headerlink\" title=\"安装最新版本\"></a>安装最新版本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y docker-ce</span><br></pre></td></tr></table></figure>\n\n<p>‌</p>\n<h2 id=\"安装指定版本\"><a href=\"#安装指定版本\" class=\"headerlink\" title=\"安装指定版本\"></a>安装指定版本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y docker-ce-18.06.1.ce-1.el7.centos</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"启动docker\"><a href=\"#启动docker\" class=\"headerlink\" title=\"启动docker\"></a>启动docker</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start docker</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> docker</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"验证安装\"><a href=\"#验证安装\" class=\"headerlink\" title=\"验证安装\"></a>验证安装</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看docker server和client的版本</span></span><br><span class=\"line\">docker version</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./docker-version.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"卸载docker\"><a href=\"#卸载docker\" class=\"headerlink\" title=\"卸载docker\"></a>卸载docker</h1><p>首先卸载docker软件包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum remove docker-ce</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后需要手动删除docker镜像、容器等相关文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用yum方式部署docker-ce环境，版本为18.06</p><p>docker在拆分为ce和ee之后，大版本例如18表示发布的年份，小版本表示的是月份。</p><p>更新于 2021-04-05</p>\n          </div>\n\n<br>\n\n\n\n\n\n<h1 id=\"卸载旧版docker\"><a href=\"#卸载旧版docker\" class=\"headerlink\" title=\"卸载旧版docker\"></a>卸载旧版docker</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n\n\n<h1 id=\"添加docker源\"><a href=\"#添加docker源\" class=\"headerlink\" title=\"添加docker源\"></a>添加docker源</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"【可选】挂载数据目录\"><a href=\"#【可选】挂载数据目录\" class=\"headerlink\" title=\"【可选】挂载数据目录\"></a>【可选】挂载数据目录</h1><p>一般docker会把数据存储在<code>/var/lib/docker</code>下，所以如果是生产环境，建议挂载一个数据盘到该目录下防止爆盘。</p>\n<br>\n\n\n\n\n\n<h1 id=\"安装Docker-CE\"><a href=\"#安装Docker-CE\" class=\"headerlink\" title=\"安装Docker CE\"></a>安装Docker CE</h1><h2 id=\"查看可用版本\"><a href=\"#查看可用版本\" class=\"headerlink\" title=\"查看可用版本\"></a>查看可用版本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum list docker-ce --showduplicates|sort -r</span><br></pre></td></tr></table></figure>\n\n<p>‌</p>\n<h2 id=\"安装最新版本\"><a href=\"#安装最新版本\" class=\"headerlink\" title=\"安装最新版本\"></a>安装最新版本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y docker-ce</span><br></pre></td></tr></table></figure>\n\n<p>‌</p>\n<h2 id=\"安装指定版本\"><a href=\"#安装指定版本\" class=\"headerlink\" title=\"安装指定版本\"></a>安装指定版本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y docker-ce-18.06.1.ce-1.el7.centos</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"启动docker\"><a href=\"#启动docker\" class=\"headerlink\" title=\"启动docker\"></a>启动docker</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start docker</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> docker</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"验证安装\"><a href=\"#验证安装\" class=\"headerlink\" title=\"验证安装\"></a>验证安装</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看docker server和client的版本</span></span><br><span class=\"line\">docker version</span><br></pre></td></tr></table></figure>\n\n<img src=\"./docker-version.png\" alt=\"img\" style=\"zoom:50%;\" />\n\n\n\n<br>\n\n\n\n<h1 id=\"卸载docker\"><a href=\"#卸载docker\" class=\"headerlink\" title=\"卸载docker\"></a>卸载docker</h1><p>首先卸载docker软件包：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum remove docker-ce</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后需要手动删除docker镜像、容器等相关文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rm -rf /var/lib/docker</span><br></pre></td></tr></table></figure>\n\n"},{"title":"部署harbor镜像仓库","date":"2021-04-05T07:54:11.000Z","description":"使用docker-compose编排部署一个docker镜像仓库","cover":"https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2179907255,3839696735&fm=11&gp=0.jpg","_content":"\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用docker-compose编排部署一个harbor镜像仓库\n\n更新于 2021-04-05\n\n{% endnote %}\n\n<br>\n\n\n\n# 环境规划\n\n{% tabs comments %}\n\n<!-- tab 软件环境 -->\n\n|      软件      |      版本       |\n| :------------: | :-------------: |\n|     docker     | docker-ce-18.06 |\n|     harbor     |  1.5.2-offline  |\n| docker-compose |      1.9.0      |\n\n<!-- endtab -->\n\n<!-- tab 硬件规划 -->\n\n两台服务器作为harbor服务器，配置8核16G，一个作为主服务器，另一个作为从服务器（从主服务器同步镜像数据），两个分别挂载1.5T数据盘作为镜像数据存储。\n\n<!-- endtab -->\n\n{% endtabs %}\n\n<br>\n\n\n\n\n\n# 初始化设置\n\n{% tabs comments %}\n\n<!-- tab 挂载数据目录 -->\n\n镜像仓库会存储很多镜像占据大量空间，所以建议单独设置一个磁盘或者使用分布式存储\n\n```bash\nmkdir /data\nmkfs.xfs /dev/vdb1\necho \"/dev/vdb1 /data xfs defaults 0 0\" >> /etc/fstab\nmount -a \n```\n\n<!-- endtab -->\n\n<!-- tab 安装epel源 -->\n\n```bash\nyum install -y epel-release\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n<br>\n\n\n\n# docker安装\n\n{% tabs comments %}\n\n<!-- tab 安装docker -->\n\ndocker安装可以参考：{% post_link 部署docker-ce  %}\n\n<!-- endtab -->\n\n<!-- tab 安装docker-compose -->\n\nharbor需要docker-compose在1.7.1及以上版本，可以从yum安装，但是需要注意版本。\n\n```bash\nyum list | grep docker-compose\nyum install -y docker-compose\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n<br>\n\n\n\n# 安装harbor\n\n## 下载harbor\n\n```bash\nmkdir /use/local/harbor1.5.2\nwget https://storage.googleapis.com/harbor-releases/harbor-offline-installer-v1.5.2.tgz -P /usr/local/harbor1.5.2\ncd /usr/local/harbor1.5.2\ntar zxf harbor-offline-installer-v1.5.2.tgz\n```\n\n\n\n## 配置harbor\n\nharbor配置文件为 `harbor.cfg` ，这里编辑这个文件，设置harbor相关参数：\n\n```bash\ncd /usr/local/harbor1.5.2/harbor\n\n# 编辑 harbor.cfg文件，根据需要修改下面项目\n\n// harbor管理UI地址\nhostname = harbor.example.com\n\n// UI界面协议\nui_url_protocol = https\n\n// 最大复制工作数，默认为3，根据自身网络及机器配置调整\nmax_job_workers = 3\n\n// 如果使用https协议，则修改这里为自己的证书\nssl_cert = /data/cert/server.crt\nssl_cert_key = /data/cert/server.key\n\n// 用于在复制策略中加密或解密远程注册表的密码的密钥路径\nsecretkey_path = /data\n\n// 设置邮件服务器和邮箱账户，发送邮件使用\nemail_server = mail.example.com\nemail_server_port = 25\nemail_username = harbor@example.com\nemail_password = harbor123\nemail_from = harbor@example.com\n\n// harbor管理员密码\nharbor_admin_password = Harbor12345\n```\n\n\n\n## 编辑docker-compose.yml文件\n\n这里需要修改该文件中 `volumes` 挂载数据卷的位置，默认是将数据存储在本机data目录下，这个刚好满足了当前的情况（data目录挂载的是大磁盘），如果大磁盘挂载在其他目录，则需要修改这里的路径。\n\n\n\n## 安装harbor\n\nharbor已经提供了安装脚本 `install.sh` ，改脚本安装分为4个步骤：\n\n- 加载harbor镜像；\n- 准备环境；\n- 检查harbor实例；\n- 启动harbor；\n\n\n\n如果以上4个步骤都没有错误就说明harbor安装成功了，对于修改了harbor配置的情况，也需要运行这个脚本来生效配置。\n\n\n\n```bash\nsh install.sh\n```\n\n\n\n## 检查启动情况\n\n```bash\n$ netstat -ntlp | grep docker-proxy\ntcp        0      0 127.0.0.1:1514          0.0.0.0:*               LISTEN      8498/docker-proxy   \ntcp        0      0 10.15.0.164:80          0.0.0.0:*               LISTEN      9901/docker-proxy   \ntcp        0      0 10.15.0.164:443         0.0.0.0:*               LISTEN      9866/docker-proxy   \ntcp        0      0 10.15.0.164:4443        0.0.0.0:*               LISTEN      9809/docker-proxy  \n\n$ docker ps \nCONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS                    PORTS                                                                          NAMES\n1fd5462b0933        vmware/harbor-jobservice:v1.5.2        \"/harbor/start.sh\"       54 seconds ago      Up 50 seconds                                                                                            harbor-jobservice\n8627ade5943b        vmware/nginx-photon:v1.5.2             \"nginx -g 'daemon of…\"   54 seconds ago      Up 41 seconds (healthy)   10.15.0.164:80->80/tcp, 10.15.0.164:443->443/tcp, 10.15.0.164:4443->4443/tcp   nginx\n5a3e9fef92a9        vmware/harbor-ui:v1.5.2                \"/harbor/start.sh\"       55 seconds ago      Up 53 seconds (healthy)                                                                                  harbor-ui\n49481d00dae8        vmware/harbor-adminserver:v1.5.2       \"/harbor/start.sh\"       56 seconds ago      Up 54 seconds (healthy)                                                                                  harbor-adminserver\n751bd2b620f1        vmware/registry-photon:v2.6.2-v1.5.2   \"/entrypoint.sh serv…\"   56 seconds ago      Up 54 seconds (healthy)   5000/tcp                                                                       registry\n9e058c908747        vmware/harbor-db:v1.5.2                \"/usr/local/bin/dock…\"   56 seconds ago      Up 54 seconds (healthy)   3306/tcp                                                                       harbor-db\n3125d3428e36        vmware/redis-photon:v1.5.2             \"docker-entrypoint.s…\"   56 seconds ago      Up 54 seconds             6379/tcp                                                                       redis\ne4362a273d57        vmware/harbor-log:v1.5.2               \"/bin/sh -c /usr/loc…\"   56 seconds ago      Up 55 seconds (healthy)   127.0.0.1:1514->10514/tcp                                                      harbor-log\n\n```\n\n\n\n<br>\n\n\n\n# 使用harbor\n\n## 访问harbor\n\n安装完成后，通过浏览器访问 80 端口即可进入harbor登录界面：\n\n<img src=\"./harbor-login.png\" style=\"zoom:75%;\" />\n\n\n\n默认用户名是`admin`，密码是在 `harbor.cfg` 中设置的 `admin_password` 字段的值。\n\n\n\n## 新建项目\n\n默认系统自动添加了library项目，也可以点击项目标签下边的 新建项目 来添加一个新的项目。\n\n<img src=\"./create.png\" style=\"zoom:75%;\" />\n\n>  这里创建了一个名为test的项目，并且把它标记为 公开的项目，这样所有人都可以访问这个项目。\n\n\n\n## 创建用户\n\n默认系统有一个admin用户，可以根据实际情况创建多个用户。点击左侧 用户管理 --> 创建用户：\n\n<img src=\"./create-user.png\" style=\"zoom:75%;\" />\n\n\n\n## 上传、拉取镜像\n\n这里在本机下载一个nginx作为测试：\n\n```bash\ndocker pull nginx\n```\n\n\n\n首先需要登录镜像仓库：\n\n```bash\ndocker login 10.10.99.226\n```\n\n**根据提示输入用户名密码**\n\n\n\n上传前需要给待上传的镜像打标签：\n\n```bash\ndocker tag nginx 10.10.99.226/test/nginx:v1\n```\n\n> 标签格式为 `[harbor地址]/仓库名/镜像名:[版本]`\n\n\n\n打完标签就可以上传镜像了：\n\n```bash\ndocker push 10.10.99.226/test/nginx:v1\n```\n\n\n\n<img src=\"./upload-image.png\" style=\"zoom:75%;\" />\n\n\n\n下载镜像可以在仓库中镜像旁边找到下载镜像的命令，直接执行即可：\n\n```bash\ndocker pull 10.10.99.226/test/nginx:v1\n```\n\n> 如果是私有仓库，则需要先登录\n\n","source":"_posts/部署harbor镜像仓库.md","raw":"---\ntitle: 部署harbor镜像仓库\ndate: 2021-04-05 15:54:11\ntags:\n- Harbor\ncategories:\n- Docker\n- 镜像仓库\ndescription: 使用docker-compose编排部署一个docker镜像仓库\ncover: https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2179907255,3839696735&fm=11&gp=0.jpg\n---\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用docker-compose编排部署一个harbor镜像仓库\n\n更新于 2021-04-05\n\n{% endnote %}\n\n<br>\n\n\n\n# 环境规划\n\n{% tabs comments %}\n\n<!-- tab 软件环境 -->\n\n|      软件      |      版本       |\n| :------------: | :-------------: |\n|     docker     | docker-ce-18.06 |\n|     harbor     |  1.5.2-offline  |\n| docker-compose |      1.9.0      |\n\n<!-- endtab -->\n\n<!-- tab 硬件规划 -->\n\n两台服务器作为harbor服务器，配置8核16G，一个作为主服务器，另一个作为从服务器（从主服务器同步镜像数据），两个分别挂载1.5T数据盘作为镜像数据存储。\n\n<!-- endtab -->\n\n{% endtabs %}\n\n<br>\n\n\n\n\n\n# 初始化设置\n\n{% tabs comments %}\n\n<!-- tab 挂载数据目录 -->\n\n镜像仓库会存储很多镜像占据大量空间，所以建议单独设置一个磁盘或者使用分布式存储\n\n```bash\nmkdir /data\nmkfs.xfs /dev/vdb1\necho \"/dev/vdb1 /data xfs defaults 0 0\" >> /etc/fstab\nmount -a \n```\n\n<!-- endtab -->\n\n<!-- tab 安装epel源 -->\n\n```bash\nyum install -y epel-release\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n<br>\n\n\n\n# docker安装\n\n{% tabs comments %}\n\n<!-- tab 安装docker -->\n\ndocker安装可以参考：{% post_link 部署docker-ce  %}\n\n<!-- endtab -->\n\n<!-- tab 安装docker-compose -->\n\nharbor需要docker-compose在1.7.1及以上版本，可以从yum安装，但是需要注意版本。\n\n```bash\nyum list | grep docker-compose\nyum install -y docker-compose\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n<br>\n\n\n\n# 安装harbor\n\n## 下载harbor\n\n```bash\nmkdir /use/local/harbor1.5.2\nwget https://storage.googleapis.com/harbor-releases/harbor-offline-installer-v1.5.2.tgz -P /usr/local/harbor1.5.2\ncd /usr/local/harbor1.5.2\ntar zxf harbor-offline-installer-v1.5.2.tgz\n```\n\n\n\n## 配置harbor\n\nharbor配置文件为 `harbor.cfg` ，这里编辑这个文件，设置harbor相关参数：\n\n```bash\ncd /usr/local/harbor1.5.2/harbor\n\n# 编辑 harbor.cfg文件，根据需要修改下面项目\n\n// harbor管理UI地址\nhostname = harbor.example.com\n\n// UI界面协议\nui_url_protocol = https\n\n// 最大复制工作数，默认为3，根据自身网络及机器配置调整\nmax_job_workers = 3\n\n// 如果使用https协议，则修改这里为自己的证书\nssl_cert = /data/cert/server.crt\nssl_cert_key = /data/cert/server.key\n\n// 用于在复制策略中加密或解密远程注册表的密码的密钥路径\nsecretkey_path = /data\n\n// 设置邮件服务器和邮箱账户，发送邮件使用\nemail_server = mail.example.com\nemail_server_port = 25\nemail_username = harbor@example.com\nemail_password = harbor123\nemail_from = harbor@example.com\n\n// harbor管理员密码\nharbor_admin_password = Harbor12345\n```\n\n\n\n## 编辑docker-compose.yml文件\n\n这里需要修改该文件中 `volumes` 挂载数据卷的位置，默认是将数据存储在本机data目录下，这个刚好满足了当前的情况（data目录挂载的是大磁盘），如果大磁盘挂载在其他目录，则需要修改这里的路径。\n\n\n\n## 安装harbor\n\nharbor已经提供了安装脚本 `install.sh` ，改脚本安装分为4个步骤：\n\n- 加载harbor镜像；\n- 准备环境；\n- 检查harbor实例；\n- 启动harbor；\n\n\n\n如果以上4个步骤都没有错误就说明harbor安装成功了，对于修改了harbor配置的情况，也需要运行这个脚本来生效配置。\n\n\n\n```bash\nsh install.sh\n```\n\n\n\n## 检查启动情况\n\n```bash\n$ netstat -ntlp | grep docker-proxy\ntcp        0      0 127.0.0.1:1514          0.0.0.0:*               LISTEN      8498/docker-proxy   \ntcp        0      0 10.15.0.164:80          0.0.0.0:*               LISTEN      9901/docker-proxy   \ntcp        0      0 10.15.0.164:443         0.0.0.0:*               LISTEN      9866/docker-proxy   \ntcp        0      0 10.15.0.164:4443        0.0.0.0:*               LISTEN      9809/docker-proxy  \n\n$ docker ps \nCONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS                    PORTS                                                                          NAMES\n1fd5462b0933        vmware/harbor-jobservice:v1.5.2        \"/harbor/start.sh\"       54 seconds ago      Up 50 seconds                                                                                            harbor-jobservice\n8627ade5943b        vmware/nginx-photon:v1.5.2             \"nginx -g 'daemon of…\"   54 seconds ago      Up 41 seconds (healthy)   10.15.0.164:80->80/tcp, 10.15.0.164:443->443/tcp, 10.15.0.164:4443->4443/tcp   nginx\n5a3e9fef92a9        vmware/harbor-ui:v1.5.2                \"/harbor/start.sh\"       55 seconds ago      Up 53 seconds (healthy)                                                                                  harbor-ui\n49481d00dae8        vmware/harbor-adminserver:v1.5.2       \"/harbor/start.sh\"       56 seconds ago      Up 54 seconds (healthy)                                                                                  harbor-adminserver\n751bd2b620f1        vmware/registry-photon:v2.6.2-v1.5.2   \"/entrypoint.sh serv…\"   56 seconds ago      Up 54 seconds (healthy)   5000/tcp                                                                       registry\n9e058c908747        vmware/harbor-db:v1.5.2                \"/usr/local/bin/dock…\"   56 seconds ago      Up 54 seconds (healthy)   3306/tcp                                                                       harbor-db\n3125d3428e36        vmware/redis-photon:v1.5.2             \"docker-entrypoint.s…\"   56 seconds ago      Up 54 seconds             6379/tcp                                                                       redis\ne4362a273d57        vmware/harbor-log:v1.5.2               \"/bin/sh -c /usr/loc…\"   56 seconds ago      Up 55 seconds (healthy)   127.0.0.1:1514->10514/tcp                                                      harbor-log\n\n```\n\n\n\n<br>\n\n\n\n# 使用harbor\n\n## 访问harbor\n\n安装完成后，通过浏览器访问 80 端口即可进入harbor登录界面：\n\n<img src=\"./harbor-login.png\" style=\"zoom:75%;\" />\n\n\n\n默认用户名是`admin`，密码是在 `harbor.cfg` 中设置的 `admin_password` 字段的值。\n\n\n\n## 新建项目\n\n默认系统自动添加了library项目，也可以点击项目标签下边的 新建项目 来添加一个新的项目。\n\n<img src=\"./create.png\" style=\"zoom:75%;\" />\n\n>  这里创建了一个名为test的项目，并且把它标记为 公开的项目，这样所有人都可以访问这个项目。\n\n\n\n## 创建用户\n\n默认系统有一个admin用户，可以根据实际情况创建多个用户。点击左侧 用户管理 --> 创建用户：\n\n<img src=\"./create-user.png\" style=\"zoom:75%;\" />\n\n\n\n## 上传、拉取镜像\n\n这里在本机下载一个nginx作为测试：\n\n```bash\ndocker pull nginx\n```\n\n\n\n首先需要登录镜像仓库：\n\n```bash\ndocker login 10.10.99.226\n```\n\n**根据提示输入用户名密码**\n\n\n\n上传前需要给待上传的镜像打标签：\n\n```bash\ndocker tag nginx 10.10.99.226/test/nginx:v1\n```\n\n> 标签格式为 `[harbor地址]/仓库名/镜像名:[版本]`\n\n\n\n打完标签就可以上传镜像了：\n\n```bash\ndocker push 10.10.99.226/test/nginx:v1\n```\n\n\n\n<img src=\"./upload-image.png\" style=\"zoom:75%;\" />\n\n\n\n下载镜像可以在仓库中镜像旁边找到下载镜像的命令，直接执行即可：\n\n```bash\ndocker pull 10.10.99.226/test/nginx:v1\n```\n\n> 如果是私有仓库，则需要先登录\n\n","slug":"部署harbor镜像仓库","published":1,"updated":"2021-04-05T08:08:21.874Z","_id":"ckn4auyv90000pcklck1f760r","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用docker-compose编排部署一个harbor镜像仓库</p><p>更新于 2021-04-05</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"环境规划\"><a href=\"#环境规划\" class=\"headerlink\" title=\"环境规划\"></a>环境规划</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">软件环境</button></li><li class=\"tab\"><button data-href=\"#comments-2\">硬件规划</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><table>\n<thead>\n<tr>\n<th align=\"center\">软件</th>\n<th align=\"center\">版本</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">docker</td>\n<td align=\"center\">docker-ce-18.06</td>\n</tr>\n<tr>\n<td align=\"center\">harbor</td>\n<td align=\"center\">1.5.2-offline</td>\n</tr>\n<tr>\n<td align=\"center\">docker-compose</td>\n<td align=\"center\">1.9.0</td>\n</tr>\n</tbody></table><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>两台服务器作为harbor服务器，配置8核16G，一个作为主服务器，另一个作为从服务器（从主服务器同步镜像数据），两个分别挂载1.5T数据盘作为镜像数据存储。</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n<br>\n\n\n\n\n\n<h1 id=\"初始化设置\"><a href=\"#初始化设置\" class=\"headerlink\" title=\"初始化设置\"></a>初始化设置</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">挂载数据目录</button></li><li class=\"tab\"><button data-href=\"#comments-2\">安装epel源</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>镜像仓库会存储很多镜像占据大量空间，所以建议单独设置一个磁盘或者使用分布式存储</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /data</span><br><span class=\"line\">mkfs.xfs /dev/vdb1</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/dev/vdb1 /data xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\">mount -a </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y epel-release</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n<br>\n\n\n\n<h1 id=\"docker安装\"><a href=\"#docker安装\" class=\"headerlink\" title=\"docker安装\"></a>docker安装</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装docker</button></li><li class=\"tab\"><button data-href=\"#comments-2\">安装docker-compose</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>docker安装可以参考：<a href=\"/2021/04/05/%E9%83%A8%E7%BD%B2docker-ce/\" title=\"部署docker-ce\">部署docker-ce</a></p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>harbor需要docker-compose在1.7.1及以上版本，可以从yum安装，但是需要注意版本。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum list | grep docker-compose</span><br><span class=\"line\">yum install -y docker-compose</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n<br>\n\n\n\n<h1 id=\"安装harbor\"><a href=\"#安装harbor\" class=\"headerlink\" title=\"安装harbor\"></a>安装harbor</h1><h2 id=\"下载harbor\"><a href=\"#下载harbor\" class=\"headerlink\" title=\"下载harbor\"></a>下载harbor</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /use/<span class=\"built_in\">local</span>/harbor1.5.2</span><br><span class=\"line\">wget https://storage.googleapis.com/harbor-releases/harbor-offline-installer-v1.5.2.tgz -P /usr/<span class=\"built_in\">local</span>/harbor1.5.2</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/harbor1.5.2</span><br><span class=\"line\">tar zxf harbor-offline-installer-v1.5.2.tgz</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"配置harbor\"><a href=\"#配置harbor\" class=\"headerlink\" title=\"配置harbor\"></a>配置harbor</h2><p>harbor配置文件为 <code>harbor.cfg</code> ，这里编辑这个文件，设置harbor相关参数：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/harbor1.5.2/harbor</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑 harbor.cfg文件，根据需要修改下面项目</span></span><br><span class=\"line\"></span><br><span class=\"line\">// harbor管理UI地址</span><br><span class=\"line\">hostname = harbor.example.com</span><br><span class=\"line\"></span><br><span class=\"line\">// UI界面协议</span><br><span class=\"line\">ui_url_protocol = https</span><br><span class=\"line\"></span><br><span class=\"line\">// 最大复制工作数，默认为3，根据自身网络及机器配置调整</span><br><span class=\"line\">max_job_workers = 3</span><br><span class=\"line\"></span><br><span class=\"line\">// 如果使用https协议，则修改这里为自己的证书</span><br><span class=\"line\">ssl_cert = /data/cert/server.crt</span><br><span class=\"line\">ssl_cert_key = /data/cert/server.key</span><br><span class=\"line\"></span><br><span class=\"line\">// 用于在复制策略中加密或解密远程注册表的密码的密钥路径</span><br><span class=\"line\">secretkey_path = /data</span><br><span class=\"line\"></span><br><span class=\"line\">// 设置邮件服务器和邮箱账户，发送邮件使用</span><br><span class=\"line\">email_server = mail.example.com</span><br><span class=\"line\">email_server_port = 25</span><br><span class=\"line\">email_username = harbor@example.com</span><br><span class=\"line\">email_password = harbor123</span><br><span class=\"line\">email_from = harbor@example.com</span><br><span class=\"line\"></span><br><span class=\"line\">// harbor管理员密码</span><br><span class=\"line\">harbor_admin_password = Harbor12345</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"编辑docker-compose-yml文件\"><a href=\"#编辑docker-compose-yml文件\" class=\"headerlink\" title=\"编辑docker-compose.yml文件\"></a>编辑docker-compose.yml文件</h2><p>这里需要修改该文件中 <code>volumes</code> 挂载数据卷的位置，默认是将数据存储在本机data目录下，这个刚好满足了当前的情况（data目录挂载的是大磁盘），如果大磁盘挂载在其他目录，则需要修改这里的路径。</p>\n<h2 id=\"安装harbor-1\"><a href=\"#安装harbor-1\" class=\"headerlink\" title=\"安装harbor\"></a>安装harbor</h2><p>harbor已经提供了安装脚本 <code>install.sh</code> ，改脚本安装分为4个步骤：</p>\n<ul>\n<li>加载harbor镜像；</li>\n<li>准备环境；</li>\n<li>检查harbor实例；</li>\n<li>启动harbor；</li>\n</ul>\n<p>如果以上4个步骤都没有错误就说明harbor安装成功了，对于修改了harbor配置的情况，也需要运行这个脚本来生效配置。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sh install.sh</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查启动情况\"><a href=\"#检查启动情况\" class=\"headerlink\" title=\"检查启动情况\"></a>检查启动情况</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ netstat -ntlp | grep docker-proxy</span><br><span class=\"line\">tcp        0      0 127.0.0.1:1514          0.0.0.0:*               LISTEN      8498/docker-proxy   </span><br><span class=\"line\">tcp        0      0 10.15.0.164:80          0.0.0.0:*               LISTEN      9901/docker-proxy   </span><br><span class=\"line\">tcp        0      0 10.15.0.164:443         0.0.0.0:*               LISTEN      9866/docker-proxy   </span><br><span class=\"line\">tcp        0      0 10.15.0.164:4443        0.0.0.0:*               LISTEN      9809/docker-proxy  </span><br><span class=\"line\"></span><br><span class=\"line\">$ docker ps </span><br><span class=\"line\">CONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS                    PORTS                                                                          NAMES</span><br><span class=\"line\">1fd5462b0933        vmware/harbor-jobservice:v1.5.2        <span class=\"string\">&quot;/harbor/start.sh&quot;</span>       54 seconds ago      Up 50 seconds                                                                                            harbor-jobservice</span><br><span class=\"line\">8627ade5943b        vmware/nginx-photon:v1.5.2             <span class=\"string\">&quot;nginx -g &#x27;daemon of…&quot;</span>   54 seconds ago      Up 41 seconds (healthy)   10.15.0.164:80-&gt;80/tcp, 10.15.0.164:443-&gt;443/tcp, 10.15.0.164:4443-&gt;4443/tcp   nginx</span><br><span class=\"line\">5a3e9fef92a9        vmware/harbor-ui:v1.5.2                <span class=\"string\">&quot;/harbor/start.sh&quot;</span>       55 seconds ago      Up 53 seconds (healthy)                                                                                  harbor-ui</span><br><span class=\"line\">49481d00dae8        vmware/harbor-adminserver:v1.5.2       <span class=\"string\">&quot;/harbor/start.sh&quot;</span>       56 seconds ago      Up 54 seconds (healthy)                                                                                  harbor-adminserver</span><br><span class=\"line\">751bd2b620f1        vmware/registry-photon:v2.6.2-v1.5.2   <span class=\"string\">&quot;/entrypoint.sh serv…&quot;</span>   56 seconds ago      Up 54 seconds (healthy)   5000/tcp                                                                       registry</span><br><span class=\"line\">9e058c908747        vmware/harbor-db:v1.5.2                <span class=\"string\">&quot;/usr/local/bin/dock…&quot;</span>   56 seconds ago      Up 54 seconds (healthy)   3306/tcp                                                                       harbor-db</span><br><span class=\"line\">3125d3428e36        vmware/redis-photon:v1.5.2             <span class=\"string\">&quot;docker-entrypoint.s…&quot;</span>   56 seconds ago      Up 54 seconds             6379/tcp                                                                       redis</span><br><span class=\"line\">e4362a273d57        vmware/harbor-log:v1.5.2               <span class=\"string\">&quot;/bin/sh -c /usr/loc…&quot;</span>   56 seconds ago      Up 55 seconds (healthy)   127.0.0.1:1514-&gt;10514/tcp                                                      harbor-log</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"使用harbor\"><a href=\"#使用harbor\" class=\"headerlink\" title=\"使用harbor\"></a>使用harbor</h1><h2 id=\"访问harbor\"><a href=\"#访问harbor\" class=\"headerlink\" title=\"访问harbor\"></a>访问harbor</h2><p>安装完成后，通过浏览器访问 80 端口即可进入harbor登录界面：</p>\n<img src= \"/img/loading.gif\" data-src=\"./harbor-login.png\" style=\"zoom:75%;\" />\n\n\n\n<p>默认用户名是<code>admin</code>，密码是在 <code>harbor.cfg</code> 中设置的 <code>admin_password</code> 字段的值。</p>\n<h2 id=\"新建项目\"><a href=\"#新建项目\" class=\"headerlink\" title=\"新建项目\"></a>新建项目</h2><p>默认系统自动添加了library项目，也可以点击项目标签下边的 新建项目 来添加一个新的项目。</p>\n<img src= \"/img/loading.gif\" data-src=\"./create.png\" style=\"zoom:75%;\" />\n\n<blockquote>\n<p> 这里创建了一个名为test的项目，并且把它标记为 公开的项目，这样所有人都可以访问这个项目。</p>\n</blockquote>\n<h2 id=\"创建用户\"><a href=\"#创建用户\" class=\"headerlink\" title=\"创建用户\"></a>创建用户</h2><p>默认系统有一个admin用户，可以根据实际情况创建多个用户。点击左侧 用户管理 –&gt; 创建用户：</p>\n<img src= \"/img/loading.gif\" data-src=\"./create-user.png\" style=\"zoom:75%;\" />\n\n\n\n<h2 id=\"上传、拉取镜像\"><a href=\"#上传、拉取镜像\" class=\"headerlink\" title=\"上传、拉取镜像\"></a>上传、拉取镜像</h2><p>这里在本机下载一个nginx作为测试：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull nginx</span><br></pre></td></tr></table></figure>\n\n\n\n<p>首先需要登录镜像仓库：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker login 10.10.99.226</span><br></pre></td></tr></table></figure>\n\n<p><strong>根据提示输入用户名密码</strong></p>\n<p>上传前需要给待上传的镜像打标签：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker tag nginx 10.10.99.226/<span class=\"built_in\">test</span>/nginx:v1</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>标签格式为 <code>[harbor地址]/仓库名/镜像名:[版本]</code></p>\n</blockquote>\n<p>打完标签就可以上传镜像了：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker push 10.10.99.226/<span class=\"built_in\">test</span>/nginx:v1</span><br></pre></td></tr></table></figure>\n\n\n\n<img src= \"/img/loading.gif\" data-src=\"./upload-image.png\" style=\"zoom:75%;\" />\n\n\n\n<p>下载镜像可以在仓库中镜像旁边找到下载镜像的命令，直接执行即可：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull 10.10.99.226/<span class=\"built_in\">test</span>/nginx:v1</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果是私有仓库，则需要先登录</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用docker-compose编排部署一个harbor镜像仓库</p><p>更新于 2021-04-05</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"环境规划\"><a href=\"#环境规划\" class=\"headerlink\" title=\"环境规划\"></a>环境规划</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">软件环境</button></li><li class=\"tab\"><button data-href=\"#comments-2\">硬件规划</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><table>\n<thead>\n<tr>\n<th align=\"center\">软件</th>\n<th align=\"center\">版本</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">docker</td>\n<td align=\"center\">docker-ce-18.06</td>\n</tr>\n<tr>\n<td align=\"center\">harbor</td>\n<td align=\"center\">1.5.2-offline</td>\n</tr>\n<tr>\n<td align=\"center\">docker-compose</td>\n<td align=\"center\">1.9.0</td>\n</tr>\n</tbody></table><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>两台服务器作为harbor服务器，配置8核16G，一个作为主服务器，另一个作为从服务器（从主服务器同步镜像数据），两个分别挂载1.5T数据盘作为镜像数据存储。</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n<br>\n\n\n\n\n\n<h1 id=\"初始化设置\"><a href=\"#初始化设置\" class=\"headerlink\" title=\"初始化设置\"></a>初始化设置</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">挂载数据目录</button></li><li class=\"tab\"><button data-href=\"#comments-2\">安装epel源</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>镜像仓库会存储很多镜像占据大量空间，所以建议单独设置一个磁盘或者使用分布式存储</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /data</span><br><span class=\"line\">mkfs.xfs /dev/vdb1</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/dev/vdb1 /data xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\">mount -a </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y epel-release</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n<br>\n\n\n\n<h1 id=\"docker安装\"><a href=\"#docker安装\" class=\"headerlink\" title=\"docker安装\"></a>docker安装</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装docker</button></li><li class=\"tab\"><button data-href=\"#comments-2\">安装docker-compose</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>docker安装可以参考：<a href=\"/2021/04/05/%E9%83%A8%E7%BD%B2docker-ce/\" title=\"部署docker-ce\">部署docker-ce</a></p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>harbor需要docker-compose在1.7.1及以上版本，可以从yum安装，但是需要注意版本。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum list | grep docker-compose</span><br><span class=\"line\">yum install -y docker-compose</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n<br>\n\n\n\n<h1 id=\"安装harbor\"><a href=\"#安装harbor\" class=\"headerlink\" title=\"安装harbor\"></a>安装harbor</h1><h2 id=\"下载harbor\"><a href=\"#下载harbor\" class=\"headerlink\" title=\"下载harbor\"></a>下载harbor</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /use/<span class=\"built_in\">local</span>/harbor1.5.2</span><br><span class=\"line\">wget https://storage.googleapis.com/harbor-releases/harbor-offline-installer-v1.5.2.tgz -P /usr/<span class=\"built_in\">local</span>/harbor1.5.2</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/harbor1.5.2</span><br><span class=\"line\">tar zxf harbor-offline-installer-v1.5.2.tgz</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"配置harbor\"><a href=\"#配置harbor\" class=\"headerlink\" title=\"配置harbor\"></a>配置harbor</h2><p>harbor配置文件为 <code>harbor.cfg</code> ，这里编辑这个文件，设置harbor相关参数：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/<span class=\"built_in\">local</span>/harbor1.5.2/harbor</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑 harbor.cfg文件，根据需要修改下面项目</span></span><br><span class=\"line\"></span><br><span class=\"line\">// harbor管理UI地址</span><br><span class=\"line\">hostname = harbor.example.com</span><br><span class=\"line\"></span><br><span class=\"line\">// UI界面协议</span><br><span class=\"line\">ui_url_protocol = https</span><br><span class=\"line\"></span><br><span class=\"line\">// 最大复制工作数，默认为3，根据自身网络及机器配置调整</span><br><span class=\"line\">max_job_workers = 3</span><br><span class=\"line\"></span><br><span class=\"line\">// 如果使用https协议，则修改这里为自己的证书</span><br><span class=\"line\">ssl_cert = /data/cert/server.crt</span><br><span class=\"line\">ssl_cert_key = /data/cert/server.key</span><br><span class=\"line\"></span><br><span class=\"line\">// 用于在复制策略中加密或解密远程注册表的密码的密钥路径</span><br><span class=\"line\">secretkey_path = /data</span><br><span class=\"line\"></span><br><span class=\"line\">// 设置邮件服务器和邮箱账户，发送邮件使用</span><br><span class=\"line\">email_server = mail.example.com</span><br><span class=\"line\">email_server_port = 25</span><br><span class=\"line\">email_username = harbor@example.com</span><br><span class=\"line\">email_password = harbor123</span><br><span class=\"line\">email_from = harbor@example.com</span><br><span class=\"line\"></span><br><span class=\"line\">// harbor管理员密码</span><br><span class=\"line\">harbor_admin_password = Harbor12345</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"编辑docker-compose-yml文件\"><a href=\"#编辑docker-compose-yml文件\" class=\"headerlink\" title=\"编辑docker-compose.yml文件\"></a>编辑docker-compose.yml文件</h2><p>这里需要修改该文件中 <code>volumes</code> 挂载数据卷的位置，默认是将数据存储在本机data目录下，这个刚好满足了当前的情况（data目录挂载的是大磁盘），如果大磁盘挂载在其他目录，则需要修改这里的路径。</p>\n<h2 id=\"安装harbor-1\"><a href=\"#安装harbor-1\" class=\"headerlink\" title=\"安装harbor\"></a>安装harbor</h2><p>harbor已经提供了安装脚本 <code>install.sh</code> ，改脚本安装分为4个步骤：</p>\n<ul>\n<li>加载harbor镜像；</li>\n<li>准备环境；</li>\n<li>检查harbor实例；</li>\n<li>启动harbor；</li>\n</ul>\n<p>如果以上4个步骤都没有错误就说明harbor安装成功了，对于修改了harbor配置的情况，也需要运行这个脚本来生效配置。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sh install.sh</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查启动情况\"><a href=\"#检查启动情况\" class=\"headerlink\" title=\"检查启动情况\"></a>检查启动情况</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ netstat -ntlp | grep docker-proxy</span><br><span class=\"line\">tcp        0      0 127.0.0.1:1514          0.0.0.0:*               LISTEN      8498/docker-proxy   </span><br><span class=\"line\">tcp        0      0 10.15.0.164:80          0.0.0.0:*               LISTEN      9901/docker-proxy   </span><br><span class=\"line\">tcp        0      0 10.15.0.164:443         0.0.0.0:*               LISTEN      9866/docker-proxy   </span><br><span class=\"line\">tcp        0      0 10.15.0.164:4443        0.0.0.0:*               LISTEN      9809/docker-proxy  </span><br><span class=\"line\"></span><br><span class=\"line\">$ docker ps </span><br><span class=\"line\">CONTAINER ID        IMAGE                                  COMMAND                  CREATED             STATUS                    PORTS                                                                          NAMES</span><br><span class=\"line\">1fd5462b0933        vmware/harbor-jobservice:v1.5.2        <span class=\"string\">&quot;/harbor/start.sh&quot;</span>       54 seconds ago      Up 50 seconds                                                                                            harbor-jobservice</span><br><span class=\"line\">8627ade5943b        vmware/nginx-photon:v1.5.2             <span class=\"string\">&quot;nginx -g &#x27;daemon of…&quot;</span>   54 seconds ago      Up 41 seconds (healthy)   10.15.0.164:80-&gt;80/tcp, 10.15.0.164:443-&gt;443/tcp, 10.15.0.164:4443-&gt;4443/tcp   nginx</span><br><span class=\"line\">5a3e9fef92a9        vmware/harbor-ui:v1.5.2                <span class=\"string\">&quot;/harbor/start.sh&quot;</span>       55 seconds ago      Up 53 seconds (healthy)                                                                                  harbor-ui</span><br><span class=\"line\">49481d00dae8        vmware/harbor-adminserver:v1.5.2       <span class=\"string\">&quot;/harbor/start.sh&quot;</span>       56 seconds ago      Up 54 seconds (healthy)                                                                                  harbor-adminserver</span><br><span class=\"line\">751bd2b620f1        vmware/registry-photon:v2.6.2-v1.5.2   <span class=\"string\">&quot;/entrypoint.sh serv…&quot;</span>   56 seconds ago      Up 54 seconds (healthy)   5000/tcp                                                                       registry</span><br><span class=\"line\">9e058c908747        vmware/harbor-db:v1.5.2                <span class=\"string\">&quot;/usr/local/bin/dock…&quot;</span>   56 seconds ago      Up 54 seconds (healthy)   3306/tcp                                                                       harbor-db</span><br><span class=\"line\">3125d3428e36        vmware/redis-photon:v1.5.2             <span class=\"string\">&quot;docker-entrypoint.s…&quot;</span>   56 seconds ago      Up 54 seconds             6379/tcp                                                                       redis</span><br><span class=\"line\">e4362a273d57        vmware/harbor-log:v1.5.2               <span class=\"string\">&quot;/bin/sh -c /usr/loc…&quot;</span>   56 seconds ago      Up 55 seconds (healthy)   127.0.0.1:1514-&gt;10514/tcp                                                      harbor-log</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"使用harbor\"><a href=\"#使用harbor\" class=\"headerlink\" title=\"使用harbor\"></a>使用harbor</h1><h2 id=\"访问harbor\"><a href=\"#访问harbor\" class=\"headerlink\" title=\"访问harbor\"></a>访问harbor</h2><p>安装完成后，通过浏览器访问 80 端口即可进入harbor登录界面：</p>\n<img src=\"./harbor-login.png\" style=\"zoom:75%;\" />\n\n\n\n<p>默认用户名是<code>admin</code>，密码是在 <code>harbor.cfg</code> 中设置的 <code>admin_password</code> 字段的值。</p>\n<h2 id=\"新建项目\"><a href=\"#新建项目\" class=\"headerlink\" title=\"新建项目\"></a>新建项目</h2><p>默认系统自动添加了library项目，也可以点击项目标签下边的 新建项目 来添加一个新的项目。</p>\n<img src=\"./create.png\" style=\"zoom:75%;\" />\n\n<blockquote>\n<p> 这里创建了一个名为test的项目，并且把它标记为 公开的项目，这样所有人都可以访问这个项目。</p>\n</blockquote>\n<h2 id=\"创建用户\"><a href=\"#创建用户\" class=\"headerlink\" title=\"创建用户\"></a>创建用户</h2><p>默认系统有一个admin用户，可以根据实际情况创建多个用户。点击左侧 用户管理 –&gt; 创建用户：</p>\n<img src=\"./create-user.png\" style=\"zoom:75%;\" />\n\n\n\n<h2 id=\"上传、拉取镜像\"><a href=\"#上传、拉取镜像\" class=\"headerlink\" title=\"上传、拉取镜像\"></a>上传、拉取镜像</h2><p>这里在本机下载一个nginx作为测试：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull nginx</span><br></pre></td></tr></table></figure>\n\n\n\n<p>首先需要登录镜像仓库：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker login 10.10.99.226</span><br></pre></td></tr></table></figure>\n\n<p><strong>根据提示输入用户名密码</strong></p>\n<p>上传前需要给待上传的镜像打标签：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker tag nginx 10.10.99.226/<span class=\"built_in\">test</span>/nginx:v1</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>标签格式为 <code>[harbor地址]/仓库名/镜像名:[版本]</code></p>\n</blockquote>\n<p>打完标签就可以上传镜像了：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker push 10.10.99.226/<span class=\"built_in\">test</span>/nginx:v1</span><br></pre></td></tr></table></figure>\n\n\n\n<img src=\"./upload-image.png\" style=\"zoom:75%;\" />\n\n\n\n<p>下载镜像可以在仓库中镜像旁边找到下载镜像的命令，直接执行即可：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull 10.10.99.226/<span class=\"built_in\">test</span>/nginx:v1</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>如果是私有仓库，则需要先登录</p>\n</blockquote>\n"},{"title":"部署单点zookeeper","date":"2021-04-06T06:57:30.000Z","description":"部署一个单点的适合于开发测试场景的zookeeper服务","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","_content":"\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了部署一个单点的zookeeper3.5.5服务\n\n更新于 2021-04-06\n\n{% endnote %}\n\n<br>\n\n\n\n## 下载\n\n下载地址：http://archive.apache.org/dist/zookeeper/\n\n>  需要下载的包必须带`bin`，这个是编译好的，否则运行会报错\n\n\n\n```bash\nwget http://archive.apache.org/dist/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz\n```\n\n\n\n<br>\n\n\n\n## 安装\n\n下载好的zookeeper压缩包已经经过编译，直接解压就可以用：\n\n```bash\ntar zxf apache-zookeeper-3.5.5-bin.tar.gz \ncd apache-zookeeper-3.5.5-bin\n```\n\n<br>\n\n## 建立配置文件\n\n默认没有配置文件，可以直接复制配置文件模板：\n\n```bash\nmv conf/zoo_sample.cfg conf/zoo.cfg\n```\n\n<br>\n\n## 创建数据目录\n\n虽然zookeeper一般数据量不大，但是还是推荐使用单独的数据盘：\n\n```bash\nmkdir /data/zookeeper\n```\n\n\n\n然后修改配置文件的如下字段，使用数据目录：\n\n```bash\n# conf/zoo.cfg\ndataDir=/data/zookeeper\n```\n\n<br>\n\n## 后台方式启动服务\n\n```bash\nbin/zkServer.sh start\n```\n\n![](./start.png)\n\n\n\n## 前台方式启动\n\n```bash\nbin/zkServer.sh start-foreground\n```\n\n<br>\n\n\n\n## 查看服务状态\n\n```bash\nbin/zkServer.sh status \n```\n\n![](./status.png)\n\n<br>\n\n## 查看日志\n\n如果是后台方式启动，日志默认存放在安装目录下的logs中，文件名包含主机名：\n\n```bash\ntail -f apache-zookeeper-3.5.5-bin/logs/zookeeper-root-server-localhost.out\n```\n\n\n\n\n\n## 停止zookeeper服务\n\n```bash\nbin/zkServer.sh stop \n```\n\n![](./stop.png)\n\n\n\n<br>","source":"_posts/部署单点zookeeper.md","raw":"---\ntitle: 部署单点zookeeper\ndate: 2021-04-06 14:57:30\ntags:\n- Zookeeper\ncategories:\n- Zookeeper\n- 部署\ndescription: 部署一个单点的适合于开发测试场景的zookeeper服务\ncover:\n---\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了部署一个单点的zookeeper3.5.5服务\n\n更新于 2021-04-06\n\n{% endnote %}\n\n<br>\n\n\n\n## 下载\n\n下载地址：http://archive.apache.org/dist/zookeeper/\n\n>  需要下载的包必须带`bin`，这个是编译好的，否则运行会报错\n\n\n\n```bash\nwget http://archive.apache.org/dist/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz\n```\n\n\n\n<br>\n\n\n\n## 安装\n\n下载好的zookeeper压缩包已经经过编译，直接解压就可以用：\n\n```bash\ntar zxf apache-zookeeper-3.5.5-bin.tar.gz \ncd apache-zookeeper-3.5.5-bin\n```\n\n<br>\n\n## 建立配置文件\n\n默认没有配置文件，可以直接复制配置文件模板：\n\n```bash\nmv conf/zoo_sample.cfg conf/zoo.cfg\n```\n\n<br>\n\n## 创建数据目录\n\n虽然zookeeper一般数据量不大，但是还是推荐使用单独的数据盘：\n\n```bash\nmkdir /data/zookeeper\n```\n\n\n\n然后修改配置文件的如下字段，使用数据目录：\n\n```bash\n# conf/zoo.cfg\ndataDir=/data/zookeeper\n```\n\n<br>\n\n## 后台方式启动服务\n\n```bash\nbin/zkServer.sh start\n```\n\n![](./start.png)\n\n\n\n## 前台方式启动\n\n```bash\nbin/zkServer.sh start-foreground\n```\n\n<br>\n\n\n\n## 查看服务状态\n\n```bash\nbin/zkServer.sh status \n```\n\n![](./status.png)\n\n<br>\n\n## 查看日志\n\n如果是后台方式启动，日志默认存放在安装目录下的logs中，文件名包含主机名：\n\n```bash\ntail -f apache-zookeeper-3.5.5-bin/logs/zookeeper-root-server-localhost.out\n```\n\n\n\n\n\n## 停止zookeeper服务\n\n```bash\nbin/zkServer.sh stop \n```\n\n![](./stop.png)\n\n\n\n<br>","slug":"部署单点zookeeper","published":1,"updated":"2021-04-06T07:08:31.130Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckn5olmow0000u5klgjjz7gz8","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了部署一个单点的zookeeper3.5.5服务</p><p>更新于 2021-04-06</p>\n          </div>\n\n<br>\n\n\n\n<h2 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p>下载地址：<a href=\"http://archive.apache.org/dist/zookeeper/\">http://archive.apache.org/dist/zookeeper/</a></p>\n<blockquote>\n<p> 需要下载的包必须带<code>bin</code>，这个是编译好的，否则运行会报错</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://archive.apache.org/dist/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>下载好的zookeeper压缩包已经经过编译，直接解压就可以用：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxf apache-zookeeper-3.5.5-bin.tar.gz </span><br><span class=\"line\"><span class=\"built_in\">cd</span> apache-zookeeper-3.5.5-bin</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"建立配置文件\"><a href=\"#建立配置文件\" class=\"headerlink\" title=\"建立配置文件\"></a>建立配置文件</h2><p>默认没有配置文件，可以直接复制配置文件模板：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mv conf/zoo_sample.cfg conf/zoo.cfg</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"创建数据目录\"><a href=\"#创建数据目录\" class=\"headerlink\" title=\"创建数据目录\"></a>创建数据目录</h2><p>虽然zookeeper一般数据量不大，但是还是推荐使用单独的数据盘：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /data/zookeeper</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后修改配置文件的如下字段，使用数据目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># conf/zoo.cfg</span></span><br><span class=\"line\">dataDir=/data/zookeeper</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"后台方式启动服务\"><a href=\"#后台方式启动服务\" class=\"headerlink\" title=\"后台方式启动服务\"></a>后台方式启动服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh start</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./start.png\" alt=\"\"></p>\n<h2 id=\"前台方式启动\"><a href=\"#前台方式启动\" class=\"headerlink\" title=\"前台方式启动\"></a>前台方式启动</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh start-foreground</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"查看服务状态\"><a href=\"#查看服务状态\" class=\"headerlink\" title=\"查看服务状态\"></a>查看服务状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh status </span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./status.png\" alt=\"\"></p>\n<br>\n\n<h2 id=\"查看日志\"><a href=\"#查看日志\" class=\"headerlink\" title=\"查看日志\"></a>查看日志</h2><p>如果是后台方式启动，日志默认存放在安装目录下的logs中，文件名包含主机名：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tail -f apache-zookeeper-3.5.5-bin/logs/zookeeper-root-server-localhost.out</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"停止zookeeper服务\"><a href=\"#停止zookeeper服务\" class=\"headerlink\" title=\"停止zookeeper服务\"></a>停止zookeeper服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh stop </span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./stop.png\" alt=\"\"></p>\n<br>","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了部署一个单点的zookeeper3.5.5服务</p><p>更新于 2021-04-06</p>\n          </div>\n\n<br>\n\n\n\n<h2 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p>下载地址：<a href=\"http://archive.apache.org/dist/zookeeper/\">http://archive.apache.org/dist/zookeeper/</a></p>\n<blockquote>\n<p> 需要下载的包必须带<code>bin</code>，这个是编译好的，否则运行会报错</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://archive.apache.org/dist/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>下载好的zookeeper压缩包已经经过编译，直接解压就可以用：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxf apache-zookeeper-3.5.5-bin.tar.gz </span><br><span class=\"line\"><span class=\"built_in\">cd</span> apache-zookeeper-3.5.5-bin</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"建立配置文件\"><a href=\"#建立配置文件\" class=\"headerlink\" title=\"建立配置文件\"></a>建立配置文件</h2><p>默认没有配置文件，可以直接复制配置文件模板：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mv conf/zoo_sample.cfg conf/zoo.cfg</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"创建数据目录\"><a href=\"#创建数据目录\" class=\"headerlink\" title=\"创建数据目录\"></a>创建数据目录</h2><p>虽然zookeeper一般数据量不大，但是还是推荐使用单独的数据盘：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /data/zookeeper</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后修改配置文件的如下字段，使用数据目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># conf/zoo.cfg</span></span><br><span class=\"line\">dataDir=/data/zookeeper</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"后台方式启动服务\"><a href=\"#后台方式启动服务\" class=\"headerlink\" title=\"后台方式启动服务\"></a>后台方式启动服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh start</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./start.png\" alt=\"\"></p>\n<h2 id=\"前台方式启动\"><a href=\"#前台方式启动\" class=\"headerlink\" title=\"前台方式启动\"></a>前台方式启动</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh start-foreground</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"查看服务状态\"><a href=\"#查看服务状态\" class=\"headerlink\" title=\"查看服务状态\"></a>查看服务状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh status </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./status.png\" alt=\"\"></p>\n<br>\n\n<h2 id=\"查看日志\"><a href=\"#查看日志\" class=\"headerlink\" title=\"查看日志\"></a>查看日志</h2><p>如果是后台方式启动，日志默认存放在安装目录下的logs中，文件名包含主机名：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tail -f apache-zookeeper-3.5.5-bin/logs/zookeeper-root-server-localhost.out</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"停止zookeeper服务\"><a href=\"#停止zookeeper服务\" class=\"headerlink\" title=\"停止zookeeper服务\"></a>停止zookeeper服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh stop </span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./stop.png\" alt=\"\"></p>\n<br>"},{"title":"二进制方式部署kubernetes 1.20","date":"2021-04-11T03:11:26.000Z","description":"使用二进制方式安装kubernetes 1.20版本集群","cover":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180613%2Fa12e8e321ae040e08c0a1edac71aeb2f.jpeg&refer=http%3A%2F%2F5b0988e595225.cdn.sohucs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620702740&t=d5454a9fbcd5da397ea7ec9d6531d1ab","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用二进制方式安装kubernetes 1.20版本集群\n\n更新于 2021-04-11\n\n{% endnote %}\n\n<br>\n\n\n\n# 集群规划\n\n{% tabs comments %}\n\n<!-- tab 部署流程 -->\n\n先部署一个单master节点的k8s集群，然后再扩展集群为多master节点实现高可用；\n\n<!-- endtab -->\n\n<!-- tab 服务器规划 -->\n\n| 角色       | IP            | 组件                                                         |\n| ---------- | ------------- | ------------------------------------------------------------ |\n| k8s-master | 192.168.31.71 | kube-apiserver，kube-controller-manager，kube-scheduler，etcd |\n| k8s-node1  | 192.168.31.72 | kubelet，kube-proxy，docker，etcd                            |\n| k8s-node2  | 192.168.31.73 | kubelet，kube-proxy，docker，etcd                            |\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 初始化配置\n\n**下面的初始化操作在所有服务器上进行**\n\n{% tabs comments %}\n\n<!-- tab 关闭防火墙 -->\n\n```bash\nsystemctl stop firewalld \nsystemctl disable firewalld \n```\n\n\n\n> 生产环境其实建议按需按端口开放\n\n<!-- endtab -->\n\n<!-- tab 关闭selinux和swap -->\n\n```bash\n# 关闭selinux \nsed -i 's/enforcing/disabled/' /etc/selinux/config  \nsetenforce 0  \n \n# 关闭swap \nswapoff -a \nsed -ri 's/.*swap.*/#&/' /etc/fstab   \n\n```\n\n<!-- endtab -->\n\n<!-- tab 添加host -->\n\n```bash\ncat >> /etc/hosts << EOF \n192.168.31.71 k8s-master1 \n192.168.31.72 k8s-node1 \n192.168.31.73 k8s-node2 \nEOF \n```\n\n<!-- endtab -->\n\n<!-- tab 内核参数设置 -->\n\n```bash\ncat > /etc/sysctl.d/k8s.conf << EOF \nnet.bridge.bridge-nf-call-ip6tables = 1 \nnet.bridge.bridge-nf-call-iptables = 1 \nEOF \n\n# 生效配置\nsysctl --system  \n```\n\n<!-- endtab -->\n\n<!-- tab 时间同步 -->\n\n```bash\nyum install -y  ntpdate \nntpdate time.windows.com\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署etcd\n\n{% note info 'fas fa-bullhorn' %}\n\n根据规划，我们将在三个节点上部署服务，形成一个etcd集群\n\n{% endnote %}\n\n\n\n## 创建证书\n\n{% tabs comments %}\n\n<!-- tab 安装cfssl -->\n\n安装cfssl用于生成证书文件，这里我在master节点上进行安装\n\n```bash\nwget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\nwget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\nwget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64\nchmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64\nmv cfssl_linux-amd64 /usr/local/bin/cfssl\nmv cfssljson_linux-amd64 /usr/local/bin/cfssljson\nmv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo \n```\n\n<!-- endtab -->\n\n<!-- tab 创建CA -->\n\n```bash\n# 创建证书目录\nmkdir -p ~/TLS/{etcd,k8s}\ncd ~/TLS/etcd\n\n# 自签CA\ncat > ca-config.json << EOF\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"87600h\"\n    },\n    \"profiles\": {\n      \"www\": {\n         \"expiry\": \"87600h\",\n         \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ]\n      }\n    }\n  }\n}\nEOF\n\ncat > ca-csr.json << EOF\n{\n    \"CN\": \"etcd CA\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"Beijing\",\n            \"ST\": \"Beijing\"\n        }\n    ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n```\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n执行完成后会生成`ca.pem`和`ca-key.pem`文件\n\n{% endnote %}\n\n<!-- endtab -->\n\n<!-- tab 签发etcd证书 -->\n\n```bash\n# 创建申请文件\ncat > server-csr.json << EOF\n{\n    \"CN\": \"etcd\",\n    \"hosts\": [\n    \"192.168.31.71\",\n    \"192.168.31.72\",\n    \"192.168.31.73\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"BeiJing\",\n            \"ST\": \"BeiJing\"\n        }\n    ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n执行完成后会生成`server.pem`和`server-key.pem`文件\n\n{% endnote %}\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 部署etcd集群\n\n\n\n{% tabs comments %}\n\n<!-- tab 安装 -->\n\n```bash\nwget https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz\n\n# 创建工作目录\nmkdir /opt/etcd/{bin,cfg,ssl} -p\ntar zxvf etcd-v3.4.9-linux-amd64.tar.gz\nmv etcd-v3.4.9-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/\n```\n\n<!-- endtab -->\n\n\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/etcd/cfg/etcd.conf << EOF\n#[Member]\nETCD_NAME=\"etcd-1\"\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"https://192.168.31.71:2380\"\nETCD_LISTEN_CLIENT_URLS=\"https://192.168.31.71:2379\"\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://192.168.31.71:2380\"\nETCD_ADVERTISE_CLIENT_URLS=\"https://192.168.31.71:2379\"\nETCD_INITIAL_CLUSTER=\"etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nEOF\n```\n\n-  ETCD_NAME：节点名称，集群中唯一\n- ETCD_DATA_DIR：数据目录\n- ETCD_LISTEN_PEER_URLS：集群通信监听地址\n- ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址\n- ETCD_INITIAL_ADVERTISE_PEERURLS：集群通告地址\n- ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址\n- ETCD_INITIAL_CLUSTER：集群节点地址\n- ETCD_INITIALCLUSTER_TOKEN：集群Token\n- ETCD_INITIALCLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群\n\n<!-- endtab -->\n\n<!-- tab 创建服务启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/etcd.service << EOF\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=notify\nEnvironmentFile=/opt/etcd/cfg/etcd.conf\nExecStart=/opt/etcd/bin/etcd \\\n--cert-file=/opt/etcd/ssl/server.pem \\\n--key-file=/opt/etcd/ssl/server-key.pem \\\n--peer-cert-file=/opt/etcd/ssl/server.pem \\\n--peer-key-file=/opt/etcd/ssl/server-key.pem \\\n--trusted-ca-file=/opt/etcd/ssl/ca.pem \\\n--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\\n--logger=zap\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 拷贝证书 -->\n\n```bash\ncp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动集群\n\n首先启动第一个节点：\n\n```bash\nsystemctl daemon-reload\nsystemctl start etcd\nsystemctl enable etcd\n```\n\n\n\n将上一步中的文件都拷贝到其他节点上：\n\n```bash\nscp -r /opt/etcd/ root@192.168.31.72:/opt/\nscp /usr/lib/systemd/system/etcd.service root@192.168.31.72:/usr/lib/systemd/system/\nscp -r /opt/etcd/ root@192.168.31.73:/opt/\nscp /usr/lib/systemd/system/etcd.service root@192.168.31.73:/usr/lib/systemd/system/\n```\n\n\n\n注意，拷贝过去后需要修改一下配置文件的内容，将IP和节点名称修改为当前所在服务器的地址：\n\n```bash\ncat /opt/etcd/cfg/etcd.conf\n#[Member]\nETCD_NAME=\"etcd-1\"   # 修改此处，节点2改为etcd-2，节点3改为etcd-3\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"https://192.168.31.71:2380\"   # 修改此处为当前服务器IP\nETCD_LISTEN_CLIENT_URLS=\"https://192.168.31.71:2379\" # 修改此处为当前服务器IP\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://192.168.31.71:2380\" # 修改此处为当前服务器IP\nETCD_ADVERTISE_CLIENT_URLS=\"https://192.168.31.71:2379\" # 修改此处为当前服务器IP\nETCD_INITIAL_CLUSTER=\"etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\n```\n\n\n\n然后在启动剩下的两个节点，步骤同上。\n\n\n\n## 查看集群状态\n\n```bash\nETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=\"https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.31.73:2379\" endpoint health --write-out=table\n\n+----------------------------+--------+-------------+-------+\n|          ENDPOINT    | HEALTH |    TOOK     | ERROR |\n+----------------------------+--------+-------------+-------+\n| https://192.168.31.71:2379 |   true | 10.301506ms |    |\n| https://192.168.31.73:2379 |   true | 12.87467ms |     |\n| https://192.168.31.72:2379 |   true | 13.225954ms |    |\n+----------------------------+--------+-------------+-------+\n\n```\n\n\n\n{% note success 'fas fa-bullhorn' %}\n\n可以看到集群是正常的，部署成功\n\n{% endnote %}\n\n\n\n<br>\n\n\n\n# 安装docker\n\n{% note info 'fas fa-bullhorn' %}\n\n在所有的节点都安装docker，也可以换成其他的容器引擎如containerd\n\n{% endnote %}\n\n\n\n## 下载安装 \n\n```bash\nwget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz\ntar zxvf docker-19.03.9.tgz\nmv docker/* /usr/bin\n```\n\n\n\n##  创建服务启动文件 \n\n```bash\ncat > /usr/lib/systemd/system/docker.service << EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n\n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP $MAINPID\nLimitNOFILE=infinity\nLimitNPROC=infinity\nLimitCORE=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n\n\n## 创建配置文件 \n\n```bash\nmkdir /etc/docker\ncat > /etc/docker/daemon.json << EOF\n{\n  \"registry-mirrors\": [\"https://b9pmyelo.mirror.aliyuncs.com\"]\n}\nEOF\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n这里使用了阿里云镜像加速器\n\n{% endnote %}\n\n\n\n\n\n## 启动服务 \n\n```bash\nsystemctl daemon-reload\nsystemctl start docker\nsystemctl enable docker\n```\n\n\n\n\n\n<br>\n\n\n\n# 部署master节点\n\n## 生成kube-apiserver证书\n\n{% tabs comments %}\n\n<!-- tab 自签CA -->\n\n```bash\ncd ~/TLS/k8s\n\ncat > ca-config.json << EOF\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"87600h\"\n    },\n    \"profiles\": {\n      \"kubernetes\": {\n         \"expiry\": \"87600h\",\n         \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ]\n      }\n    }\n  }\n}\nEOF\ncat > ca-csr.json << EOF\n{\n    \"CN\": \"kubernetes\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"Beijing\",\n            \"ST\": \"Beijing\",\n            \"O\": \"k8s\",\n            \"OU\": \"System\"\n        }\n    ]\n}\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 生成证书 -->\n\n```bash\ncfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n会生成`ca.pem`和`ca-key.pem`文件。\n\n{% endnote %}\n\n<!-- endtab -->\n\n<!-- tab 签发kube-apiserver证书 -->\n\n```bash\ncat > server-csr.json << EOF\n{\n    \"CN\": \"kubernetes\",\n    \"hosts\": [\n      \"10.0.0.1\",\n      \"127.0.0.1\",\n      \"192.168.31.71\",\n      \"192.168.31.72\",\n      \"192.168.31.73\",\n      \"192.168.31.88\",\n      \"kubernetes\",\n      \"kubernetes.default\",\n      \"kubernetes.default.svc\",\n      \"kubernetes.default.svc.cluster\",\n      \"kubernetes.default.svc.cluster.local\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"BeiJing\",\n            \"ST\": \"BeiJing\",\n            \"O\": \"k8s\",\n            \"OU\": \"System\"\n        }\n    ]\n}\nEOF\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n文件hosts字段中IP为所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP\n\n{% endnote %}\n\n<!-- endtab -->\n\n<!-- tab 生成证书 -->\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 安装kube-apiserver\n\n**https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md，在这里下载1.20版本的安装包，下载server包就够了，包含了Master和Worker Node二进制文件。**\n\n{% tabs comments %}\n\n<!-- tab 安装 -->\n\n```bash\nmkdir -p /opt/kubernetes/{bin,cfg,ssl,logs} \ntar zxvf kubernetes-server-linux-amd64.tar.gz\ncd kubernetes/server/bin\ncp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin\ncp kubectl /usr/bin/\n\n# 拷贝证书\ncp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/\n```\n\n<!-- endtab -->\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-apiserver.conf << EOF\nKUBE_APISERVER_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--etcd-servers=https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.31.73:2379 \\\\\n--bind-address=192.168.31.71 \\\\\n--secure-port=6443 \\\\\n--advertise-address=192.168.31.71 \\\\\n--allow-privileged=true \\\\\n--service-cluster-ip-range=10.0.0.0/24 \\\\\n--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\\\\n--authorization-mode=RBAC,Node \\\\\n--enable-bootstrap-token-auth=true \\\\\n--token-auth-file=/opt/kubernetes/cfg/token.csv \\\\\n--service-node-port-range=30000-32767 \\\\\n--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\\\\n--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\\\\n--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\\\\n--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\\n--service-account-issuer=api \\\\\n--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--etcd-cafile=/opt/etcd/ssl/ca.pem \\\\\n--etcd-certfile=/opt/etcd/ssl/server.pem \\\\\n--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\\\\n--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\\\\n--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--requestheader-allowed-names=kubernetes \\\\\n--requestheader-extra-headers-prefix=X-Remote-Extra- \\\\\n--requestheader-group-headers=X-Remote-Group \\\\\n--requestheader-username-headers=X-Remote-User \\\\\n--enable-aggregator-routing=true \\\\\n--audit-log-maxage=30 \\\\\n--audit-log-maxbackup=3 \\\\\n--audit-log-maxsize=100 \\\\\n--audit-log-path=/opt/kubernetes/logs/k8s-audit.log\"\nEOF\n```\n\n- --logtostderr：启用日志\n- ---v：日志等级\n- --log-dir：日志目录\n- --etcd-servers：etcd集群地址\n- --bind-address：监听地址\n- --secure-port：https安全端口\n- --advertise-address：集群通告地址\n- --allow-privileged：启用授权\n- --service-cluster-ip-range：Service虚拟IP地址段\n- --enable-admission-plugins：准入控制模块\n- --authorization-mode：认证授权，启用RBAC授权和节点自管理\n- --enable-bootstrap-token-auth：启用TLS bootstrap机制\n- --token-auth-file：bootstrap token文件\n- --service-node-port-range：Service nodeport类型默认分配端口范围\n- --kubelet-client-xxx：apiserver访问kubelet客户端证书\n- --tls-xxx-file：apiserver https证书\n- --etcd-xxxfile：连接Etcd集群证书\n- --audit-log-xxx：审计日志\n\n1.20版本必须加的参数：\n\n- --service-account-issuer\n- --service-account-signing-key-file\n\n启动聚合层相关配置：\n\n- --requestheader-client-ca-file\n- --proxy-client-cert-file\n- --proxy-client-key-file\n- --requestheader-allowed-names\n- --requestheader-extra-headers-prefix\n- --requestheader-group-headers\n- --requestheader-username-headers\n- --enable-aggregator-routing\n\n<!-- endtab -->\n\n<!-- tab 创建TLS Token -->\n\n```bash\n# 生成一个token\nhead -c 16 /dev/urandom | od -An -t x | tr -d ' '\n\n# 创建文件\ncat > /opt/kubernetes/cfg/token.csv << EOF\nc47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,\"system:node-bootstrapper\"\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kube-apiserver.service << EOF\n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf\nExecStart=/opt/kubernetes/bin/kube-apiserver \\$KUBE_APISERVER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kube-apiserver\n\n```bash\nsystemctl daemon-reload\nsystemctl start kube-apiserver \nsystemctl enable kube-apiserver\n```\n\n\n\n\n\n## 部署kube-controller-manager\n\n{% tabs comments %}\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-controller-manager.conf << EOF\nKUBE_CONTROLLER_MANAGER_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--leader-elect=true \\\\\n--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\\\\n--bind-address=127.0.0.1 \\\\\n--allocate-node-cidrs=true \\\\\n--cluster-cidr=10.244.0.0/16 \\\\\n--service-cluster-ip-range=10.0.0.0/24 \\\\\n--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\\\\n--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\\\\n--root-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\\n--cluster-signing-duration=87600h0m0s\"\nEOF\n```\n\n- --kubeconfig：连接apiserver配置文件\n- --leader-elect：当该组件启动多个时，自动选举（HA）\n- --cluster-signing-cert-file/--cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致\n\n<!-- endtab -->\n\n<!-- tab 创建证书 -->\n\n```bash\ncd ~/TLS/k8s\n\n# 创建证书请求文件\ncat > kube-controller-manager-csr.json << EOF\n{\n  \"CN\": \"system:kube-controller-manager\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"BeiJing\", \n      \"ST\": \"BeiJing\",\n      \"O\": \"system:masters\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kubeconfig文件 -->\n\n```bash\nKUBE_CONFIG=\"/opt/kubernetes/cfg/kube-controller-manager.kubeconfig\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\"\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials kube-controller-manager \\\n  --client-certificate=./kube-controller-manager.pem \\\n  --client-key=./kube-controller-manager-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-controller-manager \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kube-controller-manager.service << EOF\n[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf\nExecStart=/opt/kubernetes/bin/kube-controller-manager \\$KUBE_CONTROLLER_MANAGER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kube-controller-manager\n\n```bash\nsystemctl daemon-reload\nsystemctl start kube-controller-manager\nsystemctl enable kube-controller-manager\n```\n\n\n\n## 部署kube-scheduler\n\n{% tabs comments %}\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-scheduler.conf << EOF\nKUBE_SCHEDULER_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--leader-elect \\\\\n--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\\\\n--bind-address=127.0.0.1\"\nEOF\n```\n\n- --kubeconfig：连接apiserver配置文件\n- --leader-elect：当该组件启动多个时，自动选举（HA）\n\n<!-- endtab -->\n\n<!-- tab 创建证书 -->\n\n```bash\ncd ~/TLS/k8s\n\n# 创建证书请求文件\ncat > kube-scheduler-csr.json << EOF\n{\n  \"CN\": \"system:kube-scheduler\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"BeiJing\",\n      \"ST\": \"BeiJing\",\n      \"O\": \"system:masters\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kubeconfig文件 -->\n\n```bash\nKUBE_CONFIG=\"/opt/kubernetes/cfg/kube-scheduler.kubeconfig\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\"\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials kube-scheduler \\\n  --client-certificate=./kube-scheduler.pem \\\n  --client-key=./kube-scheduler-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-scheduler \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kube-scheduler.service << EOF\n[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf\nExecStart=/opt/kubernetes/bin/kube-scheduler \\$KUBE_SCHEDULER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kube-scheduler\n\n```bash\nsystemctl daemon-reload\nsystemctl start kube-scheduler\nsystemctl enable kube-scheduler\n```\n\n\n\n## 创建kubectl证书文件连接集群\n\n```bash\n# 生成证书\ncat > admin-csr.json <<EOF\n{\n  \"CN\": \"admin\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"BeiJing\",\n      \"ST\": \"BeiJing\",\n      \"O\": \"system:masters\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF\n\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin\n\n# 生成kubeconfig\nmkdir /root/.kube\n\nKUBE_CONFIG=\"/root/.kube/config\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\"\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials cluster-admin \\\n  --client-certificate=./admin.pem \\\n  --client-key=./admin-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=cluster-admin \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n\n\n## 查看集群状态\n\n```bash\nkubectl get cs\nNAME                STATUS    MESSAGE             ERROR\nscheduler             Healthy   ok                  \ncontroller-manager       Healthy   ok                  \netcd-2               Healthy   {\"health\":\"true\"}   \netcd-1               Healthy   {\"health\":\"true\"}   \netcd-0               Healthy   {\"health\":\"true\"}  \n```\n\n{% note info 'fas fa-bullhorn' %}\n\n都是`health`表示集群现在是健康状态\n\n{% endnote %}\n\n\n\n## 授权kubelet-bootstrap用户允许请求证书\n\n```bash\nkubectl create clusterrolebinding kubelet-bootstrap \\\n--clusterrole=system:node-bootstrapper \\\n--user=kubelet-bootstrap\n```\n\n\n\n<br>\n\n\n\n# 部署node节点\n\n## 创建工作目录并拷贝二进制文件\n\n```bash\nmkdir -p /opt/kubernetes/{bin,cfg,ssl,logs} \ncd kubernetes/server/bin\ncp kubelet kube-proxy /opt/kubernetes/bin  \n```\n\n\n\n\n\n## 部署kubelet\n\n{% tabs comments %}\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kubelet.conf << EOF\nKUBELET_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--hostname-override=k8s-master1 \\\\\n--network-plugin=cni \\\\\n--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\\\\n--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\\\\n--config=/opt/kubernetes/cfg/kubelet-config.yml \\\\\n--cert-dir=/opt/kubernetes/ssl \\\\\n--pod-infra-container-image=lizhenliang/pause-amd64:3.0\"\nEOF\n```\n\n- --hostname-override：显示名称，集群中唯一\n- --network-plugin：启用CNI\n- --kubeconfig：空路径，会自动生成，后面用于连接apiserver\n- --bootstrap-kubeconfig：首次启动向apiserver申请证书\n- --config：配置参数文件\n- --cert-dir：kubelet证书生成目录\n- --pod-infra-container-image：管理Pod网络容器的镜像\n\n<!-- endtab -->\n\n<!-- tab 创建配置参数文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kubelet-config.yml << EOF\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\naddress: 0.0.0.0\nport: 10250\nreadOnlyPort: 10255\ncgroupDriver: cgroupfs\nclusterDNS:\n- 10.0.0.2\nclusterDomain: cluster.local \nfailSwapOn: false\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 2m0s\n    enabled: true\n  x509:\n    clientCAFile: /opt/kubernetes/ssl/ca.pem \nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\nevictionHard:\n  imagefs.available: 15%\n  memory.available: 100Mi\n  nodefs.available: 10%\n  nodefs.inodesFree: 5%\nmaxOpenFiles: 1000000\nmaxPods: 110\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kubeconfig文件 -->\n\n```bash\nKUBE_CONFIG=\"/opt/kubernetes/cfg/bootstrap.kubeconfig\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\" # apiserver IP:PORT\nTOKEN=\"c47ffb939f5ca36231d9e3121a252940\" # 与token.csv里保持一致\n\n# 生成 kubelet bootstrap kubeconfig 配置文件\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials \"kubelet-bootstrap\" \\\n  --token=${TOKEN} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=\"kubelet-bootstrap\" \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kubelet.service << EOF\n[Unit]\nDescription=Kubernetes Kubelet\nAfter=docker.service\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kubelet.conf\nExecStart=/opt/kubernetes/bin/kubelet \\$KUBELET_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kubelet\n\n```bash\nsystemctl daemon-reload\nsystemctl start kubelet\nsystemctl enable kubelet\n```\n\n\n\n## 审批kubelet证书申请并加入集群\n\n```bash\n# 查看kubelet证书请求\nkubectl get csr\nNAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION\nnode-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A   6m3s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending\n\n# 批准申请\nkubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A\n\n# 查看节点\nkubectl get node\nNAME         STATUS     ROLES    AGE   VERSION\nk8s-master1   NotReady   <none>   7s    v1.18.3\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n由于网络插件还没有部署，节点会没有准备就绪 NotReady\n\n{% endnote %}\n\n\n\n## 部署kube-proxy\n\n{% tabs comments %}\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-proxy.conf << EOF\nKUBE_PROXY_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--config=/opt/kubernetes/cfg/kube-proxy-config.yml\"\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 创建配置参数文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-proxy-config.yml << EOF\nkind: KubeProxyConfiguration\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0\nmetricsBindAddress: 0.0.0.0:10249\nclientConnection:\n  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig\nhostnameOverride: k8s-master1\nclusterCIDR: 10.0.0.0/24\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kube-proxy证书 -->\n\n```bash\ncd ~/TLS/k8s\n\n# 创建证书请求文件\ncat > kube-proxy-csr.json << EOF\n{\n  \"CN\": \"system:kube-proxy\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"BeiJing\",\n      \"ST\": \"BeiJing\",\n      \"O\": \"k8s\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kubeconfig文件 -->\n\n```bash\nKUBE_CONFIG=\"/opt/kubernetes/cfg/kube-proxy.kubeconfig\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\"\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials kube-proxy \\\n  --client-certificate=./kube-proxy.pem \\\n  --client-key=./kube-proxy-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-proxy \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kube-proxy.service << EOF\n[Unit]\nDescription=Kubernetes Proxy\nAfter=network.target\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf\nExecStart=/opt/kubernetes/bin/kube-proxy \\$KUBE_PROXY_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kube-proxy\n\n```bash\nsystemctl daemon-reload\nsystemctl start kube-proxy\nsystemctl enable kube-proxy\n```\n\n\n\n<br>\n\n\n\n## 部署网络插件callico\n\n```bash\nkubectl apply -f calico.yaml\nkubectl get pods -n kube-system\n```\n\n\n\n## 检查集群pod状态\n\n```bash\nkubectl get node\nNAME         STATUS   ROLES    AGE   VERSION\nk8s-master   Ready    <none>   37m   v1.20.4\n```\n\n\n\n## 授权apiserver访问kubelet\n\n```bash\ncat > apiserver-to-kubelet-rbac.yaml << EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:kube-apiserver-to-kubelet\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - nodes/proxy\n      - nodes/stats\n      - nodes/log\n      - nodes/spec\n      - nodes/metrics\n      - pods/log\n    verbs:\n      - \"*\"\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: system:kube-apiserver\n  namespace: \"\"\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:kube-apiserver-to-kubelet\nsubjects:\n  - apiGroup: rbac.authorization.k8s.io\n    kind: User\n    name: kubernetes\nEOF\n\nkubectl apply -f apiserver-to-kubelet-rbac.yaml\n```\n\n\n\n## node节点扩容\n\n```bash\n# 拷贝相关文件\nscp -r /opt/kubernetes root@192.168.31.72:/opt/\n\nscp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service root@192.168.31.72:/usr/lib/systemd/system\n\nscp /opt/kubernetes/ssl/ca.pem root@192.168.31.72:/opt/kubernetes/ssl\n\n# 在node节点上删除kubeconfig文件\nrm -f /opt/kubernetes/cfg/kubelet.kubeconfig \nrm -f /opt/kubernetes/ssl/kubelet*\n\n# 修改kubelet配置文件\nvi /opt/kubernetes/cfg/kubelet.conf\n--hostname-override=k8s-node1 ## 修改这一项\n\nvi /opt/kubernetes/cfg/kube-proxy-config.yml\nhostnameOverride: k8s-node1  ## 修改这一项\n\n\n# 启动\nsystemctl daemon-reload\nsystemctl start kubelet kube-proxy\nsystemctl enable kubelet kube-proxy\nsystemctl start kubelet kubelet\nsystemctl enable kubelet kubelet\n\n# 在master上批准请求\n# 查看证书请求\nkubectl get csr\nNAME           AGE   SIGNERNAME                    REQUESTOR           CONDITION\nnode-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro   89s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending\n\n# 授权请求\nkubectl certificate approve node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro\n\n# 查看node状态\nkubectl get node\nNAME       STATUS   ROLES    AGE     VERSION\nk8s-master1   Ready    <none>   47m     v1.20.4\nk8s-node1    Ready    <none>   6m49s   v1.20.4\n```\n\n\n\n<br>\n\n\n\n# 常用插件部署\n\n## 部署dashboard\n\n```bash\nkubectl apply -f kubernetes-dashboard.yaml\nkubectl get pods,svc -n kubernetes-dashboard\n\n# 创建serviceaccount\nkubectl create serviceaccount dashboard-admin -n kube-system\nkubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin\nkubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')\n```\n\n\n\n上一步将输出一个token，访问：https://NodeIP:30001，输入token即可进入页面\n\n\n\n## 部署coredns\n\n```bash\nkubectl apply -f coredns.yaml \n \nkubectl get pods -n kube-system  \nNAME                          READY   STATUS    RESTARTS   AGE \ncoredns-5ffbfd976d-j6shb      1/1     Running   0          32s\n\n# 测试解析\nkubectl run -it --rm dns-test --image=busybox:1.28.4 sh \nIf you don't see a command prompt, try pressing enter. \n \n/ # nslookup kubernetes \nServer:    10.0.0.2 \nAddress 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local \n \nName:      kubernetes \nAddress 1: 10.0.0.1 kubernetes.default.svc.cluster.local\n\n```\n\n","source":"_posts/二进制方式部署kubernetes-1-20.md","raw":"---\ntitle: 二进制方式部署kubernetes 1.20\ndate: 2021-04-11 11:11:26\ntags:\n- Kubernetes\ncategories:\n- Kubernetes\n- 集群部署\ndescription: 使用二进制方式安装kubernetes 1.20版本集群\ncover: https://gimg2.baidu.com/image_search/src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180613%2Fa12e8e321ae040e08c0a1edac71aeb2f.jpeg&refer=http%3A%2F%2F5b0988e595225.cdn.sohucs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620702740&t=d5454a9fbcd5da397ea7ec9d6531d1ab\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用二进制方式安装kubernetes 1.20版本集群\n\n更新于 2021-04-11\n\n{% endnote %}\n\n<br>\n\n\n\n# 集群规划\n\n{% tabs comments %}\n\n<!-- tab 部署流程 -->\n\n先部署一个单master节点的k8s集群，然后再扩展集群为多master节点实现高可用；\n\n<!-- endtab -->\n\n<!-- tab 服务器规划 -->\n\n| 角色       | IP            | 组件                                                         |\n| ---------- | ------------- | ------------------------------------------------------------ |\n| k8s-master | 192.168.31.71 | kube-apiserver，kube-controller-manager，kube-scheduler，etcd |\n| k8s-node1  | 192.168.31.72 | kubelet，kube-proxy，docker，etcd                            |\n| k8s-node2  | 192.168.31.73 | kubelet，kube-proxy，docker，etcd                            |\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 初始化配置\n\n**下面的初始化操作在所有服务器上进行**\n\n{% tabs comments %}\n\n<!-- tab 关闭防火墙 -->\n\n```bash\nsystemctl stop firewalld \nsystemctl disable firewalld \n```\n\n\n\n> 生产环境其实建议按需按端口开放\n\n<!-- endtab -->\n\n<!-- tab 关闭selinux和swap -->\n\n```bash\n# 关闭selinux \nsed -i 's/enforcing/disabled/' /etc/selinux/config  \nsetenforce 0  \n \n# 关闭swap \nswapoff -a \nsed -ri 's/.*swap.*/#&/' /etc/fstab   \n\n```\n\n<!-- endtab -->\n\n<!-- tab 添加host -->\n\n```bash\ncat >> /etc/hosts << EOF \n192.168.31.71 k8s-master1 \n192.168.31.72 k8s-node1 \n192.168.31.73 k8s-node2 \nEOF \n```\n\n<!-- endtab -->\n\n<!-- tab 内核参数设置 -->\n\n```bash\ncat > /etc/sysctl.d/k8s.conf << EOF \nnet.bridge.bridge-nf-call-ip6tables = 1 \nnet.bridge.bridge-nf-call-iptables = 1 \nEOF \n\n# 生效配置\nsysctl --system  \n```\n\n<!-- endtab -->\n\n<!-- tab 时间同步 -->\n\n```bash\nyum install -y  ntpdate \nntpdate time.windows.com\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署etcd\n\n{% note info 'fas fa-bullhorn' %}\n\n根据规划，我们将在三个节点上部署服务，形成一个etcd集群\n\n{% endnote %}\n\n\n\n## 创建证书\n\n{% tabs comments %}\n\n<!-- tab 安装cfssl -->\n\n安装cfssl用于生成证书文件，这里我在master节点上进行安装\n\n```bash\nwget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\nwget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\nwget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64\nchmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64\nmv cfssl_linux-amd64 /usr/local/bin/cfssl\nmv cfssljson_linux-amd64 /usr/local/bin/cfssljson\nmv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo \n```\n\n<!-- endtab -->\n\n<!-- tab 创建CA -->\n\n```bash\n# 创建证书目录\nmkdir -p ~/TLS/{etcd,k8s}\ncd ~/TLS/etcd\n\n# 自签CA\ncat > ca-config.json << EOF\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"87600h\"\n    },\n    \"profiles\": {\n      \"www\": {\n         \"expiry\": \"87600h\",\n         \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ]\n      }\n    }\n  }\n}\nEOF\n\ncat > ca-csr.json << EOF\n{\n    \"CN\": \"etcd CA\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"Beijing\",\n            \"ST\": \"Beijing\"\n        }\n    ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n```\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n执行完成后会生成`ca.pem`和`ca-key.pem`文件\n\n{% endnote %}\n\n<!-- endtab -->\n\n<!-- tab 签发etcd证书 -->\n\n```bash\n# 创建申请文件\ncat > server-csr.json << EOF\n{\n    \"CN\": \"etcd\",\n    \"hosts\": [\n    \"192.168.31.71\",\n    \"192.168.31.72\",\n    \"192.168.31.73\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"BeiJing\",\n            \"ST\": \"BeiJing\"\n        }\n    ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n执行完成后会生成`server.pem`和`server-key.pem`文件\n\n{% endnote %}\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 部署etcd集群\n\n\n\n{% tabs comments %}\n\n<!-- tab 安装 -->\n\n```bash\nwget https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz\n\n# 创建工作目录\nmkdir /opt/etcd/{bin,cfg,ssl} -p\ntar zxvf etcd-v3.4.9-linux-amd64.tar.gz\nmv etcd-v3.4.9-linux-amd64/{etcd,etcdctl} /opt/etcd/bin/\n```\n\n<!-- endtab -->\n\n\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/etcd/cfg/etcd.conf << EOF\n#[Member]\nETCD_NAME=\"etcd-1\"\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"https://192.168.31.71:2380\"\nETCD_LISTEN_CLIENT_URLS=\"https://192.168.31.71:2379\"\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://192.168.31.71:2380\"\nETCD_ADVERTISE_CLIENT_URLS=\"https://192.168.31.71:2379\"\nETCD_INITIAL_CLUSTER=\"etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nEOF\n```\n\n-  ETCD_NAME：节点名称，集群中唯一\n- ETCD_DATA_DIR：数据目录\n- ETCD_LISTEN_PEER_URLS：集群通信监听地址\n- ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址\n- ETCD_INITIAL_ADVERTISE_PEERURLS：集群通告地址\n- ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址\n- ETCD_INITIAL_CLUSTER：集群节点地址\n- ETCD_INITIALCLUSTER_TOKEN：集群Token\n- ETCD_INITIALCLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群\n\n<!-- endtab -->\n\n<!-- tab 创建服务启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/etcd.service << EOF\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=notify\nEnvironmentFile=/opt/etcd/cfg/etcd.conf\nExecStart=/opt/etcd/bin/etcd \\\n--cert-file=/opt/etcd/ssl/server.pem \\\n--key-file=/opt/etcd/ssl/server-key.pem \\\n--peer-cert-file=/opt/etcd/ssl/server.pem \\\n--peer-key-file=/opt/etcd/ssl/server-key.pem \\\n--trusted-ca-file=/opt/etcd/ssl/ca.pem \\\n--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\\n--logger=zap\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 拷贝证书 -->\n\n```bash\ncp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动集群\n\n首先启动第一个节点：\n\n```bash\nsystemctl daemon-reload\nsystemctl start etcd\nsystemctl enable etcd\n```\n\n\n\n将上一步中的文件都拷贝到其他节点上：\n\n```bash\nscp -r /opt/etcd/ root@192.168.31.72:/opt/\nscp /usr/lib/systemd/system/etcd.service root@192.168.31.72:/usr/lib/systemd/system/\nscp -r /opt/etcd/ root@192.168.31.73:/opt/\nscp /usr/lib/systemd/system/etcd.service root@192.168.31.73:/usr/lib/systemd/system/\n```\n\n\n\n注意，拷贝过去后需要修改一下配置文件的内容，将IP和节点名称修改为当前所在服务器的地址：\n\n```bash\ncat /opt/etcd/cfg/etcd.conf\n#[Member]\nETCD_NAME=\"etcd-1\"   # 修改此处，节点2改为etcd-2，节点3改为etcd-3\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"https://192.168.31.71:2380\"   # 修改此处为当前服务器IP\nETCD_LISTEN_CLIENT_URLS=\"https://192.168.31.71:2379\" # 修改此处为当前服务器IP\n\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://192.168.31.71:2380\" # 修改此处为当前服务器IP\nETCD_ADVERTISE_CLIENT_URLS=\"https://192.168.31.71:2379\" # 修改此处为当前服务器IP\nETCD_INITIAL_CLUSTER=\"etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\n```\n\n\n\n然后在启动剩下的两个节点，步骤同上。\n\n\n\n## 查看集群状态\n\n```bash\nETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=\"https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.31.73:2379\" endpoint health --write-out=table\n\n+----------------------------+--------+-------------+-------+\n|          ENDPOINT    | HEALTH |    TOOK     | ERROR |\n+----------------------------+--------+-------------+-------+\n| https://192.168.31.71:2379 |   true | 10.301506ms |    |\n| https://192.168.31.73:2379 |   true | 12.87467ms |     |\n| https://192.168.31.72:2379 |   true | 13.225954ms |    |\n+----------------------------+--------+-------------+-------+\n\n```\n\n\n\n{% note success 'fas fa-bullhorn' %}\n\n可以看到集群是正常的，部署成功\n\n{% endnote %}\n\n\n\n<br>\n\n\n\n# 安装docker\n\n{% note info 'fas fa-bullhorn' %}\n\n在所有的节点都安装docker，也可以换成其他的容器引擎如containerd\n\n{% endnote %}\n\n\n\n## 下载安装 \n\n```bash\nwget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz\ntar zxvf docker-19.03.9.tgz\nmv docker/* /usr/bin\n```\n\n\n\n##  创建服务启动文件 \n\n```bash\ncat > /usr/lib/systemd/system/docker.service << EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n\n[Service]\nType=notify\nExecStart=/usr/bin/dockerd\nExecReload=/bin/kill -s HUP $MAINPID\nLimitNOFILE=infinity\nLimitNPROC=infinity\nLimitCORE=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n\n\n## 创建配置文件 \n\n```bash\nmkdir /etc/docker\ncat > /etc/docker/daemon.json << EOF\n{\n  \"registry-mirrors\": [\"https://b9pmyelo.mirror.aliyuncs.com\"]\n}\nEOF\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n这里使用了阿里云镜像加速器\n\n{% endnote %}\n\n\n\n\n\n## 启动服务 \n\n```bash\nsystemctl daemon-reload\nsystemctl start docker\nsystemctl enable docker\n```\n\n\n\n\n\n<br>\n\n\n\n# 部署master节点\n\n## 生成kube-apiserver证书\n\n{% tabs comments %}\n\n<!-- tab 自签CA -->\n\n```bash\ncd ~/TLS/k8s\n\ncat > ca-config.json << EOF\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"87600h\"\n    },\n    \"profiles\": {\n      \"kubernetes\": {\n         \"expiry\": \"87600h\",\n         \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ]\n      }\n    }\n  }\n}\nEOF\ncat > ca-csr.json << EOF\n{\n    \"CN\": \"kubernetes\",\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"Beijing\",\n            \"ST\": \"Beijing\",\n            \"O\": \"k8s\",\n            \"OU\": \"System\"\n        }\n    ]\n}\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 生成证书 -->\n\n```bash\ncfssl gencert -initca ca-csr.json | cfssljson -bare ca -\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n会生成`ca.pem`和`ca-key.pem`文件。\n\n{% endnote %}\n\n<!-- endtab -->\n\n<!-- tab 签发kube-apiserver证书 -->\n\n```bash\ncat > server-csr.json << EOF\n{\n    \"CN\": \"kubernetes\",\n    \"hosts\": [\n      \"10.0.0.1\",\n      \"127.0.0.1\",\n      \"192.168.31.71\",\n      \"192.168.31.72\",\n      \"192.168.31.73\",\n      \"192.168.31.88\",\n      \"kubernetes\",\n      \"kubernetes.default\",\n      \"kubernetes.default.svc\",\n      \"kubernetes.default.svc.cluster\",\n      \"kubernetes.default.svc.cluster.local\"\n    ],\n    \"key\": {\n        \"algo\": \"rsa\",\n        \"size\": 2048\n    },\n    \"names\": [\n        {\n            \"C\": \"CN\",\n            \"L\": \"BeiJing\",\n            \"ST\": \"BeiJing\",\n            \"O\": \"k8s\",\n            \"OU\": \"System\"\n        }\n    ]\n}\nEOF\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n文件hosts字段中IP为所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP\n\n{% endnote %}\n\n<!-- endtab -->\n\n<!-- tab 生成证书 -->\n\n```bash\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 安装kube-apiserver\n\n**https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md，在这里下载1.20版本的安装包，下载server包就够了，包含了Master和Worker Node二进制文件。**\n\n{% tabs comments %}\n\n<!-- tab 安装 -->\n\n```bash\nmkdir -p /opt/kubernetes/{bin,cfg,ssl,logs} \ntar zxvf kubernetes-server-linux-amd64.tar.gz\ncd kubernetes/server/bin\ncp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin\ncp kubectl /usr/bin/\n\n# 拷贝证书\ncp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/\n```\n\n<!-- endtab -->\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-apiserver.conf << EOF\nKUBE_APISERVER_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--etcd-servers=https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.31.73:2379 \\\\\n--bind-address=192.168.31.71 \\\\\n--secure-port=6443 \\\\\n--advertise-address=192.168.31.71 \\\\\n--allow-privileged=true \\\\\n--service-cluster-ip-range=10.0.0.0/24 \\\\\n--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\\\\n--authorization-mode=RBAC,Node \\\\\n--enable-bootstrap-token-auth=true \\\\\n--token-auth-file=/opt/kubernetes/cfg/token.csv \\\\\n--service-node-port-range=30000-32767 \\\\\n--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\\\\n--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\\\\n--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\\\\n--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\\n--service-account-issuer=api \\\\\n--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--etcd-cafile=/opt/etcd/ssl/ca.pem \\\\\n--etcd-certfile=/opt/etcd/ssl/server.pem \\\\\n--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\\\\n--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\\\\n--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\\\\n--requestheader-allowed-names=kubernetes \\\\\n--requestheader-extra-headers-prefix=X-Remote-Extra- \\\\\n--requestheader-group-headers=X-Remote-Group \\\\\n--requestheader-username-headers=X-Remote-User \\\\\n--enable-aggregator-routing=true \\\\\n--audit-log-maxage=30 \\\\\n--audit-log-maxbackup=3 \\\\\n--audit-log-maxsize=100 \\\\\n--audit-log-path=/opt/kubernetes/logs/k8s-audit.log\"\nEOF\n```\n\n- --logtostderr：启用日志\n- ---v：日志等级\n- --log-dir：日志目录\n- --etcd-servers：etcd集群地址\n- --bind-address：监听地址\n- --secure-port：https安全端口\n- --advertise-address：集群通告地址\n- --allow-privileged：启用授权\n- --service-cluster-ip-range：Service虚拟IP地址段\n- --enable-admission-plugins：准入控制模块\n- --authorization-mode：认证授权，启用RBAC授权和节点自管理\n- --enable-bootstrap-token-auth：启用TLS bootstrap机制\n- --token-auth-file：bootstrap token文件\n- --service-node-port-range：Service nodeport类型默认分配端口范围\n- --kubelet-client-xxx：apiserver访问kubelet客户端证书\n- --tls-xxx-file：apiserver https证书\n- --etcd-xxxfile：连接Etcd集群证书\n- --audit-log-xxx：审计日志\n\n1.20版本必须加的参数：\n\n- --service-account-issuer\n- --service-account-signing-key-file\n\n启动聚合层相关配置：\n\n- --requestheader-client-ca-file\n- --proxy-client-cert-file\n- --proxy-client-key-file\n- --requestheader-allowed-names\n- --requestheader-extra-headers-prefix\n- --requestheader-group-headers\n- --requestheader-username-headers\n- --enable-aggregator-routing\n\n<!-- endtab -->\n\n<!-- tab 创建TLS Token -->\n\n```bash\n# 生成一个token\nhead -c 16 /dev/urandom | od -An -t x | tr -d ' '\n\n# 创建文件\ncat > /opt/kubernetes/cfg/token.csv << EOF\nc47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,\"system:node-bootstrapper\"\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kube-apiserver.service << EOF\n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf\nExecStart=/opt/kubernetes/bin/kube-apiserver \\$KUBE_APISERVER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kube-apiserver\n\n```bash\nsystemctl daemon-reload\nsystemctl start kube-apiserver \nsystemctl enable kube-apiserver\n```\n\n\n\n\n\n## 部署kube-controller-manager\n\n{% tabs comments %}\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-controller-manager.conf << EOF\nKUBE_CONTROLLER_MANAGER_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--leader-elect=true \\\\\n--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\\\\n--bind-address=127.0.0.1 \\\\\n--allocate-node-cidrs=true \\\\\n--cluster-cidr=10.244.0.0/16 \\\\\n--service-cluster-ip-range=10.0.0.0/24 \\\\\n--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\\\\n--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\\\\n--root-ca-file=/opt/kubernetes/ssl/ca.pem \\\\\n--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\\n--cluster-signing-duration=87600h0m0s\"\nEOF\n```\n\n- --kubeconfig：连接apiserver配置文件\n- --leader-elect：当该组件启动多个时，自动选举（HA）\n- --cluster-signing-cert-file/--cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致\n\n<!-- endtab -->\n\n<!-- tab 创建证书 -->\n\n```bash\ncd ~/TLS/k8s\n\n# 创建证书请求文件\ncat > kube-controller-manager-csr.json << EOF\n{\n  \"CN\": \"system:kube-controller-manager\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"BeiJing\", \n      \"ST\": \"BeiJing\",\n      \"O\": \"system:masters\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kubeconfig文件 -->\n\n```bash\nKUBE_CONFIG=\"/opt/kubernetes/cfg/kube-controller-manager.kubeconfig\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\"\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials kube-controller-manager \\\n  --client-certificate=./kube-controller-manager.pem \\\n  --client-key=./kube-controller-manager-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-controller-manager \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kube-controller-manager.service << EOF\n[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf\nExecStart=/opt/kubernetes/bin/kube-controller-manager \\$KUBE_CONTROLLER_MANAGER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kube-controller-manager\n\n```bash\nsystemctl daemon-reload\nsystemctl start kube-controller-manager\nsystemctl enable kube-controller-manager\n```\n\n\n\n## 部署kube-scheduler\n\n{% tabs comments %}\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-scheduler.conf << EOF\nKUBE_SCHEDULER_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--leader-elect \\\\\n--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\\\\n--bind-address=127.0.0.1\"\nEOF\n```\n\n- --kubeconfig：连接apiserver配置文件\n- --leader-elect：当该组件启动多个时，自动选举（HA）\n\n<!-- endtab -->\n\n<!-- tab 创建证书 -->\n\n```bash\ncd ~/TLS/k8s\n\n# 创建证书请求文件\ncat > kube-scheduler-csr.json << EOF\n{\n  \"CN\": \"system:kube-scheduler\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"BeiJing\",\n      \"ST\": \"BeiJing\",\n      \"O\": \"system:masters\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kubeconfig文件 -->\n\n```bash\nKUBE_CONFIG=\"/opt/kubernetes/cfg/kube-scheduler.kubeconfig\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\"\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials kube-scheduler \\\n  --client-certificate=./kube-scheduler.pem \\\n  --client-key=./kube-scheduler-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-scheduler \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kube-scheduler.service << EOF\n[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf\nExecStart=/opt/kubernetes/bin/kube-scheduler \\$KUBE_SCHEDULER_OPTS\nRestart=on-failure\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kube-scheduler\n\n```bash\nsystemctl daemon-reload\nsystemctl start kube-scheduler\nsystemctl enable kube-scheduler\n```\n\n\n\n## 创建kubectl证书文件连接集群\n\n```bash\n# 生成证书\ncat > admin-csr.json <<EOF\n{\n  \"CN\": \"admin\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"BeiJing\",\n      \"ST\": \"BeiJing\",\n      \"O\": \"system:masters\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF\n\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin\n\n# 生成kubeconfig\nmkdir /root/.kube\n\nKUBE_CONFIG=\"/root/.kube/config\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\"\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials cluster-admin \\\n  --client-certificate=./admin.pem \\\n  --client-key=./admin-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=cluster-admin \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n\n\n## 查看集群状态\n\n```bash\nkubectl get cs\nNAME                STATUS    MESSAGE             ERROR\nscheduler             Healthy   ok                  \ncontroller-manager       Healthy   ok                  \netcd-2               Healthy   {\"health\":\"true\"}   \netcd-1               Healthy   {\"health\":\"true\"}   \netcd-0               Healthy   {\"health\":\"true\"}  \n```\n\n{% note info 'fas fa-bullhorn' %}\n\n都是`health`表示集群现在是健康状态\n\n{% endnote %}\n\n\n\n## 授权kubelet-bootstrap用户允许请求证书\n\n```bash\nkubectl create clusterrolebinding kubelet-bootstrap \\\n--clusterrole=system:node-bootstrapper \\\n--user=kubelet-bootstrap\n```\n\n\n\n<br>\n\n\n\n# 部署node节点\n\n## 创建工作目录并拷贝二进制文件\n\n```bash\nmkdir -p /opt/kubernetes/{bin,cfg,ssl,logs} \ncd kubernetes/server/bin\ncp kubelet kube-proxy /opt/kubernetes/bin  \n```\n\n\n\n\n\n## 部署kubelet\n\n{% tabs comments %}\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kubelet.conf << EOF\nKUBELET_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--hostname-override=k8s-master1 \\\\\n--network-plugin=cni \\\\\n--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\\\\n--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\\\\n--config=/opt/kubernetes/cfg/kubelet-config.yml \\\\\n--cert-dir=/opt/kubernetes/ssl \\\\\n--pod-infra-container-image=lizhenliang/pause-amd64:3.0\"\nEOF\n```\n\n- --hostname-override：显示名称，集群中唯一\n- --network-plugin：启用CNI\n- --kubeconfig：空路径，会自动生成，后面用于连接apiserver\n- --bootstrap-kubeconfig：首次启动向apiserver申请证书\n- --config：配置参数文件\n- --cert-dir：kubelet证书生成目录\n- --pod-infra-container-image：管理Pod网络容器的镜像\n\n<!-- endtab -->\n\n<!-- tab 创建配置参数文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kubelet-config.yml << EOF\nkind: KubeletConfiguration\napiVersion: kubelet.config.k8s.io/v1beta1\naddress: 0.0.0.0\nport: 10250\nreadOnlyPort: 10255\ncgroupDriver: cgroupfs\nclusterDNS:\n- 10.0.0.2\nclusterDomain: cluster.local \nfailSwapOn: false\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    cacheTTL: 2m0s\n    enabled: true\n  x509:\n    clientCAFile: /opt/kubernetes/ssl/ca.pem \nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\nevictionHard:\n  imagefs.available: 15%\n  memory.available: 100Mi\n  nodefs.available: 10%\n  nodefs.inodesFree: 5%\nmaxOpenFiles: 1000000\nmaxPods: 110\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kubeconfig文件 -->\n\n```bash\nKUBE_CONFIG=\"/opt/kubernetes/cfg/bootstrap.kubeconfig\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\" # apiserver IP:PORT\nTOKEN=\"c47ffb939f5ca36231d9e3121a252940\" # 与token.csv里保持一致\n\n# 生成 kubelet bootstrap kubeconfig 配置文件\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials \"kubelet-bootstrap\" \\\n  --token=${TOKEN} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=\"kubelet-bootstrap\" \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kubelet.service << EOF\n[Unit]\nDescription=Kubernetes Kubelet\nAfter=docker.service\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kubelet.conf\nExecStart=/opt/kubernetes/bin/kubelet \\$KUBELET_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kubelet\n\n```bash\nsystemctl daemon-reload\nsystemctl start kubelet\nsystemctl enable kubelet\n```\n\n\n\n## 审批kubelet证书申请并加入集群\n\n```bash\n# 查看kubelet证书请求\nkubectl get csr\nNAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION\nnode-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A   6m3s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending\n\n# 批准申请\nkubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A\n\n# 查看节点\nkubectl get node\nNAME         STATUS     ROLES    AGE   VERSION\nk8s-master1   NotReady   <none>   7s    v1.18.3\n```\n\n{% note info 'fas fa-bullhorn' %}\n\n由于网络插件还没有部署，节点会没有准备就绪 NotReady\n\n{% endnote %}\n\n\n\n## 部署kube-proxy\n\n{% tabs comments %}\n\n<!-- tab 创建配置文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-proxy.conf << EOF\nKUBE_PROXY_OPTS=\"--logtostderr=false \\\\\n--v=2 \\\\\n--log-dir=/opt/kubernetes/logs \\\\\n--config=/opt/kubernetes/cfg/kube-proxy-config.yml\"\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 创建配置参数文件 -->\n\n```bash\ncat > /opt/kubernetes/cfg/kube-proxy-config.yml << EOF\nkind: KubeProxyConfiguration\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0\nmetricsBindAddress: 0.0.0.0:10249\nclientConnection:\n  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig\nhostnameOverride: k8s-master1\nclusterCIDR: 10.0.0.0/24\nEOF\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kube-proxy证书 -->\n\n```bash\ncd ~/TLS/k8s\n\n# 创建证书请求文件\ncat > kube-proxy-csr.json << EOF\n{\n  \"CN\": \"system:kube-proxy\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"L\": \"BeiJing\",\n      \"ST\": \"BeiJing\",\n      \"O\": \"k8s\",\n      \"OU\": \"System\"\n    }\n  ]\n}\nEOF\n\n# 生成证书\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy\n```\n\n<!-- endtab -->\n\n<!-- tab 创建kubeconfig文件 -->\n\n```bash\nKUBE_CONFIG=\"/opt/kubernetes/cfg/kube-proxy.kubeconfig\"\nKUBE_APISERVER=\"https://192.168.31.71:6443\"\n\nkubectl config set-cluster kubernetes \\\n  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\\n  --embed-certs=true \\\n  --server=${KUBE_APISERVER} \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-credentials kube-proxy \\\n  --client-certificate=./kube-proxy.pem \\\n  --client-key=./kube-proxy-key.pem \\\n  --embed-certs=true \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config set-context default \\\n  --cluster=kubernetes \\\n  --user=kube-proxy \\\n  --kubeconfig=${KUBE_CONFIG}\n\nkubectl config use-context default --kubeconfig=${KUBE_CONFIG}\n```\n\n<!-- endtab -->\n\n<!-- tab 创建启动文件 -->\n\n```bash\ncat > /usr/lib/systemd/system/kube-proxy.service << EOF\n[Unit]\nDescription=Kubernetes Proxy\nAfter=network.target\n\n[Service]\nEnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf\nExecStart=/opt/kubernetes/bin/kube-proxy \\$KUBE_PROXY_OPTS\nRestart=on-failure\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 启动kube-proxy\n\n```bash\nsystemctl daemon-reload\nsystemctl start kube-proxy\nsystemctl enable kube-proxy\n```\n\n\n\n<br>\n\n\n\n## 部署网络插件callico\n\n```bash\nkubectl apply -f calico.yaml\nkubectl get pods -n kube-system\n```\n\n\n\n## 检查集群pod状态\n\n```bash\nkubectl get node\nNAME         STATUS   ROLES    AGE   VERSION\nk8s-master   Ready    <none>   37m   v1.20.4\n```\n\n\n\n## 授权apiserver访问kubelet\n\n```bash\ncat > apiserver-to-kubelet-rbac.yaml << EOF\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:kube-apiserver-to-kubelet\nrules:\n  - apiGroups:\n      - \"\"\n    resources:\n      - nodes/proxy\n      - nodes/stats\n      - nodes/log\n      - nodes/spec\n      - nodes/metrics\n      - pods/log\n    verbs:\n      - \"*\"\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: system:kube-apiserver\n  namespace: \"\"\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:kube-apiserver-to-kubelet\nsubjects:\n  - apiGroup: rbac.authorization.k8s.io\n    kind: User\n    name: kubernetes\nEOF\n\nkubectl apply -f apiserver-to-kubelet-rbac.yaml\n```\n\n\n\n## node节点扩容\n\n```bash\n# 拷贝相关文件\nscp -r /opt/kubernetes root@192.168.31.72:/opt/\n\nscp -r /usr/lib/systemd/system/{kubelet,kube-proxy}.service root@192.168.31.72:/usr/lib/systemd/system\n\nscp /opt/kubernetes/ssl/ca.pem root@192.168.31.72:/opt/kubernetes/ssl\n\n# 在node节点上删除kubeconfig文件\nrm -f /opt/kubernetes/cfg/kubelet.kubeconfig \nrm -f /opt/kubernetes/ssl/kubelet*\n\n# 修改kubelet配置文件\nvi /opt/kubernetes/cfg/kubelet.conf\n--hostname-override=k8s-node1 ## 修改这一项\n\nvi /opt/kubernetes/cfg/kube-proxy-config.yml\nhostnameOverride: k8s-node1  ## 修改这一项\n\n\n# 启动\nsystemctl daemon-reload\nsystemctl start kubelet kube-proxy\nsystemctl enable kubelet kube-proxy\nsystemctl start kubelet kubelet\nsystemctl enable kubelet kubelet\n\n# 在master上批准请求\n# 查看证书请求\nkubectl get csr\nNAME           AGE   SIGNERNAME                    REQUESTOR           CONDITION\nnode-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro   89s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending\n\n# 授权请求\nkubectl certificate approve node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro\n\n# 查看node状态\nkubectl get node\nNAME       STATUS   ROLES    AGE     VERSION\nk8s-master1   Ready    <none>   47m     v1.20.4\nk8s-node1    Ready    <none>   6m49s   v1.20.4\n```\n\n\n\n<br>\n\n\n\n# 常用插件部署\n\n## 部署dashboard\n\n```bash\nkubectl apply -f kubernetes-dashboard.yaml\nkubectl get pods,svc -n kubernetes-dashboard\n\n# 创建serviceaccount\nkubectl create serviceaccount dashboard-admin -n kube-system\nkubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin\nkubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk '/dashboard-admin/{print $1}')\n```\n\n\n\n上一步将输出一个token，访问：https://NodeIP:30001，输入token即可进入页面\n\n\n\n## 部署coredns\n\n```bash\nkubectl apply -f coredns.yaml \n \nkubectl get pods -n kube-system  \nNAME                          READY   STATUS    RESTARTS   AGE \ncoredns-5ffbfd976d-j6shb      1/1     Running   0          32s\n\n# 测试解析\nkubectl run -it --rm dns-test --image=busybox:1.28.4 sh \nIf you don't see a command prompt, try pressing enter. \n \n/ # nslookup kubernetes \nServer:    10.0.0.2 \nAddress 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local \n \nName:      kubernetes \nAddress 1: 10.0.0.1 kubernetes.default.svc.cluster.local\n\n```\n\n","slug":"二进制方式部署kubernetes-1-20","published":1,"updated":"2021-04-11T05:01:08.893Z","_id":"ckncle8ll00001akl2f04ggp0","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用二进制方式安装kubernetes 1.20版本集群</p><p>更新于 2021-04-11</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"集群规划\"><a href=\"#集群规划\" class=\"headerlink\" title=\"集群规划\"></a>集群规划</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">部署流程</button></li><li class=\"tab\"><button data-href=\"#comments-2\">服务器规划</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>先部署一个单master节点的k8s集群，然后再扩展集群为多master节点实现高可用；</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><table>\n<thead>\n<tr>\n<th>角色</th>\n<th>IP</th>\n<th>组件</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>k8s-master</td>\n<td>192.168.31.71</td>\n<td>kube-apiserver，kube-controller-manager，kube-scheduler，etcd</td>\n</tr>\n<tr>\n<td>k8s-node1</td>\n<td>192.168.31.72</td>\n<td>kubelet，kube-proxy，docker，etcd</td>\n</tr>\n<tr>\n<td>k8s-node2</td>\n<td>192.168.31.73</td>\n<td>kubelet，kube-proxy，docker，etcd</td>\n</tr>\n</tbody></table><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"初始化配置\"><a href=\"#初始化配置\" class=\"headerlink\" title=\"初始化配置\"></a>初始化配置</h1><p><strong>下面的初始化操作在所有服务器上进行</strong></p>\n<div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">关闭防火墙</button></li><li class=\"tab\"><button data-href=\"#comments-2\">关闭selinux和swap</button></li><li class=\"tab\"><button data-href=\"#comments-3\">添加host</button></li><li class=\"tab\"><button data-href=\"#comments-4\">内核参数设置</button></li><li class=\"tab\"><button data-href=\"#comments-5\">时间同步</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld </span><br><span class=\"line\">systemctl <span class=\"built_in\">disable</span> firewalld </span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>生产环境其实建议按需按端口开放</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 关闭selinux </span></span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  </span><br><span class=\"line\">setenforce 0  </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># 关闭swap </span></span><br><span class=\"line\">swapoff -a </span><br><span class=\"line\">sed -ri <span class=\"string\">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab   </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt; /etc/hosts &lt;&lt; <span class=\"string\">EOF </span></span><br><span class=\"line\"><span class=\"string\">192.168.31.71 k8s-master1 </span></span><br><span class=\"line\"><span class=\"string\">192.168.31.72 k8s-node1 </span></span><br><span class=\"line\"><span class=\"string\">192.168.31.73 k8s-node2 </span></span><br><span class=\"line\"><span class=\"string\">EOF</span> </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class=\"string\">EOF </span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-ip6tables = 1 </span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-iptables = 1 </span></span><br><span class=\"line\"><span class=\"string\">EOF</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生效配置</span></span><br><span class=\"line\">sysctl --system  </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-5\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y  ntpdate </span><br><span class=\"line\">ntpdate time.windows.com</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署etcd\"><a href=\"#部署etcd\" class=\"headerlink\" title=\"部署etcd\"></a>部署etcd</h1><div class=\"note info fas fa-bullhorn\">\n            <p>根据规划，我们将在三个节点上部署服务，形成一个etcd集群</p>\n          </div>\n\n\n\n<h2 id=\"创建证书\"><a href=\"#创建证书\" class=\"headerlink\" title=\"创建证书\"></a>创建证书</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装cfssl</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建CA</button></li><li class=\"tab\"><button data-href=\"#comments-3\">签发etcd证书</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>安装cfssl用于生成证书文件，这里我在master节点上进行安装</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class=\"line\">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class=\"line\">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class=\"line\">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class=\"line\">mv cfssl_linux-amd64 /usr/<span class=\"built_in\">local</span>/bin/cfssl</span><br><span class=\"line\">mv cfssljson_linux-amd64 /usr/<span class=\"built_in\">local</span>/bin/cfssljson</span><br><span class=\"line\">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建证书目录</span></span><br><span class=\"line\">mkdir -p ~/TLS/&#123;etcd,k8s&#125;</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/etcd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 自签CA</span></span><br><span class=\"line\">cat &gt; ca-config.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;signing&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;default&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;expiry&quot;: &quot;87600h&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;profiles&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;www&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">         &quot;expiry&quot;: &quot;87600h&quot;,</span></span><br><span class=\"line\"><span class=\"string\">         &quot;usages&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">            &quot;signing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;key encipherment&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;server auth&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;client auth&quot;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; ca-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;CN&quot;: &quot;etcd CA&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;L&quot;: &quot;Beijing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;ST&quot;: &quot;Beijing&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure>\n\n\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>执行完成后会生成<code>ca.pem</code>和<code>ca-key.pem</code>文件</p>\n          </div><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建申请文件</span></span><br><span class=\"line\">cat &gt; server-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;CN&quot;: &quot;etcd&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;hosts&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &quot;192.168.31.71&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;192.168.31.72&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;192.168.31.73&quot;</span></span><br><span class=\"line\"><span class=\"string\">    ],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;ST&quot;: &quot;BeiJing&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>执行完成后会生成<code>server.pem</code>和<code>server-key.pem</code>文件</p>\n          </div><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"部署etcd集群\"><a href=\"#部署etcd集群\" class=\"headerlink\" title=\"部署etcd集群\"></a>部署etcd集群</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建服务启动文件</button></li><li class=\"tab\"><button data-href=\"#comments-4\">拷贝证书</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建工作目录</span></span><br><span class=\"line\">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p</span><br><span class=\"line\">tar zxvf etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class=\"line\">mv etcd-v3.4.9-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">#[Member]</span></span><br><span class=\"line\"><span class=\"string\">ETCD_NAME=&quot;etcd-1&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.31.71:2380&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.31.71:2379&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#[Clustering]</span></span><br><span class=\"line\"><span class=\"string\">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.31.71:2380&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.31.71:2379&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>ETCD_NAME：节点名称，集群中唯一</li>\n<li>ETCD_DATA_DIR：数据目录</li>\n<li>ETCD_LISTEN_PEER_URLS：集群通信监听地址</li>\n<li>ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址</li>\n<li>ETCD_INITIAL_ADVERTISE_PEERURLS：集群通告地址</li>\n<li>ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址</li>\n<li>ETCD_INITIAL_CLUSTER：集群节点地址</li>\n<li>ETCD_INITIALCLUSTER_TOKEN：集群Token</li>\n<li>ETCD_INITIALCLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Etcd Server</span></span><br><span class=\"line\"><span class=\"string\">After=network.target</span></span><br><span class=\"line\"><span class=\"string\">After=network-online.target</span></span><br><span class=\"line\"><span class=\"string\">Wants=network-online.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">Type=notify</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/etcd/bin/etcd \\</span></span><br><span class=\"line\"><span class=\"string\">--cert-file=/opt/etcd/ssl/server.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--key-file=/opt/etcd/ssl/server-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--peer-cert-file=/opt/etcd/ssl/server.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--peer-key-file=/opt/etcd/ssl/server-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--trusted-ca-file=/opt/etcd/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--logger=zap</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\">LimitNOFILE=65536</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动集群\"><a href=\"#启动集群\" class=\"headerlink\" title=\"启动集群\"></a>启动集群</h2><p>首先启动第一个节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start etcd</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> etcd</span><br></pre></td></tr></table></figure>\n\n\n\n<p>将上一步中的文件都拷贝到其他节点上：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">scp -r /opt/etcd/ root@192.168.31.72:/opt/</span><br><span class=\"line\">scp /usr/lib/systemd/system/etcd.service root@192.168.31.72:/usr/lib/systemd/system/</span><br><span class=\"line\">scp -r /opt/etcd/ root@192.168.31.73:/opt/</span><br><span class=\"line\">scp /usr/lib/systemd/system/etcd.service root@192.168.31.73:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>\n\n\n\n<p>注意，拷贝过去后需要修改一下配置文件的内容，将IP和节点名称修改为当前所在服务器的地址：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /opt/etcd/cfg/etcd.conf</span><br><span class=\"line\"><span class=\"comment\">#[Member]</span></span><br><span class=\"line\">ETCD_NAME=<span class=\"string\">&quot;etcd-1&quot;</span>   <span class=\"comment\"># 修改此处，节点2改为etcd-2，节点3改为etcd-3</span></span><br><span class=\"line\">ETCD_DATA_DIR=<span class=\"string\">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_PEER_URLS=<span class=\"string\">&quot;https://192.168.31.71:2380&quot;</span>   <span class=\"comment\"># 修改此处为当前服务器IP</span></span><br><span class=\"line\">ETCD_LISTEN_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.31.71:2379&quot;</span> <span class=\"comment\"># 修改此处为当前服务器IP</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#[Clustering]</span></span><br><span class=\"line\">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class=\"string\">&quot;https://192.168.31.71:2380&quot;</span> <span class=\"comment\"># 修改此处为当前服务器IP</span></span><br><span class=\"line\">ETCD_ADVERTISE_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.31.71:2379&quot;</span> <span class=\"comment\"># 修改此处为当前服务器IP</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER=<span class=\"string\">&quot;etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_TOKEN=<span class=\"string\">&quot;etcd-cluster&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_STATE=<span class=\"string\">&quot;new&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后在启动剩下的两个节点，步骤同上。</p>\n<h2 id=\"查看集群状态\"><a href=\"#查看集群状态\" class=\"headerlink\" title=\"查看集群状态\"></a>查看集群状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=<span class=\"string\">&quot;https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.31.73:2379&quot;</span> endpoint health --write-out=table</span><br><span class=\"line\"></span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">|          ENDPOINT    | HEALTH |    TOOK     | ERROR |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">| https://192.168.31.71:2379 |   <span class=\"literal\">true</span> | 10.301506ms |    |</span><br><span class=\"line\">| https://192.168.31.73:2379 |   <span class=\"literal\">true</span> | 12.87467ms |     |</span><br><span class=\"line\">| https://192.168.31.72:2379 |   <span class=\"literal\">true</span> | 13.225954ms |    |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<div class=\"note success fas fa-bullhorn\">\n            <p>可以看到集群是正常的，部署成功</p>\n          </div>\n\n\n\n<br>\n\n\n\n<h1 id=\"安装docker\"><a href=\"#安装docker\" class=\"headerlink\" title=\"安装docker\"></a>安装docker</h1><div class=\"note info fas fa-bullhorn\">\n            <p>在所有的节点都安装docker，也可以换成其他的容器引擎如containerd</p>\n          </div>\n\n\n\n<h2 id=\"下载安装\"><a href=\"#下载安装\" class=\"headerlink\" title=\"下载安装\"></a>下载安装</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz</span><br><span class=\"line\">tar zxvf docker-19.03.9.tgz</span><br><span class=\"line\">mv docker/* /usr/bin</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建服务启动文件\"><a href=\"#创建服务启动文件\" class=\"headerlink\" title=\"创建服务启动文件\"></a>创建服务启动文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Docker Application Container Engine</span></span><br><span class=\"line\"><span class=\"string\">Documentation=https://docs.docker.com</span></span><br><span class=\"line\"><span class=\"string\">After=network-online.target firewalld.service</span></span><br><span class=\"line\"><span class=\"string\">Wants=network-online.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">Type=notify</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/usr/bin/dockerd</span></span><br><span class=\"line\"><span class=\"string\">ExecReload=/bin/kill -s HUP $MAINPID</span></span><br><span class=\"line\"><span class=\"string\">LimitNOFILE=infinity</span></span><br><span class=\"line\"><span class=\"string\">LimitNPROC=infinity</span></span><br><span class=\"line\"><span class=\"string\">LimitCORE=infinity</span></span><br><span class=\"line\"><span class=\"string\">TimeoutStartSec=0</span></span><br><span class=\"line\"><span class=\"string\">Delegate=yes</span></span><br><span class=\"line\"><span class=\"string\">KillMode=process</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\">StartLimitBurst=3</span></span><br><span class=\"line\"><span class=\"string\">StartLimitInterval=60s</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建配置文件\"><a href=\"#创建配置文件\" class=\"headerlink\" title=\"创建配置文件\"></a>创建配置文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /etc/docker</span><br><span class=\"line\">cat &gt; /etc/docker/daemon.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>这里使用了阿里云镜像加速器</p>\n          </div>\n\n\n\n\n\n<h2 id=\"启动服务\"><a href=\"#启动服务\" class=\"headerlink\" title=\"启动服务\"></a>启动服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start docker</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> docker</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<br>\n\n\n\n<h1 id=\"部署master节点\"><a href=\"#部署master节点\" class=\"headerlink\" title=\"部署master节点\"></a>部署master节点</h1><h2 id=\"生成kube-apiserver证书\"><a href=\"#生成kube-apiserver证书\" class=\"headerlink\" title=\"生成kube-apiserver证书\"></a>生成kube-apiserver证书</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">自签CA</button></li><li class=\"tab\"><button data-href=\"#comments-2\">生成证书</button></li><li class=\"tab\"><button data-href=\"#comments-3\">签发kube-apiserver证书</button></li><li class=\"tab\"><button data-href=\"#comments-4\">生成证书</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/k8s</span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; ca-config.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;signing&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;default&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;expiry&quot;: &quot;87600h&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;profiles&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">         &quot;expiry&quot;: &quot;87600h&quot;,</span></span><br><span class=\"line\"><span class=\"string\">         &quot;usages&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">            &quot;signing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;key encipherment&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;server auth&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;client auth&quot;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">cat &gt; ca-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;L&quot;: &quot;Beijing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;ST&quot;: &quot;Beijing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>会生成<code>ca.pem</code>和<code>ca-key.pem</code>文件。</p>\n          </div><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; server-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;hosts&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">      &quot;10.0.0.1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;127.0.0.1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;192.168.31.71&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;192.168.31.72&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;192.168.31.73&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;192.168.31.88&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes.default&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes.default.svc&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes.default.svc.cluster&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class=\"line\"><span class=\"string\">    ],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>文件hosts字段中IP为所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP</p>\n          </div><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"安装kube-apiserver\"><a href=\"#安装kube-apiserver\" class=\"headerlink\" title=\"安装kube-apiserver\"></a>安装kube-apiserver</h2><p><strong><a href=\"https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md，在这里下载1.20版本的安装包，下载server包就够了，包含了Master和Worker\">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md，在这里下载1.20版本的安装包，下载server包就够了，包含了Master和Worker</a> Node二进制文件。</strong></p>\n<div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建TLS Token</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125; </span><br><span class=\"line\">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> kubernetes/server/bin</span><br><span class=\"line\">cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin</span><br><span class=\"line\">cp kubectl /usr/bin/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 拷贝证书</span></span><br><span class=\"line\">cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--etcd-servers=https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.31.73:2379 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--bind-address=192.168.31.71 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--secure-port=6443 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--advertise-address=192.168.31.71 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--allow-privileged=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-cluster-ip-range=10.0.0.0/24 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\\\</span></span><br><span class=\"line\"><span class=\"string\">--authorization-mode=RBAC,Node \\\\</span></span><br><span class=\"line\"><span class=\"string\">--enable-bootstrap-token-auth=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--token-auth-file=/opt/kubernetes/cfg/token.csv \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-node-port-range=30000-32767 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\\\</span></span><br><span class=\"line\"><span class=\"string\">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-account-issuer=api \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--etcd-cafile=/opt/etcd/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--etcd-certfile=/opt/etcd/ssl/server.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-allowed-names=kubernetes \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-extra-headers-prefix=X-Remote-Extra- \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-group-headers=X-Remote-Group \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-username-headers=X-Remote-User \\\\</span></span><br><span class=\"line\"><span class=\"string\">--enable-aggregator-routing=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--audit-log-maxage=30 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--audit-log-maxbackup=3 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--audit-log-maxsize=100 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>–logtostderr：启用日志</li>\n<li>—v：日志等级</li>\n<li>–log-dir：日志目录</li>\n<li>–etcd-servers：etcd集群地址</li>\n<li>–bind-address：监听地址</li>\n<li>–secure-port：https安全端口</li>\n<li>–advertise-address：集群通告地址</li>\n<li>–allow-privileged：启用授权</li>\n<li>–service-cluster-ip-range：Service虚拟IP地址段</li>\n<li>–enable-admission-plugins：准入控制模块</li>\n<li>–authorization-mode：认证授权，启用RBAC授权和节点自管理</li>\n<li>–enable-bootstrap-token-auth：启用TLS bootstrap机制</li>\n<li>–token-auth-file：bootstrap token文件</li>\n<li>–service-node-port-range：Service nodeport类型默认分配端口范围</li>\n<li>–kubelet-client-xxx：apiserver访问kubelet客户端证书</li>\n<li>–tls-xxx-file：apiserver https证书</li>\n<li>–etcd-xxxfile：连接Etcd集群证书</li>\n<li>–audit-log-xxx：审计日志</li>\n</ul>\n<p>1.20版本必须加的参数：</p>\n<ul>\n<li>–service-account-issuer</li>\n<li>–service-account-signing-key-file</li>\n</ul>\n<p>启动聚合层相关配置：</p>\n<ul>\n<li>–requestheader-client-ca-file</li>\n<li>–proxy-client-cert-file</li>\n<li>–proxy-client-key-file</li>\n<li>–requestheader-allowed-names</li>\n<li>–requestheader-extra-headers-prefix</li>\n<li>–requestheader-group-headers</li>\n<li>–requestheader-username-headers</li>\n<li>–enable-aggregator-routing</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 生成一个token</span></span><br><span class=\"line\">head -c 16 /dev/urandom | od -An -t x | tr -d <span class=\"string\">&#x27; &#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件</span></span><br><span class=\"line\">cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes API Server</span></span><br><span class=\"line\"><span class=\"string\">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kube-apiserver \\$KUBE_APISERVER_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kube-apiserver\"><a href=\"#启动kube-apiserver\" class=\"headerlink\" title=\"启动kube-apiserver\"></a>启动kube-apiserver</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kube-apiserver </span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kube-apiserver</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"部署kube-controller-manager\"><a href=\"#部署kube-controller-manager\" class=\"headerlink\" title=\"部署kube-controller-manager\"></a>部署kube-controller-manager</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建证书</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建kubeconfig文件</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--leader-elect=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\\\</span></span><br><span class=\"line\"><span class=\"string\">--bind-address=127.0.0.1 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--allocate-node-cidrs=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cluster-cidr=10.244.0.0/16 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-cluster-ip-range=10.0.0.0/24 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\\\</span></span><br><span class=\"line\"><span class=\"string\">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cluster-signing-duration=87600h0m0s&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>–kubeconfig：连接apiserver配置文件</li>\n<li>–leader-elect：当该组件启动多个时，自动选举（HA）</li>\n<li>–cluster-signing-cert-file/–cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/k8s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建证书请求文件</span></span><br><span class=\"line\">cat &gt; kube-controller-manager-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;hosts&quot;: [],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;L&quot;: &quot;BeiJing&quot;, </span></span><br><span class=\"line\"><span class=\"string\">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials kube-controller-manager \\</span><br><span class=\"line\">  --client-certificate=./kube-controller-manager.pem \\</span><br><span class=\"line\">  --client-key=./kube-controller-manager-key.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=kube-controller-manager \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes Controller Manager</span></span><br><span class=\"line\"><span class=\"string\">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kube-controller-manager \\$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kube-controller-manager\"><a href=\"#启动kube-controller-manager\" class=\"headerlink\" title=\"启动kube-controller-manager\"></a>启动kube-controller-manager</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kube-controller-manager</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kube-controller-manager</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"部署kube-scheduler\"><a href=\"#部署kube-scheduler\" class=\"headerlink\" title=\"部署kube-scheduler\"></a>部署kube-scheduler</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建证书</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建kubeconfig文件</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--leader-elect \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\\\</span></span><br><span class=\"line\"><span class=\"string\">--bind-address=127.0.0.1&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>–kubeconfig：连接apiserver配置文件</li>\n<li>–leader-elect：当该组件启动多个时，自动选举（HA）</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/k8s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建证书请求文件</span></span><br><span class=\"line\">cat &gt; kube-scheduler-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;hosts&quot;: [],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials kube-scheduler \\</span><br><span class=\"line\">  --client-certificate=./kube-scheduler.pem \\</span><br><span class=\"line\">  --client-key=./kube-scheduler-key.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=kube-scheduler \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes Scheduler</span></span><br><span class=\"line\"><span class=\"string\">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kube-scheduler \\$KUBE_SCHEDULER_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kube-scheduler\"><a href=\"#启动kube-scheduler\" class=\"headerlink\" title=\"启动kube-scheduler\"></a>启动kube-scheduler</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kube-scheduler</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kube-scheduler</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建kubectl证书文件连接集群\"><a href=\"#创建kubectl证书文件连接集群\" class=\"headerlink\" title=\"创建kubectl证书文件连接集群\"></a>创建kubectl证书文件连接集群</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cat &gt; admin-csr.json &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;CN&quot;: &quot;admin&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;hosts&quot;: [],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成kubeconfig</span></span><br><span class=\"line\">mkdir /root/.kube</span><br><span class=\"line\"></span><br><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/root/.kube/config&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials cluster-admin \\</span><br><span class=\"line\">  --client-certificate=./admin.pem \\</span><br><span class=\"line\">  --client-key=./admin-key.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=cluster-admin \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看集群状态-1\"><a href=\"#查看集群状态-1\" class=\"headerlink\" title=\"查看集群状态\"></a>查看集群状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get cs</span><br><span class=\"line\">NAME                STATUS    MESSAGE             ERROR</span><br><span class=\"line\">scheduler             Healthy   ok                  </span><br><span class=\"line\">controller-manager       Healthy   ok                  </span><br><span class=\"line\">etcd-2               Healthy   &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>&#125;   </span><br><span class=\"line\">etcd-1               Healthy   &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>&#125;   </span><br><span class=\"line\">etcd-0               Healthy   &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>&#125;  </span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>都是<code>health</code>表示集群现在是健康状态</p>\n          </div>\n\n\n\n<h2 id=\"授权kubelet-bootstrap用户允许请求证书\"><a href=\"#授权kubelet-bootstrap用户允许请求证书\" class=\"headerlink\" title=\"授权kubelet-bootstrap用户允许请求证书\"></a>授权kubelet-bootstrap用户允许请求证书</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create clusterrolebinding kubelet-bootstrap \\</span><br><span class=\"line\">--clusterrole=system:node-bootstrapper \\</span><br><span class=\"line\">--user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署node节点\"><a href=\"#部署node节点\" class=\"headerlink\" title=\"部署node节点\"></a>部署node节点</h1><h2 id=\"创建工作目录并拷贝二进制文件\"><a href=\"#创建工作目录并拷贝二进制文件\" class=\"headerlink\" title=\"创建工作目录并拷贝二进制文件\"></a>创建工作目录并拷贝二进制文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125; </span><br><span class=\"line\"><span class=\"built_in\">cd</span> kubernetes/server/bin</span><br><span class=\"line\">cp kubelet kube-proxy /opt/kubernetes/bin  </span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"部署kubelet\"><a href=\"#部署kubelet\" class=\"headerlink\" title=\"部署kubelet\"></a>部署kubelet</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置参数文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建kubeconfig文件</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBELET_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--hostname-override=k8s-master1 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--network-plugin=cni \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\\\</span></span><br><span class=\"line\"><span class=\"string\">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\\\</span></span><br><span class=\"line\"><span class=\"string\">--config=/opt/kubernetes/cfg/kubelet-config.yml \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cert-dir=/opt/kubernetes/ssl \\\\</span></span><br><span class=\"line\"><span class=\"string\">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>–hostname-override：显示名称，集群中唯一</li>\n<li>–network-plugin：启用CNI</li>\n<li>–kubeconfig：空路径，会自动生成，后面用于连接apiserver</li>\n<li>–bootstrap-kubeconfig：首次启动向apiserver申请证书</li>\n<li>–config：配置参数文件</li>\n<li>–cert-dir：kubelet证书生成目录</li>\n<li>–pod-infra-container-image：管理Pod网络容器的镜像</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeletConfiguration</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"string\">address: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">port: 10250</span></span><br><span class=\"line\"><span class=\"string\">readOnlyPort: 10255</span></span><br><span class=\"line\"><span class=\"string\">cgroupDriver: cgroupfs</span></span><br><span class=\"line\"><span class=\"string\">clusterDNS:</span></span><br><span class=\"line\"><span class=\"string\">- 10.0.0.2</span></span><br><span class=\"line\"><span class=\"string\">clusterDomain: cluster.local </span></span><br><span class=\"line\"><span class=\"string\">failSwapOn: false</span></span><br><span class=\"line\"><span class=\"string\">authentication:</span></span><br><span class=\"line\"><span class=\"string\">  anonymous:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: false</span></span><br><span class=\"line\"><span class=\"string\">  webhook:</span></span><br><span class=\"line\"><span class=\"string\">    cacheTTL: 2m0s</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  x509:</span></span><br><span class=\"line\"><span class=\"string\">    clientCAFile: /opt/kubernetes/ssl/ca.pem </span></span><br><span class=\"line\"><span class=\"string\">authorization:</span></span><br><span class=\"line\"><span class=\"string\">  mode: Webhook</span></span><br><span class=\"line\"><span class=\"string\">  webhook:</span></span><br><span class=\"line\"><span class=\"string\">    cacheAuthorizedTTL: 5m0s</span></span><br><span class=\"line\"><span class=\"string\">    cacheUnauthorizedTTL: 30s</span></span><br><span class=\"line\"><span class=\"string\">evictionHard:</span></span><br><span class=\"line\"><span class=\"string\">  imagefs.available: 15%</span></span><br><span class=\"line\"><span class=\"string\">  memory.available: 100Mi</span></span><br><span class=\"line\"><span class=\"string\">  nodefs.available: 10%</span></span><br><span class=\"line\"><span class=\"string\">  nodefs.inodesFree: 5%</span></span><br><span class=\"line\"><span class=\"string\">maxOpenFiles: 1000000</span></span><br><span class=\"line\"><span class=\"string\">maxPods: 110</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/opt/kubernetes/cfg/bootstrap.kubeconfig&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span> <span class=\"comment\"># apiserver IP:PORT</span></span><br><span class=\"line\">TOKEN=<span class=\"string\">&quot;c47ffb939f5ca36231d9e3121a252940&quot;</span> <span class=\"comment\"># 与token.csv里保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成 kubelet bootstrap kubeconfig 配置文件</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials <span class=\"string\">&quot;kubelet-bootstrap&quot;</span> \\</span><br><span class=\"line\">  --token=<span class=\"variable\">$&#123;TOKEN&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=<span class=\"string\">&quot;kubelet-bootstrap&quot;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes Kubelet</span></span><br><span class=\"line\"><span class=\"string\">After=docker.service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kubelet \\$KUBELET_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\">LimitNOFILE=65536</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kubelet\"><a href=\"#启动kubelet\" class=\"headerlink\" title=\"启动kubelet\"></a>启动kubelet</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kubelet</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"审批kubelet证书申请并加入集群\"><a href=\"#审批kubelet证书申请并加入集群\" class=\"headerlink\" title=\"审批kubelet证书申请并加入集群\"></a>审批kubelet证书申请并加入集群</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看kubelet证书请求</span></span><br><span class=\"line\">kubectl get csr</span><br><span class=\"line\">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class=\"line\">node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A   6m3s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 批准申请</span></span><br><span class=\"line\">kubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看节点</span></span><br><span class=\"line\">kubectl get node</span><br><span class=\"line\">NAME         STATUS     ROLES    AGE   VERSION</span><br><span class=\"line\">k8s-master1   NotReady   &lt;none&gt;   7s    v1.18.3</span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>由于网络插件还没有部署，节点会没有准备就绪 NotReady</p>\n          </div>\n\n\n\n<h2 id=\"部署kube-proxy\"><a href=\"#部署kube-proxy\" class=\"headerlink\" title=\"部署kube-proxy\"></a>部署kube-proxy</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置参数文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建kube-proxy证书</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建kubeconfig文件</button></li><li class=\"tab\"><button data-href=\"#comments-5\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBE_PROXY_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeProxyConfiguration</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"string\">bindAddress: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">metricsBindAddress: 0.0.0.0:10249</span></span><br><span class=\"line\"><span class=\"string\">clientConnection:</span></span><br><span class=\"line\"><span class=\"string\">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span></span><br><span class=\"line\"><span class=\"string\">hostnameOverride: k8s-master1</span></span><br><span class=\"line\"><span class=\"string\">clusterCIDR: 10.0.0.0/24</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/k8s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建证书请求文件</span></span><br><span class=\"line\">cat &gt; kube-proxy-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;hosts&quot;: [],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/opt/kubernetes/cfg/kube-proxy.kubeconfig&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials kube-proxy \\</span><br><span class=\"line\">  --client-certificate=./kube-proxy.pem \\</span><br><span class=\"line\">  --client-key=./kube-proxy-key.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=kube-proxy \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-5\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes Proxy</span></span><br><span class=\"line\"><span class=\"string\">After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kube-proxy \\$KUBE_PROXY_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\">LimitNOFILE=65536</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kube-proxy\"><a href=\"#启动kube-proxy\" class=\"headerlink\" title=\"启动kube-proxy\"></a>启动kube-proxy</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kube-proxy</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kube-proxy</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"部署网络插件callico\"><a href=\"#部署网络插件callico\" class=\"headerlink\" title=\"部署网络插件callico\"></a>部署网络插件callico</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f calico.yaml</span><br><span class=\"line\">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查集群pod状态\"><a href=\"#检查集群pod状态\" class=\"headerlink\" title=\"检查集群pod状态\"></a>检查集群pod状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node</span><br><span class=\"line\">NAME         STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">k8s-master   Ready    &lt;none&gt;   37m   v1.20.4</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"授权apiserver访问kubelet\"><a href=\"#授权apiserver访问kubelet\" class=\"headerlink\" title=\"授权apiserver访问kubelet\"></a>授权apiserver访问kubelet</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"string\">kind: ClusterRole</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  annotations:</span></span><br><span class=\"line\"><span class=\"string\">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    kubernetes.io/bootstrapping: rbac-defaults</span></span><br><span class=\"line\"><span class=\"string\">  name: system:kube-apiserver-to-kubelet</span></span><br><span class=\"line\"><span class=\"string\">rules:</span></span><br><span class=\"line\"><span class=\"string\">  - apiGroups:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    resources:</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/proxy</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/stats</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/log</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/spec</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/metrics</span></span><br><span class=\"line\"><span class=\"string\">      - pods/log</span></span><br><span class=\"line\"><span class=\"string\">    verbs:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;*&quot;</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"string\">kind: ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: system:kube-apiserver</span></span><br><span class=\"line\"><span class=\"string\">  namespace: &quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">roleRef:</span></span><br><span class=\"line\"><span class=\"string\">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"string\">  kind: ClusterRole</span></span><br><span class=\"line\"><span class=\"string\">  name: system:kube-apiserver-to-kubelet</span></span><br><span class=\"line\"><span class=\"string\">subjects:</span></span><br><span class=\"line\"><span class=\"string\">  - apiGroup: rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"string\">    kind: User</span></span><br><span class=\"line\"><span class=\"string\">    name: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"node节点扩容\"><a href=\"#node节点扩容\" class=\"headerlink\" title=\"node节点扩容\"></a>node节点扩容</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拷贝相关文件</span></span><br><span class=\"line\">scp -r /opt/kubernetes root@192.168.31.72:/opt/</span><br><span class=\"line\"></span><br><span class=\"line\">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.31.72:/usr/lib/systemd/system</span><br><span class=\"line\"></span><br><span class=\"line\">scp /opt/kubernetes/ssl/ca.pem root@192.168.31.72:/opt/kubernetes/ssl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在node节点上删除kubeconfig文件</span></span><br><span class=\"line\">rm -f /opt/kubernetes/cfg/kubelet.kubeconfig </span><br><span class=\"line\">rm -f /opt/kubernetes/ssl/kubelet*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改kubelet配置文件</span></span><br><span class=\"line\">vi /opt/kubernetes/cfg/kubelet.conf</span><br><span class=\"line\">--hostname-override=k8s-node1 <span class=\"comment\">## 修改这一项</span></span><br><span class=\"line\"></span><br><span class=\"line\">vi /opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class=\"line\">hostnameOverride: k8s-node1  <span class=\"comment\">## 修改这一项</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kubelet kube-proxy</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet kube-proxy</span><br><span class=\"line\">systemctl start kubelet kubelet</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet kubelet</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在master上批准请求</span></span><br><span class=\"line\"><span class=\"comment\"># 查看证书请求</span></span><br><span class=\"line\">kubectl get csr</span><br><span class=\"line\">NAME           AGE   SIGNERNAME                    REQUESTOR           CONDITION</span><br><span class=\"line\">node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro   89s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 授权请求</span></span><br><span class=\"line\">kubectl certificate approve node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看node状态</span></span><br><span class=\"line\">kubectl get node</span><br><span class=\"line\">NAME       STATUS   ROLES    AGE     VERSION</span><br><span class=\"line\">k8s-master1   Ready    &lt;none&gt;   47m     v1.20.4</span><br><span class=\"line\">k8s-node1    Ready    &lt;none&gt;   6m49s   v1.20.4</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"常用插件部署\"><a href=\"#常用插件部署\" class=\"headerlink\" title=\"常用插件部署\"></a>常用插件部署</h1><h2 id=\"部署dashboard\"><a href=\"#部署dashboard\" class=\"headerlink\" title=\"部署dashboard\"></a>部署dashboard</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kubernetes-dashboard.yaml</span><br><span class=\"line\">kubectl get pods,svc -n kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建serviceaccount</span></span><br><span class=\"line\">kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class=\"line\">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br><span class=\"line\">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk <span class=\"string\">&#x27;/dashboard-admin/&#123;print $1&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>上一步将输出一个token，访问：<a href=\"https://NodeIP:30001，输入token即可进入页面\">https://NodeIP:30001，输入token即可进入页面</a></p>\n<h2 id=\"部署coredns\"><a href=\"#部署coredns\" class=\"headerlink\" title=\"部署coredns\"></a>部署coredns</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f coredns.yaml </span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl get pods -n kube-system  </span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS   AGE </span><br><span class=\"line\">coredns-5ffbfd976d-j6shb      1/1     Running   0          32s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 测试解析</span></span><br><span class=\"line\">kubectl run -it --rm dns-test --image=busybox:1.28.4 sh </span><br><span class=\"line\">If you don<span class=\"string\">&#x27;t see a command prompt, try pressing enter. </span></span><br><span class=\"line\"><span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">/ # nslookup kubernetes </span></span><br><span class=\"line\"><span class=\"string\">Server:    10.0.0.2 </span></span><br><span class=\"line\"><span class=\"string\">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local </span></span><br><span class=\"line\"><span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">Name:      kubernetes </span></span><br><span class=\"line\"><span class=\"string\">Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用二进制方式安装kubernetes 1.20版本集群</p><p>更新于 2021-04-11</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"集群规划\"><a href=\"#集群规划\" class=\"headerlink\" title=\"集群规划\"></a>集群规划</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">部署流程</button></li><li class=\"tab\"><button data-href=\"#comments-2\">服务器规划</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>先部署一个单master节点的k8s集群，然后再扩展集群为多master节点实现高可用；</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><table>\n<thead>\n<tr>\n<th>角色</th>\n<th>IP</th>\n<th>组件</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>k8s-master</td>\n<td>192.168.31.71</td>\n<td>kube-apiserver，kube-controller-manager，kube-scheduler，etcd</td>\n</tr>\n<tr>\n<td>k8s-node1</td>\n<td>192.168.31.72</td>\n<td>kubelet，kube-proxy，docker，etcd</td>\n</tr>\n<tr>\n<td>k8s-node2</td>\n<td>192.168.31.73</td>\n<td>kubelet，kube-proxy，docker，etcd</td>\n</tr>\n</tbody></table><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"初始化配置\"><a href=\"#初始化配置\" class=\"headerlink\" title=\"初始化配置\"></a>初始化配置</h1><p><strong>下面的初始化操作在所有服务器上进行</strong></p>\n<div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">关闭防火墙</button></li><li class=\"tab\"><button data-href=\"#comments-2\">关闭selinux和swap</button></li><li class=\"tab\"><button data-href=\"#comments-3\">添加host</button></li><li class=\"tab\"><button data-href=\"#comments-4\">内核参数设置</button></li><li class=\"tab\"><button data-href=\"#comments-5\">时间同步</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld </span><br><span class=\"line\">systemctl <span class=\"built_in\">disable</span> firewalld </span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>生产环境其实建议按需按端口开放</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 关闭selinux </span></span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;s/enforcing/disabled/&#x27;</span> /etc/selinux/config  </span><br><span class=\"line\">setenforce 0  </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># 关闭swap </span></span><br><span class=\"line\">swapoff -a </span><br><span class=\"line\">sed -ri <span class=\"string\">&#x27;s/.*swap.*/#&amp;/&#x27;</span> /etc/fstab   </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt; /etc/hosts &lt;&lt; <span class=\"string\">EOF </span></span><br><span class=\"line\"><span class=\"string\">192.168.31.71 k8s-master1 </span></span><br><span class=\"line\"><span class=\"string\">192.168.31.72 k8s-node1 </span></span><br><span class=\"line\"><span class=\"string\">192.168.31.73 k8s-node2 </span></span><br><span class=\"line\"><span class=\"string\">EOF</span> </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/sysctl.d/k8s.conf &lt;&lt; <span class=\"string\">EOF </span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-ip6tables = 1 </span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-iptables = 1 </span></span><br><span class=\"line\"><span class=\"string\">EOF</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生效配置</span></span><br><span class=\"line\">sysctl --system  </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-5\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y  ntpdate </span><br><span class=\"line\">ntpdate time.windows.com</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署etcd\"><a href=\"#部署etcd\" class=\"headerlink\" title=\"部署etcd\"></a>部署etcd</h1><div class=\"note info fas fa-bullhorn\">\n            <p>根据规划，我们将在三个节点上部署服务，形成一个etcd集群</p>\n          </div>\n\n\n\n<h2 id=\"创建证书\"><a href=\"#创建证书\" class=\"headerlink\" title=\"创建证书\"></a>创建证书</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装cfssl</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建CA</button></li><li class=\"tab\"><button data-href=\"#comments-3\">签发etcd证书</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>安装cfssl用于生成证书文件，这里我在master节点上进行安装</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><br><span class=\"line\">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</span><br><span class=\"line\">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class=\"line\">chmod +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64</span><br><span class=\"line\">mv cfssl_linux-amd64 /usr/<span class=\"built_in\">local</span>/bin/cfssl</span><br><span class=\"line\">mv cfssljson_linux-amd64 /usr/<span class=\"built_in\">local</span>/bin/cfssljson</span><br><span class=\"line\">mv cfssl-certinfo_linux-amd64 /usr/bin/cfssl-certinfo </span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建证书目录</span></span><br><span class=\"line\">mkdir -p ~/TLS/&#123;etcd,k8s&#125;</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/etcd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 自签CA</span></span><br><span class=\"line\">cat &gt; ca-config.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;signing&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;default&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;expiry&quot;: &quot;87600h&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;profiles&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;www&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">         &quot;expiry&quot;: &quot;87600h&quot;,</span></span><br><span class=\"line\"><span class=\"string\">         &quot;usages&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">            &quot;signing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;key encipherment&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;server auth&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;client auth&quot;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; ca-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;CN&quot;: &quot;etcd CA&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;L&quot;: &quot;Beijing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;ST&quot;: &quot;Beijing&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure>\n\n\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>执行完成后会生成<code>ca.pem</code>和<code>ca-key.pem</code>文件</p>\n          </div><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建申请文件</span></span><br><span class=\"line\">cat &gt; server-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;CN&quot;: &quot;etcd&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;hosts&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &quot;192.168.31.71&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;192.168.31.72&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;192.168.31.73&quot;</span></span><br><span class=\"line\"><span class=\"string\">    ],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;ST&quot;: &quot;BeiJing&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=www server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>执行完成后会生成<code>server.pem</code>和<code>server-key.pem</code>文件</p>\n          </div><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"部署etcd集群\"><a href=\"#部署etcd集群\" class=\"headerlink\" title=\"部署etcd集群\"></a>部署etcd集群</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建服务启动文件</button></li><li class=\"tab\"><button data-href=\"#comments-4\">拷贝证书</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建工作目录</span></span><br><span class=\"line\">mkdir /opt/etcd/&#123;bin,cfg,ssl&#125; -p</span><br><span class=\"line\">tar zxvf etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class=\"line\">mv etcd-v3.4.9-linux-amd64/&#123;etcd,etcdctl&#125; /opt/etcd/bin/</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/etcd/cfg/etcd.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">#[Member]</span></span><br><span class=\"line\"><span class=\"string\">ETCD_NAME=&quot;etcd-1&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.31.71:2380&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.31.71:2379&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">#[Clustering]</span></span><br><span class=\"line\"><span class=\"string\">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.31.71:2380&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.31.71:2379&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span></span><br><span class=\"line\"><span class=\"string\">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>ETCD_NAME：节点名称，集群中唯一</li>\n<li>ETCD_DATA_DIR：数据目录</li>\n<li>ETCD_LISTEN_PEER_URLS：集群通信监听地址</li>\n<li>ETCD_LISTEN_CLIENT_URLS：客户端访问监听地址</li>\n<li>ETCD_INITIAL_ADVERTISE_PEERURLS：集群通告地址</li>\n<li>ETCD_ADVERTISE_CLIENT_URLS：客户端通告地址</li>\n<li>ETCD_INITIAL_CLUSTER：集群节点地址</li>\n<li>ETCD_INITIALCLUSTER_TOKEN：集群Token</li>\n<li>ETCD_INITIALCLUSTER_STATE：加入集群的当前状态，new是新集群，existing表示加入已有集群</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Etcd Server</span></span><br><span class=\"line\"><span class=\"string\">After=network.target</span></span><br><span class=\"line\"><span class=\"string\">After=network-online.target</span></span><br><span class=\"line\"><span class=\"string\">Wants=network-online.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">Type=notify</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/etcd/cfg/etcd.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/etcd/bin/etcd \\</span></span><br><span class=\"line\"><span class=\"string\">--cert-file=/opt/etcd/ssl/server.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--key-file=/opt/etcd/ssl/server-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--peer-cert-file=/opt/etcd/ssl/server.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--peer-key-file=/opt/etcd/ssl/server-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--trusted-ca-file=/opt/etcd/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">--logger=zap</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\">LimitNOFILE=65536</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp ~/TLS/etcd/ca*pem ~/TLS/etcd/server*pem /opt/etcd/ssl/</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动集群\"><a href=\"#启动集群\" class=\"headerlink\" title=\"启动集群\"></a>启动集群</h2><p>首先启动第一个节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start etcd</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> etcd</span><br></pre></td></tr></table></figure>\n\n\n\n<p>将上一步中的文件都拷贝到其他节点上：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">scp -r /opt/etcd/ root@192.168.31.72:/opt/</span><br><span class=\"line\">scp /usr/lib/systemd/system/etcd.service root@192.168.31.72:/usr/lib/systemd/system/</span><br><span class=\"line\">scp -r /opt/etcd/ root@192.168.31.73:/opt/</span><br><span class=\"line\">scp /usr/lib/systemd/system/etcd.service root@192.168.31.73:/usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>\n\n\n\n<p>注意，拷贝过去后需要修改一下配置文件的内容，将IP和节点名称修改为当前所在服务器的地址：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /opt/etcd/cfg/etcd.conf</span><br><span class=\"line\"><span class=\"comment\">#[Member]</span></span><br><span class=\"line\">ETCD_NAME=<span class=\"string\">&quot;etcd-1&quot;</span>   <span class=\"comment\"># 修改此处，节点2改为etcd-2，节点3改为etcd-3</span></span><br><span class=\"line\">ETCD_DATA_DIR=<span class=\"string\">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_PEER_URLS=<span class=\"string\">&quot;https://192.168.31.71:2380&quot;</span>   <span class=\"comment\"># 修改此处为当前服务器IP</span></span><br><span class=\"line\">ETCD_LISTEN_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.31.71:2379&quot;</span> <span class=\"comment\"># 修改此处为当前服务器IP</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#[Clustering]</span></span><br><span class=\"line\">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class=\"string\">&quot;https://192.168.31.71:2380&quot;</span> <span class=\"comment\"># 修改此处为当前服务器IP</span></span><br><span class=\"line\">ETCD_ADVERTISE_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.31.71:2379&quot;</span> <span class=\"comment\"># 修改此处为当前服务器IP</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER=<span class=\"string\">&quot;etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_TOKEN=<span class=\"string\">&quot;etcd-cluster&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_STATE=<span class=\"string\">&quot;new&quot;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后在启动剩下的两个节点，步骤同上。</p>\n<h2 id=\"查看集群状态\"><a href=\"#查看集群状态\" class=\"headerlink\" title=\"查看集群状态\"></a>查看集群状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ETCDCTL_API=3 /opt/etcd/bin/etcdctl --cacert=/opt/etcd/ssl/ca.pem --cert=/opt/etcd/ssl/server.pem --key=/opt/etcd/ssl/server-key.pem --endpoints=<span class=\"string\">&quot;https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.31.73:2379&quot;</span> endpoint health --write-out=table</span><br><span class=\"line\"></span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">|          ENDPOINT    | HEALTH |    TOOK     | ERROR |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">| https://192.168.31.71:2379 |   <span class=\"literal\">true</span> | 10.301506ms |    |</span><br><span class=\"line\">| https://192.168.31.73:2379 |   <span class=\"literal\">true</span> | 12.87467ms |     |</span><br><span class=\"line\">| https://192.168.31.72:2379 |   <span class=\"literal\">true</span> | 13.225954ms |    |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<div class=\"note success fas fa-bullhorn\">\n            <p>可以看到集群是正常的，部署成功</p>\n          </div>\n\n\n\n<br>\n\n\n\n<h1 id=\"安装docker\"><a href=\"#安装docker\" class=\"headerlink\" title=\"安装docker\"></a>安装docker</h1><div class=\"note info fas fa-bullhorn\">\n            <p>在所有的节点都安装docker，也可以换成其他的容器引擎如containerd</p>\n          </div>\n\n\n\n<h2 id=\"下载安装\"><a href=\"#下载安装\" class=\"headerlink\" title=\"下载安装\"></a>下载安装</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz</span><br><span class=\"line\">tar zxvf docker-19.03.9.tgz</span><br><span class=\"line\">mv docker/* /usr/bin</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建服务启动文件\"><a href=\"#创建服务启动文件\" class=\"headerlink\" title=\"创建服务启动文件\"></a>创建服务启动文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Docker Application Container Engine</span></span><br><span class=\"line\"><span class=\"string\">Documentation=https://docs.docker.com</span></span><br><span class=\"line\"><span class=\"string\">After=network-online.target firewalld.service</span></span><br><span class=\"line\"><span class=\"string\">Wants=network-online.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">Type=notify</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/usr/bin/dockerd</span></span><br><span class=\"line\"><span class=\"string\">ExecReload=/bin/kill -s HUP $MAINPID</span></span><br><span class=\"line\"><span class=\"string\">LimitNOFILE=infinity</span></span><br><span class=\"line\"><span class=\"string\">LimitNPROC=infinity</span></span><br><span class=\"line\"><span class=\"string\">LimitCORE=infinity</span></span><br><span class=\"line\"><span class=\"string\">TimeoutStartSec=0</span></span><br><span class=\"line\"><span class=\"string\">Delegate=yes</span></span><br><span class=\"line\"><span class=\"string\">KillMode=process</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\">StartLimitBurst=3</span></span><br><span class=\"line\"><span class=\"string\">StartLimitInterval=60s</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建配置文件\"><a href=\"#创建配置文件\" class=\"headerlink\" title=\"创建配置文件\"></a>创建配置文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /etc/docker</span><br><span class=\"line\">cat &gt; /etc/docker/daemon.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;registry-mirrors&quot;: [&quot;https://b9pmyelo.mirror.aliyuncs.com&quot;]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>这里使用了阿里云镜像加速器</p>\n          </div>\n\n\n\n\n\n<h2 id=\"启动服务\"><a href=\"#启动服务\" class=\"headerlink\" title=\"启动服务\"></a>启动服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start docker</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> docker</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<br>\n\n\n\n<h1 id=\"部署master节点\"><a href=\"#部署master节点\" class=\"headerlink\" title=\"部署master节点\"></a>部署master节点</h1><h2 id=\"生成kube-apiserver证书\"><a href=\"#生成kube-apiserver证书\" class=\"headerlink\" title=\"生成kube-apiserver证书\"></a>生成kube-apiserver证书</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">自签CA</button></li><li class=\"tab\"><button data-href=\"#comments-2\">生成证书</button></li><li class=\"tab\"><button data-href=\"#comments-3\">签发kube-apiserver证书</button></li><li class=\"tab\"><button data-href=\"#comments-4\">生成证书</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/k8s</span><br><span class=\"line\"></span><br><span class=\"line\">cat &gt; ca-config.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;signing&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;default&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;expiry&quot;: &quot;87600h&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;profiles&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">         &quot;expiry&quot;: &quot;87600h&quot;,</span></span><br><span class=\"line\"><span class=\"string\">         &quot;usages&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">            &quot;signing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;key encipherment&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;server auth&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;client auth&quot;</span></span><br><span class=\"line\"><span class=\"string\">        ]</span></span><br><span class=\"line\"><span class=\"string\">      &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  &#125;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">cat &gt; ca-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;L&quot;: &quot;Beijing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;ST&quot;: &quot;Beijing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cfssl gencert -initca ca-csr.json | cfssljson -bare ca -</span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>会生成<code>ca.pem</code>和<code>ca-key.pem</code>文件。</p>\n          </div><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; server-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;CN&quot;: &quot;kubernetes&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;hosts&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">      &quot;10.0.0.1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;127.0.0.1&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;192.168.31.71&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;192.168.31.72&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;192.168.31.73&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;192.168.31.88&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes.default&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes.default.svc&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes.default.svc.cluster&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class=\"line\"><span class=\"string\">    ],</span></span><br><span class=\"line\"><span class=\"string\">    &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">        &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">        &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">    &#125;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">        &#123;</span></span><br><span class=\"line\"><span class=\"string\">            &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class=\"line\"><span class=\"string\">            &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>文件hosts字段中IP为所有Master/LB/VIP IP，一个都不能少！为了方便后期扩容可以多写几个预留的IP</p>\n          </div><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes server-csr.json | cfssljson -bare server</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"安装kube-apiserver\"><a href=\"#安装kube-apiserver\" class=\"headerlink\" title=\"安装kube-apiserver\"></a>安装kube-apiserver</h2><p><strong><a href=\"https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md，在这里下载1.20版本的安装包，下载server包就够了，包含了Master和Worker\">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md，在这里下载1.20版本的安装包，下载server包就够了，包含了Master和Worker</a> Node二进制文件。</strong></p>\n<div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">安装</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建TLS Token</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125; </span><br><span class=\"line\">tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> kubernetes/server/bin</span><br><span class=\"line\">cp kube-apiserver kube-scheduler kube-controller-manager /opt/kubernetes/bin</span><br><span class=\"line\">cp kubectl /usr/bin/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 拷贝证书</span></span><br><span class=\"line\">cp ~/TLS/k8s/ca*pem ~/TLS/k8s/server*pem /opt/kubernetes/ssl/</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-apiserver.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBE_APISERVER_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--etcd-servers=https://192.168.31.71:2379,https://192.168.31.72:2379,https://192.168.31.73:2379 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--bind-address=192.168.31.71 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--secure-port=6443 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--advertise-address=192.168.31.71 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--allow-privileged=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-cluster-ip-range=10.0.0.0/24 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction \\\\</span></span><br><span class=\"line\"><span class=\"string\">--authorization-mode=RBAC,Node \\\\</span></span><br><span class=\"line\"><span class=\"string\">--enable-bootstrap-token-auth=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--token-auth-file=/opt/kubernetes/cfg/token.csv \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-node-port-range=30000-32767 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubelet-client-certificate=/opt/kubernetes/ssl/server.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubelet-client-key=/opt/kubernetes/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--tls-cert-file=/opt/kubernetes/ssl/server.pem  \\\\</span></span><br><span class=\"line\"><span class=\"string\">--tls-private-key-file=/opt/kubernetes/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-account-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-account-issuer=api \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-account-signing-key-file=/opt/kubernetes/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--etcd-cafile=/opt/etcd/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--etcd-certfile=/opt/etcd/ssl/server.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--etcd-keyfile=/opt/etcd/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-client-ca-file=/opt/kubernetes/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--proxy-client-cert-file=/opt/kubernetes/ssl/server.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--proxy-client-key-file=/opt/kubernetes/ssl/server-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-allowed-names=kubernetes \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-extra-headers-prefix=X-Remote-Extra- \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-group-headers=X-Remote-Group \\\\</span></span><br><span class=\"line\"><span class=\"string\">--requestheader-username-headers=X-Remote-User \\\\</span></span><br><span class=\"line\"><span class=\"string\">--enable-aggregator-routing=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--audit-log-maxage=30 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--audit-log-maxbackup=3 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--audit-log-maxsize=100 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--audit-log-path=/opt/kubernetes/logs/k8s-audit.log&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>–logtostderr：启用日志</li>\n<li>—v：日志等级</li>\n<li>–log-dir：日志目录</li>\n<li>–etcd-servers：etcd集群地址</li>\n<li>–bind-address：监听地址</li>\n<li>–secure-port：https安全端口</li>\n<li>–advertise-address：集群通告地址</li>\n<li>–allow-privileged：启用授权</li>\n<li>–service-cluster-ip-range：Service虚拟IP地址段</li>\n<li>–enable-admission-plugins：准入控制模块</li>\n<li>–authorization-mode：认证授权，启用RBAC授权和节点自管理</li>\n<li>–enable-bootstrap-token-auth：启用TLS bootstrap机制</li>\n<li>–token-auth-file：bootstrap token文件</li>\n<li>–service-node-port-range：Service nodeport类型默认分配端口范围</li>\n<li>–kubelet-client-xxx：apiserver访问kubelet客户端证书</li>\n<li>–tls-xxx-file：apiserver https证书</li>\n<li>–etcd-xxxfile：连接Etcd集群证书</li>\n<li>–audit-log-xxx：审计日志</li>\n</ul>\n<p>1.20版本必须加的参数：</p>\n<ul>\n<li>–service-account-issuer</li>\n<li>–service-account-signing-key-file</li>\n</ul>\n<p>启动聚合层相关配置：</p>\n<ul>\n<li>–requestheader-client-ca-file</li>\n<li>–proxy-client-cert-file</li>\n<li>–proxy-client-key-file</li>\n<li>–requestheader-allowed-names</li>\n<li>–requestheader-extra-headers-prefix</li>\n<li>–requestheader-group-headers</li>\n<li>–requestheader-username-headers</li>\n<li>–enable-aggregator-routing</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 生成一个token</span></span><br><span class=\"line\">head -c 16 /dev/urandom | od -An -t x | tr -d <span class=\"string\">&#x27; &#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建文件</span></span><br><span class=\"line\">cat &gt; /opt/kubernetes/cfg/token.csv &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">c47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,&quot;system:node-bootstrapper&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes API Server</span></span><br><span class=\"line\"><span class=\"string\">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kube-apiserver.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kube-apiserver \\$KUBE_APISERVER_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kube-apiserver\"><a href=\"#启动kube-apiserver\" class=\"headerlink\" title=\"启动kube-apiserver\"></a>启动kube-apiserver</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kube-apiserver </span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kube-apiserver</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"部署kube-controller-manager\"><a href=\"#部署kube-controller-manager\" class=\"headerlink\" title=\"部署kube-controller-manager\"></a>部署kube-controller-manager</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建证书</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建kubeconfig文件</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-controller-manager.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--leader-elect=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubeconfig=/opt/kubernetes/cfg/kube-controller-manager.kubeconfig \\\\</span></span><br><span class=\"line\"><span class=\"string\">--bind-address=127.0.0.1 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--allocate-node-cidrs=true \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cluster-cidr=10.244.0.0/16 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-cluster-ip-range=10.0.0.0/24 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cluster-signing-cert-file=/opt/kubernetes/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cluster-signing-key-file=/opt/kubernetes/ssl/ca-key.pem  \\\\</span></span><br><span class=\"line\"><span class=\"string\">--root-ca-file=/opt/kubernetes/ssl/ca.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--service-account-private-key-file=/opt/kubernetes/ssl/ca-key.pem \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cluster-signing-duration=87600h0m0s&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>–kubeconfig：连接apiserver配置文件</li>\n<li>–leader-elect：当该组件启动多个时，自动选举（HA）</li>\n<li>–cluster-signing-cert-file/–cluster-signing-key-file：自动为kubelet颁发证书的CA，与apiserver保持一致</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/k8s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建证书请求文件</span></span><br><span class=\"line\">cat &gt; kube-controller-manager-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;hosts&quot;: [],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;L&quot;: &quot;BeiJing&quot;, </span></span><br><span class=\"line\"><span class=\"string\">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/opt/kubernetes/cfg/kube-controller-manager.kubeconfig&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials kube-controller-manager \\</span><br><span class=\"line\">  --client-certificate=./kube-controller-manager.pem \\</span><br><span class=\"line\">  --client-key=./kube-controller-manager-key.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=kube-controller-manager \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes Controller Manager</span></span><br><span class=\"line\"><span class=\"string\">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kube-controller-manager.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kube-controller-manager \\$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kube-controller-manager\"><a href=\"#启动kube-controller-manager\" class=\"headerlink\" title=\"启动kube-controller-manager\"></a>启动kube-controller-manager</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kube-controller-manager</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kube-controller-manager</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"部署kube-scheduler\"><a href=\"#部署kube-scheduler\" class=\"headerlink\" title=\"部署kube-scheduler\"></a>部署kube-scheduler</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建证书</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建kubeconfig文件</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-scheduler.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBE_SCHEDULER_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--leader-elect \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubeconfig=/opt/kubernetes/cfg/kube-scheduler.kubeconfig \\\\</span></span><br><span class=\"line\"><span class=\"string\">--bind-address=127.0.0.1&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>–kubeconfig：连接apiserver配置文件</li>\n<li>–leader-elect：当该组件启动多个时，自动选举（HA）</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/k8s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建证书请求文件</span></span><br><span class=\"line\">cat &gt; kube-scheduler-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;hosts&quot;: [],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/opt/kubernetes/cfg/kube-scheduler.kubeconfig&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials kube-scheduler \\</span><br><span class=\"line\">  --client-certificate=./kube-scheduler.pem \\</span><br><span class=\"line\">  --client-key=./kube-scheduler-key.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=kube-scheduler \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes Scheduler</span></span><br><span class=\"line\"><span class=\"string\">Documentation=https://github.com/kubernetes/kubernetes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kube-scheduler.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kube-scheduler \\$KUBE_SCHEDULER_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kube-scheduler\"><a href=\"#启动kube-scheduler\" class=\"headerlink\" title=\"启动kube-scheduler\"></a>启动kube-scheduler</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kube-scheduler</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kube-scheduler</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"创建kubectl证书文件连接集群\"><a href=\"#创建kubectl证书文件连接集群\" class=\"headerlink\" title=\"创建kubectl证书文件连接集群\"></a>创建kubectl证书文件连接集群</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cat &gt; admin-csr.json &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;CN&quot;: &quot;admin&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;hosts&quot;: [],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;O&quot;: &quot;system:masters&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成kubeconfig</span></span><br><span class=\"line\">mkdir /root/.kube</span><br><span class=\"line\"></span><br><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/root/.kube/config&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials cluster-admin \\</span><br><span class=\"line\">  --client-certificate=./admin.pem \\</span><br><span class=\"line\">  --client-key=./admin-key.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=cluster-admin \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看集群状态-1\"><a href=\"#查看集群状态-1\" class=\"headerlink\" title=\"查看集群状态\"></a>查看集群状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get cs</span><br><span class=\"line\">NAME                STATUS    MESSAGE             ERROR</span><br><span class=\"line\">scheduler             Healthy   ok                  </span><br><span class=\"line\">controller-manager       Healthy   ok                  </span><br><span class=\"line\">etcd-2               Healthy   &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>&#125;   </span><br><span class=\"line\">etcd-1               Healthy   &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>&#125;   </span><br><span class=\"line\">etcd-0               Healthy   &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>&#125;  </span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>都是<code>health</code>表示集群现在是健康状态</p>\n          </div>\n\n\n\n<h2 id=\"授权kubelet-bootstrap用户允许请求证书\"><a href=\"#授权kubelet-bootstrap用户允许请求证书\" class=\"headerlink\" title=\"授权kubelet-bootstrap用户允许请求证书\"></a>授权kubelet-bootstrap用户允许请求证书</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create clusterrolebinding kubelet-bootstrap \\</span><br><span class=\"line\">--clusterrole=system:node-bootstrapper \\</span><br><span class=\"line\">--user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署node节点\"><a href=\"#部署node节点\" class=\"headerlink\" title=\"部署node节点\"></a>部署node节点</h1><h2 id=\"创建工作目录并拷贝二进制文件\"><a href=\"#创建工作目录并拷贝二进制文件\" class=\"headerlink\" title=\"创建工作目录并拷贝二进制文件\"></a>创建工作目录并拷贝二进制文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /opt/kubernetes/&#123;bin,cfg,ssl,logs&#125; </span><br><span class=\"line\"><span class=\"built_in\">cd</span> kubernetes/server/bin</span><br><span class=\"line\">cp kubelet kube-proxy /opt/kubernetes/bin  </span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"部署kubelet\"><a href=\"#部署kubelet\" class=\"headerlink\" title=\"部署kubelet\"></a>部署kubelet</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置参数文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建kubeconfig文件</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kubelet.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBELET_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--hostname-override=k8s-master1 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--network-plugin=cni \\\\</span></span><br><span class=\"line\"><span class=\"string\">--kubeconfig=/opt/kubernetes/cfg/kubelet.kubeconfig \\\\</span></span><br><span class=\"line\"><span class=\"string\">--bootstrap-kubeconfig=/opt/kubernetes/cfg/bootstrap.kubeconfig \\\\</span></span><br><span class=\"line\"><span class=\"string\">--config=/opt/kubernetes/cfg/kubelet-config.yml \\\\</span></span><br><span class=\"line\"><span class=\"string\">--cert-dir=/opt/kubernetes/ssl \\\\</span></span><br><span class=\"line\"><span class=\"string\">--pod-infra-container-image=lizhenliang/pause-amd64:3.0&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>–hostname-override：显示名称，集群中唯一</li>\n<li>–network-plugin：启用CNI</li>\n<li>–kubeconfig：空路径，会自动生成，后面用于连接apiserver</li>\n<li>–bootstrap-kubeconfig：首次启动向apiserver申请证书</li>\n<li>–config：配置参数文件</li>\n<li>–cert-dir：kubelet证书生成目录</li>\n<li>–pod-infra-container-image：管理Pod网络容器的镜像</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kubelet-config.yml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeletConfiguration</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"string\">address: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">port: 10250</span></span><br><span class=\"line\"><span class=\"string\">readOnlyPort: 10255</span></span><br><span class=\"line\"><span class=\"string\">cgroupDriver: cgroupfs</span></span><br><span class=\"line\"><span class=\"string\">clusterDNS:</span></span><br><span class=\"line\"><span class=\"string\">- 10.0.0.2</span></span><br><span class=\"line\"><span class=\"string\">clusterDomain: cluster.local </span></span><br><span class=\"line\"><span class=\"string\">failSwapOn: false</span></span><br><span class=\"line\"><span class=\"string\">authentication:</span></span><br><span class=\"line\"><span class=\"string\">  anonymous:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: false</span></span><br><span class=\"line\"><span class=\"string\">  webhook:</span></span><br><span class=\"line\"><span class=\"string\">    cacheTTL: 2m0s</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  x509:</span></span><br><span class=\"line\"><span class=\"string\">    clientCAFile: /opt/kubernetes/ssl/ca.pem </span></span><br><span class=\"line\"><span class=\"string\">authorization:</span></span><br><span class=\"line\"><span class=\"string\">  mode: Webhook</span></span><br><span class=\"line\"><span class=\"string\">  webhook:</span></span><br><span class=\"line\"><span class=\"string\">    cacheAuthorizedTTL: 5m0s</span></span><br><span class=\"line\"><span class=\"string\">    cacheUnauthorizedTTL: 30s</span></span><br><span class=\"line\"><span class=\"string\">evictionHard:</span></span><br><span class=\"line\"><span class=\"string\">  imagefs.available: 15%</span></span><br><span class=\"line\"><span class=\"string\">  memory.available: 100Mi</span></span><br><span class=\"line\"><span class=\"string\">  nodefs.available: 10%</span></span><br><span class=\"line\"><span class=\"string\">  nodefs.inodesFree: 5%</span></span><br><span class=\"line\"><span class=\"string\">maxOpenFiles: 1000000</span></span><br><span class=\"line\"><span class=\"string\">maxPods: 110</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/opt/kubernetes/cfg/bootstrap.kubeconfig&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span> <span class=\"comment\"># apiserver IP:PORT</span></span><br><span class=\"line\">TOKEN=<span class=\"string\">&quot;c47ffb939f5ca36231d9e3121a252940&quot;</span> <span class=\"comment\"># 与token.csv里保持一致</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成 kubelet bootstrap kubeconfig 配置文件</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials <span class=\"string\">&quot;kubelet-bootstrap&quot;</span> \\</span><br><span class=\"line\">  --token=<span class=\"variable\">$&#123;TOKEN&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=<span class=\"string\">&quot;kubelet-bootstrap&quot;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes Kubelet</span></span><br><span class=\"line\"><span class=\"string\">After=docker.service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kubelet.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kubelet \\$KUBELET_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\">LimitNOFILE=65536</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kubelet\"><a href=\"#启动kubelet\" class=\"headerlink\" title=\"启动kubelet\"></a>启动kubelet</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kubelet</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"审批kubelet证书申请并加入集群\"><a href=\"#审批kubelet证书申请并加入集群\" class=\"headerlink\" title=\"审批kubelet证书申请并加入集群\"></a>审批kubelet证书申请并加入集群</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看kubelet证书请求</span></span><br><span class=\"line\">kubectl get csr</span><br><span class=\"line\">NAME                                                   AGE    SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class=\"line\">node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A   6m3s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 批准申请</span></span><br><span class=\"line\">kubectl certificate approve node-csr-uCEGPOIiDdlLODKts8J658HrFq9CZ--K6M4G7bjhk8A</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看节点</span></span><br><span class=\"line\">kubectl get node</span><br><span class=\"line\">NAME         STATUS     ROLES    AGE   VERSION</span><br><span class=\"line\">k8s-master1   NotReady   &lt;none&gt;   7s    v1.18.3</span><br></pre></td></tr></table></figure>\n\n<div class=\"note info fas fa-bullhorn\">\n            <p>由于网络插件还没有部署，节点会没有准备就绪 NotReady</p>\n          </div>\n\n\n\n<h2 id=\"部署kube-proxy\"><a href=\"#部署kube-proxy\" class=\"headerlink\" title=\"部署kube-proxy\"></a>部署kube-proxy</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建配置文件</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建配置参数文件</button></li><li class=\"tab\"><button data-href=\"#comments-3\">创建kube-proxy证书</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建kubeconfig文件</button></li><li class=\"tab\"><button data-href=\"#comments-5\">创建启动文件</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-proxy.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">KUBE_PROXY_OPTS=&quot;--logtostderr=false \\\\</span></span><br><span class=\"line\"><span class=\"string\">--v=2 \\\\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/opt/kubernetes/logs \\\\</span></span><br><span class=\"line\"><span class=\"string\">--config=/opt/kubernetes/cfg/kube-proxy-config.yml&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /opt/kubernetes/cfg/kube-proxy-config.yml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeProxyConfiguration</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"string\">bindAddress: 0.0.0.0</span></span><br><span class=\"line\"><span class=\"string\">metricsBindAddress: 0.0.0.0:10249</span></span><br><span class=\"line\"><span class=\"string\">clientConnection:</span></span><br><span class=\"line\"><span class=\"string\">  kubeconfig: /opt/kubernetes/cfg/kube-proxy.kubeconfig</span></span><br><span class=\"line\"><span class=\"string\">hostnameOverride: k8s-master1</span></span><br><span class=\"line\"><span class=\"string\">clusterCIDR: 10.0.0.0/24</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> ~/TLS/k8s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建证书请求文件</span></span><br><span class=\"line\">cat &gt; kube-proxy-csr.json &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;hosts&quot;: [],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;key&quot;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;algo&quot;: &quot;rsa&quot;,</span></span><br><span class=\"line\"><span class=\"string\">    &quot;size&quot;: 2048</span></span><br><span class=\"line\"><span class=\"string\">  &#125;,</span></span><br><span class=\"line\"><span class=\"string\">  &quot;names&quot;: [</span></span><br><span class=\"line\"><span class=\"string\">    &#123;</span></span><br><span class=\"line\"><span class=\"string\">      &quot;C&quot;: &quot;CN&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;L&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;ST&quot;: &quot;BeiJing&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;O&quot;: &quot;k8s&quot;,</span></span><br><span class=\"line\"><span class=\"string\">      &quot;OU&quot;: &quot;System&quot;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">  ]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 生成证书</span></span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE_CONFIG=<span class=\"string\">&quot;/opt/kubernetes/cfg/kube-proxy.kubeconfig&quot;</span></span><br><span class=\"line\">KUBE_APISERVER=<span class=\"string\">&quot;https://192.168.31.71:6443&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-cluster kubernetes \\</span><br><span class=\"line\">  --certificate-authority=/opt/kubernetes/ssl/ca.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --server=<span class=\"variable\">$&#123;KUBE_APISERVER&#125;</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-credentials kube-proxy \\</span><br><span class=\"line\">  --client-certificate=./kube-proxy.pem \\</span><br><span class=\"line\">  --client-key=./kube-proxy-key.pem \\</span><br><span class=\"line\">  --embed-certs=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config set-context default \\</span><br><span class=\"line\">  --cluster=kubernetes \\</span><br><span class=\"line\">  --user=kube-proxy \\</span><br><span class=\"line\">  --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=<span class=\"variable\">$&#123;KUBE_CONFIG&#125;</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-5\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/kube-proxy.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=Kubernetes Proxy</span></span><br><span class=\"line\"><span class=\"string\">After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">EnvironmentFile=/opt/kubernetes/cfg/kube-proxy.conf</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/opt/kubernetes/bin/kube-proxy \\$KUBE_PROXY_OPTS</span></span><br><span class=\"line\"><span class=\"string\">Restart=on-failure</span></span><br><span class=\"line\"><span class=\"string\">LimitNOFILE=65536</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"启动kube-proxy\"><a href=\"#启动kube-proxy\" class=\"headerlink\" title=\"启动kube-proxy\"></a>启动kube-proxy</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kube-proxy</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kube-proxy</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"部署网络插件callico\"><a href=\"#部署网络插件callico\" class=\"headerlink\" title=\"部署网络插件callico\"></a>部署网络插件callico</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f calico.yaml</span><br><span class=\"line\">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查集群pod状态\"><a href=\"#检查集群pod状态\" class=\"headerlink\" title=\"检查集群pod状态\"></a>检查集群pod状态</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node</span><br><span class=\"line\">NAME         STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">k8s-master   Ready    &lt;none&gt;   37m   v1.20.4</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"授权apiserver访问kubelet\"><a href=\"#授权apiserver访问kubelet\" class=\"headerlink\" title=\"授权apiserver访问kubelet\"></a>授权apiserver访问kubelet</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; apiserver-to-kubelet-rbac.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"string\">kind: ClusterRole</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  annotations:</span></span><br><span class=\"line\"><span class=\"string\">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    kubernetes.io/bootstrapping: rbac-defaults</span></span><br><span class=\"line\"><span class=\"string\">  name: system:kube-apiserver-to-kubelet</span></span><br><span class=\"line\"><span class=\"string\">rules:</span></span><br><span class=\"line\"><span class=\"string\">  - apiGroups:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    resources:</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/proxy</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/stats</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/log</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/spec</span></span><br><span class=\"line\"><span class=\"string\">      - nodes/metrics</span></span><br><span class=\"line\"><span class=\"string\">      - pods/log</span></span><br><span class=\"line\"><span class=\"string\">    verbs:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;*&quot;</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"string\">kind: ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: system:kube-apiserver</span></span><br><span class=\"line\"><span class=\"string\">  namespace: &quot;&quot;</span></span><br><span class=\"line\"><span class=\"string\">roleRef:</span></span><br><span class=\"line\"><span class=\"string\">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"string\">  kind: ClusterRole</span></span><br><span class=\"line\"><span class=\"string\">  name: system:kube-apiserver-to-kubelet</span></span><br><span class=\"line\"><span class=\"string\">subjects:</span></span><br><span class=\"line\"><span class=\"string\">  - apiGroup: rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"string\">    kind: User</span></span><br><span class=\"line\"><span class=\"string\">    name: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f apiserver-to-kubelet-rbac.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"node节点扩容\"><a href=\"#node节点扩容\" class=\"headerlink\" title=\"node节点扩容\"></a>node节点扩容</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拷贝相关文件</span></span><br><span class=\"line\">scp -r /opt/kubernetes root@192.168.31.72:/opt/</span><br><span class=\"line\"></span><br><span class=\"line\">scp -r /usr/lib/systemd/system/&#123;kubelet,kube-proxy&#125;.service root@192.168.31.72:/usr/lib/systemd/system</span><br><span class=\"line\"></span><br><span class=\"line\">scp /opt/kubernetes/ssl/ca.pem root@192.168.31.72:/opt/kubernetes/ssl</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在node节点上删除kubeconfig文件</span></span><br><span class=\"line\">rm -f /opt/kubernetes/cfg/kubelet.kubeconfig </span><br><span class=\"line\">rm -f /opt/kubernetes/ssl/kubelet*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 修改kubelet配置文件</span></span><br><span class=\"line\">vi /opt/kubernetes/cfg/kubelet.conf</span><br><span class=\"line\">--hostname-override=k8s-node1 <span class=\"comment\">## 修改这一项</span></span><br><span class=\"line\"></span><br><span class=\"line\">vi /opt/kubernetes/cfg/kube-proxy-config.yml</span><br><span class=\"line\">hostnameOverride: k8s-node1  <span class=\"comment\">## 修改这一项</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start kubelet kube-proxy</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet kube-proxy</span><br><span class=\"line\">systemctl start kubelet kubelet</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet kubelet</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在master上批准请求</span></span><br><span class=\"line\"><span class=\"comment\"># 查看证书请求</span></span><br><span class=\"line\">kubectl get csr</span><br><span class=\"line\">NAME           AGE   SIGNERNAME                    REQUESTOR           CONDITION</span><br><span class=\"line\">node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro   89s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 授权请求</span></span><br><span class=\"line\">kubectl certificate approve node-csr-4zTjsaVSrhuyhIGqsefxzVoZDCNKei-aE2jyTP81Uro</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看node状态</span></span><br><span class=\"line\">kubectl get node</span><br><span class=\"line\">NAME       STATUS   ROLES    AGE     VERSION</span><br><span class=\"line\">k8s-master1   Ready    &lt;none&gt;   47m     v1.20.4</span><br><span class=\"line\">k8s-node1    Ready    &lt;none&gt;   6m49s   v1.20.4</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"常用插件部署\"><a href=\"#常用插件部署\" class=\"headerlink\" title=\"常用插件部署\"></a>常用插件部署</h1><h2 id=\"部署dashboard\"><a href=\"#部署dashboard\" class=\"headerlink\" title=\"部署dashboard\"></a>部署dashboard</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f kubernetes-dashboard.yaml</span><br><span class=\"line\">kubectl get pods,svc -n kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建serviceaccount</span></span><br><span class=\"line\">kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class=\"line\">kubectl create clusterrolebinding dashboard-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br><span class=\"line\">kubectl describe secrets -n kube-system $(kubectl -n kube-system get secret | awk <span class=\"string\">&#x27;/dashboard-admin/&#123;print $1&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n\n\n<p>上一步将输出一个token，访问：<a href=\"https://NodeIP:30001，输入token即可进入页面\">https://NodeIP:30001，输入token即可进入页面</a></p>\n<h2 id=\"部署coredns\"><a href=\"#部署coredns\" class=\"headerlink\" title=\"部署coredns\"></a>部署coredns</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f coredns.yaml </span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl get pods -n kube-system  </span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS   AGE </span><br><span class=\"line\">coredns-5ffbfd976d-j6shb      1/1     Running   0          32s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 测试解析</span></span><br><span class=\"line\">kubectl run -it --rm dns-test --image=busybox:1.28.4 sh </span><br><span class=\"line\">If you don<span class=\"string\">&#x27;t see a command prompt, try pressing enter. </span></span><br><span class=\"line\"><span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">/ # nslookup kubernetes </span></span><br><span class=\"line\"><span class=\"string\">Server:    10.0.0.2 </span></span><br><span class=\"line\"><span class=\"string\">Address 1: 10.0.0.2 kube-dns.kube-system.svc.cluster.local </span></span><br><span class=\"line\"><span class=\"string\"> </span></span><br><span class=\"line\"><span class=\"string\">Name:      kubernetes </span></span><br><span class=\"line\"><span class=\"string\">Address 1: 10.0.0.1 kubernetes.default.svc.cluster.local</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n\n"},{"title":"部署Nginx","date":"2021-04-13T00:38:54.000Z","description":"使用yum和源码两种方式部署nginx服务","cover":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.nd9p.com%2Fuploads%2Fallimg%2F160529%2F2143353111_0.jpg&refer=http%3A%2F%2Fwww.nd9p.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620866496&t=e367c0adebb6cf217109959821f24a66","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用yum和源码两种方式部署nginx服务\n\n更新于 2021-04-13\n\n{% endnote %}\n\n<br>\n\n\n\n# yum方式部署\n\n## 安装依赖\n\n```bash\nyum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel\n```\n\n\n\n 有些工具包也可以选择安装：\n\n```bash\nyum install -y wget http-tools vim\n```\n\n‌\n\n## 添加yum源\n\n```bash\ncat > /etc/yum.repos.d/nginx.repo << EOF\n[nginx-stable]\nname=nginx stable repo\nbaseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/\ngpgcheck=1\nenabled=1\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\n\n[nginx-mainline]\nname=nginx mainline repo\nbaseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/\ngpgcheck=1\nenabled=0\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\nEOF\n```\n\n‌\n\n## 安装nginx\n\n```bash\n# 查看nginx版本\nyum list | grep nginx\n\n# 安装最新版\nyum install -y nginx\n```\n\n\n\n## 查看nginx版本和编译参数\n\n```bash\n# 查看nginx版本\nnginx -v\n\n# 查看nginx编译参数\nnginx -V\n```\n\n\n\n## 默认安装的目录和文件\n\n使用下面的命令可以查看nginx通过rpm方式安装的目录结构和文件：\n\n```bash\nrpm -ql nginx\n```\n\n\n\n重要的配置文件如下：\n\n- `/etc/logrotate.d/nginx`：nginx配置logrotate日志切割的配置文件；\n- `/etc/nginx`：安装目录；\n- `/etc/nginx/nginx.conf`：主配置文件；\n- `/etc/nginx/conf.d`：其他配置存放的目录；\n- `/etc/nginx/conf.d/default.conf`：默认加载的配置；\n- `/etc/nginx/fastcgi_params`：fastcgi配置文件；\n- `/etc/nginx/scgi_params`：scgi配置文件；\n- `/etc/nginx/uwsgi_params`：uwsgi配置文件；\n- `/etc/nginx/{koi-win, koi-utf, win-utf}`：编码转换配置文件；\n- `/etc/nginx/mime.types`：设置http协议的Content-Type与扩展名对应关系的配置文件；\n- `/var/cache/nginx`：用于缓存的目录；\n- `/var/log/nginx`：日志目录；\n\n\n\n## nginx启动\n\n```bash\n# 启动\nsystemctl start nginx\n\n# 开机自启动\nsystemctl enable nginx\n\n# 查看nginx状态\nsystemctl status nginx\n\n# 停止nginx\nsystemctl stop nginx\n\n# 重启\nsystemctl restart nginx\n```\n\n<br>\n\n\n\n# 源码方式部署\n\n## 安装依赖\n\n```bash\nyum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel\n```\n\n\n\n## 下载源码包\n\n这里我使用的是1.18.0版本\n\n```bash\nwget http://nginx.org/download/nginx-1.18.0.tar.gz\n```\n\n\n\n## 编译安装\n\n```bash\n# 添加用户和组\ngroupadd nginx\nuseradd -g nginx nginx \n\n# 编译安装\ntar zxf nginx-1.18.0.tar.gz\ncd nginx-1.18.0\n./configure \\\n--user=nginx \\\n--group=nginx \\\n--prefix=/usr/local/nginx \\\n--with-http_ssl_module \\\n--with-http_stub_status_module \\\n--with-http_realip_module \\\n--with-threads\n\nmake && make install\n\n# 设置环境变量\necho \"export PATH=$PATH:/usr/local/nginx/sbin\" >> /etc/profile\nsource /etc/profile\n```\n\n> 根据实际需求增减编译的模块\n\n\n\n## 检查\n\n```bash\nnginx -v\nnginx -V\n```\n\n\n\n![](./install_source.png)\n\n\n\n## 设置启动文件\n\n```bash\ncat > /usr/lib/systemd/system/nginx.service << EOF\n[Unit]\nDescription=nginx service\nAfter=network.target\n\n[Service]\nType=forking\nExecStart=/usr/local/nginx/sbin/nginx\nExecReload=/usr/local/nginx/sbin/nginx -s reload\nExecStop=/usr/local/nginx/sbin/nginx -s quit\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n\n\n## 启动nginx\n\n```bash\nsystemctl daemon-reload\nsystemctl start nginx\nsystemctl enable nginx\nsystemctl status nginx\n```\n\n\n\n## 安装的文件\n\n在编译的时候指定了nginx的安装目录为：`--prefix=/usr/local/nginx`，安装后会有以下文件：\n\n- `conf`：配置文件目录；\n  - `fastcgi.conf`：fastcgi配置文件；\n  - `mime.types`：设置http协议的Content-Type与扩展名对应关系的配置文件；\n  - `uwsgi_params`：uwsgi配置文件；\n  - `koi-win, koi-utf, win-utf`：编码转换配置文件；\n  - `scgi_params`：scgi配置文件；\n  - `fastcgi_params`：fastcgi配置文件；\n  - `nginx.conf`：nginx主配置文件；\n- `html`：默认的静态文件根目录；\n- `sbin`：二进制命令文件目录；\n\n","source":"_posts/部署Nginx.md","raw":"---\ntitle: 部署Nginx\ndate: 2021-04-13 08:38:54\ntags:\n- Nginx\ncategories:\n- Nginx\n- 部署\ndescription: 使用yum和源码两种方式部署nginx服务\ncover: https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fwww.nd9p.com%2Fuploads%2Fallimg%2F160529%2F2143353111_0.jpg&refer=http%3A%2F%2Fwww.nd9p.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620866496&t=e367c0adebb6cf217109959821f24a66\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用yum和源码两种方式部署nginx服务\n\n更新于 2021-04-13\n\n{% endnote %}\n\n<br>\n\n\n\n# yum方式部署\n\n## 安装依赖\n\n```bash\nyum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel\n```\n\n\n\n 有些工具包也可以选择安装：\n\n```bash\nyum install -y wget http-tools vim\n```\n\n‌\n\n## 添加yum源\n\n```bash\ncat > /etc/yum.repos.d/nginx.repo << EOF\n[nginx-stable]\nname=nginx stable repo\nbaseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/\ngpgcheck=1\nenabled=1\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\n\n[nginx-mainline]\nname=nginx mainline repo\nbaseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/\ngpgcheck=1\nenabled=0\ngpgkey=https://nginx.org/keys/nginx_signing.key\nmodule_hotfixes=true\nEOF\n```\n\n‌\n\n## 安装nginx\n\n```bash\n# 查看nginx版本\nyum list | grep nginx\n\n# 安装最新版\nyum install -y nginx\n```\n\n\n\n## 查看nginx版本和编译参数\n\n```bash\n# 查看nginx版本\nnginx -v\n\n# 查看nginx编译参数\nnginx -V\n```\n\n\n\n## 默认安装的目录和文件\n\n使用下面的命令可以查看nginx通过rpm方式安装的目录结构和文件：\n\n```bash\nrpm -ql nginx\n```\n\n\n\n重要的配置文件如下：\n\n- `/etc/logrotate.d/nginx`：nginx配置logrotate日志切割的配置文件；\n- `/etc/nginx`：安装目录；\n- `/etc/nginx/nginx.conf`：主配置文件；\n- `/etc/nginx/conf.d`：其他配置存放的目录；\n- `/etc/nginx/conf.d/default.conf`：默认加载的配置；\n- `/etc/nginx/fastcgi_params`：fastcgi配置文件；\n- `/etc/nginx/scgi_params`：scgi配置文件；\n- `/etc/nginx/uwsgi_params`：uwsgi配置文件；\n- `/etc/nginx/{koi-win, koi-utf, win-utf}`：编码转换配置文件；\n- `/etc/nginx/mime.types`：设置http协议的Content-Type与扩展名对应关系的配置文件；\n- `/var/cache/nginx`：用于缓存的目录；\n- `/var/log/nginx`：日志目录；\n\n\n\n## nginx启动\n\n```bash\n# 启动\nsystemctl start nginx\n\n# 开机自启动\nsystemctl enable nginx\n\n# 查看nginx状态\nsystemctl status nginx\n\n# 停止nginx\nsystemctl stop nginx\n\n# 重启\nsystemctl restart nginx\n```\n\n<br>\n\n\n\n# 源码方式部署\n\n## 安装依赖\n\n```bash\nyum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel\n```\n\n\n\n## 下载源码包\n\n这里我使用的是1.18.0版本\n\n```bash\nwget http://nginx.org/download/nginx-1.18.0.tar.gz\n```\n\n\n\n## 编译安装\n\n```bash\n# 添加用户和组\ngroupadd nginx\nuseradd -g nginx nginx \n\n# 编译安装\ntar zxf nginx-1.18.0.tar.gz\ncd nginx-1.18.0\n./configure \\\n--user=nginx \\\n--group=nginx \\\n--prefix=/usr/local/nginx \\\n--with-http_ssl_module \\\n--with-http_stub_status_module \\\n--with-http_realip_module \\\n--with-threads\n\nmake && make install\n\n# 设置环境变量\necho \"export PATH=$PATH:/usr/local/nginx/sbin\" >> /etc/profile\nsource /etc/profile\n```\n\n> 根据实际需求增减编译的模块\n\n\n\n## 检查\n\n```bash\nnginx -v\nnginx -V\n```\n\n\n\n![](./install_source.png)\n\n\n\n## 设置启动文件\n\n```bash\ncat > /usr/lib/systemd/system/nginx.service << EOF\n[Unit]\nDescription=nginx service\nAfter=network.target\n\n[Service]\nType=forking\nExecStart=/usr/local/nginx/sbin/nginx\nExecReload=/usr/local/nginx/sbin/nginx -s reload\nExecStop=/usr/local/nginx/sbin/nginx -s quit\nPrivateTmp=true\n\n[Install]\nWantedBy=multi-user.target\nEOF\n```\n\n\n\n## 启动nginx\n\n```bash\nsystemctl daemon-reload\nsystemctl start nginx\nsystemctl enable nginx\nsystemctl status nginx\n```\n\n\n\n## 安装的文件\n\n在编译的时候指定了nginx的安装目录为：`--prefix=/usr/local/nginx`，安装后会有以下文件：\n\n- `conf`：配置文件目录；\n  - `fastcgi.conf`：fastcgi配置文件；\n  - `mime.types`：设置http协议的Content-Type与扩展名对应关系的配置文件；\n  - `uwsgi_params`：uwsgi配置文件；\n  - `koi-win, koi-utf, win-utf`：编码转换配置文件；\n  - `scgi_params`：scgi配置文件；\n  - `fastcgi_params`：fastcgi配置文件；\n  - `nginx.conf`：nginx主配置文件；\n- `html`：默认的静态文件根目录；\n- `sbin`：二进制命令文件目录；\n\n","slug":"部署Nginx","published":1,"updated":"2021-04-13T00:54:30.583Z","_id":"cknfau64z0000sbklbueccx30","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用yum和源码两种方式部署nginx服务</p><p>更新于 2021-04-13</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"yum方式部署\"><a href=\"#yum方式部署\" class=\"headerlink\" title=\"yum方式部署\"></a>yum方式部署</h1><h2 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel</span><br></pre></td></tr></table></figure>\n\n\n\n<p> 有些工具包也可以选择安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y wget http-tools vim</span><br></pre></td></tr></table></figure>\n\n<p>‌</p>\n<h2 id=\"添加yum源\"><a href=\"#添加yum源\" class=\"headerlink\" title=\"添加yum源\"></a>添加yum源</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[nginx-stable]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx stable repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=1</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[nginx-mainline]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx mainline repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=1</span></span><br><span class=\"line\"><span class=\"string\">enabled=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<p>‌</p>\n<h2 id=\"安装nginx\"><a href=\"#安装nginx\" class=\"headerlink\" title=\"安装nginx\"></a>安装nginx</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看nginx版本</span></span><br><span class=\"line\">yum list | grep nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装最新版</span></span><br><span class=\"line\">yum install -y nginx</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看nginx版本和编译参数\"><a href=\"#查看nginx版本和编译参数\" class=\"headerlink\" title=\"查看nginx版本和编译参数\"></a>查看nginx版本和编译参数</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看nginx版本</span></span><br><span class=\"line\">nginx -v</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看nginx编译参数</span></span><br><span class=\"line\">nginx -V</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"默认安装的目录和文件\"><a href=\"#默认安装的目录和文件\" class=\"headerlink\" title=\"默认安装的目录和文件\"></a>默认安装的目录和文件</h2><p>使用下面的命令可以查看nginx通过rpm方式安装的目录结构和文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -ql nginx</span><br></pre></td></tr></table></figure>\n\n\n\n<p>重要的配置文件如下：</p>\n<ul>\n<li><code>/etc/logrotate.d/nginx</code>：nginx配置logrotate日志切割的配置文件；</li>\n<li><code>/etc/nginx</code>：安装目录；</li>\n<li><code>/etc/nginx/nginx.conf</code>：主配置文件；</li>\n<li><code>/etc/nginx/conf.d</code>：其他配置存放的目录；</li>\n<li><code>/etc/nginx/conf.d/default.conf</code>：默认加载的配置；</li>\n<li><code>/etc/nginx/fastcgi_params</code>：fastcgi配置文件；</li>\n<li><code>/etc/nginx/scgi_params</code>：scgi配置文件；</li>\n<li><code>/etc/nginx/uwsgi_params</code>：uwsgi配置文件；</li>\n<li><code>/etc/nginx/&#123;koi-win, koi-utf, win-utf&#125;</code>：编码转换配置文件；</li>\n<li><code>/etc/nginx/mime.types</code>：设置http协议的Content-Type与扩展名对应关系的配置文件；</li>\n<li><code>/var/cache/nginx</code>：用于缓存的目录；</li>\n<li><code>/var/log/nginx</code>：日志目录；</li>\n</ul>\n<h2 id=\"nginx启动\"><a href=\"#nginx启动\" class=\"headerlink\" title=\"nginx启动\"></a>nginx启动</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动</span></span><br><span class=\"line\">systemctl start nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机自启动</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看nginx状态</span></span><br><span class=\"line\">systemctl status nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 停止nginx</span></span><br><span class=\"line\">systemctl stop nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启</span></span><br><span class=\"line\">systemctl restart nginx</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"源码方式部署\"><a href=\"#源码方式部署\" class=\"headerlink\" title=\"源码方式部署\"></a>源码方式部署</h1><h2 id=\"安装依赖-1\"><a href=\"#安装依赖-1\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"下载源码包\"><a href=\"#下载源码包\" class=\"headerlink\" title=\"下载源码包\"></a>下载源码包</h2><p>这里我使用的是1.18.0版本</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://nginx.org/download/nginx-1.18.0.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加用户和组</span></span><br><span class=\"line\">groupadd nginx</span><br><span class=\"line\">useradd -g nginx nginx </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编译安装</span></span><br><span class=\"line\">tar zxf nginx-1.18.0.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> nginx-1.18.0</span><br><span class=\"line\">./configure \\</span><br><span class=\"line\">--user=nginx \\</span><br><span class=\"line\">--group=nginx \\</span><br><span class=\"line\">--prefix=/usr/<span class=\"built_in\">local</span>/nginx \\</span><br><span class=\"line\">--with-http_ssl_module \\</span><br><span class=\"line\">--with-http_stub_status_module \\</span><br><span class=\"line\">--with-http_realip_module \\</span><br><span class=\"line\">--with-threads</span><br><span class=\"line\"></span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置环境变量</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export PATH=<span class=\"variable\">$PATH</span>:/usr/local/nginx/sbin&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>根据实际需求增减编译的模块</p>\n</blockquote>\n<h2 id=\"检查\"><a href=\"#检查\" class=\"headerlink\" title=\"检查\"></a>检查</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -v</span><br><span class=\"line\">nginx -V</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src= \"/img/loading.gif\" data-src=\"./install_source.png\" alt=\"\"></p>\n<h2 id=\"设置启动文件\"><a href=\"#设置启动文件\" class=\"headerlink\" title=\"设置启动文件\"></a>设置启动文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/nginx.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=nginx service</span></span><br><span class=\"line\"><span class=\"string\">After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">Type=forking</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/usr/local/nginx/sbin/nginx</span></span><br><span class=\"line\"><span class=\"string\">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span></span><br><span class=\"line\"><span class=\"string\">ExecStop=/usr/local/nginx/sbin/nginx -s quit</span></span><br><span class=\"line\"><span class=\"string\">PrivateTmp=true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"启动nginx\"><a href=\"#启动nginx\" class=\"headerlink\" title=\"启动nginx\"></a>启动nginx</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start nginx</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nginx</span><br><span class=\"line\">systemctl status nginx</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"安装的文件\"><a href=\"#安装的文件\" class=\"headerlink\" title=\"安装的文件\"></a>安装的文件</h2><p>在编译的时候指定了nginx的安装目录为：<code>--prefix=/usr/local/nginx</code>，安装后会有以下文件：</p>\n<ul>\n<li><code>conf</code>：配置文件目录；<ul>\n<li><code>fastcgi.conf</code>：fastcgi配置文件；</li>\n<li><code>mime.types</code>：设置http协议的Content-Type与扩展名对应关系的配置文件；</li>\n<li><code>uwsgi_params</code>：uwsgi配置文件；</li>\n<li><code>koi-win, koi-utf, win-utf</code>：编码转换配置文件；</li>\n<li><code>scgi_params</code>：scgi配置文件；</li>\n<li><code>fastcgi_params</code>：fastcgi配置文件；</li>\n<li><code>nginx.conf</code>：nginx主配置文件；</li>\n</ul>\n</li>\n<li><code>html</code>：默认的静态文件根目录；</li>\n<li><code>sbin</code>：二进制命令文件目录；</li>\n</ul>\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用yum和源码两种方式部署nginx服务</p><p>更新于 2021-04-13</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"yum方式部署\"><a href=\"#yum方式部署\" class=\"headerlink\" title=\"yum方式部署\"></a>yum方式部署</h1><h2 id=\"安装依赖\"><a href=\"#安装依赖\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel</span><br></pre></td></tr></table></figure>\n\n\n\n<p> 有些工具包也可以选择安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y wget http-tools vim</span><br></pre></td></tr></table></figure>\n\n<p>‌</p>\n<h2 id=\"添加yum源\"><a href=\"#添加yum源\" class=\"headerlink\" title=\"添加yum源\"></a>添加yum源</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[nginx-stable]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx stable repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/centos/\\$releasever/\\$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=1</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[nginx-mainline]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx mainline repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/mainline/centos/\\$releasever/\\$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=1</span></span><br><span class=\"line\"><span class=\"string\">enabled=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<p>‌</p>\n<h2 id=\"安装nginx\"><a href=\"#安装nginx\" class=\"headerlink\" title=\"安装nginx\"></a>安装nginx</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看nginx版本</span></span><br><span class=\"line\">yum list | grep nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装最新版</span></span><br><span class=\"line\">yum install -y nginx</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"查看nginx版本和编译参数\"><a href=\"#查看nginx版本和编译参数\" class=\"headerlink\" title=\"查看nginx版本和编译参数\"></a>查看nginx版本和编译参数</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看nginx版本</span></span><br><span class=\"line\">nginx -v</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看nginx编译参数</span></span><br><span class=\"line\">nginx -V</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"默认安装的目录和文件\"><a href=\"#默认安装的目录和文件\" class=\"headerlink\" title=\"默认安装的目录和文件\"></a>默认安装的目录和文件</h2><p>使用下面的命令可以查看nginx通过rpm方式安装的目录结构和文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rpm -ql nginx</span><br></pre></td></tr></table></figure>\n\n\n\n<p>重要的配置文件如下：</p>\n<ul>\n<li><code>/etc/logrotate.d/nginx</code>：nginx配置logrotate日志切割的配置文件；</li>\n<li><code>/etc/nginx</code>：安装目录；</li>\n<li><code>/etc/nginx/nginx.conf</code>：主配置文件；</li>\n<li><code>/etc/nginx/conf.d</code>：其他配置存放的目录；</li>\n<li><code>/etc/nginx/conf.d/default.conf</code>：默认加载的配置；</li>\n<li><code>/etc/nginx/fastcgi_params</code>：fastcgi配置文件；</li>\n<li><code>/etc/nginx/scgi_params</code>：scgi配置文件；</li>\n<li><code>/etc/nginx/uwsgi_params</code>：uwsgi配置文件；</li>\n<li><code>/etc/nginx/&#123;koi-win, koi-utf, win-utf&#125;</code>：编码转换配置文件；</li>\n<li><code>/etc/nginx/mime.types</code>：设置http协议的Content-Type与扩展名对应关系的配置文件；</li>\n<li><code>/var/cache/nginx</code>：用于缓存的目录；</li>\n<li><code>/var/log/nginx</code>：日志目录；</li>\n</ul>\n<h2 id=\"nginx启动\"><a href=\"#nginx启动\" class=\"headerlink\" title=\"nginx启动\"></a>nginx启动</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 启动</span></span><br><span class=\"line\">systemctl start nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 开机自启动</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看nginx状态</span></span><br><span class=\"line\">systemctl status nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 停止nginx</span></span><br><span class=\"line\">systemctl stop nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启</span></span><br><span class=\"line\">systemctl restart nginx</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"源码方式部署\"><a href=\"#源码方式部署\" class=\"headerlink\" title=\"源码方式部署\"></a>源码方式部署</h1><h2 id=\"安装依赖-1\"><a href=\"#安装依赖-1\" class=\"headerlink\" title=\"安装依赖\"></a>安装依赖</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"下载源码包\"><a href=\"#下载源码包\" class=\"headerlink\" title=\"下载源码包\"></a>下载源码包</h2><p>这里我使用的是1.18.0版本</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://nginx.org/download/nginx-1.18.0.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加用户和组</span></span><br><span class=\"line\">groupadd nginx</span><br><span class=\"line\">useradd -g nginx nginx </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编译安装</span></span><br><span class=\"line\">tar zxf nginx-1.18.0.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> nginx-1.18.0</span><br><span class=\"line\">./configure \\</span><br><span class=\"line\">--user=nginx \\</span><br><span class=\"line\">--group=nginx \\</span><br><span class=\"line\">--prefix=/usr/<span class=\"built_in\">local</span>/nginx \\</span><br><span class=\"line\">--with-http_ssl_module \\</span><br><span class=\"line\">--with-http_stub_status_module \\</span><br><span class=\"line\">--with-http_realip_module \\</span><br><span class=\"line\">--with-threads</span><br><span class=\"line\"></span><br><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 设置环境变量</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export PATH=<span class=\"variable\">$PATH</span>:/usr/local/nginx/sbin&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>根据实际需求增减编译的模块</p>\n</blockquote>\n<h2 id=\"检查\"><a href=\"#检查\" class=\"headerlink\" title=\"检查\"></a>检查</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -v</span><br><span class=\"line\">nginx -V</span><br></pre></td></tr></table></figure>\n\n\n\n<p><img src=\"./install_source.png\" alt=\"\"></p>\n<h2 id=\"设置启动文件\"><a href=\"#设置启动文件\" class=\"headerlink\" title=\"设置启动文件\"></a>设置启动文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /usr/lib/systemd/system/nginx.service &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">[Unit]</span></span><br><span class=\"line\"><span class=\"string\">Description=nginx service</span></span><br><span class=\"line\"><span class=\"string\">After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Service]</span></span><br><span class=\"line\"><span class=\"string\">Type=forking</span></span><br><span class=\"line\"><span class=\"string\">ExecStart=/usr/local/nginx/sbin/nginx</span></span><br><span class=\"line\"><span class=\"string\">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span></span><br><span class=\"line\"><span class=\"string\">ExecStop=/usr/local/nginx/sbin/nginx -s quit</span></span><br><span class=\"line\"><span class=\"string\">PrivateTmp=true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[Install]</span></span><br><span class=\"line\"><span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"启动nginx\"><a href=\"#启动nginx\" class=\"headerlink\" title=\"启动nginx\"></a>启动nginx</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl start nginx</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nginx</span><br><span class=\"line\">systemctl status nginx</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"安装的文件\"><a href=\"#安装的文件\" class=\"headerlink\" title=\"安装的文件\"></a>安装的文件</h2><p>在编译的时候指定了nginx的安装目录为：<code>--prefix=/usr/local/nginx</code>，安装后会有以下文件：</p>\n<ul>\n<li><code>conf</code>：配置文件目录；<ul>\n<li><code>fastcgi.conf</code>：fastcgi配置文件；</li>\n<li><code>mime.types</code>：设置http协议的Content-Type与扩展名对应关系的配置文件；</li>\n<li><code>uwsgi_params</code>：uwsgi配置文件；</li>\n<li><code>koi-win, koi-utf, win-utf</code>：编码转换配置文件；</li>\n<li><code>scgi_params</code>：scgi配置文件；</li>\n<li><code>fastcgi_params</code>：fastcgi配置文件；</li>\n<li><code>nginx.conf</code>：nginx主配置文件；</li>\n</ul>\n</li>\n<li><code>html</code>：默认的静态文件根目录；</li>\n<li><code>sbin</code>：二进制命令文件目录；</li>\n</ul>\n"},{"title":"升级集群到1.18","date":"2021-04-13T00:49:28.000Z","description":"通过kubeadm升级集群到1.18版本","cover":"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic2.zhimg.com%2Fv2-63997184325ff1f331454c8d9ae0a495_1200x500.jpg&refer=http%3A%2F%2Fpic2.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620867442&t=ae4310844b4d591ea758de96756b9461","_content":"\n{% note info 'fas fa-bullhorn' %}\n\n在之前的文章 {% post_link kubeadm部署k8s-1-18集群 kubeadm部署1.17集群 %} 中部署了一个1.17版本的集群，这次对这个集群进行升级。\n\n更新于 2021-04-13\n\n{% endnote %}\n\n<br>\n\n\n\n## 检查 kubeadm 可用版本\n\n```bash\nyum list kubeadm --showduplicates\n```\n\n<img src=\"./newversion.png\" style=\"zoom:50%;\" />\n\n\n\n>  这里我们当前的版本为1.17，下面升级到1.18.0。\n\n<br>\n\n\n\n## 升级 kubeadm\n\n建议一台一台升级，批量操作存在无法预估的错误。这里先升级第一台master的kubeadm。\n\n```bash\nyum install -y kubeadm-1.18.0-0\nkubeadm version\n```\n\n![](./update-kubeadm.png)\n\n<br>\n\n\n\n## 隔离 master1\n\n先将master1隔离，使用`drain`命令可以优雅地结束节点的pod并将节点设置为不可调度：\n\n```bash\nkubectl drain sca-lum700007 --ignore-daemonsets\n```\n\n<img src=\"./drain.png\" style=\"zoom:50%;\" />\n\n> 看到第一个master已经处于不可调度的状态了。\n\n<br>\n\n\n\n## 升级 kubernetes\n\n```bash\nkubeadm upgrade apply v1.18.0\n```\n\n当出现下面的输出内容时，表示命令执行成功了。\n\n![](./update.png)\n\n<br>\n\n\n\n## 取消隔离master1\n\n```bash\nkubectl uncordon sca-lum700007\n```\n\n<br>\n\n\n\n## 升级 kubectl 和 kubelet\n\n```bash\nyum install -y kubelet-1.18.0-0 kubectl-1.18.0-0\n```\n\n<br>\n\n\n\n## 重启kubelet\n\n```bash\nsystemctl daemon-reload\nsystemctl restart kubelet\n```\n\n<br>\n\n\n\n## 确认节点升级成功\n\n```bash\nkubectl get node\n```\n\n<img src=\"./carbon.png\" style=\"zoom:50%;\" />\n\n\n\n**可以看到第一个节点已经升级成为1.18.0版本的了。后续几个master节点也是按照上边的步骤升级**\n\n<br>\n\n\n\n## 升级node节点\n\nnode节点的升级最好也是一个一个来，首先将node节点驱逐：\n\n```bash\nkubectl drain sca-lum700013 --ignore-daemonsets\n```\n\n\n\n然后在节点上执行下面的命令，升级kubernetes：\n\n```bash\nkubeadm upgrade node\n```\n\n![](./update-node.png)\n\n\n\n在master上取消禁止调度：\n\n```bash\nkubectl uncordon sca-lum00013\n```\n\n\n\n升级worker节点上的kubelet：\n\n```bash\nyum install -y kubelet-1.18.0-0\nsystemctl daemon-reload\nsystemctl restart kubelet\n```\n\n\n\n<br>\n\n## 注意事项\n\n\n\n需要注意的是：\n\n- 跨多个版本升级需要注意，最好不要一次升上去，防止出现问题；\n- 升级的时候先从master开始，再升级worker；\n- 升级的时候一个一个节点的进行，要先驱逐节点的pod并设置为不可调度；\n\n\n\n最后，所有的节点都升级完毕：\n\n<img src=\"./update-res.png\" style=\"zoom:50%;\" />\n\n","source":"_posts/升级集群到1-18.md","raw":"---\ntitle: 升级集群到1.18\ndate: 2021-04-13 08:49:28\ntags:\n- Kubernetes\ncategories:\n- Kubernetes\n- 集群部署\ndescription: 通过kubeadm升级集群到1.18版本\ncover: https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic2.zhimg.com%2Fv2-63997184325ff1f331454c8d9ae0a495_1200x500.jpg&refer=http%3A%2F%2Fpic2.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620867442&t=ae4310844b4d591ea758de96756b9461\n---\n\n{% note info 'fas fa-bullhorn' %}\n\n在之前的文章 {% post_link kubeadm部署k8s-1-18集群 kubeadm部署1.17集群 %} 中部署了一个1.17版本的集群，这次对这个集群进行升级。\n\n更新于 2021-04-13\n\n{% endnote %}\n\n<br>\n\n\n\n## 检查 kubeadm 可用版本\n\n```bash\nyum list kubeadm --showduplicates\n```\n\n<img src=\"./newversion.png\" style=\"zoom:50%;\" />\n\n\n\n>  这里我们当前的版本为1.17，下面升级到1.18.0。\n\n<br>\n\n\n\n## 升级 kubeadm\n\n建议一台一台升级，批量操作存在无法预估的错误。这里先升级第一台master的kubeadm。\n\n```bash\nyum install -y kubeadm-1.18.0-0\nkubeadm version\n```\n\n![](./update-kubeadm.png)\n\n<br>\n\n\n\n## 隔离 master1\n\n先将master1隔离，使用`drain`命令可以优雅地结束节点的pod并将节点设置为不可调度：\n\n```bash\nkubectl drain sca-lum700007 --ignore-daemonsets\n```\n\n<img src=\"./drain.png\" style=\"zoom:50%;\" />\n\n> 看到第一个master已经处于不可调度的状态了。\n\n<br>\n\n\n\n## 升级 kubernetes\n\n```bash\nkubeadm upgrade apply v1.18.0\n```\n\n当出现下面的输出内容时，表示命令执行成功了。\n\n![](./update.png)\n\n<br>\n\n\n\n## 取消隔离master1\n\n```bash\nkubectl uncordon sca-lum700007\n```\n\n<br>\n\n\n\n## 升级 kubectl 和 kubelet\n\n```bash\nyum install -y kubelet-1.18.0-0 kubectl-1.18.0-0\n```\n\n<br>\n\n\n\n## 重启kubelet\n\n```bash\nsystemctl daemon-reload\nsystemctl restart kubelet\n```\n\n<br>\n\n\n\n## 确认节点升级成功\n\n```bash\nkubectl get node\n```\n\n<img src=\"./carbon.png\" style=\"zoom:50%;\" />\n\n\n\n**可以看到第一个节点已经升级成为1.18.0版本的了。后续几个master节点也是按照上边的步骤升级**\n\n<br>\n\n\n\n## 升级node节点\n\nnode节点的升级最好也是一个一个来，首先将node节点驱逐：\n\n```bash\nkubectl drain sca-lum700013 --ignore-daemonsets\n```\n\n\n\n然后在节点上执行下面的命令，升级kubernetes：\n\n```bash\nkubeadm upgrade node\n```\n\n![](./update-node.png)\n\n\n\n在master上取消禁止调度：\n\n```bash\nkubectl uncordon sca-lum00013\n```\n\n\n\n升级worker节点上的kubelet：\n\n```bash\nyum install -y kubelet-1.18.0-0\nsystemctl daemon-reload\nsystemctl restart kubelet\n```\n\n\n\n<br>\n\n## 注意事项\n\n\n\n需要注意的是：\n\n- 跨多个版本升级需要注意，最好不要一次升上去，防止出现问题；\n- 升级的时候先从master开始，再升级worker；\n- 升级的时候一个一个节点的进行，要先驱逐节点的pod并设置为不可调度；\n\n\n\n最后，所有的节点都升级完毕：\n\n<img src=\"./update-res.png\" style=\"zoom:50%;\" />\n\n","slug":"升级集群到1-18","published":1,"updated":"2021-04-13T00:59:50.041Z","_id":"cknfbac1h000004kl6c9z3i24","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>在之前的文章 <a href=\"/2021/03/28/kubeadm%E9%83%A8%E7%BD%B2k8s-1-18%E9%9B%86%E7%BE%A4/\" title=\"kubeadm部署1.17集群\">kubeadm部署1.17集群</a> 中部署了一个1.17版本的集群，这次对这个集群进行升级。</p><p>更新于 2021-04-13</p>\n          </div>\n\n<br>\n\n\n\n<h2 id=\"检查-kubeadm-可用版本\"><a href=\"#检查-kubeadm-可用版本\" class=\"headerlink\" title=\"检查 kubeadm 可用版本\"></a>检查 kubeadm 可用版本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum list kubeadm --showduplicates</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./newversion.png\" style=\"zoom:50%;\" />\n\n\n\n<blockquote>\n<p> 这里我们当前的版本为1.17，下面升级到1.18.0。</p>\n</blockquote>\n<br>\n\n\n\n<h2 id=\"升级-kubeadm\"><a href=\"#升级-kubeadm\" class=\"headerlink\" title=\"升级 kubeadm\"></a>升级 kubeadm</h2><p>建议一台一台升级，批量操作存在无法预估的错误。这里先升级第一台master的kubeadm。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y kubeadm-1.18.0-0</span><br><span class=\"line\">kubeadm version</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./update-kubeadm.png\" alt=\"\"></p>\n<br>\n\n\n\n<h2 id=\"隔离-master1\"><a href=\"#隔离-master1\" class=\"headerlink\" title=\"隔离 master1\"></a>隔离 master1</h2><p>先将master1隔离，使用<code>drain</code>命令可以优雅地结束节点的pod并将节点设置为不可调度：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl drain sca-lum700007 --ignore-daemonsets</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./drain.png\" style=\"zoom:50%;\" />\n\n<blockquote>\n<p>看到第一个master已经处于不可调度的状态了。</p>\n</blockquote>\n<br>\n\n\n\n<h2 id=\"升级-kubernetes\"><a href=\"#升级-kubernetes\" class=\"headerlink\" title=\"升级 kubernetes\"></a>升级 kubernetes</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm upgrade apply v1.18.0</span><br></pre></td></tr></table></figure>\n\n<p>当出现下面的输出内容时，表示命令执行成功了。</p>\n<p><img src= \"/img/loading.gif\" data-src=\"./update.png\" alt=\"\"></p>\n<br>\n\n\n\n<h2 id=\"取消隔离master1\"><a href=\"#取消隔离master1\" class=\"headerlink\" title=\"取消隔离master1\"></a>取消隔离master1</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl uncordon sca-lum700007</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"升级-kubectl-和-kubelet\"><a href=\"#升级-kubectl-和-kubelet\" class=\"headerlink\" title=\"升级 kubectl 和 kubelet\"></a>升级 kubectl 和 kubelet</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y kubelet-1.18.0-0 kubectl-1.18.0-0</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"重启kubelet\"><a href=\"#重启kubelet\" class=\"headerlink\" title=\"重启kubelet\"></a>重启kubelet</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"确认节点升级成功\"><a href=\"#确认节点升级成功\" class=\"headerlink\" title=\"确认节点升级成功\"></a>确认节点升级成功</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./carbon.png\" style=\"zoom:50%;\" />\n\n\n\n<p><strong>可以看到第一个节点已经升级成为1.18.0版本的了。后续几个master节点也是按照上边的步骤升级</strong></p>\n<br>\n\n\n\n<h2 id=\"升级node节点\"><a href=\"#升级node节点\" class=\"headerlink\" title=\"升级node节点\"></a>升级node节点</h2><p>node节点的升级最好也是一个一个来，首先将node节点驱逐：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl drain sca-lum700013 --ignore-daemonsets</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后在节点上执行下面的命令，升级kubernetes：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm upgrade node</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./update-node.png\" alt=\"\"></p>\n<p>在master上取消禁止调度：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl uncordon sca-lum00013</span><br></pre></td></tr></table></figure>\n\n\n\n<p>升级worker节点上的kubelet：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y kubelet-1.18.0-0</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n<h2 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h2><p>需要注意的是：</p>\n<ul>\n<li>跨多个版本升级需要注意，最好不要一次升上去，防止出现问题；</li>\n<li>升级的时候先从master开始，再升级worker；</li>\n<li>升级的时候一个一个节点的进行，要先驱逐节点的pod并设置为不可调度；</li>\n</ul>\n<p>最后，所有的节点都升级完毕：</p>\n<img src= \"/img/loading.gif\" data-src=\"./update-res.png\" style=\"zoom:50%;\" />\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>在之前的文章 <a href=\"/2021/03/28/kubeadm%E9%83%A8%E7%BD%B2k8s-1-18%E9%9B%86%E7%BE%A4/\" title=\"kubeadm部署1.17集群\">kubeadm部署1.17集群</a> 中部署了一个1.17版本的集群，这次对这个集群进行升级。</p><p>更新于 2021-04-13</p>\n          </div>\n\n<br>\n\n\n\n<h2 id=\"检查-kubeadm-可用版本\"><a href=\"#检查-kubeadm-可用版本\" class=\"headerlink\" title=\"检查 kubeadm 可用版本\"></a>检查 kubeadm 可用版本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum list kubeadm --showduplicates</span><br></pre></td></tr></table></figure>\n\n<img src=\"./newversion.png\" style=\"zoom:50%;\" />\n\n\n\n<blockquote>\n<p> 这里我们当前的版本为1.17，下面升级到1.18.0。</p>\n</blockquote>\n<br>\n\n\n\n<h2 id=\"升级-kubeadm\"><a href=\"#升级-kubeadm\" class=\"headerlink\" title=\"升级 kubeadm\"></a>升级 kubeadm</h2><p>建议一台一台升级，批量操作存在无法预估的错误。这里先升级第一台master的kubeadm。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y kubeadm-1.18.0-0</span><br><span class=\"line\">kubeadm version</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./update-kubeadm.png\" alt=\"\"></p>\n<br>\n\n\n\n<h2 id=\"隔离-master1\"><a href=\"#隔离-master1\" class=\"headerlink\" title=\"隔离 master1\"></a>隔离 master1</h2><p>先将master1隔离，使用<code>drain</code>命令可以优雅地结束节点的pod并将节点设置为不可调度：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl drain sca-lum700007 --ignore-daemonsets</span><br></pre></td></tr></table></figure>\n\n<img src=\"./drain.png\" style=\"zoom:50%;\" />\n\n<blockquote>\n<p>看到第一个master已经处于不可调度的状态了。</p>\n</blockquote>\n<br>\n\n\n\n<h2 id=\"升级-kubernetes\"><a href=\"#升级-kubernetes\" class=\"headerlink\" title=\"升级 kubernetes\"></a>升级 kubernetes</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm upgrade apply v1.18.0</span><br></pre></td></tr></table></figure>\n\n<p>当出现下面的输出内容时，表示命令执行成功了。</p>\n<p><img src=\"./update.png\" alt=\"\"></p>\n<br>\n\n\n\n<h2 id=\"取消隔离master1\"><a href=\"#取消隔离master1\" class=\"headerlink\" title=\"取消隔离master1\"></a>取消隔离master1</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl uncordon sca-lum700007</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"升级-kubectl-和-kubelet\"><a href=\"#升级-kubectl-和-kubelet\" class=\"headerlink\" title=\"升级 kubectl 和 kubelet\"></a>升级 kubectl 和 kubelet</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y kubelet-1.18.0-0 kubectl-1.18.0-0</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"重启kubelet\"><a href=\"#重启kubelet\" class=\"headerlink\" title=\"重启kubelet\"></a>重启kubelet</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"确认节点升级成功\"><a href=\"#确认节点升级成功\" class=\"headerlink\" title=\"确认节点升级成功\"></a>确认节点升级成功</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get node</span><br></pre></td></tr></table></figure>\n\n<img src=\"./carbon.png\" style=\"zoom:50%;\" />\n\n\n\n<p><strong>可以看到第一个节点已经升级成为1.18.0版本的了。后续几个master节点也是按照上边的步骤升级</strong></p>\n<br>\n\n\n\n<h2 id=\"升级node节点\"><a href=\"#升级node节点\" class=\"headerlink\" title=\"升级node节点\"></a>升级node节点</h2><p>node节点的升级最好也是一个一个来，首先将node节点驱逐：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl drain sca-lum700013 --ignore-daemonsets</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后在节点上执行下面的命令，升级kubernetes：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm upgrade node</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./update-node.png\" alt=\"\"></p>\n<p>在master上取消禁止调度：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl uncordon sca-lum00013</span><br></pre></td></tr></table></figure>\n\n\n\n<p>升级worker节点上的kubelet：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y kubelet-1.18.0-0</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart kubelet</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n<h2 id=\"注意事项\"><a href=\"#注意事项\" class=\"headerlink\" title=\"注意事项\"></a>注意事项</h2><p>需要注意的是：</p>\n<ul>\n<li>跨多个版本升级需要注意，最好不要一次升上去，防止出现问题；</li>\n<li>升级的时候先从master开始，再升级worker；</li>\n<li>升级的时候一个一个节点的进行，要先驱逐节点的pod并设置为不可调度；</li>\n</ul>\n<p>最后，所有的节点都升级完毕：</p>\n<img src=\"./update-res.png\" style=\"zoom:50%;\" />\n\n"},{"title":"kafka常用命令操作","date":"2021-04-17T04:04:37.000Z","description":"kafka的命令行常用操作","cover":"https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=1860660051,254729202&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在kafka中常用的命令行常用操作\n\n更新于 2021-04-17\n\n{% endnote %}\n\n<br>\n\n\n\n# topic相关命令\n\n\n\n## 创建topic\n\n```bash\nkafka-topics.sh --create --bootstrap-server 172.17.0.2:9092,172.17.0.3:9092,172.17.0.4:9092 --replication-factor 3 --partitions 3 --topic kafka_data\n```\n\n\n\n- `--bootstrap-server`：指定要哪台Kafka服务器上创建Topic，主机加端口，指定的主机地址一定要和配置文件中的listeners一致；\n- `--replication-factor`：创建Topic中的每个分区(partition)中的复制因子数量，即为Topic的副本数量，建议和Broker节点数量一致，如果复制因子超出Broker节点将无法创建；\n- `--partitions`：创建该Topic中的分区(partition)数量；\n- `--topic`：指定Topic名称；\n\n\n\n> 如果创建的topic包含\"_.\"之类的符号会收到警告，但是不会影响创建。\n\n\n\n## 查看topic\n\n```bash\nkafka-topics.sh --list --bootstrap-server 172.17.0.2:9092,172.17.0.3:9092,172.17.0.4:9092\n```\n\n- `--bootstrap-server`：指定查看哪一台kafka上的topic，这里查看所有节点的（也可以查看某一个节点）；\n\n\n\n## 查看topic详情\n\n```bash\nkafka-topics.sh --describe --bootstrap-server 172.17.0.2:9092 --topic kafka_data\n\nTopic:kafka_data    PartitionCount:3    ReplicationFactor:3    Configs:segment.bytes=1073741824\n    Topic: kafka_data    Partition: 0    Leader: 1    Replicas: 1,2,3    Isr: 1,2,3\n    Topic: kafka_data    Partition: 1    Leader: 2    Replicas: 2,3,1    Isr: 2,3,1\n    Topic: kafka_data    Partition: 2    Leader: 3    Replicas: 3,1,2    Isr: 3,1,2\n```\n\n- `Topic:kafka_data`：topic名称\n- `PartitionCount:3`：分片数量\n- `ReplicationFactor:3`：Topic副本数量\n\n\n\n## 修改topic分区数\n\n**注意：topic分区数只能增大，不能减少**\n\n```bash\nkafka-topics.sh --alter --bootstrap-server 9.235.152.125:9092 --topic kafka_data --partitions 30\n```\n\n> 修改topic：kafka_data 的分区数为30\n\n\n\n## 删除topic\n\n```bash\nkafka-topics.sh --delete --bootstrap-server 172.17.0.2:9092 --topic kafka_data\n```\n\n\n\n> 在node1节点删除了Topic，三台节点会同步更新，所以我们的`kafka_data`在三台node上全部删除\n\n\n\n注意，这个操作只会标记topic为删除状态，想要永久删除，需要登录zookeeper进行删除topic数据：\n\n```bash\n# 在zookeeper上执行下面的命令登录\nbin/zkCli.sh -server <zookeeper-host:port>\n\n# 登录后执行下面的操作\nrmr /brokers/topics/<topicname>\n```\n\n\n\n<br>\n\n\n\n# 消息相关命令\n\n\n\n## 发送消息\n\n```bash\nkafka-console-producer.sh --broker-list 172.17.0.2:9092 --topic kafka_data\n>Hello Kafka_data\n>I'm the 172.17.0.2 Kafka create\n>test\n```\n\n- `--broker-list`：指定使用哪台broker来生产消息\n- `--topic`：指定要往哪个Topic中生产消息\n\n\n\n## 消费消息\n\n```bash\nkafka-console-consumer.sh --bootstrap-server 172.17.0.4:9092 --topic kafka_data --from-beginning \n\nI'm the 172.17.0.2 Kafka create\ntest\nHello Kafka_data\n```\n\n","source":"_posts/kafka常用命令操作.md","raw":"---\ntitle: kafka常用命令操作\ndate: 2021-04-17 12:04:37\ntags:\n- Kafka\ncategories:\n- 消息中间件\n- Kafka\n- 常用命令\ndescription: kafka的命令行常用操作\ncover: https://ss3.bdstatic.com/70cFv8Sh_Q1YnxGkpoWK1HF6hhy/it/u=1860660051,254729202&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在kafka中常用的命令行常用操作\n\n更新于 2021-04-17\n\n{% endnote %}\n\n<br>\n\n\n\n# topic相关命令\n\n\n\n## 创建topic\n\n```bash\nkafka-topics.sh --create --bootstrap-server 172.17.0.2:9092,172.17.0.3:9092,172.17.0.4:9092 --replication-factor 3 --partitions 3 --topic kafka_data\n```\n\n\n\n- `--bootstrap-server`：指定要哪台Kafka服务器上创建Topic，主机加端口，指定的主机地址一定要和配置文件中的listeners一致；\n- `--replication-factor`：创建Topic中的每个分区(partition)中的复制因子数量，即为Topic的副本数量，建议和Broker节点数量一致，如果复制因子超出Broker节点将无法创建；\n- `--partitions`：创建该Topic中的分区(partition)数量；\n- `--topic`：指定Topic名称；\n\n\n\n> 如果创建的topic包含\"_.\"之类的符号会收到警告，但是不会影响创建。\n\n\n\n## 查看topic\n\n```bash\nkafka-topics.sh --list --bootstrap-server 172.17.0.2:9092,172.17.0.3:9092,172.17.0.4:9092\n```\n\n- `--bootstrap-server`：指定查看哪一台kafka上的topic，这里查看所有节点的（也可以查看某一个节点）；\n\n\n\n## 查看topic详情\n\n```bash\nkafka-topics.sh --describe --bootstrap-server 172.17.0.2:9092 --topic kafka_data\n\nTopic:kafka_data    PartitionCount:3    ReplicationFactor:3    Configs:segment.bytes=1073741824\n    Topic: kafka_data    Partition: 0    Leader: 1    Replicas: 1,2,3    Isr: 1,2,3\n    Topic: kafka_data    Partition: 1    Leader: 2    Replicas: 2,3,1    Isr: 2,3,1\n    Topic: kafka_data    Partition: 2    Leader: 3    Replicas: 3,1,2    Isr: 3,1,2\n```\n\n- `Topic:kafka_data`：topic名称\n- `PartitionCount:3`：分片数量\n- `ReplicationFactor:3`：Topic副本数量\n\n\n\n## 修改topic分区数\n\n**注意：topic分区数只能增大，不能减少**\n\n```bash\nkafka-topics.sh --alter --bootstrap-server 9.235.152.125:9092 --topic kafka_data --partitions 30\n```\n\n> 修改topic：kafka_data 的分区数为30\n\n\n\n## 删除topic\n\n```bash\nkafka-topics.sh --delete --bootstrap-server 172.17.0.2:9092 --topic kafka_data\n```\n\n\n\n> 在node1节点删除了Topic，三台节点会同步更新，所以我们的`kafka_data`在三台node上全部删除\n\n\n\n注意，这个操作只会标记topic为删除状态，想要永久删除，需要登录zookeeper进行删除topic数据：\n\n```bash\n# 在zookeeper上执行下面的命令登录\nbin/zkCli.sh -server <zookeeper-host:port>\n\n# 登录后执行下面的操作\nrmr /brokers/topics/<topicname>\n```\n\n\n\n<br>\n\n\n\n# 消息相关命令\n\n\n\n## 发送消息\n\n```bash\nkafka-console-producer.sh --broker-list 172.17.0.2:9092 --topic kafka_data\n>Hello Kafka_data\n>I'm the 172.17.0.2 Kafka create\n>test\n```\n\n- `--broker-list`：指定使用哪台broker来生产消息\n- `--topic`：指定要往哪个Topic中生产消息\n\n\n\n## 消费消息\n\n```bash\nkafka-console-consumer.sh --bootstrap-server 172.17.0.4:9092 --topic kafka_data --from-beginning \n\nI'm the 172.17.0.2 Kafka create\ntest\nHello Kafka_data\n```\n\n","slug":"kafka常用命令操作","published":1,"updated":"2021-04-17T04:09:51.959Z","_id":"cknl8040c00008hklbdpvcc2r","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在kafka中常用的命令行常用操作</p><p>更新于 2021-04-17</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"topic相关命令\"><a href=\"#topic相关命令\" class=\"headerlink\" title=\"topic相关命令\"></a>topic相关命令</h1><h2 id=\"创建topic\"><a href=\"#创建topic\" class=\"headerlink\" title=\"创建topic\"></a>创建topic</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --create --bootstrap-server 172.17.0.2:9092,172.17.0.3:9092,172.17.0.4:9092 --replication-factor 3 --partitions 3 --topic kafka_data</span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><code>--bootstrap-server</code>：指定要哪台Kafka服务器上创建Topic，主机加端口，指定的主机地址一定要和配置文件中的listeners一致；</li>\n<li><code>--replication-factor</code>：创建Topic中的每个分区(partition)中的复制因子数量，即为Topic的副本数量，建议和Broker节点数量一致，如果复制因子超出Broker节点将无法创建；</li>\n<li><code>--partitions</code>：创建该Topic中的分区(partition)数量；</li>\n<li><code>--topic</code>：指定Topic名称；</li>\n</ul>\n<blockquote>\n<p>如果创建的topic包含”_.”之类的符号会收到警告，但是不会影响创建。</p>\n</blockquote>\n<h2 id=\"查看topic\"><a href=\"#查看topic\" class=\"headerlink\" title=\"查看topic\"></a>查看topic</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --list --bootstrap-server 172.17.0.2:9092,172.17.0.3:9092,172.17.0.4:9092</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>--bootstrap-server</code>：指定查看哪一台kafka上的topic，这里查看所有节点的（也可以查看某一个节点）；</li>\n</ul>\n<h2 id=\"查看topic详情\"><a href=\"#查看topic详情\" class=\"headerlink\" title=\"查看topic详情\"></a>查看topic详情</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --describe --bootstrap-server 172.17.0.2:9092 --topic kafka_data</span><br><span class=\"line\"></span><br><span class=\"line\">Topic:kafka_data    PartitionCount:3    ReplicationFactor:3    Configs:segment.bytes=1073741824</span><br><span class=\"line\">    Topic: kafka_data    Partition: 0    Leader: 1    Replicas: 1,2,3    Isr: 1,2,3</span><br><span class=\"line\">    Topic: kafka_data    Partition: 1    Leader: 2    Replicas: 2,3,1    Isr: 2,3,1</span><br><span class=\"line\">    Topic: kafka_data    Partition: 2    Leader: 3    Replicas: 3,1,2    Isr: 3,1,2</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>Topic:kafka_data</code>：topic名称</li>\n<li><code>PartitionCount:3</code>：分片数量</li>\n<li><code>ReplicationFactor:3</code>：Topic副本数量</li>\n</ul>\n<h2 id=\"修改topic分区数\"><a href=\"#修改topic分区数\" class=\"headerlink\" title=\"修改topic分区数\"></a>修改topic分区数</h2><p><strong>注意：topic分区数只能增大，不能减少</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --alter --bootstrap-server 9.235.152.125:9092 --topic kafka_data --partitions 30</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>修改topic：kafka_data 的分区数为30</p>\n</blockquote>\n<h2 id=\"删除topic\"><a href=\"#删除topic\" class=\"headerlink\" title=\"删除topic\"></a>删除topic</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --delete --bootstrap-server 172.17.0.2:9092 --topic kafka_data</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>在node1节点删除了Topic，三台节点会同步更新，所以我们的<code>kafka_data</code>在三台node上全部删除</p>\n</blockquote>\n<p>注意，这个操作只会标记topic为删除状态，想要永久删除，需要登录zookeeper进行删除topic数据：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在zookeeper上执行下面的命令登录</span></span><br><span class=\"line\">bin/zkCli.sh -server &lt;zookeeper-host:port&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 登录后执行下面的操作</span></span><br><span class=\"line\">rmr /brokers/topics/&lt;topicname&gt;</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"消息相关命令\"><a href=\"#消息相关命令\" class=\"headerlink\" title=\"消息相关命令\"></a>消息相关命令</h1><h2 id=\"发送消息\"><a href=\"#发送消息\" class=\"headerlink\" title=\"发送消息\"></a>发送消息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-console-producer.sh --broker-list 172.17.0.2:9092 --topic kafka_data</span><br><span class=\"line\">&gt;Hello Kafka_data</span><br><span class=\"line\">&gt;I<span class=\"string\">&#x27;m the 172.17.0.2 Kafka create</span></span><br><span class=\"line\"><span class=\"string\">&gt;test</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>--broker-list</code>：指定使用哪台broker来生产消息</li>\n<li><code>--topic</code>：指定要往哪个Topic中生产消息</li>\n</ul>\n<h2 id=\"消费消息\"><a href=\"#消费消息\" class=\"headerlink\" title=\"消费消息\"></a>消费消息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-console-consumer.sh --bootstrap-server 172.17.0.4:9092 --topic kafka_data --from-beginning </span><br><span class=\"line\"></span><br><span class=\"line\">I<span class=\"string\">&#x27;m the 172.17.0.2 Kafka create</span></span><br><span class=\"line\"><span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"string\">Hello Kafka_data</span></span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在kafka中常用的命令行常用操作</p><p>更新于 2021-04-17</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"topic相关命令\"><a href=\"#topic相关命令\" class=\"headerlink\" title=\"topic相关命令\"></a>topic相关命令</h1><h2 id=\"创建topic\"><a href=\"#创建topic\" class=\"headerlink\" title=\"创建topic\"></a>创建topic</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --create --bootstrap-server 172.17.0.2:9092,172.17.0.3:9092,172.17.0.4:9092 --replication-factor 3 --partitions 3 --topic kafka_data</span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><code>--bootstrap-server</code>：指定要哪台Kafka服务器上创建Topic，主机加端口，指定的主机地址一定要和配置文件中的listeners一致；</li>\n<li><code>--replication-factor</code>：创建Topic中的每个分区(partition)中的复制因子数量，即为Topic的副本数量，建议和Broker节点数量一致，如果复制因子超出Broker节点将无法创建；</li>\n<li><code>--partitions</code>：创建该Topic中的分区(partition)数量；</li>\n<li><code>--topic</code>：指定Topic名称；</li>\n</ul>\n<blockquote>\n<p>如果创建的topic包含”_.”之类的符号会收到警告，但是不会影响创建。</p>\n</blockquote>\n<h2 id=\"查看topic\"><a href=\"#查看topic\" class=\"headerlink\" title=\"查看topic\"></a>查看topic</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --list --bootstrap-server 172.17.0.2:9092,172.17.0.3:9092,172.17.0.4:9092</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>--bootstrap-server</code>：指定查看哪一台kafka上的topic，这里查看所有节点的（也可以查看某一个节点）；</li>\n</ul>\n<h2 id=\"查看topic详情\"><a href=\"#查看topic详情\" class=\"headerlink\" title=\"查看topic详情\"></a>查看topic详情</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --describe --bootstrap-server 172.17.0.2:9092 --topic kafka_data</span><br><span class=\"line\"></span><br><span class=\"line\">Topic:kafka_data    PartitionCount:3    ReplicationFactor:3    Configs:segment.bytes=1073741824</span><br><span class=\"line\">    Topic: kafka_data    Partition: 0    Leader: 1    Replicas: 1,2,3    Isr: 1,2,3</span><br><span class=\"line\">    Topic: kafka_data    Partition: 1    Leader: 2    Replicas: 2,3,1    Isr: 2,3,1</span><br><span class=\"line\">    Topic: kafka_data    Partition: 2    Leader: 3    Replicas: 3,1,2    Isr: 3,1,2</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>Topic:kafka_data</code>：topic名称</li>\n<li><code>PartitionCount:3</code>：分片数量</li>\n<li><code>ReplicationFactor:3</code>：Topic副本数量</li>\n</ul>\n<h2 id=\"修改topic分区数\"><a href=\"#修改topic分区数\" class=\"headerlink\" title=\"修改topic分区数\"></a>修改topic分区数</h2><p><strong>注意：topic分区数只能增大，不能减少</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --alter --bootstrap-server 9.235.152.125:9092 --topic kafka_data --partitions 30</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>修改topic：kafka_data 的分区数为30</p>\n</blockquote>\n<h2 id=\"删除topic\"><a href=\"#删除topic\" class=\"headerlink\" title=\"删除topic\"></a>删除topic</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-topics.sh --delete --bootstrap-server 172.17.0.2:9092 --topic kafka_data</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>在node1节点删除了Topic，三台节点会同步更新，所以我们的<code>kafka_data</code>在三台node上全部删除</p>\n</blockquote>\n<p>注意，这个操作只会标记topic为删除状态，想要永久删除，需要登录zookeeper进行删除topic数据：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在zookeeper上执行下面的命令登录</span></span><br><span class=\"line\">bin/zkCli.sh -server &lt;zookeeper-host:port&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 登录后执行下面的操作</span></span><br><span class=\"line\">rmr /brokers/topics/&lt;topicname&gt;</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h1 id=\"消息相关命令\"><a href=\"#消息相关命令\" class=\"headerlink\" title=\"消息相关命令\"></a>消息相关命令</h1><h2 id=\"发送消息\"><a href=\"#发送消息\" class=\"headerlink\" title=\"发送消息\"></a>发送消息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-console-producer.sh --broker-list 172.17.0.2:9092 --topic kafka_data</span><br><span class=\"line\">&gt;Hello Kafka_data</span><br><span class=\"line\">&gt;I<span class=\"string\">&#x27;m the 172.17.0.2 Kafka create</span></span><br><span class=\"line\"><span class=\"string\">&gt;test</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><code>--broker-list</code>：指定使用哪台broker来生产消息</li>\n<li><code>--topic</code>：指定要往哪个Topic中生产消息</li>\n</ul>\n<h2 id=\"消费消息\"><a href=\"#消费消息\" class=\"headerlink\" title=\"消费消息\"></a>消费消息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kafka-console-consumer.sh --bootstrap-server 172.17.0.4:9092 --topic kafka_data --from-beginning </span><br><span class=\"line\"></span><br><span class=\"line\">I<span class=\"string\">&#x27;m the 172.17.0.2 Kafka create</span></span><br><span class=\"line\"><span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"string\">Hello Kafka_data</span></span><br></pre></td></tr></table></figure>\n\n"},{"title":"zookeeper常用命令行操作","date":"2021-04-17T04:14:35.000Z","description":"zookeeper日常用到的操作","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在zookeeper中日常用到的命令行操作\n\n更新于 2021-04-17\n\n{% endnote %}\n\n<br>\n\n\n\n\n\n## 登录zookeeper shell\n\n使用如下命令连接本地的zookeeper：\n\n```bash\nbin/zkCli.sh\n```\n\n\n\n<br>\n\n\n\n## 节点操作\n\n### 查看节点\n\n使用下面的命令查看都有哪些节点：\n\n```bash\n[zk: localhost:2181(CONNECTED) 1] ls /\n```\n\n![](./ls.png)\n\n> 默认只有一个zookeeper节点\n\n\n\n### 创建一个节点\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] create /workers \"\"\nCreated /workers\n[zk: localhost:2181(CONNECTED) 10] ls /\n[workers, zookeeper]\n```\n\n\n\n> 当创建/workers节点后指定了一个空字符串(\"\")，说明此刻不希望在这个znode中保存数据。然而，该接口中的这个参数可以使我们保存任何字符串到ZooKeeper的节点中。比如，可以替 换\"\"为\"workers\"。\n\n\n\n### 创建带序号的节点\n\n如果此时再次支执行`create /workers \"\"`，则会报错：`Node already exists`，此时可以使用`-s`参数表示创建一个带序号的节点：\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] create -s /workers \"\"\nCreated /workers000000002\n```\n\n\n\n> 带序号的节点会把序号追加到节点名字后且全局唯一\n\n\n\n### 创建临时节点\n\n在`create`的时候使用`-e`可以创建临时节点：\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] create -e /tmpnode \"\"\nCreated /tmnpnode\n```\n\n\n\n当创建临时节点的会话中断之后，临时节点就会消失；\n\n\n\n### 注册到节点\n\n通知客户端zookeeper节点数据变化是zookeeper的一个重要功能，使用如下的命令可以将当前会话注册到zookeeper：\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] ls -w / \n```\n\n> `-w`表示`watch`，意思是监控当前的节点，如果节点发生变化则会被zookeepr通知\n\n\n\n此时如果`/`节点发生了变化，则这个会话会收到通知：`WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/`\n\n\n\n\n\n### 查看节点状态\n\n使用下面的命令可以查看节点的状态：\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] state /workers\n```\n\n\n\n其中会输出如下内容：\n\n- `czxid`：创建节点的事物id；\n- `ctime`：创建该节点的时间；\n- `mZxid`：修改该节点的事物id；\n- `pZxid`：最后一次修改子节点的zxid；\n- `cversion`：子节点修改次数；\n- `dataversion`：当前节点修改次数；\n- `aclVersion`：访问控制列表变化的次数；\n\n\n\n\n\n### 删除节点\n\n```bash\n[zk: localhost:2181(CONNECTED) 11] delete /workers\n[zk: localhost:2181(CONNECTED) 12] ls /\n[zookeeper]\n```\n\n\n\n`delete`只能删除没有子节点的节点，如果要递归删除则使用`deleteall`：\n\n```bash\n[zk: localhost:2181(CONNECTED) 11] deleteall /workers\n```\n\n\n\n<br>\n\n\n\n## 退出shell\n\n```bash\n[zk: localhost:2181(CONNECTED) 13] quit\n\nWATCHER::\n\nWatchedEvent state:Closed type:None path:null\n2020-12-12 15:14:16,594 [myid:] - INFO  [main:ZooKeeper@1422] - Session: 0x100f8067ce90000 closed\n2020-12-12 15:14:16,594 [myid:] - INFO  [main-EventThread:ClientCnxn$EventThread@524] - EventThread shut down for session: 0x100f8067ce90000\n```\n\n","source":"_posts/zookeeper常用命令行操作.md","raw":"---\ntitle: zookeeper常用命令行操作\ndate: 2021-04-17 12:14:35\ntags:\n- Zookeeper\ncategories: \n- Zookeeper\n- 常用操作 \ndescription: zookeeper日常用到的操作\ncover: \n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在zookeeper中日常用到的命令行操作\n\n更新于 2021-04-17\n\n{% endnote %}\n\n<br>\n\n\n\n\n\n## 登录zookeeper shell\n\n使用如下命令连接本地的zookeeper：\n\n```bash\nbin/zkCli.sh\n```\n\n\n\n<br>\n\n\n\n## 节点操作\n\n### 查看节点\n\n使用下面的命令查看都有哪些节点：\n\n```bash\n[zk: localhost:2181(CONNECTED) 1] ls /\n```\n\n![](./ls.png)\n\n> 默认只有一个zookeeper节点\n\n\n\n### 创建一个节点\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] create /workers \"\"\nCreated /workers\n[zk: localhost:2181(CONNECTED) 10] ls /\n[workers, zookeeper]\n```\n\n\n\n> 当创建/workers节点后指定了一个空字符串(\"\")，说明此刻不希望在这个znode中保存数据。然而，该接口中的这个参数可以使我们保存任何字符串到ZooKeeper的节点中。比如，可以替 换\"\"为\"workers\"。\n\n\n\n### 创建带序号的节点\n\n如果此时再次支执行`create /workers \"\"`，则会报错：`Node already exists`，此时可以使用`-s`参数表示创建一个带序号的节点：\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] create -s /workers \"\"\nCreated /workers000000002\n```\n\n\n\n> 带序号的节点会把序号追加到节点名字后且全局唯一\n\n\n\n### 创建临时节点\n\n在`create`的时候使用`-e`可以创建临时节点：\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] create -e /tmpnode \"\"\nCreated /tmnpnode\n```\n\n\n\n当创建临时节点的会话中断之后，临时节点就会消失；\n\n\n\n### 注册到节点\n\n通知客户端zookeeper节点数据变化是zookeeper的一个重要功能，使用如下的命令可以将当前会话注册到zookeeper：\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] ls -w / \n```\n\n> `-w`表示`watch`，意思是监控当前的节点，如果节点发生变化则会被zookeepr通知\n\n\n\n此时如果`/`节点发生了变化，则这个会话会收到通知：`WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/`\n\n\n\n\n\n### 查看节点状态\n\n使用下面的命令可以查看节点的状态：\n\n```bash\n[zk: localhost:2181(CONNECTED) 9] state /workers\n```\n\n\n\n其中会输出如下内容：\n\n- `czxid`：创建节点的事物id；\n- `ctime`：创建该节点的时间；\n- `mZxid`：修改该节点的事物id；\n- `pZxid`：最后一次修改子节点的zxid；\n- `cversion`：子节点修改次数；\n- `dataversion`：当前节点修改次数；\n- `aclVersion`：访问控制列表变化的次数；\n\n\n\n\n\n### 删除节点\n\n```bash\n[zk: localhost:2181(CONNECTED) 11] delete /workers\n[zk: localhost:2181(CONNECTED) 12] ls /\n[zookeeper]\n```\n\n\n\n`delete`只能删除没有子节点的节点，如果要递归删除则使用`deleteall`：\n\n```bash\n[zk: localhost:2181(CONNECTED) 11] deleteall /workers\n```\n\n\n\n<br>\n\n\n\n## 退出shell\n\n```bash\n[zk: localhost:2181(CONNECTED) 13] quit\n\nWATCHER::\n\nWatchedEvent state:Closed type:None path:null\n2020-12-12 15:14:16,594 [myid:] - INFO  [main:ZooKeeper@1422] - Session: 0x100f8067ce90000 closed\n2020-12-12 15:14:16,594 [myid:] - INFO  [main-EventThread:ClientCnxn$EventThread@524] - EventThread shut down for session: 0x100f8067ce90000\n```\n\n","slug":"zookeeper常用命令行操作","published":1,"updated":"2021-04-17T04:17:47.941Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cknl8cbi8000085kl4px89d56","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在zookeeper中日常用到的命令行操作</p><p>更新于 2021-04-17</p>\n          </div>\n\n<br>\n\n\n\n\n\n<h2 id=\"登录zookeeper-shell\"><a href=\"#登录zookeeper-shell\" class=\"headerlink\" title=\"登录zookeeper shell\"></a>登录zookeeper shell</h2><p>使用如下命令连接本地的zookeeper：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkCli.sh</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"节点操作\"><a href=\"#节点操作\" class=\"headerlink\" title=\"节点操作\"></a>节点操作</h2><h3 id=\"查看节点\"><a href=\"#查看节点\" class=\"headerlink\" title=\"查看节点\"></a>查看节点</h3><p>使用下面的命令查看都有哪些节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 1] ls /</span><br></pre></td></tr></table></figure>\n\n<p><img src= \"/img/loading.gif\" data-src=\"./ls.png\" alt=\"\"></p>\n<blockquote>\n<p>默认只有一个zookeeper节点</p>\n</blockquote>\n<h3 id=\"创建一个节点\"><a href=\"#创建一个节点\" class=\"headerlink\" title=\"创建一个节点\"></a>创建一个节点</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] create /workers <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">Created /workers</span><br><span class=\"line\">[zk: localhost:2181(CONNECTED) 10] ls /</span><br><span class=\"line\">[workers, zookeeper]</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>当创建/workers节点后指定了一个空字符串(“”)，说明此刻不希望在这个znode中保存数据。然而，该接口中的这个参数可以使我们保存任何字符串到ZooKeeper的节点中。比如，可以替 换””为”workers”。</p>\n</blockquote>\n<h3 id=\"创建带序号的节点\"><a href=\"#创建带序号的节点\" class=\"headerlink\" title=\"创建带序号的节点\"></a>创建带序号的节点</h3><p>如果此时再次支执行<code>create /workers &quot;&quot;</code>，则会报错：<code>Node already exists</code>，此时可以使用<code>-s</code>参数表示创建一个带序号的节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] create -s /workers <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">Created /workers000000002</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>带序号的节点会把序号追加到节点名字后且全局唯一</p>\n</blockquote>\n<h3 id=\"创建临时节点\"><a href=\"#创建临时节点\" class=\"headerlink\" title=\"创建临时节点\"></a>创建临时节点</h3><p>在<code>create</code>的时候使用<code>-e</code>可以创建临时节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] create -e /tmpnode <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">Created /tmnpnode</span><br></pre></td></tr></table></figure>\n\n\n\n<p>当创建临时节点的会话中断之后，临时节点就会消失；</p>\n<h3 id=\"注册到节点\"><a href=\"#注册到节点\" class=\"headerlink\" title=\"注册到节点\"></a>注册到节点</h3><p>通知客户端zookeeper节点数据变化是zookeeper的一个重要功能，使用如下的命令可以将当前会话注册到zookeeper：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] ls -w / </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><code>-w</code>表示<code>watch</code>，意思是监控当前的节点，如果节点发生变化则会被zookeepr通知</p>\n</blockquote>\n<p>此时如果<code>/</code>节点发生了变化，则这个会话会收到通知：<code>WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/</code></p>\n<h3 id=\"查看节点状态\"><a href=\"#查看节点状态\" class=\"headerlink\" title=\"查看节点状态\"></a>查看节点状态</h3><p>使用下面的命令可以查看节点的状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] state /workers</span><br></pre></td></tr></table></figure>\n\n\n\n<p>其中会输出如下内容：</p>\n<ul>\n<li><code>czxid</code>：创建节点的事物id；</li>\n<li><code>ctime</code>：创建该节点的时间；</li>\n<li><code>mZxid</code>：修改该节点的事物id；</li>\n<li><code>pZxid</code>：最后一次修改子节点的zxid；</li>\n<li><code>cversion</code>：子节点修改次数；</li>\n<li><code>dataversion</code>：当前节点修改次数；</li>\n<li><code>aclVersion</code>：访问控制列表变化的次数；</li>\n</ul>\n<h3 id=\"删除节点\"><a href=\"#删除节点\" class=\"headerlink\" title=\"删除节点\"></a>删除节点</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 11] delete /workers</span><br><span class=\"line\">[zk: localhost:2181(CONNECTED) 12] ls /</span><br><span class=\"line\">[zookeeper]</span><br></pre></td></tr></table></figure>\n\n\n\n<p><code>delete</code>只能删除没有子节点的节点，如果要递归删除则使用<code>deleteall</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 11] deleteall /workers</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"退出shell\"><a href=\"#退出shell\" class=\"headerlink\" title=\"退出shell\"></a>退出shell</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 13] quit</span><br><span class=\"line\"></span><br><span class=\"line\">WATCHER::</span><br><span class=\"line\"></span><br><span class=\"line\">WatchedEvent state:Closed <span class=\"built_in\">type</span>:None path:null</span><br><span class=\"line\">2020-12-12 15:14:16,594 [myid:] - INFO  [main:ZooKeeper@1422] - Session: 0x100f8067ce90000 closed</span><br><span class=\"line\">2020-12-12 15:14:16,594 [myid:] - INFO  [main-EventThread:ClientCnxn<span class=\"variable\">$EventThread</span>@524] - EventThread shut down <span class=\"keyword\">for</span> session: 0x100f8067ce90000</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在zookeeper中日常用到的命令行操作</p><p>更新于 2021-04-17</p>\n          </div>\n\n<br>\n\n\n\n\n\n<h2 id=\"登录zookeeper-shell\"><a href=\"#登录zookeeper-shell\" class=\"headerlink\" title=\"登录zookeeper shell\"></a>登录zookeeper shell</h2><p>使用如下命令连接本地的zookeeper：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkCli.sh</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"节点操作\"><a href=\"#节点操作\" class=\"headerlink\" title=\"节点操作\"></a>节点操作</h2><h3 id=\"查看节点\"><a href=\"#查看节点\" class=\"headerlink\" title=\"查看节点\"></a>查看节点</h3><p>使用下面的命令查看都有哪些节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 1] ls /</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"./ls.png\" alt=\"\"></p>\n<blockquote>\n<p>默认只有一个zookeeper节点</p>\n</blockquote>\n<h3 id=\"创建一个节点\"><a href=\"#创建一个节点\" class=\"headerlink\" title=\"创建一个节点\"></a>创建一个节点</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] create /workers <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">Created /workers</span><br><span class=\"line\">[zk: localhost:2181(CONNECTED) 10] ls /</span><br><span class=\"line\">[workers, zookeeper]</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>当创建/workers节点后指定了一个空字符串(“”)，说明此刻不希望在这个znode中保存数据。然而，该接口中的这个参数可以使我们保存任何字符串到ZooKeeper的节点中。比如，可以替 换””为”workers”。</p>\n</blockquote>\n<h3 id=\"创建带序号的节点\"><a href=\"#创建带序号的节点\" class=\"headerlink\" title=\"创建带序号的节点\"></a>创建带序号的节点</h3><p>如果此时再次支执行<code>create /workers &quot;&quot;</code>，则会报错：<code>Node already exists</code>，此时可以使用<code>-s</code>参数表示创建一个带序号的节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] create -s /workers <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">Created /workers000000002</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>带序号的节点会把序号追加到节点名字后且全局唯一</p>\n</blockquote>\n<h3 id=\"创建临时节点\"><a href=\"#创建临时节点\" class=\"headerlink\" title=\"创建临时节点\"></a>创建临时节点</h3><p>在<code>create</code>的时候使用<code>-e</code>可以创建临时节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] create -e /tmpnode <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">Created /tmnpnode</span><br></pre></td></tr></table></figure>\n\n\n\n<p>当创建临时节点的会话中断之后，临时节点就会消失；</p>\n<h3 id=\"注册到节点\"><a href=\"#注册到节点\" class=\"headerlink\" title=\"注册到节点\"></a>注册到节点</h3><p>通知客户端zookeeper节点数据变化是zookeeper的一个重要功能，使用如下的命令可以将当前会话注册到zookeeper：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] ls -w / </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p><code>-w</code>表示<code>watch</code>，意思是监控当前的节点，如果节点发生变化则会被zookeepr通知</p>\n</blockquote>\n<p>此时如果<code>/</code>节点发生了变化，则这个会话会收到通知：<code>WatchedEvent state:SyncConnected type:NodeChildrenChanged path:/</code></p>\n<h3 id=\"查看节点状态\"><a href=\"#查看节点状态\" class=\"headerlink\" title=\"查看节点状态\"></a>查看节点状态</h3><p>使用下面的命令可以查看节点的状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 9] state /workers</span><br></pre></td></tr></table></figure>\n\n\n\n<p>其中会输出如下内容：</p>\n<ul>\n<li><code>czxid</code>：创建节点的事物id；</li>\n<li><code>ctime</code>：创建该节点的时间；</li>\n<li><code>mZxid</code>：修改该节点的事物id；</li>\n<li><code>pZxid</code>：最后一次修改子节点的zxid；</li>\n<li><code>cversion</code>：子节点修改次数；</li>\n<li><code>dataversion</code>：当前节点修改次数；</li>\n<li><code>aclVersion</code>：访问控制列表变化的次数；</li>\n</ul>\n<h3 id=\"删除节点\"><a href=\"#删除节点\" class=\"headerlink\" title=\"删除节点\"></a>删除节点</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 11] delete /workers</span><br><span class=\"line\">[zk: localhost:2181(CONNECTED) 12] ls /</span><br><span class=\"line\">[zookeeper]</span><br></pre></td></tr></table></figure>\n\n\n\n<p><code>delete</code>只能删除没有子节点的节点，如果要递归删除则使用<code>deleteall</code>：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 11] deleteall /workers</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"退出shell\"><a href=\"#退出shell\" class=\"headerlink\" title=\"退出shell\"></a>退出shell</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[zk: localhost:2181(CONNECTED) 13] quit</span><br><span class=\"line\"></span><br><span class=\"line\">WATCHER::</span><br><span class=\"line\"></span><br><span class=\"line\">WatchedEvent state:Closed <span class=\"built_in\">type</span>:None path:null</span><br><span class=\"line\">2020-12-12 15:14:16,594 [myid:] - INFO  [main:ZooKeeper@1422] - Session: 0x100f8067ce90000 closed</span><br><span class=\"line\">2020-12-12 15:14:16,594 [myid:] - INFO  [main-EventThread:ClientCnxn<span class=\"variable\">$EventThread</span>@524] - EventThread shut down <span class=\"keyword\">for</span> session: 0x100f8067ce90000</span><br></pre></td></tr></table></figure>\n\n"},{"title":"部署zookeeper集群","date":"2021-04-17T04:20:08.000Z","description":"部署一个三节点的zookeeper集群","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了部署一个三节点的zookeeper集群\n\n更新于 2021-04-017\n\n{% endnote %}\n\n<br>\n\n\n\n\n\n## 下载\n\n下载地址：http://archive.apache.org/dist/zookeeper/\n\n>  需要下载的包必须带`bin`，这个是编译好的，否则运行会报错\n\n\n\n```bash\nwget http://archive.apache.org/dist/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz\n```\n\n\n\n<br>\n\n\n\n## 安装\n\n下载好的zookeeper压缩包已经经过编译，直接解压就可以用：\n\n```bash\n# 在每个节点都下载\ntar zxf apache-zookeeper-3.5.5-bin.tar.gz \ncd cd apache-zookeeper-3.5.5-bin\n```\n\n\n\n<br>\n\n\n\n## 建立配置文件\n\n默认没有配置文件，可以直接复制配置文件模板：\n\n```bash\n# 在每个节点都执行\nmv conf/zoo_sample.cfg conf/zoo.cfg\n```\n\n\n\n<br>\n\n## 创建数据目录\n\n虽然zookeeper一般数据量不大，但是还是推荐使用单独的数据盘：\n\n```bash\n# 在每个节点都执行\nmkdir /data/zookeeper\n```\n\n\n\n然后在每个节点都修改配置文件的如下字段，使用数据目录：\n\n```bash\n# conf/zoo.cfg\ndataDir=/data/zookeeper\n```\n\n<br>\n\n\n\n## 添加zookeeper节点\n\n在每个节点的配置文件`zoo.cfg`中，添加zookeeper集群每台节点的地址，例如我这里是三节点的集群：\n\n```bash\n# conf/zoo.cfg\n# 增加如下的内容\nserver.2=192.168.12.12:2888:3888\nserver.3=192.168.12.13:2888:3888\nserver.4=192.168.12.14:2888:3888\n```\n\n\n\n> `2888`为zookeeper节点间的通信端口号，`3888`为选举的端口号；主从关系通过`3888`自动选举产生，配置中不需要指定；\n>\n> `server`后面的数字为集群中节点的id，可以随便起但是不能相同；\n\n<br>\n\n## 添加id文件\n\n在上一步中添加了三个节点：\n\n```bash\nserver.2=192.168.12.12:2888:3888\nserver.3=192.168.12.13:2888:3888\nserver.4=192.168.12.14:2888:3888\n```\n\n\n\n现在到`192.168.12.12`这个节点的zookeeper数据目录`/data/zookeeper`下，设置节点id文件：\n\n```bash\ncd /data/zookeeper\necho 2 > myid\n```\n\n\n\n> `myid`这个文件名是固定的不能变；文件的内容就是这个节点的id号，根据配置文件中指定的数字配置；\n\n\n\n其他的节点，需要执行相同的操作，注意id设置为自己的id；\n\n<br>\n\n## 设置日志位置\n\n默认日志位置是放在安装目录下的logs下，可以在`bin/zkENV.sh`中，修改下面的代码进行重新设置：\n\n```bash\n# bin/zkENV.sh\nif [ \"x${ZOO_LOG_DIR}\" = \"x\" ]\nthen\n    ZOO_LOG_DIR=\"/data/zookeeper/logs\"\nfi\n```\n\n\n\n然后创建日志目录：\n\n```bash\nmkdir /data/zookeeper/logs\n```\n\n<br>\n\n## 设置JAVA_HOME\n\n如果需要设置`JAVA_HOME`变量，则可以在`bin/zkENV.sh`的前面设置一个环境变量即可：\n\n```bash\n# bin/zkENV.sh\nexport JAVA_HOME=/java/home/dir\n```\n\n<br>\n\n## 启动\n\n在每个节点都执行启动命令：\n\n```bash\nbin/zkServer.sh start\n```\n\n<br>\n\n## 查看状态\n\n当集群一半以上的节点都启动之后，整个集群才会正常工作，此时执行下面的命令查看服务状态：\n\n```bash\nbin/zkServer.sh status \n```\n\n\n\n如果出现`Mode: follower`则表示该节点为从节点；如果出现`Mode: leader`则表示该节点为主节点\n\n\n\n","source":"_posts/部署zookeeper集群.md","raw":"---\ntitle: 部署zookeeper集群\ndate: 2021-04-17 12:20:08\ntags:\n- Zookeeper\ncategories:\n- Zookeeper\n- 部署\ndescription: 部署一个三节点的zookeeper集群\ncover: \n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了部署一个三节点的zookeeper集群\n\n更新于 2021-04-017\n\n{% endnote %}\n\n<br>\n\n\n\n\n\n## 下载\n\n下载地址：http://archive.apache.org/dist/zookeeper/\n\n>  需要下载的包必须带`bin`，这个是编译好的，否则运行会报错\n\n\n\n```bash\nwget http://archive.apache.org/dist/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz\n```\n\n\n\n<br>\n\n\n\n## 安装\n\n下载好的zookeeper压缩包已经经过编译，直接解压就可以用：\n\n```bash\n# 在每个节点都下载\ntar zxf apache-zookeeper-3.5.5-bin.tar.gz \ncd cd apache-zookeeper-3.5.5-bin\n```\n\n\n\n<br>\n\n\n\n## 建立配置文件\n\n默认没有配置文件，可以直接复制配置文件模板：\n\n```bash\n# 在每个节点都执行\nmv conf/zoo_sample.cfg conf/zoo.cfg\n```\n\n\n\n<br>\n\n## 创建数据目录\n\n虽然zookeeper一般数据量不大，但是还是推荐使用单独的数据盘：\n\n```bash\n# 在每个节点都执行\nmkdir /data/zookeeper\n```\n\n\n\n然后在每个节点都修改配置文件的如下字段，使用数据目录：\n\n```bash\n# conf/zoo.cfg\ndataDir=/data/zookeeper\n```\n\n<br>\n\n\n\n## 添加zookeeper节点\n\n在每个节点的配置文件`zoo.cfg`中，添加zookeeper集群每台节点的地址，例如我这里是三节点的集群：\n\n```bash\n# conf/zoo.cfg\n# 增加如下的内容\nserver.2=192.168.12.12:2888:3888\nserver.3=192.168.12.13:2888:3888\nserver.4=192.168.12.14:2888:3888\n```\n\n\n\n> `2888`为zookeeper节点间的通信端口号，`3888`为选举的端口号；主从关系通过`3888`自动选举产生，配置中不需要指定；\n>\n> `server`后面的数字为集群中节点的id，可以随便起但是不能相同；\n\n<br>\n\n## 添加id文件\n\n在上一步中添加了三个节点：\n\n```bash\nserver.2=192.168.12.12:2888:3888\nserver.3=192.168.12.13:2888:3888\nserver.4=192.168.12.14:2888:3888\n```\n\n\n\n现在到`192.168.12.12`这个节点的zookeeper数据目录`/data/zookeeper`下，设置节点id文件：\n\n```bash\ncd /data/zookeeper\necho 2 > myid\n```\n\n\n\n> `myid`这个文件名是固定的不能变；文件的内容就是这个节点的id号，根据配置文件中指定的数字配置；\n\n\n\n其他的节点，需要执行相同的操作，注意id设置为自己的id；\n\n<br>\n\n## 设置日志位置\n\n默认日志位置是放在安装目录下的logs下，可以在`bin/zkENV.sh`中，修改下面的代码进行重新设置：\n\n```bash\n# bin/zkENV.sh\nif [ \"x${ZOO_LOG_DIR}\" = \"x\" ]\nthen\n    ZOO_LOG_DIR=\"/data/zookeeper/logs\"\nfi\n```\n\n\n\n然后创建日志目录：\n\n```bash\nmkdir /data/zookeeper/logs\n```\n\n<br>\n\n## 设置JAVA_HOME\n\n如果需要设置`JAVA_HOME`变量，则可以在`bin/zkENV.sh`的前面设置一个环境变量即可：\n\n```bash\n# bin/zkENV.sh\nexport JAVA_HOME=/java/home/dir\n```\n\n<br>\n\n## 启动\n\n在每个节点都执行启动命令：\n\n```bash\nbin/zkServer.sh start\n```\n\n<br>\n\n## 查看状态\n\n当集群一半以上的节点都启动之后，整个集群才会正常工作，此时执行下面的命令查看服务状态：\n\n```bash\nbin/zkServer.sh status \n```\n\n\n\n如果出现`Mode: follower`则表示该节点为从节点；如果出现`Mode: leader`则表示该节点为主节点\n\n\n\n","slug":"部署zookeeper集群","published":1,"updated":"2021-04-17T04:25:02.709Z","_id":"cknl8jb070000p8klcm3ka6ws","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了部署一个三节点的zookeeper集群</p><p>更新于 2021-04-017</p>\n          </div>\n\n<br>\n\n\n\n\n\n<h2 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p>下载地址：<a href=\"http://archive.apache.org/dist/zookeeper/\">http://archive.apache.org/dist/zookeeper/</a></p>\n<blockquote>\n<p> 需要下载的包必须带<code>bin</code>，这个是编译好的，否则运行会报错</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://archive.apache.org/dist/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>下载好的zookeeper压缩包已经经过编译，直接解压就可以用：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在每个节点都下载</span></span><br><span class=\"line\">tar zxf apache-zookeeper-3.5.5-bin.tar.gz </span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"built_in\">cd</span> apache-zookeeper-3.5.5-bin</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"建立配置文件\"><a href=\"#建立配置文件\" class=\"headerlink\" title=\"建立配置文件\"></a>建立配置文件</h2><p>默认没有配置文件，可以直接复制配置文件模板：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在每个节点都执行</span></span><br><span class=\"line\">mv conf/zoo_sample.cfg conf/zoo.cfg</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n<h2 id=\"创建数据目录\"><a href=\"#创建数据目录\" class=\"headerlink\" title=\"创建数据目录\"></a>创建数据目录</h2><p>虽然zookeeper一般数据量不大，但是还是推荐使用单独的数据盘：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在每个节点都执行</span></span><br><span class=\"line\">mkdir /data/zookeeper</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后在每个节点都修改配置文件的如下字段，使用数据目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># conf/zoo.cfg</span></span><br><span class=\"line\">dataDir=/data/zookeeper</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"添加zookeeper节点\"><a href=\"#添加zookeeper节点\" class=\"headerlink\" title=\"添加zookeeper节点\"></a>添加zookeeper节点</h2><p>在每个节点的配置文件<code>zoo.cfg</code>中，添加zookeeper集群每台节点的地址，例如我这里是三节点的集群：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># conf/zoo.cfg</span></span><br><span class=\"line\"><span class=\"comment\"># 增加如下的内容</span></span><br><span class=\"line\">server.2=192.168.12.12:2888:3888</span><br><span class=\"line\">server.3=192.168.12.13:2888:3888</span><br><span class=\"line\">server.4=192.168.12.14:2888:3888</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p><code>2888</code>为zookeeper节点间的通信端口号，<code>3888</code>为选举的端口号；主从关系通过<code>3888</code>自动选举产生，配置中不需要指定；</p>\n<p><code>server</code>后面的数字为集群中节点的id，可以随便起但是不能相同；</p>\n</blockquote>\n<br>\n\n<h2 id=\"添加id文件\"><a href=\"#添加id文件\" class=\"headerlink\" title=\"添加id文件\"></a>添加id文件</h2><p>在上一步中添加了三个节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server.2=192.168.12.12:2888:3888</span><br><span class=\"line\">server.3=192.168.12.13:2888:3888</span><br><span class=\"line\">server.4=192.168.12.14:2888:3888</span><br></pre></td></tr></table></figure>\n\n\n\n<p>现在到<code>192.168.12.12</code>这个节点的zookeeper数据目录<code>/data/zookeeper</code>下，设置节点id文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /data/zookeeper</span><br><span class=\"line\"><span class=\"built_in\">echo</span> 2 &gt; myid</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p><code>myid</code>这个文件名是固定的不能变；文件的内容就是这个节点的id号，根据配置文件中指定的数字配置；</p>\n</blockquote>\n<p>其他的节点，需要执行相同的操作，注意id设置为自己的id；</p>\n<br>\n\n<h2 id=\"设置日志位置\"><a href=\"#设置日志位置\" class=\"headerlink\" title=\"设置日志位置\"></a>设置日志位置</h2><p>默认日志位置是放在安装目录下的logs下，可以在<code>bin/zkENV.sh</code>中，修改下面的代码进行重新设置：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># bin/zkENV.sh</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;x<span class=\"variable\">$&#123;ZOO_LOG_DIR&#125;</span>&quot;</span> = <span class=\"string\">&quot;x&quot;</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">    ZOO_LOG_DIR=<span class=\"string\">&quot;/data/zookeeper/logs&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后创建日志目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /data/zookeeper/logs</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"设置JAVA-HOME\"><a href=\"#设置JAVA-HOME\" class=\"headerlink\" title=\"设置JAVA_HOME\"></a>设置JAVA_HOME</h2><p>如果需要设置<code>JAVA_HOME</code>变量，则可以在<code>bin/zkENV.sh</code>的前面设置一个环境变量即可：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># bin/zkENV.sh</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_HOME=/java/home/dir</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h2><p>在每个节点都执行启动命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh start</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"查看状态\"><a href=\"#查看状态\" class=\"headerlink\" title=\"查看状态\"></a>查看状态</h2><p>当集群一半以上的节点都启动之后，整个集群才会正常工作，此时执行下面的命令查看服务状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh status </span><br></pre></td></tr></table></figure>\n\n\n\n<p>如果出现<code>Mode: follower</code>则表示该节点为从节点；如果出现<code>Mode: leader</code>则表示该节点为主节点</p>\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了部署一个三节点的zookeeper集群</p><p>更新于 2021-04-017</p>\n          </div>\n\n<br>\n\n\n\n\n\n<h2 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h2><p>下载地址：<a href=\"http://archive.apache.org/dist/zookeeper/\">http://archive.apache.org/dist/zookeeper/</a></p>\n<blockquote>\n<p> 需要下载的包必须带<code>bin</code>，这个是编译好的，否则运行会报错</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://archive.apache.org/dist/zookeeper/zookeeper-3.5.5/apache-zookeeper-3.5.5-bin.tar.gz</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>下载好的zookeeper压缩包已经经过编译，直接解压就可以用：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在每个节点都下载</span></span><br><span class=\"line\">tar zxf apache-zookeeper-3.5.5-bin.tar.gz </span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"built_in\">cd</span> apache-zookeeper-3.5.5-bin</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n\n\n<h2 id=\"建立配置文件\"><a href=\"#建立配置文件\" class=\"headerlink\" title=\"建立配置文件\"></a>建立配置文件</h2><p>默认没有配置文件，可以直接复制配置文件模板：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在每个节点都执行</span></span><br><span class=\"line\">mv conf/zoo_sample.cfg conf/zoo.cfg</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n<h2 id=\"创建数据目录\"><a href=\"#创建数据目录\" class=\"headerlink\" title=\"创建数据目录\"></a>创建数据目录</h2><p>虽然zookeeper一般数据量不大，但是还是推荐使用单独的数据盘：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在每个节点都执行</span></span><br><span class=\"line\">mkdir /data/zookeeper</span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后在每个节点都修改配置文件的如下字段，使用数据目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># conf/zoo.cfg</span></span><br><span class=\"line\">dataDir=/data/zookeeper</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h2 id=\"添加zookeeper节点\"><a href=\"#添加zookeeper节点\" class=\"headerlink\" title=\"添加zookeeper节点\"></a>添加zookeeper节点</h2><p>在每个节点的配置文件<code>zoo.cfg</code>中，添加zookeeper集群每台节点的地址，例如我这里是三节点的集群：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># conf/zoo.cfg</span></span><br><span class=\"line\"><span class=\"comment\"># 增加如下的内容</span></span><br><span class=\"line\">server.2=192.168.12.12:2888:3888</span><br><span class=\"line\">server.3=192.168.12.13:2888:3888</span><br><span class=\"line\">server.4=192.168.12.14:2888:3888</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p><code>2888</code>为zookeeper节点间的通信端口号，<code>3888</code>为选举的端口号；主从关系通过<code>3888</code>自动选举产生，配置中不需要指定；</p>\n<p><code>server</code>后面的数字为集群中节点的id，可以随便起但是不能相同；</p>\n</blockquote>\n<br>\n\n<h2 id=\"添加id文件\"><a href=\"#添加id文件\" class=\"headerlink\" title=\"添加id文件\"></a>添加id文件</h2><p>在上一步中添加了三个节点：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server.2=192.168.12.12:2888:3888</span><br><span class=\"line\">server.3=192.168.12.13:2888:3888</span><br><span class=\"line\">server.4=192.168.12.14:2888:3888</span><br></pre></td></tr></table></figure>\n\n\n\n<p>现在到<code>192.168.12.12</code>这个节点的zookeeper数据目录<code>/data/zookeeper</code>下，设置节点id文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /data/zookeeper</span><br><span class=\"line\"><span class=\"built_in\">echo</span> 2 &gt; myid</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p><code>myid</code>这个文件名是固定的不能变；文件的内容就是这个节点的id号，根据配置文件中指定的数字配置；</p>\n</blockquote>\n<p>其他的节点，需要执行相同的操作，注意id设置为自己的id；</p>\n<br>\n\n<h2 id=\"设置日志位置\"><a href=\"#设置日志位置\" class=\"headerlink\" title=\"设置日志位置\"></a>设置日志位置</h2><p>默认日志位置是放在安装目录下的logs下，可以在<code>bin/zkENV.sh</code>中，修改下面的代码进行重新设置：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># bin/zkENV.sh</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;x<span class=\"variable\">$&#123;ZOO_LOG_DIR&#125;</span>&quot;</span> = <span class=\"string\">&quot;x&quot;</span> ]</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">    ZOO_LOG_DIR=<span class=\"string\">&quot;/data/zookeeper/logs&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>然后创建日志目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /data/zookeeper/logs</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"设置JAVA-HOME\"><a href=\"#设置JAVA-HOME\" class=\"headerlink\" title=\"设置JAVA_HOME\"></a>设置JAVA_HOME</h2><p>如果需要设置<code>JAVA_HOME</code>变量，则可以在<code>bin/zkENV.sh</code>的前面设置一个环境变量即可：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># bin/zkENV.sh</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> JAVA_HOME=/java/home/dir</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h2><p>在每个节点都执行启动命令：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh start</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h2 id=\"查看状态\"><a href=\"#查看状态\" class=\"headerlink\" title=\"查看状态\"></a>查看状态</h2><p>当集群一半以上的节点都启动之后，整个集群才会正常工作，此时执行下面的命令查看服务状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bin/zkServer.sh status </span><br></pre></td></tr></table></figure>\n\n\n\n<p>如果出现<code>Mode: follower</code>则表示该节点为从节点；如果出现<code>Mode: leader</code>则表示该节点为主节点</p>\n"},{"title":"docker方式部署zookeeper集群","date":"2021-04-17T04:24:13.000Z","description":"使用docker方式部署zookeeper集群","cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用docker方式部署zookeeper集群\n\n更新于 2021-04-017\n\n{% endnote %}\n\n<br>\n\n\n\n# 创建目录\n\n在每个节点都创建数据和日志目录：\n\n```bash\nmkdir -p /data/zookeeper/data\nmkdir -p /data/zookeeper/logs\n```\n\n<br>\n\n\n\n# 下载镜像\n\n这里使用的是3.5.5版本的zookeeper：\n\n```bash\ndocker pull zookeeper:3.5.5\n```\n\n<br>\n\n# 创建配置文件\n\n配置文件的内容如下：\n\n```bash\ncat > /data/zookeeper/zoo.cfg << EOF\nclientPort=2181\ndataDir=/data/zookeeper/data\ndataLogDir=/data/zookeeper/logs\ntickTime=2000\ninitLimit=5\nsyncLimit=2\nautopurge.snapRetainCount=3\nautopurge.purgeInterval=0\nmaxClientCnxns=60\nstandaloneEnabled=false\nadmin.enableServer=true\n4lw.commands.whitelist=*\nserver.2=192.168.12.12:2888:3888\nserver.3=192.168.12.13:2888:3888\nserver.4=192.168.12.14:2888:3888\nserver.5=192.168.12.15:2888:3888\nserver.6=192.168.12.16:2888:3888\nEOF\n```\n\n\n\n- `clientPort`：服务监听的端口；\n- `dataDir`：数据目录；\n- `dataLogDir`：顺序日志目录；\n- `tickTime`：心跳间隔；\n- `autopurge.snapRetainCount`：保留多少个snapshot，之前的会删除；\n- `autopurge.purgeInterval`：多久会清理一次数据（0表示不清理）；\n- `maxClientCnxns`：客户端连接数限制；\n- `standaloneEnabled`：在启动脚本中关闭管理控制台；\n- `4lw.commands.whitelist`：白名单；\n\n\n\n> 注意修改配置文件中的server配置，**配置文件需要在每个节点都创建**\n\n<br>\n\n\n\n\n\n# 生成myid文件\n\n根据预先设置的myid，在每个节点的`/data/zookeeper/data`下创建一个`myid`文件：\n\n```bash\necho 2 > /data/zookeeper/data/myid\n```\n\n\n\n> 注意每个节点的myid文件内容不一样\n\n<br>\n\n\n\n# 启动zookeeper\n\n在每个节点分别执行下面的命令启动zookeeper：\n\n```bash\ndocker run \\\n    --name zookeeper \\\n    --network=host \\\n    --restart always \\\n    -v /data/zookeeper/zoo.cfg:/conf/zoo.cfg \\\n    -v /data/zookeeper:/data/zookeeper \\\n    -v /etc/localtime:/etc/localtime:ro \\\n    -d zookeeper:3.5.5\n```\n\n","source":"_posts/docker方式部署zookeeper集群.md","raw":"---\ntitle: docker方式部署zookeeper集群\ndate: 2021-04-17 12:24:13\ntags:\n- Zookeeper\ncategories:\n- Zookeeper\n- 部署\ndescription: 使用docker方式部署zookeeper集群\ncover:\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了使用docker方式部署zookeeper集群\n\n更新于 2021-04-017\n\n{% endnote %}\n\n<br>\n\n\n\n# 创建目录\n\n在每个节点都创建数据和日志目录：\n\n```bash\nmkdir -p /data/zookeeper/data\nmkdir -p /data/zookeeper/logs\n```\n\n<br>\n\n\n\n# 下载镜像\n\n这里使用的是3.5.5版本的zookeeper：\n\n```bash\ndocker pull zookeeper:3.5.5\n```\n\n<br>\n\n# 创建配置文件\n\n配置文件的内容如下：\n\n```bash\ncat > /data/zookeeper/zoo.cfg << EOF\nclientPort=2181\ndataDir=/data/zookeeper/data\ndataLogDir=/data/zookeeper/logs\ntickTime=2000\ninitLimit=5\nsyncLimit=2\nautopurge.snapRetainCount=3\nautopurge.purgeInterval=0\nmaxClientCnxns=60\nstandaloneEnabled=false\nadmin.enableServer=true\n4lw.commands.whitelist=*\nserver.2=192.168.12.12:2888:3888\nserver.3=192.168.12.13:2888:3888\nserver.4=192.168.12.14:2888:3888\nserver.5=192.168.12.15:2888:3888\nserver.6=192.168.12.16:2888:3888\nEOF\n```\n\n\n\n- `clientPort`：服务监听的端口；\n- `dataDir`：数据目录；\n- `dataLogDir`：顺序日志目录；\n- `tickTime`：心跳间隔；\n- `autopurge.snapRetainCount`：保留多少个snapshot，之前的会删除；\n- `autopurge.purgeInterval`：多久会清理一次数据（0表示不清理）；\n- `maxClientCnxns`：客户端连接数限制；\n- `standaloneEnabled`：在启动脚本中关闭管理控制台；\n- `4lw.commands.whitelist`：白名单；\n\n\n\n> 注意修改配置文件中的server配置，**配置文件需要在每个节点都创建**\n\n<br>\n\n\n\n\n\n# 生成myid文件\n\n根据预先设置的myid，在每个节点的`/data/zookeeper/data`下创建一个`myid`文件：\n\n```bash\necho 2 > /data/zookeeper/data/myid\n```\n\n\n\n> 注意每个节点的myid文件内容不一样\n\n<br>\n\n\n\n# 启动zookeeper\n\n在每个节点分别执行下面的命令启动zookeeper：\n\n```bash\ndocker run \\\n    --name zookeeper \\\n    --network=host \\\n    --restart always \\\n    -v /data/zookeeper/zoo.cfg:/conf/zoo.cfg \\\n    -v /data/zookeeper:/data/zookeeper \\\n    -v /etc/localtime:/etc/localtime:ro \\\n    -d zookeeper:3.5.5\n```\n\n","slug":"docker方式部署zookeeper集群","published":1,"updated":"2021-04-17T04:26:42.786Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cknl8nt5u00001lkl7lht833n","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用docker方式部署zookeeper集群</p><p>更新于 2021-04-017</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"创建目录\"><a href=\"#创建目录\" class=\"headerlink\" title=\"创建目录\"></a>创建目录</h1><p>在每个节点都创建数据和日志目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /data/zookeeper/data</span><br><span class=\"line\">mkdir -p /data/zookeeper/logs</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"下载镜像\"><a href=\"#下载镜像\" class=\"headerlink\" title=\"下载镜像\"></a>下载镜像</h1><p>这里使用的是3.5.5版本的zookeeper：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull zookeeper:3.5.5</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h1 id=\"创建配置文件\"><a href=\"#创建配置文件\" class=\"headerlink\" title=\"创建配置文件\"></a>创建配置文件</h1><p>配置文件的内容如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /data/zookeeper/zoo.cfg &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">clientPort=2181</span></span><br><span class=\"line\"><span class=\"string\">dataDir=/data/zookeeper/data</span></span><br><span class=\"line\"><span class=\"string\">dataLogDir=/data/zookeeper/logs</span></span><br><span class=\"line\"><span class=\"string\">tickTime=2000</span></span><br><span class=\"line\"><span class=\"string\">initLimit=5</span></span><br><span class=\"line\"><span class=\"string\">syncLimit=2</span></span><br><span class=\"line\"><span class=\"string\">autopurge.snapRetainCount=3</span></span><br><span class=\"line\"><span class=\"string\">autopurge.purgeInterval=0</span></span><br><span class=\"line\"><span class=\"string\">maxClientCnxns=60</span></span><br><span class=\"line\"><span class=\"string\">standaloneEnabled=false</span></span><br><span class=\"line\"><span class=\"string\">admin.enableServer=true</span></span><br><span class=\"line\"><span class=\"string\">4lw.commands.whitelist=*</span></span><br><span class=\"line\"><span class=\"string\">server.2=192.168.12.12:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">server.3=192.168.12.13:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">server.4=192.168.12.14:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">server.5=192.168.12.15:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">server.6=192.168.12.16:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><code>clientPort</code>：服务监听的端口；</li>\n<li><code>dataDir</code>：数据目录；</li>\n<li><code>dataLogDir</code>：顺序日志目录；</li>\n<li><code>tickTime</code>：心跳间隔；</li>\n<li><code>autopurge.snapRetainCount</code>：保留多少个snapshot，之前的会删除；</li>\n<li><code>autopurge.purgeInterval</code>：多久会清理一次数据（0表示不清理）；</li>\n<li><code>maxClientCnxns</code>：客户端连接数限制；</li>\n<li><code>standaloneEnabled</code>：在启动脚本中关闭管理控制台；</li>\n<li><code>4lw.commands.whitelist</code>：白名单；</li>\n</ul>\n<blockquote>\n<p>注意修改配置文件中的server配置，<strong>配置文件需要在每个节点都创建</strong></p>\n</blockquote>\n<br>\n\n\n\n\n\n<h1 id=\"生成myid文件\"><a href=\"#生成myid文件\" class=\"headerlink\" title=\"生成myid文件\"></a>生成myid文件</h1><p>根据预先设置的myid，在每个节点的<code>/data/zookeeper/data</code>下创建一个<code>myid</code>文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> 2 &gt; /data/zookeeper/data/myid</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>注意每个节点的myid文件内容不一样</p>\n</blockquote>\n<br>\n\n\n\n<h1 id=\"启动zookeeper\"><a href=\"#启动zookeeper\" class=\"headerlink\" title=\"启动zookeeper\"></a>启动zookeeper</h1><p>在每个节点分别执行下面的命令启动zookeeper：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run \\</span><br><span class=\"line\">    --name zookeeper \\</span><br><span class=\"line\">    --network=host \\</span><br><span class=\"line\">    --restart always \\</span><br><span class=\"line\">    -v /data/zookeeper/zoo.cfg:/conf/zoo.cfg \\</span><br><span class=\"line\">    -v /data/zookeeper:/data/zookeeper \\</span><br><span class=\"line\">    -v /etc/localtime:/etc/localtime:ro \\</span><br><span class=\"line\">    -d zookeeper:3.5.5</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了使用docker方式部署zookeeper集群</p><p>更新于 2021-04-017</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"创建目录\"><a href=\"#创建目录\" class=\"headerlink\" title=\"创建目录\"></a>创建目录</h1><p>在每个节点都创建数据和日志目录：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p /data/zookeeper/data</span><br><span class=\"line\">mkdir -p /data/zookeeper/logs</span><br></pre></td></tr></table></figure>\n\n<br>\n\n\n\n<h1 id=\"下载镜像\"><a href=\"#下载镜像\" class=\"headerlink\" title=\"下载镜像\"></a>下载镜像</h1><p>这里使用的是3.5.5版本的zookeeper：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull zookeeper:3.5.5</span><br></pre></td></tr></table></figure>\n\n<br>\n\n<h1 id=\"创建配置文件\"><a href=\"#创建配置文件\" class=\"headerlink\" title=\"创建配置文件\"></a>创建配置文件</h1><p>配置文件的内容如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt; /data/zookeeper/zoo.cfg &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">clientPort=2181</span></span><br><span class=\"line\"><span class=\"string\">dataDir=/data/zookeeper/data</span></span><br><span class=\"line\"><span class=\"string\">dataLogDir=/data/zookeeper/logs</span></span><br><span class=\"line\"><span class=\"string\">tickTime=2000</span></span><br><span class=\"line\"><span class=\"string\">initLimit=5</span></span><br><span class=\"line\"><span class=\"string\">syncLimit=2</span></span><br><span class=\"line\"><span class=\"string\">autopurge.snapRetainCount=3</span></span><br><span class=\"line\"><span class=\"string\">autopurge.purgeInterval=0</span></span><br><span class=\"line\"><span class=\"string\">maxClientCnxns=60</span></span><br><span class=\"line\"><span class=\"string\">standaloneEnabled=false</span></span><br><span class=\"line\"><span class=\"string\">admin.enableServer=true</span></span><br><span class=\"line\"><span class=\"string\">4lw.commands.whitelist=*</span></span><br><span class=\"line\"><span class=\"string\">server.2=192.168.12.12:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">server.3=192.168.12.13:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">server.4=192.168.12.14:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">server.5=192.168.12.15:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">server.6=192.168.12.16:2888:3888</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><code>clientPort</code>：服务监听的端口；</li>\n<li><code>dataDir</code>：数据目录；</li>\n<li><code>dataLogDir</code>：顺序日志目录；</li>\n<li><code>tickTime</code>：心跳间隔；</li>\n<li><code>autopurge.snapRetainCount</code>：保留多少个snapshot，之前的会删除；</li>\n<li><code>autopurge.purgeInterval</code>：多久会清理一次数据（0表示不清理）；</li>\n<li><code>maxClientCnxns</code>：客户端连接数限制；</li>\n<li><code>standaloneEnabled</code>：在启动脚本中关闭管理控制台；</li>\n<li><code>4lw.commands.whitelist</code>：白名单；</li>\n</ul>\n<blockquote>\n<p>注意修改配置文件中的server配置，<strong>配置文件需要在每个节点都创建</strong></p>\n</blockquote>\n<br>\n\n\n\n\n\n<h1 id=\"生成myid文件\"><a href=\"#生成myid文件\" class=\"headerlink\" title=\"生成myid文件\"></a>生成myid文件</h1><p>根据预先设置的myid，在每个节点的<code>/data/zookeeper/data</code>下创建一个<code>myid</code>文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> 2 &gt; /data/zookeeper/data/myid</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>注意每个节点的myid文件内容不一样</p>\n</blockquote>\n<br>\n\n\n\n<h1 id=\"启动zookeeper\"><a href=\"#启动zookeeper\" class=\"headerlink\" title=\"启动zookeeper\"></a>启动zookeeper</h1><p>在每个节点分别执行下面的命令启动zookeeper：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run \\</span><br><span class=\"line\">    --name zookeeper \\</span><br><span class=\"line\">    --network=host \\</span><br><span class=\"line\">    --restart always \\</span><br><span class=\"line\">    -v /data/zookeeper/zoo.cfg:/conf/zoo.cfg \\</span><br><span class=\"line\">    -v /data/zookeeper:/data/zookeeper \\</span><br><span class=\"line\">    -v /etc/localtime:/etc/localtime:ro \\</span><br><span class=\"line\">    -d zookeeper:3.5.5</span><br></pre></td></tr></table></figure>\n\n"}],"PostAsset":[{"_id":"source/_posts/在k8s中部署RabbitMQ/bushu.png","slug":"bushu.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署RabbitMQ/client_log.png","slug":"client_log.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署RabbitMQ/log.png","slug":"log.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署RabbitMQ/service.png","slug":"service.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署RabbitMQ/web.png","slug":"web.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/pod.png","slug":"pod.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v1.png","slug":"v1.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2.png","slug":"v2.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-wight.png","slug":"v2-wight.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-ha.png","slug":"v2-ha.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-never.png","slug":"v2-never.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-true.png","slug":"v2-true.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署redis集群/cluster.png","slug":"cluster.png","post":"ckmhnxqql0000rekl24iihiwh","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署redis集群/create.png","slug":"create.png","post":"ckmhnxqql0000rekl24iihiwh","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署redis集群/detail.png","slug":"detail.png","post":"ckmhnxqql0000rekl24iihiwh","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署redis集群/info.png","slug":"info.png","post":"ckmhnxqql0000rekl24iihiwh","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署mysql主从集群/zhucong.png","slug":"zhucong.png","post":"ckmhomleh00009akldrlddunm","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用nfs存储/nfs-client.png","slug":"nfs-client.png","post":"ckmm1mich0000tpkldiecb3rx","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用nfs存储/pod-nfs-test.png","slug":"pod-nfs-test.png","post":"ckmm1mich0000tpkldiecb3rx","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用nfs存储/pod-nfs-svc.png","slug":"pod-nfs-svc.png","post":"ckmm1mich0000tpkldiecb3rx","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用nfs存储/pod-nfs.png","slug":"pod-nfs.png","post":"ckmm1mich0000tpkldiecb3rx","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用nfs存储/pv.png","slug":"pv.png","post":"ckmm1mich0000tpkldiecb3rx","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用nfs存储/pvc-nginx.png","slug":"pvc-nginx.png","post":"ckmm1mich0000tpkldiecb3rx","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用nfs存储/pvc.png","slug":"pvc.png","post":"ckmm1mich0000tpkldiecb3rx","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用nfs存储/storageclass-pvc.png","slug":"storageclass-pvc.png","post":"ckmm1mich0000tpkldiecb3rx","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/es-pod.png","slug":"es-pod.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/add-cluster-1.png","slug":"add-cluster-1.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/add-cluster-2.png","slug":"add-cluster-2.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/kafka-pod.png","slug":"kafka-pod.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/configmap.png","slug":"configmap.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/logstash-pod.png","slug":"logstash-pod.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/pod.png","slug":"pod.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/kafka.png","slug":"kafka.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/kibana.png","slug":"kibana.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中使用EFLK进行日志收集/kibana-pod.png","slug":"kibana-pod.png","post":"ckmr8oskh00003nklevtyder2","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/ansible-check.png","slug":"ansible-check.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/calico-ip.png","slug":"calico-ip.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/calico-node.png","slug":"calico-node.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/check-master.png","slug":"check-master.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/cluster-check.png","slug":"cluster-check.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/etcd-cluster.png","slug":"etcd-cluster.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/etcd-helth.png","slug":"etcd-helth.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/etcd-member.png","slug":"etcd-member.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/getnode.png","slug":"getnode.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/ipvs-rule.png","slug":"ipvs-rule.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/ipvs.png","slug":"ipvs.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/kubeadm-init.png","slug":"kubeadm-init.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/nodes.png","slug":"nodes.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/kubeadm部署k8s-1-18集群/single-master.png","slug":"single-master.png","post":"ckmssfie00000h0klhkf821js","modified":0,"renderable":0},{"_id":"source/_posts/使用k3d和traefik快速搭建开发环境/whoami.png","slug":"whoami.png","post":"ckmsthprc0000vwklbrbd652u","modified":0,"renderable":0},{"_id":"source/_posts/使用k3d和traefik快速搭建开发环境/dashboard.png","slug":"dashboard.png","post":"ckmsthprc0000vwklbrbd652u","modified":0,"renderable":0},{"_id":"source/_posts/部署docker-ce/docker-version.png","slug":"docker-version.png","post":"ckn4am84z0000zkkl8pjpc13t","modified":0,"renderable":0},{"_id":"source/_posts/部署harbor镜像仓库/create-user.png","slug":"create-user.png","post":"ckn4auyv90000pcklck1f760r","modified":0,"renderable":0},{"_id":"source/_posts/部署harbor镜像仓库/create.png","slug":"create.png","post":"ckn4auyv90000pcklck1f760r","modified":0,"renderable":0},{"_id":"source/_posts/部署harbor镜像仓库/harbor-login.png","slug":"harbor-login.png","post":"ckn4auyv90000pcklck1f760r","modified":0,"renderable":0},{"_id":"source/_posts/部署harbor镜像仓库/upload-image.png","slug":"upload-image.png","post":"ckn4auyv90000pcklck1f760r","modified":0,"renderable":0},{"_id":"source/_posts/部署单点zookeeper/start.png","slug":"start.png","post":"ckn5olmow0000u5klgjjz7gz8","modified":0,"renderable":0},{"_id":"source/_posts/部署单点zookeeper/status.png","slug":"status.png","post":"ckn5olmow0000u5klgjjz7gz8","modified":0,"renderable":0},{"_id":"source/_posts/部署单点zookeeper/stop.png","slug":"stop.png","post":"ckn5olmow0000u5klgjjz7gz8","modified":0,"renderable":0},{"_id":"source/_posts/部署Nginx/install_source.png","slug":"install_source.png","post":"cknfau64z0000sbklbueccx30","modified":0,"renderable":0},{"_id":"source/_posts/升级集群到1-18/carbon.png","slug":"carbon.png","post":"cknfbac1h000004kl6c9z3i24","modified":0,"renderable":0},{"_id":"source/_posts/升级集群到1-18/drain.png","slug":"drain.png","post":"cknfbac1h000004kl6c9z3i24","modified":0,"renderable":0},{"_id":"source/_posts/升级集群到1-18/newversion.png","slug":"newversion.png","post":"cknfbac1h000004kl6c9z3i24","modified":0,"renderable":0},{"_id":"source/_posts/升级集群到1-18/update-kubeadm.png","slug":"update-kubeadm.png","post":"cknfbac1h000004kl6c9z3i24","modified":0,"renderable":0},{"_id":"source/_posts/升级集群到1-18/update-node.png","slug":"update-node.png","post":"cknfbac1h000004kl6c9z3i24","modified":0,"renderable":0},{"_id":"source/_posts/升级集群到1-18/update-res.png","slug":"update-res.png","post":"cknfbac1h000004kl6c9z3i24","modified":0,"renderable":0},{"_id":"source/_posts/升级集群到1-18/update.png","slug":"update.png","post":"cknfbac1h000004kl6c9z3i24","modified":0,"renderable":0},{"_id":"source/_posts/zookeeper常用命令行操作/ls.png","slug":"ls.png","post":"cknl8cbi8000085kl4px89d56","modified":0,"renderable":0}],"PostCategory":[{"post_id":"ckmhcqa1w0005ihkl8wyy7a8c","category_id":"ckmhcqa1z0006ihklc1vl5jh3","_id":"ckmhcqa21000bihklevu22qfj"},{"post_id":"ckmhcqa1w0005ihkl8wyy7a8c","category_id":"ckmhcqa200009ihklec2k1y6e","_id":"ckmhcqa21000cihklgik30wo1"},{"post_id":"ckmhcqa1w0005ihkl8wyy7a8c","category_id":"ckmhcqa20000aihkl1z5r5ap4","_id":"ckmhcqa21000dihkl3aw6eyfz"},{"post_id":"ckmhedtrq000069kl21spa224","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckmhedtru000569kl4gns4ahw"},{"post_id":"ckmhedtrq000069kl21spa224","category_id":"ckmhedtru000469kl8n316bgc","_id":"ckmhedtru000669kl2jusdwkj"},{"post_id":"ckmhfeglz0000a9kl96lc40q7","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckmhfegm30002a9kl04fz5b96"},{"post_id":"ckmhfeglz0000a9kl96lc40q7","category_id":"ckmhedtru000469kl8n316bgc","_id":"ckmhfegm30003a9kladk7ddeq"},{"post_id":"ckmhnxqql0000rekl24iihiwh","category_id":"ckmhnxqqo0001rekl6vy4gso0","_id":"ckmhnxqqr0006rekl4vlf0dbh"},{"post_id":"ckmhnxqql0000rekl24iihiwh","category_id":"ckmhnxqqq0004rekl8e4o6n3y","_id":"ckmhnxqqr0007rekl37o73pbn"},{"post_id":"ckmhnxqql0000rekl24iihiwh","category_id":"ckmhnxqqq0005rekl0rof3u4y","_id":"ckmhnxqqr0008reklbfnw4eb5"},{"post_id":"ckmhomleh00009akldrlddunm","category_id":"ckmhnxqqo0001rekl6vy4gso0","_id":"ckmhomlen00059akl9zsx07dc"},{"post_id":"ckmhomleh00009akldrlddunm","category_id":"ckmhomlel00029akl2yue81ng","_id":"ckmhomlen00069akl5ilkebhv"},{"post_id":"ckmhomleh00009akldrlddunm","category_id":"ckmhomlem00049akl1aku3r09","_id":"ckmhomlen00079akl7smz5m07"},{"post_id":"ckmiywj6d0000rckldiobffs5","category_id":"ckmhnxqqo0001rekl6vy4gso0","_id":"ckmiywj6q0002rckl9xu96k9c"},{"post_id":"ckmiywj6d0000rckldiobffs5","category_id":"ckmhomlel00029akl2yue81ng","_id":"ckmiywj6q0003rcklfnbog2hg"},{"post_id":"ckmiywj6d0000rckldiobffs5","category_id":"ckmhomlem00049akl1aku3r09","_id":"ckmiywj6q0004rckl06064t6r"},{"post_id":"ckmiz76uz0000i5klf1kh3vak","category_id":"ckmhnxqqo0001rekl6vy4gso0","_id":"ckmiz76v10002i5klfgi8ekcu"},{"post_id":"ckmiz76uz0000i5klf1kh3vak","category_id":"ckmhomlel00029akl2yue81ng","_id":"ckmiz76v10003i5kl590adwud"},{"post_id":"ckmiz76uz0000i5klf1kh3vak","category_id":"ckmhomlem00049akl1aku3r09","_id":"ckmiz76v10004i5klgtiuc3ou"},{"post_id":"ckmm1mich0000tpkldiecb3rx","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckmm1micq0005tpkl06ni20cv"},{"post_id":"ckmm1mich0000tpkldiecb3rx","category_id":"ckmm1micp0002tpkldcks657m","_id":"ckmm1micq0006tpkl95k919is"},{"post_id":"ckmm1mich0000tpkldiecb3rx","category_id":"ckmm1micq0004tpklg7gz7y4d","_id":"ckmm1micq0007tpkl21j387g3"},{"post_id":"ckmm2hjl700006lkl3s4h67o2","category_id":"ckmm2hjla00016lklewircegs","_id":"ckmm2hjle00056lkl3aglfl31"},{"post_id":"ckmm2hjl700006lkl3s4h67o2","category_id":"ckmm2hjld00036lkle3r87h5e","_id":"ckmm2hjle00066lkl8fp85hq6"},{"post_id":"ckmm2hjl700006lkl3s4h67o2","category_id":"ckmm2hjld00046lkl9tkjd5h8","_id":"ckmm2hjle00076lkl32zm6cv9"},{"post_id":"ckmr8oskh00003nklevtyder2","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckmr8oskx00043nkl3xt0djxs"},{"post_id":"ckmr8oskh00003nklevtyder2","category_id":"ckmr8oskw00023nkl0p62535k","_id":"ckmr8osky00063nkl71ne2mlh"},{"post_id":"ckmssfie00000h0klhkf821js","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckmssfie80004h0kldxsw9kst"},{"post_id":"ckmssfie00000h0klhkf821js","category_id":"ckmstgf290000i8klgooka7fy","_id":"ckmstgf2a0001i8kl369yegkx"},{"post_id":"ckmsthprc0000vwklbrbd652u","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckmstj2cq0001wkkl8ii4ami4"},{"post_id":"ckmsthprc0000vwklbrbd652u","category_id":"ckmstgf290000i8klgooka7fy","_id":"ckmstj2cq0002wkkl2ap5dryz"},{"post_id":"ckn4am84z0000zkkl8pjpc13t","category_id":"ckn4am8520001zkkl9zt70kyu","_id":"ckn4am8570005zkklbw598o2b"},{"post_id":"ckn4am84z0000zkkl8pjpc13t","category_id":"ckn4am8560004zkkl2h3f7x0q","_id":"ckn4am8570006zkklejfce06w"},{"post_id":"ckn4auyv90000pcklck1f760r","category_id":"ckn4am8520001zkkl9zt70kyu","_id":"ckn4auyvg0004pcklc4p162xl"},{"post_id":"ckn4auyv90000pcklck1f760r","category_id":"ckn4auyvf0002pckld7fda7xn","_id":"ckn4auyvg0005pcklcv1q6dak"},{"post_id":"ckn5olmow0000u5klgjjz7gz8","category_id":"ckn5olmoz0001u5klc9q15f6g","_id":"ckn5olmp40005u5klbshsh06c"},{"post_id":"ckn5olmow0000u5klgjjz7gz8","category_id":"ckn5olmp30004u5kl93iy22tz","_id":"ckn5olmp40006u5klae1mdcfr"},{"post_id":"ckncle8ll00001akl2f04ggp0","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckncle8lq00021akldsks4zek"},{"post_id":"ckncle8ll00001akl2f04ggp0","category_id":"ckmstgf290000i8klgooka7fy","_id":"ckncllkax000023klcj6o5kl6"},{"post_id":"cknfau64z0000sbklbueccx30","category_id":"cknfau6530001sbkl01vu52dk","_id":"cknfau6580005sbklbse531si"},{"post_id":"cknfau64z0000sbklbueccx30","category_id":"cknfau6580004sbklgcsvabwj","_id":"cknfau6590006sbkl5i74f26c"},{"post_id":"cknfbac1h000004kl6c9z3i24","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"cknfbac1l000204kl932e9ve1"},{"post_id":"cknfbac1h000004kl6c9z3i24","category_id":"ckmstgf290000i8klgooka7fy","_id":"cknfbac1l000304kl22ov35jv"},{"post_id":"cknl8040c00008hklbdpvcc2r","category_id":"ckmhcqa1z0006ihklc1vl5jh3","_id":"cknl8040l00058hkl74x4h5i2"},{"post_id":"cknl8040c00008hklbdpvcc2r","category_id":"cknl8040k00028hklfcy47m0x","_id":"cknl8040m00068hkld1d0gpf0"},{"post_id":"cknl8040c00008hklbdpvcc2r","category_id":"cknl8040l00048hkl0e642uk8","_id":"cknl8040m00078hklca7ocetl"},{"post_id":"cknl8cbi8000085kl4px89d56","category_id":"ckn5olmoz0001u5klc9q15f6g","_id":"cknl8cbif000385klcp3z5nq6"},{"post_id":"cknl8cbi8000085kl4px89d56","category_id":"cknl8cbib000285kla7rd4vfn","_id":"cknl8cbif000485klg10300l0"},{"post_id":"cknl8jb070000p8klcm3ka6ws","category_id":"ckn5olmoz0001u5klc9q15f6g","_id":"cknl8jb0b0002p8kl8ffnabpt"},{"post_id":"cknl8jb070000p8klcm3ka6ws","category_id":"ckn5olmp30004u5kl93iy22tz","_id":"cknl8jb0b0003p8kl2sqq52kc"},{"post_id":"cknl8nt5u00001lkl7lht833n","category_id":"ckn5olmoz0001u5klc9q15f6g","_id":"cknl8nt5z00021lkl1evv6456"},{"post_id":"cknl8nt5u00001lkl7lht833n","category_id":"ckn5olmp30004u5kl93iy22tz","_id":"cknl8nt5z00031lklcq8h94c6"}],"PostTag":[{"post_id":"ckmhcqa1w0005ihkl8wyy7a8c","tag_id":"ckmhcqa1z0007ihkl08q7ftb2","_id":"ckmhcqa200008ihklhscveo6i"},{"post_id":"ckmhedtrq000069kl21spa224","tag_id":"ckmhedtrt000269kl379e6n5x","_id":"ckmhedtrt000369klcp8w3jin"},{"post_id":"ckmhfeglz0000a9kl96lc40q7","tag_id":"ckmhedtrt000269kl379e6n5x","_id":"ckmhfegm30001a9kl7b157g0r"},{"post_id":"ckmhnxqql0000rekl24iihiwh","tag_id":"ckmhnxqqp0002rekl52a8cbil","_id":"ckmhnxqqq0003reklcweo36h5"},{"post_id":"ckmhomleh00009akldrlddunm","tag_id":"ckmhomlek00019aklcmz91yd7","_id":"ckmhomlem00039akldk7i6ojr"},{"post_id":"ckmiywj6d0000rckldiobffs5","tag_id":"ckmhomlek00019aklcmz91yd7","_id":"ckmiywj6q0001rckl13v5fd24"},{"post_id":"ckmiz76uz0000i5klf1kh3vak","tag_id":"ckmhomlek00019aklcmz91yd7","_id":"ckmiz76v00001i5kl68zq4xdb"},{"post_id":"ckmm1mich0000tpkldiecb3rx","tag_id":"ckmm1micn0001tpkl52rraoss","_id":"ckmm1micq0003tpkl8btz9m6e"},{"post_id":"ckmm2hjl700006lkl3s4h67o2","tag_id":"ckmm1micn0001tpkl52rraoss","_id":"ckmm2hjld00026lkl4z3p8dy2"},{"post_id":"ckmr8oskh00003nklevtyder2","tag_id":"ckmr8osks00013nklgzoe7czg","_id":"ckmr8osky00053nkl4z0yh3rq"},{"post_id":"ckmr8oskh00003nklevtyder2","tag_id":"ckmr8oskx00033nkl7vly0d5n","_id":"ckmr8osky00073nklehz8g1wq"},{"post_id":"ckmssfie00000h0klhkf821js","tag_id":"ckmssfie40001h0kld3ro5ast","_id":"ckmssfie80003h0kl0epc4riq"},{"post_id":"ckmsthprc0000vwklbrbd652u","tag_id":"ckmssfie40001h0kld3ro5ast","_id":"ckmstj2cq0000wkkl8dizap61"},{"post_id":"ckn4am84z0000zkkl8pjpc13t","tag_id":"ckn4am8550002zkkl9j70cewm","_id":"ckn4am8560003zkklcx446y2m"},{"post_id":"ckn4auyv90000pcklck1f760r","tag_id":"ckn4auyvc0001pckl5l998ozb","_id":"ckn4auyvf0003pckl6h87gwpw"},{"post_id":"ckn5olmow0000u5klgjjz7gz8","tag_id":"ckn5olmp20002u5klfnb50yvt","_id":"ckn5olmp30003u5kl034v3ry0"},{"post_id":"ckncle8ll00001akl2f04ggp0","tag_id":"ckmssfie40001h0kld3ro5ast","_id":"ckncle8lp00011akl8nsqdcoa"},{"post_id":"cknfau64z0000sbklbueccx30","tag_id":"cknfau6570002sbkl2ne1fo0a","_id":"cknfau6580003sbklcuo59p28"},{"post_id":"cknfbac1h000004kl6c9z3i24","tag_id":"ckmssfie40001h0kld3ro5ast","_id":"cknfbac1k000104kl7mp9ehdm"},{"post_id":"cknl8040c00008hklbdpvcc2r","tag_id":"cknl8040g00018hkl7vqqbq77","_id":"cknl8040l00038hkldj6b2pte"},{"post_id":"cknl8cbi8000085kl4px89d56","tag_id":"ckn5olmp20002u5klfnb50yvt","_id":"cknl8cbib000185kl0osl3pxe"},{"post_id":"cknl8jb070000p8klcm3ka6ws","tag_id":"ckn5olmp20002u5klfnb50yvt","_id":"cknl8jb0b0001p8klcbri0kcq"},{"post_id":"cknl8nt5u00001lkl7lht833n","tag_id":"ckn5olmp20002u5klfnb50yvt","_id":"cknl8nt5z00011lkl7jm6htjg"}],"Tag":[{"name":"RabbitMQ","_id":"ckmhcqa1z0007ihkl08q7ftb2"},{"name":"Ingress","_id":"ckmhedtrt000269kl379e6n5x"},{"name":"Redis","_id":"ckmhnxqqp0002rekl52a8cbil"},{"name":"MySQL","_id":"ckmhomlek00019aklcmz91yd7"},{"name":"NFS","_id":"ckmm1micn0001tpkl52rraoss"},{"name":"K8S","_id":"ckmr8osks00013nklgzoe7czg"},{"name":"日志收集","_id":"ckmr8oskx00033nkl7vly0d5n"},{"name":"Kubernetes","_id":"ckmssfie40001h0kld3ro5ast"},{"name":"Docker","_id":"ckn4am8550002zkkl9j70cewm"},{"name":"Harbor","_id":"ckn4auyvc0001pckl5l998ozb"},{"name":"Zookeeper","_id":"ckn5olmp20002u5klfnb50yvt"},{"name":"Nginx","_id":"cknfau6570002sbkl2ne1fo0a"},{"name":"Kafka","_id":"cknl8040g00018hkl7vqqbq77"}]}}