{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"themes/butterfly/source/css/index.styl","path":"css/index.styl","modified":0,"renderable":1},{"_id":"themes/butterfly/source/css/var.styl","path":"css/var.styl","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/404.jpg","path":"img/404.jpg","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/algolia.svg","path":"img/algolia.svg","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/avator.png","path":"img/avator.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/favicon.png","path":"img/favicon.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/friend_404.gif","path":"img/friend_404.gif","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/icp.png","path":"img/icp.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/loading.gif","path":"img/loading.gif","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/tw_cn.js","path":"js/tw_cn.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/search/algolia.js","path":"js/search/algolia.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/search/local-search.js","path":"js/search/local-search.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/ClickShowText.js","path":"js/third-party/ClickShowText.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/activate-power-mode.js","path":"js/third-party/activate-power-mode.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/canvas-nest.js","path":"js/third-party/canvas-nest.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/canvas-ribbon.js","path":"js/third-party/canvas-ribbon.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/click_heart.js","path":"js/third-party/click_heart.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/fireworks.js","path":"js/third-party/fireworks.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/third-party/piao.js","path":"js/third-party/piao.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"48f01e357230864df594b4549a67d838047b39dd","modified":1600595468717},{"_id":"source/.DS_Store","hash":"a425e6cc89d5d5cfd01ef237ead0cdaf9ea92cba","modified":1616211948456},{"_id":"source/_posts/.DS_Store","hash":"ffa18ae380144d7522b9adb47ab50785608e2d62","modified":1616218048909},{"_id":"source/_posts/在k8s中部署RabbitMQ.md","hash":"bc1e6bb9f515c0830ad7d8c3afdeb5fa4f0199fe","modified":1616224573580},{"_id":"source/archives/index.md","hash":"48a8c6149085940ce0706c2d8cd5efc4606bdec6","modified":1616212573023},{"_id":"source/categories/index-1.md","hash":"99e4ac4fde62b04081c73b9e51ba2a168a67587c","modified":1616212474907},{"_id":"source/categories/index.md","hash":"85bf8b8d10fc11464413d4aebbf69db8588832d7","modified":1599290835590},{"_id":"source/tags/index-1.md","hash":"a757bb59b90734987feb65998f4d416276252d2c","modified":1616212481066},{"_id":"source/tags/index.md","hash":"ed49c4e6c4204d89e0c5838479e499e795c334d7","modified":1599290835590},{"_id":"source/_posts/在k8s中部署RabbitMQ/service.png","hash":"71d9ec668af0d71f6d4109d20edd67ce9b654718","modified":1616217980467},{"_id":"source/_posts/在k8s中部署RabbitMQ/bushu.png","hash":"51b3273b0ed83d2f03df80e5b08903682752c58f","modified":1616217472733},{"_id":"themes/butterfly/LICENSE","hash":"c372b56b7553dafd2d8a8abf12d0dd71b4e2bfc0","modified":1599293200708},{"_id":"themes/butterfly/README.md","hash":"111662216ce7d1ea63d7072aaea2a612543c19a1","modified":1599293200708},{"_id":"themes/butterfly/_config.yml","hash":"f816ea37b346522c157eb9975490cffed33dcee6","modified":1616224680069},{"_id":"themes/butterfly/README_CN.md","hash":"6c17872d3bbd147a86f53a7de7ee193dfd1a9000","modified":1599293200708},{"_id":"themes/butterfly/package.json","hash":"f92db754486cb1cfaaa4b03b869877c922974bee","modified":1599293200723},{"_id":"themes/butterfly/.github/ISSUE_TEMPLATE.md","hash":"bc427d7f13fec05cfd2dcc10953cbb2a96bc31be","modified":1599293200707},{"_id":"themes/butterfly/.github/stale.yml","hash":"cd5a929ce25a6293a9f449e7b80dfe4307326797","modified":1599293200708},{"_id":"themes/butterfly/layout/404.pug","hash":"9ba3cea0f61ad5d0f6cb782fd3da9cf7b4077ae4","modified":1599293200709},{"_id":"themes/butterfly/layout/archive.pug","hash":"bd62286afb64a51c97e800c5945620d51605d5fa","modified":1599293200709},{"_id":"themes/butterfly/layout/category.pug","hash":"d014234c26d2c07caaea6703f7b48cb69c51907d","modified":1599293200709},{"_id":"themes/butterfly/layout/flink.pug","hash":"12571e3b98651d655cab29c01a33663393c66056","modified":1599293200710},{"_id":"themes/butterfly/layout/index.pug","hash":"e1c3146834c16e6077406180858add0a8183875a","modified":1599293200722},{"_id":"themes/butterfly/layout/page.pug","hash":"130ab657a6acfe149dbc59e481dc05d4d7d926a3","modified":1599293200722},{"_id":"themes/butterfly/layout/post.pug","hash":"2e34fd65d36508faec9fd015d6cdb108d4c29b58","modified":1599293200722},{"_id":"themes/butterfly/layout/tag.pug","hash":"3bb2a700c6d709d2757d55d357eed1fca5644e24","modified":1599293200722},{"_id":"themes/butterfly/languages/default.yml","hash":"730a00d41d0cb7b6ad768a9f91889307ffeffc23","modified":1599293200709},{"_id":"themes/butterfly/languages/en.yml","hash":"730a00d41d0cb7b6ad768a9f91889307ffeffc23","modified":1599293200709},{"_id":"themes/butterfly/languages/zh-CN.yml","hash":"e7d642fe6ed909c6552accd919a812c9ae86df7d","modified":1599293200709},{"_id":"themes/butterfly/languages/zh-TW.yml","hash":"582d4800d33209f4612f48f25f69e8d952aeabfe","modified":1599293200709},{"_id":"themes/butterfly/layout/includes/additional-js.pug","hash":"06ff82eaedfbc5cc9a65e34eaa063cebfb942a93","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/footer.pug","hash":"0675b44ce8eeffca750f32f68e406145b070f363","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head.pug","hash":"5f3a4c030a5f27d890089737f3fd4c58a1154c1f","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/layout.pug","hash":"e764e4ecceb04e11e2bfef84e72b4529bdc2362b","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/pagination.pug","hash":"29c6e5f8b82de38f61b53decfa9e0e9831b188f8","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/rightside.pug","hash":"71960ea57a3f241c80e7701f2decbf4ba9736ba0","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/sidebar.pug","hash":"158e49e0466e71e4d2cc7087a3ac5e703b3e13e4","modified":1599293200719},{"_id":"themes/butterfly/scripts/events/404.js","hash":"3c30dbd8b910ce7d8d7d8353cf2266cbc5d8775d","modified":1599293200723},{"_id":"themes/butterfly/scripts/events/replace_config.js","hash":"537e556e76760ce2103f359d5a424c6e2b9a0710","modified":1599293200723},{"_id":"themes/butterfly/scripts/filters/post_lazyload.js","hash":"e6db030700cefcd79e7a826b04e2a7172d53428e","modified":1599293200724},{"_id":"themes/butterfly/scripts/filters/random_cover.js","hash":"0b4775aaa955b75f03648fc1957fb88a6d440803","modified":1599293200724},{"_id":"themes/butterfly/scripts/helpers/aside_archives.js","hash":"fb394ffd0ec61fe50ff992fdf11356312ca2ccfb","modified":1599293200724},{"_id":"themes/butterfly/scripts/helpers/aside_categories.js","hash":"11aabab0092a3f2258c1fa931e74a7796074c515","modified":1599293200724},{"_id":"themes/butterfly/scripts/helpers/page.js","hash":"729a9f40c5bf603036f6e9443db93b1704cf17d9","modified":1599293200725},{"_id":"themes/butterfly/scripts/helpers/related_post.js","hash":"64b13aeb4f49609529be6f9060797bafc8a6f9bc","modified":1599293200725},{"_id":"themes/butterfly/scripts/tags/button.js","hash":"bae84b36b58572112047c3b02e975c1e762de56b","modified":1599293200725},{"_id":"themes/butterfly/scripts/tags/hide.js","hash":"a32e4166b6cbbc1c2bdecaa74662a12cdb98f4ce","modified":1599293200725},{"_id":"themes/butterfly/scripts/tags/gallery.js","hash":"2fad0a9e6645613631aad36dc3473fe8e032809b","modified":1599293200725},{"_id":"themes/butterfly/scripts/tags/mermaid.js","hash":"53eaff19d8da32e04e2c871300ea495356d633cd","modified":1599293200726},{"_id":"themes/butterfly/scripts/tags/note.js","hash":"c739846637c48b4779df2f62effb78e15100fd9f","modified":1599293200726},{"_id":"themes/butterfly/scripts/tags/tabs.js","hash":"ec58149e16b6269bbcb685020b98567e8e3440a8","modified":1599293200726},{"_id":"themes/butterfly/source/css/index.styl","hash":"8d908c4bc856f9369e8148e7b8dd7fb968fbf66c","modified":1599293200734},{"_id":"themes/butterfly/source/css/var.styl","hash":"3c20dbec8e323628f17a8510f6ef8bba6f00db2a","modified":1599293200734},{"_id":"themes/butterfly/source/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1599293200734},{"_id":"themes/butterfly/source/img/algolia.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1599293200734},{"_id":"themes/butterfly/source/img/favicon.png","hash":"3cf89864b4f6c9b532522a4d260a2e887971c92d","modified":1599293200736},{"_id":"themes/butterfly/source/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1599293200737},{"_id":"themes/butterfly/source/img/icp.png","hash":"cb1fd69b38ec23ce8366668ddffbbd0160de0104","modified":1599293200737},{"_id":"themes/butterfly/source/img/loading.gif","hash":"5f0287fb8fb98872fe1998c6f781111819e71806","modified":1599293200737},{"_id":"themes/butterfly/source/js/main.js","hash":"c2e386dfd6614123a58dd87a66a7fc9bcca8b64f","modified":1616218902930},{"_id":"themes/butterfly/source/js/tw_cn.js","hash":"030ad26843c22f6a5f91a40200c65d079a4f8475","modified":1599293200740},{"_id":"themes/butterfly/source/js/utils.js","hash":"43da5a9129aa827dc5c311b0e5e3a12ccc61b488","modified":1599293200740},{"_id":"themes/butterfly/layout/includes/chat/chatra.pug","hash":"77ec360f1f9fd702be540b0542449705828a77da","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/chat/daovoice.pug","hash":"ab96a70b0a65a7fae094d426beba7433f60f4a5a","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/chat/gitter.pug","hash":"ba9576ecba1a1768c25377e8b4fdb133982bd214","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/chat/index.pug","hash":"da7412131e768e331a9f33804f2f5f7c5eeaa178","modified":1599293200710},{"_id":"themes/butterfly/layout/includes/chat/tidio.pug","hash":"208035fb6ae639653861d15c9a20e8d4bba2b02a","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/disqus.pug","hash":"821d968122bab8ce1ce04dc553b731eaf8e0d181","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/disqusjs.pug","hash":"751351eae0540651a5db865262ff4a6d40680715","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/facebook_comments.pug","hash":"7b7bb7d2b39b639cc8e1edf1274148460796662e","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/gitalk.pug","hash":"e98f5c199a76ad939a29a46c0dcbf7e85ec60ed2","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/index.pug","hash":"67cfc03939e08992ccb3a453d2b72458056535e9","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/livere.pug","hash":"9518b6e0c532af8ab0ae569ad795b769a2bd3040","modified":1599293200711},{"_id":"themes/butterfly/layout/includes/comments/utterances.pug","hash":"9427cb07bcfe2bc7198755eeebf60f9fe430a342","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/comments/valine.pug","hash":"7b91be55c613f16bb2da9ab48aaf6e08781f563a","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head/analytics.pug","hash":"8ec0609f14c284c3e6120940d7c4d7f1f201cd67","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head/Open_Graph.pug","hash":"a3c819238dceab080d5db0336ef07009ca216310","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head/aplayer.pug","hash":"b24959f00ac75f12f66b445158aad143ee860795","modified":1599293200712},{"_id":"themes/butterfly/layout/includes/head/comment.pug","hash":"7de136bdce45afa81341b13e61b7a3926e15f03b","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/config.pug","hash":"e8b774f88cc717371d2e31f5d532007d0b7b23ab","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/config_site.pug","hash":"29d6ab8de6e355925e76d92862671ce48ddd6f12","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/darkmode.pug","hash":"fa834037bf29843abd6b63fed3a868638b9875cd","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/noscript.pug","hash":"0a23423304127c4ffa69310526aaa59830d12c78","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/google_adsense.pug","hash":"ff4ceda534cdd711cfa2cb9e95e36258988674e1","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/preconnect.pug","hash":"95affc2c333f27b968c47272277da712d13f2670","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/pwa.pug","hash":"be1ff710e4381fc684243313dcadf0140d7469de","modified":1599293200713},{"_id":"themes/butterfly/layout/includes/head/site_verification.pug","hash":"f5c8ec73c797ff3455e732fa7c92c856692f3ce5","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/head/subtitle.pug","hash":"bfbf1c850dcd825c2eb68bc74e9787a5fef9258b","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/index.pug","hash":"12dc74a7370b8d00f010e6914c09b1b12343fd92","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/menu_item.pug","hash":"c76b6236995f15e3cf5af376101c782a1078b845","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/nav.pug","hash":"2ff93c4edc1e52f63f3cd5f90354683e933a299e","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/post-info.pug","hash":"aa83c7e0dcaf60c85d44af32a7d2d20667a6893b","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/header/social.pug","hash":"0d953e51d04a9294a64153c89c20f491a9ec42d4","modified":1599293200714},{"_id":"themes/butterfly/layout/includes/loading/loading.pug","hash":"5276937fbcceb9d62879dc47be880cd469a27349","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/loading/loading-js.pug","hash":"3cf431a4f04997b55873f7099c1402155b19cc95","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/mixins/article-sort.pug","hash":"4736ea0dec5561f4f75d283be3629062b234af23","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/mixins/post-ui.pug","hash":"c046c1b43ce9b5afe68b60c08230b843113a1561","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/mobile-sidebar/index.pug","hash":"d12fab033fb32b55abbc9be9b04cc6ab6465b98e","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/mobile-sidebar/mobile-menus.pug","hash":"e7ee2593788c6614b9f41f0789ef7166fe73a707","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/math/index.pug","hash":"ec97f284626b67208370b5084e5c5822844fa30a","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/math/katex.pug","hash":"73356f1068c7426597e268d6c4aefa2b0ac3a1d9","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/math/mermaid.pug","hash":"db848ff451d4c58670af415882ca6bb2e0da971b","modified":1599293200716},{"_id":"themes/butterfly/layout/includes/math/mathjax.pug","hash":"6ccfaa776fc913ccf8b34825d918ab2b4d457434","modified":1599293200715},{"_id":"themes/butterfly/layout/includes/search/algolia.pug","hash":"518eec7302d4fad75be46486407a945b39833ff8","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/search/index.pug","hash":"b01828b37d789797aeb5433f1705cff3c540a4d5","modified":1599293200718},{"_id":"themes/butterfly/layout/includes/search/local-search.pug","hash":"f8686264a4ff1d48961296f9949d705bc87de3ea","modified":1599293200718},{"_id":"themes/butterfly/layout/includes/post/post-copyright.pug","hash":"8efc0b7886bdb5959e173b5e11f5ffb8d1c5230e","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/share/add-this.pug","hash":"2980f1889226ca981aa23b8eb1853fde26dcf89a","modified":1599293200718},{"_id":"themes/butterfly/layout/includes/share/addtoany.pug","hash":"bbf5b70460b17c4fecb9ee6880aa71cdb2d807a8","modified":1599293200718},{"_id":"themes/butterfly/layout/includes/post/reward.pug","hash":"3740cece6885c285351295612723fd66e0d5a4bf","modified":1599293200717},{"_id":"themes/butterfly/layout/includes/share/index.pug","hash":"c341aaa00113681b22f945f5004e6b22c8a0ca69","modified":1599293200719},{"_id":"themes/butterfly/layout/includes/share/share-js.pug","hash":"828a04c6e8e3a56c3c7f3c9bb1ecf4f99ed842fe","modified":1599293200719},{"_id":"themes/butterfly/layout/includes/third-party/canvas-nest.pug","hash":"3d7a3654ae03fd2665ea355ee9eac48af0ee82af","modified":1599293200719},{"_id":"themes/butterfly/layout/includes/third-party/canvas-ribbon-piao.pug","hash":"001f28c633d2ec2d5ef9ca047fb1fe61ffefd66f","modified":1599293200719},{"_id":"themes/butterfly/layout/includes/third-party/canvas-ribbon.pug","hash":"b4acf48c98ba2a6a5a5fb5387a0fd610bdfd55ef","modified":1599293200720},{"_id":"themes/butterfly/layout/includes/third-party/pangu.pug","hash":"8fdb96b8329e352ed691228767451b264151b3a6","modified":1599293200720},{"_id":"themes/butterfly/layout/includes/widget/card_ad.pug","hash":"2e940de1a6261fd378e16e4cd3362a9d69c12f50","modified":1599293200720},{"_id":"themes/butterfly/layout/includes/widget/card_author.pug","hash":"b5d73ceb54c43cc22e46b1cdcde24fcc8e420755","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_archives.pug","hash":"393a6f9a5dcabe8d96e9b6cb5620c12966dfd37f","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_announcement.pug","hash":"721b611fda6dcfca8f88b9c7b70fede7b69a516b","modified":1599293200720},{"_id":"themes/butterfly/layout/includes/widget/card_categories.pug","hash":"83cb6ba0d8c913570147b3871c7fc0674dac8cdf","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_recent_post.pug","hash":"355b50dd13471e00fbbfcf6519cf32a092c095b3","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_tags.pug","hash":"6a4c85a037c10e093f545d3167691c0b68634465","modified":1599293200721},{"_id":"themes/butterfly/layout/includes/widget/card_webinfo.pug","hash":"e0febc7eb43ceb21bb1607d4f2358b9b633cb2d2","modified":1599293200722},{"_id":"themes/butterfly/layout/includes/widget/index.pug","hash":"15fb3730f829e237c102a70ab9781178471fd786","modified":1599293200722},{"_id":"themes/butterfly/source/css/_global/function.styl","hash":"7f800733ca4e4ee4dd1e0ccaace274d1bc896539","modified":1599293200727},{"_id":"themes/butterfly/source/css/_global/index.styl","hash":"cd9580fdf3a138ca84504e1a8b3f4d633ccc7bd5","modified":1599293200727},{"_id":"themes/butterfly/source/css/_highlight/diff.styl","hash":"2d9820f9fc556855c9c26f9242adb1b29fe3c272","modified":1599293200727},{"_id":"themes/butterfly/source/css/_highlight/highlight.styl","hash":"f2884605b55dfb9575f9532d6ac568bc59d0c4ab","modified":1599293200727},{"_id":"themes/butterfly/source/css/_highlight/theme.styl","hash":"70ce4e354b03fe926fd06822e2a5f125e1cd3697","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/404.styl","hash":"b766e536a7a558f4850b31464a284ce2384d79f6","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/aside.styl","hash":"25c9a71043156adf67662d68b35d97d66f60a396","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/category.styl","hash":"7267043e52a9e620adfa860bdb3e4de400ff2596","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/chat.styl","hash":"29f48f9370f245e6e575b5836bccf47eb5688d8b","modified":1599293200728},{"_id":"themes/butterfly/source/css/_layout/flink.styl","hash":"079ed647f847cf2693928d358929b65ce67cb31b","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/footer.styl","hash":"d8709e29efcfa0a7356384026dfbaac8861d3baa","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/head.styl","hash":"f7038a0ac08396784e57bcd31f6431c92909f514","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/loadding.styl","hash":"144ef01b03ae34d3ede4b9aa18f4c8cd3d6651ea","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/mobile-sidebar.styl","hash":"d2d6b36f3bcbba35e1e63ac0d59879decf63cc1f","modified":1599293200729},{"_id":"themes/butterfly/source/css/_layout/page.styl","hash":"2fc2230d9a7117f6c5f7e484e2fbfc76e62fa8bc","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/pagination.styl","hash":"8f44be6a866d11f6afabf8689d9ae7b65eee18ae","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/post.styl","hash":"37a9832a6bc409947e85556b31f2adadf2f412ec","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/relatedposts.styl","hash":"4825afd4f94f1481b5422072fa5e506e2a387247","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/reward.styl","hash":"495da7b41a7909df989a5dcc13a29761ef23089b","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/rightside.styl","hash":"1cb78e3c8217eb93ad3652f60a3f4c92c1218083","modified":1599293200730},{"_id":"themes/butterfly/source/css/_layout/sidebar.styl","hash":"33da3da65715ce1a85b8ecab92e0eab6ce620a58","modified":1599293200731},{"_id":"themes/butterfly/source/css/_layout/third-party.styl","hash":"4923e99c1b6abf11c81539576ce65202a2f40efb","modified":1599293200731},{"_id":"themes/butterfly/source/css/_mode/darkmode.styl","hash":"ce9b157439f48c5ef9106cbe3090525815009134","modified":1599293200731},{"_id":"themes/butterfly/source/css/_mode/readmode.styl","hash":"1608b5c2a307809e25ac7ad903fc6bc009c30016","modified":1599293200731},{"_id":"themes/butterfly/source/css/_search/algolia.styl","hash":"641ef2bc7af135c17fd90f3f974e78ebbaf1ac13","modified":1599293200732},{"_id":"themes/butterfly/source/css/_search/index.styl","hash":"5bb29799d0168b1d68cfb8165a41b9d90f86eab7","modified":1599293200732},{"_id":"themes/butterfly/source/css/_search/local-search.styl","hash":"da791f46239eabbbf28eb30b9e441f1ac2a8ced1","modified":1599293200732},{"_id":"themes/butterfly/source/css/_tags/button.styl","hash":"40926b9d87e06d4679bd3c8542a7a3acd5d10cc1","modified":1599293200732},{"_id":"themes/butterfly/source/css/_tags/gallery.styl","hash":"0bc29278fbcf1aec15222ed10c58697da1a0d676","modified":1599293200732},{"_id":"themes/butterfly/source/css/_tags/hexo.styl","hash":"d0386ba6d8d63afc72b9673e8f3e89df6446ffc2","modified":1599293200733},{"_id":"themes/butterfly/source/css/_tags/hide.styl","hash":"10e925cf59748af445d3606d965731013f31827c","modified":1599293200733},{"_id":"themes/butterfly/source/css/_tags/note.styl","hash":"2f8d4043dedef70813493e43e4c158e16ccc3fc0","modified":1599293200733},{"_id":"themes/butterfly/source/css/_tags/tabs.styl","hash":"48a582e1847595aaa435c048a7bb78b44ed8a716","modified":1599293200733},{"_id":"themes/butterfly/source/css/_third-party/normalize.min.css","hash":"001bd6d68a9b9af5dd0158fe116889434f36b1fd","modified":1599293200733},{"_id":"themes/butterfly/source/js/search/algolia.js","hash":"5ff5cb40d5ede73b48594d331244ada001154dac","modified":1599293200738},{"_id":"themes/butterfly/source/js/search/local-search.js","hash":"497993860b3c42bdc926a3bd83b4b8f480febd99","modified":1599293200738},{"_id":"themes/butterfly/source/js/third-party/ClickShowText.js","hash":"32864aee35b5d739a36702b8d916b17bac52b17e","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/activate-power-mode.js","hash":"2c4ab494225b7d04eed934efc43a43791e596f4a","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/canvas-nest.js","hash":"978402a16f3ceebe453806e3e25a5905a89776be","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/canvas-ribbon.js","hash":"1ddf4f6896175e77518f0fbd45776132b2954fb6","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/click_heart.js","hash":"004ea645ed8c5e354711b5fc0dbfe015e181916b","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/fireworks.js","hash":"411ced4031a856a5b87f7c62d3800027d12bacec","modified":1599293200739},{"_id":"themes/butterfly/source/js/third-party/piao.js","hash":"05da3437664bb335e2336a52be8587e7719f7b89","modified":1599293200740},{"_id":"source/_posts/在k8s中部署RabbitMQ/log.png","hash":"67f08866e31bf7be0b10733147d91acb87c318cb","modified":1616217771632},{"_id":"themes/butterfly/source/img/avator.png","hash":"b2bc08b8559a3a777724aadcbaebbaf3bef791ef","modified":1599293200736},{"_id":"source/_posts/在k8s中部署RabbitMQ/web.png","hash":"aca80a860af76862c1510399be20e585580aaa45","modified":1616218111938},{"_id":"source/_posts/在k8s中部署RabbitMQ/client_log.png","hash":"5835d6bb7d706b615bcd8f49239d7e3ae82aa82b","modified":1616217853920},{"_id":"public/archives/index.html","hash":"0c6591f574f88437da6775dfe8d64e78000bf40a","modified":1616230539649},{"_id":"public/categories/index-1.html","hash":"b5f0a158ec11a5a98063f55bb3b4cb3d6752b478","modified":1616230539649},{"_id":"public/categories/index.html","hash":"30f5259671e9996ee17dd66d5a88880eff44ae8b","modified":1616230539649},{"_id":"public/tags/index-1.html","hash":"cb6386b703c02f7ecaf99061ce64ce10acac69ba","modified":1616230539649},{"_id":"public/tags/index.html","hash":"a4dc57b45ae0911a8e787be239883849d0918250","modified":1616230539649},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/index.html","hash":"03f8adcfb3356140361e74f809241119ee1203bd","modified":1616226286798},{"_id":"public/archives/2021/index.html","hash":"9ff9b321af6e5a176216b4a25a684f192821bf8c","modified":1616230539649},{"_id":"public/archives/2021/03/index.html","hash":"5f987ceadafb8a53c317a990b03dba0117a1c794","modified":1616230539649},{"_id":"public/categories/消息中间件/index.html","hash":"7653bee8d4c5e9382da73dcc435b6191ff869d2a","modified":1616230539649},{"_id":"public/categories/消息中间件/RabbitMQ/index.html","hash":"29ea9b262bfcc5684cd57f06298ccd4f44557355","modified":1616230539649},{"_id":"public/categories/消息中间件/RabbitMQ/部署/index.html","hash":"df7a36976275067ee1dfadb7db7e03399d14c7f8","modified":1616230539649},{"_id":"public/index.html","hash":"0cd1a491b641995440f9ab12429beebf4572a5c7","modified":1616230539649},{"_id":"public/tags/RabbitMQ/index.html","hash":"744acd7ce58015346187c859acb7d441a6c52396","modified":1616230539649},{"_id":"public/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1616221797577},{"_id":"public/img/algolia.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1616221797577},{"_id":"public/img/favicon.png","hash":"3cf89864b4f6c9b532522a4d260a2e887971c92d","modified":1616221797577},{"_id":"public/img/icp.png","hash":"cb1fd69b38ec23ce8366668ddffbbd0160de0104","modified":1616221797577},{"_id":"public/img/loading.gif","hash":"5f0287fb8fb98872fe1998c6f781111819e71806","modified":1616221797577},{"_id":"public/CNAME","hash":"48f01e357230864df594b4549a67d838047b39dd","modified":1616221797577},{"_id":"public/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/service.png","hash":"71d9ec668af0d71f6d4109d20edd67ce9b654718","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/bushu.png","hash":"51b3273b0ed83d2f03df80e5b08903682752c58f","modified":1616221797577},{"_id":"public/css/var.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1616221797577},{"_id":"public/js/utils.js","hash":"43da5a9129aa827dc5c311b0e5e3a12ccc61b488","modified":1616221797577},{"_id":"public/js/search/algolia.js","hash":"5ff5cb40d5ede73b48594d331244ada001154dac","modified":1616221797577},{"_id":"public/js/search/local-search.js","hash":"497993860b3c42bdc926a3bd83b4b8f480febd99","modified":1616221797577},{"_id":"public/js/third-party/ClickShowText.js","hash":"32864aee35b5d739a36702b8d916b17bac52b17e","modified":1616221797577},{"_id":"public/js/third-party/activate-power-mode.js","hash":"2c4ab494225b7d04eed934efc43a43791e596f4a","modified":1616221797577},{"_id":"public/js/third-party/canvas-nest.js","hash":"978402a16f3ceebe453806e3e25a5905a89776be","modified":1616221797577},{"_id":"public/js/third-party/canvas-ribbon.js","hash":"1ddf4f6896175e77518f0fbd45776132b2954fb6","modified":1616221797577},{"_id":"public/js/third-party/click_heart.js","hash":"004ea645ed8c5e354711b5fc0dbfe015e181916b","modified":1616221797577},{"_id":"public/js/third-party/fireworks.js","hash":"411ced4031a856a5b87f7c62d3800027d12bacec","modified":1616221797577},{"_id":"public/js/third-party/piao.js","hash":"05da3437664bb335e2336a52be8587e7719f7b89","modified":1616221797577},{"_id":"public/css/index.css","hash":"d955f3a4c6a05310eb5354404ac1ef9cbd28fe8c","modified":1616221797577},{"_id":"public/js/main.js","hash":"c2e386dfd6614123a58dd87a66a7fc9bcca8b64f","modified":1616221797577},{"_id":"public/js/tw_cn.js","hash":"030ad26843c22f6a5f91a40200c65d079a4f8475","modified":1616221797577},{"_id":"public/img/avator.png","hash":"b2bc08b8559a3a777724aadcbaebbaf3bef791ef","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/log.png","hash":"67f08866e31bf7be0b10733147d91acb87c318cb","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/web.png","hash":"aca80a860af76862c1510399be20e585580aaa45","modified":1616221797577},{"_id":"public/2021/03/20/在k8s中部署RabbitMQ/client_log.png","hash":"5835d6bb7d706b615bcd8f49239d7e3ae82aa82b","modified":1616221797577},{"_id":"source/_posts/部署Ingress.md","hash":"f2276e7eb979ddb5b85a95ee4784dc46b771efa7","modified":1616225614178},{"_id":"source/_posts/在k8s中部署RabbitMQ/.DS_Store","hash":"4e64f1ac8566a9d3dc317186d770d52fcdb34144","modified":1616224447450},{"_id":"public/2021/03/20/部署Ingress/index.html","hash":"de40df0566b19147e69e8605db067debcb5dadad","modified":1616226286798},{"_id":"public/categories/Kubernetes/index.html","hash":"115743bfdc7ad8cbfebdafad7128fe30d981f8c6","modified":1616230539649},{"_id":"public/categories/Kubernetes/Ingress-nginx/index.html","hash":"30243a9ab3b1c477c375b083c3271105e96f894d","modified":1616230539649},{"_id":"public/tags/Ingress/index.html","hash":"dbb1a7b9b07d12cbcdcc2d952db8a1e88abda909","modified":1616230539649},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布.md","hash":"e4a37b897e59ca81b31b7e3e6bf6d77138effaf7","modified":1616230531405},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/index.html","hash":"5942c1b3dd70068db8fca449a6c5e56ce2096837","modified":1616230539649},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/pod.png","hash":"5d27bac9f250f8c1fa0582d179135d8e4182e519","modified":1616226381609},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-ha.png","hash":"ff05d70835407c65fffb62ca46f31c6d507b8a3f","modified":1616227117706},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-never.png","hash":"a5bd79e1cf70bbf210658a923beb3e64039294e2","modified":1616227230206},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-wight.png","hash":"d6309a6c2f52b75ed625ef6a1f1d22c6d29ca622","modified":1616226688767},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-true.png","hash":"0dc651430e734e14767c987d9351c9a8ed39e161","modified":1616227310172},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2.png","hash":"9849d93155f759958c418acff7993cad654d6120","modified":1616226633526},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v1.png","hash":"fa31197af7e26528f5825fccea9cba7e584e0f2e","modified":1616226746224},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/pod.png","hash":"5d27bac9f250f8c1fa0582d179135d8e4182e519","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v1.png","hash":"fa31197af7e26528f5825fccea9cba7e584e0f2e","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2.png","hash":"9849d93155f759958c418acff7993cad654d6120","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2-wight.png","hash":"d6309a6c2f52b75ed625ef6a1f1d22c6d29ca622","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2-true.png","hash":"0dc651430e734e14767c987d9351c9a8ed39e161","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2-never.png","hash":"a5bd79e1cf70bbf210658a923beb3e64039294e2","modified":1616228714566},{"_id":"public/2021/03/20/ingress-nginx实现蓝绿、灰度发布/v2-ha.png","hash":"ff05d70835407c65fffb62ca46f31c6d507b8a3f","modified":1616228714566}],"Category":[{"name":"消息中间件","_id":"ckmhcqa1z0006ihklc1vl5jh3"},{"name":"RabbitMQ","parent":"ckmhcqa1z0006ihklc1vl5jh3","_id":"ckmhcqa200009ihklec2k1y6e"},{"name":"部署","parent":"ckmhcqa200009ihklec2k1y6e","_id":"ckmhcqa20000aihkl1z5r5ap4"},{"name":"Kubernetes","_id":"ckmhedtrs000169kl7xhs1t43"},{"name":"Ingress-nginx","parent":"ckmhedtrs000169kl7xhs1t43","_id":"ckmhedtru000469kl8n316bgc"}],"Data":[],"Page":[{"title":"archives","date":"2021-03-20T03:56:13.000Z","_content":"","source":"archives/index.md","raw":"---\ntitle: archives\ndate: 2021-03-20 11:56:13\n---\n","updated":"2021-03-20T03:56:13.023Z","path":"archives/index.html","comments":1,"layout":"page","_id":"ckmhcqa1r0000ihkld47ub9ui","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""},{"title":"categories","date":"2021-03-20T03:54:34.000Z","_content":"","source":"categories/index-1.md","raw":"---\ntitle: categories\ndate: 2021-03-20 11:54:34\n---\n","updated":"2021-03-20T03:54:34.907Z","path":"categories/index-1.html","comments":1,"layout":"page","_id":"ckmhcqa1t0001ihklhrn756l3","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""},{"title":"分类","date":"2020-07-01T16:00:00.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2020-07-02 00:00:00\ntype: \"categories\"\n---\n","updated":"2020-09-05T07:27:15.590Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ckmhcqa1u0002ihklhy3j15r5","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""},{"title":"tags","date":"2021-03-20T03:54:41.000Z","_content":"","source":"tags/index-1.md","raw":"---\ntitle: tags\ndate: 2021-03-20 11:54:41\n---\n","updated":"2021-03-20T03:54:41.066Z","path":"tags/index-1.html","comments":1,"layout":"page","_id":"ckmhcqa1u0003ihklh8dw4231","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""},{"title":"标签","date":"2020-07-01T16:00:00.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: 标签\ndate: 2020-07-02 00:00:00\ntype: \"tags\"\n---\n","updated":"2020-09-05T07:27:15.590Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ckmhcqa1w0004ihkl0krka2jz","content":"","site":{"data":{}},"cover":"https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg","excerpt":"","more":""}],"Post":[{"title":"在k8s中部署RabbitMQ","date":"2021-03-20T04:09:11.000Z","description":"本文介绍在k8s中使用有状态服务部署RabbitMQ 3.8.3","cover":"https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=1271185307,1858861969&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个RabbitMQ 3.8.3 版本的集群\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 准备\n\n{% tabs comments %}\n\n<!-- tab K8S集群环境 -->\n\n本文使用的 k8s版本为 `1.20.4`版本，将使用`storageclass`作为持久化存储，底层为`nfs`，使用`default` namespace部署。\n\n<!-- endtab -->\n\n<!-- tab RabbitMq -->\n\n`RabbitMQ`在`k8s`集群中通过`rabbitmq_peer_discovery_k8s plugin`与`k8s apiserver`进行交互，获取各个服务的`URL`，且`RabbitMQ`在`k8s`集群中必须用`statefulset`和`headless service`进行匹配；\n\n> rabbitmq_peer_discovery_k8s`是`RabbitMQ`官方基于第三方开源项目`rabbitmq-autocluster`开发，对`3.7.X`及以上版本提供的`Kubernetes`下的对等发现插件，可实现`rabbitmq`集群在`k8s`中的自动化部署，因此低于3.7.X版本请使用`rabbitmq-autocluster\n\n\n\n这里部署使用的版本是`3.8.3`，其他版本信息可以参看官方文档：[rabbitmq download](https://www.rabbitmq.com/download.html)\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署\n\n\n\n## 创建相关文件\n\n\n\n{% tabs comments %}\n\n<!-- tab 创建configmap -->\n\n创建一个`rabbitmq-configmap.yaml`的文件：\n\n```yaml\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: rabbitmq-cluster-config\n  namespace: default\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\ndata:\n    enabled_plugins: |\n      [rabbitmq_management,rabbitmq_peer_discovery_k8s].\n    rabbitmq.conf: |\n      default_user = admin\n      default_pass = 123!@#\n      cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s\n      cluster_formation.k8s.host = kubernetes.default.svc.cluster.local\n      cluster_formation.k8s.address_type = hostname\n      cluster_formation.node_cleanup.interval = 30\n      cluster_formation.node_cleanup.only_log_warning = true\n      cluster_partition_handling = autoheal\n      queue_master_locator=min-masters\n      loopback_users.guest = false\n      cluster_formation.randomized_startup_delay_range.min = 0\n      cluster_formation.randomized_startup_delay_range.max = 2\n      cluster_formation.k8s.hostname_suffix = .rabbitmq-cluster.default.svc.cluster.local\n      vm_memory_high_watermark.absolute = 1GB\n      disk_free_limit.absolute = 2GB\n```\n\n\n\n- `enabled_plugins`：声明开启的插件；\n- `default_user/default_pass`：指定用户名和密码；\n- `cluster_formation.k8s.address_type`：从`k8s`返回的`Pod`容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是`ip`，但是默认情况下在`k8s`中`pod`的`ip`都是不固定的，因此可能导致节点的配置和数据丢失，后面的`yaml`中会通过引用元数据的方式固定`pod`的主机名；\n\n<!-- endtab -->\n\n<!-- tab 创建service -->\n\n创建一个`rabbitmq-service.yaml`的文件：\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster\n  namespace: default\nspec:\n  clusterIP: None\n  ports:\n  - name: rmqport\n    port: 5672\n    targetPort: 5672\n  selector:\n    app: rabbitmq-cluster\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster-manage\n  namespace: default\nspec:\n  ports:\n  - name: http\n    port: 15672\n    protocol: TCP\n    targetPort: 15672\n  selector:\n    app: rabbitmq-cluster\n  type: NodePort\n```\n\n\n\n> 这里定义了两个service，一个是`NodePort`用于用户通过web访问的管理页面，另一个是用于rabbitmq服务通信；\n\n<!-- endtab -->\n\n<!-- tab RBAC -->\n\n创建一个`rabbitmq-rbac.yaml`的文件：\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\nrules:\n- apiGroups: [\"\"]\n  resources: [\"endpoints\"]\n  verbs: [\"get\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: rabbitmq-cluster\nsubjects:\n- kind: ServiceAccount\n  name: rabbitmq-cluster\n  namespace: default\n```\n\n<!-- endtab -->\n\n\n\n<!-- tab 创建statefulset -->\n\n创建一个`rabbitmq-cluster-sts.yaml`的文件：\n\n```yaml\nkind: StatefulSet\napiVersion: apps/v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster\n  namespace: default\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: rabbitmq-cluster\n  serviceName: rabbitmq-cluster\n  template:\n    metadata:\n      labels:\n        app: rabbitmq-cluster\n    spec:\n      containers:\n      - args:\n        - -c\n        - cp -v /etc/rabbitmq/rabbitmq.conf ${RABBITMQ_CONFIG_FILE}; exec docker-entrypoint.sh\n          rabbitmq-server\n        command:\n        - sh\n        env:\n        - name: TZ\n          value: 'Asia/Shanghai'\n        - name: RABBITMQ_ERLANG_COOKIE\n          value: 'SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY='\n        - name: K8S_SERVICE_NAME\n          value: rabbitmq-cluster\n        - name: POD_IP\n          valueFrom:\n            fieldRef:\n              fieldPath: status.podIP\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: POD_NAMESPACE\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.namespace\n        - name: RABBITMQ_USE_LONGNAME\n          value: \"true\"\n        - name: RABBITMQ_NODENAME\n          value: rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local\n        - name: RABBITMQ_CONFIG_FILE\n          value: /var/lib/rabbitmq/rabbitmq.conf\n        image: rabbitmq:3.8.3-management\n        imagePullPolicy: IfNotPresent\n        livenessProbe:\n          exec:\n            command:\n            - rabbitmq-diagnostics\n            - status\n          initialDelaySeconds: 60\n          periodSeconds: 60\n          timeoutSeconds: 15\n        name: rabbitmq\n        ports:\n        - containerPort: 15672\n          name: http\n          protocol: TCP\n        - containerPort: 5672\n          name: amqp\n          protocol: TCP\n        readinessProbe:\n          exec:\n            command:\n            - rabbitmq-diagnostics\n            - status\n          initialDelaySeconds: 20\n          periodSeconds: 60\n          timeoutSeconds: 10\n        volumeMounts:\n        - mountPath: /etc/rabbitmq\n          name: config-volume\n          readOnly: false\n        - mountPath: /var/lib/rabbitmq\n          name: rabbitmq-storage\n          readOnly: false\n        - name: timezone\n          mountPath: /etc/localtime\n          readOnly: true\n      serviceAccountName: rabbitmq-cluster\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: config-volume\n        configMap:\n          items:\n          - key: rabbitmq.conf\n            path: rabbitmq.conf\n          - key: enabled_plugins\n            path: enabled_plugins\n          name: rabbitmq-cluster-config\n      - name: timezone\n        hostPath:\n          path: /usr/share/zoneinfo/Asia/Shanghai\n  volumeClaimTemplates:\n  - metadata:\n      name: rabbitmq-storage\n    spec:\n      accessModes:\n      - ReadWriteMany\n      storageClassName: \"managed-nfs-storage\"\n      resources:\n        requests:\n          storage: 2Gi\n```\n\n> 这里指定了storageclass的名字为：`managed-nfs-storage`，需要根据实际情况调整\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 部署服务\n\n执行下面的命令完成部署：\n\n```bash\nkubectl apply -f .\n```\n\n\n\n## 检查\n\n执行下面的命令检查资源创建情况，确保pod都处于运行状态：\n\n```bash\nkubectl get pod,sts -n default\n```\n\n\n\n<img src=\"./bushu.png\" style=\"zoom:70%;\" />\n\n\n\n检查pod日志，观察集群建立情况：\n\n<img src=\"./log.png\" style=\"zoom:70%;\" />\n\n\n\n进入pod中，通过客户端命令查看集群状态：\n\n```bash\nkubectl exec -ti  rabbitmq-cluster-0 -n default -- rabbitmqctl cluster_status\n```\n\n<img src=\"./client_log.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问管理页面\n\n查看对应service使用的宿主机端口：\n\n```bash\nkubectl get svc -n default\n```\n\n<img src=\"./service.png\" style=\"zoom:70%;\" />\n\n\n\n通过浏览器访问node节点的30888端口即可打开rabbitmq的管理页面：\n\n<img src=\"./web.png\" style=\"zoom:70%;\" />\n\n","source":"_posts/在k8s中部署RabbitMQ.md","raw":"---\ntitle: 在k8s中部署RabbitMQ\ndate: 2021-03-20 12:09:11\ntags:\n- RabbitMQ\ncategories:\n- 消息中间件\n- RabbitMQ\n- 部署\ndescription: 本文介绍在k8s中使用有状态服务部署RabbitMQ 3.8.3\ncover: https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=1271185307,1858861969&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个RabbitMQ 3.8.3 版本的集群\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 准备\n\n{% tabs comments %}\n\n<!-- tab K8S集群环境 -->\n\n本文使用的 k8s版本为 `1.20.4`版本，将使用`storageclass`作为持久化存储，底层为`nfs`，使用`default` namespace部署。\n\n<!-- endtab -->\n\n<!-- tab RabbitMq -->\n\n`RabbitMQ`在`k8s`集群中通过`rabbitmq_peer_discovery_k8s plugin`与`k8s apiserver`进行交互，获取各个服务的`URL`，且`RabbitMQ`在`k8s`集群中必须用`statefulset`和`headless service`进行匹配；\n\n> rabbitmq_peer_discovery_k8s`是`RabbitMQ`官方基于第三方开源项目`rabbitmq-autocluster`开发，对`3.7.X`及以上版本提供的`Kubernetes`下的对等发现插件，可实现`rabbitmq`集群在`k8s`中的自动化部署，因此低于3.7.X版本请使用`rabbitmq-autocluster\n\n\n\n这里部署使用的版本是`3.8.3`，其他版本信息可以参看官方文档：[rabbitmq download](https://www.rabbitmq.com/download.html)\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n<br>\n\n\n\n# 部署\n\n\n\n## 创建相关文件\n\n\n\n{% tabs comments %}\n\n<!-- tab 创建configmap -->\n\n创建一个`rabbitmq-configmap.yaml`的文件：\n\n```yaml\nkind: ConfigMap\napiVersion: v1\nmetadata:\n  name: rabbitmq-cluster-config\n  namespace: default\n  labels:\n    addonmanager.kubernetes.io/mode: Reconcile\ndata:\n    enabled_plugins: |\n      [rabbitmq_management,rabbitmq_peer_discovery_k8s].\n    rabbitmq.conf: |\n      default_user = admin\n      default_pass = 123!@#\n      cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s\n      cluster_formation.k8s.host = kubernetes.default.svc.cluster.local\n      cluster_formation.k8s.address_type = hostname\n      cluster_formation.node_cleanup.interval = 30\n      cluster_formation.node_cleanup.only_log_warning = true\n      cluster_partition_handling = autoheal\n      queue_master_locator=min-masters\n      loopback_users.guest = false\n      cluster_formation.randomized_startup_delay_range.min = 0\n      cluster_formation.randomized_startup_delay_range.max = 2\n      cluster_formation.k8s.hostname_suffix = .rabbitmq-cluster.default.svc.cluster.local\n      vm_memory_high_watermark.absolute = 1GB\n      disk_free_limit.absolute = 2GB\n```\n\n\n\n- `enabled_plugins`：声明开启的插件；\n- `default_user/default_pass`：指定用户名和密码；\n- `cluster_formation.k8s.address_type`：从`k8s`返回的`Pod`容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是`ip`，但是默认情况下在`k8s`中`pod`的`ip`都是不固定的，因此可能导致节点的配置和数据丢失，后面的`yaml`中会通过引用元数据的方式固定`pod`的主机名；\n\n<!-- endtab -->\n\n<!-- tab 创建service -->\n\n创建一个`rabbitmq-service.yaml`的文件：\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster\n  namespace: default\nspec:\n  clusterIP: None\n  ports:\n  - name: rmqport\n    port: 5672\n    targetPort: 5672\n  selector:\n    app: rabbitmq-cluster\n\n---\nkind: Service\napiVersion: v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster-manage\n  namespace: default\nspec:\n  ports:\n  - name: http\n    port: 15672\n    protocol: TCP\n    targetPort: 15672\n  selector:\n    app: rabbitmq-cluster\n  type: NodePort\n```\n\n\n\n> 这里定义了两个service，一个是`NodePort`用于用户通过web访问的管理页面，另一个是用于rabbitmq服务通信；\n\n<!-- endtab -->\n\n<!-- tab RBAC -->\n\n创建一个`rabbitmq-rbac.yaml`的文件：\n\n```yaml\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\n---\nkind: Role\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\nrules:\n- apiGroups: [\"\"]\n  resources: [\"endpoints\"]\n  verbs: [\"get\"]\n---\nkind: RoleBinding\napiVersion: rbac.authorization.k8s.io/v1beta1\nmetadata:\n  name: rabbitmq-cluster\n  namespace: default\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: Role\n  name: rabbitmq-cluster\nsubjects:\n- kind: ServiceAccount\n  name: rabbitmq-cluster\n  namespace: default\n```\n\n<!-- endtab -->\n\n\n\n<!-- tab 创建statefulset -->\n\n创建一个`rabbitmq-cluster-sts.yaml`的文件：\n\n```yaml\nkind: StatefulSet\napiVersion: apps/v1\nmetadata:\n  labels:\n    app: rabbitmq-cluster\n  name: rabbitmq-cluster\n  namespace: default\nspec:\n  replicas: 3\n  selector:\n    matchLabels:\n      app: rabbitmq-cluster\n  serviceName: rabbitmq-cluster\n  template:\n    metadata:\n      labels:\n        app: rabbitmq-cluster\n    spec:\n      containers:\n      - args:\n        - -c\n        - cp -v /etc/rabbitmq/rabbitmq.conf ${RABBITMQ_CONFIG_FILE}; exec docker-entrypoint.sh\n          rabbitmq-server\n        command:\n        - sh\n        env:\n        - name: TZ\n          value: 'Asia/Shanghai'\n        - name: RABBITMQ_ERLANG_COOKIE\n          value: 'SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY='\n        - name: K8S_SERVICE_NAME\n          value: rabbitmq-cluster\n        - name: POD_IP\n          valueFrom:\n            fieldRef:\n              fieldPath: status.podIP\n        - name: POD_NAME\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.name\n        - name: POD_NAMESPACE\n          valueFrom:\n            fieldRef:\n              fieldPath: metadata.namespace\n        - name: RABBITMQ_USE_LONGNAME\n          value: \"true\"\n        - name: RABBITMQ_NODENAME\n          value: rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local\n        - name: RABBITMQ_CONFIG_FILE\n          value: /var/lib/rabbitmq/rabbitmq.conf\n        image: rabbitmq:3.8.3-management\n        imagePullPolicy: IfNotPresent\n        livenessProbe:\n          exec:\n            command:\n            - rabbitmq-diagnostics\n            - status\n          initialDelaySeconds: 60\n          periodSeconds: 60\n          timeoutSeconds: 15\n        name: rabbitmq\n        ports:\n        - containerPort: 15672\n          name: http\n          protocol: TCP\n        - containerPort: 5672\n          name: amqp\n          protocol: TCP\n        readinessProbe:\n          exec:\n            command:\n            - rabbitmq-diagnostics\n            - status\n          initialDelaySeconds: 20\n          periodSeconds: 60\n          timeoutSeconds: 10\n        volumeMounts:\n        - mountPath: /etc/rabbitmq\n          name: config-volume\n          readOnly: false\n        - mountPath: /var/lib/rabbitmq\n          name: rabbitmq-storage\n          readOnly: false\n        - name: timezone\n          mountPath: /etc/localtime\n          readOnly: true\n      serviceAccountName: rabbitmq-cluster\n      terminationGracePeriodSeconds: 30\n      volumes:\n      - name: config-volume\n        configMap:\n          items:\n          - key: rabbitmq.conf\n            path: rabbitmq.conf\n          - key: enabled_plugins\n            path: enabled_plugins\n          name: rabbitmq-cluster-config\n      - name: timezone\n        hostPath:\n          path: /usr/share/zoneinfo/Asia/Shanghai\n  volumeClaimTemplates:\n  - metadata:\n      name: rabbitmq-storage\n    spec:\n      accessModes:\n      - ReadWriteMany\n      storageClassName: \"managed-nfs-storage\"\n      resources:\n        requests:\n          storage: 2Gi\n```\n\n> 这里指定了storageclass的名字为：`managed-nfs-storage`，需要根据实际情况调整\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 部署服务\n\n执行下面的命令完成部署：\n\n```bash\nkubectl apply -f .\n```\n\n\n\n## 检查\n\n执行下面的命令检查资源创建情况，确保pod都处于运行状态：\n\n```bash\nkubectl get pod,sts -n default\n```\n\n\n\n<img src=\"./bushu.png\" style=\"zoom:70%;\" />\n\n\n\n检查pod日志，观察集群建立情况：\n\n<img src=\"./log.png\" style=\"zoom:70%;\" />\n\n\n\n进入pod中，通过客户端命令查看集群状态：\n\n```bash\nkubectl exec -ti  rabbitmq-cluster-0 -n default -- rabbitmqctl cluster_status\n```\n\n<img src=\"./client_log.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问管理页面\n\n查看对应service使用的宿主机端口：\n\n```bash\nkubectl get svc -n default\n```\n\n<img src=\"./service.png\" style=\"zoom:70%;\" />\n\n\n\n通过浏览器访问node节点的30888端口即可打开rabbitmq的管理页面：\n\n<img src=\"./web.png\" style=\"zoom:70%;\" />\n\n","slug":"在k8s中部署RabbitMQ","published":1,"updated":"2021-03-20T07:16:13.580Z","_id":"ckmhcqa1w0005ihkl8wyy7a8c","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个RabbitMQ 3.8.3 版本的集群</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">K8S集群环境</button></li><li class=\"tab\"><button data-href=\"#comments-2\">RabbitMq</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>本文使用的 k8s版本为 <code>1.20.4</code>版本，将使用<code>storageclass</code>作为持久化存储，底层为<code>nfs</code>，使用<code>default</code> namespace部署。</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p><code>RabbitMQ</code>在<code>k8s</code>集群中通过<code>rabbitmq_peer_discovery_k8s plugin</code>与<code>k8s apiserver</code>进行交互，获取各个服务的<code>URL</code>，且<code>RabbitMQ</code>在<code>k8s</code>集群中必须用<code>statefulset</code>和<code>headless service</code>进行匹配；</p>\n<blockquote>\n<p>rabbitmq_peer_discovery_k8s<code>是</code>RabbitMQ<code>官方基于第三方开源项目</code>rabbitmq-autocluster<code>开发，对</code>3.7.X<code>及以上版本提供的</code>Kubernetes<code>下的对等发现插件，可实现</code>rabbitmq<code>集群在</code>k8s<code>中的自动化部署，因此低于3.7.X版本请使用</code>rabbitmq-autocluster</p>\n</blockquote>\n<p>这里部署使用的版本是<code>3.8.3</code>，其他版本信息可以参看官方文档：<a href=\"https://www.rabbitmq.com/download.html\">rabbitmq download</a></p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h1><h2 id=\"创建相关文件\"><a href=\"#创建相关文件\" class=\"headerlink\" title=\"创建相关文件\"></a>创建相关文件</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建configmap</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">RBAC</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建statefulset</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>创建一个<code>rabbitmq-configmap.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">addonmanager.kubernetes.io/mode:</span> <span class=\"string\">Reconcile</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">    <span class=\"attr\">enabled_plugins:</span> <span class=\"string\">|</span></span><br><span class=\"line\">      [<span class=\"string\">rabbitmq_management</span>,<span class=\"string\">rabbitmq_peer_discovery_k8s</span>]<span class=\"string\">.</span></span><br><span class=\"line\">    <span class=\"attr\">rabbitmq.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">      <span class=\"string\">default_user</span> <span class=\"string\">=</span> <span class=\"string\">admin</span></span><br><span class=\"line\">      <span class=\"string\">default_pass</span> <span class=\"string\">=</span> <span class=\"number\">123</span><span class=\"type\">!@#</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.peer_discovery_backend</span> <span class=\"string\">=</span> <span class=\"string\">rabbit_peer_discovery_k8s</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.host</span> <span class=\"string\">=</span> <span class=\"string\">kubernetes.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.address_type</span> <span class=\"string\">=</span> <span class=\"string\">hostname</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.node_cleanup.interval</span> <span class=\"string\">=</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.node_cleanup.only_log_warning</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"string\">cluster_partition_handling</span> <span class=\"string\">=</span> <span class=\"string\">autoheal</span></span><br><span class=\"line\">      <span class=\"string\">queue_master_locator=min-masters</span></span><br><span class=\"line\">      <span class=\"string\">loopback_users.guest</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.randomized_startup_delay_range.min</span> <span class=\"string\">=</span> <span class=\"number\">0</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.randomized_startup_delay_range.max</span> <span class=\"string\">=</span> <span class=\"number\">2</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.hostname_suffix</span> <span class=\"string\">=</span> <span class=\"string\">.rabbitmq-cluster.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"string\">vm_memory_high_watermark.absolute</span> <span class=\"string\">=</span> <span class=\"string\">1GB</span></span><br><span class=\"line\">      <span class=\"string\">disk_free_limit.absolute</span> <span class=\"string\">=</span> <span class=\"string\">2GB</span></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><code>enabled_plugins</code>：声明开启的插件；</li>\n<li><code>default_user/default_pass</code>：指定用户名和密码；</li>\n<li><code>cluster_formation.k8s.address_type</code>：从<code>k8s</code>返回的<code>Pod</code>容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是<code>ip</code>，但是默认情况下在<code>k8s</code>中<code>pod</code>的<code>ip</code>都是不固定的，因此可能导致节点的配置和数据丢失，后面的<code>yaml</code>中会通过引用元数据的方式固定<code>pod</code>的主机名；</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>创建一个<code>rabbitmq-service.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">rmqport</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-manage</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>这里定义了两个service，一个是<code>NodePort</code>用于用户通过web访问的管理页面，另一个是用于rabbitmq服务通信；</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>创建一个<code>rabbitmq-rbac.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><p>创建一个<code>rabbitmq-cluster-sts.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">cp</span> <span class=\"string\">-v</span> <span class=\"string\">/etc/rabbitmq/rabbitmq.conf</span> <span class=\"string\">$&#123;RABBITMQ_CONFIG_FILE&#125;;</span> <span class=\"string\">exec</span> <span class=\"string\">docker-entrypoint.sh</span></span><br><span class=\"line\">          <span class=\"string\">rabbitmq-server</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;Asia/Shanghai&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_ERLANG_COOKIE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY=&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">K8S_SERVICE_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAMESPACE</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_USE_LONGNAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_NODENAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_CONFIG_FILE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/var/lib/rabbitmq/rabbitmq.conf</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">rabbitmq:3.8.3-management</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">rabbitmq-diagnostics</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">status</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">amqp</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">rabbitmq-diagnostics</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">status</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-storage</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">items:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">rabbitmq.conf</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">rabbitmq.conf</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">enabled_plugins</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">enabled_plugins</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-config</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\">        <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-storage</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">&quot;managed-nfs-storage&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">2Gi</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里指定了storageclass的名字为：<code>managed-nfs-storage</code>，需要根据实际情况调整</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"部署服务\"><a href=\"#部署服务\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h2><p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f .</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查\"><a href=\"#检查\" class=\"headerlink\" title=\"检查\"></a>检查</h2><p>执行下面的命令检查资源创建情况，确保pod都处于运行状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,sts -n default</span><br></pre></td></tr></table></figure>\n\n\n\n<img src= \"/img/loading.gif\" data-src=\"./bushu.png\" style=\"zoom:70%;\" />\n\n\n\n<p>检查pod日志，观察集群建立情况：</p>\n<img src= \"/img/loading.gif\" data-src=\"./log.png\" style=\"zoom:70%;\" />\n\n\n\n<p>进入pod中，通过客户端命令查看集群状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -ti  rabbitmq-cluster-0 -n default -- rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./client_log.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问管理页面\"><a href=\"#访问管理页面\" class=\"headerlink\" title=\"访问管理页面\"></a>访问管理页面</h2><p>查看对应service使用的宿主机端口：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n default</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./service.png\" style=\"zoom:70%;\" />\n\n\n\n<p>通过浏览器访问node节点的30888端口即可打开rabbitmq的管理页面：</p>\n<img src= \"/img/loading.gif\" data-src=\"./web.png\" style=\"zoom:70%;\" />\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中使用有状态服务Statfulset方式部署一个RabbitMQ 3.8.3 版本的集群</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h1><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">K8S集群环境</button></li><li class=\"tab\"><button data-href=\"#comments-2\">RabbitMq</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>本文使用的 k8s版本为 <code>1.20.4</code>版本，将使用<code>storageclass</code>作为持久化存储，底层为<code>nfs</code>，使用<code>default</code> namespace部署。</p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p><code>RabbitMQ</code>在<code>k8s</code>集群中通过<code>rabbitmq_peer_discovery_k8s plugin</code>与<code>k8s apiserver</code>进行交互，获取各个服务的<code>URL</code>，且<code>RabbitMQ</code>在<code>k8s</code>集群中必须用<code>statefulset</code>和<code>headless service</code>进行匹配；</p>\n<blockquote>\n<p>rabbitmq_peer_discovery_k8s<code>是</code>RabbitMQ<code>官方基于第三方开源项目</code>rabbitmq-autocluster<code>开发，对</code>3.7.X<code>及以上版本提供的</code>Kubernetes<code>下的对等发现插件，可实现</code>rabbitmq<code>集群在</code>k8s<code>中的自动化部署，因此低于3.7.X版本请使用</code>rabbitmq-autocluster</p>\n</blockquote>\n<p>这里部署使用的版本是<code>3.8.3</code>，其他版本信息可以参看官方文档：<a href=\"https://www.rabbitmq.com/download.html\">rabbitmq download</a></p><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<br>\n\n\n\n<h1 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h1><h2 id=\"创建相关文件\"><a href=\"#创建相关文件\" class=\"headerlink\" title=\"创建相关文件\"></a>创建相关文件</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">创建configmap</button></li><li class=\"tab\"><button data-href=\"#comments-2\">创建service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">RBAC</button></li><li class=\"tab\"><button data-href=\"#comments-4\">创建statefulset</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><p>创建一个<code>rabbitmq-configmap.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">addonmanager.kubernetes.io/mode:</span> <span class=\"string\">Reconcile</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">    <span class=\"attr\">enabled_plugins:</span> <span class=\"string\">|</span></span><br><span class=\"line\">      [<span class=\"string\">rabbitmq_management</span>,<span class=\"string\">rabbitmq_peer_discovery_k8s</span>]<span class=\"string\">.</span></span><br><span class=\"line\">    <span class=\"attr\">rabbitmq.conf:</span> <span class=\"string\">|</span></span><br><span class=\"line\">      <span class=\"string\">default_user</span> <span class=\"string\">=</span> <span class=\"string\">admin</span></span><br><span class=\"line\">      <span class=\"string\">default_pass</span> <span class=\"string\">=</span> <span class=\"number\">123</span><span class=\"type\">!@#</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.peer_discovery_backend</span> <span class=\"string\">=</span> <span class=\"string\">rabbit_peer_discovery_k8s</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.host</span> <span class=\"string\">=</span> <span class=\"string\">kubernetes.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.address_type</span> <span class=\"string\">=</span> <span class=\"string\">hostname</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.node_cleanup.interval</span> <span class=\"string\">=</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.node_cleanup.only_log_warning</span> <span class=\"string\">=</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"string\">cluster_partition_handling</span> <span class=\"string\">=</span> <span class=\"string\">autoheal</span></span><br><span class=\"line\">      <span class=\"string\">queue_master_locator=min-masters</span></span><br><span class=\"line\">      <span class=\"string\">loopback_users.guest</span> <span class=\"string\">=</span> <span class=\"literal\">false</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.randomized_startup_delay_range.min</span> <span class=\"string\">=</span> <span class=\"number\">0</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.randomized_startup_delay_range.max</span> <span class=\"string\">=</span> <span class=\"number\">2</span></span><br><span class=\"line\">      <span class=\"string\">cluster_formation.k8s.hostname_suffix</span> <span class=\"string\">=</span> <span class=\"string\">.rabbitmq-cluster.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"string\">vm_memory_high_watermark.absolute</span> <span class=\"string\">=</span> <span class=\"string\">1GB</span></span><br><span class=\"line\">      <span class=\"string\">disk_free_limit.absolute</span> <span class=\"string\">=</span> <span class=\"string\">2GB</span></span><br></pre></td></tr></table></figure>\n\n\n\n<ul>\n<li><code>enabled_plugins</code>：声明开启的插件；</li>\n<li><code>default_user/default_pass</code>：指定用户名和密码；</li>\n<li><code>cluster_formation.k8s.address_type</code>：从<code>k8s</code>返回的<code>Pod</code>容器列表中计算对等节点列表，这里只能使用主机名，官方示例中是<code>ip</code>，但是默认情况下在<code>k8s</code>中<code>pod</code>的<code>ip</code>都是不固定的，因此可能导致节点的配置和数据丢失，后面的<code>yaml</code>中会通过引用元数据的方式固定<code>pod</code>的主机名；</li>\n</ul><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><p>创建一个<code>rabbitmq-service.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">rmqport</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-manage</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>这里定义了两个service，一个是<code>NodePort</code>用于用户通过web访问的管理页面，另一个是用于rabbitmq服务通信；</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><p>创建一个<code>rabbitmq-rbac.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-4\"><p>创建一个<code>rabbitmq-cluster-sts.yaml</code>的文件：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">cp</span> <span class=\"string\">-v</span> <span class=\"string\">/etc/rabbitmq/rabbitmq.conf</span> <span class=\"string\">$&#123;RABBITMQ_CONFIG_FILE&#125;;</span> <span class=\"string\">exec</span> <span class=\"string\">docker-entrypoint.sh</span></span><br><span class=\"line\">          <span class=\"string\">rabbitmq-server</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">sh</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TZ</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;Asia/Shanghai&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_ERLANG_COOKIE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&#x27;SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY=&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">K8S_SERVICE_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_IP</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAMESPACE</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_USE_LONGNAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_NODENAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">rabbit@$(POD_NAME).$(K8S_SERVICE_NAME).$(POD_NAMESPACE).svc.cluster.local</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">RABBITMQ_CONFIG_FILE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">/var/lib/rabbitmq/rabbitmq.conf</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">rabbitmq:3.8.3-management</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">rabbitmq-diagnostics</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">status</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">5672</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">amqp</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">exec:</span></span><br><span class=\"line\">            <span class=\"attr\">command:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">rabbitmq-diagnostics</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">status</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/rabbitmq</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-storage</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">rabbitmq-cluster</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config-volume</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">items:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">rabbitmq.conf</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">rabbitmq.conf</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">enabled_plugins</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">enabled_plugins</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-cluster-config</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">timezone</span></span><br><span class=\"line\">        <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">rabbitmq-storage</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">&quot;managed-nfs-storage&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">2Gi</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里指定了storageclass的名字为：<code>managed-nfs-storage</code>，需要根据实际情况调整</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"部署服务\"><a href=\"#部署服务\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h2><p>执行下面的命令完成部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f .</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"检查\"><a href=\"#检查\" class=\"headerlink\" title=\"检查\"></a>检查</h2><p>执行下面的命令检查资源创建情况，确保pod都处于运行状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,sts -n default</span><br></pre></td></tr></table></figure>\n\n\n\n<img src=\"./bushu.png\" style=\"zoom:70%;\" />\n\n\n\n<p>检查pod日志，观察集群建立情况：</p>\n<img src=\"./log.png\" style=\"zoom:70%;\" />\n\n\n\n<p>进入pod中，通过客户端命令查看集群状态：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"built_in\">exec</span> -ti  rabbitmq-cluster-0 -n default -- rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>\n\n<img src=\"./client_log.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问管理页面\"><a href=\"#访问管理页面\" class=\"headerlink\" title=\"访问管理页面\"></a>访问管理页面</h2><p>查看对应service使用的宿主机端口：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n default</span><br></pre></td></tr></table></figure>\n\n<img src=\"./service.png\" style=\"zoom:70%;\" />\n\n\n\n<p>通过浏览器访问node节点的30888端口即可打开rabbitmq的管理页面：</p>\n<img src=\"./web.png\" style=\"zoom:70%;\" />\n\n"},{"title":"部署Ingress","date":"2021-03-20T07:13:31.000Z","description":"在k8s集群中部署ingress-nginx","cover":"https://www.kubernetes.org.cn/img/2019/10/fe9890c6467aa42ebd24d536416942d3-768x442.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中部署Ingress-nginx。\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 什么是Ingress\n\nIngress实际是集群的流量统一入口，可以根据不同请求的URL将流量转发给集群中的服务（通过Ingress-Controller实现）。目前有很多Ingress-controller的实现方案：\n\n- `Ingress NGINX`: Kubernetes 官方维护的方案，也是本次安装使用的 Controller；\n- `F5 BIG-IP Controller`: F5 所开发的 Controller，它能够让管理员通过 CLI 或 API 让 Kubernetes 与 OpenShift 管理 F5 BIG-IP 设备；\n- `Ingress Kong`: 著名的开源 API Gateway 方案所维护的 Kubernetes Ingress Controller；\n- `Traefik`: 是一套开源的 HTTP 反向代理与负载均衡器，而它也支援了 Ingress；\n- `Voyager`: 一套以 HAProxy 为底的 Ingress Controller；\n\n\n\n这里使用的是Ingress Nginx，它实质就是一个nginx服务，他可以通过apiserver动态更新nginx的配置，实现基于域名的虚拟主机工功能。\n\n\n\n<br>\n\n\n\n## 部署Ingress Nginx\n\n官方维护的配置yaml文件在 [官方YAML文件](https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml)，可以直接执行下面的命令部署：\n\n```bash\n$ kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml\n```\n\n\n\n这个文件会创建一个名为：`ingress-nginx`的namespace，相关的pod会部署在这个namespace下面。\n\n\n\n有一点需要注意的是，最好修改一下这个文件中deployment的这个地方：\n\n```yaml\nspec:\n      hostNetwork: true\n      dnsPolicy: ClusterFirst\n      containers:\n        - name: controller\n          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.32.0\n          imagePullPolicy: IfNotPresent\n```\n\n> 这里增加了`hostNetwork: true`，让ingress使用host网络，这样才可以通过默认的service配置被外部访问。\n\n\n\n使用下面的命令进行部署：\n\n```bash\nkubectl apply -f deploy.yaml\n```\n\n\n\n<br>\n\n","source":"_posts/部署Ingress.md","raw":"---\ntitle: 部署Ingress\ndate: 2021-03-20 15:13:31\ntags:\n- Ingress\ncategories:\n- Kubernetes\n- Ingress-nginx\ndescription: 在k8s集群中部署ingress-nginx\ncover: https://www.kubernetes.org.cn/img/2019/10/fe9890c6467aa42ebd24d536416942d3-768x442.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中部署Ingress-nginx。\n\n更新于 2021-03-20\n\n{% endnote %}\n\n<br>\n\n\n\n# 什么是Ingress\n\nIngress实际是集群的流量统一入口，可以根据不同请求的URL将流量转发给集群中的服务（通过Ingress-Controller实现）。目前有很多Ingress-controller的实现方案：\n\n- `Ingress NGINX`: Kubernetes 官方维护的方案，也是本次安装使用的 Controller；\n- `F5 BIG-IP Controller`: F5 所开发的 Controller，它能够让管理员通过 CLI 或 API 让 Kubernetes 与 OpenShift 管理 F5 BIG-IP 设备；\n- `Ingress Kong`: 著名的开源 API Gateway 方案所维护的 Kubernetes Ingress Controller；\n- `Traefik`: 是一套开源的 HTTP 反向代理与负载均衡器，而它也支援了 Ingress；\n- `Voyager`: 一套以 HAProxy 为底的 Ingress Controller；\n\n\n\n这里使用的是Ingress Nginx，它实质就是一个nginx服务，他可以通过apiserver动态更新nginx的配置，实现基于域名的虚拟主机工功能。\n\n\n\n<br>\n\n\n\n## 部署Ingress Nginx\n\n官方维护的配置yaml文件在 [官方YAML文件](https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml)，可以直接执行下面的命令部署：\n\n```bash\n$ kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml\n```\n\n\n\n这个文件会创建一个名为：`ingress-nginx`的namespace，相关的pod会部署在这个namespace下面。\n\n\n\n有一点需要注意的是，最好修改一下这个文件中deployment的这个地方：\n\n```yaml\nspec:\n      hostNetwork: true\n      dnsPolicy: ClusterFirst\n      containers:\n        - name: controller\n          image: quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.32.0\n          imagePullPolicy: IfNotPresent\n```\n\n> 这里增加了`hostNetwork: true`，让ingress使用host网络，这样才可以通过默认的service配置被外部访问。\n\n\n\n使用下面的命令进行部署：\n\n```bash\nkubectl apply -f deploy.yaml\n```\n\n\n\n<br>\n\n","slug":"部署Ingress","published":1,"updated":"2021-03-20T07:33:34.178Z","_id":"ckmhedtrq000069kl21spa224","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中部署Ingress-nginx。</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"什么是Ingress\"><a href=\"#什么是Ingress\" class=\"headerlink\" title=\"什么是Ingress\"></a>什么是Ingress</h1><p>Ingress实际是集群的流量统一入口，可以根据不同请求的URL将流量转发给集群中的服务（通过Ingress-Controller实现）。目前有很多Ingress-controller的实现方案：</p>\n<ul>\n<li><code>Ingress NGINX</code>: Kubernetes 官方维护的方案，也是本次安装使用的 Controller；</li>\n<li><code>F5 BIG-IP Controller</code>: F5 所开发的 Controller，它能够让管理员通过 CLI 或 API 让 Kubernetes 与 OpenShift 管理 F5 BIG-IP 设备；</li>\n<li><code>Ingress Kong</code>: 著名的开源 API Gateway 方案所维护的 Kubernetes Ingress Controller；</li>\n<li><code>Traefik</code>: 是一套开源的 HTTP 反向代理与负载均衡器，而它也支援了 Ingress；</li>\n<li><code>Voyager</code>: 一套以 HAProxy 为底的 Ingress Controller；</li>\n</ul>\n<p>这里使用的是Ingress Nginx，它实质就是一个nginx服务，他可以通过apiserver动态更新nginx的配置，实现基于域名的虚拟主机工功能。</p>\n<br>\n\n\n\n<h2 id=\"部署Ingress-Nginx\"><a href=\"#部署Ingress-Nginx\" class=\"headerlink\" title=\"部署Ingress Nginx\"></a>部署Ingress Nginx</h2><p>官方维护的配置yaml文件在 <a href=\"https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml\">官方YAML文件</a>，可以直接执行下面的命令部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<p>这个文件会创建一个名为：<code>ingress-nginx</code>的namespace，相关的pod会部署在这个namespace下面。</p>\n<p>有一点需要注意的是，最好修改一下这个文件中deployment的这个地方：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">hostNetwork:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.32.0</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里增加了<code>hostNetwork: true</code>，让ingress使用host网络，这样才可以通过默认的service配置被外部访问。</p>\n</blockquote>\n<p>使用下面的命令进行部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f deploy.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中部署Ingress-nginx。</p><p>更新于 2021-03-20</p>\n          </div>\n\n<br>\n\n\n\n<h1 id=\"什么是Ingress\"><a href=\"#什么是Ingress\" class=\"headerlink\" title=\"什么是Ingress\"></a>什么是Ingress</h1><p>Ingress实际是集群的流量统一入口，可以根据不同请求的URL将流量转发给集群中的服务（通过Ingress-Controller实现）。目前有很多Ingress-controller的实现方案：</p>\n<ul>\n<li><code>Ingress NGINX</code>: Kubernetes 官方维护的方案，也是本次安装使用的 Controller；</li>\n<li><code>F5 BIG-IP Controller</code>: F5 所开发的 Controller，它能够让管理员通过 CLI 或 API 让 Kubernetes 与 OpenShift 管理 F5 BIG-IP 设备；</li>\n<li><code>Ingress Kong</code>: 著名的开源 API Gateway 方案所维护的 Kubernetes Ingress Controller；</li>\n<li><code>Traefik</code>: 是一套开源的 HTTP 反向代理与负载均衡器，而它也支援了 Ingress；</li>\n<li><code>Voyager</code>: 一套以 HAProxy 为底的 Ingress Controller；</li>\n</ul>\n<p>这里使用的是Ingress Nginx，它实质就是一个nginx服务，他可以通过apiserver动态更新nginx的配置，实现基于域名的虚拟主机工功能。</p>\n<br>\n\n\n\n<h2 id=\"部署Ingress-Nginx\"><a href=\"#部署Ingress-Nginx\" class=\"headerlink\" title=\"部署Ingress Nginx\"></a>部署Ingress Nginx</h2><p>官方维护的配置yaml文件在 <a href=\"https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml\">官方YAML文件</a>，可以直接执行下面的命令部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ kubectl apply -f https://github.com/kubernetes/ingress-nginx/blob/master/deploy/static/provider/cloud/deploy.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<p>这个文件会创建一个名为：<code>ingress-nginx</code>的namespace，相关的pod会部署在这个namespace下面。</p>\n<p>有一点需要注意的是，最好修改一下这个文件中deployment的这个地方：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">hostNetwork:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.32.0</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里增加了<code>hostNetwork: true</code>，让ingress使用host网络，这样才可以通过默认的service配置被外部访问。</p>\n</blockquote>\n<p>使用下面的命令进行部署：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f deploy.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<br>\n\n"},{"title":"ingress-nginx实现蓝绿、灰度发布","date":"2021-03-20T07:34:11.000Z","description":"利用ingress特性实现在k8s中的蓝绿、灰度发布","cover":"https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg","_content":"\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中利用 Ingress-nginx 的 Canary 功能实现蓝绿、灰度发布\n\n更新于 2021-03-20\n\n{% endnote %}\n\n\n\n<br>\n\n\n\n# Canary功能介绍\n\nIngress-Nginx在0.21版本引入了Canary功能，可以为网关入口配置多个版本的应用程序，使用annotation来控制多个后端服务的流量分配。\n\n\n\ncanary通过下面的一些注释来实现流量分配：\n\n- `nginx.ingress.kubernetes.io/canary: \"true\"`：启用Canary功能；\n- `nginx.ingress.kubernetes.io/canary-weight` ：指定一个0-100的整数，根据设置的值来决定大概有百分之多少的流量会分配Canary Ingress中指定的后端服务；\n- `nginx.ingress.kubernetes.io/canary-by-header` ：基于request header 的流量切分，适用于灰度发布或者A/B测试，当设定的hearder值为always是，请求流量会被一直分配到Canary入口，当hearder值被设置为never时，请求流量不会分配到Canary入口，对于其他hearder值，将忽略，并通过优先级将请求流量分配到其他规则；\n- `nginx.ingress.kubernetes.io/canary-by-header-value`： 要和`nginx.ingress.kubernetes.io/canary-by-header` 一起使用，当请求中的hearder key和value 与`nginx.ingress.kubernetes.io/canary-by-header` `nginx.ingress.kubernetes.io/canary-by-header-value`匹配时，请求流量会被分配到Canary Ingress入口，对于其他任何hearder值，将忽略，并通过优先级将请求流量分配到其他规则；\n- `nginx.ingress.kubernetes.io/canary-by-cookie` ：基于cookie的流量切分，也适用于灰度发布或者A/B测试，当cookie值设置为always时，请求流量将被路由到Canary Ingress入口，当cookie值设置为never时，请求流量将不会路由到Canary入口，对于其他值，将忽略，并通过优先级将请求流量分配到其他规则；\n\n\n\n以上几种注释的优先级为：**canary-by-header - > canary-by-cookie - > canary-weight**\n\n\n\n<br>\n\n\n\n# 基于权重分配流量\n\n## 创建v1版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n  labels:\n    app: echoserverv1\n  name: echoserverv1\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv1\n          servicePort: 8080\n        path: /\n```\n\n\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv1\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv1\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv1\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv1\n  namespace: echoserver\n  labels:\n    name:  echoserverv1\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv1\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv1 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv1\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查创建情况\n\n```bash\nkubectl get pod,service,ingress -n echoserver\n```\n\n<img src=\"./pod.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问服务\n\n```bash\nfor i in `seq 10`;do curl -s echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v1.png\" style=\"zoom:70%;\" />\n\n\n\n>  可以看到，所有的请求都正常返回且版本为v1\n\n\n\n## 发布v2版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n> 注意这里的ingress就开启了canary功能，切设置权重为50%\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv2\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv2\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\n  labels:\n    name:  echoserverv2\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv2\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv2 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv2\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查v2版本服务\n\n```bash\nkubectl get pod,service,ingress -n echoserver\n```\n\n<img src=\"./v2.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问服务\n\n```bash\nfor i in `seq 10`;do curl -s echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-wight.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到，v1和v2两个版本的请求比几乎是50%\n\n\n\n\n\n<br>\n\n\n\n# 基于header的流量分配\n\n## 更新v2版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"v2\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n> 注意这里设置了`nginx.ingress.kubernetes.io/canary-by-header`\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv2\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv2\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\n  labels:\n    name:  echoserverv2\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv2\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv2 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv2\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 访问服务\n\n因为设置了`nginx.ingress.kubernetes.io/canary-by-header: v2`，将会出现以下的集中情况：\n\n{% tabs comments %}\n\n<!-- tab 请求header为 v2:always -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:always\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-ha.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到请求的header-key为v2，value为always，流量将全部调度到v2版本\n\n<!-- endtab -->\n\n<!-- tab 请求header为 v2:never -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:never\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-never.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到请求的header-key为v2，value为never，流量将全部调度到v1版本\n\n<!-- endtab -->\n\n<!-- tab 请求header为 v2，header-key任意 -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:true\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-true.png\" style=\"zoom:70%;\" />\n\n> 可以看到请求的header-key为v2，value为其他值，流量将根据权重比例进行分配\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 按照header key/value进行分配\n\n只需要在v2版本的ingress中指定`nginx.ingress.kubernetes.io/canary-by-header-value`即可：\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"v2\"\n    nginx.ingress.kubernetes.io/canary-by-header-value: \"true\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n\n\n此时因为指定了header key和value，则请求的header必须包含：`v2:true`才能进入v2版本，否则会按照比例进行v1，v2版本分配。\n\n\n\n<br>\n\n\n\n# 基于cookie进行流量分配\n\n## 更新v2版本服务\n\n\n\n基于cookie进行分配的时候，不能定义cookie的value\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-cookie: \"user_from_shanghai\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n\n\n## 访问服务\n\n{% tabs comments %}\n\n<!-- tab 设置cookie user_from_shanghai -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai\" echo.example.com|grep Hostname;done\n```\n\n\n\n> 请求将按照比例分配到两个版本\n\n<!-- endtab -->\n\n<!-- tab 设置cookie user_from_shanghai:always -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai:always\" echo.example.com|grep Hostname;done\n```\n\n\n\n> 请求将按照比例分配到两个版本\n\n<!-- endtab -->\n\n<!-- tab 设置coolie user_from_shanghai=always -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai=always\" echo.example.com|grep Hostname;done\n```\n\n> 请求将全部进入v2版本\n\n<!-- endtab -->\n\n{% endtabs %}\n\n","source":"_posts/ingress-nginx实现蓝绿、灰度发布.md","raw":"---\ntitle: ingress-nginx实现蓝绿、灰度发布\ndate: 2021-03-20 15:34:11\ntags:\n- Ingress\ncategories:\n- Kubernetes\n- Ingress-nginx\ndescription: 利用ingress特性实现在k8s中的蓝绿、灰度发布\ncover: https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg\n---\n\n\n\n{% note info 'fas fa-bullhorn' %}\n\n本文主要介绍了在k8s中利用 Ingress-nginx 的 Canary 功能实现蓝绿、灰度发布\n\n更新于 2021-03-20\n\n{% endnote %}\n\n\n\n<br>\n\n\n\n# Canary功能介绍\n\nIngress-Nginx在0.21版本引入了Canary功能，可以为网关入口配置多个版本的应用程序，使用annotation来控制多个后端服务的流量分配。\n\n\n\ncanary通过下面的一些注释来实现流量分配：\n\n- `nginx.ingress.kubernetes.io/canary: \"true\"`：启用Canary功能；\n- `nginx.ingress.kubernetes.io/canary-weight` ：指定一个0-100的整数，根据设置的值来决定大概有百分之多少的流量会分配Canary Ingress中指定的后端服务；\n- `nginx.ingress.kubernetes.io/canary-by-header` ：基于request header 的流量切分，适用于灰度发布或者A/B测试，当设定的hearder值为always是，请求流量会被一直分配到Canary入口，当hearder值被设置为never时，请求流量不会分配到Canary入口，对于其他hearder值，将忽略，并通过优先级将请求流量分配到其他规则；\n- `nginx.ingress.kubernetes.io/canary-by-header-value`： 要和`nginx.ingress.kubernetes.io/canary-by-header` 一起使用，当请求中的hearder key和value 与`nginx.ingress.kubernetes.io/canary-by-header` `nginx.ingress.kubernetes.io/canary-by-header-value`匹配时，请求流量会被分配到Canary Ingress入口，对于其他任何hearder值，将忽略，并通过优先级将请求流量分配到其他规则；\n- `nginx.ingress.kubernetes.io/canary-by-cookie` ：基于cookie的流量切分，也适用于灰度发布或者A/B测试，当cookie值设置为always时，请求流量将被路由到Canary Ingress入口，当cookie值设置为never时，请求流量将不会路由到Canary入口，对于其他值，将忽略，并通过优先级将请求流量分配到其他规则；\n\n\n\n以上几种注释的优先级为：**canary-by-header - > canary-by-cookie - > canary-weight**\n\n\n\n<br>\n\n\n\n# 基于权重分配流量\n\n## 创建v1版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n  labels:\n    app: echoserverv1\n  name: echoserverv1\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv1\n          servicePort: 8080\n        path: /\n```\n\n\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv1\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv1\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv1\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv1\n  namespace: echoserver\n  labels:\n    name:  echoserverv1\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv1\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv1 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv1\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查创建情况\n\n```bash\nkubectl get pod,service,ingress -n echoserver\n```\n\n<img src=\"./pod.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问服务\n\n```bash\nfor i in `seq 10`;do curl -s echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v1.png\" style=\"zoom:70%;\" />\n\n\n\n>  可以看到，所有的请求都正常返回且版本为v1\n\n\n\n## 发布v2版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n> 注意这里的ingress就开启了canary功能，切设置权重为50%\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv2\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv2\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\n  labels:\n    name:  echoserverv2\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv2\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv2 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv2\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 检查v2版本服务\n\n```bash\nkubectl get pod,service,ingress -n echoserver\n```\n\n<img src=\"./v2.png\" style=\"zoom:70%;\" />\n\n\n\n## 访问服务\n\n```bash\nfor i in `seq 10`;do curl -s echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-wight.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到，v1和v2两个版本的请求比几乎是50%\n\n\n\n\n\n<br>\n\n\n\n# 基于header的流量分配\n\n## 更新v2版本服务\n\n{% tabs comments %}\n\n<!-- tab Ingress -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"v2\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n> 注意这里设置了`nginx.ingress.kubernetes.io/canary-by-header`\n\n<!-- endtab -->\n\n<!-- tab Service -->\n\n```yaml\nkind: Service\napiVersion: v1\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\nspec:\n  selector:\n    name:  echoserverv2\n  type:  ClusterIP\n  ports:\n  - name:  echoserverv2\n    port:  8080\n    targetPort:  8080\n```\n\n<!-- endtab -->\n\n<!-- tab Deployment -->\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Deployment\nmetadata:\n  name:  echoserverv2\n  namespace: echoserver\n  labels:\n    name:  echoserverv2\nspec:\n  template:\n    metadata:\n      labels:\n        name:  echoserverv2\n    spec:\n      containers:\n      - image:  mirrorgooglecontainers/echoserver:1.10\n        name:  echoserverv2 \n        ports:\n        - containerPort:  8080\n          name:  echoserverv2\n```\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 访问服务\n\n因为设置了`nginx.ingress.kubernetes.io/canary-by-header: v2`，将会出现以下的集中情况：\n\n{% tabs comments %}\n\n<!-- tab 请求header为 v2:always -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:always\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-ha.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到请求的header-key为v2，value为always，流量将全部调度到v2版本\n\n<!-- endtab -->\n\n<!-- tab 请求header为 v2:never -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:never\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-never.png\" style=\"zoom:70%;\" />\n\n\n\n> 可以看到请求的header-key为v2，value为never，流量将全部调度到v1版本\n\n<!-- endtab -->\n\n<!-- tab 请求header为 v2，header-key任意 -->\n\n```bash\nfor i in `seq 10`;do curl -s -H \"v2:true\" echo.example.com|grep Hostname;done\n```\n\n<img src=\"./v2-true.png\" style=\"zoom:70%;\" />\n\n> 可以看到请求的header-key为v2，value为其他值，流量将根据权重比例进行分配\n\n<!-- endtab -->\n\n{% endtabs %}\n\n\n\n## 按照header key/value进行分配\n\n只需要在v2版本的ingress中指定`nginx.ingress.kubernetes.io/canary-by-header-value`即可：\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-header: \"v2\"\n    nginx.ingress.kubernetes.io/canary-by-header-value: \"true\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n\n\n此时因为指定了header key和value，则请求的header必须包含：`v2:true`才能进入v2版本，否则会按照比例进行v1，v2版本分配。\n\n\n\n<br>\n\n\n\n# 基于cookie进行流量分配\n\n## 更新v2版本服务\n\n\n\n基于cookie进行分配的时候，不能定义cookie的value\n\n```yaml\napiVersion: extensions/v1beta1\nkind: Ingress\nmetadata:\n  annotations:\n    kubernetes.io/ingress.class: nginx\n    nginx.ingress.kubernetes.io/canary: \"true\"\n    nginx.ingress.kubernetes.io/canary-weight: \"50\"\n    nginx.ingress.kubernetes.io/canary-by-cookie: \"user_from_shanghai\"\n  labels:\n    app: echoserverv2\n  name: echoserverv2\n  namespace: echoserver\nspec:\n  rules:\n  - host: echo.example.com\n    http:\n      paths:\n      - backend:\n          serviceName: echoserverv2\n          servicePort: 8080\n        path: /\n```\n\n\n\n## 访问服务\n\n{% tabs comments %}\n\n<!-- tab 设置cookie user_from_shanghai -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai\" echo.example.com|grep Hostname;done\n```\n\n\n\n> 请求将按照比例分配到两个版本\n\n<!-- endtab -->\n\n<!-- tab 设置cookie user_from_shanghai:always -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai:always\" echo.example.com|grep Hostname;done\n```\n\n\n\n> 请求将按照比例分配到两个版本\n\n<!-- endtab -->\n\n<!-- tab 设置coolie user_from_shanghai=always -->\n\n```bash\nfor i in `seq 10`;do curl -s --cookie \"user_from_shanghai=always\" echo.example.com|grep Hostname;done\n```\n\n> 请求将全部进入v2版本\n\n<!-- endtab -->\n\n{% endtabs %}\n\n","slug":"ingress-nginx实现蓝绿、灰度发布","published":1,"updated":"2021-03-20T08:55:31.405Z","_id":"ckmhfeglz0000a9kl96lc40q7","comments":1,"layout":"post","photos":[],"link":"","content":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中利用 Ingress-nginx 的 Canary 功能实现蓝绿、灰度发布</p><p>更新于 2021-03-20</p>\n          </div>\n\n\n\n<br>\n\n\n\n<h1 id=\"Canary功能介绍\"><a href=\"#Canary功能介绍\" class=\"headerlink\" title=\"Canary功能介绍\"></a>Canary功能介绍</h1><p>Ingress-Nginx在0.21版本引入了Canary功能，可以为网关入口配置多个版本的应用程序，使用annotation来控制多个后端服务的流量分配。</p>\n<p>canary通过下面的一些注释来实现流量分配：</p>\n<ul>\n<li><code>nginx.ingress.kubernetes.io/canary: &quot;true&quot;</code>：启用Canary功能；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-weight</code> ：指定一个0-100的整数，根据设置的值来决定大概有百分之多少的流量会分配Canary Ingress中指定的后端服务；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-header</code> ：基于request header 的流量切分，适用于灰度发布或者A/B测试，当设定的hearder值为always是，请求流量会被一直分配到Canary入口，当hearder值被设置为never时，请求流量不会分配到Canary入口，对于其他hearder值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-header-value</code>： 要和<code>nginx.ingress.kubernetes.io/canary-by-header</code> 一起使用，当请求中的hearder key和value 与<code>nginx.ingress.kubernetes.io/canary-by-header</code> <code>nginx.ingress.kubernetes.io/canary-by-header-value</code>匹配时，请求流量会被分配到Canary Ingress入口，对于其他任何hearder值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-cookie</code> ：基于cookie的流量切分，也适用于灰度发布或者A/B测试，当cookie值设置为always时，请求流量将被路由到Canary Ingress入口，当cookie值设置为never时，请求流量将不会路由到Canary入口，对于其他值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n</ul>\n<p>以上几种注释的优先级为：<strong>canary-by-header - &gt; canary-by-cookie - &gt; canary-weight</strong></p>\n<br>\n\n\n\n<h1 id=\"基于权重分配流量\"><a href=\"#基于权重分配流量\" class=\"headerlink\" title=\"基于权重分配流量\"></a>基于权重分配流量</h1><h2 id=\"创建v1版本服务\"><a href=\"#创建v1版本服务\" class=\"headerlink\" title=\"创建v1版本服务\"></a>创建v1版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查创建情况\"><a href=\"#检查创建情况\" class=\"headerlink\" title=\"检查创建情况\"></a>检查创建情况</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,service,ingress -n echoserver</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./pod.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问服务\"><a href=\"#访问服务\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v1.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p> 可以看到，所有的请求都正常返回且版本为v1</p>\n</blockquote>\n<h2 id=\"发布v2版本服务\"><a href=\"#发布v2版本服务\" class=\"headerlink\" title=\"发布v2版本服务\"></a>发布v2版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意这里的ingress就开启了canary功能，切设置权重为50%</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查v2版本服务\"><a href=\"#检查v2版本服务\" class=\"headerlink\" title=\"检查v2版本服务\"></a>检查v2版本服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,service,ingress -n echoserver</span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问服务-1\"><a href=\"#访问服务-1\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2-wight.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到，v1和v2两个版本的请求比几乎是50%</p>\n</blockquote>\n<br>\n\n\n\n<h1 id=\"基于header的流量分配\"><a href=\"#基于header的流量分配\" class=\"headerlink\" title=\"基于header的流量分配\"></a>基于header的流量分配</h1><h2 id=\"更新v2版本服务\"><a href=\"#更新v2版本服务\" class=\"headerlink\" title=\"更新v2版本服务\"></a>更新v2版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意这里设置了<code>nginx.ingress.kubernetes.io/canary-by-header</code></p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"访问服务-2\"><a href=\"#访问服务-2\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><p>因为设置了<code>nginx.ingress.kubernetes.io/canary-by-header: v2</code>，将会出现以下的集中情况：</p>\n<div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">请求header为 v2:always</button></li><li class=\"tab\"><button data-href=\"#comments-2\">请求header为 v2:never</button></li><li class=\"tab\"><button data-href=\"#comments-3\">请求header为 v2，header-key任意</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2-ha.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为always，流量将全部调度到v2版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:never&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2-never.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为never，流量将全部调度到v1版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:true&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src= \"/img/loading.gif\" data-src=\"./v2-true.png\" style=\"zoom:70%;\" />\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为其他值，流量将根据权重比例进行分配</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"按照header-key-value进行分配\"><a href=\"#按照header-key-value进行分配\" class=\"headerlink\" title=\"按照header key/value进行分配\"></a>按照header key/value进行分配</h2><p>只需要在v2版本的ingress中指定<code>nginx.ingress.kubernetes.io/canary-by-header-value</code>即可：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header-value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>此时因为指定了header key和value，则请求的header必须包含：<code>v2:true</code>才能进入v2版本，否则会按照比例进行v1，v2版本分配。</p>\n<br>\n\n\n\n<h1 id=\"基于cookie进行流量分配\"><a href=\"#基于cookie进行流量分配\" class=\"headerlink\" title=\"基于cookie进行流量分配\"></a>基于cookie进行流量分配</h1><h2 id=\"更新v2版本服务-1\"><a href=\"#更新v2版本服务-1\" class=\"headerlink\" title=\"更新v2版本服务\"></a>更新v2版本服务</h2><p>基于cookie进行分配的时候，不能定义cookie的value</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class=\"string\">&quot;user_from_shanghai&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"访问服务-3\"><a href=\"#访问服务-3\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">设置cookie user_from_shanghai</button></li><li class=\"tab\"><button data-href=\"#comments-2\">设置cookie user_from_shanghai:always</button></li><li class=\"tab\"><button data-href=\"#comments-3\">设置coolie user_from_shanghai=always</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>请求将按照比例分配到两个版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai:always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>请求将按照比例分配到两个版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai=always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>请求将全部进入v2版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n","site":{"data":{}},"excerpt":"","more":"<div class=\"note info fas fa-bullhorn\">\n            <p>本文主要介绍了在k8s中利用 Ingress-nginx 的 Canary 功能实现蓝绿、灰度发布</p><p>更新于 2021-03-20</p>\n          </div>\n\n\n\n<br>\n\n\n\n<h1 id=\"Canary功能介绍\"><a href=\"#Canary功能介绍\" class=\"headerlink\" title=\"Canary功能介绍\"></a>Canary功能介绍</h1><p>Ingress-Nginx在0.21版本引入了Canary功能，可以为网关入口配置多个版本的应用程序，使用annotation来控制多个后端服务的流量分配。</p>\n<p>canary通过下面的一些注释来实现流量分配：</p>\n<ul>\n<li><code>nginx.ingress.kubernetes.io/canary: &quot;true&quot;</code>：启用Canary功能；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-weight</code> ：指定一个0-100的整数，根据设置的值来决定大概有百分之多少的流量会分配Canary Ingress中指定的后端服务；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-header</code> ：基于request header 的流量切分，适用于灰度发布或者A/B测试，当设定的hearder值为always是，请求流量会被一直分配到Canary入口，当hearder值被设置为never时，请求流量不会分配到Canary入口，对于其他hearder值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-header-value</code>： 要和<code>nginx.ingress.kubernetes.io/canary-by-header</code> 一起使用，当请求中的hearder key和value 与<code>nginx.ingress.kubernetes.io/canary-by-header</code> <code>nginx.ingress.kubernetes.io/canary-by-header-value</code>匹配时，请求流量会被分配到Canary Ingress入口，对于其他任何hearder值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n<li><code>nginx.ingress.kubernetes.io/canary-by-cookie</code> ：基于cookie的流量切分，也适用于灰度发布或者A/B测试，当cookie值设置为always时，请求流量将被路由到Canary Ingress入口，当cookie值设置为never时，请求流量将不会路由到Canary入口，对于其他值，将忽略，并通过优先级将请求流量分配到其他规则；</li>\n</ul>\n<p>以上几种注释的优先级为：<strong>canary-by-header - &gt; canary-by-cookie - &gt; canary-weight</strong></p>\n<br>\n\n\n\n<h1 id=\"基于权重分配流量\"><a href=\"#基于权重分配流量\" class=\"headerlink\" title=\"基于权重分配流量\"></a>基于权重分配流量</h1><h2 id=\"创建v1版本服务\"><a href=\"#创建v1版本服务\" class=\"headerlink\" title=\"创建v1版本服务\"></a>创建v1版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv1</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查创建情况\"><a href=\"#检查创建情况\" class=\"headerlink\" title=\"检查创建情况\"></a>检查创建情况</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,service,ingress -n echoserver</span><br></pre></td></tr></table></figure>\n\n<img src=\"./pod.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问服务\"><a href=\"#访问服务\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v1.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p> 可以看到，所有的请求都正常返回且版本为v1</p>\n</blockquote>\n<h2 id=\"发布v2版本服务\"><a href=\"#发布v2版本服务\" class=\"headerlink\" title=\"发布v2版本服务\"></a>发布v2版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意这里的ingress就开启了canary功能，切设置权重为50%</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"检查v2版本服务\"><a href=\"#检查v2版本服务\" class=\"headerlink\" title=\"检查v2版本服务\"></a>检查v2版本服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get pod,service,ingress -n echoserver</span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2.png\" style=\"zoom:70%;\" />\n\n\n\n<h2 id=\"访问服务-1\"><a href=\"#访问服务-1\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2-wight.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到，v1和v2两个版本的请求比几乎是50%</p>\n</blockquote>\n<br>\n\n\n\n<h1 id=\"基于header的流量分配\"><a href=\"#基于header的流量分配\" class=\"headerlink\" title=\"基于header的流量分配\"></a>基于header的流量分配</h1><h2 id=\"更新v2版本服务\"><a href=\"#更新v2版本服务\" class=\"headerlink\" title=\"更新v2版本服务\"></a>更新v2版本服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">Ingress</button></li><li class=\"tab\"><button data-href=\"#comments-2\">Service</button></li><li class=\"tab\"><button data-href=\"#comments-3\">Deployment</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>注意这里设置了<code>nginx.ingress.kubernetes.io/canary-by-header</code></p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span>  <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span>  <span class=\"number\">8080</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span>  <span class=\"string\">mirrorgooglecontainers/echoserver:1.10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span> </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span>  <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span>  <span class=\"string\">echoserverv2</span></span><br></pre></td></tr></table></figure><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"访问服务-2\"><a href=\"#访问服务-2\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><p>因为设置了<code>nginx.ingress.kubernetes.io/canary-by-header: v2</code>，将会出现以下的集中情况：</p>\n<div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">请求header为 v2:always</button></li><li class=\"tab\"><button data-href=\"#comments-2\">请求header为 v2:never</button></li><li class=\"tab\"><button data-href=\"#comments-3\">请求header为 v2，header-key任意</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2-ha.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为always，流量将全部调度到v2版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:never&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2-never.png\" style=\"zoom:70%;\" />\n\n\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为never，流量将全部调度到v1版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s -H <span class=\"string\">&quot;v2:true&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<img src=\"./v2-true.png\" style=\"zoom:70%;\" />\n\n<blockquote>\n<p>可以看到请求的header-key为v2，value为其他值，流量将根据权重比例进行分配</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n\n\n<h2 id=\"按照header-key-value进行分配\"><a href=\"#按照header-key-value进行分配\" class=\"headerlink\" title=\"按照header key/value进行分配\"></a>按照header key/value进行分配</h2><p>只需要在v2版本的ingress中指定<code>nginx.ingress.kubernetes.io/canary-by-header-value</code>即可：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;v2&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header-value:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n\n\n<p>此时因为指定了header key和value，则请求的header必须包含：<code>v2:true</code>才能进入v2版本，否则会按照比例进行v1，v2版本分配。</p>\n<br>\n\n\n\n<h1 id=\"基于cookie进行流量分配\"><a href=\"#基于cookie进行流量分配\" class=\"headerlink\" title=\"基于cookie进行流量分配\"></a>基于cookie进行流量分配</h1><h2 id=\"更新v2版本服务-1\"><a href=\"#更新v2版本服务-1\" class=\"headerlink\" title=\"更新v2版本服务\"></a>更新v2版本服务</h2><p>基于cookie进行分配的时候，不能定义cookie的value</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">extensions/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;50&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class=\"string\">&quot;user_from_shanghai&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">echoserver</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">echo.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">serviceName:</span> <span class=\"string\">echoserverv2</span></span><br><span class=\"line\">          <span class=\"attr\">servicePort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"访问服务-3\"><a href=\"#访问服务-3\" class=\"headerlink\" title=\"访问服务\"></a>访问服务</h2><div class=\"tabs\" id=\"comments\"><ul class=\"nav-tabs\"><li class=\"tab active\"><button data-href=\"#comments-1\">设置cookie user_from_shanghai</button></li><li class=\"tab\"><button data-href=\"#comments-2\">设置cookie user_from_shanghai:always</button></li><li class=\"tab\"><button data-href=\"#comments-3\">设置coolie user_from_shanghai=always</button></li></ul><div class=\"tab-contents\"><div class=\"tab-item-content active\" id=\"comments-1\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>请求将按照比例分配到两个版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-2\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai:always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>请求将按照比例分配到两个版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div><div class=\"tab-item-content\" id=\"comments-3\"><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `seq 10`;<span class=\"keyword\">do</span> curl -s --cookie <span class=\"string\">&quot;user_from_shanghai=always&quot;</span> echo.example.com|grep Hostname;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>请求将全部进入v2版本</p>\n</blockquote><button class=\"tab-to-top\" onclick=\"scrollToDest($(this).parents('.tabs'),65)\"><i class=\"fas fa-arrow-up\"></i></button></div></div></div>\n\n"}],"PostAsset":[{"_id":"source/_posts/在k8s中部署RabbitMQ/bushu.png","slug":"bushu.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署RabbitMQ/client_log.png","slug":"client_log.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署RabbitMQ/log.png","slug":"log.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署RabbitMQ/service.png","slug":"service.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/在k8s中部署RabbitMQ/web.png","slug":"web.png","post":"ckmhcqa1w0005ihkl8wyy7a8c","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/pod.png","slug":"pod.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v1.png","slug":"v1.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2.png","slug":"v2.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-wight.png","slug":"v2-wight.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-ha.png","slug":"v2-ha.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-never.png","slug":"v2-never.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0},{"_id":"source/_posts/ingress-nginx实现蓝绿、灰度发布/v2-true.png","slug":"v2-true.png","post":"ckmhfeglz0000a9kl96lc40q7","modified":0,"renderable":0}],"PostCategory":[{"post_id":"ckmhcqa1w0005ihkl8wyy7a8c","category_id":"ckmhcqa1z0006ihklc1vl5jh3","_id":"ckmhcqa21000bihklevu22qfj"},{"post_id":"ckmhcqa1w0005ihkl8wyy7a8c","category_id":"ckmhcqa200009ihklec2k1y6e","_id":"ckmhcqa21000cihklgik30wo1"},{"post_id":"ckmhcqa1w0005ihkl8wyy7a8c","category_id":"ckmhcqa20000aihkl1z5r5ap4","_id":"ckmhcqa21000dihkl3aw6eyfz"},{"post_id":"ckmhedtrq000069kl21spa224","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckmhedtru000569kl4gns4ahw"},{"post_id":"ckmhedtrq000069kl21spa224","category_id":"ckmhedtru000469kl8n316bgc","_id":"ckmhedtru000669kl2jusdwkj"},{"post_id":"ckmhfeglz0000a9kl96lc40q7","category_id":"ckmhedtrs000169kl7xhs1t43","_id":"ckmhfegm30002a9kl04fz5b96"},{"post_id":"ckmhfeglz0000a9kl96lc40q7","category_id":"ckmhedtru000469kl8n316bgc","_id":"ckmhfegm30003a9kladk7ddeq"}],"PostTag":[{"post_id":"ckmhcqa1w0005ihkl8wyy7a8c","tag_id":"ckmhcqa1z0007ihkl08q7ftb2","_id":"ckmhcqa200008ihklhscveo6i"},{"post_id":"ckmhedtrq000069kl21spa224","tag_id":"ckmhedtrt000269kl379e6n5x","_id":"ckmhedtrt000369klcp8w3jin"},{"post_id":"ckmhfeglz0000a9kl96lc40q7","tag_id":"ckmhedtrt000269kl379e6n5x","_id":"ckmhfegm30001a9kl7b157g0r"}],"Tag":[{"name":"RabbitMQ","_id":"ckmhcqa1z0007ihkl08q7ftb2"},{"name":"Ingress","_id":"ckmhedtrt000269kl379e6n5x"}]}}