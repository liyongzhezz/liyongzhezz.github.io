<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>kubeadm部署k8s 1.17集群 | 彭彭丁满</title><meta name="description" content="通过kubeadm部署3master节点高可用k8s 1.17.3集群"><meta name="keywords" content="Kubernetes"><meta name="author" content="Luka Vergo"><meta name="copyright" content="Luka Vergo"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://liyongzhezz.github.io/2021/03/28/kubeadm%E9%83%A8%E7%BD%B2k8s-1-18%E9%9B%86%E7%BE%A4/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="kubeadm部署k8s 1.17集群"><meta property="og:url" content="https://liyongzhezz.github.io/2021/03/28/kubeadm%E9%83%A8%E7%BD%B2k8s-1-18%E9%9B%86%E7%BE%A4/"><meta property="og:site_name" content="彭彭丁满"><meta property="og:description" content="通过kubeadm部署3master节点高可用k8s 1.17.3集群"><meta property="og:image" content="https://raw.githubusercontent.com/kubernetes/kubeadm/master/logos/stacked/color/kubeadm-stacked-color.png"><meta property="article:published_time" content="2021-03-28T06:32:13.000Z"><meta property="article:modified_time" content="2021-03-28T07:03:40.676Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = '1'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="prev" title="使用k3d和traefik快速搭建开发环境" href="https://liyongzhezz.github.io/2021/03/28/%E4%BD%BF%E7%94%A8k3d%E5%92%8Ctraefik%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"><link rel="next" title="在k8s中使用EFLK进行日志收集" href="https://liyongzhezz.github.io/2021/03/27/%E5%9C%A8k8s%E4%B8%AD%E4%BD%BF%E7%94%A8EFLK%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-1185009661039450',
  enable_page_level_ads: 'true'
});</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avator.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">38</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">14</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">37</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-home"></i><span> 目录</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"><i class="fa-fw fas fa-archive"></i><span> 消息中间件</span></a></li><li><a class="site-page" href="/categories/Kubernetes/"><i class="fa-fw fas fa-archive"></i><span> Kubernetes</span></a></li><li><a class="site-page" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/"><i class="fa-fw fas fa-archive"></i><span> MySQL</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%84%E5%88%92"><span class="toc-number">1.</span> <span class="toc-text">集群规划</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7"><span class="toc-number">2.</span> <span class="toc-text">安装工具</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96"><span class="toc-number">3.</span> <span class="toc-text">内核优化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%89%8D%E5%87%86%E5%A4%87"><span class="toc-number">4.</span> <span class="toc-text">部署前准备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.</span> <span class="toc-text">安装基础服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0yum%E6%BA%90"><span class="toc-number">5.1.</span> <span class="toc-text">添加yum源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kubelet%E3%80%81kubectl%E3%80%81kubeadm"><span class="toc-number">5.2.</span> <span class="toc-text">安装kubelet、kubectl、kubeadm</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2master%E8%8A%82%E7%82%B9"><span class="toc-number">6.</span> <span class="toc-text">部署master节点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEkubeadm%E5%8F%82%E6%95%B0"><span class="toc-number">6.1.</span> <span class="toc-text">配置kubeadm参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%85%8D%E7%BD%AE"><span class="toc-number">6.2.</span> <span class="toc-text">验证配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4"><span class="toc-number">6.3.</span> <span class="toc-text">创建集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%85%B6%E4%BB%96%E7%9A%84master%E8%8A%82%E7%82%B9"><span class="toc-number">6.4.</span> <span class="toc-text">添加其他的master节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEkubectl"><span class="toc-number">6.5.</span> <span class="toc-text">设置kubectl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81master%E9%83%A8%E7%BD%B2%E6%83%85%E5%86%B5"><span class="toc-number">6.6.</span> <span class="toc-text">验证master部署情况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4kubeproxy%E5%BC%80%E5%90%AF%E4%BA%86ipvs"><span class="toc-number">6.7.</span> <span class="toc-text">确认kubeproxy开启了ipvs</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2etcd"><span class="toc-number">7.</span> <span class="toc-text">部署etcd</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0etcd%E9%85%8D%E7%BD%AE"><span class="toc-number">7.1.</span> <span class="toc-text">更新etcd配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Betcd%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81"><span class="toc-number">7.2.</span> <span class="toc-text">查看etcd节点状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">7.3.</span> <span class="toc-text">查看集群状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#etcd%E8%8A%82%E7%82%B9%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81"><span class="toc-number">7.4.</span> <span class="toc-text">etcd节点健康状态</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2node%E8%8A%82%E7%82%B9"><span class="toc-number">8.</span> <span class="toc-text">部署node节点</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2calico"><span class="toc-number">9.</span> <span class="toc-text">部署calico</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%BD%BDcalico"><span class="toc-number">9.1.</span> <span class="toc-text">下载calico</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2calico-1"><span class="toc-number">9.2.</span> <span class="toc-text">部署calico</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEcalico%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7"><span class="toc-number">9.3.</span> <span class="toc-text">设置calico命令行工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bcalico%E8%8A%82%E7%82%B9"><span class="toc-number">9.4.</span> <span class="toc-text">查看calico节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bippool"><span class="toc-number">9.5.</span> <span class="toc-text">查看ippool</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bip%E7%8A%B6%E6%80%81"><span class="toc-number">9.6.</span> <span class="toc-text">查看ip状态</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%A0%A1%E9%AA%8C"><span class="toc-number">10.</span> <span class="toc-text">集群校验</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx%E6%9C%8D%E5%8A%A1%E5%85%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">11.</span> <span class="toc-text">nginx服务其配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6"><span class="toc-number">11.1.</span> <span class="toc-text">自签证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9nginx%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">11.2.</span> <span class="toc-text">修改nginx主配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%B5%8B%E8%AF%95%E9%85%8D%E7%BD%AE"><span class="toc-number">11.2.1.</span> <span class="toc-text">创建一个测试配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9Ahost"><span class="toc-number">11.2.2.</span> <span class="toc-text">绑定host</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%90%AFnginx%E5%B9%B6%E8%AE%BF%E9%97%AE"><span class="toc-number">11.2.3.</span> <span class="toc-text">重启nginx并访问</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/kubernetes/kubeadm/master/logos/stacked/color/kubeadm-stacked-color.png)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">彭彭丁满</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fas fa-home"></i><span> 目录</span><i class="fas fa-chevron-down menus-expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"><i class="fa-fw fas fa-archive"></i><span> 消息中间件</span></a></li><li><a class="site-page" href="/categories/Kubernetes/"><i class="fa-fw fas fa-archive"></i><span> Kubernetes</span></a></li><li><a class="site-page" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/"><i class="fa-fw fas fa-archive"></i><span> MySQL</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">kubeadm部署k8s 1.17集群</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2021-03-28 14:32:13"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2021-03-28</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2021-03-28 15:03:40"><i class="fas fa-history fa-fw"></i> 更新于 2021-03-28</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/Kubernetes/">Kubernetes</a><i class="fas fa-angle-right post-meta__separator"></i><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/Kubernetes/%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">集群部署</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="far fa-comments fa-fw post-meta__icon"></i><span>评论数:</span><a href="/2021/03/28/kubeadm%E9%83%A8%E7%BD%B2k8s-1-18%E9%9B%86%E7%BE%A4/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><div class="note info fas fa-bullhorn">
            <p>本文主要介绍了通过kubeadm部署3master节点高可用k8s 1.17.3集群 </p><p>更新于 2021-03-28</p>
          </div>

<br>



<h1 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h1><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">IP地址</th>
<th align="center">用途</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SCA-LUM700011</td>
<td align="center">10.8.138.8</td>
<td align="center">nginx+nfs+运维节点</td>
</tr>
<tr>
<td align="center">SCA-LUM700007</td>
<td align="center">10.8.138.5</td>
<td align="center">master-1</td>
</tr>
<tr>
<td align="center">SCA-LUM700008</td>
<td align="center">10.8.138.6</td>
<td align="center">Master-2</td>
</tr>
<tr>
<td align="center">SCA-LUM700012</td>
<td align="center">10.8.138.10</td>
<td align="center">Master-3</td>
</tr>
<tr>
<td align="center">SCA-LUM700013</td>
<td align="center">10.8.138.9</td>
<td align="center">Node-1</td>
</tr>
<tr>
<td align="center">SCA-LUM700014</td>
<td align="center">10.8.138.11</td>
<td align="center">node-2</td>
</tr>
</tbody></table>
<p>操作系统<code>centos7.6</code>，前端还有一个elb，地址为<code>10.8.138.12</code>，代理master的apiserver。kube-proxy使用<code>ipvs</code>模式，集群使用<code>1.17.3</code>版本</p>
<br>



<h1 id="安装工具"><a href="#安装工具" class="headerlink" title="安装工具"></a>安装工具</h1><div class="tabs" id="comments"><ul class="nav-tabs"><li class="tab active"><button data-href="#comments-1">安装nfs</button></li><li class="tab"><button data-href="#comments-2">安装nginx</button></li><li class="tab"><button data-href="#comments-3">安装ansible</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="comments-1"><p>nfs的作用是为集群提供共享存储，nginx后面用来代理集群的ingress等服务。在<code>SCA-LUM700011</code>这台nfs服务器上有挂载的磁盘，先对其格式化并创建nfs的数据目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs /dev/vdb -f</span><br><span class="line">mkdir -p /data/nfs-data</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/dev/vdb /data/nfs-data xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class="line">mount -a</span><br><span class="line">df -h</span><br></pre></td></tr></table></figure>



<p>安装nfs相关服务并启动nfs：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils rpcbind</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/data/nfs-data *(rw,no_root_squash)&quot;</span> &gt;&gt; /etc/exports</span><br><span class="line">systemctl start rpcbind</span><br><span class="line">systemctl status rpcbind</span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind</span><br><span class="line">systemctl start nfs </span><br><span class="line">systemctl status nfs</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs</span><br></pre></td></tr></table></figure>



<p>在集群的每一个节点上执行下面的命令安装<code>nfs-utils</code>工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils </span><br></pre></td></tr></table></figure><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="comments-2"><p>nginx将作为一个代理，代理集群中的服务，这里使用yum方式安装nginx。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加yum源</span></span><br><span class="line">cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[nginx-stable]</span></span><br><span class="line"><span class="string">name=nginx stable repo</span></span><br><span class="line"><span class="string">baseurl=http://nginx.org/packages/centos/\$releasever/\$basearch/</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class="line"><span class="string">module_hotfixes=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[nginx-mainline]</span></span><br><span class="line"><span class="string">name=nginx mainline repo</span></span><br><span class="line"><span class="string">baseurl=http://nginx.org/packages/mainline/centos/\$releasever/\$basearch/</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">enabled=0</span></span><br><span class="line"><span class="string">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class="line"><span class="string">module_hotfixes=true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装nginx</span></span><br><span class="line">yum install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">nginx -v</span><br><span class="line">nginx -V</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动nginx</span></span><br><span class="line">systemctl start nginx</span><br><span class="line">systenctl status nginx</span><br><span class="line">systenctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="comments-3"><p><code>ansible</code>可以方便批量执行指令，首先在<code>SCA-LUM700011</code>这台创建ssh key并分发到其他节点，将这台服务器作为运维节点，下面使用的ansible就在这个上面运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id 10.8.138.5</span><br><span class="line">ssh-copy-id 10.8.138.6</span><br><span class="line">ssh-copy-id 10.8.138.10</span><br><span class="line">ssh-copy-id 10.8.138.9</span><br><span class="line">ssh-copy-id 10.8.138.11</span><br></pre></td></tr></table></figure>



<p>安装ansible：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">yum install -y ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置配置文件</span></span><br><span class="line">cat &gt; /etc/ansible/ansible.cfg &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[defaults]</span></span><br><span class="line"><span class="string">log_path = /var/log/ansible.log</span></span><br><span class="line"><span class="string">forks = 20</span></span><br><span class="line"><span class="string">host_key_checking = False</span></span><br><span class="line"><span class="string">retry_files_enabled = False</span></span><br><span class="line"><span class="string">deprecation_warnings = False</span></span><br><span class="line"><span class="string">nocows = True</span></span><br><span class="line"><span class="string">remote_user = root</span></span><br><span class="line"><span class="string">roles_path = roles/</span></span><br><span class="line"><span class="string">gathering = smart</span></span><br><span class="line"><span class="string">fact_caching = jsonfile</span></span><br><span class="line"><span class="string">fact_caching_connection = /etc/ansible/facts</span></span><br><span class="line"><span class="string">fact_caching_timeout = 600</span></span><br><span class="line"><span class="string">callback_whitelist = profile_tasks</span></span><br><span class="line"><span class="string">inventory_ignore_extensions = secrets.py, .pyc, .cfg, .crt, .ini</span></span><br><span class="line"><span class="string">timeout = 30</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[inventory]</span></span><br><span class="line"><span class="string">unparsed_is_failed=true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[ssh_connection]</span></span><br><span class="line"><span class="string">pipelining = True</span></span><br><span class="line"><span class="string">ssh_args = -o ControlMaster=auto -o ControlPersist=600s</span></span><br><span class="line"><span class="string">timeout = 10</span></span><br><span class="line"><span class="string">control_path = %(directory)s/%%h-%%r</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置host文件</span></span><br><span class="line">cat &gt; /etc/ansible/hosts &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[cluster]</span></span><br><span class="line"><span class="string">10.8.138.5  hostname=&#x27;SCA-LUM700007&#x27;</span></span><br><span class="line"><span class="string">10.8.138.6  hostname=&#x27;SCA-LUM700008&#x27;</span></span><br><span class="line"><span class="string">10.8.138.10 hostname=&#x27;SCA-LUM700012&#x27;</span></span><br><span class="line"><span class="string">10.8.138.9  hostname=&#x27;SCA-LUM700013&#x27;</span></span><br><span class="line"><span class="string">10.8.138.11 hostname=&#x27;SCA-LUM700014&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[ans]</span></span><br><span class="line"><span class="string">10.8.138.8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[master]</span></span><br><span class="line"><span class="string">10.8.138.5</span></span><br><span class="line"><span class="string">10.8.138.6</span></span><br><span class="line"><span class="string">10.8.138.10</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[worker]</span></span><br><span class="line"><span class="string">10.8.138.9</span></span><br><span class="line"><span class="string">10.8.138.11</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查ansible</span></span><br><span class="line">ansible cluster -m ping </span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="./ansible-check.png" style="zoom:40%;" /><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div></div></div>





<br>

<h1 id="内核优化"><a href="#内核优化" class="headerlink" title="内核优化"></a>内核优化</h1><div class="tabs" id="comments"><ul class="nav-tabs"><li class="tab active"><button data-href="#comments-1">升级内核版本</button></li><li class="tab"><button data-href="#comments-2">设置内核参数</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="comments-1"><p><strong>注意，我这里计划使用ipvs模式，需要升级内核版本，每台服务器都升级一下</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 载入公钥</span></span><br><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 ELRepo 最新版本</span></span><br><span class="line">yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出可以使用的 kernel 包版本</span></span><br><span class="line">yum list available --disablerepo=* --enablerepo=elrepo-kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装内核</span></span><br><span class="line">yum install -y kernel-lt-4.4.226-1.el7.elrepo --enablerepo=elrepo-kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看可用内核</span></span><br><span class="line">cat /boot/grub2/grub.cfg | grep menuentry</span><br><span class="line"></span><br><span class="line">menuentry <span class="string">&#x27;CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)&#x27;</span> --class centos （略）</span><br><span class="line">menuentry <span class="string">&#x27;CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)&#x27;</span> --class centos ...（略）</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置从新的内核起动</span></span><br><span class="line">grub2-set-default <span class="string">&quot;CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核启动项</span></span><br><span class="line">grub2-editenv list</span><br><span class="line"></span><br><span class="line">saved_entry=CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="comments-2"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/k8s.conf &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">fs.file-max=6815744</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables=1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables=1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">net.ipv4.tcp_tw_recycle=0</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string">vm.panic_on_oom=0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 当内核维护的arp表过于庞大时候，可以考虑优化</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh1=1024</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh2=4096</span></span><br><span class="line"><span class="string">net.ipv4.neigh.default.gc_thresh3=8192</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># netfilter优化</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_max=10485760</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_tcp_timeout_established=300</span></span><br><span class="line"><span class="string">net.netfilter.nf_conntrack_buckets=655360</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">net.core.netdev_max_backlog=10000</span></span><br><span class="line"><span class="string">fs.inotify.max_user_instances=524288</span></span><br><span class="line"><span class="string">fs.inotify.max_user_watches=524288</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>fs.file-max</code>表示系统级别最大文件句柄数量；</li>
<li><code>net.ipv4.neigh.default.gc_thresh1</code>表示存在于ARP高速缓存中的最少层数，如果少于这个数垃圾收集器将不会运行。缺省值是128；</li>
<li><code>net.ipv4.neigh.default.gc_thresh2</code>保存在ARP高速缓存中的最多的记录软限制。垃圾收集器在开始收集前允许记录数超过这个数字 5 秒。缺省值是 512；</li>
<li><code>net.ipv4.neigh.default.gc_thresh3</code>保存在ARP高速缓存中的最多记录的硬限制，一旦高速缓存中的数目高于此，垃圾收集器将马上运行。缺省值是1024；</li>
<li><code>net.netfilter.nf_conntrack_max</code>内核内存中netfilter可以同时处理的“任务”（连接跟踪条目）；</li>
<li><code>net.netfilter.nf_conntrack_buckets</code>哈希表大小（只读）（64位系统、8G内存默认 65536，16G翻倍，如此类推）;</li>
<li><code>net.core.netdev_max_backlog</code>网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目；</li>
<li><code>fs.inotify.max_user_instances</code>默认值: 128 指定了每一个real user ID可创建的inotify instatnces的数量上限；</li>
<li><code>fs.inotify.max_user_watches</code>默认值: 8192 指定了每个inotify instance相关联的watches的上限；</li>
</ul>
<p>执行下面的命令在每个节点生效配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible cluster -m copy -a <span class="string">&#x27;src=/etc/sysctl.d/k8s.conf dest=/etc/sysctl.d/k8s.conf mode=0755&#x27;</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;sysctl -p /etc/sysctl.d/k8s.conf&#x27;</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;echo &quot;/sbin/sysctl -p /etc/sysctl.d/k8s.conf&quot; &gt;&gt; /etc/rc.local&#x27;</span></span><br></pre></td></tr></table></figure><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div></div></div>



<br>



<h1 id="部署前准备"><a href="#部署前准备" class="headerlink" title="部署前准备"></a>部署前准备</h1><div class="tabs" id="comments"><ul class="nav-tabs"><li class="tab active"><button data-href="#comments-1">设置host</button></li><li class="tab"><button data-href="#comments-2">安装docker</button></li><li class="tab"><button data-href="#comments-3">关闭swap</button></li><li class="tab"><button data-href="#comments-4">开启ipvs</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="comments-1"><p>通过<code>ansible</code>为每个节点设置host文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible cluster -m shell -a <span class="string">&#x27;cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span></span><br><span class="line"><span class="string">10.8.138.5  SCA-LUM700007 sca-lum700007 master1</span></span><br><span class="line"><span class="string">10.8.138.6  SCA-LUM700008 sca-lum700008 master2</span></span><br><span class="line"><span class="string">10.8.138.10 SCA-LUM700012 sca-lum700012 master3</span></span><br><span class="line"><span class="string">10.8.138.9  SCA-LUM700013 sca-lum700013 node1</span></span><br><span class="line"><span class="string">10.8.138.11 SCA-LUM700014 sca-lum700014 node2</span></span><br><span class="line"><span class="string">EOF&#x27;</span></span><br></pre></td></tr></table></figure><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="comments-2"><p><strong>需要给集群所有的节点安装docker</strong></p>
<p>首先添加repo文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible cluster -m shell -a <span class="string">&#x27;yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo&#x27;</span></span><br></pre></td></tr></table></figure>



<p>设置存储目录，一般docker的数据存放路径为<code>/var/lib/docker</code>，所以在每个服务器上最好都有一个数据盘挂载到该目录下，防止docker数据过多爆盘。这里以一台服务器的设置为例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/docker</span><br><span class="line">mkfs.xfs -f /dev/vdb</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/dev/vdb /var/lib/docker xfs defaults 0 0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class="line">mount -a</span><br><span class="line">df -h</span><br></pre></td></tr></table></figure>



<p>安装docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前可用的版本</span></span><br><span class="line">yum list docker-ce --showduplicates|sort -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装docker</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;yum install -y docker-ce-18.06.3.ce-3.el7&#x27;</span></span><br></pre></td></tr></table></figure>



<p>设置配置文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; daemon.json &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span></span><br><span class="line"><span class="string">  &quot;log-driver&quot;: &quot;json-file&quot;,</span></span><br><span class="line"><span class="string">  &quot;log-opts&quot;: &#123;</span></span><br><span class="line"><span class="string">    &quot;max-size&quot;: &quot;100m&quot;,</span></span><br><span class="line"><span class="string">    &quot;max-file&quot;: &quot;5&quot;</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发到集群节点</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;mkdir /etc/docker&#x27;</span></span><br><span class="line">ansible cluster -m copy -a <span class="string">&#x27;src=daemon.json dest=/etc/docker/daemon.json&#x27;</span></span><br></pre></td></tr></table></figure>



<p>启动服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible cluster -m shell -a <span class="string">&#x27;systemctl daemon-reload&#x27;</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;systemctl restart docker&#x27;</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;systemctl status docker&#x27;</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;systemctl enable docker&#x27;</span></span><br></pre></td></tr></table></figure><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="comments-3"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible cluster -m shell -a <span class="string">&#x27;swapoff -a&#x27;</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;sed -i &quot;/swap/s/^/#/g&quot; /etc/fstab&#x27;</span></span><br></pre></td></tr></table></figure><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="comments-4"><p>本集群的service网络采用ipvs模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置内核参数</span></span><br><span class="line">ansible cluster -m sysctl -a <span class="string">&#x27;name=net.ipv4.ip_forward value=1 state=present&#x27;</span></span><br><span class="line">ansible cluster -m sysctl -a <span class="string">&#x27;name=net.bridge.bridge-nf-call-iptables value=1 state=present&#x27;</span></span><br><span class="line">ansible cluster -m sysctl -a <span class="string">&#x27;name=net.bridge.bridge-nf-call-ip6tables value=1 state=present&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载ipvs模块</span></span><br><span class="line">cat &gt; /tmp/ipvs.modules &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/bash</span></span><br><span class="line"><span class="string">ipvs_modules=&quot;ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4&quot;</span></span><br><span class="line"><span class="string">for kernel_module in \$&#123;ipvs_modules&#125;; do</span></span><br><span class="line"><span class="string">    /sbin/modinfo -F filename \$&#123;kernel_module&#125; &gt; /dev/null 2&gt;&amp;1</span></span><br><span class="line"><span class="string">    if [ $? -eq 0 ]; then</span></span><br><span class="line"><span class="string">        /sbin/modprobe \$&#123;kernel_module&#125;</span></span><br><span class="line"><span class="string">    fi</span></span><br><span class="line"><span class="string">done</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">ansible cluster -m copy -a <span class="string">&#x27;src=/tmp/ipvs.modules dest=/root/ipvs.modules mode=0755&#x27;</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;sh /root/ipvs.modules&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机启动执行该脚本</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;echo &quot;sh /root/ipvs.modules&quot; &gt;&gt; /etc/rc.local&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证 ipvs 支持</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;lsmod | grep ip_vs&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装ipvsadm</span></span><br><span class="line">ansible cluster -m yum -a <span class="string">&#x27;name=ipvsadm state=present&#x27;</span></span><br></pre></td></tr></table></figure><button class="tab-to-top" onclick="scrollToDest($(this).parents('.tabs'),65)"><i class="fas fa-arrow-up"></i></button></div></div></div>



<br>



<h1 id="安装基础服务"><a href="#安装基础服务" class="headerlink" title="安装基础服务"></a>安装基础服务</h1><h2 id="添加yum源"><a href="#添加yum源" class="headerlink" title="添加yum源"></a>添加yum源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发文件</span></span><br><span class="line">ansible cluster -m copy -a <span class="string">&#x27;src=/etc/yum.repos.d/kubernetes.repo dest=/etc/yum.repos.d/kubernetes.repo&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="安装kubelet、kubectl、kubeadm"><a href="#安装kubelet、kubectl、kubeadm" class="headerlink" title="安装kubelet、kubectl、kubeadm"></a>安装kubelet、kubectl、kubeadm</h2><p>这里安装的是<code>1.17.3</code>版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装kubectl、kubeadm、kubelet</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;yum install -y kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;ls /usr/bin/kube*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置kubelet自启动</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">&#x27;systemctl enable kubelet&#x27;</span></span><br></pre></td></tr></table></figure>



<br>



<h1 id="部署master节点"><a href="#部署master节点" class="headerlink" title="部署master节点"></a>部署master节点</h1><p>这一步在任意一个master上执行，这里我在<code>master1</code>上执行。需要配置下kubeadm的相关参数。</p>
<h2 id="配置kubeadm参数"><a href="#配置kubeadm参数" class="headerlink" title="配置kubeadm参数"></a>配置kubeadm参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kubeadm-config.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">kind: InitConfiguration</span></span><br><span class="line"><span class="string">localAPIEndpoint:</span></span><br><span class="line"><span class="string">  advertiseAddress: 0.0.0.0</span></span><br><span class="line"><span class="string">  bindPort: 6443</span></span><br><span class="line"><span class="string">nodeRegistration:</span></span><br><span class="line"><span class="string">  criSocket: /var/run/dockershim.sock</span></span><br><span class="line"><span class="string">  taints:</span></span><br><span class="line"><span class="string">  - effect: NoSchedule</span></span><br><span class="line"><span class="string">    key: node-role.kubernetes.io/master</span></span><br><span class="line"><span class="string">  kubeletExtraArgs:</span></span><br><span class="line"><span class="string">    cgroup-driver: &quot;systemd&quot;</span></span><br><span class="line"><span class="string">  ignorePreflightErrors:</span></span><br><span class="line"><span class="string">  - IsPrivilegedUser</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class="line"><span class="string">kind: ClusterConfiguration</span></span><br><span class="line"><span class="string">controlPlaneEndpoint: 10.8.138.12:6443</span></span><br><span class="line"><span class="string">certificatesDir: /etc/kubernetes/pki</span></span><br><span class="line"><span class="string">clusterName: kubernetes</span></span><br><span class="line"><span class="string">apiServer:</span></span><br><span class="line"><span class="string">  timeoutForControlPlane: 5m0s</span></span><br><span class="line"><span class="string">  extraArgs:</span></span><br><span class="line"><span class="string">    authorization-mode: &quot;Node,RBAC&quot;</span></span><br><span class="line"><span class="string">  certSANs:</span></span><br><span class="line"><span class="string">  - &quot;10.8.138.12&quot;</span></span><br><span class="line"><span class="string">  - &quot;14.116.177.22&quot;</span></span><br><span class="line"><span class="string">  - &quot;kubernetes&quot;</span></span><br><span class="line"><span class="string">  - &quot;kubernetes.default&quot;</span></span><br><span class="line"><span class="string">  - &quot;kubernetes.default.svc&quot;</span></span><br><span class="line"><span class="string">  - &quot;kubernetes.default.svc.cluster&quot;</span></span><br><span class="line"><span class="string">  - &quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class="line"><span class="string">controllerManager:</span></span><br><span class="line"><span class="string">  extraArgs:</span></span><br><span class="line"><span class="string">    &quot;node-cidr-mask-size&quot;: &quot;20&quot;</span></span><br><span class="line"><span class="string">scheduler:</span></span><br><span class="line"><span class="string">  extraArgs:</span></span><br><span class="line"><span class="string">    address: &quot;0.0.0.0&quot;</span></span><br><span class="line"><span class="string">dns:</span></span><br><span class="line"><span class="string">  type: CoreDNS</span></span><br><span class="line"><span class="string">etcd:</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    dataDir: /var/lib/etcd</span></span><br><span class="line"><span class="string">#    extraArgs:</span></span><br><span class="line"><span class="string">#      listen-client-urls: &quot;http://10.100.0.1:2379&quot;</span></span><br><span class="line"><span class="string">#    serverCertSANs:</span></span><br><span class="line"><span class="string">#    serverCertSANs:</span></span><br><span class="line"><span class="string">#    - &quot;localhost&quot;</span></span><br><span class="line"><span class="string">#    - &quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="string">#    peerCertSANs:</span></span><br><span class="line"><span class="string">#    - &quot;localhost&quot;</span></span><br><span class="line"><span class="string">#    - &quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="string">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span><br><span class="line"><span class="string">kubernetesVersion: v1.17.3</span></span><br><span class="line"><span class="string">networking:</span></span><br><span class="line"><span class="string">  dnsDomain: cluster.local</span></span><br><span class="line"><span class="string">  serviceSubnet: 172.24.0.0/16</span></span><br><span class="line"><span class="string">  podSubnet: 172.21.0.0/16</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class="line"><span class="string">kind: KubeProxyConfiguration</span></span><br><span class="line"><span class="string">bindAddress: 0.0.0.0</span></span><br><span class="line"><span class="string">#clusterCIDR:</span></span><br><span class="line"><span class="string">mode: ipvs  # 定义代理模式： userspace、 iptables 或 ipvs 。默认使用 iptables ，大集群建议使用 ipvs。</span></span><br><span class="line"><span class="string">ipvs:</span></span><br><span class="line"><span class="string">  scheduler: lc</span></span><br><span class="line"><span class="string">  syncPeriod: 30s</span></span><br><span class="line"><span class="string">  minSyncPeriod: 5s</span></span><br><span class="line"><span class="string">  tcpTimeout: 0s</span></span><br><span class="line"><span class="string">  tcpFinTimeout: 0s</span></span><br><span class="line"><span class="string">  udpTimeout: 0s</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="string">kind: KubeletConfiguration</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>

<ul>
<li>其中<code>10.8.138.12</code>为我前端slb的IP地址，代理后端三个master节点的6443；</li>
<li>根据实际情况在<code>certSANs</code>中添加IP和域名；</li>
<li>注意修改其中的kubernetes的版本，以及ipvs模式的调度算法（这里我使用的是lc）</li>
</ul>
<h2 id="验证配置"><a href="#验证配置" class="headerlink" title="验证配置"></a>验证配置</h2><p>下面的命令可以验证配置是否有误，并不会真正执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs --dry-run</span><br></pre></td></tr></table></figure>



<h2 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建集群</span></span><br><span class="line">kubeadm init --config=kubeadm-config.yaml --upload-certs</span><br></pre></td></tr></table></figure>



<p>执行成功的话，会出现下面的信息：</p>
<p><img src= "/img/loading.gif" data-src="./kubeadm-init.png" alt=""></p>
<p>从上边可以看出，添加master节点和node节点就可以在对应服务器上执行下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加master</span></span><br><span class="line">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \</span><br><span class="line">    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加node节点</span></span><br><span class="line">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e</span><br></pre></td></tr></table></figure>

<blockquote>
<p>命令中的token有两个小时时效，时效后需要重新获取</p>
</blockquote>
<h2 id="添加其他的master节点"><a href="#添加其他的master节点" class="headerlink" title="添加其他的master节点"></a>添加其他的master节点</h2><p>在剩下的两个master节点<code>SCA-LUM700008</code>和<code>SCA-LUM700012</code>执行下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \</span><br><span class="line">    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不需要拷贝kubeadm-config.yaml文件，会通过第一个apiserver去配置信息；</p>
</blockquote>
<h2 id="设置kubectl"><a href="#设置kubectl" class="headerlink" title="设置kubectl"></a>设置kubectl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自动补全</span></span><br><span class="line">ansible master -m shell -a <span class="string">&#x27;echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置kubectl证书</span></span><br><span class="line">cp /etc/kubernetes/admin.conf /root/.kube/config</span><br></pre></td></tr></table></figure>



<h2 id="验证master部署情况"><a href="#验证master部署情况" class="headerlink" title="验证master部署情况"></a>验证master部署情况</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看master</span></span><br><span class="line">kubectl get node --kubeconfig /etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">kubectl get pod --all-namespaces --kubeconfig /etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="check-master.png" alt=""></p>
<blockquote>
<p>这里有些pod没有启动是正常的，因为集群还没部署完成。</p>
</blockquote>
<h2 id="确认kubeproxy开启了ipvs"><a href="#确认kubeproxy开启了ipvs" class="headerlink" title="确认kubeproxy开启了ipvs"></a>确认kubeproxy开启了ipvs</h2><p>首先查看网卡信息，多了一个kube-ipvs0网卡：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ip a s</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="./ipvs.png" style="zoom:50%;" />



<p>查看ipvs规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipvsadm -Ln</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="./ipvs-rule.png" style="zoom:40%;" />



<br>



<h1 id="部署etcd"><a href="#部署etcd" class="headerlink" title="部署etcd"></a>部署etcd</h1><h2 id="更新etcd配置"><a href="#更新etcd配置" class="headerlink" title="更新etcd配置"></a>更新etcd配置</h2><p>更新后会自动重启服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible master -m shell -a <span class="string">&#x27;sed -i &quot;/--initial-cluster=/c\    - --initial-cluster=sca-lum700012=https://10.8.138.10:2380,sca-lum700007=https://10.8.138.5:2380,sca-lum700008=https://10.8.138.6:2380&quot; /etc/kubernetes/manifests/etcd.yaml&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apiserver 默认访问本地的 etcd 节点，如果需要访问集群所有节点可以修改配置。</span></span><br><span class="line">ansible master -m shell -a <span class="string">&#x27;sed -i &quot;/- --etcd-servers/c\    - --etcd-servers=https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379&quot; /etc/kubernetes/manifests/kube-apiserver.yaml&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="查看etcd节点状态"><a href="#查看etcd节点状态" class="headerlink" title="查看etcd节点状态"></a>查看etcd节点状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载etcdctl</span></span><br><span class="line">curl -L -O https://github.com/etcd-io/etcd/releases/download/v3.4.3/etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class="line">tar xzf etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class="line">mv etcd-v3.4.3-linux-amd64/etcd* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">ETCDCTL=3 etcdctl --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   member list</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="./etcd-member.png" alt=""></p>
<h2 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint status</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="./etcd-cluster.png" alt=""></p>
<h2 id="etcd节点健康状态"><a href="#etcd节点健康状态" class="headerlink" title="etcd节点健康状态"></a>etcd节点健康状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint health</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="./etcd-helth.png" alt=""></p>
<br>



<h1 id="部署node节点"><a href="#部署node节点" class="headerlink" title="部署node节点"></a>部署node节点</h1><p>在所有node节点上执行下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e</span><br></pre></td></tr></table></figure>



<p>查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node </span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="./getnode.png" style="zoom:67%;" />



<p><em>节点已经添加进来了，因为没有部署CNI所以都是NOTREADY。</em></p>
<br>



<h1 id="部署calico"><a href="#部署calico" class="headerlink" title="部署calico"></a>部署calico</h1><h2 id="下载calico"><a href="#下载calico" class="headerlink" title="下载calico"></a>下载calico</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载calico的yaml文件</span></span><br><span class="line">curl -L https://docs.projectcalico.org/v3.11/manifests/calico.yaml -o calico.yaml</span><br></pre></td></tr></table></figure>



<h2 id="部署calico-1"><a href="#部署calico-1" class="headerlink" title="部署calico"></a>部署calico</h2><p>修改calico.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改为pod网段</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV4POOL_CIDR</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;172.21.0.0/16&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 增加该参数，设定端口范围</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FELIX_KUBENODEPORTRANGES</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">&quot;30000:50000&quot;</span></span><br></pre></td></tr></table></figure>



<p>部署calico：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>



<p>部署完成后，查看节点状态，应该都READY：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="./nodes.png" style="zoom:50%;" />



<h2 id="设置calico命令行工具"><a href="#设置calico命令行工具" class="headerlink" title="设置calico命令行工具"></a>设置calico命令行工具</h2><p>下载calico命令行工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">curl -L -o /usr/<span class="built_in">local</span>/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.11.2/calicoctl-linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">mkdir -p /etc/calico</span><br><span class="line">cat &gt; /etc/calico/calicoctl.cfg &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: projectcalico.org/v3</span></span><br><span class="line"><span class="string">kind: CalicoAPIConfig</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  datastoreType: kubernetes</span></span><br><span class="line"><span class="string">  kubeconfig: /etc/kubernetes/admin.conf  # 使用 admin 配置</span></span><br><span class="line"><span class="string">  #k8sAPIEndpoint: https://10.8.138.12:6443</span></span><br><span class="line"><span class="string">  #k8sCertFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line"><span class="string">  #k8sKeyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line"><span class="string">  #k8sCAFile: /etc/kubernetes/pki/ca.crt</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure>



<h2 id="查看calico节点"><a href="#查看calico节点" class="headerlink" title="查看calico节点"></a>查看calico节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">calicoctl node status</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="./calico-node.png" style="zoom:50%;" />



<h2 id="查看ippool"><a href="#查看ippool" class="headerlink" title="查看ippool"></a>查看ippool</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">calicoctl get ippool -o wide</span><br><span class="line"></span><br><span class="line">NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR</span><br><span class="line">default-ipv4-ippool   172.21.0.0/16   <span class="literal">true</span>   Always     Never       <span class="literal">false</span>      all()</span><br></pre></td></tr></table></figure>



<h2 id="查看ip状态"><a href="#查看ip状态" class="headerlink" title="查看ip状态"></a>查看ip状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">calicoctl ipam show</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="./calico-ip.png" alt=""></p>
<br>



<h1 id="集群校验"><a href="#集群校验" class="headerlink" title="集群校验"></a>集群校验</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl config get-clusters</span><br><span class="line">kubectl cluster-info</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="./cluster-check.png" alt=""></p>
<br>



<h1 id="nginx服务其配置"><a href="#nginx服务其配置" class="headerlink" title="nginx服务其配置"></a>nginx服务其配置</h1><p><code>SCA-LUM700011</code>作为nginx服务器，将会代理ingress服务，所以先设置一下。</p>
<h2 id="自签证书"><a href="#自签证书" class="headerlink" title="自签证书"></a>自签证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确认安装了openssl</span></span><br><span class="line">openssl version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确定nginx安装了https模块(应该有--with-http_ssl_module)</span></span><br><span class="line">nginx -V</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建整数目录</span></span><br><span class="line"><span class="built_in">cd</span> /etc/nginx/</span><br><span class="line">mkdir ssl</span><br><span class="line"><span class="built_in">cd</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成秘钥</span></span><br><span class="line">openssl genrsa -out nginx.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">..............................................+++</span><br><span class="line">.....................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成签名请求文件（csr），输入上边的密码，并输入相关的信息</span></span><br><span class="line">openssl req -new -key nginx.key -out nginx.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以在一行，不用交互式输入</span></span><br><span class="line">openssl req -subj <span class="string">&quot;/C=CN/ST=Guangdong/L=Shenzhen/O=nginx/OU=dev/CN=test.example.com/emailAddress=test@123.com&quot;</span> -new -key nginx.key -out nginx.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成自签名证书，指定过期时间3650天，输入密码即可生成</span></span><br><span class="line">openssl x509 -req -days 3650 -<span class="keyword">in</span> nginx.csr -signkey nginx.key -out nginx.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看生成的文件</span></span><br><span class="line">$ ls</span><br><span class="line">nginx.crt  nginx.csr  nginx.key</span><br></pre></td></tr></table></figure>



<h2 id="修改nginx主配置文件"><a href="#修改nginx主配置文件" class="headerlink" title="修改nginx主配置文件"></a>修改nginx主配置文件</h2><p>修改<code>/etc/nginx/nginx.conf</code>文件为如下内容：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span>  nginx;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/error.log <span class="literal">warn</span>;</span><br><span class="line"><span class="attribute">pid</span>        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里使用<code>include</code>导入其他的配置文件，所有服务的nginx配置都放在<code>/etc/nginx/conf.d</code>下，如果目录不存在需要自己创建。</p>
<p>在``/etc/nginx/conf.d<code>下先创建一个通用配置文件</code>common.ini`，这个是所有配置文件都要用的，所以抽离出来：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> = /favicon.ico &#123;</span><br><span class="line">    <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* /\.(svn|git)/</span> &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">404</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="创建一个测试配置"><a href="#创建一个测试配置" class="headerlink" title="创建一个测试配置"></a>创建一个测试配置</h3><p>在<code>/etc/nginx/conf.d</code>下新建一个配置文件<code>https.conf</code>：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> https-server.example.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> https://$host<span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> https-server.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/new/nginx.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/new/nginx.key;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/https-server.example.com_access.log main;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/https-server.example.com_error.log;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">      <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> conf.d/common.ini;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在<code>/usr/share/nginx/html</code>下创建测试页面：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;this is https page&quot;</span> &gt; /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>



<h3 id="绑定host"><a href="#绑定host" class="headerlink" title="绑定host"></a>绑定host</h3><p>因为我是测试环境，且我要通过域名的方式访问服务，所以需要绑定host，这一步在自己的电脑上操作，过程不赘述。</p>
<h3 id="重启nginx并访问"><a href="#重启nginx并访问" class="headerlink" title="重启nginx并访问"></a>重启nginx并访问</h3><p>执行下面的命令检查配置并重新加载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx -t</span><br><span class="line">nginx -s reload </span><br></pre></td></tr></table></figure>



<p>然后通过浏览器访问域名：<code>https-server.example.com</code>，应该就可以看到设置的https页面了。</p>
<blockquote>
<p>注意，有的浏览器对于自签证书是不信任的，需要手动下载证书然后在电脑中导入就可以了。</p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Luka Vergo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://liyongzhezz.github.io/2021/03/28/kubeadm%E9%83%A8%E7%BD%B2k8s-1-18%E9%9B%86%E7%BE%A4/">https://liyongzhezz.github.io/2021/03/28/kubeadm%E9%83%A8%E7%BD%B2k8s-1-18%E9%9B%86%E7%BE%A4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://liyongzhezz.github.io" target="_blank">彭彭丁满</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Kubernetes/">Kubernetes</a></div><div class="post_share"><div class="social-share" data-image="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1753787%2F201908%2F1753787-20190807150457472-2109756553.png&amp;refer=http%3A%2F%2Fimg2018.cnblogs.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=jpeg?sec=1632125371&amp;t=3b852d76d15e14e2ac022452cf7aef8c" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><button class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.png" alt="wechat" onclick="window.open('/img/wechat.png')"/><div class="post-qr-code__desc">wechat</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.png" alt="alipay" onclick="window.open('/img/alipay.png')"/><div class="post-qr-code__desc">alipay</div></li></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/28/%E4%BD%BF%E7%94%A8k3d%E5%92%8Ctraefik%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"><img class="prev-cover" data-src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3084171116,3613775985&amp;fm=26&amp;gp=0.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">使用k3d和traefik快速搭建开发环境</div></div></a></div><div class="next-post pull-right"><a href="/2021/03/27/%E5%9C%A8k8s%E4%B8%AD%E4%BD%BF%E7%94%A8EFLK%E8%BF%9B%E8%A1%8C%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"><img class="next-cover" data-src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&amp;fm=26&amp;gp=0.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">在k8s中使用EFLK进行日志收集</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2021/03/28/使用k3d和traefik快速搭建开发环境/" title="使用k3d和traefik快速搭建开发环境"><img class="relatedPosts_cover" data-src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3084171116,3613775985&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-28</div><div class="relatedPosts_title">使用k3d和traefik快速搭建开发环境</div></div></a></div><div class="relatedPosts_item"><a href="/2021/04/13/升级集群到1-18/" title="升级集群到1.18"><img class="relatedPosts_cover" data-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic2.zhimg.com%2Fv2-63997184325ff1f331454c8d9ae0a495_1200x500.jpg&refer=http%3A%2F%2Fpic2.zhimg.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620867442&t=ae4310844b4d591ea758de96756b9461"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-13</div><div class="relatedPosts_title">升级集群到1.18</div></div></a></div><div class="relatedPosts_item"><a href="/2021/04/11/二进制方式部署kubernetes-1-20/" title="二进制方式部署kubernetes 1.20"><img class="relatedPosts_cover" data-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180613%2Fa12e8e321ae040e08c0a1edac71aeb2f.jpeg&refer=http%3A%2F%2F5b0988e595225.cdn.sohucs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1620702740&t=d5454a9fbcd5da397ea7ec9d6531d1ab"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-11</div><div class="relatedPosts_title">二进制方式部署kubernetes 1.20</div></div></a></div><div class="relatedPosts_item"><a href="/2021/08/09/kubernetes中的服务质量QoS/" title="kubernetes中的服务质量QoS"><img class="relatedPosts_cover" data-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fdeveloper.ibm.com%2Fdwblog%2Fwp-content%2Fuploads%2Fsites%2F73%2Fdwblog-kubernetes-850x425.png&refer=http%3A%2F%2Fdeveloper.ibm.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1631112416&t=ec53fac9e0c6d318c97d8b1d27623a0a"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-09</div><div class="relatedPosts_title">kubernetes中的服务质量QoS</div></div></a></div><div class="relatedPosts_item"><a href="/2021/08/21/使用kubeadm管理集群证书/" title="使用kubeadm管理集群证书"><img class="relatedPosts_cover" data-src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fimg2018.cnblogs.com%2Fblog%2F1753787%2F201908%2F1753787-20190807150457472-2109756553.png&refer=http%3A%2F%2Fimg2018.cnblogs.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1632125371&t=3b852d76d15e14e2ac022452cf7aef8c"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-21</div><div class="relatedPosts_title">使用kubeadm管理集群证书</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '50c33518212f08034726',
  clientSecret: '497b04ce72a905ec41ebc3fb051369434affe3c7',
  repo: 'liyongzhezz.github.io',
  owner: 'liyongzhezz',
  admin: ['liyongzhezz'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Luka Vergo</div><div class="framework-info"><span>驱动 </span><a target="_blank" rel="noopener" href="https://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">简</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fas fa-comments"></i></a><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><script>var endLoading = function () {
  document.body.style.overflow = 'auto';
  document.getElementById('loading-box').classList.add("loaded")
}
window.addEventListener('load',endLoading)</script></body></html>