<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>[k8s实践系列]kubeadm部署k8s 1.17 | 彭彭丁满</title><meta name="description" content="通过kubeadm部署3master节点高可用k8s 1.17.3集群"><meta name="keywords" content="k8s,k8s集群部署"><meta name="author" content="Luka Vergo"><meta name="copyright" content="Luka Vergo"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://liyongzhezz.github.io/2020/07/02/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-kubeadm%E9%83%A8%E7%BD%B2k8s-1.18/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="[k8s实践系列]kubeadm部署k8s 1.17"><meta property="og:url" content="https://liyongzhezz.github.io/2020/07/02/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-kubeadm%E9%83%A8%E7%BD%B2k8s-1.18/"><meta property="og:site_name" content="彭彭丁满"><meta property="og:description" content="通过kubeadm部署3master节点高可用k8s 1.17.3集群"><meta property="og:image" content="https://raw.githubusercontent.com/kubernetes/kubeadm/master/logos/stacked/color/kubeadm-stacked-color.png"><meta property="article:published_time" content="2020-07-02T01:33:03.000Z"><meta property="article:modified_time" content="2020-08-04T07:26:08.748Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = '1'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="prev" title="Nginx基础概念" href="https://liyongzhezz.github.io/2020/07/03/Nginx%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-1185009661039450',
  enable_page_level_ads: 'true'
});</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avator.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">77</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">33</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">45</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#集群规划"><span class="toc-number">1.</span> <span class="toc-text">集群规划</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#升级内核版本"><span class="toc-number">2.</span> <span class="toc-text">升级内核版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设置内核参数"><span class="toc-number">3.</span> <span class="toc-text">设置内核参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装nfs和nginx"><span class="toc-number">4.</span> <span class="toc-text">安装nfs和nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装nfs"><span class="toc-number">4.1.</span> <span class="toc-text">安装nfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装nginx"><span class="toc-number">4.2.</span> <span class="toc-text">安装nginx</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置sshkey"><span class="toc-number">5.</span> <span class="toc-text">配置sshkey</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装ansible"><span class="toc-number">6.</span> <span class="toc-text">安装ansible</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-number">6.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置配置文件"><span class="toc-number">6.2.</span> <span class="toc-text">设置配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置ansible-host文件"><span class="toc-number">6.3.</span> <span class="toc-text">设置ansible host文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证ansible"><span class="toc-number">6.4.</span> <span class="toc-text">验证ansible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设置host"><span class="toc-number">7.</span> <span class="toc-text">设置host</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装docker"><span class="toc-number">8.</span> <span class="toc-text">安装docker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#添加docker-repo文件"><span class="toc-number">8.1.</span> <span class="toc-text">添加docker repo文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置存储目录"><span class="toc-number">8.2.</span> <span class="toc-text">设置存储目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装docker-1"><span class="toc-number">8.3.</span> <span class="toc-text">安装docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置docker配置文件"><span class="toc-number">8.4.</span> <span class="toc-text">配置docker配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动docker服务"><span class="toc-number">8.5.</span> <span class="toc-text">启动docker服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#关闭swap"><span class="toc-number">9.</span> <span class="toc-text">关闭swap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#开启ipvs"><span class="toc-number">10.</span> <span class="toc-text">开启ipvs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加阿里云k8s-yum源"><span class="toc-number">11.</span> <span class="toc-text">添加阿里云k8s yum源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装kubernetes基础工具"><span class="toc-number">12.</span> <span class="toc-text">安装kubernetes基础工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建master"><span class="toc-number">13.</span> <span class="toc-text">创建master</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置kubeadm参数"><span class="toc-number">13.1.</span> <span class="toc-text">配置kubeadm参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证配置"><span class="toc-number">13.2.</span> <span class="toc-text">验证配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建集群"><span class="toc-number">13.3.</span> <span class="toc-text">创建集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加其他master"><span class="toc-number">13.4.</span> <span class="toc-text">添加其他master</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#设置kubectl"><span class="toc-number">14.</span> <span class="toc-text">设置kubectl</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自动补全"><span class="toc-number">14.1.</span> <span class="toc-text">自动补全</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置kubectl证书"><span class="toc-number">14.2.</span> <span class="toc-text">设置kubectl证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证master部署情况"><span class="toc-number">15.</span> <span class="toc-text">验证master部署情况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#确认kube-proxy开启了ipvs"><span class="toc-number">16.</span> <span class="toc-text">确认kube-proxy开启了ipvs</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#etcd配置"><span class="toc-number">17.</span> <span class="toc-text">etcd配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#更新etcd配置"><span class="toc-number">17.1.</span> <span class="toc-text">更新etcd配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看etcd节点状态"><span class="toc-number">17.2.</span> <span class="toc-text">查看etcd节点状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看集群状态"><span class="toc-number">17.3.</span> <span class="toc-text">查看集群状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etcd节点健康状态"><span class="toc-number">17.4.</span> <span class="toc-text">etcd节点健康状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建node"><span class="toc-number">18.</span> <span class="toc-text">创建node</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署calico"><span class="toc-number">19.</span> <span class="toc-text">部署calico</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载calico"><span class="toc-number">19.1.</span> <span class="toc-text">下载calico</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署calico-1"><span class="toc-number">19.2.</span> <span class="toc-text">部署calico</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置calico命令行工具"><span class="toc-number">19.3.</span> <span class="toc-text">设置calico命令行工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看calico节点"><span class="toc-number">19.4.</span> <span class="toc-text">查看calico节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看ippool"><span class="toc-number">19.5.</span> <span class="toc-text">查看ippool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看ip状态"><span class="toc-number">19.6.</span> <span class="toc-text">查看ip状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群校验"><span class="toc-number">20.</span> <span class="toc-text">集群校验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx服务其配置"><span class="toc-number">21.</span> <span class="toc-text">nginx服务其配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自签证书"><span class="toc-number">21.1.</span> <span class="toc-text">自签证书</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改nginx主配置文件"><span class="toc-number">21.2.</span> <span class="toc-text">修改nginx主配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建一个测试配置"><span class="toc-number">21.3.</span> <span class="toc-text">创建一个测试配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#绑定host"><span class="toc-number">21.4.</span> <span class="toc-text">绑定host</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重启nginx并访问"><span class="toc-number">21.5.</span> <span class="toc-text">重启nginx并访问</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.githubusercontent.com/kubernetes/kubeadm/master/logos/stacked/color/kubeadm-stacked-color.png)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">彭彭丁满</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">[k8s实践系列]kubeadm部署k8s 1.17</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-02 09:33:03"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2020-07-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-08-04 15:26:08"><i class="fas fa-history fa-fw"></i> 更新于 2020-08-04</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/%E5%AE%9E%E8%B7%B5K8s/">实践K8s</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="far fa-comments fa-fw post-meta__icon"></i><span>评论数:</span><a href="/2020/07/02/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-kubeadm%E9%83%A8%E7%BD%B2k8s-1.18/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h2><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">IP地址</th>
<th align="center">用途</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SCA-LUM700011</td>
<td align="center">10.8.138.8</td>
<td align="center">nginx+nfs+运维节点</td>
</tr>
<tr>
<td align="center">SCA-LUM700007</td>
<td align="center">10.8.138.5</td>
<td align="center">master-1</td>
</tr>
<tr>
<td align="center">SCA-LUM700008</td>
<td align="center">10.8.138.6</td>
<td align="center">Master-2</td>
</tr>
<tr>
<td align="center">SCA-LUM700012</td>
<td align="center">10.8.138.10</td>
<td align="center">Master-3</td>
</tr>
<tr>
<td align="center">SCA-LUM700013</td>
<td align="center">10.8.138.9</td>
<td align="center">Node-1</td>
</tr>
<tr>
<td align="center">SCA-LUM700014</td>
<td align="center">10.8.138.11</td>
<td align="center">node-2</td>
</tr>
</tbody></table>
<p>操作系统<code>centos7.6</code>，前端还有一个elb，地址为<code>10.8.138.12</code>，代理master的apiserver。kube-proxy使用<code>ipvs</code>模式。</p>
<p>集群使用<code>1.17.3</code>版本</p>
<br>

<h2 id="升级内核版本"><a href="#升级内核版本" class="headerlink" title="升级内核版本"></a>升级内核版本</h2><p><strong>注意，我这里计划使用ipvs模式，需要升级内核版本，每台服务器都升级一下</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 载入公钥</span></span><br><span class="line">$ rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 ELRepo 最新版本</span></span><br><span class="line">$ yum install -y https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出可以使用的 kernel 包版本</span></span><br><span class="line">$ yum list available --disablerepo=* --enablerepo=elrepo-kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装内核</span></span><br><span class="line">$ yum install -y kernel<span class="_">-lt</span>-4.4.226-1.el7.elrepo --enablerepo=elrepo-kernel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看可用内核</span></span><br><span class="line">$ cat /boot/grub2/grub.cfg | grep menuentry</span><br><span class="line">menuentry <span class="string">'CentOS Linux (3.10.0-1062.el7.x86_64) 7 (Core)'</span> --class centos （略）</span><br><span class="line">menuentry <span class="string">'CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)'</span> --class centos ...（略）</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置从新的内核起动</span></span><br><span class="line">$ grub2-set-default <span class="string">"CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内核启动项</span></span><br><span class="line">$ grub2-editenv list</span><br><span class="line">saved_entry=CentOS Linux (4.4.226-1.el7.elrepo.x86_64) 7 (Core)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<br>



<h2 id="设置内核参数"><a href="#设置内核参数" class="headerlink" title="设置内核参数"></a>设置内核参数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/k8s.conf &lt;&lt; EOF</span><br><span class="line">fs.file-max=6815744</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.bridge.bridge-nf-call-iptables=1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables=1</span><br><span class="line">net.ipv4.ip_forward=1</span><br><span class="line">net.ipv4.tcp_tw_recycle=0</span><br><span class="line">vm.swappiness=0</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当内核维护的arp表过于庞大时候，可以考虑优化</span></span><br><span class="line">net.ipv4.neigh.default.gc_thresh1=1024</span><br><span class="line">net.ipv4.neigh.default.gc_thresh2=4096</span><br><span class="line">net.ipv4.neigh.default.gc_thresh3=8192</span><br><span class="line"></span><br><span class="line"><span class="comment"># netfilter优化</span></span><br><span class="line">net.netfilter.nf_conntrack_max=10485760</span><br><span class="line">net.netfilter.nf_conntrack_tcp_timeout_established=300</span><br><span class="line">net.netfilter.nf_conntrack_buckets=655360</span><br><span class="line"></span><br><span class="line">net.core.netdev_max_backlog=10000</span><br><span class="line">fs.inotify.max_user_instances=524288</span><br><span class="line">fs.inotify.max_user_watches=524288</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li><code>fs.file-max</code>表示系统级别最大文件句柄数量；</li>
<li><code>net.ipv4.neigh.default.gc_thresh1</code>表示存在于ARP高速缓存中的最少层数，如果少于这个数垃圾收集器将不会运行。缺省值是128；</li>
<li><code>net.ipv4.neigh.default.gc_thresh2</code>保存在ARP高速缓存中的最多的记录软限制。垃圾收集器在开始收集前允许记录数超过这个数字 5 秒。缺省值是 512；</li>
<li><code>net.ipv4.neigh.default.gc_thresh3</code>保存在ARP高速缓存中的最多记录的硬限制，一旦高速缓存中的数目高于此，垃圾收集器将马上运行。缺省值是1024；</li>
<li><code>net.netfilter.nf_conntrack_max</code>内核内存中netfilter可以同时处理的“任务”（连接跟踪条目）；</li>
<li><code>net.netfilter.nf_conntrack_buckets</code>哈希表大小（只读）（64位系统、8G内存默认 65536，16G翻倍，如此类推）;</li>
<li><code>net.core.netdev_max_backlog</code>网络接口接收数据包的速率比内核处理这些包的速率快时，允许送到队列的数据包的最大数目；</li>
<li><code>fs.inotify.max_user_instances</code>默认值: 128 指定了每一个real user ID可创建的inotify instatnces的数量上限；</li>
<li><code>fs.inotify.max_user_watches</code>默认值: 8192 指定了每个inotify instance相关联的watches的上限；</li>
</ul>
<p>执行下面的命令在每个节点生效配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ansible cluster -m copy -a <span class="string">'src=/etc/sysctl.d/k8s.conf dest=/etc/sysctl.d/k8s.conf mode=0755'</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'sysctl -p /etc/sysctl.d/k8s.conf'</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'echo "/sbin/sysctl -p /etc/sysctl.d/k8s.conf" &gt;&gt; /etc/rc.local'</span></span><br></pre></td></tr></table></figure>

<br>



<h2 id="安装nfs和nginx"><a href="#安装nfs和nginx" class="headerlink" title="安装nfs和nginx"></a>安装nfs和nginx</h2><h3 id="安装nfs"><a href="#安装nfs" class="headerlink" title="安装nfs"></a>安装nfs</h3><p>nfs的作用是为集群提供共享存储，nginx后面用来代理集群的ingress等服务。在<code>SCA-LUM700011</code>这台nfs服务器上有挂载的磁盘，先对其格式化并创建nfs的数据目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs.xfs /dev/vdb -f</span><br><span class="line">$ mkdir -p /data/nfs-data</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"/dev/vdb /data/nfs-data xfs defaults 0 0"</span> &gt;&gt; /etc/fstab</span><br><span class="line">$ mount -a</span><br><span class="line">$ df -h</span><br></pre></td></tr></table></figure>



<p>安装nfs相关服务并启动nfs：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y nfs-utils rpcbind</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"/data/nfs-data *(rw,no_root_squash)"</span> &gt;&gt; /etc/exports</span><br><span class="line">$ systemctl start rpcbind</span><br><span class="line">$ systemctl status rpcbind</span><br><span class="line">$ systemctl <span class="built_in">enable</span> rpcbind</span><br><span class="line">$ systemctl start nfs </span><br><span class="line">$ systemctl status nfs</span><br><span class="line">$ systemctl <span class="built_in">enable</span> nfs</span><br></pre></td></tr></table></figure>



<p>在集群的每一个节点上执行下面的命令安装<code>nfs-utils</code>工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y nfs-utils</span><br></pre></td></tr></table></figure>



<h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><p>这里使用yum方式安装nginx。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">$ yum install -y gcc gcc-c++ autoconf pcre pcre-devel make automake yum-utils zlib zlib-devel openssl openssl-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加yum源</span></span><br><span class="line">$ cat &gt; /etc/yum.repos.d/nginx.repo &lt;&lt; EOF</span><br><span class="line">[nginx-stable]</span><br><span class="line">name=nginx stable repo</span><br><span class="line">baseurl=http://nginx.org/packages/centos/\<span class="variable">$releasever</span>/\<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[nginx-mainline]</span><br><span class="line">name=nginx mainline repo</span><br><span class="line">baseurl=http://nginx.org/packages/mainline/centos/\<span class="variable">$releasever</span>/\<span class="variable">$basearch</span>/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=0</span><br><span class="line">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="line">module_hotfixes=<span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装nginx</span></span><br><span class="line">$ yum install -y nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">$ nginx -v</span><br><span class="line">$ nginx -V</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动nginx</span></span><br><span class="line">$ systemctl start nginx</span><br><span class="line">$ systenctl status nginx</span><br><span class="line">$ systenctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>

<br>



<h2 id="配置sshkey"><a href="#配置sshkey" class="headerlink" title="配置sshkey"></a>配置sshkey</h2><p>在<code>SCA-LUM700011</code>这台创建ssh key并分发到其他节点，将这台服务器作为运维节点，下面使用的ansible就在这个上面运行。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ssh-keygen</span><br><span class="line">$ ssh-copy-id 10.8.138.5</span><br><span class="line">$ ssh-copy-id 10.8.138.6</span><br><span class="line">$ ssh-copy-id 10.8.138.10</span><br><span class="line">$ ssh-copy-id 10.8.138.9</span><br><span class="line">$ ssh-copy-id 10.8.138.11</span><br></pre></td></tr></table></figure>

<br>



<h2 id="安装ansible"><a href="#安装ansible" class="headerlink" title="安装ansible"></a>安装ansible</h2><p><code>ansible</code>可以方便批量执行指令：</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install -y ansible</span><br></pre></td></tr></table></figure>



<h3 id="设置配置文件"><a href="#设置配置文件" class="headerlink" title="设置配置文件"></a>设置配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/ansible/ansible.cfg &lt;&lt;EOF</span><br><span class="line">[defaults]</span><br><span class="line">log_path = /var/<span class="built_in">log</span>/ansible.log</span><br><span class="line">forks = 20</span><br><span class="line">host_key_checking = False</span><br><span class="line">retry_files_enabled = False</span><br><span class="line">deprecation_warnings = False</span><br><span class="line">nocows = True</span><br><span class="line">remote_user = root</span><br><span class="line">roles_path = roles/</span><br><span class="line">gathering = smart</span><br><span class="line">fact_caching = jsonfile</span><br><span class="line">fact_caching_connection = /etc/ansible/facts</span><br><span class="line">fact_caching_timeout = 600</span><br><span class="line">callback_whitelist = profile_tasks</span><br><span class="line">inventory_ignore_extensions = secrets.py, .pyc, .cfg, .crt, .ini</span><br><span class="line">timeout = 30</span><br><span class="line"></span><br><span class="line">[inventory]</span><br><span class="line">unparsed_is_failed=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[ssh_connection]</span><br><span class="line">pipelining = True</span><br><span class="line">ssh_args = -o ControlMaster=auto -o ControlPersist=600s</span><br><span class="line">timeout = 10</span><br><span class="line">control_path = %(directory)s/%%h-%%r</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="设置ansible-host文件"><a href="#设置ansible-host文件" class="headerlink" title="设置ansible host文件"></a>设置ansible host文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/ansible/hosts &lt;&lt;EOF</span><br><span class="line">[cluster]</span><br><span class="line">10.8.138.5  hostname=<span class="string">'SCA-LUM700007'</span></span><br><span class="line">10.8.138.6  hostname=<span class="string">'SCA-LUM700008'</span></span><br><span class="line">10.8.138.10 hostname=<span class="string">'SCA-LUM700012'</span></span><br><span class="line">10.8.138.9  hostname=<span class="string">'SCA-LUM700013'</span></span><br><span class="line">10.8.138.11 hostname=<span class="string">'SCA-LUM700014'</span></span><br><span class="line"></span><br><span class="line">[ans]</span><br><span class="line">10.8.138.8</span><br><span class="line"></span><br><span class="line">[master]</span><br><span class="line">10.8.138.5</span><br><span class="line">10.8.138.6</span><br><span class="line">10.8.138.10</span><br><span class="line"></span><br><span class="line">[worker]</span><br><span class="line">10.8.138.9</span><br><span class="line">10.8.138.11</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="验证ansible"><a href="#验证ansible" class="headerlink" title="验证ansible"></a>验证ansible</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible cluster -m ping</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="ansible-check.png" style="zoom:40%;" />

<br>

<h2 id="设置host"><a href="#设置host" class="headerlink" title="设置host"></a>设置host</h2><p>通过<code>ansible</code>为每个节点设置host文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ansible cluster -m shell -a <span class="string">'cat &gt;&gt; /etc/hosts &lt;&lt;EOF</span></span><br><span class="line"><span class="string">10.8.138.5  SCA-LUM700007 sca-lum700007 master1</span></span><br><span class="line"><span class="string">10.8.138.6  SCA-LUM700008 sca-lum700008 master2</span></span><br><span class="line"><span class="string">10.8.138.10 SCA-LUM700012 sca-lum700012 master3</span></span><br><span class="line"><span class="string">10.8.138.9  SCA-LUM700013 sca-lum700013 node1</span></span><br><span class="line"><span class="string">10.8.138.11 SCA-LUM700014 sca-lum700014 node2</span></span><br><span class="line"><span class="string">EOF'</span></span><br></pre></td></tr></table></figure>



<br>



<h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><p>需要给集群所有的节点安装docker：</p>
<h3 id="添加docker-repo文件"><a href="#添加docker-repo文件" class="headerlink" title="添加docker repo文件"></a>添加docker repo文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible cluster -m shell -a <span class="string">'yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo'</span></span><br></pre></td></tr></table></figure>



<h3 id="设置存储目录"><a href="#设置存储目录" class="headerlink" title="设置存储目录"></a>设置存储目录</h3><p>一般docker的数据存放路径为<code>/var/lib/docker</code>，所以在每个服务器上最好都有一个数据盘挂载到该目录下，防止docker数据过多爆盘。这里以一台服务器的设置为例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /var/lib/docker</span><br><span class="line">$ mkfs.xfs -f /dev/vdb</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">"/dev/vdb /var/lib/docker xfs defaults 0 0"</span> &gt;&gt; /etc/fstab</span><br><span class="line">$ mount -a</span><br><span class="line">$ df -h</span><br></pre></td></tr></table></figure>



<h3 id="安装docker-1"><a href="#安装docker-1" class="headerlink" title="安装docker"></a>安装docker</h3><p>这里使用的是18.06.3的版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前可用的版本</span></span><br><span class="line">$ yum list docker-ce --showduplicates|sort -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装docker</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'yum install -y docker-ce-18.06.3.ce-3.el7'</span></span><br></pre></td></tr></table></figure>



<h3 id="配置docker配置文件"><a href="#配置docker配置文件" class="headerlink" title="配置docker配置文件"></a>配置docker配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</span><br><span class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">  <span class="string">"log-opts"</span>: &#123;</span><br><span class="line">    <span class="string">"max-size"</span>: <span class="string">"100m"</span>,</span><br><span class="line">    <span class="string">"max-file"</span>: <span class="string">"5"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"storage-driver"</span>: <span class="string">"overlay2"</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发到集群节点</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'mkdir /etc/docker'</span></span><br><span class="line">$ ansible cluster -m copy -a <span class="string">'src=daemon.json dest=/etc/docker/daemon.json'</span></span><br></pre></td></tr></table></figure>



<h3 id="启动docker服务"><a href="#启动docker服务" class="headerlink" title="启动docker服务"></a>启动docker服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ansible cluster -m shell -a <span class="string">'systemctl daemon-reload'</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'systemctl restart docker'</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'systemctl status docker'</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'systemctl enable docker'</span></span><br></pre></td></tr></table></figure>

<br>



<h2 id="关闭swap"><a href="#关闭swap" class="headerlink" title="关闭swap"></a>关闭swap</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ansible cluster -m shell -a <span class="string">'swapoff -a'</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'sed -i "/swap/s/^/#/g" /etc/fstab'</span></span><br></pre></td></tr></table></figure>

<br>



<h2 id="开启ipvs"><a href="#开启ipvs" class="headerlink" title="开启ipvs"></a>开启ipvs</h2><p>本集群的service网络采用ipvs模式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置内核参数</span></span><br><span class="line">$ ansible cluster -m sysctl -a <span class="string">'name=net.ipv4.ip_forward value=1 state=present'</span></span><br><span class="line">$ ansible cluster -m sysctl -a <span class="string">'name=net.bridge.bridge-nf-call-iptables value=1 state=present'</span></span><br><span class="line">$ ansible cluster -m sysctl -a <span class="string">'name=net.bridge.bridge-nf-call-ip6tables value=1 state=present'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载ipvs模块</span></span><br><span class="line">$ cat &gt; /tmp/ipvs.modules &lt;&lt;EOF</span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ipvs_modules=<span class="string">"ip_vs ip_vs_lc ip_vs_wlc ip_vs_rr ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack_ipv4"</span></span><br><span class="line"><span class="keyword">for</span> kernel_module <span class="keyword">in</span> \<span class="variable">$&#123;ipvs_modules&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    /sbin/modinfo -F filename \<span class="variable">$&#123;kernel_module&#125;</span> &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">        /sbin/modprobe \<span class="variable">$&#123;kernel_module&#125;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ ansible cluster -m copy -a <span class="string">'src=/tmp/ipvs.modules dest=/root/ipvs.modules mode=0755'</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'sh /root/ipvs.modules'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机启动执行该脚本</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'echo "sh /root/ipvs.modules" &gt;&gt; /etc/rc.local'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证 ipvs 支持</span></span><br><span class="line">$ ansible cluster -m shell -a <span class="string">'lsmod | grep ip_vs'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装ipvsadm</span></span><br><span class="line">$ ansible cluster -m yum -a <span class="string">'name=ipvsadm state=present'</span></span><br></pre></td></tr></table></figure>

<br>



<h2 id="添加阿里云k8s-yum源"><a href="#添加阿里云k8s-yum源" class="headerlink" title="添加阿里云k8s yum源"></a>添加阿里云k8s yum源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 分发文件</span></span><br><span class="line">$ ansible cluster -m copy -a <span class="string">'src=/etc/yum.repos.d/kubernetes.repo dest=/etc/yum.repos.d/kubernetes.repo'</span></span><br></pre></td></tr></table></figure>

<br>



<h2 id="安装kubernetes基础工具"><a href="#安装kubernetes基础工具" class="headerlink" title="安装kubernetes基础工具"></a>安装kubernetes基础工具</h2><p>这里安装的是<code>1.17.3</code>版本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装kubectl、kubeadm、kubelet</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">'yum install -y kubelet-1.17.3 kubeadm-1.17.3 kubectl-1.17.3'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">'ls /usr/bin/kube*'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置kubelet自启动</span></span><br><span class="line">ansible cluster -m shell -a <span class="string">'systemctl enable kubelet'</span></span><br></pre></td></tr></table></figure>

<br>



<h2 id="创建master"><a href="#创建master" class="headerlink" title="创建master"></a>创建master</h2><p>这一步在任意一个master上执行，这里我在<code>master1</code>上执行。需要配置下kubeadm的相关参数。</p>
<h3 id="配置kubeadm参数"><a href="#配置kubeadm参数" class="headerlink" title="配置kubeadm参数"></a>配置kubeadm参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat &gt; kubeadm-config.yaml &lt;&lt; EOF</span></span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 0.0.0.0</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">  kubeletExtraArgs:</span><br><span class="line">    cgroup-driver: "systemd"</span><br><span class="line">  ignorePreflightErrors:</span><br><span class="line">  - IsPrivilegedUser</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">controlPlaneEndpoint: 10.8.138.12:6443</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 5m0s</span><br><span class="line">  extraArgs:</span><br><span class="line">    authorization-mode: "Node,RBAC"</span><br><span class="line">  certSANs:</span><br><span class="line">  - "10.8.138.12"</span><br><span class="line">  - "14.116.177.22"</span><br><span class="line">  - "kubernetes"</span><br><span class="line">  - "kubernetes.default"</span><br><span class="line">  - "kubernetes.default.svc"</span><br><span class="line">  - "kubernetes.default.svc.cluster"</span><br><span class="line">  - "kubernetes.default.svc.cluster.local"</span><br><span class="line">controllerManager:</span><br><span class="line">  extraArgs:</span><br><span class="line">    "node-cidr-mask-size": "20"</span><br><span class="line">scheduler:</span><br><span class="line">  extraArgs:</span><br><span class="line">    address: "0.0.0.0"</span><br><span class="line">dns:</span><br><span class="line">  type: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line"><span class="meta">#</span><span class="bash">    extraArgs:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">      listen-client-urls: <span class="string">"http://10.100.0.1:2379"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    serverCertSANs:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    serverCertSANs:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    - <span class="string">"localhost"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    - <span class="string">"127.0.0.1"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    peerCertSANs:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    - <span class="string">"localhost"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">    - <span class="string">"127.0.0.1"</span></span></span><br><span class="line">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line">kubernetesVersion: v1.17.3</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 172.24.0.0/16</span><br><span class="line">  podSubnet: 172.21.0.0/16</span><br><span class="line">---</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash">clusterCIDR:</span></span><br><span class="line">mode: ipvs  # 定义代理模式： userspace、 iptables 或 ipvs 。默认使用 iptables ，大集群建议使用 ipvs。</span><br><span class="line">ipvs:</span><br><span class="line">  scheduler: lc</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">  minSyncPeriod: 5s</span><br><span class="line">  tcpTimeout: 0s</span><br><span class="line">  tcpFinTimeout: 0s</span><br><span class="line">  udpTimeout: 0s</span><br><span class="line">---</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>其中<code>10.8.138.12</code>为我前端slb的IP地址，代理后端三个master节点的6443；</li>
<li>根据实际情况在<code>certSANs</code>中添加IP和域名；</li>
<li>注意修改其中的kubernetes的版本，以及ipvs模式的调度算法（这里我使用的是lc）</li>
</ul>
<h3 id="验证配置"><a href="#验证配置" class="headerlink" title="验证配置"></a>验证配置</h3><p>下面的命令可以验证配置是否有误，并不会真正执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm init --config&#x3D;kubeadm-config.yaml --upload-certs --dry-run</span><br></pre></td></tr></table></figure>



<h3 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建集群</span><br><span class="line">$ kubeadm init --config&#x3D;kubeadm-config.yaml --upload-certs</span><br></pre></td></tr></table></figure>



<p>执行成功的话，会出现下面的信息：</p>
<p><img src= "/img/loading.gif" data-src="kubeadm-init.png" alt=""></p>
<p>从上边可以看出，添加master节点和node节点就可以在对应服务器上执行下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 添加master</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \</span></span><br><span class="line">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \</span><br><span class="line">    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c</span><br><span class="line">    </span><br><span class="line"><span class="meta">#</span><span class="bash"> 添加node节点</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \</span></span><br><span class="line">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e</span><br></pre></td></tr></table></figure>

<blockquote>
<p>命令中的token有两个小时时效，时效后需要重新获取</p>
</blockquote>
<h3 id="添加其他master"><a href="#添加其他master" class="headerlink" title="添加其他master"></a>添加其他master</h3><p>在剩下的两个master节点<code>SCA-LUM700008</code>和<code>SCA-LUM700012</code>执行下面的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \</span></span><br><span class="line">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e \</span><br><span class="line">    --control-plane --certificate-key d708ea62b465ecfd667fa807eb6a0cc7babbb4969a3bb9256f13543a2ddfe20c</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不需要拷贝kubeadm-config.yaml文件，会通过第一个apiserver回去配置信息；</p>
</blockquote>
<br>

<h2 id="设置kubectl"><a href="#设置kubectl" class="headerlink" title="设置kubectl"></a>设置kubectl</h2><h3 id="自动补全"><a href="#自动补全" class="headerlink" title="自动补全"></a>自动补全</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ansible master -m shell -a <span class="string">'echo "source &lt;(kubectl completion bash)" &gt;&gt; ~/.bashrc'</span></span><br></pre></td></tr></table></figure>



<h3 id="设置kubectl证书"><a href="#设置kubectl证书" class="headerlink" title="设置kubectl证书"></a>设置kubectl证书</h3><p>现在执行kubectl命令需要<code>--kubeconfig</code>参数指定配置文件，执行下面的命令设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp /etc/kubernetes/admin.conf /root/.kube/config</span><br></pre></td></tr></table></figure>



<br>

<h2 id="验证master部署情况"><a href="#验证master部署情况" class="headerlink" title="验证master部署情况"></a>验证master部署情况</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看master</span></span><br><span class="line">$ kubectl get node --kubeconfig /etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pod</span></span><br><span class="line">$ kubectl get pod --all-namespaces --kubeconfig /etc/kubernetes/admin.conf</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="check-master.png" alt=""></p>
<blockquote>
<p>这里有些pod没有启动是正常的，因为集群还没部署完成。</p>
</blockquote>
<h2 id="确认kube-proxy开启了ipvs"><a href="#确认kube-proxy开启了ipvs" class="headerlink" title="确认kube-proxy开启了ipvs"></a>确认kube-proxy开启了ipvs</h2><p>首先查看网卡信息，多了一个kube-ipvs0网卡：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ip a s</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="ipvs.png" style="zoom:50%;" />





<p>查看ipvs规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipvsadm -Ln</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="ipvs-rule.png" style="zoom:40%;" />

<br>



<h2 id="etcd配置"><a href="#etcd配置" class="headerlink" title="etcd配置"></a>etcd配置</h2><h3 id="更新etcd配置"><a href="#更新etcd配置" class="headerlink" title="更新etcd配置"></a>更新etcd配置</h3><p>更新后会自动重启服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ansible master -m shell -a <span class="string">'sed -i "/--initial-cluster=/c\    - --initial-cluster=sca-lum700012=https://10.8.138.10:2380,sca-lum700007=https://10.8.138.5:2380,sca-lum700008=https://10.8.138.6:2380" /etc/kubernetes/manifests/etcd.yaml'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apiserver 默认访问本地的 etcd 节点，如果需要访问集群所有节点可以修改配置。</span></span><br><span class="line">$ ansible master -m shell -a <span class="string">'sed -i "/- --etcd-servers/c\    - --etcd-servers=https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379" /etc/kubernetes/manifests/kube-apiserver.yaml'</span></span><br></pre></td></tr></table></figure>



<h3 id="查看etcd节点状态"><a href="#查看etcd节点状态" class="headerlink" title="查看etcd节点状态"></a>查看etcd节点状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载etcdctl</span></span><br><span class="line">$ curl -L -O https://github.com/etcd-io/etcd/releases/download/v3.4.3/etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class="line">$ tar xzf etcd-v3.4.3-linux-amd64.tar.gz</span><br><span class="line">$ mv etcd-v3.4.3-linux-amd64/etcd* /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">$ ETCDCTL=3 etcdctl --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   member list</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="etcd-member.png" alt=""></p>
<h3 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint status</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="etcd-cluster.png" alt=""></p>
<h3 id="etcd节点健康状态"><a href="#etcd节点健康状态" class="headerlink" title="etcd节点健康状态"></a>etcd节点健康状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ETCDCTL=3 etcdctl --cluster --write-out=table   --cert /etc/kubernetes/pki/etcd/peer.crt   --key /etc/kubernetes/pki/etcd/peer.key   --cacert /etc/kubernetes/pki/etcd/ca.crt   --endpoints https://10.8.138.10:2379,https://10.8.138.5:2379,https://10.8.138.6:2379   endpoint health</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="etcd-helth.png" alt=""></p>
<br>



<h2 id="创建node"><a href="#创建node" class="headerlink" title="创建node"></a>创建node</h2><p>在所有node节点上执行下面的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm join 10.8.138.12:6443 --token z9ibq2.s5ttzyxvc49mep02 \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:71a025d1a18f9ec0f4c16ab771b2d01674ce9921316c87e0bdfd162d53f8524e</span><br></pre></td></tr></table></figure>



<p>查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="getnode.png" style="zoom:67%;" />



<p><em>节点已经添加进来了，因为没有部署CNI所以都是NOTREADY。</em></p>
<br>



<h2 id="部署calico"><a href="#部署calico" class="headerlink" title="部署calico"></a>部署calico</h2><h3 id="下载calico"><a href="#下载calico" class="headerlink" title="下载calico"></a>下载calico</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载calico的yaml文件</span></span><br><span class="line">$ curl -L https://docs.projectcalico.org/v3.11/manifests/calico.yaml -o calico.yaml</span><br></pre></td></tr></table></figure>



<h3 id="部署calico-1"><a href="#部署calico-1" class="headerlink" title="部署calico"></a>部署calico</h3><p>修改calico.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改为pod网段</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CALICO_IPV4POOL_CIDR</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"172.21.0.0/16"</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 增加该参数，设定端口范围</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FELIX_KUBENODEPORTRANGES</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"30000:50000"</span></span><br></pre></td></tr></table></figure>



<p>部署calico：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>



<p>部署完成后，查看节点状态，应该都READY：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get node</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="nodes.png" style="zoom:50%;" />



<h3 id="设置calico命令行工具"><a href="#设置calico命令行工具" class="headerlink" title="设置calico命令行工具"></a>设置calico命令行工具</h3><p>下载calico命令行工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载</span></span><br><span class="line">$ curl -L -o /usr/<span class="built_in">local</span>/bin/calicoctl https://github.com/projectcalico/calicoctl/releases/download/v3.11.2/calicoctl-linux-amd64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">$ mkdir -p /etc/calico</span><br><span class="line">$ cat &gt; /etc/calico/calicoctl.cfg &lt;&lt;EOF</span><br><span class="line">apiVersion: projectcalico.org/v3</span><br><span class="line">kind: CalicoAPIConfig</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">  datastoreType: kubernetes</span><br><span class="line">  kubeconfig: /etc/kubernetes/admin.conf  <span class="comment"># 使用 admin 配置</span></span><br><span class="line">  <span class="comment">#k8sAPIEndpoint: https://10.8.138.12:6443</span></span><br><span class="line">  <span class="comment">#k8sCertFile: /etc/kubernetes/pki/apiserver-kubelet-client.crt</span></span><br><span class="line">  <span class="comment">#k8sKeyFile: /etc/kubernetes/pki/apiserver-kubelet-client.key</span></span><br><span class="line">  <span class="comment">#k8sCAFile: /etc/kubernetes/pki/ca.crt</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h3 id="查看calico节点"><a href="#查看calico节点" class="headerlink" title="查看calico节点"></a>查看calico节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ calicoctl node status</span><br></pre></td></tr></table></figure>

<img src= "/img/loading.gif" data-src="calico-node.png" style="zoom:50%;" />



<h3 id="查看ippool"><a href="#查看ippool" class="headerlink" title="查看ippool"></a>查看ippool</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ calicoctl get ippool -o wide</span><br><span class="line">NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR</span><br><span class="line">default-ipv4-ippool   172.21.0.0/16   <span class="literal">true</span>   Always     Never       <span class="literal">false</span>      all()</span><br></pre></td></tr></table></figure>



<h3 id="查看ip状态"><a href="#查看ip状态" class="headerlink" title="查看ip状态"></a>查看ip状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ calicoctl ipam show</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="calico-ip.png" alt=""></p>
<br>



<h2 id="集群校验"><a href="#集群校验" class="headerlink" title="集群校验"></a>集群校验</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl config get-clusters</span><br><span class="line">kubectl cluster-info</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="cluster-check.png" alt=""></p>
<br>



<h2 id="nginx服务其配置"><a href="#nginx服务其配置" class="headerlink" title="nginx服务其配置"></a>nginx服务其配置</h2><p><code>SCA-LUM700011</code>作为nginx服务器，将会代理ingress服务，所以先设置一下。</p>
<h3 id="自签证书"><a href="#自签证书" class="headerlink" title="自签证书"></a>自签证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确认安装了openssl</span></span><br><span class="line">openssl version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 确定nginx安装了https模块(应该有--with-http_ssl_module)</span></span><br><span class="line">nginx -V</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建整数目录</span></span><br><span class="line"><span class="built_in">cd</span> /etc/nginx/</span><br><span class="line">mkdir ssl</span><br><span class="line"><span class="built_in">cd</span> ssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成秘钥</span></span><br><span class="line">$ openssl genrsa -out nginx.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus</span><br><span class="line">..............................................+++</span><br><span class="line">.....................................................................+++</span><br><span class="line">e is 65537 (0x10001)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成签名请求文件（csr），输入上边的密码，并输入相关的信息</span></span><br><span class="line">openssl req -new -key nginx.key -out nginx.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以在一行，不用交互式输入</span></span><br><span class="line">openssl req -subj <span class="string">"/C=CN/ST=Guangdong/L=Shenzhen/O=nginx/OU=dev/CN=test.example.com/emailAddress=test@123.com"</span> -new -key nginx.key -out nginx.csr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成自签名证书，指定过期时间3650天，输入密码即可生成</span></span><br><span class="line">openssl x509 -req -days 3650 -<span class="keyword">in</span> nginx.csr -signkey nginx.key -out nginx.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看生成的文件</span></span><br><span class="line">$ ls</span><br><span class="line">nginx.crt  nginx.csr  nginx.key</span><br></pre></td></tr></table></figure>



<h3 id="修改nginx主配置文件"><a href="#修改nginx主配置文件" class="headerlink" title="修改nginx主配置文件"></a>修改nginx主配置文件</h3><p>修改<code>/etc/nginx/nginx.conf</code>文件为如下内容：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span>  nginx;</span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span>  /var/log/nginx/error.log <span class="literal">warn</span>;</span><br><span class="line"><span class="attribute">pid</span>        /var/run/nginx.pid;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里使用<code>include</code>导入其他的配置文件，所有服务的nginx配置都放在<code>/etc/nginx/conf.d</code>下，如果目录不存在需要自己创建。</p>
<p>在``/etc/nginx/conf.d<code>下先创建一个通用配置文件</code>common.ini`，这个是所有配置文件都要用的，所以抽离出来：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> = /favicon.ico &#123;</span><br><span class="line">    <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* /\.(svn|git)/</span> &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">404</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="创建一个测试配置"><a href="#创建一个测试配置" class="headerlink" title="创建一个测试配置"></a>创建一个测试配置</h3><p>在<code>/etc/nginx/conf.d</code>下新建一个配置文件<code>https.conf</code>：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">  <span class="attribute">server_name</span> https-server.example.com;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> https://<span class="variable">$host</span><span class="variable">$1</span> <span class="literal">permanent</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> https-server.example.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/nginx/ssl/new/nginx.crt;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/new/nginx.key;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/https-server.example.com_access.log main;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/https-server.example.com_error.log;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">root</span> /usr/share/nginx/html;</span><br><span class="line">      <span class="attribute">index</span> index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> conf.d/common.ini;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在<code>/usr/share/nginx/html</code>下创建测试页面：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">"this is https page"</span> &gt; /usr/share/nginx/html/index.html</span><br></pre></td></tr></table></figure>



<h3 id="绑定host"><a href="#绑定host" class="headerlink" title="绑定host"></a>绑定host</h3><p>因为我是测试环境，且我要通过域名的方式访问服务，所以需要绑定host，这一步在自己的电脑上操作，过程不赘述。</p>
<h3 id="重启nginx并访问"><a href="#重启nginx并访问" class="headerlink" title="重启nginx并访问"></a>重启nginx并访问</h3><p>执行下面的命令检查配置并重新加载：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -t</span><br><span class="line">$ nginx -s reload</span><br></pre></td></tr></table></figure>



<p>然后通过浏览器访问域名：<code>https-server.example.com</code>，应该就可以看到设置的https页面了。</p>
<blockquote>
<p>注意，有的浏览器对于自签证书是不信任的，需要手动下载证书然后在电脑中导入就可以了。</p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Luka Vergo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://liyongzhezz.github.io/2020/07/02/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-kubeadm%E9%83%A8%E7%BD%B2k8s-1.18/">https://liyongzhezz.github.io/2020/07/02/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-kubeadm%E9%83%A8%E7%BD%B2k8s-1.18/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://liyongzhezz.github.io" target="_blank">彭彭丁满</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/k8s%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/">k8s集群部署</a></div><div class="post_share"><div class="social-share" data-image="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1599574285430&amp;di=13d7f6b83db000b0a0298ab9c5e62a43&amp;imgtype=0&amp;src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180310%2F39fdd0b4d90346918a01b9f89556ecf3.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><button class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.png" alt="wechat" onclick="window.open('/img/wechat.png')"/><div class="post-qr-code__desc">wechat</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.png" alt="alipay" onclick="window.open('/img/alipay.png')"/><div class="post-qr-code__desc">alipay</div></li></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2020/07/03/Nginx%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"><img class="prev-cover" data-src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1596540192624&amp;di=bbd964cce4cea1709707e02e51dc38ce&amp;imgtype=0&amp;src=http%3A%2F%2Fwww.otcms.cn%2Fupfiles%2Finfoimg%2Fcoll%2Fot20190122232426541.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Nginx基础概念</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/07/03/k8s实践系列-升级集群到1-18/" title="[k8s实践系列]升级集群到1.18"><img class="relatedPosts_cover" data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1593790386156&di=943b925fcd65f439c473b846f9c0d9d5&imgtype=0&src=http%3A%2F%2Fgit.oschina.net%2Fkkomge%2Fkubeadm-ha%2Fraw%2Fe2b531dd2d3ca8202ca33da7063444ac750cc9f4%2Fimages%2FKubernetes.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-03</div><div class="relatedPosts_title">[k8s实践系列]升级集群到1.18</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/05/k8s实践系列-卸载集群/" title="[k8s实践系列]卸载集群"><img class="relatedPosts_cover" data-src="http://www.soft6.com/uploadfile/2017/1009/20171009035234769.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-05</div><div class="relatedPosts_title">[k8s实践系列]卸载集群</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/05/k8s实践系列-证书管理/" title="[k8s实践系列]证书管理"><img class="relatedPosts_cover" data-src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-05</div><div class="relatedPosts_title">[k8s实践系列]证书管理</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/05/k8s实践系列-使用nfs存储/" title="[k8s实践系列]使用nfs存储"><img class="relatedPosts_cover" data-src="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=251466455,608736426&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-05</div><div class="relatedPosts_title">[k8s实践系列]使用nfs存储</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/05/k8s实践系列-部署MetricServer/" title="[k8s实践系列]部署MetricServer"><img class="relatedPosts_cover" data-src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-05</div><div class="relatedPosts_title">[k8s实践系列]部署MetricServer</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/09/k8s实践系列-EFK-Kafka日志收集-一/" title="[k8s实践系列]EFK+Kafka日志收集(一)--架构方案和准备"><img class="relatedPosts_cover" data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1594302026732&di=01120f85d5d842f277b2ab6c42ef3373&imgtype=0&src=http%3A%2F%2Fwww.ruanyifeng.com%2Fblogimg%2Fasset%2F2017%2Fbg2017081701.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-09</div><div class="relatedPosts_title">[k8s实践系列]EFK+Kafka日志收集(一)--架构方案和准备</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '50c33518212f08034726',
  clientSecret: '497b04ce72a905ec41ebc3fb051369434affe3c7',
  repo: 'liyongzhezz.github.io',
  owner: 'liyongzhezz',
  admin: ['liyongzhezz'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Luka Vergo</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"><meta name="generator" content="Hexo 4.2.1"></head></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">简</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fas fa-comments"></i></a><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>