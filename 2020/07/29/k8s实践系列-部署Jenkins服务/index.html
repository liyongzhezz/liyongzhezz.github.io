<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>[k8s实践系列]基于动态jenkins-slave的CICD | 彭彭丁满</title><meta name="description" content="在k8s环境中部署jenkins并实现动态slave功能"><meta name="keywords" content="k8s,Jenkins"><meta name="author" content="Luka Vergo"><meta name="copyright" content="Luka Vergo"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://liyongzhezz.github.io/2020/07/29/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-%E9%83%A8%E7%BD%B2Jenkins%E6%9C%8D%E5%8A%A1/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="[k8s实践系列]基于动态jenkins-slave的CICD"><meta property="og:url" content="https://liyongzhezz.github.io/2020/07/29/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-%E9%83%A8%E7%BD%B2Jenkins%E6%9C%8D%E5%8A%A1/"><meta property="og:site_name" content="彭彭丁满"><meta property="og:description" content="在k8s环境中部署jenkins并实现动态slave功能"><meta property="og:image" content="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1596017743701&amp;di=489a3aed2ef7d89f6f665bdf4e6b9362&amp;imgtype=0&amp;src=http%3A%2F%2Fimg4.mukewang.com%2F5b1e0cfc0001ef7b06000338.jpg"><meta property="article:published_time" content="2020-07-29T07:25:43.000Z"><meta property="article:modified_time" content="2020-07-29T08:03:31.051Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = '1'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="prev" title="Prometheus监控指标--kubernetes" href="https://liyongzhezz.github.io/2020/07/30/Prometheus%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87-kubernetes/"><link rel="next" title="Nginx用户名密码认证" href="https://liyongzhezz.github.io/2020/07/29/Nginx%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E8%AE%A4%E8%AF%81/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-1185009661039450',
  enable_page_level_ads: 'true'
});</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"bottom-left"},
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true
  }</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avator.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">51</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">25</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">27</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#准备工作"><span class="toc-number">1.</span> <span class="toc-text">准备工作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#新建namespace"><span class="toc-number">1.1.</span> <span class="toc-text">新建namespace</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建storageclass对象"><span class="toc-number">1.2.</span> <span class="toc-text">创建storageclass对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建pvc"><span class="toc-number">1.3.</span> <span class="toc-text">创建pvc</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#服务部署"><span class="toc-number">2.</span> <span class="toc-text">服务部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建serviceaccount并授权"><span class="toc-number">2.1.</span> <span class="toc-text">创建serviceaccount并授权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#新建master-deployment"><span class="toc-number">2.2.</span> <span class="toc-text">新建master deployment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#新建service"><span class="toc-number">2.3.</span> <span class="toc-text">新建service</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#暴露服务"><span class="toc-number">3.</span> <span class="toc-text">暴露服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#新建Ingress"><span class="toc-number">3.1.</span> <span class="toc-text">新建Ingress</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看服务运行情况"><span class="toc-number">3.2.</span> <span class="toc-text">查看服务运行情况</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx设置反向代理"><span class="toc-number">3.3.</span> <span class="toc-text">nginx设置反向代理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#访问测试"><span class="toc-number">4.</span> <span class="toc-text">访问测试</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#jenkins汉化"><span class="toc-number">5.</span> <span class="toc-text">jenkins汉化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#动态创建slave"><span class="toc-number">6.</span> <span class="toc-text">动态创建slave</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是动态生成slave"><span class="toc-number">6.1.</span> <span class="toc-text">什么是动态生成slave</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#优势"><span class="toc-number">6.2.</span> <span class="toc-text">优势</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件安装和设置"><span class="toc-number">6.3.</span> <span class="toc-text">插件安装和设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试"><span class="toc-number">6.4.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pipline结合动态slave"><span class="toc-number">7.</span> <span class="toc-text">pipline结合动态slave</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是pipeline"><span class="toc-number">7.1.</span> <span class="toc-text">什么是pipeline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pipeline-核心概念"><span class="toc-number">7.2.</span> <span class="toc-text">Pipeline 核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#如何创建Pipline"><span class="toc-number">7.3.</span> <span class="toc-text">如何创建Pipline</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建一个简单的pipline"><span class="toc-number">7.4.</span> <span class="toc-text">创建一个简单的pipline</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#通过pipeline部署服务到k8s"><span class="toc-number">8.</span> <span class="toc-text">通过pipeline部署服务到k8s</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#流程"><span class="toc-number">8.1.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jenkins添加凭证"><span class="toc-number">8.2.</span> <span class="toc-text">jenkins添加凭证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建代码"><span class="toc-number">8.3.</span> <span class="toc-text">创建代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加dockerfile"><span class="toc-number">8.4.</span> <span class="toc-text">添加dockerfile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加部署yaml"><span class="toc-number">8.5.</span> <span class="toc-text">添加部署yaml</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加Jenkinsfile"><span class="toc-number">8.6.</span> <span class="toc-text">添加Jenkinsfile</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#推动代码到代码库"><span class="toc-number">8.7.</span> <span class="toc-text">推动代码到代码库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改流水线配置"><span class="toc-number">8.8.</span> <span class="toc-text">修改流水线配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行流水线"><span class="toc-number">8.9.</span> <span class="toc-text">运行流水线</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1596017743701&amp;di=489a3aed2ef7d89f6f665bdf4e6b9362&amp;imgtype=0&amp;src=http%3A%2F%2Fimg4.mukewang.com%2F5b1e0cfc0001ef7b06000338.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">彭彭丁满</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">[k8s实践系列]基于动态jenkins-slave的CICD</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-07-29 15:25:43"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2020-07-29</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-29 16:03:31"><i class="fas fa-history fa-fw"></i> 更新于 2020-07-29</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/%E5%AE%9E%E8%B7%B5K8s/">实践K8s</a><i class="fas fa-angle-right post-meta__separator"></i><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/%E5%AE%9E%E8%B7%B5K8s/Jenkins/">Jenkins</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="far fa-comments fa-fw post-meta__icon"></i><span>评论数:</span><a href="/2020/07/29/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-%E9%83%A8%E7%BD%B2Jenkins%E6%9C%8D%E5%8A%A1/#post-comment"><span class="gitalk-comment-count comment-count"></span></a></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><p><strong>在k8s中部署jenkins服务，并实现根据流水线自动创建slave工作节点。</strong></p>
<hr>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><h2 id="新建namespace"><a href="#新建namespace" class="headerlink" title="新建namespace"></a>新建namespace</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># namespace.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-ops</span></span><br></pre></td></tr></table></figure>



<p>执行下面的命令完成创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f namespace.yaml</span><br></pre></td></tr></table></figure>



<h2 id="创建storageclass对象"><a href="#创建storageclass对象" class="headerlink" title="创建storageclass对象"></a>创建storageclass对象</h2><p>这里使用nfs作为后端存储，可以参考：<a href="/2020/07/05/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8nfs%E5%AD%98%E5%82%A8/" title="[k8s实践系列]使用nfs存储">[k8s实践系列]使用nfs存储</a>，需要创建一个名为<code>xjl-storageclass</code>的storageclass。</p>
<h2 id="创建pvc"><a href="#创建pvc" class="headerlink" title="创建pvc"></a>创建pvc</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pvc.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">opspvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">xjl-storageclass</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">20Gi</span></span><br></pre></td></tr></table></figure>



<p>执行下面的命令完成创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pvc.yaml</span><br></pre></td></tr></table></figure>



<p><img src= "/img/loading.gif" data-src="pvc.png" alt=""></p>
<br>



<h1 id="服务部署"><a href="#服务部署" class="headerlink" title="服务部署"></a>服务部署</h1><h2 id="创建serviceaccount并授权"><a href="#创建serviceaccount并授权" class="headerlink" title="创建serviceaccount并授权"></a>创建serviceaccount并授权</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jenkins-serviceaccount.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["extensions",</span> <span class="string">"apps"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["deployments"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["create",</span> <span class="string">"delete"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["services"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["create",</span> <span class="string">"delete"</span><span class="string">,</span> <span class="string">"get"</span><span class="string">,</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["pods"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["create","delete","get","list","patch","update","watch"]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["pods/exec"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["create","delete","get","list","patch","update","watch"]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["pods/log"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["get","list","watch"]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["secrets"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["get"]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">jenkins2</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-ops</span></span><br></pre></td></tr></table></figure>



<p>执行下面的命令完成创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f jenkins-serviceaccount.yaml</span><br></pre></td></tr></table></figure>



<h2 id="新建master-deployment"><a href="#新建master-deployment" class="headerlink" title="新建master deployment"></a>新建master deployment</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jenkins-deployment.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-ops</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">jenkins2</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jenkins2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">jenkins2</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">jenkins/jenkins:lts</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">50000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">12</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">12</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkinshome</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">jenkins2</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LIMITS_MEMORY</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">resourceFieldRef:</span></span><br><span class="line">              <span class="attr">resource:</span> <span class="string">limits.memory</span></span><br><span class="line">              <span class="attr">divisor:</span> <span class="string">1Mi</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JAVA_OPTS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">-Xmx$(LIMITS_MEMORY)m</span> <span class="string">-XshowSettings:vm</span> <span class="string">-Dhudson.slaves.NodeProvisioner.initialDelay=0</span> <span class="string">-Dhudson.slaves.NodeProvisioner.MARGIN=50</span> <span class="string">-Dhudson.slaves.NodeProvisioner.MARGIN0=0.85</span> <span class="string">-Duser.timezone=Asia/Shanghai</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">1000</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkinshome</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">opspvc</span></span><br></pre></td></tr></table></figure>



<p>执行下面的命令完成创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f jenkins-deployment.yaml</span><br></pre></td></tr></table></figure>



<h2 id="新建service"><a href="#新建service" class="headerlink" title="新建service"></a>新建service</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jenkins-service.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-ops</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins2</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">50000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">50000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>



<p>执行下面的命令完成创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f jenkins-service.yaml</span><br></pre></td></tr></table></figure>



<br>



<h1 id="暴露服务"><a href="#暴露服务" class="headerlink" title="暴露服务"></a>暴露服务</h1><h2 id="新建Ingress"><a href="#新建Ingress" class="headerlink" title="新建Ingress"></a>新建Ingress</h2><p>设定jenkins的域名为：<code>jenkins-k8s.example.com</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jenkins-ingress.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-ops</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">jenkins-k8s.example.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">jenkins2</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/</span></span><br></pre></td></tr></table></figure>



<p>执行下面的域名完成创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f jenkins-ingress.yaml</span><br></pre></td></tr></table></figure>



<br>



<h2 id="查看服务运行情况"><a href="#查看服务运行情况" class="headerlink" title="查看服务运行情况"></a>查看服务运行情况</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod,svc,ingress,pvc -n kube-ops</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="status.png" alt=""></p>
<br>



<h2 id="nginx设置反向代理"><a href="#nginx设置反向代理" class="headerlink" title="nginx设置反向代理"></a>nginx设置反向代理</h2><p>这里使用ingress-nginx作为服务入口，外部通过nginx最为ingress的代理，设置jenkins对应的nginx配置如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jenkins-k8s.conf</span></span><br><span class="line"><span class="attribute">upstream</span> jenkins-k8s &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">10.8.138.10:80</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">10s</span> weight=<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">10.8.138.9:80</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">10s</span> weight=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> jenkins-k8s.example.com;</span><br><span class="line">    <span class="attribute">access_log</span> /var/log/nginx/jenkins-k8s.example.com_access.log elk_json;</span><br><span class="line">    <span class="attribute">error_log</span> /var/log/nginx/jenkins-k8s.example.com_error.log;</span><br><span class="line">    <span class="attribute">expires</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://jenkins-k8s;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host jenkins-k8s.example.com;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_buffering</span>          <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_intercept_errors</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span>    <span class="number">30</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span>       <span class="number">30</span>;</span><br><span class="line">        <span class="attribute">proxy_send_timeout</span>       <span class="number">30</span>;</span><br><span class="line">        <span class="attribute">proxy_buffer_size</span> <span class="number">64k</span>;</span><br><span class="line">        <span class="attribute">proxy_buffers</span> <span class="number">8</span> <span class="number">64k</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> = /favicon.ico &#123;</span><br><span class="line">        <span class="attribute">log_not_found</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~* /\.(svn|git)/</span> &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">404</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>upstream中的两台机器是我的k8s中的ingress节点；</li>
<li>域名<code>jenkins-k8s.example.com</code>需要和nginx节点的IP做hosdt绑定；</li>
</ul>
<p>执行下面的命令检查nginx并重载配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nginx -t</span><br><span class="line">$ nginx -s reload</span><br></pre></td></tr></table></figure>



<br>



<h1 id="访问测试"><a href="#访问测试" class="headerlink" title="访问测试"></a>访问测试</h1><p>通过浏览器，使用域名访问jenkins，可以看到如下的页面：</p>
<p><img src= "/img/loading.gif" data-src="jenkins-init.png" alt=""></p>
<p>使用如下的命令获取到token并解锁jenkins：</p>
<p><img src= "/img/loading.gif" data-src="jenkins-password.png" alt=""></p>
<p>进入后根据实际情况安装插件，然后设置一个用户名和密码，就完成jenkins的部署了。</p>
<p><img src= "/img/loading.gif" data-src="jenkins-home.png" alt=""></p>
<br>



<h1 id="jenkins汉化"><a href="#jenkins汉化" class="headerlink" title="jenkins汉化"></a>jenkins汉化</h1><p>选择 <code>Manage Jenkins</code> –&gt; <code>Plugin Manager</code> –&gt; <code>Available</code>，搜索插件<code>locale plugin</code>并安装。</p>
<blockquote>
<p>一般安装完成就自动切换为中文了。</p>
</blockquote>
<br>



<h1 id="动态创建slave"><a href="#动态创建slave" class="headerlink" title="动态创建slave"></a>动态创建slave</h1><h2 id="什么是动态生成slave"><a href="#什么是动态生成slave" class="headerlink" title="什么是动态生成slave"></a>什么是动态生成slave</h2><p>Jenkins Master 和 Jenkins Slave 以 Pod 形式运行在 Kubernetes 集群的 Node 上，Master 运行在其中一个节点，并且将其配置数据存储到一个 Volume 上去，Slave 运行在各个节点上，并且它不是一直处于运行状态，它会按照需求动态的创建并自动删除。</p>
<p>这种方式的工作流程大致为：当 Jenkins Master 接受到 Build 请求时，会根据配置的 Label 动态创建一个运行在 Pod 中的 Jenkins Slave 并注册到 Master 上，当运行完 Job 后，这个 Slave 会被注销并且这个 Pod 也会自动删除，恢复到最初状态。</p>
<p><img src= "/img/loading.gif" data-src="jenkins-slave" alt=""></p>
<h2 id="优势"><a href="#优势" class="headerlink" title="优势"></a>优势</h2><ul>
<li>服务高可用，当 Jenkins Master 出现故障时，Kubernetes 会自动创建一个新的 Jenkins Master 容器，并且将 Volume 分配给新创建的容器，保证数据不丢失，从而达到集群服务高可用。</li>
<li>动态伸缩，合理使用资源，每次运行 Job 时，会自动创建一个 Jenkins Slave，Job 完成后，Slave 自动注销并删除容器，资源自动释放，而且 Kubernetes 会根据每个资源的使用情况，动态分配 Slave 到空闲的节点上创建，降低出现因某节点资源利用率高，还排队等待在该节点的情况。</li>
<li>扩展性好，当 Kubernetes 集群的资源严重不足而导致 Job 排队等待时，可以很容易的添加一个 Kubernetes Node 到集群中，从而实现扩展。</li>
</ul>
<h2 id="插件安装和设置"><a href="#插件安装和设置" class="headerlink" title="插件安装和设置"></a>插件安装和设置</h2><p>搜索插件<code>kubernetes</code>并安装。</p>
<p><img src= "/img/loading.gif" data-src="kubernetes.png" alt=""></p>
<p>选择<code>Manage Jenkins</code> —&gt; <code>Configure System</code> —&gt; (拖到最下方)<code>Add a new cloud</code>，选择<code>kubernetes</code>，填写kubernetes和jenkins信息：</p>
<p><img src= "/img/loading.gif" data-src="add-cloud.png" alt=""></p>
<ul>
<li><code>namespace</code>这里填写的是<code>kube-ops</code>；</li>
<li><code>jenkins地址</code>按照k8s集群内域名的格式填写；</li>
<li>点击测试，如果出现<code>success</code>表名连接集群成功；</li>
</ul>
<p>然后点击<code>pod template</code>，添加一个pod模板，就是<code>jenkins-slave</code>运行的模板：</p>
<p><img src= "/img/loading.gif" data-src="pod-template.png" alt=""></p>
<blockquote>
<p>这里的template名称和标签列表似乎只能是这个值，否则slave启动会失败。</p>
</blockquote>
<p>需要挂载两个主机目录：</p>
<ul>
<li><code>/var/run/docker.sock</code>：该文件是用于 Pod 中的容器能够共享宿主机的 Docker（docker in docker 的方式）；</li>
<li><code>/root/.kube</code> ：将这个目录挂载到容器的 /home/jenkins/.kube 目录下面这是为了让我们能够在 Pod 的容器中能够使用 kubectl 工具来访问 Kubernetes 集群，方便后面在 Slave Pod 部署 Kubernetes 应用；</li>
</ul>
<p><img src= "/img/loading.gif" data-src="volume.png" alt=""></p>
<p>这里设置一下超时时间和serviceaccount，防止出现权限问题。</p>
<p><img src= "/img/loading.gif" data-src="timeout.png" alt=""></p>
<p>设置完成后保存。</p>
<p><strong>因为需要kubeconfig文件，所以从master上将/root/.kube拷贝到node节点上</strong></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>新建一个任务：</p>
<p><img src= "/img/loading.gif" data-src="demo.png" alt=""></p>
<p>这里的标签表达式填入上面设置的标签<code>haimaxy-jnlp</code>：</p>
<p><img src= "/img/loading.gif" data-src="label.png" alt=""></p>
<p>然后在<code>构建</code>这个步骤中，选择<code>执行shell</code>，使用下面的脚本测试：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"测试 Kubernetes 动态生成 jenkins slave"</span><span class="built_in">echo</span> <span class="string">"==============docker in docker==========="</span></span><br><span class="line">docker info</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=============kubectl============="</span></span><br><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>



<p>点击保存后，执行构建，因为整个构建很简单，所以速度很快，查看构建日志可以看见构建成功了：</p>
<p><img src= "/img/loading.gif" data-src="result.png" alt=""></p>
<p>或者可以在master节点上执行下面的命令动态查看构建过程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch kubectl get pod -n kube-ops</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看到会创建一个slave的pod执行成功后自动删除。</p>
</blockquote>
<br>



<h1 id="pipline结合动态slave"><a href="#pipline结合动态slave" class="headerlink" title="pipline结合动态slave"></a>pipline结合动态slave</h1><h2 id="什么是pipeline"><a href="#什么是pipeline" class="headerlink" title="什么是pipeline"></a>什么是pipeline</h2><p>在 Jenkins 中的构建工作可以有多种方式，常用的是 Pipeline 这种方式。Pipeline就是一套运行在 Jenkins 上的工作流框架，将原来独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排和可视化的工作。</p>
<h2 id="Pipeline-核心概念"><a href="#Pipeline-核心概念" class="headerlink" title="Pipeline 核心概念"></a>Pipeline 核心概念</h2><ul>
<li><code>Node</code>：节点，一个 Node 就是一个 Jenkins 节点，Master 或者 Agent，是执行 Step 的具体运行环境，比如动态运行的Slave；</li>
<li><code>Stage</code>：阶段，一个 Pipeline 可以划分为若干个 Stage，每个 Stage 代表一组操作，比如：Build、Test、Deploy，Stage 是一个逻辑分组的概念，可以跨多个 Node</li>
<li><code>Step</code>：步骤，Step 是最基本的操作单元，可以是打印一句话，也可以是构建一个 Docker 镜像，由各类 Jenkins 插件提供，比如命令：sh ‘make’，就相当于我们平时 shell 终端中执行 make 命令一样。</li>
</ul>
<h2 id="如何创建Pipline"><a href="#如何创建Pipline" class="headerlink" title="如何创建Pipline"></a>如何创建Pipline</h2><ul>
<li>Pipeline 脚本是由 Groovy 语言实现的，但是我们没必要单独去学习 Groovy，当然你会的话最好</li>
<li>Pipeline 支持两种语法：Declarative(声明式)和 Scripted Pipeline(脚本式)语法</li>
<li>Pipeline 也有两种创建方法：可以直接在 Jenkins 的 Web UI 界面中输入脚本；也可以通过创建一个 Jenkinsfile 脚本文件放入项目源码库中</li>
<li>一般我们都推荐在 Jenkins 中直接从源代码控制(SCMD)中直接载入 Jenkinsfile Pipeline 这种方法</li>
</ul>
<br>



<h2 id="创建一个简单的pipline"><a href="#创建一个简单的pipline" class="headerlink" title="创建一个简单的pipline"></a>创建一个简单的pipline</h2><p>新建任务，选择<code>流水线</code>：</p>
<p><img src= "/img/loading.gif" data-src="pipline-demo.png" alt=""></p>
<p>在流水线脚本中，输入下面的脚本，然后点击保存：</p>
<p><img src= "/img/loading.gif" data-src="pipline-script.png" alt=""></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">node(<span class="string">'haimaxy-jnlp'</span>) &#123;    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      echo <span class="string">"1.Clone Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      echo <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      echo <span class="string">"3.Build Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      echo <span class="string">"4. Deploy Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个构建脚本，首先给node添加了上面设置的动态slave标签，然后设置了4个简单的构建流程</p>
</blockquote>
<p>直接点击构建，会看到构建成功：</p>
<p><img src= "/img/loading.gif" data-src="pipline-build.png" alt=""></p>
<p>在k8s集群上执行下面的命令，也看到了动态创建的pod执行该构建，成功后被清除：</p>
<img src= "/img/loading.gif" data-src="onk8s.png" style="zoom:67%;" />



<br>



<h1 id="通过pipeline部署服务到k8s"><a href="#通过pipeline部署服务到k8s" class="headerlink" title="通过pipeline部署服务到k8s"></a>通过pipeline部署服务到k8s</h1><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>要部署 Kubernetes大概的流程如下：</p>
<ul>
<li><code>CI阶段</code>：编写代码 – 测试 – 编写 Dockerfile –构建打包 Docker 镜像 – 推送 Docker 镜像到仓库；</li>
<li><code>CD阶段</code>：编写 Kubernetes YAML 文件 – 利用 kubectl 工具部署应用</li>
</ul>
<h2 id="jenkins添加凭证"><a href="#jenkins添加凭证" class="headerlink" title="jenkins添加凭证"></a>jenkins添加凭证</h2><p>由于我们是拉取私有仓库（harbor中）的镜像，所以需要密码认证。为了避免明文密码泄露，所以使用jenkins的凭证管理密码：</p>
<p><img src= "/img/loading.gif" data-src="jenkins-certs.png" alt=""></p>
<blockquote>
<p> 注意这里的ID，后面要用到。</p>
</blockquote>
<h2 id="创建代码"><a href="#创建代码" class="headerlink" title="创建代码"></a>创建代码</h2><p>在自己的gitlab中先创建一个空的项目（没有gitlab自行搭建一个就好），这里我的是<code>pipline-demo</code>：</p>
<p><img src= "/img/loading.gif" data-src="gitinit.png" alt=""></p>
<p>将项目克隆到服务器上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> http://10.8.138.11/root/pipeline-demo.git</span><br></pre></td></tr></table></figure>



<p>添加代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; app.py &lt;&lt; EOF</span><br><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(<span class="string">'/'</span>)</span><br><span class="line">def hello_world():</span><br><span class="line">    <span class="built_in">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>)</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<h2 id="添加dockerfile"><a href="#添加dockerfile" class="headerlink" title="添加dockerfile"></a>添加dockerfile</h2><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y epel-release</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum install -y python-pip &amp;&amp; /usr/bin/pip install flask</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> app.py /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> python /root/app.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>



<h2 id="添加部署yaml"><a href="#添加部署yaml" class="headerlink" title="添加部署yaml"></a>添加部署yaml</h2><p>创建一个deployment的yaml文件，用于部署服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; deployment.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-demo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: jenkins-demo</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: jenkins-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: 10.8.138.11:8181/python-demo/python-demo:&lt;BUILD_TAG&gt;</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: jenkins-demo</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>这里的镜像tag会在Jenkinsfile中导入</strong></p>
<h2 id="添加Jenkinsfile"><a href="#添加Jenkinsfile" class="headerlink" title="添加Jenkinsfile"></a>添加Jenkinsfile</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; Jenkinsfile &lt;&lt; EOF</span><br><span class="line">node(<span class="string">'haimaxy-jnlp'</span>) &#123;</span><br><span class="line">    stage(<span class="string">'Clone'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"1.Clone Stage"</span></span><br><span class="line">      checkout scm</span><br><span class="line">      script &#123;</span><br><span class="line">        build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">'git rev-parse --short HEAD'</span>).trim()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">'Test'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"2.Test Stage"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">'Build'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"3.Build Docker Image Stage"</span></span><br><span class="line">      sh <span class="string">"docker build -t 10.8.138.11:8181/python-demo/python-demo:<span class="variable">$&#123;build_tag&#125;</span> ."</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">'Push'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"4.Push Docker Image Stage"</span></span><br><span class="line">      withCredentials([usernamePassword(credentialsId: <span class="string">'harbor'</span>, passwordVariable: <span class="string">'harborPassword'</span>, usernameVariable: <span class="string">'harborUser'</span>)]) &#123;</span><br><span class="line">        sh <span class="string">"docker login -u <span class="variable">$&#123;harborUser&#125;</span> -p <span class="variable">$&#123;harborPassword&#125;</span> 10.8.138.11:8181"</span></span><br><span class="line">        sh <span class="string">"docker push 10.8.138.11:8181/python-demo/python-demo:<span class="variable">$&#123;build_tag&#125;</span>"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">'Deploy'</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"5. Deploy Stage"</span></span><br><span class="line">      def userInput = input(</span><br><span class="line">        id: <span class="string">'userInput'</span>,</span><br><span class="line">        message: <span class="string">'Choose a deploy environment'</span>,</span><br><span class="line">        parameters: [</span><br><span class="line">          [</span><br><span class="line">            <span class="variable">$class</span>: <span class="string">'ChoiceParameterDefinition'</span>,</span><br><span class="line">            choices: <span class="string">"Dev\nQA\nProd"</span>,</span><br><span class="line">            name: <span class="string">'Env'</span></span><br><span class="line">          ]</span><br><span class="line">        ]</span><br><span class="line">      )</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"This is a deploy step to <span class="variable">$&#123;userInput&#125;</span>"</span></span><br><span class="line">      sh <span class="string">"sed -i 's/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/' deployment.yaml"</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (userInput == <span class="string">"Dev"</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Deploying to DEV ."</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userInput == <span class="string">"QA"</span>)&#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Deploying to QA ."</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Deploying to Prod ."</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      sh <span class="string">"kubectl apply -f deployment.yaml"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<ul>
<li>这个Jenkinsfile将流水线分为：获取代码、测试、构建、推送、部署这几步，其中测试暂时忽略；</li>
<li>克隆这一步中，使用script将上传代码的commit与镜像tag进行关联，方便后续问题定位；</li>
<li>推送镜像这一步，使用的是之前在jenkins中创建的凭证，<code>credentialsId</code>为凭证的ID，<code>passwordVariable</code>和<code>usernameVariable</code>的前缀为凭证ID；</li>
<li>一般情况下，部署的时候都会选择现部署到测试或者开发环境，再部署到生产，所以这里通过获取用户输入来选择部署到哪个环境（当然这里只是一个示例，并没有那么多环境）；</li>
<li>部署这一步中，通过<code>sed</code>命令将镜像tag进行替换；</li>
</ul>
<h2 id="推动代码到代码库"><a href="#推动代码到代码库" class="headerlink" title="推动代码到代码库"></a>推动代码到代码库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git add .</span><br><span class="line">$ git commit -m <span class="string">'init project'</span></span><br><span class="line">$ git push origin master</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="gitlab-push.png" alt=""></p>
<h2 id="修改流水线配置"><a href="#修改流水线配置" class="headerlink" title="修改流水线配置"></a>修改流水线配置</h2><p>编辑之前创建的<code>pipeline-demo</code>流水线，修改流水线定义为如下：</p>
<p><img src= "/img/loading.gif" data-src="jenkinsfile-pipeline.png" alt=""></p>
<blockquote>
<p>根据实际情况填写代码库地址、分支以及凭据；</p>
</blockquote>
<h2 id="运行流水线"><a href="#运行流水线" class="headerlink" title="运行流水线"></a>运行流水线</h2><p>直接点击构建，会经过5个构建步骤，当运行到部署这一步的时候，需要选择一个部署环境：</p>
<p><img src= "/img/loading.gif" data-src="deploy-jenkins.png" alt=""></p>
<blockquote>
<p>当然这里的环境选择是个假的，选任何环境都可以，实际是需要在jenkinsfile中具体设置的</p>
</blockquote>
<p>最后运行成功了：</p>
<p><img src= "/img/loading.gif" data-src="success.png" alt=""></p>
<p>在集群中，容器也已经启动了（默认是和jenkins在一个namespace下）</p>
<img src= "/img/loading.gif" data-src="run-demo.png" style="zoom:67%;" />



</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Luka Vergo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://liyongzhezz.github.io/2020/07/29/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-%E9%83%A8%E7%BD%B2Jenkins%E6%9C%8D%E5%8A%A1/">https://liyongzhezz.github.io/2020/07/29/k8s%E5%AE%9E%E8%B7%B5%E7%B3%BB%E5%88%97-%E9%83%A8%E7%BD%B2Jenkins%E6%9C%8D%E5%8A%A1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://liyongzhezz.github.io" target="_blank">彭彭丁满</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a><a class="post-meta__tags" href="/tags/Jenkins/">Jenkins</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><button class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.png" alt="wechat" onclick="window.open('/img/wechat.png')"/><div class="post-qr-code__desc">wechat</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.png" alt="alipay" onclick="window.open('/img/alipay.png')"/><div class="post-qr-code__desc">alipay</div></li></ul></div></button></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/07/30/Prometheus%E7%9B%91%E6%8E%A7%E6%8C%87%E6%A0%87-kubernetes/"><img class="prev-cover" data-src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1596101882876&amp;di=b13bad8c07c9545ff79b1a92c694afaf&amp;imgtype=0&amp;src=http%3A%2F%2Fhbimg.b0.upaiyun.com%2F4be335086b589e4c398a207233f8d6a594804a8e3cf6e-n19Jwt_fw658" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Prometheus监控指标--kubernetes</div></div></a></div><div class="next-post pull-right"><a href="/2020/07/29/Nginx%E7%94%A8%E6%88%B7%E5%90%8D%E5%AF%86%E7%A0%81%E8%AE%A4%E8%AF%81/"><img class="next-cover" data-src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1596016589978&amp;di=3faa7ad2ca5d23c5bf55d775db6b2dc2&amp;imgtype=0&amp;src=http%3A%2F%2Fwww.nd9p.com%2Fuploads%2Fallimg%2F160529%2F2143353111_0.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Nginx用户名密码认证</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/07/10/k8s实践系列-EFK-Kafka日志收集-四/" title="[k8s实践系列]EFK+Kafka日志收集(四)--部署logstash"><img class="relatedPosts_cover" data-src="https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1594370632842&di=f01ac8d28b717c7dcd0e297ae0f25e1c&imgtype=0&src=http%3A%2F%2Fattach.dataguru.cn%2Fattachments%2Fforum%2F201605%2F01%2F224314k0sjhntg3je4qj15.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-10</div><div class="relatedPosts_title">[k8s实践系列]EFK+Kafka日志收集(四)--部署logstash</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/02/k8s实践系列-kubeadm部署k8s-1.18/" title="[k8s实践系列]kubeadm部署k8s 1.17"><img class="relatedPosts_cover" data-src="https://raw.githubusercontent.com/kubernetes/kubeadm/master/logos/stacked/color/kubeadm-stacked-color.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-02</div><div class="relatedPosts_title">[k8s实践系列]kubeadm部署k8s 1.17</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/05/k8s实践系列-卸载集群/" title="[k8s实践系列]卸载集群"><img class="relatedPosts_cover" data-src="http://www.soft6.com/uploadfile/2017/1009/20171009035234769.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-05</div><div class="relatedPosts_title">[k8s实践系列]卸载集群</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/05/k8s实践系列-证书管理/" title="[k8s实践系列]证书管理"><img class="relatedPosts_cover" data-src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-05</div><div class="relatedPosts_title">[k8s实践系列]证书管理</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/05/k8s实践系列-使用nfs存储/" title="[k8s实践系列]使用nfs存储"><img class="relatedPosts_cover" data-src="https://ss1.bdstatic.com/70cFuXSh_Q1YnxGkpoWK1HF6hhy/it/u=251466455,608736426&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-05</div><div class="relatedPosts_title">[k8s实践系列]使用nfs存储</div></div></a></div><div class="relatedPosts_item"><a href="/2020/07/05/k8s实践系列-部署MetricServer/" title="[k8s实践系列]部署MetricServer"><img class="relatedPosts_cover" data-src="https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=175965930,2539474621&fm=26&gp=0.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-05</div><div class="relatedPosts_title">[k8s实践系列]部署MetricServer</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '50c33518212f08034726',
  clientSecret: '497b04ce72a905ec41ebc3fb051369434affe3c7',
  repo: 'liyongzhezz.github.io',
  owner: 'liyongzhezz',
  admin: ['liyongzhezz'],
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN',
  perPage: 10,
  distractionFreeMode: false,
  pagerDirection: 'last',
  createIssueManually: false,
  updateCountCallback: commentCount
})
gitalk.render('gitalk-container')

function commentCount(n){
  try {
    document.getElementsByClassName('gitalk-comment-count')[0].innerHTML= n
  } catch (e) {
    return false
  }
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Luka Vergo</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"><meta name="generator" content="Hexo 4.2.1"></head></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><button id="readmode" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" title="缩小字体"><i class="fas fa-minus"></i></button><button class="translate_chn_to_cht" id="translateLink" title="简繁转换">简</button><button id="darkmode" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fas fa-comments"></i></a><button class="close" id="mobile-toc-button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>