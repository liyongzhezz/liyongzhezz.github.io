---
title: 为什么删除文件后磁盘空间不释放
date: 2020-07-16 11:02:31
tags: 常见问题
categories:
- 常见问题
- Linux系统
description: 删除文件后磁盘空间不释放的原因分析和实验
cover: https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1594878899027&di=f873d906117286440a61a4b821bfcbbe&imgtype=0&src=http%3A%2F%2F5b0988e595225.cdn.sohucs.com%2Fimages%2F20180916%2Fb4ccdc6b88ab43fca605caf3155d2dd0.jpeg
---



## 现象

磁盘空间达到报警阈值产生报警，删除多于的文件后空间并没有释放。



<br>



## 测试

首先看下分区空间剩余大小：

```bash
$ df -h | grep boot
/dev/vda1      1014M  186M  829M   19% /boot
```



然后在这个分区下创建一个随机文件占据一定的空间：

```bash
$ dd if=/dev/urandom of=/boot/test.txt bs=50M count=1
$ df -h | grep boot
/dev/vda1      1014M  218M  797M   22% /boot
```



用一个测试测C程序，编译并运行：

```c
// test.c
#include<stdio.h>
#include<unistd.h>
int main(void)
{
    FILE *fp = NULL;
    fp = fopen("/boot/test.txt", "rw+");
    if(NULL == fp)
    {
       perror("open file failed");
       return -1;
    }
    while(1)
    {
       //do nothing
       sleep(1);
    }
    fclose(fp);
    return 0;
}
```

> 这个程序就是打开测试文件，然后循环。



编译并运行：

```bash
$ gcc -o openfile test.c
$ ./openfile
```



然后删除测试文件`test.txt`，并查看剩余空间：

```bash
$ rm -f test.txt
$ df -h | grep boot
/dev/vda1      1014M  218M  797M   22% /boot
```



看到尽管文件删除了，空间并没有释放。



现在停止测试程序再查看：

```bash
$ df -h | grep boot
/dev/vda1      1014M  186M  829M   19% /boot
```

 空间释放掉了。



<br>



## 原因

所谓的删除，也不过是文件名到 inode 的链接删除，只要不被重新写入新的数据，磁盘上的block数据块不会被删除。只有当一个文件的引用计数为0（包括硬链接数）的时候，才可能调用unlink删除，只要它不是0，那么就不会被删除。当一个程序打开一个文件的时候（获取到文件描述符），它的引用计数会被+1，rm虽然看似删除了文件，实际上只是会将引用计数减1，但由于引用计数不为0，因此文件不会被删除



所以上边的问题在于，尽管删除了文件，但是依然有程序在占用这个文件，导致空间不能被释放。通过下面的命令可以查看到已经删除但是还在占用的文件：

```bash
$ lsof | grep delete
openfile  15148          root    3u      REG              253,1  33554431         86 /boot/test.txt (deleted)
```

> 看到openfile程序在占用test.txt文件，且test.txt是被删除的状态。



这类问题往往出现在程序的日志文件中，尤其是日志文件滚动之后。所以养成好习惯，打开文件后，不用时，记得关闭文件描述符。