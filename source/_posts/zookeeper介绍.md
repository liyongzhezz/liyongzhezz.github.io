---
title: zookeeper介绍
date: 2020-12-12 13:06:15
tags:
- zookeeper
categories:
- zookeeper
description: 介绍zookeeper的基础概念
cover: 
---



## zookeeper介绍

zookeeper最早由雅虎研究院开发，后来托管到apache基金会。它是一个开源的分布式的，为分布式应用提供协调服务的项目。



### 什么是分布式系统

分布式系统是同事跨越多个无立柱及，独立运行多个软件所组成的系统。采用分布式去设计系统可以利用多处理器的运算能力，如并行复制任务。



### zookeeper工作机制

zookeeper是一个基于观察者模式设计的分布式服务管理框架，它负责存储和管理大家都关心的数据，然后接受观察者的注册，一旦这些数据的状态发生变化，zookeeper将负责通知在zookeeper上注册的观察者做出反应。



### zookeeper服务流程

1. 服务端将自己的地址和端口注册到zookeeper中；
2. 客户端通过zookeeper观察这些注册进来的服务端数据；
3. 如果服务端中某个节点下线，则会导致zookeeper中数据发生变化；
4. zookeeper会在数据发生变化时主动通知客户端：服务端存在下线；



> zookeeper实质是文件系统+通知机制，依靠这两点来实现分布式服务协调的功能。



### zookeeper特点

1. zookeeper集群中主节点称为：leader，从节点称为：follower；
2. zookeeper集群中只要有半数以上节点存活就能正常工作；
3. 全局数据一致：每个节点存储的数据都一样，无论client连接到哪个节点都能取到相同的数据；
4. 更新请求顺序进行，来自同一个client的更新请求按其发送顺序依次执行；
5. 数据更新原子性，依次数据更新要么成功，要么失败；



### zookeeper数据结构

zookeeper数据结构模型类似于Unix文件系统，整体上可以看做一个树，每个节点称为1一个`znode`，每个znode默认能够存储`1MB`的数据,每个znode都可以通过其路径唯一标识。

![](./znode.png)



<br>

## zookeeper的应用实例

### HBase

HBase是一个与hadoop一起使用的数据仓库，在HBase中，zookeeper用于选举一个集群内的主节点，以便追踪可用的服务器，并保存集群的元数据；



### Kafka

Kafka是一个基于订阅-发布的消息系统，其中zookeeper用于检测崩溃，实现topic的发现并保持topic的生产和消费状态；



### Solr

Solr是一个企业级搜索平台，其使用zookeeper存储集群元数据，并协作更新这些元数据；

<br>



## 会话生命周期

会话的生命周期(lifetime)是指会话从创建到结束的时期，无论会 话正常关闭还是因超时而导致过期。一个会话的主要可能状态:CONNECTING、 CONNECTED、CLOSED和NOT_CONNECTED。状态的转换依赖于发 生在客户端与服务之间的各种事件

![](./lifetime.png)



一个会话从NOT_CONNECTED状态开始，当ZooKeeper客户端初始 化后转换到CONNECTING状态(图2-6中的箭头1)。正常情况下，成 功与ZooKeeper服务器建立连接后，会话转换到CONNECTED状态(箭 头2)。当客户端与ZooKeeper服务器断开连接或者无法收到服务器的响 应时，它就会转换回CONNECTING状态(箭头3)并尝试发现其他 ZooKeeper服务器。如果可以发现另一个服务器或重连到原来的服务 器，当服务器确认会话有效后，状态又会转换回CONNECTED状态。否 则，它将会声明会话过期，然后转换到CLOSED状态(箭头4)。应用 也可以显式地关闭会话(箭头4和箭头5)。



创建一个会话时，你需要设置会话超时这个重要的参数，这个参数 设置了ZooKeeper服务允许会话被声明为超时之前存在的时间。如果经 过时间t之后服务接收不到这个会话的任何消息，服务就会声明会话过 期。而在客户端侧，如果经过t/3的时间未收到任何消息，客户端将向服 务器发送心跳消息。在经过2t/3时间后，ZooKeeper客户端开始寻找其他 的服务器，而此时它还有t/3时间去寻找。



在仲裁模式下，客户端有多个服务器可以连接，而在独立模式下， 客户端只能尝试重新连接单个服务器。在仲裁模式中，应用需要传递可 用的服务器列表给客户端，告知客户端可以连接的服务器信息并选择一 个进行连接。